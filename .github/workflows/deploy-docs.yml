name: Deploy Documentation to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      # Only trigger on changes to source files that affect documentation
      - 'libocsqlite/**/*.vala'
      - 'libocfiles/**/*.vala'
      - 'libocmarkdown/**/*.vala'
      - 'libocmarkdowngtk/**/*.vala'
      - 'libollmchat/**/*.vala'
      - 'liboctools/**/*.vala'
      - 'liboccoder/**/*.vala'
      - 'libocvector/**/*.vala'
      - 'libollmchatgtk/**/*.vala'
      - 'ollmapp/**/*.vala'
      - 'examples/**/*.vala'
      - 'docs/meson.build'
      - '.github/workflows/deploy-docs.yml'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install libfaiss-dev dependencies from Ubuntu
        run: |
          # Update package lists and install dependencies from Ubuntu repositories
          sudo apt-get update
          sudo apt-get install -y \
            libblas-dev \
            liblapack-dev \
            libomp-dev
          
      - name: Download and install libfaiss-dev
        run: |
          # Download libfaiss-dev .deb package from Debian repository
          wget http://ftp.us.debian.org/debian/pool/main/f/faiss/libfaiss-dev_1.13.2-1_amd64.deb -O /tmp/libfaiss-dev.deb
          
          # Install the package and fix any missing dependencies
          sudo apt-get install -y libfaiss1 || true
          sudo dpkg -i /tmp/libfaiss-dev.deb || sudo apt-get install -f -y

      - name: Install build dependencies
        run: |
          # Enable universe repository for packages like libfaiss-dev
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository universe -y
          sudo apt-get update
          sudo apt-get install -y \
            meson \
            ninja-build \
            valac \
            valadoc \
            libgee-0.8-dev \
            libglib2.0-dev \
            libgtk-4-dev \
            libgtksourceview-5-dev \
            libadwaita-1-dev \
            libsoup-3.0-dev \
            libjson-glib-dev \
            libxml2-dev \
            libsqlite3-dev \
            libgit2-glib-1.0-dev \
            gobject-introspection \
            libgirepository1.0-dev \
            libomp-dev \
            libblas-dev \
            liblapack-dev \
            libtree-sitter-dev \
            build-essential \
            pkg-config

      - name: Setup meson build
        run: |
          meson setup build --prefix=/usr

      - name: Build documentation
        run: |
          # Build documentation (valadoc target has build_by_default: true)
          # This will build the docs along with any dependencies
          ninja -C build

      - name: Create .nojekyll file
        run: |
          touch build/valadoc/.nojekyll

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/valadoc

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

