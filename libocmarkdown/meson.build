# Build ocmarkdown base library (libocmarkdown.so) - no GTK dependencies
# We'll generate VAPI manually via custom_target to control command line order
# Meson will generate a VAPI with default name 'ocmarkdown.vapi', but we override it
# by generating our own via custom_target. The meson-generated one won't be used.

# Dependencies for ocmarkdown library
valac = meson.get_compiler('vala')
ocmarkdown_deps = [
  dependency('gee-0.8'),
  dependency('gio-2.0'),
  dependency('glib-2.0'),
  dependency('gobject-2.0'),
  dependency('json-glib-1.0'),
  dependency('libsoup-3.0'),
  dependency('libxml-2.0'),
  valac.find_library('posix'),
]

ocmarkdown_src = files([
  'Parser.vala',
  'RenderBase.vala',
  'PangoRender.vala',
  'DummyRenderer.vala',
  'HtmlParser.vala',
  'HtmlRender.vala',
  'Tags.vala',
  'TagsTable.vala',
  'Writer.vala',
])

ocmarkdown_base_lib = library('ocmarkdown',
  dependencies: ocmarkdown_deps,
  sources: ocmarkdown_src,
  vala_header: 'ocmarkdown.h',
  vala_vapi: 'ocmarkdown-meson.vapi',  # Use different name so our custom_target can use 'ocmarkdown.vapi'
  install: true
)

# Manually generate ocmarkdown.vapi with correct command line order
# This replicates the Makefile approach and bypasses meson's determine_dep_vapis()
# Note: We only generate the VAPI file here - the header is generated by ocmarkdown_base_lib
ocmarkdown_vapi = custom_target('ocmarkdown-vapi',
  output: 'ocmarkdown.vapi',
  input: ocmarkdown_src,
  command: [
    valac_exe,
    '-C', '--debug',
    '--target-glib=auto',
    '--vapidir', meson.current_source_dir() / '../vapi',
    '--vapidir', meson.current_source_dir() / '../../vapi',
    '--vapidir', meson.current_build_dir(),
    '--pkg', 'posix',
    '--pkg', 'libxml-2.0',
    '--pkg', 'libsoup-3.0',
    '--pkg', 'json-glib-1.0',
    '--pkg', 'gobject-2.0',
    '--pkg', 'glib-2.0',
    '--pkg', 'gio-2.0',
    '--pkg', 'gee-0.8',
    '--library', 'ocmarkdown',
    '--header', meson.current_build_dir() / 'ocmarkdown.h',  # Use header from library
    '--vapi', '@OUTPUT@',
    '@INPUT@'
  ],
  depends: [ocmarkdown_base_lib],  # Ensure library is built first (so header exists)
  build_by_default: true
)

# Create a dependency that includes the VAPI file to ensure build order
# Note: We can't include the library in sources, so we rely on link_args to ensure it's built
ocmarkdown_vapi_dep = declare_dependency(
  link_args: ['-L' + meson.current_build_dir(), '-locmarkdown'],
  sources: [ocmarkdown_vapi[0]]  # Include VAPI file to ensure it's built first
)

# VAPI-only dependency (no linking) for test executables that only need the VAPI
ocmarkdown_vapi_only_dep = declare_dependency(
  sources: [ocmarkdown_vapi[0]]  # Include VAPI file to ensure it's built first, but no link_args
)

# GObject Introspection for ocmarkdown base library
# Note: Namespace is now Markdown (not OLLMchat.Markdown)
ocmarkdown_gir = gnome.generate_gir(ocmarkdown_base_lib,
  namespace: 'OCMarkdown',
  nsversion: '1.0',
  identifier_prefix: 'Markdown',
  symbol_prefix: 'markdown',
  includes: ['GObject-2.0', 'Gio-2.0'],
  install: true,
  fatal_warnings: false
)
