# 1.3.3. Configuration Migration Bugs and Defaults

## Overview

This document addresses bugs and default value handling during the migration from Config1 (old config.json format) to Config2 (new config.2.json format), specifically around the `model`, `title_model`, and `think` properties.

## Status

⏳ **TODO** - Planning document for configuration migration bug fixes and default handling.

## Related Plans

- **1.3** - Multiple Client Configuration
- **1.3.1** - Configuration Classes
- **1.3.2** - Configuration Interface
- **1.4** - Client Configuration Setup

## Issues to Address

### 1. Embed Config Loading

**Problem**: Embed configuration for vector database was loaded from a separate `embed.json` file, which was not integrated with the new Config2 system.

**Location**: 
- `ollmchat/Window.vala` - `initialize_codebase_search_tool()` method
- Previously loaded from: `~/.config/ollmchat/embed.json`

**Solution**:
- Embed configuration is now integrated into Config2 structure using ModelUsage entries
- Static methods in `OLLMvector.Database` and `OLLMvector.Indexing.Analysis` classes set up ModelUsage entries
- `Database.setup_embed_usage()` creates "ocvector.embed" entry in Config2's usage map
- `Analysis.setup_analysis_usage()` creates "ocvector.analysis" entry in Config2's usage map
- Both methods use the default connection from Config2 and hardcoded models (bge-m3 for embed, qwen3-coder:30b for analysis)
- Window.vala now calls these methods to auto-create configuration if it doesn't exist
- Config2 registers "ocvector.embed" and "ocvector.analysis" as ModelUsage types

**Status**: ✅ **IMPLEMENTED** - Auto-creation of embed/analysis config in Config2 via static methods

### 2. Think Property (Removed from Config)

**Decision**: `think` is NOT stored in Config - it remains as a runtime property on Client only.

**Solution**: 
- `think` is removed from Config1/Config2 - it's not persisted
- `think` remains on Client as a runtime property (callers can set it if needed)
- When migrating Config1 to Config2, do NOT store `think` in ModelUsage objects
- Code should use `client.think` directly (runtime property), not from config

**Location**: 
- `libollmchat/Settings/Config1.vala` - `toV2()` method (do not store think)
- `libollmchat/Client.vala` - `think` property remains as runtime property

### 3. Model and Title Model Defaults

**Problem**: During migration, `model` and `title_model` from Config1 may be empty strings, and code should handle this gracefully.

**Solution**:
- Code that uses `model` and `title_model` can assume empty strings as valid defaults
- When migrating Config1 to Config2:
  - If `model` is empty, it remains empty (no default model is set)
  - If `title_model` is empty, it remains empty (no default title model is set)
- Code accessing these properties should check for empty strings and handle appropriately
- No need to set default values during migration - empty strings are acceptable

**Location**: 
- `libollmchat/Settings/Config1.vala` - `toV2()` method
- All code that accesses `model` and `title_model` properties

## Implementation Notes

### Config1.toV2() Migration

When converting Config1 to Config2 (see [1.3.1-configuration-classes.md](1.3.1-configuration-classes.md) for Config2 structure):

1. **Connection**: Create Connection from Config1's `url` and `api_key`, add to Config2's connections map
2. **Default Model**: Create ModelUsage object for "default_model" key in Config2's usage map:
   - `connection` = Config1's url (references connection in connections map)
   - `model` = Config1's model (can be empty string)
   - `options` = new empty Call.Options()
   - Do NOT set `think` - it's not stored in config
3. **Title Model**: Create ModelUsage object for "title_model" key in Config2's usage map:
   - `connection` = Config1's url (references connection in connections map)
   - `model` = Config1's title_model (can be empty string)
   - `options` = new empty Call.Options()
   - Do NOT set `think` - it's not stored in config

### Code Assumptions

Code throughout the codebase should:
- Assume `model` can be an empty string (no model selected)
- Assume `title_model` can be an empty string (no title model configured)
- Use `client.think` directly (runtime property on Client, not from config)

### Storage in Config2

**Note**: This is a refactoring task, not adding new functionality. We are preserving existing behavior using the Config2 design (see [1.3.1-configuration-classes.md](1.3.1-configuration-classes.md)).

**Decision**: `model` and `title_model` are stored in Config2's `usage` map as `ModelUsage` objects, then extracted to Client properties at runtime. `think` is NOT stored in config.

- `model` and `title_model` are stored in Config2's `usage` map:
  - "default_model" → ModelUsage (connection, model, options) - no think
  - "title_model" → ModelUsage (connection, title_model, options) - no think
- At runtime, these are extracted from Config2 and set on Client as direct properties (replacing `client.config.model` and `client.config.title_model`)
- `think` is NOT stored in config - it remains as a runtime property on Client only
- During migration from Config1, only model and title_model are preserved as ModelUsage objects in Config2's usage map
- Config2 must register ModelUsage type: `config.register_type("default_model", typeof(Settings.ModelUsage))` and `config.register_type("title_model", typeof(Settings.ModelUsage))` (where `config` is the Config2 instance variable)

## Files to Modify

- `libollmchat/Settings/Config1.vala` - Update `toV2()` method to preserve these values
- `libollmchat/Settings/Config2.vala` - May need to add properties or storage for model/title_model/think
- All code that accesses `client.config.model`, `client.config.title_model`, `client.config.think` - Ensure they handle empty strings/defaults appropriately

## Migration Strategy

1. Load `config.json` as Config1
2. Convert to Config2 using `toV2()`
3. Preserve:
   - `model` (can be empty)
   - `title_model` (can be empty)
   - Do NOT preserve `think` - it's not stored in config
4. Save as `config.2.json`
5. Code accessing these values should handle empty strings
6. `think` remains as runtime property on Client (not from config)

