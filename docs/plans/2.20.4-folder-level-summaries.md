# 2.20.4. Folder-Level Summaries

## Status

⏳ **PENDING**

## Purpose

Generate one-line descriptions for each directory/folder to help LLM understand code organization. Folders provide important organizational context that should be captured and made available.

## Problem Statement

Folders provide important organizational context, but currently there's no high-level description of what each folder contains.

## Folder Metadata

### Storage

- Stored in `vector_metadata` table
- `element_type = 'folder'`
- `file_id` references the folder's `FileBase.id` (folders are also in filebase table)
- `start_line = 0` and `end_line = 0` (no line numbers for folders)
- `vector_id = 0` (NOT stored in FAISS, not vectorized)
- `description` contains one-line folder description
- `ast_path = ''` (folders don't have AST paths)

### Analysis Process

1. Get child folders directly from folder structure:
   - Iterate through `folder.children.items`
   - Filter for `Folder` objects (subfolders)
   - For each child folder, query its description from `vector_metadata`:
     ```sql
     SELECT description FROM vector_metadata 
     WHERE file_id = ? AND element_type = 'folder'
     ```
2. Query `vector_metadata` for all files in the folder:
   ```sql
   SELECT element_name, description FROM vector_metadata 
   WHERE file_id IN (SELECT id FROM filebase WHERE parent_id = ? AND base_type = 'f')
   AND element_type = 'file'
   ```
3. Build context: folder path + list of files with their descriptions + list of child folders with their descriptions
4. Call Analysis layer with folder analysis prompt template (includes child folder summaries)
5. Generate one-line description (similar to element descriptions, but can reference child folders)
6. Store in `vector_metadata` with `element_type='folder'`

### Folder Processing Order

- **Bottom-up traversal**: Process child folders before parent folders
- Recursively collect all folders in the project
- Sort folders by depth (deepest folders first)
- Process folders in sorted order (deepest → shallowest)
- This ensures child folder descriptions are available when analyzing parent folders
- Parent folder analysis can include summaries of what child folders contain

### Prompt Template

- New resource file: `resources/ocvector/folder-prompt.txt`
- Similar structure to element analysis prompt
- Input includes:
  - Folder path
  - List of files with their descriptions
  - List of child folders with their descriptions (if any)
- Output: one-line description of folder contents (can reference child folders)

## Implementation Details

### New Analysis Method

`Analysis.analyze_folder()`:
- Takes folder `Folder` object
- Gets child folders directly from `folder.children.items` (filter for Folder objects)
- For each child folder, queries its description from `vector_metadata` (if already analyzed)
- Queries file descriptions for files in folder from `vector_metadata`
- Builds prompt context (includes files and child folders)
- Calls LLM with folder prompt template
- Returns folder description
- Stores in `vector_metadata`

### Indexer Modifications

Add new method to `Indexer`:

`index_folders()`:
- Called after `index_folder()` completes file scanning
- Recursively collects all folders in the project
- Sorts folders by depth (deepest folders first) for bottom-up processing
- Iterates through folders in sorted order (deepest → shallowest)
- For each folder, calls `Analysis.analyze_folder()`
- Stores folder metadata
- Ensures child folders are analyzed before parent folders

### Updated Indexing Flow

```
index_filebase(folder, recurse, force):
  1. index_folder() → scans all files
  2. index_folders() → analyzes all folders (NEW)
  3. index_project() → analyzes project (Phase 5)
```

## Deliverables

- [ ] Create `resources/ocvector/folder-prompt.txt` prompt template (includes child folder summaries)
- [ ] Implement `Analysis.analyze_folder()` method:
  - Gets child folders from `folder.children.items` (filter for Folder objects)
  - Queries child folder descriptions from `vector_metadata` (if already analyzed)
  - Queries file descriptions for files in folder
- [ ] Add `Indexer.index_folders()` method with bottom-up traversal
- [ ] Implement folder depth calculation and sorting (deepest first)
- [ ] Integrate folder analysis into indexing flow (after file scanning)
- [ ] Store folder metadata with `element_type='folder'`
- [ ] Test folder description generation (verify child folders included in parent analysis)
- [ ] Verify folder metadata is queryable
- [ ] Test bottom-up processing order (child folders before parents)

## Related Plans

- 2.20-codebase-scanner-improvements.md - Parent plan
- 2.20.5-project-level-summaries.md - Project analysis (depends on folder summaries)
- 2.10-codebase-search-tool.md - Existing codebase search infrastructure
