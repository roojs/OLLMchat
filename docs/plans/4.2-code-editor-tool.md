# 4.2. Code Editor Interface

## Overview

Code editor tool for viewing and approving changes to files. Allows users to review and approve file changes before they are applied.

## Status

⏳ **TODO** - Complex UI enhancement to be implemented.

## Features
- View and ??? edit files.....
- View file changes in code editor
- Project and file selection with searchable dropdowns
- Approve changes to files (see Phase 6)
- Track approved file versions (see Phase 6)
- Handle partial file approvals (see Phase 6)

## Phased Implementation Plan

### Phase 1: Pane View Component

✅ **DONE** - WindowPane component created and moved to ollmchat directory.

Create a window pane component to contain the chat widget and a GTK Editor inside a tabbed window.

#### Component: Window Pane
- **Purpose**: Handle adjustment of the pane and manage visibility/resizing behavior
- **Contains**: Right tabbed view only (not responsible for adding widgets to tabs)
- **Exposes**: Tab view reference so main window (controller) can add widgets

#### Pane Behavior Rules
1. **Initial State**:
   - When program starts, right pane (source view) is **hidden/collapsed**
   - Chat widget occupies full available space

2. **Visibility Toggle (Opening Code View)**:
   - Pane becomes visible when user switches from "ask me" to "code assist" mode
   - **Window Resizing Strategy**:
     1. Capture current chat view width
     2. Set minimum width of chat view to its current width (prevents chat from shrinking)
     3. Unhide source view with minimum width (initially fixed 400px, later restored from configuration - see Phase 4)
     4. Window automatically resizes to accommodate both panes with their minimum widths
     5. In idle callback, remove the minimum width constraints
     6. Window has now been resized, and panes can be adjusted normally
   - This ensures chat view width stays the same when code view opens
   - Window grows to accommodate the new pane rather than shrinking the chat area

3. **Hide Right Pane Method**:
   - Method to hide the right pane
   - When hidden, adjust window size such that:
     - Chat widget remains the same size (does not expand)
     - Window shrinks to accommodate the hidden pane

#### Implementation Details
- Use GTK4 `Gtk.Paned` (horizontal orientation) for the split view
- Left pane: Chat widget
- Right pane: Tabbed container (initially empty/hidden)
- Pane adjustment handles minimum size constraints for both panes
- Main window will add widgets to the tabbed container

#### Files to Create
- `ollmchat/WindowPane.vala` - Main pane component class (namespace: OLLMchat)

---

### Phase 2A: Data Layer (liboccoder)

Create the basic data layer library for managing projects, files, and folders.

#### Component: liboccoder Library
- **Namespace**: `OLLMcoder`
- **Library Name**: `liboccoder`
- **Classes**:
  - `OLLMcoder.Files.File` - Represents a file (extends `FileBase`)
  - `OLLMcoder.Files.Folder` - Represents a folder/directory (extends `FileBase`)
  - `OLLMcoder.Files.Project` - Represents a project (extends `OLLMcoder.Files.Folder`)
  - `OLLMcoder.ProjectManager` - Manages projects and files (basic structure, database sync added in Phase 2B)

#### Class Properties

##### OLLMcoder.Files.FileBase (Base Class)
- `id` (int64) - Database ID
- `path` (string) - File/folder path
- `parent` (OLLMcoder.Files.Folder?) - Reference to parent folder (nullable for root folders/projects)
- `icon_name` (string) - Icon name for binding in lists
- `display_name` (string) - Display name for binding in lists
- `tooltip` (string) - Tooltip text for binding in lists
- **Methods**:
  - `mtime_on_disk()` - Get modification time on disk (Unix timestamp)

**Note**: FileBase provides common properties and methods shared by both File and Folder.

##### OLLMcoder.Files.File (extends FileBase)
- Inherits all properties from `OLLMcoder.Files.FileBase`
- `language` (string?) - Programming language (optional, for files)
- `manager` (OLLMcoder.ProjectManager) - Reference to ProjectManager
- `text_buffer` (GtkSource.Buffer?) - Pointer to text buffer (GTK-specific, nullable)
- `sourceview` (GtkSource.View?) - Pointer to SourceView widget (GTK-specific, nullable)
- `is_open` (bool) - Whether file is currently open in editor
- `is_active` (bool) - Whether this is the currently active/viewed file
- `last_approved_copy` (string) - Filename of last approved copy (default: empty string)
- **Methods**: 
  - `read()` - Read file contents
  - `write(string)` - Write file contents
- **Signals**: `changed` - Emitted when file content changes

**Note**: Files can be in multiple projects (due to softlinks/symlinks). All alias references are tracked in ProjectManager's alias_map.

##### OLLMcoder.Files.Folder (extends FileBase)
- Inherits all properties from `OLLMcoder.Files.FileBase`
- `children` (Gee.ListStore<OLLMcoder.Files.FileBase>) - ListStore of children (files and subfolders)
- `child_map` (Gee.HashMap<string, OLLMcoder.Files.FileBase>) - Hashmap of [name in dir] => file object
- **Methods**:
  - `async read_dir()` - Load children from filesystem
- **Signals**: 
  - `child_added` - Emitted when a child is added
  - `child_removed` - Emitted when a child is removed

**Note**: Folder maintains a list of its children and a hashmap for quick lookup by filename. Emits signals when children are added/removed.

##### OLLMcoder.Files.Project
- Inherits all properties from `OLLMcoder.Files.Folder`
- `all_files` (Gee.ListStore<OLLMcoder.Files.File>) - ListStore of all files in project (used by dropdowns)

**Note**: Projects are folders with special project management capabilities. Maintains a flat list of all files for efficient dropdown population.

#### Design Decisions
- **File SourceView lifecycle**: Decision pending on whether to keep SourceView open when file is not active, or close/recreate it
- **Multi-project files**: Files can belong to multiple projects (via softlinks), managed through separate relationship tracking
- **GTK-specific properties**: `text_buffer` and `sourceview` are nullable and only set when file is open in GTK UI

#### ProjectManager Basic Responsibilities
- Manage project discovery and indexing
- Keep file/directory objects in memory
- **Static stores**:
  - `path_map` (Gee.HashMap<string, OLLMcoder.Files.FileBase>) - Hashmap of path => FileBase for quick lookup
  - `alias_map` (Gee.HashMap<OLLMcoder.Files.File, Gee.ArrayList<string>>) - Hashmap of File => list of all paths (aliases) that reference it
- Basic methods for accessing projects, files, and folders
- Methods to handle file changes (rename, move) and update all alias references
- Import initial data from ProjectMigrate (Phase 1.5)
- Note: Database persistence and sync will be added in Phase 2B

**Note**: The `alias_map` tracks all paths that reference the same file object, making it easy to find all references when a file changes (e.g., rename). This is more efficient than iterating through all folders.

#### Files to Create
- `liboccoder/` - New library directory
- `liboccoder/meson.build` - Meson build configuration
- `liboccoder/files/` - Subdirectory for file/folder/project classes
- `liboccoder/files/FileBase.vala` - Base class (namespace: OLLMcoder.Files) - shared properties and methods
- `liboccoder/files/File.vala` - File class (namespace: OLLMcoder.Files, extends FileBase)
- `liboccoder/files/Folder.vala` - Folder class (namespace: OLLMcoder.Files, extends FileBase)
- `liboccoder/files/Project.vala` - Project class (namespace: OLLMcoder.Files, extends OLLMcoder.Files.Folder)
- `liboccoder/ProjectManager.vala` - Project and file management (namespace: OLLMcoder, basic structure)

#### Meson Build Configuration
- **Library Name**: `occoder`
- **VAPI Name**: `occoder.vapi`
- **Header Name**: `occoder.h`
- **Dependencies**: 
  - `gee-0.8`
  - `gio-2.0`
  - `glib-2.0`
  - `gobject-2.0`
  - `sqlite3` (via libocsqlite)
  - `ocsqlite` (link with libocsqlite)
- **GObject Introspection**:
  - Namespace: `OLLMcoder`
  - NSVersion: `1.0`
  - Identifier prefix: `OLLMcoder`
  - Symbol prefix: `ollmcoder`
- **Build Order**: Add `subdir('liboccoder')` to main `meson.build` after `libocsqlite` (depends on it)
- **RPath**: Add liboccoder to build rpath in dependent libraries
- **Main meson.build Update**: 
  - Add `subdir('liboccoder')` in dependency order (after libocsqlite, before libraries that depend on it)
  - Add liboccoder path to library paths for LD_LIBRARY_PATH in wrapper scripts
- **Dependency Updates**:
  - `libollmchatgtk` will need to depend on `liboccoder` (for dropdown widgets)

---

### Phase 1.5: Project Migration

Create a Project Migrate class to read and import project data from existing sources.

#### Component: Project Migrate
- **Namespace**: `OLLMcoder`
- **Class**: `OLLMcoder.ProjectMigrate`
- **Purpose**: Read project and file data from bootstrap sources and prepare for import into liboccoder

#### Data Sources to Read
1. **Cursor SQLite Database**
   - Path: `~/.config/Cursor/User/globalStorage/state.vscdb`
   - Query: `SELECT value FROM ItemTable WHERE key = 'history.recentlyOpenedPathsList';`
   - Extracts recently opened file paths from Cursor

2. **roobuilder Projects List**
   - Path: `~/.config/roobuilder/Projects.list`
   - Contains project information from roobuilder

3. **VS Code Storage**
   - Path: `~/.config/Code/storage.json`
   - Contains VS Code workspace and file history

#### Implementation Details
- Read data from each source
- Parse and normalize project/file paths
- Extract project roots and file associations
- Prepare data structure for import into ProjectManager (Phase 2A)
- Handle missing or inaccessible sources gracefully

#### Files to Create
- `liboccoder/ProjectMigrate.vala` - Migration class (namespace: OLLMcoder)
  - Methods to read from each data source
  - Data normalization and parsing
  - Output format for ProjectManager import

#### Dependencies
- Uses libocsqlite for reading Cursor SQLite database
- JSON parsing for VS Code storage
- File I/O for roobuilder Projects.list

---

### Phase 2B: Database Schema and Sync

Add database persistence and background sync functionality to ProjectManager.

#### Database Schema
- SQLite table to store file information and directories
- Fields to track:
  - File paths
  - Directory structure
  - Project associations
  - Metadata (timestamps, etc.)

#### ProjectManager Database Integration
- Uses libocsqlite (SQ library) for database operations
- Background process to update database
- Methods to:
  - Update representation of files as objects
  - Sync objects to database (via libocsqlite)
  - Sync to UI if necessary (when UI is active)
- File system watcher for real-time updates

#### Files to Modify
- `liboccoder/ProjectManager.vala` - Add database persistence and sync methods

---

### Phase 2C: Searchable Dropdown Widgets

Create searchable dropdown widgets for Project and File selection.

#### Component: Searchable Dropdowns
- **Location**: Header bar above source view
- **Layout**:
  - **Project dropdown**: Left side, searchable
  - **File dropdown**: Right side, searchable
- **Functionality**:
  - Both support search/filter interface
  - Can open files or switch projects
  - Query data via ProjectManager (from in-memory objects, backed by database from Phase 2B)

#### Implementation Details
- **Wrapper Pattern**: GTK4 dropdowns are sealed classes, so we wrap them rather than extend
- **Naming Convention**: Use `this.ell` pattern for internal widget references (not overly explicit like `this.dropdown`)
- Create wrapper widgets that contain the dropdown and add search/filter functionality
- Integrate with ProjectManager for data access
- Populate dropdowns from ProjectManager's in-memory objects

#### Files to Create
- `libollmchatgtk/ProjectDropdown.vala` - Searchable project dropdown widget (wraps GTK dropdown)
- `libollmchatgtk/FileDropdown.vala` - Searchable file dropdown widget (wraps GTK dropdown)

---

### Phase 3: Source View Component

Add the source view component to the tabbed container inside the window pane.

#### Component: Source View
- **Location**: Added to tabbed container in window pane (right side)
- **Layout**:
  - **Header Bar**: Contains Project and File dropdowns (from Phase 2C)
  - **Code Editor**: GTK SourceView or similar code editor component
- **Sizing**:
  - Minimum width: 400px
  - No responsibility for pane sizing (handled by WindowPane)

#### Implementation Details
- Integrate with dropdowns from Phase 2C
- Load and display file content
- Support code editing features
- Handle file switching via dropdowns

#### Files to Create
- `libollmchatgtk/SourceView.vala` - Source view component with header bar and editor

---

### Phase 4: Configuration Persistence (Future)

Save and restore UI state preferences.

#### Configuration to Persist
- **Source View Width**: Save the user's preferred source view pane width
- Restore this width when opening code view (used in Phase 1 visibility toggle)
- Store in application settings/preferences

#### Implementation Details
- Use GSettings or similar configuration system
- Save width when user adjusts pane
- Restore on application startup and when switching to code assist mode

#### Files to Create/Modify
- Configuration management module
- Update WindowPane to use saved width when available

---

### Phase 5: CodeAssistant Integration

Integrate CodeAssistant prompt system with ProjectManager and the code editor.

#### CodeAssistant Integration
- **Current Location**: `libollmchat/Prompt/CodeAssistant.vala`
- **Integration**: CodeAssistant prompt system will use ProjectManager to:
  - Get workspace path from active project
  - Access file contents via ProjectManager
  - Track open files and active file state from SourceView
- **Provider**: `CodeAssistantProvider` (in `libollmchatgtk/Prompt/CodeAssistantProvider.vala`) will integrate with:
  - ProjectManager for project/file access
  - SourceView for active file and cursor position tracking
- **Note**: CodeAssistant remains in `libollmchat` but will depend on `liboccoder` for data access

#### Implementation Details
- Update CodeAssistantProvider to use ProjectManager instead of OpenFile tracking
- Connect SourceView to CodeAssistantProvider for active file updates
- Integrate cursor position and selection tracking from code editor
- Update CodeAssistant to use ProjectManager for workspace and file access

#### Files to Modify
- `libollmchatgtk/Prompt/CodeAssistantProvider.vala` - Integrate with ProjectManager and SourceView
- `libollmchat/Prompt/CodeAssistant.vala` - Update to use ProjectManager for workspace/file access (if needed)

#### Dependency Updates
- `libollmchat` will need to depend on `liboccoder` (for CodeAssistant integration)

---

### Phase 6: File Approval and Version Tracking (Future)

Implement file approval workflow and version tracking system.

#### Auto-commit Assumption
- All changes are assumed to be auto-committed
- **Important**: Git committing automatically should NOT be done on main/master branch
- Use work-in-progress branch for automatic commits
- Need to track which version of file has been approved

#### Approval States
1. **Full file approval**: Jumps to the approved state of the file
2. **Partial file approval**: More complicated
   - Need temporary approved copy of the file
   - Diff against temporary approved copy
   - When further changes occur, compare to temporary approved copy rather than committed copy
   - Handle sliding window between approval process

#### Version Tracking
- Track approved file version
- Maintain temporary approved copy for partial approvals
- Diff management between approved and current state

#### Implementation Details
- Design approval workflow UI
- Handle edge cases in partial approval
- Manage temporary approved file copies
- Diff algorithm for comparing against approved state
- UI for showing changes and approval status

#### Files to Create/Modify
- Code editor component with diff view
- Approval UI components
- File version tracking system
- Temporary file management for partial approvals

---

### Phase 7: Code Editor Manager Tool

Create a tool that allows the LLM to manage the code editor interface.

#### Component: Code Editor Manager Tool
- **Namespace**: `OLLMchat.Tools`
- **Class**: `OLLMchat.Tools.CodeEditorManager` (implements `OLLMchat.Tool.Interface`)
- **Request Handler**: `OLLMchat.Tools.RequestCodeEditorManager` (extends `OLLMchat.Tool.RequestBase`)
- **Purpose**: Allow LLM to control file navigation and cursor positioning in the code editor UI

#### Tool Capabilities
Single unified tool that handles:
- **Open/Switch to file**: Open a file in the SourceView code editor, or switch to an already open file/tab
- **Navigate to line**: Jump to a specific line number in the current or target file
- Parameters: `file_path` (required), `line_number` (optional)

**Note**: Query operations (get cursor position, get selected text, get file contents) are already provided by `CodeAssistantProvider` (Phase 5) and do not need to be duplicated in this tool.

#### Implementation Details
- Tool follows the same pattern as `ReadFile`, `EditMode`, `RunCommand`
- Single tool handles both file opening/switching and line navigation
- If file is not open, opens it; if already open, switches to it
- If line_number is provided, navigates to that line after opening/switching
- Integrates with SourceView component from Phase 3
- May need to integrate with WindowPane to ensure code view is visible
- Request handler will need access to SourceView instance
- GTK-specific implementation in `libollmchatgtk/Tools/RequestCodeEditorManager.vala`

#### EditMode Integration
- **Component**: `OLLMchat.Tools.EditModeWrapper`
- **Purpose**: Intercept EditMode changes and update SourceView editor UI
- **Implementation**: 
  - Wraps the existing `EditMode` tool
  - Connects to `EditMode.change_done` signal to intercept file changes
  - Updates SourceView when files are edited via EditMode tool
  - If file is open in editor, refreshes content and highlights changes
  - If file is not open, optionally opens it in editor to show changes

#### Files to Create
- `libollmchat/Tools/CodeEditorManager.vala` - Tool interface definition
- `libollmchat/Tools/RequestCodeEditorManager.vala` - Base request handler
- `libollmchatgtk/Tools/RequestCodeEditorManager.vala` - GTK-specific implementation with SourceView integration
- `libollmchatgtk/Tools/EditModeWrapper.vala` - Wrapper to intercept EditMode changes and update SourceView

#### Files to Modify
- `ollmchat/Window.vala` - Add CodeEditorManager tool to client, use EditModeWrapper instead of direct EditMode
- `libollmchatgtk/SourceView.vala` - Expose methods for tool to control editor (open file, navigate, refresh content, highlight changes)
- `libollmchatgtk/WindowPane.vala` - May need to expose method to show/ensure code view is visible
