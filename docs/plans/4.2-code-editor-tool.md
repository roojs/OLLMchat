# 4.2. Code Editor Interface

## Overview

Code editor tool for viewing and approving changes to files. Allows users to review and approve file changes before they are applied.

## Status

üü° **IN PROGRESS** - Core data layer and dropdown widgets complete. All compile errors resolved. Source view partially implemented (~75%). Integration pending.

**Progress:** 5 of 11 phases complete (45%), 1 partially complete (Phase 3 at ~75%)

**Recent Updates (Latest Session):**
- ‚úÖ Fixed all compile errors in data layer
- ‚úÖ FileDropdown now uses ProjectFiles directly as ListModel (no copying)
- ‚úÖ ProjectFiles.project_files property is now non-nullable (always initialized)
- ‚úÖ Added get_active_file() method to ProjectFiles
- ‚úÖ Fixed FileAlias property overrides (removed override, use new properties that delegate to target)
- ‚úÖ Fixed array concatenation issues in Folder.load_children()
- ‚úÖ Fixed lambda expression error in SourceView.open_file()
- ‚úÖ Fixed syntax errors in Folder.read_dir_update()
- ‚úÖ Fixed target_id reference error in Folder.load_children()

## Features
- View and ??? edit files.....
- View file changes in code editor
- Project and file selection with searchable dropdowns
- Approve changes to files (see Phase 6)
- Track approved file versions (see Phase 6)
- Handle partial file approvals (see Phase 6)

## Phase Summary

| Phase | Status | Description |
|-------|--------|-------------|
| Phase 1: Pane View Component | ‚úÖ DONE | WindowPane component with visibility toggle and resizing behavior |
| Phase 1.5: Project Migration | ‚úÖ DONE | ProjectMigrate class for importing from Cursor, roobuilder, VS Code |
| Phase 2A: Data Layer (liboccoder) | ‚úÖ DONE | FileBase, File, Folder (with is_project flag), ProjectFiles, ProjectFile, and ProjectManager classes - fully implemented and compiling |
| Phase 2B: Database Schema and Sync | ‚úÖ DONE | Database methods implemented, schema complete, save/load functionality working |
| Phase 2C: Searchable Dropdown Widgets | ‚úÖ DONE | SearchableDropdown, ProjectDropdown, FileDropdown fully implemented. FileDropdown uses ProjectFiles directly. Sections/separators for recent items pending |
| Phase 2D: Tabbed FileDropdown | ‚è≥ TODO | Add tabbed interface to FileDropdown: Tab 1 (search through ProjectFiles), Tab 2 (tree navigation of Folder.children with all expanded) |
| Phase 3: Source View Component | üü° PARTIAL | SourceView component implemented (~75% complete). Core functionality done: buffer switching, file/project switching, state persistence. Missing: file saving, search, diagnostics, user error dialogs |
| Phase 4: Configuration Persistence | ‚è≥ FUTURE | Save/restore UI state preferences |
| Phase 5: CodeAssistant Integration | ‚è≥ TODO | Integrate CodeAssistant with ProjectManager and editor |
| Phase 6: File Approval and Version Tracking | ‚è≥ FUTURE | Approval workflow and version tracking system |
| Phase 7: Code Editor Manager Tool | ‚è≥ TODO | Tool for LLM to manage code editor interface |
| Phase 8: Background Sync and File Watcher | ‚è≥ TODO | Background sync process and file system watcher for real-time updates |

**Legend:**
- ‚úÖ DONE - Fully implemented
- üü° PARTIAL - Partially implemented
- üî¥ NEEDS REDOING - Needs refactoring/updating to match new architecture
- ‚è≥ TODO - Not yet started
- ‚è≥ FUTURE - Planned for future implementation

## Phased Implementation Plan

### Phase 1: Pane View Component

‚úÖ **DONE** - WindowPane component created and moved to ollmchat directory.

Create a window pane component to contain the chat widget and a GTK Editor inside a tabbed window.

#### Component: Window Pane
- **Purpose**: Handle adjustment of the pane and manage visibility/resizing behavior
- **Contains**: Right tabbed view only (not responsible for adding widgets to tabs)
- **Exposes**: Tab view reference so main window (controller) can add widgets

#### Pane Behavior Rules
1. **Initial State**:
   - When program starts, right pane (source view) is **hidden/collapsed**
   - Chat widget occupies full available space

2. **Visibility Toggle (Opening Code View)**:
   - Pane becomes visible when user switches from "ask me" to "code assist" mode
   - **Window Resizing Strategy**:
     1. Capture current chat view width
     2. Set minimum width of chat view to its current width (prevents chat from shrinking)
     3. Unhide source view with minimum width (initially fixed 400px, later restored from configuration - see Phase 4)
     4. Window automatically resizes to accommodate both panes with their minimum widths
     5. In idle callback, remove the minimum width constraints
     6. Window has now been resized, and panes can be adjusted normally
   - This ensures chat view width stays the same when code view opens
   - Window grows to accommodate the new pane rather than shrinking the chat area

3. **Hide Right Pane Method**:
   - Method to hide the right pane
   - When hidden, adjust window size such that:
     - Chat widget remains the same size (does not expand)
     - Window shrinks to accommodate the hidden pane

#### Implementation Details
- Use GTK4 `Gtk.Paned` (horizontal orientation) for the split view
- Left pane: Chat widget
- Right pane: Tabbed container (initially empty/hidden)
- Pane adjustment handles minimum size constraints for both panes
- Main window will add widgets to the tabbed container

#### Files to Create
- `ollmchat/WindowPane.vala` - Main pane component class (namespace: OLLMchat)

---

### Phase 2A: Data Layer (liboccoder)

‚úÖ **IMPLEMENTED** - Basic data layer library exists and is functional. Architecture has evolved from original plan.

**Status**: Core implementation is complete. Some methods referenced in code are not yet implemented (see Issues section below).

#### ‚úÖ Implementation Status

**Architecture Changes (Completed):**
1. ‚úÖ **Project class removed** - All functionality merged into Folder with `is_project` flag
2. ‚úÖ **ProjectFiles class created** - Wrapper class for managing ProjectFile objects (ListModel implementation)
3. ‚úÖ **Alias properties added to FileBase** - `is_alias` (computed), `points_to`, `points_to_id`, `target_path` for symlink tracking
4. ‚úÖ **Database schema updated** - Alias fields added, base_type handling implemented
5. ‚úÖ **.git exclusion** - Hidden/system directories skipped during scanning (implemented in Folder.read_dir())
6. ‚úÖ **FileAlias class** - Wrapper for File aliases (throws errors for editor operations - aliases not used in editor)
7. ‚úÖ **FolderFiles class** - ListModel implementation for Folder.children with integrated child_map (basename lookup)

**Architecture Differences from Original Plan:**
1. ‚ö†Ô∏è **Folder.read_dir() still in Folder** - Not moved to ProjectFiles as originally planned. Folder handles its own directory scanning.
2. ‚úÖ **FolderAlias never intended** - Original plan incorrectly assumed FolderAlias was needed. Only FileAlias exists (for file symlinks). Folder symlinks are handled differently.
3. ‚ö†Ô∏è **ProjectFiles is a wrapper** - Stores ProjectFile objects (wrappers around File), not FileBase objects. Different from original plan.
4. ‚úÖ **ProjectFile is a wrapper** - Wraps a File object for project-specific display (intended design - ProjectFiles provides the relationship context).
5. ‚ö†Ô∏è **FileBase has more properties** - Many properties (language, cursor_line, etc.) moved to FileBase for shared access.

**Files Status:**
- ‚úÖ `FileBase.vala` - Complete with alias properties, database schema, shared properties
- ‚úÖ `File.vala` - Complete, no `is_project` flag (correct)
- ‚úÖ `Folder.vala` - Complete with `is_project` flag, `project_files`, `read_dir()` still present
- ‚úÖ `ProjectFiles.vala` - Created as ListModel wrapper for ProjectFile objects (scan_project and get_flat_file_list not needed - Folder handles scanning, ProjectFiles provides ListModel directly)
- ‚úÖ `ProjectManager.vala` - Updated to use Folder instead of Project
- ‚úÖ `FileDropdown.vala` - Updated to use `project_files` (with fallback)
- ‚úÖ `FileAlias.vala` - Created, throws errors for editor operations
- ‚úÖ `FolderFiles.vala` - Created (named differently from planned FolderChildren)
- ‚úÖ `ProjectFile.vala` - Created as File wrapper, not relationship tracker

**Note**: File class has `is_open` and `is_active` properties. The `text_buffer` property (GtkSource.Buffer) will be added in Phase 3 when SourceView is implemented. The `sourceview` property is not needed - SourceView component manages the single view widget and switches buffers.

#### Component: liboccoder Library
- **Namespace**: `OLLMcoder`
- **Library Name**: `liboccoder`
- **Classes**:
  - `OLLMcoder.Files.File` - Represents a file (extends `FileBase`)
  - `OLLMcoder.Files.Folder` - Represents a folder/directory (extends `FileBase`, has `is_project` flag, merged with Project functionality)
  - `OLLMcoder.Files.ProjectFile` - Wrapper around File for project-specific display (ProjectFiles provides the relationship context)
  - `OLLMcoder.ProjectManager` - Manages projects and files (basic structure, database sync added in Phase 2B)

#### Class Properties

##### OLLMcoder.Files.FileBase (Base Class)
- `id` (int64) - Database ID
- `path` (string) - File/folder path
- `parent_id` (int64) - Parent folder ID for database storage
- `parent` (OLLMcoder.Files.Folder?) - Reference to parent folder (nullable for root folders/projects)
- `manager` (OLLMcoder.ProjectManager) - Reference to ProjectManager (required, construct-only)
- `is_alias` (bool) - **Computed property**: Returns true if this is a FileAlias (checked via `this is FileAlias`)
- `points_to` (FileBase?) - Reference to the FileBase object this alias points to (nullable, only set when `is_alias = true`). Loaded from database via `points_to_id`.
- `points_to_id` (int64) - The ID of the FileBase object this alias points to (stored in database, default: 0, foreign key reference)
- `target_path` (string) - The resolved path of the target (for database queries and symlink resolution)
- `base_type` (string) - Type identifier for serialization ("f" for File, "d" for Folder, "fa" for FileAlias, "pf" for ProjectFile)
- `is_active` (bool) - Whether this is the currently active/viewed item
- `language` (string) - Programming language (optional, for files)
- `cursor_line` (int) - Last cursor line number (stored in database, default: 0)
- `cursor_offset` (int) - Last cursor character offset (stored in database, default: 0)
- `scroll_position` (double) - Last scroll position (stored in database, optional, default: 0.0)
- `last_approved_copy_path` (string) - Filename of last approved copy (default: empty string)
- `needs_approval` (bool) - Whether the file needs approval (inverted from is_approved, default: true)
- `is_unsaved` (bool) - Whether the file has unsaved changes (default: false)
- `is_project` (bool) - Whether this folder represents a project (stored in database, default: false)
- `last_viewed` (int64) - Unix timestamp of last view (stored in database, default: 0)
- `icon_name` (string) - Icon name for binding in lists (virtual, overridden by subclasses)
- `display_name` (string) - Display name for binding in lists
- `display_with_indicators` (string) - Display text with status indicators (virtual, overridden by subclasses)
- `tooltip` (string) - Tooltip text for binding in lists
- **Methods**:
  - `mtime_on_disk()` - Get modification time on disk (Unix timestamp)
  - `get_target_info(string target_path)` - Get FileInfo for a given path (for symlink resolution)
  - `compare(FileBase other)` - Compare this FileBase with another to determine if they represent the same item
  - `copy_db_fields_to(FileBase target)` - Copy database-preserved fields from this object to another
  - `saveToDB(SQ.Database db, FileBase? new_values = null, bool sync = true)` - Save to SQLite database
  - `removeFromDB(SQ.Database db)` - Remove from SQLite database
  - `static initDB(SQ.Database db)` - Initialize database table
  - `static query(SQ.Database db)` - Create a query object with typemap configured

**Note**: 
- FileBase provides common properties and methods shared by both File and Folder.
- Many properties that were originally planned for File/Folder are now in FileBase for shared access.
- Alias properties (`is_alias`, `points_to`, `points_to_id`, `target_path`) allow tracking symlinks and aliases.
- `is_alias` is computed by checking if object is instance of FileAlias (no database field needed).
- `target_path` stores the resolved symlink target path for efficient database queries.
- Database operations are handled directly in FileBase (saveToDB, removeFromDB, initDB, query).

##### OLLMcoder.Files.FileAlias (extends File)
- Wrapper class for File objects that are aliases/symlinks
- **Important**: Alias files are NOT used in the editor. All editor-related properties/methods throw errors.
- **Properties that throw errors** (not delegated, throw GLib.error):
  - `language` - Returns null, setter throws error
  - `text_buffer` - Returns null, setter throws error
  - `cursor_line`, `cursor_offset`, `scroll_position` - Return 0/0.0, setters throw error
  - `last_viewed` - Returns 0, setter throws error
  - `needs_approval`, `is_unsaved` - Return true/false defaults, setters throw error
  - `last_approved_copy_path` - Returns empty string, setter throws error
  - `read_async()`, `write()` - Methods throw GLib.error
- **Own properties** (not delegated):
  - `is_alias` - Always true (computed from FileBase)
  - `points_to` - Reference to target FileBase object (set via points_to_id)
  - `points_to_id` - Target file ID (for database persistence, set to -1 if target doesn't exist)
  - `target_path` - Resolved target path (set via realpath() in constructor)
  - `path` - The alias path (where the symlink exists, not the target path)
  - `parent` - The alias's parent folder
- **Constructors**:
  - `FileAlias(ProjectManager manager)` - Basic constructor
  - `FileAlias.new_from_info(Folder parent, FileInfo info, string path)` - Creates from directory enumeration, resolves target_path via realpath()

**Note**: 
- FileAlias wraps a File that is an alias/symlink, but alias files are explicitly NOT used in the editor.
- All editor-related operations throw errors to prevent accidental use.
- The alias maintains its own path and parent (where the alias exists) for filesystem tracking.
- Target resolution uses `realpath()` to fully resolve symlink chains.
- If target doesn't exist, `points_to_id` is set to -1 and `target_path` is empty.

##### OLLMcoder.Files.FolderAlias (extends Folder)
- ‚ùå **NEVER INTENDED** - FolderAlias was a false assumption in the original plan.
- Only FileAlias exists (for file symlinks). Folder symlinks are handled through the normal Folder class with alias properties (is_alias, points_to, points_to_id) when needed.
- No separate FolderAlias wrapper class is required.

##### OLLMcoder.Files.File (extends FileBase)
- Inherits all properties from `OLLMcoder.Files.FileBase` (including language, cursor_line, etc.)
- `text_buffer` (GtkSource.Buffer?) - Pointer to text buffer (GTK-specific, nullable, created when file is first opened)
- `is_open` (bool) - **Computed property**: Whether file was viewed within last week (based on `last_viewed` timestamp from FileBase)
- `needs_approval` (bool) - Whether the file needs approval (inherited from FileBase, default: true)
- `is_unsaved` (bool) - Whether the file has unsaved changes (inherited from FileBase, default: false)
- `icon_name` (string) - **Overridden**: Returns icon based on content type (uses Gio.ContentType)
- `display_with_path` (string) - Display name with path: basename on first line, dirname on second line in grey
- `display_basename` (string) - Display name with basename only
- `display_with_indicators` (string) - **Overridden**: Display text with status indicators (approved checkmark, unsaved dot)
- **Constructors**:
  - `File(ProjectManager manager)` - Basic constructor, sets base_type = "f"
  - `File.new_from_info(Folder parent, FileInfo info, string path)` - Creates from directory enumeration
- **Methods**: 
  - `async read_async()` - Read file contents asynchronously (uses GLib.File.load_contents_async)
  - `write(string contents)` - Write file contents (creates parent directories if needed, emits changed signal)
- **Signals**: `changed` - Emitted when file content changes

**Note**: 
- Most properties (language, cursor_line, etc.) are now in FileBase for shared access.
- `sourceview` property removed from design. SourceView component manages a single view widget and switches buffers.
- Each File object stores its buffer reference for reuse when switching between files.
- `is_open` is computed from `last_viewed` timestamp (within last week = open).
- Buffer state (cursor, scroll) is persisted to database for session restoration.
- Files can be in multiple projects (due to softlinks/symlinks). Alias/symlink information is tracked via FileBase properties.

##### OLLMcoder.Files.FolderFiles (implements GLib.ListModel)
- ‚ö†Ô∏è **Named differently from plan**: Implementation is called `FolderFiles`, not `FolderChildren`
- Implements `GLib.ListModel` interface (not extends ListStore) using `Gee.ArrayList<FileBase>` as backing store
- `child_map` (Gee.HashMap<string, FileBase>) - Hashmap of basename => FileBase for quick lookup by filename
- **ListModel interface methods**:
  - `get_item_type()` - Returns `typeof(FileBase)`
  - `get_n_items()` - Returns number of items in ArrayList
  - `get_item(uint position)` - Returns item at position from ArrayList
- **ListStore-compatible methods**:
  - `append(FileBase item)` - Add item to list and map (checks for duplicates, emits items_changed)
  - `insert(uint position, FileBase item)` - Insert item at position
  - `remove(FileBase item)` - Remove item by reference
  - `remove_at(uint position)` - Remove item at position
  - `remove_all()` - Clear both list and map
  - `find(FileBase item, out uint position)` - Find item and return position
  - `contains(FileBase item)` - Check if item exists (uses child_map lookup)

**Note**: 
- FolderFiles implements ListModel (not extends ListStore) using ArrayList as backing store.
- The `child_map` stores basename (filename in directory) => FileBase for O(1) lookup.
- All append/remove operations automatically update both the list and the map.
- Used by Folder.children to maintain both ordered list and quick lookup capabilities.
- Emits `items_changed` signal for ListModel compatibility.

##### OLLMcoder.Files.Folder (extends FileBase)
- Inherits all properties from `OLLMcoder.Files.FileBase` (including is_project, last_viewed, etc.)
- `children` (OLLMcoder.Files.FolderFiles) - FolderFiles ListModel that manages children (files and subfolders) with integrated basename map - used for tree view hierarchy
- `project_files` (OLLMcoder.Files.ProjectFiles?) - ProjectFiles manager for this project (only set when `is_project = true`, nullable). Wraps ProjectFile objects.
- `last_check_time` (int64) - Last check time for this folder (prevents re-checking during recursive scans)
- **Constructors**:
  - `Folder(ProjectManager manager)` - Basic constructor, sets base_type = "d"
  - `Folder.new_from_info(Folder parent, FileInfo info, string path)` - Creates from directory enumeration
- **Methods**:
  - `async read_dir(int64 check_time, bool recurse = false)` - ‚ö†Ô∏è **Still in Folder** (not moved to ProjectFiles as planned). Load children from filesystem, handles async file enumeration, symlink resolution, updates Folder.children. Excludes .git directories. Recursively reads subdirectories if recurse=true.
  - `load_files_from_db()` - Load project files from database. Three-step process: a) Load files/folders/aliases from DB, b) Recursively load aliased data, c) Build tree structure.
  - `read_dir_scan()` - Private: Scan directory and create FileBase objects for all items found
  - `read_dir_update(FileBase new_item, HashMap<string, FileBase> old_child_map)` - Private: Compare new item with old items and handle updates/inserts
  - `read_dir_remove(ArrayList<FileBase> new_items, ArrayList<FileBase> old_children)` - Private: Check for removed items and remove them
  - `load_children(HashMap<int64, FileBase> id_map, string[] paths, ref string[] seen_ids)` - Private: Load children using path-based queries, following symlinks via target_path
  - `build_tree_structure(FileBase file_base, HashMap<int64, FileBase> id_map)` - Private: Build tree structure by adding file_base to its parent's children

**Note**: 
- Folder uses `FolderFiles` (implements ListModel) which combines list and map functionality.
- `children` is used for the tree view hierarchy - folders contain their child files and subfolders.
- `children.child_map.get(basename)` provides O(1) lookup by filename.
- When `is_project = true`, Folder acts as a project with special project management capabilities.
- ‚ö†Ô∏è **read_dir() is still in Folder** - Not moved to ProjectFiles as originally planned. Folder handles its own directory scanning.
- `project_files` wraps ProjectFile objects (not FileBase) for project-specific file management.
- Database loading uses path-based queries with `instr()` to find children, following symlinks via `target_path`.
- Tree structure is built after loading from database by setting parent references and adding to parent.children.
- Project functionality (previously in separate Project class) is now merged into Folder.

##### OLLMcoder.Files.ProjectFile (extends FileBase)
- ‚úÖ **Intended design**: ProjectFile is a wrapper around a File object for project-specific display (ProjectFiles provides the relationship context)
- Inherits all properties from `OLLMcoder.Files.FileBase`
- `file` (File) - The wrapped File object (construct-only)
- `project` (Folder) - The project folder this file belongs to (construct-only)
- `is_active` (bool) - Delegates to `file.is_active`
- `is_open` (bool) - Delegates to `file.is_open` (but setter exists - may be unused)
- `needs_approval` (bool) - Delegates to `file.needs_approval`
- `is_unsaved` (bool) - Delegates to `file.is_unsaved`
- `display_with_path` (string) - Overridden: Shows relative path from project root (basename + relative path in grey)
- `display_basename` (string) - Delegates to `file.display_basename`
- `display_with_indicators` (string) - Delegates to `file.display_with_indicators`
- **Constructor**:
  - `ProjectFile(ProjectManager manager, File file, Folder project, string path = "")` - Wraps a File object for project-specific display

**Note**: 
- ProjectFile is a wrapper around a File object for use in project file lists (intended design - ProjectFiles provides the relationship context).
- Used for searching on open files and files that need updating.
- Provides all interfaces of FileBase but overrides display name properties to show relative paths.
- The `path` property can be different from `file.path` (allows aliasing within project context).
- Individual file/folder alias/symlink information is tracked via FileBase properties (`is_alias`, `points_to`, `points_to_id`).

##### OLLMcoder.Files.ProjectFiles (implements GLib.ListModel)
- ‚ö†Ô∏è **Different from plan**: ProjectFiles stores ProjectFile objects (wrappers), not FileBase objects
- Implements `GLib.ListModel` interface using `Gee.ArrayList<ProjectFile>` as backing store (private `items` property)
- `child_map` (Gee.HashMap<string, ProjectFile>) - Hashmap of file path => ProjectFile object for quick lookup
- **ListModel interface methods**:
  - `get_item_type()` - Returns `typeof(ProjectFile)` (not FileBase)
  - `get_n_items()` - Returns number of items in ArrayList
  - `get_item(uint position)` - Returns ProjectFile at position from ArrayList
- **ListStore-compatible methods**:
  - `append(ProjectFile item)` - Add item to list and map, emits items_changed
  - `insert(uint position, ProjectFile item)` - Insert item at position
  - `remove(ProjectFile item)` - Remove item by reference
  - `remove_at(uint position)` - Remove item at position
  - `remove_all()` - Clear both list and map
  - `find(ProjectFile item, out uint position)` - Find item and return position
  - `contains(ProjectFile item)` - Check if item exists
- **Methods**:
  - ‚úÖ `update_from(Folder folder)` - Updates project files from folder tree recursively
  - ‚úÖ `get_active_file()` - Returns the active File from project files list
  - ‚ö†Ô∏è `sync_with_filesystem()` - Not implemented (may not be needed)
  - ‚ö†Ô∏è `populate_from_folder()` - Not implemented (update_from() serves this purpose)
  - ‚ö†Ô∏è `clear()` - Not implemented (remove_all() exists)

**Note**: 
- ProjectFiles implements `GLib.ListModel` interface using `Gee.ArrayList<ProjectFile>` as the backing store.
- ‚ö†Ô∏è **Different from plan**: Stores ProjectFile objects (wrappers around File), not FileBase objects.
- The `child_map` provides O(1) lookup by file path for ProjectFile objects.
- ‚úÖ **Core methods implemented**: `update_from()`, `get_active_file()`, ListModel interface methods. Some utility methods (`sync_with_filesystem()`, `clear()`) may not be needed as `update_from()` and `remove_all()` serve the core functionality.
- Currently used as a ListModel wrapper for ProjectFile objects.
- ProjectFiles itself can be used directly as a ListModel (implements GLib.ListModel interface).
- No separate `get_flat_file_list()` method needed - ProjectFiles provides the flat list directly.
- ‚úÖ **FileDropdown updated**: Now uses ProjectFiles directly as ListModel (no copying). Extracts File objects from ProjectFile wrappers for display. Property bindings work with ProjectFile objects.
- **Separation of concerns**: Folder.children provides the hierarchical structure for tree views, while ProjectFiles provides the flat list for dropdowns.

#### Design Decisions (Actual Implementation)
- **File SourceView lifecycle**: Decision pending on whether to keep SourceView open when file is not active, or close/recreate it
- **Multi-project files**: Files can belong to multiple projects (via softlinks/symlinks), tracked via FileBase alias properties
- **GTK-specific properties**: `text_buffer` is nullable and only set when file is open in GTK UI. `sourceview` property removed from design.
- **Project/Folder unification**: ‚úÖ Implemented - Projects are folders with `is_project = true`, eliminating the need for a separate Project class
- **ProjectFile as wrapper**: ProjectFile is a wrapper around File objects for project-specific display (intended design - ProjectFiles provides the relationship context)
- **ProjectFiles class**: ‚úÖ Implemented as ListModel wrapper for ProjectFile objects. Can be used directly as ListModel (no separate get_flat_file_list() needed).
- **Async file I/O in Folder**: ‚úÖ **Intended design** - `read_dir()` is in Folder (correct design decision). Folder handles its own directory scanning.
- **Tree view structure**: ‚úÖ Implemented - Uses Folder.children (FolderFiles ListModel) for hierarchical structure. Each Folder maintains its children list with integrated basename map.
- **FolderFiles class**: ‚úÖ Implemented (named differently from planned FolderChildren) - Implements ListModel with integrated child_map for O(1) basename lookup
- **Alias/symlink scanning**: ‚úÖ Implemented in Folder.read_dir() - Creates FileAlias objects when encountering file symlinks. Uses realpath() to resolve target_path. Folder symlinks are handled through normal Folder class with alias properties (no separate FolderAlias class needed).
- **FileAlias implementation**: ‚úÖ Implemented - Alias files explicitly NOT used in editor (all editor operations throw errors). Maintains own path/parent for filesystem tracking.
- **Hidden directory exclusion**: ‚úÖ Implemented - `.git` directories excluded during Folder.read_dir() scanning
- **Properties in FileBase**: Many properties (language, cursor_line, etc.) moved to FileBase for shared access between File and Folder
- **Database operations in FileBase**: Database operations (saveToDB, removeFromDB, initDB, query) are implemented directly in FileBase

#### ProjectManager Basic Responsibilities (Actual Implementation)
- ‚úÖ Manage project discovery and indexing
- ‚úÖ Keep file/directory objects in memory via `file_cache` (Gee.HashMap<string, FileBase>)
- ‚úÖ **Stores**:
  - `file_cache` (Gee.HashMap<string, FileBase>) - Hashmap of path => FileBase for quick lookup
  - `projects` (Gee.ArrayList<Folder>) - List of all projects (folders where `is_project = true`)
  - `active_project` (Folder?) - Currently active project
  - `active_file` (File?) - Currently active file
  - `db` (SQ.Database?) - Database instance for persistence
- ‚úÖ **Methods**:
  - `activate_file(File? file)` - Activate a file (deactivates previous, saves to DB)
  - `async activate_project(Folder? project)` - Activate a project (initializes ProjectFiles, starts scan)
  - `notify_file_changed(File file)` - Notify that a file's state has changed (save to database)
  - `notify_project_changed(Folder project)` - Notify that a project's state has changed (save to database)
  - `restore_session(out Folder? project, out File? file)` - Restore session from in-memory data structures
- ‚úÖ **Signals**:
  - `active_file_changed(File? file)` - Emitted when active file changes
  - `active_project_changed(Folder? project)` - Emitted when active project changes
- ‚ö†Ô∏è **Missing**: Methods to handle file changes (rename, move) - ProjectFiles manages the file-to-project relationship context
- Note: Database persistence is implemented (saveToDB, removeFromDB in FileBase)

#### Files Status

**‚úÖ Created Files:**
- ‚úÖ `liboccoder/` - Library directory exists
- ‚úÖ `liboccoder/meson.build` - Meson build configuration exists
- ‚úÖ `liboccoder/files/` - Subdirectory for file/folder/project classes exists
- ‚úÖ `liboccoder/files/FileBase.vala` - Base class with shared properties, database operations, alias support
- ‚úÖ `liboccoder/files/File.vala` - File class (extends FileBase)
- ‚úÖ `liboccoder/files/FileAlias.vala` - FileAlias class (throws errors for editor operations)
- ‚úÖ `liboccoder/files/FolderFiles.vala` - FolderFiles class (implements ListModel, named differently from planned FolderChildren)
- ‚úÖ `liboccoder/files/Folder.vala` - Folder class (extends FileBase, has `is_project` flag, includes read_dir())
- ‚úÖ `liboccoder/files/ProjectFile.vala` - ProjectFile class (wrapper around File, not relationship tracker)
- ‚úÖ `liboccoder/files/ProjectFiles.vala` - ProjectFiles class (ListModel wrapper for ProjectFile objects, missing key methods)
- ‚úÖ `liboccoder/ProjectManager.vala` - Project and file management (uses Folder instead of Project)
- ‚úÖ `liboccoder/FileDropdown.vala` - File dropdown widget (updated to use project_files with fallback)

**‚ùå Not Created (Never Intended):**
- ‚ùå `liboccoder/files/FolderAlias.vala` - FolderAlias was a false assumption in original plan (not needed)
- ‚ùå `liboccoder/files/FolderChildren.vala` - Named FolderFiles instead

**‚úÖ Removed:**
- ‚úÖ `liboccoder/files/Project.vala` - Project class removed (functionality merged into Folder)

#### ‚ö†Ô∏è Known Issues and Missing Implementation

**Critical Missing Methods:**

1. **ProjectFiles utility methods** - ‚ö†Ô∏è **OPTIONAL - MAY NOT BE NEEDED**
   - ‚ö†Ô∏è `sync_with_filesystem()` - Not implemented (may not be needed - update_from() handles synchronization)
   - ‚ö†Ô∏è `populate_from_folder()` - Not implemented (update_from() serves this purpose)
   - ‚ö†Ô∏è `clear()` - Not implemented (remove_all() exists and serves this purpose)
   - ‚úÖ `update_from(Folder folder)` - **IMPLEMENTED** - Updates project files from folder tree recursively
   - ‚úÖ `get_active_file()` - **IMPLEMENTED** - Returns the active File from project files list
   - **Impact**: Limited ProjectFiles functionality

**Architecture Differences:**

3. **Folder.read_dir() in Folder** - ‚úÖ **INTENDED DESIGN**
   - Original plan incorrectly assumed `read_dir()` should move to ProjectFiles
   - Actual: `read_dir()` remains in Folder class (correct design decision)
   - Folder is responsible for scanning its own directory structure
   - **No action needed**: This is the intended architecture

4. **ProjectFiles stores ProjectFile objects** - ‚úÖ **INTENDED DESIGN**
   - Original plan incorrectly assumed FileBase objects were needed
   - Actual: Stores ProjectFile objects (wrappers around File) - correct design
   - ProjectFiles works fine with ProjectFile wrappers
   - **No action needed**: This is the intended architecture

5. **ProjectFile is a wrapper, not relationship tracker** - ‚úÖ **INTENDED DESIGN**
   - Original plan incorrectly assumed relationship tracking was needed
   - Actual: ProjectFile is a wrapper around File for display purposes - correct design
   - ProjectFiles provides the relationship context (which files belong to which project)
   - **No action needed**: This is the intended architecture

**Clarifications:**

7. **FolderAlias never intended** - ‚úÖ **NOT AN ISSUE**
   - Original plan incorrectly assumed FolderAlias was needed
   - Only FileAlias exists (for file symlinks)
   - Folder symlinks are handled through normal Folder class with alias properties when needed
   - **No action needed**: This was a false assumption in the original plan

**Code Issues:**

8. **Folder.read_dir_update() has syntax errors and incomplete logic** - ‚úÖ **FIXED**
   - ‚úÖ Fixed extra closing parenthesis
   - ‚úÖ Fixed incomplete assignment (now correctly sets points_to_id)
   - ‚úÖ Fixed alias resolution logic (now checks target_path correctly)
   - ‚úÖ Fixed null check for points_to before calling saveToDB()
   - **Status**: All syntax errors resolved, alias resolution working correctly

9. **Folder.load_children() references undefined variable** - ‚úÖ **FIXED**
   - ‚úÖ Changed `file_base.target_id` to `file_base.points_to_id`
   - **Status**: Database loading of aliased files now works correctly

10. **FileAlias doesn't resolve points_to** - ‚ö†Ô∏è **INCOMPLETE**
    - FileAlias sets `target_path` but doesn't resolve `points_to` object reference
    - `points_to` should be loaded from database via `points_to_id` or looked up in file_cache
    - **Impact**: Alias objects may not have target references set
    - **Fix needed**: Resolve points_to after construction or during database load

**Design Questions:**

11. **How should file-to-project relationships be tracked?** - ‚úÖ **RESOLVED**
    - Current: ProjectFiles provides the relationship context (which files belong to which project)
    - ProjectFile is a wrapper for display, not a relationship tracker
    - **No action needed**: ProjectFiles manages the relationship context, which is sufficient

#### Meson Build Configuration
- **Library Name**: `occoder`
- **VAPI Name**: `occoder.vapi`
- **Header Name**: `occoder.h`
- **Dependencies**: 
  - `gee-0.8`
  - `gio-2.0`
  - `glib-2.0`
  - `gobject-2.0`
  - `sqlite3` (via libocsqlite)
  - `ocsqlite` (link with libocsqlite)
- **GObject Introspection**:
  - Namespace: `OLLMcoder`
  - NSVersion: `1.0`
  - Identifier prefix: `OLLMcoder`
  - Symbol prefix: `ollmcoder`
- **Build Order**: Add `subdir('liboccoder')` to main `meson.build` after `libocsqlite` (depends on it)
- **RPath**: Add liboccoder to build rpath in dependent libraries
- **Main meson.build Update**: 
  - Add `subdir('liboccoder')` in dependency order (after libocsqlite, before libraries that depend on it)
  - Add liboccoder path to library paths for LD_LIBRARY_PATH in wrapper scripts
- **Dependency Updates**:
  - `libollmchatgtk` will need to depend on `liboccoder` (for dropdown widgets)

---

### Phase 1.5: Project Migration

‚úÖ **DONE** - ProjectMigrate class fully implemented with migration from Cursor, roobuilder, and VS Code.

Create a Project Migrate class to read and import project data from existing sources.

#### Component: Project Migrate
- **Namespace**: `OLLMcoder`
- **Class**: `OLLMcoder.ProjectMigrate`
- **Purpose**: Read project and file data from bootstrap sources and prepare for import into liboccoder

#### Data Sources to Read
1. **Cursor SQLite Database**
   - Path: `~/.config/Cursor/User/globalStorage/state.vscdb`
   - Query: `SELECT value FROM ItemTable WHERE key = 'history.recentlyOpenedPathsList';`
   - Extracts recently opened file paths from Cursor

2. **roobuilder Projects List**
   - Path: `~/.config/roobuilder/Projects.list`
   - Contains project information from roobuilder

3. **VS Code Storage**
   - Path: `~/.config/Code/storage.json`
   - Contains VS Code workspace and file history

#### Implementation Details
- Read data from each source
- Parse and normalize project/file paths
- Extract project roots and file associations
- Prepare data structure for import into ProjectManager (Phase 2A)
- Handle missing or inaccessible sources gracefully

#### Files to Create
- `liboccoder/ProjectMigrate.vala` - Migration class (namespace: OLLMcoder)
  - Methods to read from each data source
  - Data normalization and parsing
  - Output format for ProjectManager import

#### Dependencies
- Uses libocsqlite for reading Cursor SQLite database
- JSON parsing for VS Code storage
- File I/O for roobuilder Projects.list

---

### Phase 2B: Database Schema and Sync

‚úÖ **DONE** - Database integration implemented: ProjectManager has `db` property, FileBase has `initDB()` and `saveToDB()` methods with sync parameter. Database schema complete, save/load functionality working. Background sync and file system watcher moved to Phase 8.

Add database persistence functionality to ProjectManager.

#### Database Schema
- SQLite tables to store file information and directories:
  - **filebase table**: Stores File and Folder objects (including projects via `is_project` flag)
  - **projectfile table**: Stores ProjectFile relationships (file-to-project associations)
- Fields to track:
  - File paths
  - Directory structure
  - **Project flag**: `is_project` (INTEGER) for folders/files that are projects
  - **Alias/symlink tracking**: `is_alias` (INTEGER), `points_to` (TEXT - stores target path for loading object reference), `points_to_id` (INT64) for tracking symlinks and aliases. Note: `points_to` property in code is `FileBase?` object reference, loaded from `points_to_id`.
  - **ProjectFile relationships**: `file_id`, `path`, `alias`, `target`, `last_accessed`
  - Metadata (timestamps, etc.)
  - **Active state**: `is_active` (INTEGER) for files and projects
  - **Buffer state**: `cursor_line`, `cursor_offset`, `scroll_position`, `last_viewed` (INTEGER/REAL) for files
  - **Project state**: `is_active` (INTEGER), `last_viewed` (INTEGER) for projects (folders with `is_project = true`)

#### ProjectManager Database Integration
- Uses libocsqlite (SQ library) for database operations
- Methods to:
  - Update representation of files as objects
  - Sync objects to database (via libocsqlite)
  - Sync to UI if necessary (when UI is active)
- ‚úÖ **Implemented**: Database schema, save/load methods, backup functionality
- ‚úÖ **Implemented**: Database dirty flag (`is_dirty`) - tracks unsaved changes in memory
- ‚úÖ **Implemented**: Optional periodic autosave - Database constructor accepts `autosave` parameter (default: false)
  - When enabled, checks `is_dirty` every minute and saves to disk if dirty
  - Manual saves (e.g., `backupDB()`) reset the dirty flag immediately
  - All database writes mark the database as dirty (via `db.is_dirty = true`)
- ‚è≥ **Moved to Phase 8**: Background sync process and file system watcher for real-time updates

#### Files to Modify
- `liboccoder/ProjectManager.vala` - Add database persistence and sync methods

---

### Phase 2C: Searchable Dropdown Widgets

‚úÖ **DONE** - SearchableDropdown base class, ProjectDropdown, and FileDropdown widgets fully implemented. FileDropdown uses ProjectFiles directly as ListModel. Still need: sections/separators for "recent" vs "rest" items (optional enhancement).

Create searchable dropdown widgets for Project and File selection.

#### Component: Searchable Dropdowns
- **Location**: Header bar above source view
- **Layout**:
  - **Project dropdown**: Left side, searchable
  - **File dropdown**: Right side, searchable (with nested tree view tab)
- **Functionality**:
  - Both support search/filter interface
  - Can open files or switch projects
  - Query data via ProjectManager (from in-memory objects, backed by database from Phase 2B)
  - **File dropdown popup**: Will have a separate tab showing a nested tree view of the project structure (using Folder.children hierarchy)

#### Implementation Details
- **Wrapper Pattern**: GTK4 dropdowns are sealed classes, so we wrap them rather than extend
- **Naming Convention**: Use `this.ell` pattern for internal widget references (not overly explicit like `this.dropdown`)
- Create wrapper widgets that contain the dropdown and add search/filter functionality
- Integrate with ProjectManager for data access
- Populate dropdowns from ProjectManager's in-memory objects

#### Files Created
- `liboccoder/SearchableDropdown.vala` - Base class for searchable dropdown widgets
- `liboccoder/ProjectDropdown.vala` - Searchable project dropdown widget (extends SearchableDropdown)
- `liboccoder/FileDropdown.vala` - Searchable file dropdown widget (extends SearchableDropdown)

**Note**: Files are in liboccoder (data layer) rather than libollmchatgtk, which is appropriate as they integrate with ProjectManager.

#### FileDropdown Tree View Tab
- **Status**: ‚è≥ **Moved to Phase 2D** - See Phase 2D section for detailed implementation plan
- **Note**: The tree structure uses Folder.children for the hierarchy - each Folder maintains its children list, making it suitable for tree view widgets

#### Sections/Separators in Dropdowns (TODO)

**Requirement**: Add visual separators between "recent" and "rest" of projects/files in dropdowns.

**Implementation Approach**:
- **Option 1: Wrapper objects with separators**
  - Create a wrapper class (e.g., `DropdownSection`) that can represent either an item or a separator
  - Factory checks if item is a separator and creates `Gtk.Separator` widget
  - Populate store with: [recent items...], [separator], [rest of items...]
  
- **Option 2: Custom factory with position detection**
  - Factory detects position in list (e.g., after last recent item)
  - Inserts separator widget at appropriate position
  - Requires tracking which items are "recent" vs "rest"

- **Option 3: Two separate stores with separator between**
  - Use `Gtk.FlattenListModel` to combine: recent_store, separator_item, rest_store
  - Simpler but requires managing two stores

**Recommended**: Option 1 (wrapper objects) - most flexible and clean.

**Implementation Details**:
```vala
// Wrapper class for dropdown items
internal class DropdownItem : Object {
  public Files.FileBase? item { get; set; }
  public bool is_separator { get; set; default = false; }
  public string? separator_label { get; set; } // e.g., "Recent", "All Projects"
}

// In factory setup:
factory.setup.connect((list_item) => {
  var item = list_item.item as DropdownItem;
  if (item.is_separator) {
    var separator = new Gtk.Separator(Gtk.Orientation.HORIZONTAL);
    var label = new Gtk.Label(item.separator_label) {
      halign = Gtk.Align.START,
      margin_start = 5
    };
    var box = new Gtk.Box(Gtk.Orientation.VERTICAL, 0);
    box.append(label);
    box.append(separator);
    list_item.child = box;
  } else {
    // Normal item setup
  }
});
```

**Sorting Logic**:
- **ProjectDropdown**: Sort by `is_active` first (active project at top), then by `last_viewed` (recent first), then alphabetically
- **FileDropdown**: Sort by `is_active` first (active file at top), then by `is_open` (recently viewed within last week), then alphabetically
- Insert separator after active/recent items, before rest

**Recent Definition**:
- **Projects**: `is_active = true` OR `last_viewed` within last week
- **Files**: `is_active = true` OR `is_open = true` (which is computed from `last_viewed` within last week)

---

### Phase 2D: Tabbed FileDropdown

‚è≥ **TODO** - Add tabbed interface to FileDropdown widget for dual navigation modes.

#### Component: Tabbed FileDropdown
- **Purpose**: Provide two navigation modes for file selection
- **Location**: Extends existing FileDropdown widget

#### Tab 1: Search Mode (Current Implementation)
- **Description**: Search through ProjectFiles (flat list)
- **Functionality**: 
  - Current searchable dropdown implementation
  - Filters files by name/path
  - Shows all files in project as flat list
  - Sorted by open status, then by path

#### Tab 2: Tree Navigation Mode
- **Description**: Tree view of Folder.children hierarchy
- **Data Source**: `project.children` (FolderFiles ListModel)
- **Functionality**:
  - Hierarchical tree view showing folder structure
  - All folders expanded by default
  - Click folders to expand/collapse
  - Click files to select
  - Visual tree structure with indentation
- **Implementation**:
  - Use `Gtk.TreeView` or `Gtk.ColumnView` with tree model
  - Bind to `project.children` (FolderFiles) which maintains Folder.children hierarchy
  - Use `Gtk.TreeListModel` to create tree structure from FolderFiles
  - Each Folder maintains its children via Folder.children (FolderFiles ListModel)

#### UI Design
- **Tab Switcher**: Add `Gtk.Notebook` or `Gtk.StackSwitcher` to FileDropdown popup
- **Tab 1 Label**: "Search" or "List"
- **Tab 2 Label**: "Tree" or "Folders"
- **Default Tab**: Tab 1 (Search mode) for backward compatibility

#### Files to Modify
- `liboccoder/FileDropdown.vala` - Add tabbed interface with tree view tab

---

### Phase 3: Source View Component

üü° **PARTIALLY DONE** - SourceView component implemented with core functionality. Approximately 75% complete.

**‚úÖ Implemented:**
- Header bar with Project and File dropdowns
- Code editor (GtkSource.View) in ScrolledWindow
- Single SourceView with buffer switching strategy
- Buffer management (create, reuse, store in File.text_buffer)
- Language detection and syntax highlighting
- File switching workflow (save state, activate, load, restore cursor)
- Project switching workflow
- Cursor position save/restore (line and offset)
- Last viewed timestamp tracking
- Unsaved changes tracking via buffer modified property
- Navigate to line functionality
- ProjectManager integration (all required methods)
- File content loading (async read_async)

**‚ö†Ô∏è Partially Implemented:**
- Session restoration: Method exists but commented out (~20%)
- Error handling: Basic warnings but no user interaction/dialogs (~40%)
- File refresh: Method exists but errors out instead of prompting user (~60%)

**‚ùå Not Implemented:**
- Search functionality (GtkSource.SearchContext, search UI, keyboard shortcuts)
- Selection save/restore
- Error markers and diagnostics (GtkSource.Mark, error highlighting)
- User-configurable editor settings UI

Add the source view component to the tabbed container inside the window pane.

#### Component: Source View
- **Location**: Added to tabbed container in window pane (right side)
- **Layout**:
  - **Header Bar**: Contains Project dropdown (left), File dropdown (right), and Save button (next to file dropdown)
  - **Code Editor**: GTK SourceView or similar code editor component
- **Sizing**:
  - Minimum width: 400px
  - No responsibility for pane sizing (handled by WindowPane)

#### Design Decision: Buffer Switching Strategy

**Research Findings:**
- ‚úÖ **Buffer switching is feasible**: `GtkSource.View.set_buffer()` (inherited from `Gtk.TextView`) allows switching buffers at runtime
- ‚úÖ **API supports it**: The GTK4 API explicitly supports this pattern - one view can display different buffers
- ‚úÖ **One buffer can be shared**: A single buffer can be displayed in multiple views (though we won't need this)
- ‚ö†Ô∏è **View state is separate**: Cursor position, scroll position, selection are view-specific, not buffer-specific

**Chosen Approach: Single SourceView with Buffer Switching**

**Rationale:**
1. **Memory efficiency**: One view widget instead of one per file
2. **Simpler management**: Single view to maintain, configure, and style
3. **State management**: View state (cursor, scroll) is maintained per-view, so switching buffers will reset these (acceptable behavior)
4. **Proven pattern**: Used in existing codebase (RenderSourceView, RequestRunCommand)

**Alternative Considered:**
- Multiple SourceViews (one per file) with visibility switching
- **Rejected because**: More complex state management, higher memory usage, no clear benefit

#### Implementation Details

##### Buffer Management
- **Single SourceView widget**: One `GtkSource.View` instance in the SourceView component
- **Buffer per file**: Each `OLLMcoder.Files.File` object can have an associated `GtkSource.Buffer`
- **Buffer lifecycle**:
  - Create buffer when file is first opened
  - Store buffer reference in File object (via `text_buffer` property - see Phase 2A note)
  - Reuse existing buffer when switching back to a previously opened file
  - Switch view to file's buffer using `source_view.set_buffer(file.text_buffer)`
- **Buffer creation**:
  - Detect language from file extension/path
  - Create `GtkSource.Buffer.with_language()` if language detected
  - Fall back to `GtkSource.Buffer(null)` if no language match
  - Load file content into buffer: `buffer.text = yield file.read_async()`

##### File Switching Workflow
1. **User selects file from FileDropdown**
2. **SourceView receives file selection signal**
3. **Save current file state** (if switching away):
   - Save cursor position to `file.cursor_line` and `file.cursor_offset`
   - Save scroll position (if tracking)
   - Update `file.last_viewed` timestamp
   - Call `manager.notify_file_changed(file)` to update database
4. **Notify manager**: Call `manager.activate_file(file)` to:
   - Deactivate previous active file (`is_active = false`)
   - Activate new file (`is_active = true`)
   - Update database
5. **Check if file has existing buffer**:
   - If `file.text_buffer != null`: Reuse existing buffer
   - If `file.text_buffer == null`: Create new buffer, load content, store reference
6. **Switch view to file's buffer**: `source_view.set_buffer(file.text_buffer)`
7. **Restore buffer state**:
   - Restore cursor position from `file.cursor_line` and `file.cursor_offset`
   - Restore scroll position (if saved)
   - Update `file.last_viewed` timestamp
8. **Update UI**: Refresh dropdowns, update header display

##### Language Detection
- Use `GtkSource.LanguageManager.get_default()` to detect language from file path
- Map common file extensions to GtkSource language IDs
- Set buffer language when creating buffer (affects syntax highlighting)
- Language is buffer property, persists when switching buffers

##### Buffer State Persistence
- ‚úÖ **IMPLEMENTED** - Cursor position and last_viewed timestamp
- ‚úÖ **IMPLEMENTED** - Scroll position (first visible line) saved/restored with rate limiting
- ‚ùå **NOT IMPLEMENTED** - Selection save/restore
- **State to store**: Cursor position, scroll position, selection (if any)
- **Storage location**: File object properties and database
- **Database fields** (‚úÖ all exist in FileBase table):
  - ‚úÖ `cursor_line` (int) - Last cursor line number - **SAVED AND RESTORED**
  - ‚úÖ `cursor_offset` (int) - Last cursor character offset - **SAVED AND RESTORED**
  - ‚úÖ `scroll_position` (double) - Last scroll position (first visible line) - **SAVED AND RESTORED WITH RATE LIMITING**
  - ‚úÖ `last_viewed` (int64) - Unix timestamp of last view - **SAVED AND RESTORED**
- **Restore on open**: ‚úÖ When switching to a file, restore cursor position and scroll position from stored state
- **Save on switch**: ‚úÖ When switching away from a file, save current buffer state (cursor, scroll position, last_viewed) to File object and database
- **Scroll position rate limiting**: ‚úÖ Debounced with 500ms delay - only saves after scrolling stops to reduce database writes

##### Cursor Position and Navigation
- **Cursor position**: Restore from File object when switching to file, save when switching away
- **Navigate to line**: When opening/switching to file, can navigate to specific line (overrides saved position):
  ```vala
  Gtk.TextIter iter;
  buffer.get_iter_at_line(out iter, line_number);
  buffer.place_cursor(iter);
  source_view.scroll_to_iter(iter, 0.0, false, 0.0, 0.5);
  ```
- **Selection**: Save selection range when switching away, restore if still valid

##### File Content Synchronization
- ‚úÖ **Initial load**: Read file from disk when creating buffer - **IMPLEMENTED**
- ‚è≥ **File changes**: Monitor file system for changes (future: Phase 8 file watcher) - **NOT IMPLEMENTED**
- ‚úÖ **Unsaved changes**: Track via buffer's `modified` property - **IMPLEMENTED** (connected to file.is_unsaved)
- ‚ö†Ô∏è **Reload prompt**: `refresh_file()` method exists but errors out instead of prompting user - **PARTIALLY IMPLEMENTED**
- ‚úÖ **File saving**: `save_file()` method writes buffer content to file - **IMPLEMENTED**
  - Save button in header bar (next to file dropdown) with tooltip "Save file"
  - Ctrl-S keyboard shortcut for saving
  - Saves buffer content to disk and forces immediate database backup
  - Resets buffer modified flag and file.is_unsaved after successful save

##### ProjectManager Integration
- **SourceView requires ProjectManager**: SourceView must have a `manager` property (OLLMcoder.ProjectManager)
- **Manager responsibilities**:
  - Track active project and active file
  - Handle activation/deactivation of files and projects
  - Update database when files/projects change
  - Provide methods for SourceView to call
- **Manager methods to add**:
  ```vala
  // Activate a file (deactivates previous active file)
  public void activate_file(OLLMcoder.Files.File file)
  
  // Activate a project (deactivates previous active project)
  // Note: Projects are Folders with is_project = true
  public void activate_project(OLLMcoder.Files.Folder project)
  
  // Notify that a file's state has changed (save to database)
  public void notify_file_changed(OLLMcoder.Files.File file)
  
  // Notify that a project's state has changed (save to database)
  // Note: Projects are Folders with is_project = true
  public void notify_project_changed(OLLMcoder.Files.Folder project)
  
  // Get active project
  // Note: Returns Folder with is_project = true, or null
  public OLLMcoder.Files.Folder? get_active_project()
  
  // Get active file
  public OLLMcoder.Files.File? get_active_file()
  ```
- **Signals on Manager** (optional, for UI updates):
  ```vala
  public signal void active_file_changed(OLLMcoder.Files.File? file)
  // Note: Projects are Folders with is_project = true
  public signal void active_project_changed(OLLMcoder.Files.Folder? project)
  ```

##### Integration Points
- **ProjectDropdown**: When project changes, call `manager.activate_project(project)`, update FileDropdown's project
- **FileDropdown**: When file selected, trigger file switching workflow (which calls `manager.activate_file()`)
- **ProjectManager**: Query files from active project's `project_files` (always initialized, non-nullable)
- **File objects**: Store buffer references, track active state, store buffer state (cursor, scroll)
- **ProjectFiles**: Provides both tree structure (for tree views) and hashmap (for fast lookups) for project files

##### Component Structure
```
SourceView (Gtk.Box, vertical)
‚îú‚îÄ‚îÄ HeaderBar (Gtk.Box, horizontal)
‚îÇ   ‚îú‚îÄ‚îÄ ProjectDropdown (left-aligned)
‚îÇ   ‚îú‚îÄ‚îÄ [Spacer - space for future widgets]
‚îÇ   ‚îî‚îÄ‚îÄ FileDropdown (right-aligned)
‚îî‚îÄ‚îÄ ScrolledWindow
    ‚îî‚îÄ‚îÄ GtkSource.View
        ‚îî‚îÄ‚îÄ (buffer switched dynamically)
```

**Header Layout:**
- Project dropdown: Left side, left-aligned
- File dropdown: Right side, right-aligned
- Save button: Right side, next to file dropdown (with tooltip "Save file")
- Middle space: Reserved for future widgets (not yet decided)

##### Signals and Events
- **File selection**: Connect to FileDropdown's `file_selected` signal
- **Project selection**: Connect to ProjectDropdown's `project_selected` signal
- **Buffer modified**: Connect to buffer's `modified-changed` signal to track unsaved changes
- **File changed**: Future: Connect to file system watcher (Phase 8)

##### Methods to Expose
- ‚úÖ `open_file(OLLMcoder.Files.File file, int? line_number = null)` - **IMPLEMENTED** - Open/switch to file, optionally navigate to line (calls manager.activate_file())
- ‚úÖ `open_project(OLLMcoder.Files.Folder project)` - **IMPLEMENTED** - Switch to project (calls manager.activate_project(), project must have is_project = true)
- ‚úÖ `current_file` (property) - **IMPLEMENTED** - Returns currently active File object
- ‚úÖ `current_project` (property) - **IMPLEMENTED** - Returns currently active project Folder object (from manager, Folder with is_project = true)
- ‚úÖ `current_buffer` (property) - **IMPLEMENTED** - Returns current GtkSource.Buffer
- ‚úÖ `navigate_to_line(int line_number)` - **IMPLEMENTED** - Navigate to line in current file
- ‚ö†Ô∏è `refresh_file()` - **PARTIALLY IMPLEMENTED** - Reload current file from disk (exists but errors out instead of prompting for unsaved changes)
- ‚ö†Ô∏è `restore_session()` - **NOT CALLED** - Restore active project and file from database (method exists in ProjectManager but not called from SourceView constructor - commented out)
- ‚úÖ `save_file()` - **IMPLEMENTED** - Save current buffer content to file with Ctrl-S shortcut and save button

#### Files Created
- ‚úÖ `liboccoder/SourceView.vala` - Source view component with header bar and editor (in liboccoder, not libollmchatgtk)

**Implementation Status:**
- ‚úÖ Core component structure complete
- ‚úÖ Buffer management complete
- ‚úÖ File/project switching complete
- ‚úÖ State persistence (cursor, scroll position, last_viewed) complete
- ‚úÖ Scroll position persistence with rate limiting (500ms debounce)
- ‚úÖ File saving implemented (save_file() method, Ctrl-S, save button)
- ‚úÖ Database dirty flag and periodic autosave (optional, configurable in Database constructor)
- ‚ö†Ô∏è Session restoration disabled (commented out)
- ‚ùå Search functionality not implemented
- ‚ùå Error markers/diagnostics not implemented

#### File.is_open Semantics Change
- **Current**: `is_open` is a simple boolean property
- **New requirement**: Since there's only one editor and no close button, `is_open` should represent "recently viewed"
- **Implementation**: Make `is_open` a computed property that checks if `last_viewed` is within the last week
- **Database**: Store `last_viewed` timestamp (int64, Unix timestamp)
- **Logic**:### Search Functionality

**Feature**: In-buffer search with highlighting and navigation.

**Implementation**:
- **GtkSource.SearchContext**: Use for search functionality
- **Search options**: Case sensitive, regex, multiline support
- **Navigation**: Forward/backward search with keyboard shortcuts (Ctrl+G, Ctrl+Shift+G)
- **Search UI**: Add search entry widget to footer bar below the code editor
- **Result display**: Show match count (e.g., "3 matches")

  ```vala
  public bool is_open {
    get {
      if (this.last_viewed == 0) {
        return false;
      }
      var now = new DateTime.now_local();
      var one_week_ago = now.add_days(-7);
      var viewed_time = new DateTime.from_unix_local(this.last_viewed);
      return viewed_time.compare(one_week_ago) > 0;
    }
  }
  ```
- **Update**: Set `last_viewed` timestamp whenever file is viewed/opened

#### Session Restoration
- ‚ö†Ô∏è **PARTIALLY IMPLEMENTED** - Method exists but is commented out in constructor
- **On startup**: SourceView should restore the last active project and file from database
- **Database query**: Query for project/file where `is_active = 1`
- **Workflow**:
  1. On SourceView initialization, call `restore_session()` (currently disabled)
  2. Query database for active project and active file
  3. If found, call `manager.activate_project()` and `manager.activate_file()` (without saving, just setting state)
  4. Open the file in the editor
  5. Restore buffer state (cursor, scroll position)
- **Status**: Code exists in ProjectManager.restore_session() but SourceView.restore_session() is not called (commented out on line 135)

#### Dependencies
- SourceView is part of `liboccoder` (not libollmchatgtk) - it's a data layer component
- Requires `gtksourceview-5` (for GtkSource.View and GtkSource.Buffer)
- GTK4 widgets (Gtk.Box, Gtk.ScrolledWindow)
- SourceView must have `manager` property (OLLMcoder.ProjectManager) - set in constructor
- liboccoder will need GTK4 dependency (already added in meson.build)

#### Additional Features to Consider (from roobuilder Editor.vala)

‚è≥ **NOT IMPLEMENTED** - Error markers and diagnostics not yet added to SourceView.

##### Error Markers and Diagnostics
- **GtkSource.Mark for line markers**: Use `GtkSource.Mark` to show error/warning/deprecation markers in the left gutter
- **GtkSource.MarkAttributes**: Configure icons and tooltips for different mark categories:
  - ERR: `dialog-error` icon, pink background highlight
  - WARN: `dialog-warning` icon, light blue background highlight  
  - DEPR: `dialog-information` icon, purple background highlight
- **Text tags for highlighting**: Use `Gtk.TextTag` to highlight error ranges with background colors
- **Tooltip integration**: Show diagnostic messages when hovering over marks or error-highlighted text
- **Mark management**: Track marks per file, remove old marks when diagnostics update
- **Implementation pattern**:
  ```vala
  // Create mark attributes
  var attrs = new GtkSource.MarkAttributes();
  attrs.set_icon_name("dialog-error");
  attrs.query_tooltip_text.connect((mark) => { return mark.name; });
  source_view.set_mark_attributes("ERR", attrs, 1);
  
  // Create marks and tags
  var mark = buffer.create_source_mark(message, category, iter);
  var tag = buffer.create_tag("ERR" + counter, "background", "pink");
  buffer.apply_tag(tag, start_iter, end_iter);
  ```

##### Editor Settings
- **Line marks**: `source_view.show_line_marks = true` - Enables gutter for error markers
- **Current line highlight**: `source_view.highlight_current_line = true`
- **Line numbers**: `source_view.show_line_numbers = true`
- **Space drawer**: Show whitespace characters (optional, for debugging)
- **Font size control**: Scale widget to adjust editor font size (optional)

##### Search Functionality

‚è≥ **NOT IMPLEMENTED** - Search functionality not yet added to SourceView.

**Reference Implementation**: See `/home/alan/gitlive/roobuilder/src/Builder4/Editor.vala` for complete search implementation.

**Feature**: In-buffer search with highlighting and navigation - simple to add using existing code pattern.

**Implementation**:
- **GtkSource.SearchContext**: Use `GtkSource.SearchContext` with `GtkSource.SearchSettings`
- **Search options**: Case sensitive, regex, multiline support (via SearchSettings)
- **Navigation**: Forward/backward search with keyboard shortcuts (Ctrl+G, Ctrl+Shift+G)
- **Search UI**: Add search entry widget to footer bar below the code editor
- **Result display**: Show match count (e.g., "3 matches")
- **Highlighting**: Use `searchcontext.set_highlight(true)` to highlight all matches

**Implementation Pattern** (from roobuilder Editor.vala):
```vala
// Create search settings
var search_settings = new GtkSource.SearchSettings();
search_settings.case_sensitive = case_sensitive_checkbox.active;
search_settings.regex_enabled = regex_checkbox.active;
search_settings.wrap_around = false;

// Create search context
var searchcontext = new GtkSource.SearchContext(buffer, search_settings);
searchcontext.set_highlight(true);
search_settings.set_search_text(search_text);

// Forward search
Gtk.TextIter beg, st, en;
bool has_wrapped_around;
buffer.get_iter_at_offset(out beg, last_search_end);
if (searchcontext.forward(beg, out st, out en, out has_wrapped_around)) {
    buffer.place_cursor(st);
    source_view.scroll_to_iter(st, 0.1f, true, 0.0f, 0.5f);
    last_search_end = en.get_offset();
}

// Get match count
var count = searchcontext.get_occurrences_count();
```

**UI Location**: Footer bar below the SourceView editor (simple addition, not complex).

**Note**: Error markers are the most important feature to consider for Phase 3, as they provide immediate visual feedback about code issues. Search functionality is also straightforward to add using the existing roobuilder pattern.

#### Testing Considerations
- Test buffer switching with files of different languages
- Test switching between files rapidly
- Test opening same file multiple times (should reuse buffer)
- Test language detection for various file extensions
- Test cursor position after buffer switch (should reset)
- Test file content reloading
- Test error markers display and removal
- Test error marker tooltips
- Test error highlighting with text tags

---

### Phase 4: Configuration Persistence (Future)

Save and restore UI state preferences.

#### Configuration to Persist
- **Source View Width**: Save the user's preferred source view pane width
- Restore this width when opening code view (used in Phase 1 visibility toggle)
- Store in application settings/preferences

#### Implementation Details
- Use GSettings or similar configuration system
- Save width when user adjusts pane
- Restore on application startup and when switching to code assist mode

#### Files to Create/Modify
- Configuration management module
- Update WindowPane to use saved width when available

---

### Phase 5: CodeAssistant Integration

‚è≥ **TODO** - CodeAssistantProvider still uses OpenFile tracking, not integrated with ProjectManager yet.

Integrate CodeAssistant prompt system with ProjectManager and the code editor.

#### CodeAssistant Integration
- **Current Location**: `libollmchat/Prompt/CodeAssistant.vala`
- **Integration**: CodeAssistant prompt system will use ProjectManager to:
  - Get workspace path from active project
  - Access file contents via ProjectManager
  - Track open files and active file state from SourceView
- **Provider**: `CodeAssistantProvider` (in `libollmchatgtk/Prompt/CodeAssistantProvider.vala`) will integrate with:
  - ProjectManager for project/file access
  - SourceView for active file and cursor position tracking
- **Note**: CodeAssistant remains in `libollmchat` but will depend on `liboccoder` for data access

#### Implementation Details
- Update CodeAssistantProvider to use ProjectManager instead of OpenFile tracking
- Connect SourceView to CodeAssistantProvider for active file updates
- Integrate cursor position and selection tracking from code editor
- Update CodeAssistant to use ProjectManager for workspace and file access

#### Files to Modify
- `libollmchatgtk/Prompt/CodeAssistantProvider.vala` - Integrate with ProjectManager and SourceView
- `libollmchat/Prompt/CodeAssistant.vala` - Update to use ProjectManager for workspace/file access (if needed)

#### Dependency Updates
- `libollmchat` will need to depend on `liboccoder` (for CodeAssistant integration)

---

### Phase 6: File Approval and Version Tracking (Future)

Implement file approval workflow and version tracking system.

#### Auto-commit Assumption
- All changes are assumed to be auto-committed
- **Important**: Git committing automatically should NOT be done on main/master branch
- Use work-in-progress branch for automatic commits
- Need to track which version of file has been approved

#### Approval States
1. **Full file approval**: Jumps to the approved state of the file
2. **Partial file approval**: More complicated
   - Need temporary approved copy of the file
   - Diff against temporary approved copy
   - When further changes occur, compare to temporary approved copy rather than committed copy
   - Handle sliding window between approval process

#### Version Tracking
- Track approved file version
- Maintain temporary approved copy for partial approvals
- Diff management between approved and current state

#### Implementation Details
- Design approval workflow UI
- Handle edge cases in partial approval
- Manage temporary approved file copies
- Diff algorithm for comparing against approved state
- UI for showing changes and approval status

#### Files to Create/Modify
- Code editor component with diff view
- Approval UI components
- File version tracking system
- Temporary file management for partial approvals

---

### Phase 7: Code Editor Manager Tool

‚è≥ **TODO** - CodeEditorManager tool not yet implemented.

---

### Phase 8: Background Sync and File Watcher

‚è≥ **TODO** - Background sync process and file system watcher for real-time updates.

#### Component: Background Sync and File Watcher
- **Purpose**: Keep database and in-memory objects synchronized with filesystem changes
- **Location**: `liboccoder/ProjectManager.vala` and new watcher component

#### Background Sync Process
- **Functionality**:
  - Periodic background process to update database
  - Sync objects to database (via libocsqlite)
  - Sync to UI if necessary (when UI is active)
  - Handle file system changes detected by watcher
- **Implementation**:
  - Use `GLib.Timeout` or `GLib.Idle` for periodic sync
  - Process queued file system events from watcher
  - Update ProjectFiles when files are added/removed/modified

#### File System Watcher
- **Functionality**:
  - Monitor file system for real-time updates
  - Detect file changes (create, modify, delete, move)
  - Detect directory changes (create, delete, move)
  - Queue events for background sync process
- **Implementation**:
  - Use `Gio.FileMonitor` for file system monitoring
  - Monitor project root directories
  - Handle symlink/alias changes
  - Integrate with Folder.read_dir() for directory scanning

#### Integration Points
- **ProjectManager**: Coordinate watcher and sync process
- **Folder.read_dir()**: Triggered by watcher events or periodic sync
- **ProjectFiles**: Updated when files are added/removed/modified
- **UI Updates**: Emit signals when changes detected (for UI refresh)

#### Files to Create/Modify
- `liboccoder/ProjectManager.vala` - Add background sync and watcher management
- `liboccoder/files/Folder.vala` - Integrate with watcher events (optional)

---

Create a tool that allows the LLM to manage the code editor interface.

#### Component: Code Editor Manager Tool
- **Namespace**: `OLLMchat.Tools`
- **Class**: `OLLMchat.Tools.CodeEditorManager` (implements `OLLMchat.Tool.Interface`)
- **Request Handler**: `OLLMchat.Tools.RequestCodeEditorManager` (extends `OLLMchat.Tool.RequestBase`)
- **Purpose**: Allow LLM to control file navigation and cursor positioning in the code editor UI

#### Tool Capabilities
Single unified tool that handles:
- **Open/Switch to file**: Open a file in the SourceView code editor, or switch to an already open file/tab
- **Navigate to line**: Jump to a specific line number in the current or target file
- Parameters: `file_path` (required), `line_number` (optional)

**Note**: Query operations (get cursor position, get selected text, get file contents) are already provided by `CodeAssistantProvider` (Phase 5) and do not need to be duplicated in this tool.

#### Implementation Details
- Tool follows the same pattern as `ReadFile`, `EditMode`, `RunCommand`
- Single tool handles both file opening/switching and line navigation
- If file is not open, opens it; if already open, switches to it
- If line_number is provided, navigates to that line after opening/switching
- Integrates with SourceView component from Phase 3
- May need to integrate with WindowPane to ensure code view is visible
- Request handler will need access to SourceView instance
- GTK-specific implementation in `libollmchatgtk/Tools/RequestCodeEditorManager.vala`

#### EditMode Integration
- **Component**: `OLLMchat.Tools.EditModeWrapper`
- **Purpose**: Intercept EditMode changes and update SourceView editor UI
- **Implementation**: 
  - Wraps the existing `EditMode` tool
  - Connects to `EditMode.change_done` signal to intercept file changes
  - Updates SourceView when files are edited via EditMode tool
  - If file is open in editor, refreshes content and highlights changes
  - If file is not open, optionally opens it in editor to show changes

#### Files to Create
- `libollmchat/Tools/CodeEditorManager.vala` - Tool interface definition
- `libollmchat/Tools/RequestCodeEditorManager.vala` - Base request handler
- `libollmchatgtk/Tools/RequestCodeEditorManager.vala` - GTK-specific implementation with SourceView integration (SourceView is in liboccoder, accessed via manager)
- `libollmchatgtk/Tools/EditModeWrapper.vala` - Wrapper to intercept EditMode changes and update SourceView

#### Files to Modify
- `ollmchat/Window.vala` - Add CodeEditorManager tool to client, use EditModeWrapper instead of direct EditMode
- `liboccoder/SourceView.vala` - Expose methods for tool to control editor (open file, navigate, refresh content, highlight changes)
- `ollmchat/WindowPane.vala` - May need to expose method to show/ensure code view is visible

---

## Future Considerations (Not in Current Scope)

These are features and issues that will need to be addressed in the future but are not part of the current implementation plan.

### Forward/Back Navigation

**Issue**: Users may want to navigate forward/back through their file viewing history (like browser history).

**Considerations**:
- Maintain a history stack of viewed files
- Track navigation order (not just active file)
- Support forward/back buttons or keyboard shortcuts
- Handle history when switching projects
- Decide if history is per-window or global
- Store history in database for persistence across sessions

**Implementation Notes**:
- Could use a simple stack: `Gee.ArrayList<OLLMcoder.Files.File>` for history
- Need to track current position in history (not just top of stack)
- History should update when user manually selects file (adds to history)
- History should update when navigating forward/back (moves position)

### Aliasing Issues (Files in Multiple Projects)

**Issue**: Files can belong to multiple projects via symlinks/softlinks. Current design tracks this via `ProjectFile` relationships, but there are unresolved questions.

**Considerations**:
- **Active file in multiple projects**: If a file is active and exists in multiple projects, which project is considered active?
- **File state per project**: Should buffer state (cursor, scroll) be per-project or global per file?
- **Dropdown display**: When showing files in a project dropdown, should symlinked files show which projects they're also in?
- **File operations**: When renaming/moving a file, need to update all ProjectFile relationships
- **Project switching**: When switching projects, if current file exists in new project, should it remain active?

**Current Design**:
- `ProjectFile` objects track all file-to-project relationships (explicit relationship model)
- File object is shared across projects (single buffer per file)
- Buffer state is global per file (not per-project)

**Open Questions**:
- Should we track "active project context" separately from "active file"?
- If file is active in Project A, and user switches to Project B (which also contains the file), should file remain active?
- Should we maintain separate cursor positions per project for the same file?

### Active File and Active Project Handling

**Issue**: Current design assumes single active file and single active project, but this may not scale to multiple windows.

**Considerations**:
- **Single window assumption**: Current design tracks one active file/project globally
- **Multiple windows**: If application supports multiple windows, each window may have its own active file/project
- **Database storage**: `is_active` flag in database can only represent one active item - how to handle multiple windows?
- **Manager responsibility**: Should ProjectManager track active state per-window, or should each window have its own manager instance?

**Possible Solutions**:
1. **Per-window ProjectManager**: Each window has its own ProjectManager instance
   - Pros: Clean separation, no conflicts
   - Cons: Duplicate data, harder to share state
   
2. **Window-aware ProjectManager**: Manager tracks active state per-window
   - Pros: Shared data, single source of truth
   - Cons: More complex, need window identifiers
   
3. **Hybrid**: Shared ProjectManager for data, per-window state for active items
   - Pros: Best of both worlds
   - Cons: Most complex to implement

**Database Considerations**:
- Current schema has `is_active` as boolean - insufficient for multiple windows
- May need `active_window_id` or similar to track which window has item active
- Or: Don't store active state in database, only track in memory per-window

### Multiple Windows Support

**Issue**: If the application supports multiple windows, how does the code editor work across windows?

**Considerations**:
- **SourceView per window**: Each window would have its own SourceView instance
- **Shared ProjectManager**: Should projects/files be shared across windows, or per-window?
- **Active state**: Each window can have different active file/project
- **Buffer sharing**: Should file buffers be shared across windows (same file in multiple windows), or separate?
- **Session restoration**: Which window should restore the "active" project/file from database?

**Design Questions**:
- Should ProjectManager be a singleton or per-window?
- Should file buffers be shared (one buffer, multiple views) or separate (one buffer per window)?
- How to handle file changes when same file is open in multiple windows?
- Should there be a "global" active file/project, or only per-window?

**Recommendation** (for future):
- ProjectManager as singleton (shared data)
- Active state tracked per-window (not in database, or with window_id)
- File buffers shared across windows (single buffer, multiple views - GTK supports this)
- Each window has its own SourceView and tracks its own active file/project in memory


### Code Completion

**Feature**: Code completion support with language-specific providers.

**Implementation**:
- **GtkSource.Completion**: Use GTK's built-in completion system
- **Completion providers**: Custom providers for language-specific completions
- **Trigger**: Ctrl+Space to show completion popup
- **Integration**: May require LSP or language server integration for advanced completions

### Hover Help

**Feature**: Show help/hover information when hovering over symbols.

**Implementation**:
- **LSP integration**: Connect to language server for hover information
- **Tooltip display**: Show documentation in helper label or tooltip
- **Cursor tracking**: Detect when cursor is over a symbol
- **Async loading**: Load hover information asynchronously to avoid blocking UI

---

## Files Requiring Review (For Coding Agent Tool)

When the EditMode tool edits files, we need to capture the state before changes and provide a review workflow for users.

### EditMode File Change Capture

**Workflow:**
1. **Before EditMode applies changes**: Save a copy of the file to `last_approved_copy_path` (if not already set)
2. **After EditMode applies changes**: File is now in "edited but not reviewed" state
3. **User review**: Display list of files that have been edited but not yet reviewed/approved
4. **Diff view**: Show diff between current file and `last_approved_copy_path` (see Phase 6: Diff View)
5. **Approval**: When user approves, update `last_approved_copy_path` to current state and mark as approved

### Implementation Requirements

**File State Tracking:**
- `File.last_approved_copy_path` - Path to approved copy (already exists in File class)
- `File.needs_approval` - Whether file needs approval (true = needs approval, false = approved, inverted from is_approved)
- Need to track: Files that have been edited by EditMode but not yet reviewed

**EditMode Integration:**
- Intercept `EditMode.change_done` signal (see Phase 5: EditMode Integration)
- Before applying changes, save current file content to `last_approved_copy_path` (if empty)
- After changes applied, mark file as needing review (`needs_approval = true`)

**Review List Display:**
- Query files where `needs_approval = true` and `last_approved_copy_path != ""`
- Display in a list/widget (could be in SourceView header, separate panel, or status area)
- Allow user to:
  - View diff between current and approved version
  - Approve changes (update `last_approved_copy_path`, set `needs_approval = false`)
  - Reject changes (revert to `last_approved_copy_path`, clear `last_approved_copy_path`)

**Related to Diff View (Phase 6):**
- Diff view will compare current file content with `last_approved_copy_path`
- Diff view needed for reviewing EditMode changes
- See Phase 6 section for diff view implementation details

### Files to Review/Modify

**liboccoder/ (Code Editor Library):**
- `liboccoder/files/File.vala` - Already has `last_approved_copy_path` and `needs_approval` properties
- `liboccoder/ProjectManager.vala` - May need method to query files needing review
- `liboccoder/SourceView.vala` - May need UI to display review list and integrate with diff view

**libollmchat/Tools/ (EditMode Tool):**
- `libollmchat/Tools/RequestEditMode.vala` - Need to save file copy before applying changes
- `libollmchat/Tools/EditMode.vala` - May need to track which files were edited

**Integration Points:**
- EditModeWrapper (Phase 5) - Intercept `change_done` signal to save approved copy
- Diff view component (Phase 6) - Display differences for review
- Review list UI - Display and manage files needing review

---

**Note**: These considerations are documented for future reference but are explicitly out of scope for the current implementation phases. The current design assumes a single-window application with one active file and one active project.
