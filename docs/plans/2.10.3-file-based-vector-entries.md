# 2.10.3 File-Based Vector Entries

## Overview

After the indexer analyzes all components of a file using tree-sitter, we need to create a file-level summary and add it to the vector index. This will help the codebase search tool find relevant files when the LLM searches for code.

## Phases

### Phase 1: AST Path Support (Foundation)
- [x] Add ast_path property to VectorMetadata class and update database schema (libocvector/VectorMetadata.vala - add property and update initDB() to add ast_path column)
- [x] Build AST path during tree parsing (libocvector/Indexing/Tree.vala - update extract_element_metadata() to build ast_path from namespace/parent_class using '-' separator)

### Phase 2: File Analysis Infrastructure
- [x] Create file-level analysis prompt template (resources/ocvector/analysis-prompt-file.txt - new file with system/user message template)
- [x] Add analyze_file() method to Analysis class (libocvector/Indexing/Analysis.vala - method that loads prompt, builds element summary, calls LLM, creates file VectorMetadata)

### Phase 3: File Element Creation and Indexing
- [x] Create file VectorMetadata in analyze_file() (libocvector/Indexing/Analysis.vala - create VectorMetadata with element_type='file', ast_path='', etc. and add to tree.elements)
- [x] Integrate file analysis into Indexer pipeline (libocvector/Indexing/Indexer.vala - call analyze_file() after analyze_tree() in index_file())

### Phase 4: Search Tool Updates
- [ ] Add 'file' to VALID_ELEMENT_TYPES (libocvector/Tool/RequestCodebaseSearch.vala - add 'file' to array)
- [ ] Update CodebaseSearchTool parameter description (libocvector/Tool/CodebaseSearchTool.vala - add 'file' to supported types list)
- [ ] Update command line search tool help text (examples/oc-vector-search.vala - add 'file' to element type examples in help and option descriptions)
- [ ] Add ast-path to search result output (libocvector/Tool/RequestCodebaseSearch.vala - update format_results() to include ast-path line when ast_path is not empty)

## Implementation Plan

### 1. Create File-Level Analysis Prompt

- **File**: `resources/ocvector/analysis-prompt-file.txt`
- Create a new prompt template similar to `analysis-prompt.txt` but for file-level summaries
- Include a section that lists all elements in the file with their descriptions (in order they were defined)
- Format: `class: xxxx - {explanation from earlier}`, `method: yyyy - {explanation from earlier}`, `property: zzzz - {explanation}`, `enum_type: EnumName - {explanation}`, etc.
- Include all element types (classes, methods, properties, enum types, functions, delegates, etc.) but exclude enum members
- No code snippets needed in this section - just element type, name, and description

### 2. Add File Analysis Method to Analysis Class

- **File**: `libocvector/Indexing/Analysis.vala`
- Add new method `analyze_file(Tree tree)` that:
  - Loads the `analysis-prompt-file.txt` template
  - Builds a summary section listing all elements with their descriptions (in order from `tree.elements`, excluding enum members)
  - Calls LLM to generate a file-level summary
  - Creates a VectorMetadata object for the file with the generated description
  - Adds the file VectorMetadata to `tree.elements` so it gets processed like other elements

### 3. Add AST Path Support

- **File**: `libocvector/VectorMetadata.vala`
  - ✅ Add `ast_path` property (string, stored in database)
  - ✅ Update `initDB()` to add `ast_path TEXT NOT NULL DEFAULT ''` column to vector_metadata table
  - ✅ Add migration for existing databases
  - AST path format: `namespace-class-method` or `namespace-function` etc. (using '-' separator to avoid confusion with file paths)
  - For file elements: `ast_path = ""` (empty, files don't have AST paths)

- **File**: `libocfiles/Tree.vala`
  - ✅ Add `ast_path()` method that takes a TreeSitter.Node and traverses up the AST to build the path
  - ✅ Handles nested classes by building hierarchical paths
  - ✅ Renamed `get_element_name()` to `element_name()` and optimized to use string methods instead of character loops

- **File**: `libocvector/Indexing/Tree.vala`
  - ✅ Updated `extract_element_metadata()` to call `this.ast_path(node, code_content)` from base class
  - ✅ AST path is now built by traversing the AST tree structure

### 4. Add File Element to Tree

- **File**: `libocvector/Indexing/Analysis.vala`
- In `analyze_file()` method, after generating the file description:
  - Create a new `VectorMetadata` object for the file:
    - `element_type = "file"`
    - `element_name = GLib.Path.get_basename(tree.file.path)`
    - `start_line = 1`
    - `end_line = last line of file` (get from Tree or File object)
    - `description = file summary from LLM`
    - `file_id = tree.file.id`
    - `ast_path = ""` (empty for file elements)
  - Add this VectorMetadata to `tree.elements` so it gets processed like other elements
  - No special handling needed in VectorBuilder - it will process the file element automatically

### 5. Update Indexer to Call File Analysis

- **File**: `libocvector/Indexing/Indexer.vala`
- In `index_file()`, after `analyze_tree()` completes:
  - Call `analysis.analyze_file(tree)` which will:
    - Generate the file summary using LLM
    - Create a VectorMetadata object for the file
    - Add it to `tree.elements`
  - Then call `vector_builder.process_file(tree)` as normal - the file element will be processed automatically

### 6. Update Search Tools to Support File Element Type

- **File**: `libocvector/Tool/RequestCodebaseSearch.vala`
  - Add "file" to the `VALID_ELEMENT_TYPES` array so file elements can be searched

- **File**: `libocvector/Tool/CodebaseSearchTool.vala`
  - Update the `parameter_description` to include "file" in the list of supported element types
  - Change: `Supported types: "class", "struct", "interface", "enum_type", "enum", "function", "method", "constructor", "property", "field", "delegate", "signal", "constant", "file"`

- **File**: `examples/oc-vector-search.vala`
  - Update the help text (line 44) to include "file" in the element type examples
  - Update the option description (line 62) to include "file" in the element type list
  - Example: `Filter by element type (e.g., class, method, function, property, struct, interface, enum, constructor, field, delegate, signal, constant, file)`

### 7. Add AST Path to Tool Output

- **File**: `libocvector/Tool/RequestCodebaseSearch.vala`
  - In `format_results()` method, add `ast-path: {ast_path}` to the output for each result
  - Format: Include `ast-path: {metadata.ast_path}` in the result header (only if ast_path is not empty)
  - Example output:
    ```
    1. methodName (method) - file.vala:10-25
    ast-path: Namespace-ClassName-methodName
    Description: ...
    ```
  - For file elements (ast_path is empty), omit the ast-path line

## Files to Modify

1. `resources/ocvector/analysis-prompt-file.txt` (new file)
2. `libocvector/VectorMetadata.vala` - add `ast_path` property and update database schema
3. `libocvector/Indexing/Tree.vala` - build AST path during element extraction
4. `libocvector/Indexing/Analysis.vala` - add `analyze_file()` method that creates and adds file VectorMetadata to tree.elements
5. `libocvector/Indexing/VectorBuilder.vala` - no changes needed (file element processed like other elements, ast_path stored automatically)
6. `libocvector/Indexing/Indexer.vala` - integrate file analysis into pipeline
7. `libocvector/Tool/RequestCodebaseSearch.vala` - add "file" to VALID_ELEMENT_TYPES and include ast-path in output
8. `libocvector/Tool/CodebaseSearchTool.vala` - update parameter description to include "file"
9. `examples/oc-vector-search.vala` - update help text and option descriptions to include "file"

## Implementation Details

### Prompt Template Structure

The `analysis-prompt-file.txt` should:

- Use `---` separator between system and user messages (like `analysis-prompt.txt`)
- System message: Explain this is for generating a SHORT, ONE-LINE file summary
- User message template with placeholders:
  - `{file_basename}` - filename
  - `{file_path}` - full file path
  - `{elements_summary}` - formatted list of all elements with descriptions

### Element Summary Format

Build the elements summary by iterating `tree.elements` in order, excluding enum members:

```
class: ClassName - description from element.description
  method: methodName - description
  property: propertyName - description
  enum_type: EnumName - description
  function: functionName - description
  delegate: DelegateName - description
  field: fieldName - description
...
```

Note: Skip enum members (element_type == "enum") when building the summary.

### File Vector Metadata

The file element is created as a regular VectorMetadata object and added to `tree.elements`:

- `element_type = "file"`
- `element_name = GLib.Path.get_basename(tree.file.path)`
- `start_line = 1`
- `end_line = last line of file` (get from Tree or File object)
- `description = file summary from LLM`
- `file_id = tree.file.id`
- `ast_path = ""` (empty for file elements - files don't have AST paths)

This VectorMetadata is then processed by VectorBuilder just like any other element - no special handling required.

### AST Path Format

AST paths are built during tree parsing from namespace and parent_class information:

- Format: `namespace-class-method` or `namespace-function` etc. (using '-' separator to avoid confusion with file paths)
- Examples:
  - `OLLMvector.Indexing-Tree-parse` - method in class in namespace
  - `OLLMvector.Indexing-parse` - function in namespace
  - `Tree-parse` - method in class (no namespace)
  - `parse` - top-level function (no namespace, no class)
- For file elements: `ast_path = ""` (empty string)
- Stored in database as `ast_path TEXT NOT NULL DEFAULT ''` column
- Note: Uses '-' separator instead of '/' to avoid confusion with file system paths