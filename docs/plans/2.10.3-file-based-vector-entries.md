# 2.10.3 File-Based Vector Entries

## Overview

After the indexer analyzes all components of a file using tree-sitter, we need to create a file-level summary and add it to the vector index. This will help the codebase search tool find relevant files when the LLM searches for code.

## Implementation Plan

### 1. Create File-Level Analysis Prompt

- **File**: `resources/ocvector/analysis-prompt-file.txt`
- Create a new prompt template similar to `analysis-prompt.txt` but for file-level summaries
- Include a section that lists all elements in the file with their descriptions (in order they were defined)
- Format: `class: xxxx - {explanation from earlier}`, `method: yyyy - {explanation from earlier}`, etc.
- No code snippets needed in this section - just element type, name, and description

### 2. Add File Analysis Method to Analysis Class

- **File**: `libocvector/Indexing/Analysis.vala`
- Add new method `analyze_file(Tree tree)` that:
  - Loads the `analysis-prompt-file.txt` template
  - Builds a summary section listing all elements with their descriptions (in order from `tree.elements`)
  - Calls LLM to generate a file-level summary
  - Returns the file description string
- Modify `analyze_tree()` to optionally call `analyze_file()` after processing all elements, or add it as a separate call in Indexer

### 3. Update VectorBuilder to Handle File-Level Entries

- **File**: `libocvector/Indexing/VectorBuilder.vala`
- Modify `process_file()` to:
  - Accept an optional file description parameter
  - After processing all element vectors, create a file-level document
  - Format file document similar to `format_element_document()` but:
    - `element_type = "file"`
    - `element_name = file basename`
    - `start_line = 1`, `end_line = last line of file`
    - Include the file summary description
    - Include the list of all elements (type, name, description) in order
  - Add the file-level vector to FAISS and metadata to SQL

### 4. Update Indexer to Call File Analysis

- **File**: `libocvector/Indexing/Indexer.vala`
- In `index_file()`, after `analyze_tree()` completes:
  - Call `analysis.analyze_file(tree)` to get file summary
  - Pass the file summary to `vector_builder.process_file(tree, file_description)`
  - Or modify VectorBuilder to accept the Tree and call analyze_file internally

## Files to Modify

1. `resources/ocvector/analysis-prompt-file.txt` (new file)
2. `libocvector/Indexing/Analysis.vala` - add `analyze_file()` method
3. `libocvector/Indexing/VectorBuilder.vala` - add file-level vector processing
4. `libocvector/Indexing/Indexer.vala` - integrate file analysis into pipeline

## Implementation Details

### Prompt Template Structure

The `analysis-prompt-file.txt` should:

- Use `---` separator between system and user messages (like `analysis-prompt.txt`)
- System message: Explain this is for generating a SHORT, ONE-LINE file summary
- User message template with placeholders:
  - `{file_basename}` - filename
  - `{file_path}` - full file path
  - `{elements_summary}` - formatted list of all elements with descriptions

### Element Summary Format

Build the elements summary by iterating `tree.elements` in order:

```
class: ClassName - description from element.description
  method: methodName - description
  property: propertyName - description
...
```

### File Vector Metadata

- `element_type = "file"`
- `element_name = GLib.Path.get_basename(tree.file.path)`
- `start_line = 1`
- `end_line = tree.file total lines` (need to get from Tree or File object)
- `description = file summary from LLM`
