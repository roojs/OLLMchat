# 3.8.4. UI Integration

## Overview

Integrate Approvals widget into main UI with split pane, approve button, next button, and proper size management.

## Status

⏳ **TODO** - To be implemented.

## Prerequisites

- Phase 3.8.3 must be completed (Approvals widget)

## Goals

1. Add split pane below chat widget
2. Integrate Approvals widget in split pane
3. Add approve button (don't replace save button)
4. Add next button (">")
5. Implement size management (min/max, auto-resize)
6. Implement visibility management (hide/show based on count)
7. Implement approval workflow
8. Implement FileHistory approval

## Implementation Details

### Files to Modify

- `ollmapp/Window.vala` - Main UI integration

### UI Layout

1. **Split Pane Structure**:
   ```
   Main Window
   ├── Left Area (Gtk.Paned)
   │   ├── Chat Widget (top)
   │   └── Approvals Widget (bottom, in Gtk.ScrolledWindow)
   └── Right Area (existing)
   ```

2. **Approvals Pane**:
   - Wrapped in Gtk.ScrolledWindow
   - Hidden when `review_files.get_n_items() == 0`
   - Visible when `review_files.get_n_items() > 0`
   - Expands on transition from 0 to >0
   - User adjustable via paned
   - Minimum: Enough to show all files
   - Maximum: 60% of left area height
   - Auto-resizes when list updates (within min/max)

### Buttons

1. **Approve Button**:
   - Location: Where save button is (add, don't replace)
   - Visibility: Only visible when a file in ReviewFiles is selected
   - Action: Approve selected file and all FileHistory items
   - Behavior: Disappears when file is approved

2. **Next Button** (">"):
   - Location: Next to approve button
   - Visibility: Always visible if there are any items in ReviewFiles list
   - Tooltip: "X more files to approve" (shows remaining count)
   - Action: Select next file and open in codeview
   - Behavior: Blocks selection handler when changing selection

### Approval Workflow

1. **Approve Button Clicked**:
   ```vala
   void on_approve_clicked() {
       var file = this.approvals.get_selected_file();
       if (file == null) {
           return;
       }
       
       // Approve file
       file.is_need_approval = false;
       file.saveToDB(this.project_manager.db, null, false);
       
       // Approve all FileHistory items for this file
       // Query FileHistory table for this file_id
       // Set approved flag on all items
       
       // Update ReviewFiles (file will be removed)
       this.active_project.review_files.update_from(this.active_project.project_files);
       
       // Select next file if available
       var next_file = this.approvals.get_selected_file();
       if (next_file == null) {
           this.approvals.select_next();
       }
       
       // Hide approve button if no file selected
       this.approve_button.visible = (this.approvals.get_selected_file() != null);
       
       // Resize paned if needed
       this.adjust_paned_size();
   }
   ```

2. **Next Button Clicked**:
   ```vala
   void on_next_clicked() {
       this.approvals.select_next();
       var file = this.approvals.get_selected_file();
       if (file != null) {
           // Open file in codeview
           this.open_file_in_codeview(file);
       }
       
       // Update tooltip
       var count = this.active_project.review_files.get_n_items();
       this.next_button.tooltip_text = "%u more files to approve".printf(count);
   }
   ```

### Size Management

1. **Initial Size**:
   - When pane appears (0 to >0): Set size to show all files (within min/max)

2. **Auto-Resize**:
   - When ReviewFiles updates: Adjust size within min/max constraints
   - Minimum: Enough to show all files (or at least one file)
   - Maximum: 60% of left area height

3. **Size Adjustment Method**:
   ```vala
   void adjust_paned_size() {
       if (this.approvals_pane == null || !this.approvals_pane.visible) {
           return;
       }
       
       var review_files = this.active_project.review_files;
       var count = review_files.get_n_items();
       if (count == 0) {
           return;
       }
       
       // Calculate desired size (enough to show all files)
       var item_height = 30;  // Approximate height per item
       var desired_height = count * item_height;
       
       // Get left area height
       var left_area_height = this.left_paned.get_allocated_height();
       
       // Calculate min/max
       var min_height = item_height;  // At least one file
       var max_height = (int)(left_area_height * 0.6);  // 60% of left area
       
       // Clamp desired height
       var target_height = desired_height.clamp(min_height, max_height);
       
       // Set paned position
       var current_position = this.left_paned.position;
       var chat_height = left_area_height - target_height;
       this.left_paned.position = chat_height;
   }
   ```

### Visibility Management

1. **Show/Hide Logic**:
   ```vala
   void update_approvals_visibility() {
       var count = this.active_project.review_files.get_n_items();
       var was_visible = this.approvals_pane.visible;
       this.approvals_pane.visible = (count > 0);
       
       if (!was_visible && this.approvals_pane.visible) {
           // Transition from 0 to >0: expand
           this.adjust_paned_size();
       } else if (was_visible && !this.approvals_pane.visible) {
           // Transition from >0 to 0: hide (already handled by visible = false)
       }
   }
   ```

### FileHistory Approval

When approving a file, also approve all FileHistory items:

```vala
void approve_file_history(File file) {
    // Query FileHistory table for this file_id
    var db = this.project_manager.db;
    var stmt = db.prepare("""
        UPDATE file_history 
        SET is_approved = 1 
        WHERE file_id = ?
    """);
    stmt.bind_int64(1, file.id);
    stmt.step();
    stmt.reset();
}
```

### Selection Management

1. **User Opens File Not in ReviewFiles**:
   ```vala
   void on_file_opened_in_codeview(File file) {
       // Check if file is in ReviewFiles
       if (this.active_project.review_files.file_map.has_key(file.path)) {
           // File is in ReviewFiles: select it
           this.approvals.select_file(file);
       } else {
           // File is not in ReviewFiles: clear selection
           this.approvals.clear_selection();
       }
       
       // Update approve button visibility
       this.approve_button.visible = (this.approvals.get_selected_file() != null);
   }
   ```

2. **User Clicks File in Approvals**:
   - Handled by Approvals widget (emits file_selected signal)
   - Open file in codeview
   - Update approve button visibility

## Implementation Tasks

- [ ] Add Gtk.Paned below chat widget
- [ ] Add Approvals widget in split pane
- [ ] Wrap Approvals in Gtk.ScrolledWindow
- [ ] Implement visibility management (show/hide based on count)
- [ ] Implement size management (min/max, auto-resize)
- [ ] Add approve button (don't replace save button)
- [ ] Add next button (">")
- [ ] Implement approve button click handler
- [ ] Implement next button click handler
- [ ] Implement FileHistory approval
- [ ] Implement selection management
- [ ] Connect to ReviewFiles.items_changed signal
- [ ] Update approve button visibility
- [ ] Update next button tooltip
- [ ] Test all workflows

## Testing

- Test split pane appears below chat widget
- Test Approvals pane hidden when no files need approval
- Test Approvals pane visible when files need approval
- Test Approvals pane expands on transition from 0 to >0
- Test Approvals pane disappears when all files approved
- Test size constraints (min/max)
- Test user can adjust paned size
- Test auto-resize when list updates
- Test approve button only visible when file selected
- Test approve button disappears when file approved
- Test next button always visible when items exist
- Test next button tooltip shows correct count
- Test approve button approves file and FileHistory
- Test next button selects next file
- Test selection clearing when opening file not in ReviewFiles
- Test selection when opening file in ReviewFiles
- Test paned reference in Approvals widget works correctly
