# Fix Background Scanner Not Starting on Project Selection

## Status

üü° **PARTLY DONE** - User project selection now correctly starts the background scanner. However, the restore project issue during initialization is still pending - the background scanner may not start when restoring a previously active project on agent initialization.

## Problem Analysis

**Key Issue**: When we activate the agent (switch to occoder), we need to:

1. Load the active project into the UI ‚úì (already done via `apply_manager_state()`)
2. Trigger that the project is "activated fresh" ‚úó (signal is NOT emitted because project is already active)

**Initialization Flow**:

1. `AgentFactory.initialize_widget()` calls:

   - `load_projects_from_db()` - loads projects from database (project has `is_active = true` from previous session)
   - `restore_active_state()` - finds project with `is_active = true`, calls `activate_project()` which:
     - Sets `this.active_project = project`
     - Emits `active_project_changed` signal (line 202) ‚úì
   - `apply_manager_state()` - calls `activate_project()` again to load into UI, but:
     - Returns early (line 149-151) because project is already active
     - Signal is NOT emitted ‚úó

**User Selection Flow**:

- When user selects a project from dropdown:
  - `SourceView.on_project_selected()` ‚Üí `SourceView.open_project()`
  - `open_project()` checks if already active (lines 416-420) and returns early
  - OR if it calls `activate_project()`, that also returns early (line 149-151)
  - Signal is never emitted, background scanner never starts ‚úó

## Root Cause

The project is flagged as active in the database (`is_active = true`), and after `restore_active_state()` sets `this.active_project`, the project appears to be "already active". When the user explicitly selects the project:

1. `SourceView.open_project()` sees `this.manager.active_project.path == project.path` and returns early (line 417-419)
2. Even if we remove that check, `ProjectManager.activate_project()` has its own early return (line 149-151) that prevents the signal from being emitted when the project is already active

The signal is only emitted at line 202, which is never reached when the early return at line 151 is taken.

## Fix Strategy

**Solution**: Before loading the project at initialization, set `is_active = false`, then call `activate_project()` which will:

- See the project is not active (because we just set it to false)
- Go through the full activation process
- Emit the `active_project_changed` signal
- Force the UI to update the selected project
- Trigger the background scanner

**Loop Prevention**: We need to prevent selection change trigger loops. When programmatically activating a project during initialization, we should not trigger the dropdown's `on_project_selected()` handler which would call `open_project()` again.

**Implementation**:

1. In `ProjectManager.restore_active_state()`, after finding the active project (using `get_active_project()` which looks for `is_active = true`), reset `is_active = false` before calling `activate_project()`
2. This ensures `restore_active_state()` can find the project, then reset it, then activate it with full signal emission
3. `apply_manager_state()` will then just apply UI state (no need to reset or activate again)
4. Remove the early return in `SourceView.open_project()` - always call `activate_project()` when user selects a project

## Changes Required

### 1. Modify ProjectManager.restore_active_state() to reset is_active before activation

**File**: `libocfiles/ProjectManager.vala` (lines 420-453)

After finding the active project (which requires `is_active = true` to be found), reset `is_active = false` before calling `activate_project()`:

```vala
public async void restore_active_state()
{
    bool db_updated = false;
    
    // Find active project using ProjectList internal method
    // This requires is_active = true to find the project
    var project = this.projects.get_active_project();
    if (project == null) {
        // Reset is_active for all projects if no active project found
        // (in case multiple projects were marked active in database)
        foreach (var other_project in this.projects.project_map.values) {
            if (other_project.is_project && other_project.is_active) {
                other_project.is_active = false;
                other_project.saveToDB(this.db, null, false);
                db_updated = true;
            }
        }
        if (db_updated) {
            this.db.is_dirty = true;
        }
        return;
    }
    
    // Reset is_active to false in memory to force fresh activation
    // activate_project() will set it back to true and save it, so no need to save here
    if (project.is_active) {
        project.is_active = false;
    }
    
    // This will set this.active_project, set is_active=true, save to DB, emit signal
    yield this.activate_project(project);
    
    // Note: File activation is handled by apply_manager_state() via open_file()
    // which calls activate_file(), so we don't need to do it here
}
```

**Note**: The reset happens inside `restore_active_state()` after finding the project (which requires `is_active = true`), but before calling `activate_project()`. This ensures the project can be found, then reset, then activated with full signal emission.

### 2. Fix project dropdown placeholder update in apply_manager_state()

**File**: `liboccoder/SourceView.vala` (lines 249-269)

Update `apply_manager_state()` to only update placeholder if different (no need to reset is_active or call activate_project() since that's already done in restore_active_state()):

```vala
public async void apply_manager_state()
{
    // Only apply UI state from manager properties - all data is already loaded
    // Use manager's active_project and active_file properties
    
    if (this.manager.active_project == null) {
        return;
    }
    
    // Check if we're already on the same project - if so, don't change active file
    bool same_project = (this.project_dropdown.selected_project != null && 
                         this.project_dropdown.selected_project.path == this.manager.active_project.path);
    
    // Project is already activated by restore_active_state(), just update UI
    // Update file dropdown's project
    this.file_dropdown.project = this.manager.active_project;
    
    // Update project dropdown placeholder only if it's different (avoid unnecessary updates)
    // Note: on_selected() already handles clearing entry and setting placeholder,
    // so we only need to update if it's different to avoid duplicate work
    var expected_placeholder = this.manager.active_project.path_basename;
    if (this.project_dropdown.placeholder_text != expected_placeholder) {
        this.project_dropdown.entry.text = "";
        this.project_dropdown.placeholder_text = expected_placeholder;
    }
    
    // If we're switching to the same project, don't change the active file
    if (same_project) {
        return;
    }
    
    if (this.manager.active_file == null) {
        return;
    }
    
    // Open file (will restore cursor/scroll position from file.cursor_line, etc.)
    yield this.open_file(this.manager.active_file);
}
```

### 3. Remove early return in SourceView.open_project()

**File**: `liboccoder/SourceView.vala` (lines 414-420)

Remove the early return check so `activate_project()` is always called (which will now emit the signal even if already active):

```vala
public async void open_project(OLLMfiles.Folder project)
{
    // REMOVE THIS CHECK - let activate_project() handle duplicates and emit signal
    // if (this.manager.active_project != null &&
    //     this.manager.active_project.path == project.path) {
    //     return;
    // }
    
    // Notify manager to activate project (this will emit signal even if already active)
    yield this.manager.activate_project(project);
    // ... rest of method
}
```

## Implementation

1. **Modify ProjectManager.restore_active_state()** - After finding the active project (which requires `is_active = true`), reset `is_active = false` before calling `activate_project()`
2. **Fix SourceView.apply_manager_state()** - Only update UI state (placeholder), no need to reset or activate since that's already done
3. **Remove early return in SourceView.open_project()** - Always call `activate_project()` when user selects a project

This ensures:

- **Agent initialization**: 
  - `initialize_widget()` loads projects, calls `restore_active_state()`
  - `restore_active_state()` finds active project (requires `is_active = true`), resets `is_active = false`, then calls `activate_project()`
  - `activate_project()` sees project is not active and performs full activation (sets `is_active = true`, emits signal, triggers background scanner)
  - `apply_manager_state()` then just updates UI (placeholder, file dropdown)
  - Background scanner is triggered during initialization

- **User selection**: 
  - User selects project from dropdown
  - `on_project_selected()` ‚Üí `open_project()` ‚Üí `activate_project()`
  - Signal is emitted and background scanner starts

- **Full activation**: Every activation goes through the full process, ensuring consistency
- **Signal-based architecture**: Background scanner always gets notified via the signal, maintaining clean separation of concerns

## Todos

- [x] Modify ProjectManager.restore_active_state() to reset is_active=false after finding the active project but before calling activate_project() - this forces fresh activation with signal emission during agent initialization
- [x] Fix project dropdown placeholder update in apply_manager_state() - check if placeholder is already correct before updating (avoid unnecessary work, since on_selected() already handles this)
- [x] Remove early return check in SourceView.open_project() that prevents activate_project() from being called when user selects a project

## Progress Notes

**‚úÖ Completed:**
- User project selection now correctly starts the background scanner. When a user selects a project from the dropdown, `open_project()` always calls `activate_project()`, which emits the signal and triggers the background scanner.

**‚è≥ Still Pending:**
- Restore project issue: The background scanner may not start when restoring a previously active project during agent initialization. The `restore_active_state()` method has been modified to reset `is_active = false` before calling `activate_project()`, but this may need further investigation to ensure the signal is properly emitted and the background scanner starts during initialization.
