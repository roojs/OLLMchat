# 3.8. Change Approvals

## Overview

Change approval system for tracking and reviewing file changes. Provides a ReviewFiles collection that tracks files needing approval, and an Approvals widget UI for reviewing and approving changes.

## Status

â³ **TODO** - To be implemented in phases.

## Implementation Phases

This plan is divided into 4 phases:

1. **3.8.1** - Changes to EditMode and RunCommand and FileBase (set is_need_approval flag, rename property, add to database)
2. **3.8.2** - ReviewFiles class
3. **3.8.3** - Approvals Widget
4. **3.8.4** - Integration into UI including next button etc.

See sub-plans for detailed implementation steps.

## Implementation Details

### Features

#### ReviewFiles Collection
- **ReviewFiles class** - Collection of Files (not ProjectFiles) that need approval
- **Property of Folder** - Only used for folders that are projects (`is_project = true`)
- **GLib.ListModel** - Implements ListModel interface for UI binding
- **Backing store** - Uses HashMap for quick lookup and ArrayList for add/remove operations
- **Signals** - Standard signals like ProjectFiles (items_changed, etc.)
- **Auto-update** - Updated by scanning project_files and adding/removing items based on `is_need_approval` flag
- **Creation** - Created when `project_files` is created
- **Update triggers** - Updated after EditMode or RunCommand runs

#### Approvals Widget
- **Gtk.Box** - Container widget
- **Gtk.ListView** - Displays list of files needing approval
- **Ordering** - Files ordered by updated date (most recent first)
- **Display** - Shows basename of file with tooltip showing full path prefixed by "Added / Deleted / Modified"
- **Visual indicators**:
  - Deleted files shown as strikethrough
  - New files show "+" before the name
- **Click behavior** - Clicking on a file opens it in the codeview
- **Selection** - Can be none selected if user opens another file in sourceview that's not in the list
- **Paned reference** - Holds reference to Gtk.Paned for size adjustments

#### UI Integration
- **Location** - Below the chat widget (with a split pane)
- **Visibility** - Pane hidden if there are no changed files
- **Expansion** - Expands when going from 0 to many files (only on transition from 0 to >0)
- **Size constraints**:
  - User adjustable via paned
  - Minimum: Enough to show all files
  - Maximum: 60% of the height of the left area (chat + approvals area)
- **Auto-resize** - When list updates, resize within min/max constraints
- **Disappears** - When all files are approved, pane disappears

#### Approval Actions
- **Approve button** - Add button (don't replace save button) where save button is located
  - Only visible when a file in ReviewFiles is selected
  - Approves the selected file (sets `is_need_approval = false`)
  - Approves all FileHistory items for that file
  - Disappears when file is approved
- **Next button** - ">" button next to approve button
  - Always visible if there are any items in ReviewFiles list
  - Tooltip shows how many more files need approval: "X more files to approve"
  - Opens the next file by changing the selection on the Approvals widget
  - Blocks selection change handler when programmatically changing selection

#### Selection Management
- **Block selection handler** - When programmatically changing selection (via next button or approve), block the selection change handler to prevent recursive calls
- **User opens file not in ReviewFiles**:
  - Clear selection in Approvals widget (set to none selected)
- **User clicks file in Approvals**:
  - Select file in Approvals widget
  - Open file in codeview
- **File is approved**:
  - Remove from ReviewFiles
  - If it was selected, select next file (or clear if none remaining)
  - Approve button disappears
  - Pane can shrink in size

### Files to Create/Modify

#### New Files
- `libocfiles/ReviewFiles.vala` - ReviewFiles collection class
- `liboccoder/Approvals.vala` - Approvals widget class
- `docs/plans/3.8.1-scan-editmode-needs-approval.md` - Phase 1 sub-plan
- `docs/plans/3.8.2-review-files-class.md` - Phase 2 sub-plan
- `docs/plans/3.8.3-approvals-widget.md` - Phase 3 sub-plan
- `docs/plans/3.8.4-ui-integration.md` - Phase 4 sub-plan

#### Files to Modify
- `libocfiles/Folder.vala` - Add `review_files` property (only for projects)
- `libocfiles/FileBase.vala` - Rename `needs_approval` to `is_need_approval`, add to database schema, add to copy_db_fields_to
- `libocfiles/File.vala` - Rename `needs_approval` to `is_need_approval`
- `libocfiles/FileAlias.vala` - Rename `needs_approval` to `is_need_approval`
- `libocfiles/ProjectFile.vala` - Rename `needs_approval` to `is_need_approval`
- `liboctools/EditMode/Request.vala` - Set `is_need_approval = true` after applying changes
- `liboctools/RunCommand/Scan.vala` - Set `is_need_approval = true` when detecting new/modified files
- `ollmapp/Window.vala` - Add Approvals widget UI integration

### Implementation Notes

#### is_need_approval Flag Updates Required

**Current Status**: Property renamed from `needs_approval` to `is_need_approval` for consistency. Flag exists in `FileBase` but needs to be added to database schema and copy_db_fields_to. Flag is NOT being set when our app modifies files.

**Required Changes**:

1. **FileBase.vala**:
   - Rename `needs_approval` to `is_need_approval` (default = false)
   - Add `is_need_approval INTEGER NOT NULL DEFAULT 0` to database schema
   - Add migration for existing databases
   - Add `is_need_approval` to `copy_db_fields_to()` method

2. **File.vala, FileAlias.vala, ProjectFile.vala**:
   - Rename `needs_approval` to `is_need_approval`

3. **EditMode/Request.vala** (liboctools/EditMode/Request.vala):
   - After successfully applying changes (after line ~650): Set `file.is_need_approval = true`
   - Save file to database with updated flag
   - Do NOT set flag during scanning (user changes don't need approval)

4. **RunCommand/Scan.vala** (liboctools/RunCommand/Scan.vala):
   - When new file detected (`change_type == "added"`, line ~224): Set `file.is_need_approval = true` before saving
   - When file modified (`change_type == "modified"`, line ~211): Set `file.is_need_approval = true` after copying from overlay
   - Update `last_modified` timestamp when file is modified

#### ReviewFiles Update Strategy
- ReviewFiles constructor takes `ProjectFiles` as parameter
- ReviewFiles has `refresh()` method (not `update_from()`) to update the list
- Call `refresh()` when:
  - `project_files` is created/initialized
  - After EditMode completes (`change_done` signal)
  - After RunCommand completes (if it modifies files)
  - After file scanner completes (scanner does NOT set is_need_approval - user changes don't need approval)
- Use efficient update: Only add/remove items that changed, don't rebuild entire list
- Extract File objects from ProjectFiles (not store ProjectFiles)

#### Approvals Widget Rendering
- Determine file state for display:
  - **Added**: `last_approved_copy_path == ""` and file exists
  - **Deleted**: `is_deleted == true` or file doesn't exist but record does
  - **Modified**: `last_approved_copy_path != ""` and file exists and differs from approved copy
- Use Pango markup for strikethrough: `<s>filename</s>`
- Use "+" prefix for new files: `+ filename`

#### UI Layout Considerations
- Use `Gtk.Paned` for split pane (allows user to resize)
- Set minimum size for Approvals pane to show at least one file
- Set maximum size to 60% of left area height (chat + approvals)
- Auto-resize when list updates (within min/max constraints)
- Hide pane when count goes to 0
- Show pane when count goes from 0 to >0 (with animation)
- Ensure chat widget still has reasonable minimum size
- Approvals widget needs reference to paned for size adjustments

#### Approval Workflow
- When approve button clicked:
  1. Get selected file (or first file if none selected)
  2. Set `is_need_approval = false` on the file
  3. Approve all FileHistory items for that file (set approved flag)
  4. Save file to database
  5. Update ReviewFiles (file will be removed)
  6. If more files remain, select next file
  7. Hide approve button if no file selected
  8. Resize paned if needed
- When next button clicked:
  1. Block selection change handler
  2. Get current selection position
  3. Select next position (or first if at end, or clear if empty)
  4. Unblock selection change handler
  5. Emit `file_selected` signal to open in codeview
  6. Update tooltip with remaining count

### Testing

- Test property renamed to `is_need_approval` in all files
- Test database schema includes `is_need_approval` column
- Test migration adds `is_need_approval` column
- Test `copy_db_fields_to()` copies `is_need_approval` flag
- Test scanner does NOT set `is_need_approval` flag (user changes don't need approval)
- Test `is_need_approval` flag is set after EditMode applies changes
- Test `is_need_approval` flag is set after RunCommand modifies files
- Test default value is `false` (files are approved by default)
- Test ReviewFiles creation when project_files is created
- Test ReviewFiles update after EditMode applies changes
- Test ReviewFiles update after RunCommand modifies files
- Test ReviewFiles update after scanner detects new/modified files
- Test ReviewFiles signals (items_changed)
- Test Approvals widget displays files correctly
- Test Approvals widget shows correct indicators (+, strikethrough)
- Test Approvals widget tooltips show correct state
- Test clicking file in Approvals opens it in codeview
- Test approve button approves file and removes from list
- Test approve button approves all FileHistory items
- Test approve button disappears when file approved
- Test next button selects next file
- Test next button tooltip shows correct count
- Test next button blocks selection handler
- Test Approvals pane visibility (hidden when empty, shown when has items)
- Test Approvals pane size constraints (min/max, user adjustable)
- Test Approvals pane auto-resize when list updates
- Test Approvals pane disappears when all files approved
- Test selection clearing when opening file not in ReviewFiles
- Test ReviewFiles only exists for project folders
- Test paned reference in Approvals widget