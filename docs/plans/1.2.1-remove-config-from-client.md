# 1.2.1. Remove Configuration and Conversation Concerns from Client

## Overview

Remove request-specific configuration and conversation-specific properties from `Client` class. These properties belong in `Chat`/`Embed`/`Generate` (request-specific) or `Session` (conversation-specific), not in `Client` (connection-specific).

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

✅ **Phase 1 Complete** - New code paths added with backward compatibility
⏳ **Phase 2 In Progress** - Migrating call sites incrementally
⏳ **Phase 3 TODO** - Remove old code paths

## Goal

Make `Client` a thin HTTP communication layer that only holds connection-related properties. Move all request-specific and conversation-specific properties to their appropriate locations.

## Properties to Remove from Client

### Request-Specific Properties → Move to Chat/Embed/Generate

1. **`model` (string)**
   - **Current**: `Client.model` - model name to use for requests
   - **Move to**: `Call.Chat.model`, `Call.Embed.model`, `Call.Generate.model`
   - **Reason**: Model selection is request-specific, not connection-specific

2. **`stream` (bool)**
   - **Current**: `Client.stream` - whether to stream responses
   - **Move to**: `Call.Chat.stream`
   - **Reason**: Streaming preference is request-specific

3. **`format` (string?)**
   - **Current**: `Client.format` - response format ("json" or JSON schema)
   - **Move to**: `Call.Chat.format`
   - **Reason**: Format preference is request-specific

4. **`think` (bool)**
   - **Current**: `Client.think` - whether to return thinking output separately
   - **Move to**: `Call.Chat.think`
   - **Reason**: Thinking preference is request-specific

5. **`keep_alive` (string?)**
   - **Current**: `Client.keep_alive` - model keep-alive duration
   - **Move to**: `Call.Chat.keep_alive`, `Call.Embed.keep_alive`, `Call.Generate.keep_alive`
   - **Reason**: Keep-alive is request-specific

6. **`options` (Call.Options)**
   - **Current**: `Client.options` - runtime parameters (temperature, top_p, etc.)
   - **Move to**: `Call.Chat.options`, `Call.Embed.options`, `Call.Generate.options`
   - **Reason**: Runtime options are request-specific

### Conversation-Specific Properties → Move to Chat/Session

7. **`tools` (HashMap<string, Tool.BaseTool>)**
   - **Current**: `Client.tools` - available tools indexed by name
   - **Move to**: `Call.Chat.tools`
   - **Reason**: Tools are conversation-specific, not connection-specific
   - **Note**: Each Chat can have different tools
   - **Caller manages tools**: The caller (AgentHandler, Session, etc.) adds tools directly to Chat
   - **Remove**: `Client.add_tool()` method
   - **Add**: `Call.Chat.add_tool(Tool.BaseTool)` method

8. **`permission_provider` (ChatPermission.Provider)**
   - **Current**: `Client.permission_provider` - handles permission requests for tool execution
   - **Move to**: `Call.Chat.permission_provider` (with fallback to `Client.permission_provider`)
   - **Reason**: Permission handling is UI/session-specific, not connection-specific
   - **Note**: Tools access it via `chat_call.permission_provider` context
   - **Note**: Session can set `permission_provider` on Chat when wrapping it, but Chat does not reference Session

### State Properties → Move to Chat

9. **`streaming_response` (Response.Chat?)**
   - **Current**: `Client.streaming_response` - current streaming state
   - **Move to**: `Call.Chat.streaming_response`
   - **Reason**: Streaming state is session-specific, not connection-specific

## Implementation Strategy

**⚠️ CRITICAL**: This refactoring must be done incrementally to keep the code usable after each step. See [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md) for the overall approach.

**Key Principle**: Add new code paths first, migrate call sites incrementally, remove old code paths last.

## Implementation Steps

### Phase 1: Add New Code Paths (Backward Compatible)

#### Step 1.1: Add Real Properties to Chat with Fallback Logic

**Goal**: Allow Chat to have real properties while still supporting realized properties that delegate to Client.

**Changes**:
1. **Update `Call.Chat`**:
   - ✅ **DONE**: Add private real properties: `refactor_stream`, `refactor_format`, `refactor_think`, `refactor_keep_alive`, `refactor_tools`, `refactor_streaming_response`
     - **Note**: `refactor_` prefix makes it clear these are temporary properties for refactoring
   - ✅ **DONE**: Update getters to check if real property is set, otherwise fall back to `client.*`
   - ✅ **DONE**: Update setters to set real properties
   - ✅ **DONE**: Add `add_tool(Tool.BaseTool)` method (adds to Chat's tools, not Client's)
   - ✅ **DONE**: Add `permission_provider` property with fallback to `client.permission_provider`
   - Keep existing constructor signature for backward compatibility

**Example**:
```vala
private bool? refactor_stream = null;
public bool stream { 
    get { 
        if (refactor_stream != null) return refactor_stream;
        return this.client.stream; 
    }
    set { refactor_stream = value; }
}
```

**Result**: Code still works, but Chat can now have independent properties

2. **Update `Call.Embed`**:
   - ✅ **DONE**: Add real properties: `refactor_model`, `refactor_keep_alive`, `refactor_options`
   - ✅ **DONE**: Update getters/setters with fallback logic
   - Keep existing constructor signature for backward compatibility

3. **Update `Call.Generate`**:
   - ✅ **DONE**: Add real properties: `refactor_model`, `refactor_format`, `refactor_stream`, `refactor_think`, `refactor_keep_alive`, `refactor_options`
   - ✅ **DONE**: Update getters/setters with fallback logic
   - Keep existing constructor signature for backward compatibility

#### Step 1.2: Add Permission Provider to Chat with Fallback

**Goal**: Allow permission_provider to be on Chat while still supporting Client.

**Changes**:
1. ✅ **DONE**: **Add `permission_provider` property to `Call.Chat`**:
   - Add `refactor_permission_provider` private property
   - Getter checks Chat's property first, falls back to `client.permission_provider`
   - Session can set `permission_provider` on Chat when wrapping it

2. ✅ **DONE**: **Add `permission_provider` property to `Session`**:
   - Session stores `permission_provider` internally
   - Session sets it on Chat when wrapping Chat in constructor
   - **Note**: Chat does NOT reference Session (no cross-level references)

3. ✅ **DONE**: **Update tools to use Chat's permission_provider**:
   - Update `Tool.RequestBase` to use `chat_call.permission_provider`
   - Chat's getter handles fallback to Client automatically
   - This allows gradual migration

**Result**: Code still works, Chat can have permission_provider, Session can set it when wrapping Chat

### Phase 2: Migrate Call Sites Incrementally

#### Step 2.1: Migrate Client Convenience Methods

**Goal**: Update Client methods to use real properties on Chat.

1. **Update `Client.chat(string)`**:
   - Create `Call.Chat` with explicit model/options
   - Set real properties on Chat: `stream`, `format`, `think`, `keep_alive`
   - Use `this.model` and `this.options` as defaults (still available on Client)

2. **Update `Client.embed()` and `Client.embed_array()`**:
   - Keep using `this.model` for now (Client still has it)
   - Create `Call.Embed` with explicit model/options
   - Set real properties on Embed

3. **Update `Client.generate()`**:
   - Keep using `this.model` for now (Client still has it)
   - Create `Call.Generate` with explicit properties
   - Set real properties on Generate

**Result**: Client methods work, but now use real properties on Chat

#### Step 2.2-N: Migrate All Chat Creation Points

**Goal**: Update each Chat creation point to use real properties.

**Order** (from simplest to most complex):
1. `Client.chat()` - Already done in Step 2.1
2. `Client.embed()` / `embed_array()` - Already done in Step 2.1
3. `Client.generate()` - Already done in Step 2.1
4. `Config2.create_chat()` - Already uses explicit options (good pattern, just verify)
5. `Analysis` - Already uses explicit options (good pattern, just verify)
6. `EmptySession.send_message()` - Update to set real properties
7. `SessionPlaceholder` - Update to set real properties
8. `Manager.new_client()` - Update to set real properties
9. `AgentHandler` - Update to set real properties, add tools to Chat
10. `CodeAssistantHandler` - Update to set real properties, add tools to Chat

**For each**:
- Update to set real properties on Chat (stream, format, think, keep_alive)
- Update to add tools to Chat directly (not Client)
- Update to set permission_provider on Session (if applicable)
- Test that it still works

**Result**: All call sites migrated, code still works

### Phase 3: Remove Old Code Paths

#### Step 3.1: Remove Fallback Logic from Chat

**Goal**: Remove fallback logic, Chat now only uses real properties.

**Prerequisite**: All Chat creation points must be migrated (Phase 2 complete)

**Changes**:
- Remove fallback logic from Chat property getters
- Chat now only uses real properties
- Remove "realized" property getters that delegate to `client.*`

**Files**:
- `libollmchat/Call/Chat.vala` - Remove fallback logic

**Result**: Chat is simpler, but Client still has properties (for backward compatibility)

#### Step 3.2: Remove Properties from Client

**Goal**: Remove properties from Client that are no longer needed.

**Prerequisite**: All Chat creation points use real properties (Step 3.1 complete)

**Changes**:
1. Remove properties from `Client` class:
   - `model`, `stream`, `format`, `think`, `keep_alive`, `options`
   - `tools`, `permission_provider`
   - `streaming_response`

2. Remove `Client.add_tool()` method:
   - Tools are now added to Chat, not Client

3. Update Client documentation to reflect removed properties

**Result**: Client is thinner, but code still works (Chats have their own properties)

## Files to Modify

### Core Classes
- `libollmchat/Client.vala` - Remove properties and `add_tool()` method
- `libollmchat/Call/Chat.vala` - Add real properties, remove realized properties
- `libollmchat/Call/Embed.vala` - Add real properties
- `libollmchat/Call/Generate.vala` - Add real properties

### Tool System
- ✅ `libollmchat/Tool/RequestBase.vala` - **DONE**: Updated to access `permission_provider` from Chat
- All tool implementations that access `client.permission_provider` (may need updates)

### Session/History
- ✅ `libollmchat/History/Session.vala` - **DONE**: Added `permission_provider` property, sets it on Chat when wrapping
- `libollmchat/History/Manager.vala` - Update to set `permission_provider` on Session (if needed)

## Testing Checklist

### Phase 1 (Complete)
- [x] Chat has real properties with fallback to Client (stream, format, think, keep_alive, tools, streaming_response)
- [x] Embed has real properties with fallback to Client (model, keep_alive, options)
- [x] Generate has real properties with fallback to Client (model, format, stream, think, keep_alive, options)
- [x] Tools can be added to Chat via `add_tool()` method
- [x] Permission provider accessible from Chat (with fallback to Client)
- [x] Session can set permission_provider on Chat when wrapping it
- [x] Tools access permission_provider via `chat_call.permission_provider`

### Phase 2 (In Progress)
- [ ] Client convenience methods (`chat()`, `embed()`, `generate()`) updated to set real properties
- [ ] All Chat creation points updated to set real properties
- [ ] All call sites migrated to use real properties

### Phase 3 (Not Started)
- [ ] Client no longer has request-specific properties
- [ ] Fallback logic removed from Chat/Embed/Generate
- [ ] No code references removed Client properties

## Related Plans

- [1.2.2. Remove Unnecessary Signals from Client](./1.2.2-remove-signals-from-client.md)
- [1.2.3. Update Call.Base to Take Connection](./1.2.3-update-call-base-connection.md)
- [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md)

