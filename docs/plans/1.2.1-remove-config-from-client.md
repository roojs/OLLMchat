# 1.2.1. Remove Configuration and Conversation Concerns from Client

## Overview

Remove request-specific configuration and conversation-specific properties from `Client` class. These properties belong in `Chat`/`Embed`/`Generate` (request-specific) or `Session` (conversation-specific), not in `Client` (connection-specific).

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

⏳ **TODO** - Refactoring needed.

## Goal

Make `Client` a thin HTTP communication layer that only holds connection-related properties. Move all request-specific and conversation-specific properties to their appropriate locations.

## Properties to Remove from Client

### Request-Specific Properties → Move to Chat/Embed/Generate

1. **`model` (string)**
   - **Current**: `Client.model` - model name to use for requests
   - **Move to**: `Call.Chat.model`, `Call.Embed.model`, `Call.Generate.model`
   - **Reason**: Model selection is request-specific, not connection-specific

2. **`stream` (bool)**
   - **Current**: `Client.stream` - whether to stream responses
   - **Move to**: `Call.Chat.stream`
   - **Reason**: Streaming preference is request-specific

3. **`format` (string?)**
   - **Current**: `Client.format` - response format ("json" or JSON schema)
   - **Move to**: `Call.Chat.format`
   - **Reason**: Format preference is request-specific

4. **`think` (bool)**
   - **Current**: `Client.think` - whether to return thinking output separately
   - **Move to**: `Call.Chat.think`
   - **Reason**: Thinking preference is request-specific

5. **`keep_alive` (string?)**
   - **Current**: `Client.keep_alive` - model keep-alive duration
   - **Move to**: `Call.Chat.keep_alive`, `Call.Embed.keep_alive`, `Call.Generate.keep_alive`
   - **Reason**: Keep-alive is request-specific

6. **`options` (Call.Options)**
   - **Current**: `Client.options` - runtime parameters (temperature, top_p, etc.)
   - **Move to**: `Call.Chat.options`, `Call.Embed.options`, `Call.Generate.options`
   - **Reason**: Runtime options are request-specific

### Conversation-Specific Properties → Move to Chat/Session

7. **`tools` (HashMap<string, Tool.BaseTool>)**
   - **Current**: `Client.tools` - available tools indexed by name
   - **Move to**: `Call.Chat.tools`
   - **Reason**: Tools are conversation-specific, not connection-specific
   - **Note**: Each Chat can have different tools
   - **Caller manages tools**: The caller (AgentHandler, Session, etc.) adds tools directly to Chat
   - **Remove**: `Client.add_tool()` method
   - **Add**: `Call.Chat.add_tool(Tool.BaseTool)` method

8. **`permission_provider` (ChatPermission.Provider)**
   - **Current**: `Client.permission_provider` - handles permission requests for tool execution
   - **Move to**: `Session.permission_provider` (or `Chat.permission_provider` if needed per-chat)
   - **Reason**: Permission handling is UI/session-specific, not connection-specific
   - **Note**: Tools access it via `chat_call` context, so it should be on Session/Chat, not Client

### State Properties → Move to Chat

9. **`streaming_response` (Response.Chat?)**
   - **Current**: `Client.streaming_response` - current streaming state
   - **Move to**: `Call.Chat.streaming_response`
   - **Reason**: Streaming state is session-specific, not connection-specific

## Implementation Steps

### Step 1: Add Properties to Chat/Embed/Generate

1. **Update `Call.Chat`**:
   - Add real properties: `model`, `stream`, `format`, `think`, `keep_alive`, `options`, `tools`
   - Remove "realized" properties that delegate to `client.*`
   - Add `add_tool(Tool.BaseTool)` method
   - Update constructor to take these as parameters or set via object initializer

2. **Update `Call.Embed`**:
   - Add real properties: `model`, `keep_alive`, `options`
   - Remove usage of `client.model` and `client.config.model_options`
   - Update constructor to take `model` and `options` as parameters

3. **Update `Call.Generate`**:
   - Add real properties: `model`, `format`, `stream`, `think`, `keep_alive`, `options`
   - Remove "realized" properties that delegate to `client.*`
   - Update constructor to take these as parameters

### Step 2: Update Client Methods

1. **Update `Client.chat(string)`**:
   - Create `Call.Chat` with explicit model/options (no longer uses `this.model`, `this.options`)
   - Need to get model from Config2 or pass as parameter

2. **Update `Client.embed()` and `Client.embed_array()`**:
   - Add `model` parameter (currently uses `this.model`)
   - Create `Call.Embed` with explicit model/options

3. **Update `Client.generate()`**:
   - Add `model` parameter (currently uses `this.model`)
   - Create `Call.Generate` with explicit properties

4. **Remove `Client.add_tool()` method**:
   - Tools are now added to Chat, not Client

### Step 3: Update Permission Provider

1. **Move `permission_provider` to Session**:
   - Add `permission_provider` property to `Session`
   - Update tools to access via `chat_call.session.permission_provider` instead of `chat_call.client.permission_provider`
   - Update all tool code that accesses `client.permission_provider`

### Step 4: Update All Chat Creation Points

Find all places that create `Call.Chat` and update to:
- Pass explicit properties instead of relying on Client defaults
- Add tools to Chat directly (not Client)
- See [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md) for detailed list

### Step 5: Remove Properties from Client

1. Remove properties from `Client` class:
   - `model`, `stream`, `format`, `think`, `keep_alive`, `options`
   - `tools`, `permission_provider`
   - `streaming_response`

2. Update Client documentation to reflect removed properties

## Files to Modify

### Core Classes
- `libollmchat/Client.vala` - Remove properties and `add_tool()` method
- `libollmchat/Call/Chat.vala` - Add real properties, remove realized properties
- `libollmchat/Call/Embed.vala` - Add real properties
- `libollmchat/Call/Generate.vala` - Add real properties

### Tool System
- `libollmchat/Tool/RequestBase.vala` - Update to access `permission_provider` from Session/Chat
- All tool implementations that access `client.permission_provider`

### Session/History
- `libollmchat/History/Session.vala` - Add `permission_provider` property
- `libollmchat/History/Manager.vala` - Update to set `permission_provider` on Session

## Testing Checklist

- [ ] Client no longer has request-specific properties
- [ ] Chat has all request-specific properties as real (not realized) properties
- [ ] Tools can be added to Chat (not Client)
- [ ] Permission provider accessible from Session/Chat
- [ ] All Chat creation points updated
- [ ] Client convenience methods (`chat()`, `embed()`, `generate()`) work with explicit parameters
- [ ] No code references removed Client properties

## Related Plans

- [1.2.2. Remove Unnecessary Signals from Client](./1.2.2-remove-signals-from-client.md)
- [1.2.3. Update Call.Base to Take Connection](./1.2.3-update-call-base-connection.md)
- [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md)

