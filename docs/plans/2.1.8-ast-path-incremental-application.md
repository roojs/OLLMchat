# 2.1.8. AST Path Mode (Incremental Application)

## Overview

Add incremental application of AST path-based changes to the buffer. This allows AST path resolution to work correctly for subsequent edits in the same session by applying changes immediately to the buffer (but not syncing to disk until end of session).

## Status

ðŸ“‹ **PLANNED** - Part of 2.1.4 AST Path Support for EditFile Integration

## Related Plans

- **2.1.4** - AST Path Support for EditFile Integration (main plan)
- **2.1.6** - Stream Class Refactoring (prerequisite)
- **2.1.7** - Line Number Mode (Legacy) and Mode Separation (prerequisite)

## Prerequisites

- Phase 7 must be complete (mode separation, ignored changes tracking, reporting)
- Stream class refactoring (Phase 6) must be complete

## Purpose

Enable incremental application of AST path-based changes. When a code block with an AST path is captured, apply it immediately to the buffer (in memory) so that subsequent AST path lookups in the same session work correctly. File is synced to disk only at the end of the session.

## Implementation

- [ ] **AST Path Mode Behavior (`use_line_numbers = false` and `edit_mode == "ast_path"`):**
  - [ ] AST paths are required in code block format: `type:ast-path:Namespace-Class-Method`
  - [ ] If line number format is detected: Ignore the code block (handled by Phase 7)
  - [ ] Changes are applied incrementally to buffer (this phase)

- [ ] **Streaming Application:**
  - [ ] **Only when `use_line_numbers = false`:** Apply each code block change immediately when it's captured (in `Stream.add_linebreak()` when code block closes)
  - [ ] This allows AST path resolution to work correctly for subsequent edits in the same session
  - [ ] Changes are applied to the buffer immediately, but file is not synced to disk until end of session
  - [ ] **Implementation:** Add `skip_sync` parameter to `FileBuffer.apply_edits()` method, OR
  - [ ] **Alternative:** Create `apply_edits_incremental()` method that applies edits without syncing, OR
  - [ ] **Alternative:** Manually apply edits using buffer operations (delete/insert) without calling `apply_edits()`
  - [ ] For incremental AST edits, apply to buffer but skip the sync step (sync only at end of session)
  - [ ] **Tree Reparse Marking:** After each AST path-based change is applied to the buffer (but before sync to disk), mark the tree as needing reparse:
    ```vala
    // After applying incremental AST path change to buffer
    // Check if the change used AST path (check FileChange.ast_path property)
    if (change.ast_path != null && change.ast_path != "" && this.file != null && this.file.id > 0) {
        var project_manager = ((Tool) this.tool).project_manager;
        var tree = project_manager.tree_factory(this.file);
        tree.needs_reparse = true; // Mark for reparse on next AST path lookup
    }
    ```
  - [ ] **Note:** Since changes are applied to buffer but not synced to disk, mtime won't change. The `needs_reparse` flag (from Phase 5) forces reparse on next AST path lookup. When file is synced to disk at end of session, mtime update will naturally trigger reparse.

- [ ] **File History Backup (Before First Modification):**
  - [ ] Add `file_history_created` flag to Request class
  - [ ] Add `incremental_changes_applied` flag to Request class (tracks if any incremental changes were applied to buffer)
  - [ ] Create file history backup BEFORE applying the first AST path-based change
  - [ ] On first AST path change:
    - [ ] Check if file exists (if not, skip backup - it's a new file)
    - [ ] If file exists and backup not yet created:
      - [ ] Get or create File object
      - [ ] Create FileHistory with `change_type = "modified"`
      - [ ] Call `FileHistory.commit()` async (creates backup before modification)
      - [ ] Set `file_history_created = true`
  - [ ] Subsequent AST path changes in same session skip backup creation (already done)
  - [ ] Implementation:
    ```vala
    // In Request class
    private bool file_history_created = false;
    
    // In Stream.add_linebreak() when AST path code block closes (first time only)
    if (!this.file_history_created && this.file != null) {
        var file_exists = GLib.FileUtils.test(this.normalized_path, GLib.FileTest.IS_REGULAR);
        if (file_exists) {
            yield this.create_file_history(project_manager, this.file, "modified");
            this.file_history_created = true;
        }
    }
    // Then apply the change to buffer
    ```
  
- [ ] **Delayed Disk Write:**
  - [ ] Apply each AST path-based change to the buffer immediately (in memory) when code block closes
  - [ ] Set `incremental_changes_applied = true` when applying incremental change to buffer
  - [ ] Do NOT sync buffer to disk after each incremental change
  - [ ] All changes accumulate in the buffer (in memory)
  - [ ] **Important:** File history is created BEFORE the first incremental change (see "File History Backup" section above) - this creates backup from original file on disk
  - [ ] At end of session (`on_message_completed()` â†’ `apply_all_changes()`), check `incremental_changes_applied` flag in addition to `changes.size`
  - [ ] **Critical:** Update `apply_all_changes()` early return check:
    ```vala
    // Check if we have changes OR incremental changes were applied
    if (this.changes.size == 0 && !this.incremental_changes_applied) {
        return;
    }
    ```
  - [ ] **For incremental changes path:** If `incremental_changes_applied == true` but `changes.size == 0`:
    - [ ] Get or create File object
    - [ ] Ensure buffer is loaded
    - [ ] **Do NOT create file history again** (already created before first incremental change)
    - [ ] Sync buffer to disk: `yield file.buffer.sync_to_file()`
    - [ ] Update file metadata (is_need_approval, last_change_type, last_modified)
    - [ ] Save to database if needed
  - [ ] **Note:** The buffer's `sync_to_file()` method writes all accumulated changes to disk (backup was already created by FileHistory.commit() before first change)

## Files to Modify

- [ ] `liboctools/EditMode/Request.vala` - Add incremental change application logic
- [ ] `liboctools/EditMode/Stream.vala` - Apply changes incrementally when AST path code blocks close
- [ ] `libocfiles/FileBuffer.vala` - Add incremental edit support (skip sync option)
