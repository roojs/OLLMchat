# 1.2.7.20. Inline Temporary Variables in add_message() Calls

## Overview

Many locations in the code create a temporary variable just to pass to `add_message()`, and the variable is never used afterward. These should be inlined directly into the `add_message()` call.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md)

## Status

✅ **DONE** - All temporary variables in `add_message()` calls have been inlined across 5 locations in 4 files. Code readability improved and follows coding standards.

## Goal

Improve code readability by inlining temporary variables used only for `add_message()` calls.

## Issue

Many locations in the code create a temporary variable just to pass to `add_message()`, and the variable is never used afterward. These should be inlined directly into the `add_message()` call.

## Action

- Search for all `add_message()` calls in the codebase
- Identify cases where a temporary variable is created just to pass to `add_message()` and never used again
- Inline the variable creation directly into the `add_message()` call
- This improves code readability and reduces unnecessary variable declarations

## Files to Modify

### 1. `libollmchat/Tool/RequestBase.vala`
- **Location**: Lines 137-140 in `send_ui()` method
- **Issue**: `ui_msg` variable is created and only used once in `add_message()` call
- **Change**: Inline `new OLLMchat.Message(...)` directly into `this.agent.session.add_message()` call

```132:141:libollmchat/Tool/RequestBase.vala
protected void send_ui(string type, string title, string body)
{
	// Escape code blocks in body to prevent breaking the outer codeblock
	var escaped_body = body.replace("\n```", "\n\\`\\`\\`");
	var message = "```" + type + " " + title + "\n" + escaped_body + "\n```";
	var ui_msg = new OLLMchat.Message(this.agent.chat, "ui", message);
	
	// Add message to session via agent (Chat → Agent → Session)
	this.agent.session.add_message(ui_msg);
}
```

### 2. `libollmchat/Tools/RequestRunCommand.vala`
- **Location 1**: Lines 212-216 in `execute()` method
- **Issue**: `cmd_msg` variable is created and only used once in `add_message()` call
- **Change**: Inline `new OLLMchat.Message(...)` directly into `this.agent.session.add_message()` call

```211:216:libollmchat/Tools/RequestRunCommand.vala
// Send command to UI before requesting permission
var cmd_msg = new OLLMchat.Message(this.agent.chat, "ui",
	"```bash\n$ " + this.command + "\n```");

// Add message to session via agent (Chat → Agent → Session)
this.agent.session.add_message(cmd_msg);
```

- **Location 2**: Lines 317-322 in `execute_tool_async()` method
- **Issue**: `output_msg` variable is created and only used once in `add_message()` call
- **Change**: Inline `new OLLMchat.Message(...)` directly into `this.agent.session.add_message()` call

```316:322:libollmchat/Tools/RequestRunCommand.vala
// Send output as second message
var output_msg = new OLLMchat.Message(this.agent.chat, "ui", 
	"```txt\n" + output_content.replace("\n```", "\n\\`\\`\\`") + "\n```"
);

// Add message to session via agent (Chat → Agent → Session)
this.agent.session.add_message(output_msg);
```

### 3. `libollmchat/Tools/RequestWebFetch.vala`
- **Location 1**: Lines 78-82 in `execute_request()` method
- **Issue**: `request_msg` variable is created and only used once in `add_message()` call
- **Change**: Inline `new OLLMchat.Message(...)` directly into `this.agent.session.add_message()` call

```77:82:libollmchat/Tools/RequestWebFetch.vala
// Send request message to UI
var request_msg = new OLLMchat.Message(this.agent.chat, "ui",
	"```" + this.tool.name + " - request\n" + this.url + "\n```");

// Add message to session via agent (Chat → Agent → Session)
this.agent.session.add_message(request_msg);
```

- **Location 2**: Lines 117-122 in `execute_request()` method
- **Issue**: `response_msg` variable is created and only used once in `add_message()` call
- **Change**: Inline `new OLLMchat.Message(...)` directly into `this.agent.session.add_message()` call

```116:122:libollmchat/Tools/RequestWebFetch.vala
// Send response message to UI (escape code blocks in result)
var response_msg = new OLLMchat.Message(this.agent.chat, "ui",
	"```" + this.tool.name + " - response (" + this.format + ")\n" + 
		result.replace("\n```", "\n\\`\\`\\`") + "\n```");

// Add message to session via agent (Chat → Agent → Session)
this.agent.session.add_message(response_msg);
```

### 4. `libollmchat/Tools/RequestReadFile.vala`
- **Location**: Lines 116-119 in `execute_request()` method
- **Issue**: `ui_msg` variable is created and only used once in `add_message()` call
- **Change**: Inline `new OLLMchat.Message(...)` directly into `this.agent.session.add_message()` call

```116:119:libollmchat/Tools/RequestReadFile.vala
var ui_msg = new OLLMchat.Message(this.agent.chat, "ui", message);

// Add message to session via agent (Chat → Agent → Session)
this.agent.session.add_message(ui_msg);
```

## Summary

✅ **Completed**: All 5 locations across 4 files have been modified
- ✅ `libollmchat/Tool/RequestBase.vala`: 1 location (also inlined `escaped_body` and `message` variables)
- ✅ `libollmchat/Tools/RequestRunCommand.vala`: 2 locations
- ✅ `libollmchat/Tools/RequestWebFetch.vala`: 2 locations
- ✅ `libollmchat/Tools/RequestReadFile.vala`: 1 location

All changes follow coding standards:
- Temporary variables inlined directly into `add_message()` calls
- Proper line breaking on `(` for function calls
- String concatenation broken on `+` for readability
- Each argument on its own line when broken

## Testing Checklist

- [x] Temporary variables in `add_message()` calls have been inlined
- [x] Code readability improved
- [x] All functionality still works correctly after cleanup

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md) - Parent plan
- [1.2.7.8. Cleanup Items](./1.2.7.8-cleanup-items.md) - Related cleanup item

