# 1.2.4. Update All Chat Creation Points

## Overview

Update all places in the codebase that create `Call.Chat` objects to use the new constructor signature (taking `Connection` instead of `Client`) and explicitly set all required properties.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

‚è≥ **TODO** - Refactoring needed.

## Goal

Ensure all Chat creation points:
1. Pass `Connection` instead of `Client`
2. Explicitly set all required properties (`model`, `options`, etc.)
3. Add tools to Chat directly (not Client)
4. Use Config2 or defaults as needed

## Chat Creation Points to Update

### 1. AgentHandler (`libollmchat/Prompt/AgentHandler.vala`)

**Current** (line ~131):
```vala
var call = new OLLMchat.Call.Chat(this.client, this.client.model);
```

**New**:
```vala
var connection = get_connection_from_client(this.client);  // Or pass connection directly
var model = get_model_from_config_or_request();  // Get from Config2 or request
var options = get_options_from_config(model);  // Get from Config2.model_options
var call = new OLLMchat.Call.Chat(connection, model, options) {
    stream = true,  // Or get from config
    think = false,
    keep_alive = "5m"
};
// Add tools to Chat
foreach (var tool in this.agent.get_tools()) {
    call.add_tool(tool);
}
```

### 2. CodeAssistantHandler (`liboccoder/Prompt/CodeAssistantHandler.vala`)

**Current** (line ~55):
```vala
var call = new OLLMchat.Call.Chat(this.client, this.client.model);
```

**New**: Same pattern as AgentHandler above.

### 3. Client.chat() (`libollmchat/Client.vala`)

**Current** (line ~320):
```vala
var call = new Call.Chat(this, this.model) {
    cancellable = cancellable
};
```

**New**:
```vala
// Need to get model from parameter or config
var model = get_model_from_config();  // Or pass as parameter
var options = get_options_from_config(model);
var call = new Call.Chat(this.connection, model, options) {
    cancellable = cancellable,
    stream = true  // Or get from config
};
```

**Note**: `Client.chat()` may need to accept `model` parameter or get from Config2.

### 4. Manager.new_client() usage (`libollmchat/History/Manager.vala`)

**Current** (line ~271):
```vala
var session = new Session(this, new Call.Chat(client, client.model));
```

**New**:
```vala
var connection = client.connection;
var model = get_model_from_config();  // Or from session/request
var options = get_options_from_config(model);
var chat = new Call.Chat(connection, model, options) {
    stream = true
};
var session = new Session(this, chat);
```

### 5. EmptySession.send_message() (`libollmchat/History/EmptySession.vala`)

**Current** (line ~73):
```vala
var chat = new Call.Chat(new_client, new_client.model);
```

**New**:
```vala
var connection = new_client.connection;
var model = get_model_from_config();  // Or from request
var options = get_options_from_config(model);
var chat = new Call.Chat(connection, model, options) {
    stream = true
};
```

### 6. Config2.create_chat() (`libollmchat/Settings/Config2.vala`)

**Current** (line ~559):
```vala
return new OLLMchat.Call.Chat(client, model_usage_obj.model, model_usage_obj.options);
```

**New**:
```vala
// This one already provides options explicitly - good!
// Just need to change client to connection
return new OLLMchat.Call.Chat(client.connection, model_usage_obj.model, model_usage_obj.options);
```

### 7. Analysis (`libocvector/Indexing/Analysis.vala`)

**Current** (line ~322):
```vala
var chat = new OLLMchat.Call.Chat(analysis_client, analysis_usage.model, analysis_usage.options);
```

**New**:
```vala
// This one already provides options explicitly - good!
// Just need to change client to connection
var chat = new OLLMchat.Call.Chat(analysis_client.connection, analysis_usage.model, analysis_usage.options);
```

## Implementation Steps

### Step 1: Create Helper Functions

Create helper functions to get model/options from Config2:

```vala
// In Manager or Config2
private string get_model_for_chat(Session? session = null) {
    // Get from session, request, or default
}

private Call.Options get_options_for_model(string model, Config2? config = null) {
    if (config != null && config.model_options.has_key(model)) {
        return config.model_options.get(model);
    }
    return new Call.Options();
}
```

### Step 2: Update Each Creation Point

For each Chat creation point:
1. Change `Client` parameter to `Connection`
2. Get `model` explicitly (from parameter, config, or request)
3. Get `options` explicitly (from parameter, config, or defaults)
4. Set other properties explicitly (`stream`, `think`, `keep_alive`, etc.)
5. Add tools to Chat directly using `chat.add_tool()`

### Step 3: Update Tool Management

Ensure tools are added to Chat, not Client:
- Remove any `client.add_tool()` calls
- Add `chat.add_tool()` calls after Chat creation
- Tools should be added by the caller (AgentHandler, Session, etc.)

## Files to Modify

### Handlers/Agents
- `libollmchat/Prompt/AgentHandler.vala` - Update Chat creation
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Update Chat creation

### Client
- `libollmchat/Client.vala` - Update `chat()` method

### History/Session
- `libollmchat/History/Manager.vala` - Update Chat creation
- `libollmchat/History/EmptySession.vala` - Update Chat creation

### Settings
- `libollmchat/Settings/Config2.vala` - Update `create_chat()` method

### Other
- `libocvector/Indexing/Analysis.vala` - Update Chat creation

## Testing Checklist

- [ ] All Chat creation points updated to use `Connection`
- [ ] All Chat creation points explicitly set `model`
- [ ] All Chat creation points explicitly set `options` (or use defaults)
- [ ] All Chat creation points set other properties explicitly
- [ ] Tools are added to Chat (not Client)
- [ ] No code uses removed Client properties
- [ ] All Chat instances work correctly

## Related Plans

- [1.2.1. Remove Configuration from Client](./1.2.1-remove-config-from-client.md)
- [1.2.3. Update Call.Base to Take Connection](./1.2.3-update-call-base-connection.md)
- [1.2.5. Update Callers to Handle State Directly](./1.2.5-update-callers-state.md)

