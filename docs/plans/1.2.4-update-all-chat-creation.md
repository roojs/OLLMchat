# 1.2.4. Update All Chat Creation Points

## Overview

Update all places in the codebase that create `Call.Chat` objects to use the new constructor signature (taking `Connection` instead of `Client`) and explicitly set all required properties.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

⏳ **TODO** - Refactoring needed.

## ⚠️ CRITICAL: Incremental Implementation Required

**IMPORTANT**: This refactoring must be done incrementally to keep the code usable after each step. See [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md) for the overall approach.

**Key Principle**: Migrate call sites incrementally (one file at a time), ensuring code remains usable after each migration.

## Goal

Ensure all Chat creation points:
1. Pass `Connection` instead of `Client` (using `new_connection_refactor` constructor)
2. Do not use null; only set properties (`model`, `options`, `stream`, `think`, `keep_alive`, etc.) if they do not match the defaults or are explicitly needed to be set
3. Add tools to Chat directly (not Client)
4. Use Config2 or defaults as needed

## Implementation Strategy

This plan implements **Phase 2, Step 2.2-N** of the incremental strategy: migrating all Chat creation points one by one.

**Prerequisites**:
- Phase 1.1 complete: Chat supports both realized and real properties (with `refactor_` prefix)
- Phase 1.2 complete: Call.Base supports both Client and Connection (with `new_connection_refactor` constructor)

## Implementation Steps

### Phase 1: Prepare Helper Functions (Optional)

#### Step 1.1: Create Helper Functions

**Note**: Helper functions are generally not needed:
- **Model**: Session has a `model` property - use `session.model` directly if session is available
- **Options**: `config.model_options.get(model)` returns `Call.Options?` - use directly or with null coalescing: `config.model_options.get(model) ?? new Call.Options()`

If helper functions are needed for specific cases, they should be minimal and only created where the pattern is repeated multiple times.

**Result**: Use direct property access and map lookups instead of helper functions

### Phase 2: Migrate Call Sites Incrementally

Migrate each Chat creation point **one at a time**, test after each migration.

#### Step 2.1: Migrate Client.chat() (Simplest, Isolated)

**File**: `libollmchat/Client.vala`

**Current** (line ~320):
```vala
var call = new Call.Chat(this, this.model) {
    cancellable = cancellable
};
```

**New** (if Phase 1.2 is complete):
```vala
// Use new_connection_refactor constructor with property initialization
var call = new Call.Chat.new_connection_refactor(this.connection, this.model) {
    cancellable = cancellable,
    refactor_stream = this.stream,
    refactor_format = this.format,
    refactor_think = this.think,
    refactor_keep_alive = this.keep_alive
};
```

**Or** (if Phase 1.2 not yet complete, use Client constructor but set real properties):
```vala
// Use refactor_ properties to set real properties on Chat
var call = new Call.Chat(this, this.model) {
    cancellable = cancellable,
    refactor_stream = this.stream,
    refactor_format = this.format,
    refactor_think = this.think,
    refactor_keep_alive = this.keep_alive
};
```

**Test**: Verify `Client.chat()` still works

**Result**: One call site migrated, code still works

#### Step 2.2: Migrate Client.embed() and embed_array()

**File**: `libollmchat/Client.vala`

**Current**:
```vala
var call = new Call.Embed(this, this.model, new Call.Options()) {
    cancellable = cancellable,
    input = input,
    dimensions = dimensions,
    truncate = truncate
};
```

**New**:
```vala
// Use new_connection_refactor constructor (if Phase 1.2 complete)
var call = new Call.Embed.new_connection_refactor(this.connection, this.model, new Call.Options()) {
    cancellable = cancellable,
    input = input,
    dimensions = dimensions,
    truncate = truncate
};
```

**Test**: Verify `Client.embed()` and `embed_array()` still work

**Result**: Two more call sites migrated, code still works

#### Step 2.3: Migrate Client.generate()

**File**: `libollmchat/Client.vala`

**Current**:
```vala
var call = new Call.Generate(this) {
    cancellable = cancellable,
    prompt = prompt,
    system = system
};
```

**New**:
```vala
// Use new_connection_refactor constructor (if Phase 1.2 complete)
var call = new Call.Generate.new_connection_refactor(this.connection) {
    cancellable = cancellable,
    prompt = prompt,
    system = system,
    refactor_stream = this.stream,
    refactor_format = this.format,
    refactor_think = this.think,
    refactor_keep_alive = this.keep_alive
};
```

**Test**: Verify `Client.generate()` still works

**Result**: Another call site migrated, code still works

#### Step 2.4: Migrate Config2.create_chat() (Already Good Pattern)

**File**: `libollmchat/Settings/Config2.vala`

**Current** (line ~559):
```vala
return new OLLMchat.Call.Chat(client, model_usage_obj.model, model_usage_obj.options);
```

**New**:
```vala
// This one already provides options explicitly - good!
// Just need to change to new_connection_refactor constructor
return new OLLMchat.Call.Chat.new_connection_refactor(
    client.connection, 
    model_usage_obj.model, 
    model_usage_obj.options
) {
    refactor_stream = true,  // Or get from config
    refactor_think = false,
    refactor_keep_alive = "5m"
};
```

**Test**: Verify `Config2.create_chat()` still works

**Result**: Another call site migrated, code still works

#### Step 2.5: Migrate Analysis (Already Good Pattern)

**File**: `libocvector/Indexing/Analysis.vala`

**Current** (line ~322):
```vala
var chat = new OLLMchat.Call.Chat(analysis_client, analysis_usage.model, analysis_usage.options);
```

**New**:
```vala
// This one already provides options explicitly - good!
// Just need to change to new_connection_refactor constructor
var chat = new OLLMchat.Call.Chat.new_connection_refactor(
    analysis_client.connection, 
    analysis_usage.model, 
    analysis_usage.options
) {
    refactor_stream = true,
    refactor_think = false
};
```

**Test**: Verify Analysis still works

**Result**: Another call site migrated, code still works

#### Step 2.6: Migrate EmptySession.send_message()

**File**: `libollmchat/History/EmptySession.vala`

**Current** (line ~73):
```vala
var chat = new Call.Chat(new_client, new_client.model);
```

**New**:
```vala
// Get model from session or config
var model = this.model;  // Session has model property
if (model == "" && this.manager.config != null) {
    model = this.manager.config.get_default_model();
}

// Get options from config (use model_options map directly)
var options = this.manager.config.model_options.get(model) ?? new Call.Options();

var chat = new Call.Chat.new_connection_refactor(new_client.connection, model, options) {
    refactor_stream = true,
    refactor_think = false,
    refactor_keep_alive = "5m"
};
```

**Test**: Verify EmptySession.send_message() still works

**Result**: Another call site migrated, code still works

#### Step 2.7: Migrate SessionPlaceholder

**File**: `libollmchat/History/SessionPlaceholder.vala`

**Current** (line ~88):
```vala
var real_session = new Session(this.manager, new Call.Chat(client, this.model));
```

**New**:
```vala
// Get options from config (use model_options map directly)
var options = this.manager.config.model_options.get(this.model) ?? new Call.Options();

var chat = new Call.Chat.new_connection_refactor(client.connection, this.model, options) {
    refactor_stream = true,
    refactor_think = false
};
var real_session = new Session(this.manager, chat);
```

**Test**: Verify SessionPlaceholder still works

**Result**: Another call site migrated, code still works

#### Step 2.8: Migrate Manager.new_client()

**File**: `libollmchat/History/Manager.vala`

**Current** (line ~271):
```vala
var session = new Session(this, new Call.Chat(client, client.model));
```

**New**:
```vala
// Get model from current session if available, otherwise use default from config
var model = "";
if (this.session != null && this.session.model != "") {
    model = this.session.model;
} else if (this.config != null) {
    model = this.config.get_default_model();
}

// Get options from config (use usage map for default_model, or model_options)
var options = new Call.Options();
var default_usage = this.config.usage.get("default_model") as Settings.ModelUsage;
if (default_usage != null) {
    options = default_usage.options;
} else {
    options = this.config.model_options.get(model) ?? new Call.Options();
}

var chat = new Call.Chat.new_connection_refactor(client.connection, model, options) {
    refactor_stream = true,
    refactor_think = false
};
var session = new Session(this, chat);
```

**Test**: Verify Manager.new_client() still works

**Result**: Another call site migrated, code still works

#### Step 2.9: Migrate AgentHandler (Most Complex - Has Tools)

**File**: `libollmchat/Prompt/AgentHandler.vala`

**Current** (line ~131):
```vala
var call = new OLLMchat.Call.Chat(this.client, this.client.model);
```

**New**:
```vala
// Get model from session (Session has model property)
var model = this.session.model;
if (model == "" && this.client.config != null) {
    model = this.client.config.get_default_model();
}

// Get options from config (use model_options map directly)
var options = this.client.config.model_options.get(model) ?? new Call.Options();

var call = new OLLMchat.Call.Chat.new_connection_refactor(
    this.client.connection, 
    model, 
    options
) {
    refactor_stream = true,
    refactor_think = false,
    refactor_keep_alive = "5m"
};

// Add tools to Chat directly (not Client)
foreach (var tool in this.agent.get_tools()) {
    call.add_tool(tool);
}
```

**Test**: Verify AgentHandler still works, tools are added correctly

**Result**: Another call site migrated, code still works

#### Step 2.10: Migrate CodeAssistantHandler (Most Complex - Has Tools)

**File**: `liboccoder/Prompt/CodeAssistantHandler.vala`

**Current** (line ~55):
```vala
var call = new OLLMchat.Call.Chat(this.client, this.client.model);
```

**New**: Same pattern as AgentHandler above.

**Test**: Verify CodeAssistantHandler still works, tools are added correctly

**Result**: All call sites migrated, code still works

### Phase 3: Cleanup (After All Migrations Complete)

#### Step 3.1: Remove Old Client Constructors

**Prerequisite**: All Chat creation points must be migrated (Phase 2 complete)

**Changes**:
- Remove `Chat(Client client, ...)` constructors
- Rename `Chat.new_connection_refactor(...)` to `Chat(...)` (now the only constructor)
- Repeat for all Call classes

**Result**: Call constructors are simpler, but code still works

## Files to Modify

### Handlers/Agents
- `libollmchat/Prompt/AgentHandler.vala` - Step 2.9
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Step 2.10

### Client
- `libollmchat/Client.vala` - Steps 2.1, 2.2, 2.3

### History/Session
- `libollmchat/History/Manager.vala` - Step 2.8
- `libollmchat/History/EmptySession.vala` - Step 2.6
- `libollmchat/History/SessionPlaceholder.vala` - Step 2.7

### Settings
- `libollmchat/Settings/Config2.vala` - Step 2.4

### Other
- `libocvector/Indexing/Analysis.vala` - Step 2.5

## Testing Checklist

- [ ] Step 2.1: Client.chat() migrated and tested
- [ ] Step 2.2: Client.embed() / embed_array() migrated and tested
- [ ] Step 2.3: Client.generate() migrated and tested
- [ ] Step 2.4: Config2.create_chat() migrated and tested
- [ ] Step 2.5: Analysis migrated and tested
- [ ] Step 2.6: EmptySession.send_message() migrated and tested
- [ ] Step 2.7: SessionPlaceholder migrated and tested
- [ ] Step 2.8: Manager.new_client() migrated and tested
- [ ] Step 2.9: AgentHandler migrated and tested (with tools)
- [ ] Step 2.10: CodeAssistantHandler migrated and tested (with tools)
- [ ] All Chat creation points use `new_connection_refactor` constructor
- [ ] All Chat creation points explicitly set `refactor_*` properties
- [ ] Tools are added to Chat (not Client)
- [ ] All Chat instances work correctly

## Related Plans

- [1.2.1. Remove Configuration from Client](./1.2.1-remove-config-from-client.md)
- [1.2.3. Update Call.Base to Take Connection](./1.2.3-update-call-base-connection.md)
- [1.2.5. Update Callers to Handle State Directly](./1.2.5-update-callers-state.md)
- [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md)
