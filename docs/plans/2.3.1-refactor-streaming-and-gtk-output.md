# 2.3.1. Refactor Command Output to Markdown Code Blocks

## Overview

Refactor `RequestRunCommand` to remove GTK dependency by using markdown code blocks for command output display. This eliminates the need for separate GTK versions and uses the existing markdown renderer.

## Goals

1. Remove GTK-specific `RequestRunCommand` and `RunCommand` classes
2. Use two markdown code blocks: `bash` for the command, `txt` for the output
3. Send complete output as a single tool message when command finishes
4. Leverage existing markdown renderer for display

## Current Architecture

- **Base class**: `libollmchat/Tools/RequestRunCommand.vala` - uses virtual methods `send_initial_tool_message()` and `send_or_append_message()`
- **GTK version**: `libollmchatgtk/Tools/RequestRunCommand.vala` - overrides methods to create `GtkSource.View` widgets
- **GTK tool**: `libollmchatgtk/Tools/RunCommand.vala` - deserializes to GTK RequestRunCommand
- **Usage**: `ollmchat/Window.vala` line 267 uses `OLLMchatGtk.Tools.RunCommand`

## Proposed Architecture

- **Single base class**: `libollmchat/Tools/RequestRunCommand.vala` - sends markdown code blocks via `tool_message()`
- **Simple output**: Accumulate all command output, then send complete message when done
- **UI handling**: `ChatView.append_tool_message()` renders markdown using existing infrastructure

### Output Structure

The tool message will contain two separate markdown code blocks:

```
```bash
$ ls -la
```

```txt
total 24
drwxr-xr-x  3 user user 4096 Jan 1 12:00 .
drwxr-xr-x  5 user user 4096 Jan 1 12:00 ..
-rw-r--r--  1 user user 1234 Jan 1 12:00 file.txt

Exit code: 0
```
```

- First block (`bash`): Shows the command that was executed
- Second block (`txt`): Shows the complete command output including exit code

## Implementation Tasks

### 1. Refactor RequestRunCommand

**File**: `libollmchat/Tools/RequestRunCommand.vala`

- Remove virtual methods `send_initial_tool_message()` and `send_or_append_message()`
- In `execute_tool_async()`:
  - Read all output from stdout and stderr (accumulate in strings)
  - Wait for command to complete and get exit status
  - Build complete markdown message with two code blocks:
    - First block (bash): `"```bash\n$ " + command + "\n```\n\n"`
    - Second block (txt): `"```txt\n" + stdout_output + stderr_output + "\nExit code: " + exit_status + "\n```"`
  - Send complete message via `chat_call.client.tool_message()` once
- Simplify `read_stream_async()`:
  - Just accumulate output into a string (no need to send messages during reading)
  - Return accumulated output

### 2. Update RunCommand Tool

**File**: `libollmchat/Tools/RunCommand.vala`

- No changes needed - already deserializes to base `RequestRunCommand`

### 3. Remove GTK Versions

**Files to delete**:
- `libollmchatgtk/Tools/RequestRunCommand.vala`
- `libollmchatgtk/Tools/RunCommand.vala`

**Files to update**:
- `libollmchatgtk/meson.build` - remove GTK tool files from build
- `docs/meson.build` - remove GTK tool files from documentation build

### 4. Update Window to Use Base RunCommand

**File**: `ollmchat/Window.vala` (line 267)

- Change from:
  ```vala
  new OLLMchatGtk.Tools.RunCommand(this.history_manager.base_client, 
      GLib.Environment.get_home_dir())
  ```
- To:
  ```vala
  new OLLMchat.Tools.RunCommand(this.history_manager.base_client, 
      GLib.Environment.get_home_dir())
  ```

## Technical Details

### Markdown Rendering

The existing `append_tool_message()` method already handles markdown rendering:
- Uses `Markdown.PangoRender` to convert markdown to Pango markup
- Applies grey, small text styling via Pango markup: `<span size="small" color="#1a1a1a">`
- Renders complete markdown blocks including code blocks

No changes needed to `ChatView.append_tool_message()` - it will automatically handle the two code blocks correctly.

### Output Formatting

The markdown message structure:
1. Bash code block with command (closed)
2. Empty line for separation
3. Txt code block with output (closed)
4. Exit code included in txt block

Example:
```markdown
```bash
$ ls -la
```

```txt
total 24
file1.txt
file2.txt

Exit code: 0
```
```

## Testing Considerations

- Test with commands that output many lines
- Ensure both code blocks (bash and txt) render correctly
- Verify bash block shows command, txt block shows output
- Verify exit code is displayed correctly
- Test error handling (command failures, stderr output)
- Test with commands that produce no output

## Benefits

1. **Removes GTK dependency** from base tool classes
2. **Simpler implementation** - no streaming complexity
3. **Better markdown rendering** - leverages existing renderer capabilities
4. **Simpler codebase** - no separate GTK versions to maintain
5. **Clean output** - complete command and result displayed together

## Migration Notes

- Existing sessions with tool messages will continue to work
- No breaking changes to tool API
- GTK-specific code is removed but functionality is preserved via markdown

