# 2.20.3. Binary File Handling - Image Analysis

## Status

⏳ **PENDING**

## Purpose

Enable searching for images by their content through text descriptions generated by vision models. This makes images, screenshots, diagrams, and UI mockups discoverable via codebase search.

## Problem Statement

Binary files (images, PDFs, etc.) are currently skipped entirely. There's no way to search for images or understand their content.

## Current Status

Binary files are currently skipped:
- `Indexer.index_file()` checks `if (!file.is_text)` and skips binary files
- Images, PDFs, and other binary files are not indexed
- No way to search for images or understand their content

## Proposed Image Analysis

**Goal**: Enable searching for images by their content through text descriptions.

**Approach**:
1. Detect image files (common extensions: `.png`, `.jpg`, `.jpeg`, `.gif`, `.webp`, `.svg`, etc.)
2. Use vision model to analyze image and generate text description
3. Vectorize the text description (not the image itself)
4. Store image metadata with description in `vector_metadata`
5. Enable codebase search to find images by their content descriptions

## Implementation Details

### Image Detection

- Check file extension against known image formats
- Could use `file.is_text == false` and check MIME type or extension
- Common formats: PNG, JPEG, GIF, WebP, SVG, BMP, TIFF

### Image Analysis Process

1. Load image file (read binary data)
2. Send image to vision model (e.g., via Ollama vision API or similar)
3. Generate text description of image content
4. Store description in `vector_metadata.description`
5. Vectorize description text (create embedding)
6. Store in FAISS with `vector_id` and metadata

### Storage

- `element_type = 'image'` (or `'binary'` for other binary files)
- `file_id` references the image file
- `start_line = 0, end_line = 0` (no line numbers for images)
- `description` contains text description of image content
- `vector_id` points to vectorized description embedding
- `ast_path = ''` (images don't have AST paths)

### Vision Model Integration

- Use Ollama vision models (e.g., `llava`, `bakllava`) or similar
- Send image as base64 or file path to vision API
- Prompt: "Describe this image in detail. Include any text, objects, diagrams, screenshots, or visual elements."
- Get text response describing the image
- This text description is what gets vectorized

### Vectorization

- The text description is treated like any other document
- Create embedding from description text
- Store in FAISS index
- Searchable via codebase search tool

### Example Flow

```
1. Detect: image.png (binary file, extension .png)
2. Load image data
3. Call vision model: "Describe this image"
4. Get response: "Screenshot of a login form with username and password fields, submit button, and company logo in header"
5. Create VectorMetadata:
   - element_type = 'image'
   - element_name = 'image.png'
   - description = "Screenshot of a login form..."
6. Vectorize description text
7. Store in FAISS and metadata table
```

### Search Results

- When searching for "login form", image description matches
- Search result includes image file path
- User can see what images contain without opening them

## Other Binary Files

**PDFs**:
- Could use PDF text extraction
- Extract text content and vectorize
- Similar to image analysis but extract text instead of describing

**Other Formats**:
- Consider on case-by-case basis
- Priority: Images (most common, most useful)
- Future: PDFs, Office documents, etc.

## Implementation Requirements

### New Components

1. `ImageAnalyzer` class:
   - Detects image files
   - Loads image data
   - Calls vision model API
   - Returns text description

2. `Indexer.index_binary_file()` method:
   - Handles binary files (images, PDFs, etc.)
   - Routes to appropriate analyzer (image, PDF, etc.)
   - Creates VectorMetadata entries
   - Vectorizes descriptions

3. Vision model integration:
   - Add vision API support to `OLLMchat.Client`
   - Or use existing image analysis tools if available
   - Configure vision model in tool config

### Configuration

- Add `vision_model` to `CodebaseSearchToolConfig`
- Specify which vision model to use for image analysis
- Enable/disable binary file indexing

### Modified Flow

```
Indexer.index_file():
  if (file.is_text):
    → Normal text file indexing (existing)
  else if (is_image_file(file)):
    → Image analysis and description vectorization (NEW)
  else:
    → Skip or handle other binary types (future)
```

## Benefits

- Images become searchable by content
- Screenshots, diagrams, UI mockups can be found via description
- Documentation images (screenshots, diagrams) are discoverable
- Better project understanding through visual content

## Deliverables

- [ ] Create `ImageAnalyzer` class for vision model integration
- [ ] Add vision API support to `OLLMchat.Client` (or use existing tools)
- [ ] Implement `Indexer.index_binary_file()` method
- [ ] Add image file detection (extension/MIME type checking)
- [ ] Add `vision_model` configuration to `CodebaseSearchToolConfig`
- [ ] Implement image analysis flow (load → analyze → describe → vectorize)
- [ ] Store image metadata with `element_type='image'`
- [ ] Test image indexing and searchability
- [ ] Document supported image formats

## Related Plans

- 2.20-codebase-scanner-improvements.md - Parent plan
- 2.10-codebase-search-tool.md - Existing codebase search infrastructure
