# 1.3.2. Configuration Interface

## Overview

The user permission dialog provides a unified interface for managing connections, models, tools, and agents. This dialog will be implemented in the `ollmchat` application directory under `Settings/` subfolder using libadw (Adwaita) for GTK4 UI components.

## Status

✅ **PARTIALLY COMPLETE** - SettingsDialog and ConnectionsPage implemented. ModelsPage and ToolsPage not yet implemented.

## Related Plans

- **1.3** - Multiple Client Configuration
- **1.3.1** - Configuration Classes
- **1.4** - Client Configuration Setup
- **1.5** - Model List Management
- **1.6** - Tools Management

## Dialog Tree Structure

```
SettingsDialog (Main Window)
│
├── Tab: Connections
│   ├── Horizontal Box (Action Bar)
│   │   └── [Add Connection] Button
│   │
│   ├── Adw.PreferencesGroup (in Adw.BoxedList)
│   │   └── Connection List (Adw.BoxedList)
│   │       ├── [Connection 1] (Adw.ExpanderRow) [Edit] [Remove]
│   │       ├── [Connection 2] (Adw.ExpanderRow) [Edit] [Remove]
│   │       └── [Connection N] (Adw.ExpanderRow) [Edit] [Remove]
│   │       └── (When only one connection: [Edit] only - Remove button disabled/hidden)
│   │
│   └── Connection Details Panel (Adw.ExpanderRow - when expanded)
│       ├── Name: [text entry]
│       ├── URL: [text entry]
│       ├── API Key: [text entry (password)]
│       ├── Default: [checkbox]
│       └── Action Buttons (at bottom, last row)
│           ├── [Remove] Button (red, left) - Only shown if more than one connection exists
│           └── [Verify] Button (green/blue, right) - Tests connection and saves to config
│
├── Tab: Models
│   ├── Horizontal Box (Action Bar)
│   │   ├── Adw.SearchBar
│   │   │   └── [Search Models] - Filter models by name
│   │   ├── [Add Model] Button (placeholder - not implemented)
│   │   └── [Refresh] Button - Refresh model list from all connections
│   │
│   ├── Adw.PreferencesGroup (in Adw.BoxedList)
│   │   └── Model List (Adw.BoxedList, grouped by connection)
│   │       ├── Connection 1: "Local Ollama" (Section Header)
│   │       │   ├── [Model 1] [Settings ▼] (Adw.ExpanderRow)
│   │       │   ├── [Model 2] [Settings ▼] (Adw.ExpanderRow)
│   │       │   └── [Model N] [Settings ▼] (Adw.ExpanderRow)
│   │       ├── Connection 2: "Remote Server" (Section Header)
│   │       │   ├── [Model 1] [Settings ▼] (Adw.ExpanderRow)
│   │       │   └── [Model 2] [Settings ▼] (Adw.ExpanderRow)
│   │       └── Connection N: "OpenAI" (Section Header)
│   │           └── [Model 1] [Settings ▼] (Adw.ExpanderRow)
│   │
│   └── Model Settings Panel (Adw.ExpanderRow - when expanded)
│       ├── Connection: [read-only label] (models are fixed to their provider)
│       ├── Model Name: [read-only label]
│       ├── [Separator]
│       ├── Temperature: [spin button]
│       ├── Top P: [spin button]
│       ├── Top K: [spin button]
│       ├── Num Ctx: [spin button]
│       └── ... (other Call.Options fields listed directly)
│
├── Tab: Tools
│   ├── Horizontal Box (Action Bar)
│   │   └── Adw.SearchBar
│   │       └── [Search Tools] - Filter tools by name
│   │
│   ├── Adw.PreferencesGroup (in Adw.BoxedList)
│   │   └── Tool List (Adw.BoxedList)
│   │       ├── [Tool 1] (Adw.ExpanderRow) [Configure ▼]
│   │       │   ├── [Config 1: Embedding Settings] [Edit]
│   │       │   ├── [Config 2: Analysis Settings] [Edit]
│   │       │   └── [Add Config] Button
│   │       ├── [Tool 2] (Adw.ExpanderRow) [Configure ▼]
│   │       └── [Tool N] (Adw.ExpanderRow) [Configure ▼]
│   │
│   └── Tool Configuration Panel (Adw.ExpanderRow - when expanded)
│       ├── Config Name: [text entry] (e.g., "embed", "analysis")
│       ├── Config Display Name: [text entry] (e.g., "Embedding Settings", "Analysis Settings")
│       ├── Enabled: [checkbox]
│       ├── Model Configuration: [ModelUsage editor]
│       │   ├── Connection: [dropdown]
│       │   ├── Model: [dropdown]
│       │   ├── [Separator]
│       │   ├── Temperature: [spin button]
│       │   ├── Top P: [spin button]
│       │   └── ... (other Call.Options fields listed directly)
│       └── Tool-Specific Settings: [dynamic based on tool type]
│           └── (varies by tool - e.g., vector.embed has vector_db_path, etc.)
│
└── Tab: Agents
    └── [TODO - Not implemented yet]
```

## Detailed Component Descriptions

### Connections Tab

**Purpose**: Manage server connections (add, remove, edit connection details).

**Components**:
- **Horizontal Box (Action Bar)**: Top horizontal container with action buttons
  - **Add Connection Button**: Opens ConnectionAdd dialog for adding new connection
- **Adw.PreferencesGroup**: Contains the connection list
  - Wraps `Gtk.ListBox` for connection list
- **Connection List**: Uses `Gtk.ListBox` to display all connections from `Config2.connections` map
  - Each connection uses `Adw.ExpanderRow` to show/edit connection details inline
  - Each connection shows: name, URL, default indicator (when collapsed)
  - When expanded: Shows editable form fields with Remove and Verify buttons at bottom
  - Editing is inline - no separate edit mode needed
- **Connection Details Panel**: Uses `Adw.ExpanderRow` - inline editable form for connection properties
  - Settings widgets are added as children to the `Adw.ExpanderRow` using `add_row()`
  - Uses `Adw.ActionRow` with suffix widgets for form fields
  - Name: Connection alias/name (Gtk.Entry as suffix)
  - URL: Server URL (e.g., `http://127.0.0.1:11434/api`) (Gtk.Entry as suffix)
  - API Key: Optional API key (Gtk.PasswordEntry as suffix)
  - Default: Switch to mark as default connection (Gtk.Switch as suffix)
  - **Unverified State**: When connection details are edited, add CSS class `oc-settings-unverified` to change background color
  - **Action Buttons** (shown at bottom, in Gtk.Box):
    - **Remove Button** (red, left side): Only shown when expanded and if more than one connection exists
      - Removes connection from `config.connections` map
      - Validation: Cannot remove if it's the last connection
    - **Verify Button** (green/blue, right side): Tests connection using same code as ConnectionAdd dialog
      - Creates temporary Client and calls `version()` endpoint to test
      - On success: Saves connection to `config` immediately (calls `config.save()`)
      - On failure: Shows error message
      - After verification: Removes `oc-settings-unverified` class

**Validation**:
- Cannot remove all connections (at least one must exist) - Remove button only shown when more than one connection exists
- URL must be valid format (validated when Verify button is clicked)
- Name must be unique (or use URL as key)
- Connection is saved to config immediately after successful verification (no separate save step needed)

**Data Source**: `Config2.connections` (Gee.Map<string, Settings.Connection>)

---

### Models Tab

**Purpose**: List available models, add new models, configure model-specific options.

**Components**:
- **Horizontal Box (Action Bar)**: Top horizontal container with search and action buttons
  - **Adw.SearchBar**: Search bar for filtering models
    - Filters model list in real-time as user types using show/hide visibility (does not remove models from list)
    - Searches across all connections
    - Hides connection section headers with no matching models (using visibility, not removal)
  - **Add Model Button**: Placeholder button for future model discovery feature (not implemented yet)
  - **Refresh Button**: Refresh model list from all connections
    - Fetches latest models from all configured connections
    - Updates the model list dynamically
- **Adw.PreferencesGroup**: Contains the model list
  - Wraps `Adw.BoxedList` for consistent styling
- **Model List**: Uses `Adw.BoxedList` to display models grouped by connection
  - Models are organized under their connection name (e.g., "Local Ollama", "Remote Server")
  - Each connection group uses a section header (not expandable) to show the connection name
  - Models are sorted alphabetically by name within each connection group
  - Model rows are added directly to the list after each section header
  - Each model row uses `Adw.ExpanderRow` to show/edit model settings (expandable rows)
  - Shows: model name, connection name (implicit from section header grouping)
- **Model Settings Panel**: Uses `Adw.ExpanderRow` - when model row is expanded (lazy rendering)
  - Settings widgets are added as children to the `Adw.ExpanderRow` using `add_row()` only when expanded
  - Connection: Read-only label (models are fixed to their provider/connection, not changeable)
  - Model Name: Read-only label (model name from the connection)
  - Separator (visual divider)
  - Options fields listed directly (not nested): Temperature, Top P, Top K, Num Ctx, Num Predict, Repeat Penalty, Min P, Seed, Stop
  - Options widgets restrict invalid input based on value limitations (e.g., temperature 0.0-2.0, num_ctx > 0, etc.)
  - Saves changes on blur/unblur or focus events (when user finishes editing a field)
  - Note: Only models with user-set options are saved to config. Temporary model usage array contains all models on load, but only modified ones are persisted.

**Data Sources**:
- Model list: Fetched from `Client.models()` for each connection
- Model options: `Config2.model_options` (Gee.Map<string, Call.Options>) - Only contains models where user has set options. Key is model name only (e.g., "llama3").
- Models: `models` (Gee.Map<string, Call.Options>) - Copy of model_options with all models. Key format: "connection#model_name" (e.g., "http://127.0.0.1:11434/api#llama3"). Built on load with all models, merged with config values. Only models with user-set options are saved back to config (using model name only as key).

**Note**: Model list is dynamic (fetched from connections). Config2 only stores model options for models where the user has explicitly set values. The composite key format ("connection#model_name") is only used in the ModelsPage's `models` map for the UI dialog - Config2.model_options uses model name only as the key (e.g., "llama3").

**Ideas for Future Enhancement**:
- **Model Notes**: Add a notes field for each model to allow users to make personal notes about models (e.g., "Good for code generation", "Slow but accurate", "Use for creative writing"). This could be stored in `Config2.model_metadata` or a separate `model_notes` map.
- **Expected Tokens/Second (t/s)**: Track expected performance metrics for each model. This could be:
  - Manually set by the user
  - Automatically updated from actual usage statistics (track tokens/second during API calls)
  - Used for estimating response times and selecting appropriate models for different tasks
  - Stored in `Config2.model_metadata` alongside notes

---

### Tools Tab

**Purpose**: Configure tools, set up models for tools, manage tool-specific settings.

**Components**:
- **Horizontal Box (Action Bar)**: Top horizontal container with search
  - **Adw.SearchBar**: Search bar for filtering tools
    - Filters tool list in real-time as user types
    - Searches by tool name and description
  - (No action buttons - tools are auto-discovered from registry)
- **Adw.PreferencesGroup**: Contains the tool list
  - Wraps `Adw.BoxedList` for consistent styling
- **Tool List**: Uses `Adw.BoxedList` to display all registered tools
  - Shows: tool name, enabled status, description
  - Each tool uses `Adw.ExpanderRow` to show/edit tool configurations
  - Each tool can have multiple configurations (e.g., `vector.embed`, `vector.analysis`)
- **Tool Configuration List**: When tool row is expanded
  - Lists all configurations for the tool (e.g., "Embedding Settings", "Analysis Settings")
  - Each config shows: config name, display name, enabled status
  - Actions: Edit config, Remove config, Add new config
- **Tool Configuration Panel**: Uses `Adw.ExpanderRow` - when a specific config is selected
  - Settings widgets are added as children to the `Adw.ExpanderRow` using `add_row()`
  - Config Name: Text entry (e.g., "embed", "analysis") - used as key suffix
  - Config Display Name: Text entry (e.g., "Embedding Settings", "Analysis Settings") - shown in UI
  - Enabled: Checkbox to enable/disable this specific configuration
  - Model Configuration: `ModelUsage` editor (connection, model, options)
    - Uses the same `ModelUsage` class as ocvector
    - Connection dropdown: References `Config2.connections`
    - Model dropdown: Models available from selected connection
    - Separator (visual divider)
    - Options fields listed directly: Temperature, Top P, Top K, Num Ctx, etc.
  - Tool-Specific Settings: Dynamic UI based on tool type
    - Uses tool registration system to discover configurable properties
    - Each tool can register its configuration schema via `register_type()` in Config2
    - Example: `vector.embed` might have `vector_db_path`, `index_settings`, etc.

**Data Sources**:
- Tool registry: `Client.tools` (Gee.HashMap<string, Tool>)
- Tool configurations: `Config2.external_configs` (via registered types)
  - Tools register their config type with Config2: `config2.register_type("vector", typeof(ToolConfig))`
  - Tool configs stored with composite keys: `external_configs["vector.embed"]` → ToolConfig object
  - Multiple configs per tool: `vector.embed`, `vector.analysis`, etc.

**Tool Registration Pattern**:
- Tools register their configuration class with Config2 using `register_type(tool_name, typeof(ToolConfig))`
- Tool configs stored in `Config2.external_configs` map with composite keys: `tool_name.config_name`
- Examples:
  - `vector.embed` → Embedding settings (for semantic search)
  - `vector.analysis` → Analysis settings (for semantic search)
  - `codebase_search.main` → Main codebase search configuration
- Tool config classes should implement `Json.Serializable`
- Tool config classes can contain `ModelUsage` for model configuration
- Each tool can have multiple configurations, each with its own key in the format `tool_name.config_name`

---

### Agents Tab

**Purpose**: Manage agent configurations (future feature).

**Status**: ⏳ **TODO** - Not implemented yet. Placeholder tab for future agent management.

---

## Implementation Considerations

### UI Files Needed (using libadw)

**Note**: These are UI files (not configuration classes) that use libadw (Adwaita) for GTK4 UI components.

**Layout Components**:
- **Adw.PreferencesDialog**: Main dialog window uses `Adw.PreferencesDialog` (not `Adw.Dialog` or `Adw.Window`)
- **Adw.BoxedList**: All lists (connections, models, tools) use `Adw.BoxedList` for consistent styling and layout
- **Adw.PreferencesGroup**: Wraps `Adw.BoxedList` to provide group headers and consistent spacing
- **Adw.ExpanderRow**: All expandable panels (connection details, model settings, tool configurations) use [`Adw.ExpanderRow`](https://valadoc.org/libadwaita-1/Adw.ExpanderRow.html). Settings widgets are added as children using the `add_row()` method. Provides built-in expand/collapse functionality with a visual indicator (▼ arrow)
- **Adw.SearchBar**: Used for search functionality in Models and Tools tabs
- **Horizontal Box (Action Bar)**: Top horizontal container in each tab containing search bar and action buttons (Add, Refresh, etc.)
  - Uses `Gtk.Box` with horizontal orientation
  - Contains both the search bar and action buttons in one container
- **ConnectionAdd**: Dialog for adding new connections (reusable dialog similar to initial bootstrap)

**Model Management**:
- **ModelManager** (potential new class in `libollmchat/`): Similar to liststore wrappers, can contain extra model information
  - May be needed to manage model list with additional metadata (notes, tokens/second, etc.)
  - If created, SettingsDialog would use ModelManager instead of simple `Gee.List<ModelInfo>`
  - Otherwise, SettingsDialog maintains `models_list` property directly

**1. SettingsDialog (Main Dialog Window)**
- **Location**: `ollmchat/Settings/SettingsDialog.vala`
- **UI Framework**: Uses `Adw.PreferencesDialog` with `Adw.ViewStack` for tabs
- **Purpose**: Main dialog window with tabbed interface for displaying and changing configuration
- **Properties**:
  - `config` (Settings.Config2) - Reference to configuration object (contains `connections` map)
  - // `models_list` (Gee.List<ModelInfo>?) - List of available models from all connections (commented out until model tab is added)
  - // `model_manager` (ModelManager?) - Optional ModelManager for managing model list (if created) (commented out until model tab is added)
- **Signals**:
  - // `refresh_models()` - Emitted when models need to be refreshed (main window can connect to this) (commented out until model tab is added)
- **Methods**:
  - `on_close()` - Called when dialog closes, calls `config.save()` to persist changes
  - Note: This class is only responsible for displaying and changing configuration, not loading/saving
  - Loading is done by the caller before creating the dialog
  - Saving is done automatically on close
  - Note: Client instances are not created by this class - that's the responsibility of the caller/main window

**2. ConnectionsPage**
- **Location**: `ollmchat/Settings/ConnectionsPage.vala`
- **Status**: ✅ **IMPLEMENTED** - Connections tab working with add/edit/remove functionality. Uses ConnectionAdd dialog for adding connections.
- **UI Framework**: Uses `Adw.PreferencesPage` with:
  - Horizontal box at top (Add Connection button)
  - `Adw.PreferencesGroup` wrapping `Gtk.ListBox` for connection list
  - `Adw.ExpanderRow` for each connection (expandable connection details panels)
  - Settings widgets added to `Adw.ExpanderRow` via `add_row()` method (Adw.ActionRow with suffix widgets)
  - Remove and Verify buttons shown at bottom of expanded connection details
  - Uses `oc-settings-unverified` CSS class to mark unverified connections
  - See [Adw.ExpanderRow documentation](https://valadoc.org/libadwaita-1/Adw.ExpanderRow.html)
- **Purpose**: Connections tab content
- **Properties**:
  - `settings_dialog` (SettingsDialog) - Reference to parent SettingsDialog (which has the config object)
- **Methods**:
  - `add_connection()` - Opens ConnectionAdd dialog for adding new connection
  - `on_add_closed()` - Called when ConnectionAdd dialog closes, adds verified connection to config
  - `verify_connection(string url)` - Tests connection (same code as ConnectionAdd dialog) and saves to config on success
  - `remove_connection(string url)` - Removes connection from `config.connections` map and updates visibility of Remove buttons (hides if only one connection left)
  - `render_connections()` - Creates UI entries from `config.connections` map
    - Does initial render when page is created
    - Can be called after connections are added/removed to update the UI
    - Updates Remove button visibility based on number of connections
    - Uses `add_connection_row()` to create each connection's expandable row
  - `add_connection_row(string url, Connection connection, bool can_remove)` - Creates expandable row for a connection with form fields
  - Note: Editing is inline - no separate edit/update methods needed. Fields automatically add `oc-settings-unverified` CSS class when changed.

**3. ConnectionAdd**
- **Location**: `ollmchat/Settings/ConnectionAdd.vala`
- **Status**: ✅ **IMPLEMENTED** - Dialog for adding new connections, can be used for both initial bootstrap setup and adding new connections.
- **UI Framework**: Uses `Adw.PreferencesDialog` with:
  - Single `Adw.PreferencesPage` with form fields
  - `Adw.ActionRow` widgets for Host and API Key fields
  - Add Connection button with spinner for loading state
  - See [Adw.PreferencesDialog documentation](https://valadoc.org/libadwaita-1/Adw.PreferencesDialog.html)
- **Purpose**: Dialog for adding/verifying new connections
- **Properties**:
  - `verified_connection` (Connection?) - The verified connection object (set after successful verification), null if verification failed or dialog was cancelled
- **Signals**:
  - `error_occurred(string error_message)` - Emitted when an error occurs during connection test
  - `dialog_closed()` - Emitted when the dialog is closed
- **Methods**:
  - `show_add()` - Shows dialog in "add" mode (clears previous state)
  - `test_and_save()` - Tests connection by creating temporary Client and calling `version()` endpoint, creates Connection object on success
  - `update_button_state()` - Updates button enabled state based on host entry content
  - Note: Uses `closed` signal and `force_close()` method (not `close_request`)

**4. ModelsPage**
- **Location**: `ollmchat/Settings/ModelsPage.vala`
- **Status**: ⏳ **NOT YET IMPLEMENTED**
- **UI Framework**: Uses `Adw.PreferencesPage` with:
  - Horizontal box at top containing `Adw.SearchBar`, Add Model, and Refresh buttons
  - `Adw.PreferencesGroup` wrapping `Adw.BoxedList` for model list
  - Connection groups use section headers (not expandable) to show connection names
  - Model rows use `Adw.ExpanderRow` for expandable model settings panels
  - Settings widgets added to `Adw.ExpanderRow` via `add_row()` method
  - See [Adw.ExpanderRow documentation](https://valadoc.org/libadwaita-1/Adw.ExpanderRow.html)
- **Purpose**: Models tab content
- **Properties**:
  - `settings_dialog` (SettingsDialog) - Reference to parent SettingsDialog (which has the config object and models_list)
  - `selected_model` (string?) - Currently selected model name
  - `search_filter` (string) - Current search filter text
  - `models` (Gee.Map<string, Call.Options>) - Copy of model_options with all models. Key format: "connection#model_name" (e.g., "http://127.0.0.1:11434/api#llama3"). Built on load with all models, merged with config values. Only models with user-set options are saved back to config (using model name only as key in Config2.model_options).
- **Methods**:
  - `render_models()` - Render models list, grouped by connection. Builds models map with all models on load using composite keys ("connection#model_name"). Models are sorted alphabetically by name within each connection group. Options/settings are rendered lazily when a model is expanded (not all at once). Saves on blur/unblur or focus events (when user finishes editing a field). Uses widgets that restrict invalid input based on option value limitations. Only saves models to config where user has set options (using model name only as key in Config2.model_options).
  - `filter_models(string search_text)` - Filter model list by search text using show/hide visibility (does not remove models from list)
  - `expand_model(string model_name)` - Expand a model's settings panel and collapse any currently expanded model
  - Note: Models list is managed by SettingsDialog (models_list property) or ModelManager

**4. ToolsPage**
- **Location**: `ollmchat/Settings/ToolsPage.vala`
- **Status**: ⏳ **NOT YET IMPLEMENTED**
- **UI Framework**: Uses `Adw.PreferencesPage` with:
  - Horizontal box at top containing `Adw.SearchBar` (no action buttons - tools auto-discovered)
  - `Adw.PreferencesGroup` wrapping `Adw.BoxedList` for tool list
  - Tool rows use `Adw.ExpanderRow` for expandable configuration panels
  - Settings widgets added to `Adw.ExpanderRow` via `add_row()` method
  - See [Adw.ExpanderRow documentation](https://valadoc.org/libadwaita-1/Adw.ExpanderRow.html)
- **Purpose**: Tools tab content
- **Properties**:
  - `settings_dialog` (SettingsDialog) - Reference to parent SettingsDialog (which has the config object)
  - `selected_tool` (string?) - Currently selected tool name
  - `selected_config` (string?) - Currently selected config name (format: `tool_name.config_name`)
- **Methods**:
  - `get_tool_configs(string tool_name)` - Get all configurations for a tool (returns list of config keys)
  - `configure_tool(string tool_name, string? config_name)` - Configure tool settings (config_name null = add new)
  - `add_tool_config(string tool_name, string config_name, string display_name)` - Add new configuration for tool
  - `remove_tool_config(string tool_name, string config_name)` - Remove configuration for tool
  - `get_tool_config_ui(Tool tool, string config_name)` - Generate dynamic UI for tool-specific config
  - Note: Tools are auto-discovered from Client registry, no refresh needed

**5. ToolConfig (Base Tool Configuration Class)**
- **Location**: `libollmchat/Settings/ToolConfig.vala` (optional base class)
- **Purpose**: Base configuration class for tools (data class, not UI)
- **Properties**:
  - `enabled` (bool) - Whether tool is enabled
  - `model_usage` (Settings.ModelUsage?) - Model configuration for tool
- **Note**: Tools can extend this or create their own config classes, registering with Config2

**6. ModelUsageEditor (Reusable UI Component)**
- **Location**: `ollmchat/Settings/ModelUsageEditor.vala`
- **Status**: ❌ **REMOVED** - Options editing is now integrated directly into ModelsPage, no separate component needed.
- **UI Framework**: Uses `Adw.PreferencesGroup` with `Adw.ComboRow` and `Adw.EntryRow`
- **Purpose**: Reusable UI component for editing ModelUsage
- **Properties**:
  - `model_usage` (Settings.ModelUsage) - Model usage to edit
  - `available_connections` (Gee.Map<string, Settings.Connection>) - Available connections
- **Methods**:
  - `update_connection_dropdown()` - Update connection dropdown
  - `update_model_dropdown(string connection_url)` - Update model dropdown for connection
  - `update_options_editor()` - Update Call.Options editor

---

## Potential Issues and Solutions

### Issue 1: Model List Synchronization
**Problem**: Model list is dynamic (fetched from connections), but model options are stored in Config2. Need to handle cases where:
- Model exists in Config2.model_options but not in any connection (stale config)
- Model exists in connection but not in Config2.model_options (no user-set options yet)

**Solution**:
- Model list shows all models from all connections (union)
- ModelsPage builds temporary `models` map with all models from connections, merged with Config2.model_options values
- Options are edited inline when model is expanded - no separate "Add Model Options" action needed
- Only models with user-set options are saved to Config2.model_options (using model name as key)
- Stale entries in Config2.model_options (models no longer in any connection) are ignored in UI but preserved in config

### Issue 2: Tool Configuration Discovery
**Problem**: Tools need to register their configuration schema, but we need UI to discover what's configurable.

**Solution**:
- Tools register their configuration types with Config2 using `Config2.register_type(key, gtype)`
- Tool config classes must implement `Json.Serializable` for persistence
- ToolsPage queries Client or tool registry to discover available tools
- Tool-specific configs are stored in Config2.usage map with registered keys
- UI generation for tool configs is tool-specific (may need custom UI per tool)

### Issue 3: Connection Validation
**Status**: ✅ **RESOLVED** - Connection validation is implemented in ConnectionsPage with Verify button.

**Implementation**:
- Verify button tests connection by creating temporary Client and calling `version()` endpoint
- On success: saves connection to config immediately and removes `oc-settings-unverified` CSS class
- On failure: shows error message
- ConnectionAdd dialog also validates connections before adding them

### Issue 4: Tool Model Configuration vs. Global Model Options
**Problem**: Tools have their own model configuration (ModelUsage in Config2.usage), but models also have global options (Config2.model_options). Which takes precedence?

**Solution**:
- Tool model configuration (ModelUsage) is separate from global model options
- Tool configs (like ocvector) use ModelUsage in Config2.usage map for tool-specific operations (e.g., embeddings, analysis)
- Global model options (Config2.model_options) are per-model option overrides for chat operations
- Clear separation: tool configs in `usage` map, model options in `model_options` map
- When a tool needs model options, it uses its own ModelUsage.options, not Config2.model_options

---

## File Organization

All UI files should be in `ollmchat/Settings/` subfolder (using libadw):

```
ollmchat/
├── Settings/
│   ├── SettingsDialog.vala          # ✅ Main dialog window (Adw.PreferencesDialog)
│   ├── ConnectionsPage.vala          # ✅ Connections tab (Adw.PreferencesPage)
│   ├── ConnectionAdd.vala            # ✅ Dialog for adding/editing connections
│   ├── ModelsPage.vala               # ⏳ Models tab (Adw.PreferencesPage) - NOT YET IMPLEMENTED
│   ├── ToolsPage.vala                # ⏳ Tools tab (Adw.PreferencesPage) - NOT YET IMPLEMENTED
│   └── ModelUsageEditor.vala         # ⏳ Reusable ModelUsage editor - NOT YET IMPLEMENTED
```

Tool configuration classes (data classes, not UI) go in `libollmchat/Settings/`:

```
libollmchat/
├── Settings/
│   ├── ToolConfig.vala               # Optional base tool config class (data class)
│   └── ... (other Settings classes)
```

**Note**: UI files use libadw (Adwaita) for GTK4 components. Configuration classes are data classes that implement `Json.Serializable`.

---

## Data Flow

1. **Load**: Caller loads config before creating SettingsDialog (e.g., `Config2.from_file()`)
2. **Create**: SettingsDialog is created with config object passed in
3. **Edit**: User edits settings in UI (connections, models, tools)
4. **Close**: When dialog closes, `on_close()` is called which calls `config.save()` to persist changes
5. **Refresh Models**: SettingsDialog emits `refresh_models()` signal when models need refreshing
   - Main window can connect to this signal to refresh models from connections
   - SettingsDialog updates its `models_list` property when models are refreshed
6. **Note**: SettingsDialog is only responsible for displaying and changing configuration, not loading/saving

---

## Integration Points

- **Config2**: All settings stored in Config2 (connections, model_options, external_configs)
  - Tool configs use composite keys: `tool_name.config_name` (e.g., `vector.embed`, `vector.analysis`)
- **Client**: Used for fetching models, testing connections
- **Tool Registry**: Access via `Client.tools` or global registry
- **ModelUsage**: Used for tool model configuration (each tool config can have its own ModelUsage)
- **Call.Options**: Used for model options and tool model options
- **Multiple Configs per Tool**: Tools can register multiple configurations, each with a unique `tool_name.config_name` key in `external_configs`

