# 1.3.2. Configuration Interface

## Overview

The user permission dialog provides a unified interface for managing connections, models, tools, and agents. This dialog will be implemented in the `ollmchat` application directory under `Settings/` subfolder using libadw (Adwaita) for GTK4 UI components.

## Status

✅ **PARTIALLY COMPLETE** - SettingsDialog and ConnectionsPage implemented. ModelsPage and ToolsPage not yet implemented.

## Related Plans

- **1.3** - Multiple Client Configuration
- **1.3.1** - Configuration Classes
- **1.4** - Client Configuration Setup
- **1.5** - Model List Management
- **1.6** - Tools Management

## Dialog Tree Structure

```
SettingsDialog (Main Window)
│
├── Tab: Connections
│   ├── Horizontal Box (Action Bar)
│   │   └── [Add Connection] Button
│   │
│   ├── Adw.PreferencesGroup (in Adw.BoxedList)
│   │   └── Connection List (Adw.BoxedList)
│   │       ├── [Connection 1] (Adw.ExpanderRow) [Edit] [Remove]
│   │       ├── [Connection 2] (Adw.ExpanderRow) [Edit] [Remove]
│   │       └── [Connection N] (Adw.ExpanderRow) [Edit] [Remove]
│   │       └── (When only one connection: [Edit] only - Remove button disabled/hidden)
│   │
│   └── Connection Details Panel (Adw.ExpanderRow - when expanded)
│       ├── Name: [text entry]
│       ├── URL: [text entry]
│       ├── API Key: [text entry (password)]
│       ├── Default: [checkbox]
│       └── Action Buttons (at bottom, last row)
│           ├── [Remove] Button (red, left) - Only shown if more than one connection exists
│           └── [Verify] Button (green/blue, right) - Tests connection and saves to config
│
├── Tab: Models
│   ├── Horizontal Box (Action Bar)
│   │   ├── Adw.SearchBar
│   │   │   └── [Search Models] - Filter models by name
│   │   ├── [Add Model] Button (placeholder - not implemented)
│   │   └── [Refresh] Button - Refresh model list from all connections
│   │
│   ├── Adw.PreferencesGroup (in Adw.BoxedList)
│   │   └── Model List (Adw.BoxedList, grouped by connection)
│   │       ├── Connection 1: "Local Ollama" (Adw.ExpanderRow)
│   │       │   ├── [Model 1] [Settings ▼] (Adw.ExpanderRow)
│   │       │   ├── [Model 2] [Settings ▼] (Adw.ExpanderRow)
│   │       │   └── [Model N] [Settings ▼] (Adw.ExpanderRow)
│   │       ├── Connection 2: "Remote Server" (Adw.ExpanderRow)
│   │       │   ├── [Model 1] [Settings ▼] (Adw.ExpanderRow)
│   │       │   └── [Model 2] [Settings ▼] (Adw.ExpanderRow)
│   │       └── Connection N: "OpenAI" (Adw.ExpanderRow)
│   │           └── [Model 1] [Settings ▼] (Adw.ExpanderRow)
│   │
│   └── Model Settings Panel (Adw.ExpanderRow - when expanded)
│       ├── Connection: [dropdown]
│       ├── Model Name: [text entry]
│       └── Options: [Call.Options editor]
│           ├── Temperature: [spin button]
│           ├── Top P: [spin button]
│           ├── Top K: [spin button]
│           └── ... (other Call.Options fields)
│
├── Tab: Tools
│   ├── Horizontal Box (Action Bar)
│   │   └── Adw.SearchBar
│   │       └── [Search Tools] - Filter tools by name
│   │
│   ├── Adw.PreferencesGroup (in Adw.BoxedList)
│   │   └── Tool List (Adw.BoxedList)
│   │       ├── [Tool 1] (Adw.ExpanderRow) [Configure ▼]
│   │       │   ├── [Config 1: Embedding Settings] [Edit]
│   │       │   ├── [Config 2: Analysis Settings] [Edit]
│   │       │   └── [Add Config] Button
│   │       ├── [Tool 2] (Adw.ExpanderRow) [Configure ▼]
│   │       └── [Tool N] (Adw.ExpanderRow) [Configure ▼]
│   │
│   └── Tool Configuration Panel (Adw.ExpanderRow - when expanded)
│       ├── Config Name: [text entry] (e.g., "embed", "analysis")
│       ├── Config Display Name: [text entry] (e.g., "Embedding Settings", "Analysis Settings")
│       ├── Enabled: [checkbox]
│       ├── Model Configuration: [ModelUsage editor]
│       │   ├── Connection: [dropdown]
│       │   ├── Model: [dropdown]
│       │   └── Options: [Call.Options editor]
│       └── Tool-Specific Settings: [dynamic based on tool type]
│           └── (varies by tool - e.g., vector.embed has vector_db_path, etc.)
│
└── Tab: Agents
    └── [TODO - Not implemented yet]
```

## Detailed Component Descriptions

### Connections Tab

**Purpose**: Manage server connections (add, remove, edit connection details).

**Components**:
- **Horizontal Box (Action Bar)**: Top horizontal container with action buttons
  - **Add Connection Button**: Opens connection details panel in "add" mode
- **Adw.PreferencesGroup**: Contains the connection list
  - Wraps `Adw.BoxedList` for consistent styling
- **Connection List**: Uses `Adw.BoxedList` to display all connections from `Config2.connections` map
  - Each connection uses `Adw.ExpanderRow` to show/edit connection details inline
  - Each connection shows: name, URL, default indicator (when collapsed)
  - When expanded: Shows editable form fields with Remove and Verify buttons at bottom
  - Editing is inline - no separate edit mode needed
- **Connection Details Panel**: Uses `Adw.ExpanderRow` - inline editable form for connection properties
  - Settings widgets are added as children to the `Adw.ExpanderRow` using `add_row()`
  - Name: Connection alias/name (text entry)
  - URL: Server URL (e.g., `http://127.0.0.1:11434/api`) (text entry)
  - API Key: Optional API key (password field)
  - Default: Checkbox to mark as default connection
  - **Unverified State**: When connection details are edited, add CSS class `oc-settings-unverified` to change background color
  - **Action Buttons** (shown at bottom, as last row in expanded panel):
    - **Remove Button** (red, left side): Only shown when expanded and if more than one connection exists
      - Removes connection from `config.connections` map
      - Validation: Cannot remove if it's the last connection
    - **Verify Button** (green/blue, right side): Tests connection using same code as BootstrapDialog
      - Creates temporary Client and calls `version()` endpoint to test
      - On success: Saves connection to `config` immediately (calls `config.save()`)
      - On failure: Shows error message
      - After verification: Removes `oc-settings-unverified` class

**Validation**:
- Cannot remove all connections (at least one must exist) - Remove button only shown when more than one connection exists
- URL must be valid format (validated when Verify button is clicked)
- Name must be unique (or use URL as key)
- Connection is saved to config immediately after successful verification (no separate save step needed)

**Data Source**: `Config2.connections` (Gee.Map<string, Settings.Connection>)

---

### Models Tab

**Purpose**: List available models, add new models, configure model-specific options.

**Components**:
- **Horizontal Box (Action Bar)**: Top horizontal container with search and action buttons
  - **Adw.SearchBar**: Search bar for filtering models
    - Filters model list in real-time as user types
    - Searches across all connections
    - Hides connection groups with no matching models
  - **Add Model Button**: Placeholder button for future model discovery feature (not implemented yet)
  - **Refresh Button**: Refresh model list from all connections
    - Fetches latest models from all configured connections
    - Updates the model list dynamically
- **Adw.PreferencesGroup**: Contains the model list
  - Wraps `Adw.BoxedList` for consistent styling
- **Model List**: Uses `Adw.BoxedList` to display models grouped by connection
  - Models are organized under their connection name (e.g., "Local Ollama", "Remote Server")
  - Each connection group uses `Adw.ExpanderRow` to show/hide models for that connection
  - Connection name is shown as the title of the `Adw.ExpanderRow`
  - Model rows are added as children to the connection's `Adw.ExpanderRow` using `add_row()`
  - Each model row also uses `Adw.ExpanderRow` to show/edit model settings (nested expandable rows)
  - Shows: model name, connection name (implicit from grouping)
- **Model Settings Panel**: Uses `Adw.ExpanderRow` - when model row is expanded
  - Settings widgets are added as children to the `Adw.ExpanderRow` using `add_row()`
  - Connection: Dropdown of available connections
  - Model Name: Text entry (read-only or editable depending on context)
  - Options: Full `Call.Options` editor for per-model overrides
    - Temperature, Top P, Top K, Num Ctx, etc.

**Data Sources**:
- Model list: Fetched from `Client.models()` for each connection
- Model options: `Config2.model_options` (Gee.Map<string, Call.Options>)

**Note**: Model list is dynamic (fetched from connections), while model options are stored in Config2.

**Ideas for Future Enhancement**:
- **Model Notes**: Add a notes field for each model to allow users to make personal notes about models (e.g., "Good for code generation", "Slow but accurate", "Use for creative writing"). This could be stored in `Config2.model_metadata` or a separate `model_notes` map.
- **Expected Tokens/Second (t/s)**: Track expected performance metrics for each model. This could be:
  - Manually set by the user
  - Automatically updated from actual usage statistics (track tokens/second during API calls)
  - Used for estimating response times and selecting appropriate models for different tasks
  - Stored in `Config2.model_metadata` alongside notes

---

### Tools Tab

**Purpose**: Configure tools, set up models for tools, manage tool-specific settings.

**Components**:
- **Horizontal Box (Action Bar)**: Top horizontal container with search
  - **Adw.SearchBar**: Search bar for filtering tools
    - Filters tool list in real-time as user types
    - Searches by tool name and description
  - (No action buttons - tools are auto-discovered from registry)
- **Adw.PreferencesGroup**: Contains the tool list
  - Wraps `Adw.BoxedList` for consistent styling
- **Tool List**: Uses `Adw.BoxedList` to display all registered tools
  - Shows: tool name, enabled status, description
  - Each tool uses `Adw.ExpanderRow` to show/edit tool configurations
  - Each tool can have multiple configurations (e.g., `vector.embed`, `vector.analysis`)
- **Tool Configuration List**: When tool row is expanded
  - Lists all configurations for the tool (e.g., "Embedding Settings", "Analysis Settings")
  - Each config shows: config name, display name, enabled status
  - Actions: Edit config, Remove config, Add new config
- **Tool Configuration Panel**: Uses `Adw.ExpanderRow` - when a specific config is selected
  - Settings widgets are added as children to the `Adw.ExpanderRow` using `add_row()`
  - Config Name: Text entry (e.g., "embed", "analysis") - used as key suffix
  - Config Display Name: Text entry (e.g., "Embedding Settings", "Analysis Settings") - shown in UI
  - Enabled: Checkbox to enable/disable this specific configuration
  - Model Configuration: `ModelUsage` editor (connection, model, options)
    - Uses the same `ModelUsage` class as ocvector
    - Connection dropdown: References `Config2.connections`
    - Model dropdown: Models available from selected connection
    - Options: `Call.Options` editor for tool-specific model options
  - Tool-Specific Settings: Dynamic UI based on tool type
    - Uses tool registration system to discover configurable properties
    - Each tool can register its configuration schema via `register_type()` in Config2
    - Example: `vector.embed` might have `vector_db_path`, `index_settings`, etc.

**Data Sources**:
- Tool registry: `Client.tools` (Gee.HashMap<string, Tool>)
- Tool configurations: `Config2.external_configs` (via registered types)
  - Tools register their config type with Config2: `config2.register_type("vector", typeof(ToolConfig))`
  - Tool configs stored with composite keys: `external_configs["vector.embed"]` → ToolConfig object
  - Multiple configs per tool: `vector.embed`, `vector.analysis`, etc.

**Tool Registration Pattern**:
- Tools register their configuration class with Config2 using `register_type(tool_name, typeof(ToolConfig))`
- Tool configs stored in `Config2.external_configs` map with composite keys: `tool_name.config_name`
- Examples:
  - `vector.embed` → Embedding settings (for semantic search)
  - `vector.analysis` → Analysis settings (for semantic search)
  - `codebase_search.main` → Main codebase search configuration
- Tool config classes should implement `Json.Serializable`
- Tool config classes can contain `ModelUsage` for model configuration
- Each tool can have multiple configurations, each with its own key in the format `tool_name.config_name`

---

### Agents Tab

**Purpose**: Manage agent configurations (future feature).

**Status**: ⏳ **TODO** - Not implemented yet. Placeholder tab for future agent management.

---

## Implementation Considerations

### UI Files Needed (using libadw)

**Note**: These are UI files (not configuration classes) that use libadw (Adwaita) for GTK4 UI components.

**Layout Components**:
- **Adw.PreferencesDialog**: Main dialog window uses `Adw.PreferencesDialog` (not `Adw.Dialog` or `Adw.Window`)
- **Adw.BoxedList**: All lists (connections, models, tools) use `Adw.BoxedList` for consistent styling and layout
- **Adw.PreferencesGroup**: Wraps `Adw.BoxedList` to provide group headers and consistent spacing
- **Adw.ExpanderRow**: All expandable panels (connection details, model settings, tool configurations) use [`Adw.ExpanderRow`](https://valadoc.org/libadwaita-1/Adw.ExpanderRow.html). Settings widgets are added as children using the `add_row()` method. Provides built-in expand/collapse functionality with a visual indicator (▼ arrow)
- **Adw.SearchBar**: Used for search functionality in Models and Tools tabs
- **Horizontal Box (Action Bar)**: Top horizontal container in each tab containing search bar and action buttons (Add, Refresh, etc.)
  - Uses `Gtk.Box` with horizontal orientation
  - Contains both the search bar and action buttons in one container
- **BootstrapDialog**: Used for adding new connections (reusable dialog similar to initial bootstrap)

**Model Management**:
- **ModelManager** (potential new class in `libollmchat/`): Similar to liststore wrappers, can contain extra model information
  - May be needed to manage model list with additional metadata (notes, tokens/second, etc.)
  - If created, SettingsDialog would use ModelManager instead of simple `Gee.List<ModelInfo>`
  - Otherwise, SettingsDialog maintains `models_list` property directly

**1. SettingsDialog (Main Dialog Window)**
- **Location**: `ollmchat/Settings/SettingsDialog.vala`
- **UI Framework**: Uses `Adw.PreferencesDialog` with `Adw.ViewStack` for tabs
- **Purpose**: Main dialog window with tabbed interface for displaying and changing configuration
- **Properties**:
  - `config` (Settings.Config2) - Reference to configuration object (contains `connections` map)
  - // `models_list` (Gee.List<ModelInfo>?) - List of available models from all connections (commented out until model tab is added)
  - // `model_manager` (ModelManager?) - Optional ModelManager for managing model list (if created) (commented out until model tab is added)
- **Signals**:
  - // `refresh_models()` - Emitted when models need to be refreshed (main window can connect to this) (commented out until model tab is added)
- **Methods**:
  - `on_close()` - Called when dialog closes, calls `config.save()` to persist changes
  - Note: This class is only responsible for displaying and changing configuration, not loading/saving
  - Loading is done by the caller before creating the dialog
  - Saving is done automatically on close
  - Note: Client instances are not created by this class - that's the responsibility of the caller/main window

**2. ConnectionsPage**
- **Location**: `ollmchat/Settings/ConnectionsPage.vala`
- **Status**: ✅ **IMPLEMENTED** - Connections tab working with add/edit/remove functionality. Uses ConnectionAdd dialog for adding connections.
- **UI Framework**: Uses `Adw.PreferencesPage` with:
  - Horizontal box at top (Add Connection button)
  - `Adw.PreferencesGroup` wrapping `Adw.BoxedList` for connection list
  - `Adw.ExpanderRow` for each connection (expandable connection details panels)
  - Settings widgets added to `Adw.ExpanderRow` via `add_row()` method
  - Remove and Verify buttons shown at bottom of expanded connection details
  - See [Adw.ExpanderRow documentation](https://valadoc.org/libadwaita-1/Adw.ExpanderRow.html)
- **Purpose**: Connections tab content
- **Properties**:
  - `settings_dialog` (SettingsDialog) - Reference to parent SettingsDialog (which has the config object)
- **Methods**:
  - `add_connection()` - Opens `BootstrapDialog` for adding new connection
  - `on_connection_field_changed()` - Called when any connection field is edited, adds `oc-settings-unverified` CSS class
  - `verify_connection(string url)` - Tests connection (same code as BootstrapDialog) and saves to config on success
  - `remove_connection(string url)` - Removes connection from `config.connections` map and updates visibility of Remove buttons (hides if only one connection left)
  - `render_connections()` - Creates UI entries from `config.connections` map
    - Does initial render when page is created
    - Can be called after connections are added/removed to update the UI
    - Updates Remove button visibility based on number of connections
  - Note: Editing is inline - no separate edit/update methods needed

**3. ModelsPage**
- **Location**: `ollmchat/Settings/ModelsPage.vala`
- **Status**: ⏳ **NOT YET IMPLEMENTED**
- **UI Framework**: Uses `Adw.PreferencesPage` with:
  - Horizontal box at top containing `Adw.SearchBar`, Add Model, and Refresh buttons
  - `Adw.PreferencesGroup` wrapping `Adw.BoxedList` for model list
  - Connection groups use `Adw.ExpanderRow` to show/hide models
  - Model rows use `Adw.ExpanderRow` for expandable model settings panels (nested)
  - Settings widgets added to `Adw.ExpanderRow` via `add_row()` method
  - See [Adw.ExpanderRow documentation](https://valadoc.org/libadwaita-1/Adw.ExpanderRow.html)
- **Purpose**: Models tab content
- **Properties**:
  - `settings_dialog` (SettingsDialog) - Reference to parent SettingsDialog (which has the config object and models_list)
  - `selected_model` (string?) - Currently selected model name
  - `search_filter` (string) - Current search filter text
- **Methods**:
  - `filter_models(string search_text)` - Filter model list by search text (updates UI)
  - `group_models_by_connection()` - Organize models into groups by connection
  - `edit_model_options(string model_name)` - Edit model-specific options
  - `add_model_placeholder()` - Placeholder UI for future model discovery
  - Note: Models list is managed by SettingsDialog (models_list property) or ModelManager

**4. ToolsPage**
- **Location**: `ollmchat/Settings/ToolsPage.vala`
- **Status**: ⏳ **NOT YET IMPLEMENTED**
- **UI Framework**: Uses `Adw.PreferencesPage` with:
  - Horizontal box at top containing `Adw.SearchBar` (no action buttons - tools auto-discovered)
  - `Adw.PreferencesGroup` wrapping `Adw.BoxedList` for tool list
  - Tool rows use `Adw.ExpanderRow` for expandable configuration panels
  - Settings widgets added to `Adw.ExpanderRow` via `add_row()` method
  - See [Adw.ExpanderRow documentation](https://valadoc.org/libadwaita-1/Adw.ExpanderRow.html)
- **Purpose**: Tools tab content
- **Properties**:
  - `settings_dialog` (SettingsDialog) - Reference to parent SettingsDialog (which has the config object)
  - `selected_tool` (string?) - Currently selected tool name
  - `selected_config` (string?) - Currently selected config name (format: `tool_name.config_name`)
- **Methods**:
  - `get_tool_configs(string tool_name)` - Get all configurations for a tool (returns list of config keys)
  - `configure_tool(string tool_name, string? config_name)` - Configure tool settings (config_name null = add new)
  - `add_tool_config(string tool_name, string config_name, string display_name)` - Add new configuration for tool
  - `remove_tool_config(string tool_name, string config_name)` - Remove configuration for tool
  - `get_tool_config_ui(Tool tool, string config_name)` - Generate dynamic UI for tool-specific config
  - Note: Tools are auto-discovered from Client registry, no refresh needed

**5. ToolConfig (Base Tool Configuration Class)**
- **Location**: `libollmchat/Settings/ToolConfig.vala` (optional base class)
- **Purpose**: Base configuration class for tools (data class, not UI)
- **Properties**:
  - `enabled` (bool) - Whether tool is enabled
  - `model_usage` (Settings.ModelUsage?) - Model configuration for tool
- **Note**: Tools can extend this or create their own config classes, registering with Config2

**6. ModelUsageEditor (Reusable UI Component)**
- **Location**: `ollmchat/Settings/ModelUsageEditor.vala`
- **Status**: ⏳ **NOT YET IMPLEMENTED**
- **UI Framework**: Uses `Adw.PreferencesGroup` with `Adw.ComboRow` and `Adw.EntryRow`
- **Purpose**: Reusable UI component for editing ModelUsage
- **Properties**:
  - `model_usage` (Settings.ModelUsage) - Model usage to edit
  - `available_connections` (Gee.Map<string, Settings.Connection>) - Available connections
- **Methods**:
  - `update_connection_dropdown()` - Update connection dropdown
  - `update_model_dropdown(string connection_url)` - Update model dropdown for connection
  - `update_options_editor()` - Update Call.Options editor

**7. OptionsEditor (Reusable UI Component)**
- **Location**: `ollmchat/Settings/OptionsEditor.vala`
- **Status**: ⏳ **NOT YET IMPLEMENTED**
- **UI Framework**: Uses `Adw.PreferencesGroup` with `Adw.SpinRow` and `Adw.EntryRow`
- **Purpose**: Reusable UI component for editing Call.Options
- **Properties**:
  - `options` (Call.Options) - Options to edit
- **Methods**:
  - `create_options_ui()` - Generate UI for all Call.Options fields

---

## Potential Issues and Solutions

### Issue 1: Model List Synchronization
**Problem**: Model list is dynamic (fetched from connections), but model options are stored in Config2. Need to handle cases where:
- Model exists in Config2.options but not in any connection
- Model exists in connection but not in Config2.options

**Solution**:
- Model list shows all models from all connections (union)
- Model options editor only shows models that exist in Config2.options
- Add "Add Model Options" action to create options entry for a model
- Show indicator for models that have custom options vs. default

### Issue 2: Tool Configuration Discovery
**Problem**: Tools need to register their configuration schema, but we need UI to discover what's configurable.

**Solution**:
- Tools implement a `get_config_schema()` method (or interface) that returns configurable properties
- ToolsPage uses reflection or schema to generate dynamic UI
- Tool config classes must implement `Json.Serializable` for persistence
- Use `register_type()` in Config2 to handle deserialization

### Issue 3: Connection Validation
**Problem**: Need to validate connections before allowing them to be saved (test connectivity, verify API key, etc.).

**Solution**:
- Add "Test Connection" button in connection details panel
- Async validation: test connection by calling `Client.models()` or similar lightweight endpoint
- Show validation status (success/error) before saving
- Optionally: validate on save and show error if invalid

### Issue 4: Model Options Inheritance
**Problem**: Models can have per-model options, but also need default options. How to handle inheritance?

**Solution**:
- Default options stored in `Config2.model_options["default"]`
- Per-model options override defaults
- OptionsEditor shows "Use Default" checkbox to clear per-model override
- When editing, show both default and override values

### Issue 5: Tool Model Configuration vs. Global Model Options
**Problem**: Tools have their own model configuration (ModelUsage), but models also have global options. Which takes precedence?

**Solution**:
- Tool model configuration (ModelUsage) is separate from global model options
- Tool config uses its own connection/model/options (for tool-specific operations like embeddings)
- Global model options are for chat operations
- Clear separation: tool configs in `external_configs`, model options in `model_options`

### Issue 6: Multiple Clients for Model Fetching
**Problem**: Need to fetch models from multiple connections, but creating Client instances for each connection is expensive.

**Solution**:
- SettingsDialog maintains a `client_registry` (Gee.Map<string, Client>)
- Lazy initialization: create Client only when needed
- Cache model lists per connection with TTL
- Refresh models on connection tab activation or manual refresh button

### Issue 7: Tool Registration Timing
**Problem**: Tools are registered in Window.vala during initialization, but SettingsDialog needs access to tool registry.

**Solution**:
- Pass tool registry to SettingsDialog (or access via Client)
- Tools register themselves with a global registry or via Client
- SettingsDialog queries Client.tools or global registry
- Consider: tool registry as singleton or passed as dependency

---

## File Organization

All UI files should be in `ollmchat/Settings/` subfolder (using libadw):

```
ollmchat/
├── Settings/
│   ├── SettingsDialog.vala          # ✅ Main dialog window (Adw.PreferencesDialog)
│   ├── ConnectionsPage.vala          # ✅ Connections tab (Adw.PreferencesPage)
│   ├── ConnectionAdd.vala            # ✅ Dialog for adding/editing connections
│   ├── ModelsPage.vala               # ⏳ Models tab (Adw.PreferencesPage) - NOT YET IMPLEMENTED
│   ├── ToolsPage.vala                # ⏳ Tools tab (Adw.PreferencesPage) - NOT YET IMPLEMENTED
│   ├── ModelUsageEditor.vala         # ⏳ Reusable ModelUsage editor - NOT YET IMPLEMENTED
│   └── OptionsEditor.vala            # ⏳ Reusable Call.Options editor - NOT YET IMPLEMENTED
```

Tool configuration classes (data classes, not UI) go in `libollmchat/Settings/`:

```
libollmchat/
├── Settings/
│   ├── ToolConfig.vala               # Optional base tool config class (data class)
│   └── ... (other Settings classes)
```

**Note**: UI files use libadw (Adwaita) for GTK4 components. Configuration classes are data classes that implement `Json.Serializable`.

---

## Data Flow

1. **Load**: Caller loads config before creating SettingsDialog (e.g., `Config2.from_file()`)
2. **Create**: SettingsDialog is created with config object passed in
3. **Edit**: User edits settings in UI (connections, models, tools)
4. **Close**: When dialog closes, `on_close()` is called which calls `config.save()` to persist changes
5. **Refresh Models**: SettingsDialog emits `refresh_models()` signal when models need refreshing
   - Main window can connect to this signal to refresh models from connections
   - SettingsDialog updates its `models_list` property when models are refreshed
6. **Note**: SettingsDialog is only responsible for displaying and changing configuration, not loading/saving

---

## Integration Points

- **Config2**: All settings stored in Config2 (connections, model_options, external_configs)
  - Tool configs use composite keys: `tool_name.config_name` (e.g., `vector.embed`, `vector.analysis`)
- **Client**: Used for fetching models, testing connections
- **Tool Registry**: Access via `Client.tools` or global registry
- **ModelUsage**: Used for tool model configuration (each tool config can have its own ModelUsage)
- **Call.Options**: Used for model options and tool model options
- **Multiple Configs per Tool**: Tools can register multiple configurations, each with a unique `tool_name.config_name` key in `external_configs`

