# 3.8.5. Approvals Widget Integration

## Overview

Modify the Approvals widget to be a horizontal box containing the existing next/popover button, approve button, and reject button. This consolidates all approval-related functionality into a single widget that can monitor list changes and update all buttons accordingly.

## Status

‚è≥ **TODO** - To be implemented.

## Prerequisites

- Phase 3.8.3 must be completed (Approvals widget with popover)

## Goals

1. Convert Approvals widget from Gtk.Button to Gtk.Box (horizontal)
2. Keep existing popover button functionality (task-due icon, popover on mouseover)
3. Add approve button to the box
4. Add reject button to the box
5. Consolidate visibility management in one place
6. Monitor ReviewFiles changes and update all buttons accordingly

## Implementation Details

### Files to Modify

- `liboccoder/Approvals.vala` - Convert to horizontal box with integrated buttons

### Widget Structure

**Current Structure** (3.8.3):
- `Approvals` extends `Gtk.Button`
- Contains internal popover with file list
- Shows task-due icon

**New Structure** (3.8.5):
- `Approvals` extends `Gtk.Box` (horizontal orientation)
- Contains three buttons:
  1. **Next/Popover Button** - Existing functionality (task-due icon, popover on mouseover)
  2. **Approve Button** - Approve selected file
  3. **Reject Button** - Revert selected file

### Button Details

1. **Next/Popover Button**:
   - Location: First button in the box
   - Icon: "task-due" (existing)
   - Functionality: Existing popover on mouseover, file selection
   - Visibility: Handled by Approvals widget (shows/hides based on `review_files.get_n_items()`)
   - Tooltip: Can show "X more files to approve" (optional)

2. **Approve Button**:
   - Location: Second button in the box
   - CSS Classes: `oc-approve` and `suggested-action`
   - Visibility: Only visible when a file in ReviewFiles is selected
   - Action: Approve selected file and all FileHistory items
   - Behavior: Disappears when file is approved or no file selected

3. **Reject Button**:
   - Location: Third button in the box
   - CSS Class: `oc-reject`
   - Icon: "edit-undo" or similar revert icon
   - Tooltip: "Revert file to previous version"
   - Visibility: Only visible when a file in ReviewFiles is selected AND has FileHistory records with backup_path
   - Action: Restore file from FileHistory backup and update database
   - Behavior: Disappears when no file selected or file has no backup to restore from

### Class Structure

```vala
namespace OLLMcoder
{
    /**
     * Horizontal box widget containing buttons for file approval workflow.
     * 
     * Contains:
     * - Next/popover button (existing functionality)
     * - Approve button
     * - Reject button
     * 
     * Monitors ReviewFiles and updates button visibility accordingly.
     */
    public class Approvals : Gtk.Box
    {
        private OLLMfiles.ProjectManager project_manager;
        
        // Buttons
        private Gtk.Button next_button;  // Existing popover button functionality
        private Gtk.Button approve_button;
        private Gtk.Button reject_button;
        
        // Existing popover functionality (moved from button to next_button)
        private Gtk.Popover popover;
        private Gtk.ListView list_view;
        private Gtk.SingleSelection selection;
        private List.SortedList<OLLMfiles.File> sorted_model;
        private Gtk.EventControllerMotion button_motion;
        private Gtk.EventControllerMotion popover_motion;
        private bool blocking_selection_handler = false;
        private uint hide_timeout_id = 0;
        private uint cooldown_timeout_id = 0;
        private bool in_cooldown = false;
        private ulong? review_files_handler_id = null;
        
        /**
         * Currently selected file (or null).
         */
        private OLLMfiles.File? selected_file { get; set; default = null; }
        
        /**
         * Emitted when a file is selected/clicked.
         */
        public signal void file_selected(OLLMfiles.File file);
        
        // ... methods ...
    }
}
```

### Implementation Steps

1. **Convert Class Structure**:
   - Change `Approvals` from `extends Gtk.Button` to `extends Gtk.Box`
   - Set orientation to `Gtk.Orientation.HORIZONTAL`
   - Move existing button functionality to `next_button` (internal button)

2. **Create Next/Popover Button**:
   - Create `next_button` as `Gtk.Button` with "task-due" icon
   - Move all existing popover functionality from `this` (the button) to `next_button`
   - Set popover parent to `next_button` using `popover.set_parent(next_button)`
   - Move motion controllers to `next_button`
   - Append `next_button` to the box

3. **Create Approve Button**:
   - Create `approve_button` as `Gtk.Button`
   - Add CSS classes: `oc-approve` and `suggested-action`
   - Connect click handler to approve workflow
   - Append to box

4. **Create Reject Button**:
   - Create `reject_button` as `Gtk.Button` with "edit-undo" icon
   - Add CSS class: `oc-reject`
   - Connect click handler to revert workflow
   - Append to box

5. **Consolidate Visibility Management**:
   - Single method to update all button visibility
   - Monitor `review_files.items_changed` signal
   - Update button visibility based on:
     - ReviewFiles count (for next_button visibility)
     - Selected file (for approve_button visibility)
     - Selected file + FileHistory backup (for reject_button visibility)

### Approval Workflow

1. **Approve Button Clicked**:
   ```vala
   void on_approve_clicked() {
       var file = this.selected_file;
       if (file == null) {
           return;
       }
       
       // Approve file
       file.is_need_approval = false;
       file.saveToDB(this.project_manager.db, null, false);
       
       // Approve all FileHistory items for this file
       this.approve_file_history(file);
       
       // Update ReviewFiles (file will be removed)
       this.project_manager.active_project.review_files.update_from(
           this.project_manager.active_project.project_files
       );
       
       // Update button visibility
       this.update_button_visibility();
   }
   ```

2. **Reject Button Clicked**:
   ```vala
   void on_reject_clicked() {
       var file = this.selected_file;
       if (file == null) {
           return;
       }
       
       // Get FileHistory records for this file
       var db = this.project_manager.db;
       var history_records = new Gee.ArrayList<OLLMfiles.FileHistory>();
       try {
           yield OLLMfiles.FileHistory.query(db).select_async(
               "WHERE filebase_id = %lld AND backup_path != '' ORDER BY timestamp DESC LIMIT 1".printf(file.id),
               history_records
           );
       } catch (GLib.Error e) {
           GLib.warning("Failed to query FileHistory for revert: %s", e.message);
           return;
       }
       
       if (history_records.size == 0) {
           return;
       }
       
       // Get the most recent FileHistory record with backup
       var history = history_records[0];
       
       // Revert the file using FileHistory.revert() method
       try {
           yield history.revert(file);
           
           // Update ReviewFiles (file may be removed or updated)
           this.project_manager.active_project.review_files.update_from(
               this.project_manager.active_project.project_files
           );
           
           // Update button visibility
           this.update_button_visibility();
       } catch (GLib.Error e) {
           GLib.warning("Failed to revert file: %s", e.message);
       }
   }
   ```

3. **File Selected Signal Handler**:
   ```vala
   private void update_selected_file() {
       if (this.selection.selected == Gtk.INVALID_LIST_POSITION) {
           this.selected_file = null;
           this.update_button_visibility();
           return;
       }
       
       var file = this.sorted_model.get_item_typed(this.selection.selected);
       this.selected_file = file;
       this.file_selected(file);  // Emit signal
       this.update_button_visibility();
   }
   ```

### Button Visibility Management

```vala
private async void update_button_visibility() {
    var project = this.project_manager.active_project;
    if (project == null) {
        this.visible = false;
        return;
    }
    
    var count = project.review_files.get_n_items();
    
    // Next button visibility: based on ReviewFiles count
    this.next_button.visible = (count > 0);
    
    // Approve button visibility: based on selected file
    this.approve_button.visible = (this.selected_file != null);
    
    // Reject button visibility: based on selected file + FileHistory backup
    if (this.selected_file == null) {
        this.reject_button.visible = false;
    } else {
        // Check if file has FileHistory records with backup_path
        var db = this.project_manager.db;
        var history_records = new Gee.ArrayList<OLLMfiles.FileHistory>();
        try {
            yield OLLMfiles.FileHistory.query(db).select_async(
                "WHERE filebase_id = %lld AND backup_path != '' LIMIT 1".printf(this.selected_file.id),
                history_records
            );
        } catch (GLib.Error e) {
            GLib.warning("Failed to check FileHistory for reject button: %s", e.message);
            this.reject_button.visible = false;
            return;
        }
        
        this.reject_button.visible = (history_records.size > 0);
    }
    
    // Overall widget visibility: show if any button should be visible
    this.visible = (this.next_button.visible || this.approve_button.visible || this.reject_button.visible);
}
```

### FileHistory Approval

```vala
private void approve_file_history(File file) {
    // Query FileHistory table for this file_id
    var db = this.project_manager.db;
    var stmt = db.prepare("""
        UPDATE file_history 
        SET status = 1 
        WHERE filebase_id = ?
    """);
    stmt.bind_int64(1, file.id);
    stmt.step();
    stmt.reset();
}
```

### FileHistory Revert

Add revert method to FileHistory class (see 3.8.4 plan for details):

```vala
// In libocfiles/FileHistory.vala
public async void revert(OLLMfiles.File file) throws Error
{
    // Check if backup exists
    if (this.backup_path == "" || !GLib.FileUtils.test(this.backup_path, GLib.FileTest.EXISTS)) {
        throw new Error.FILE_NOT_FOUND("Backup file does not exist: %s".printf(this.backup_path));
    }
    
    // Check change type - cannot revert "added" files (no backup)
    if (this.change_type == "added") {
        throw new Error.INVALID_ARGUMENT("Cannot revert added files (no backup exists)");
    }
    
    // Get database from file's manager
    var db = file.manager.db;
    
    // Copy backup file back to original path
    var backup_file = GLib.File.new_for_path(this.backup_path);
    var target_file = GLib.File.new_for_path(this.path);
    
    // Create parent directory if it doesn't exist (for deleted files)
    var parent_dir = target_file.get_parent();
    if (parent_dir != null && !parent_dir.query_exists()) {
        parent_dir.make_directory_with_parents(null);
    }
    
    // Copy backup to original location (overwrites existing file)
    backup_file.copy(
        target_file,
        GLib.FileCopyFlags.OVERWRITE,
        null,
        null
    );
    
    // Update File object metadata
    file.last_modified = new GLib.DateTime.now_local().to_unix();
    
    // Save File object to database
    file.saveToDB(db, null, false);
    
    // Update FileHistory status to rejected (-1)
    this.status = -1;
    yield this.save_to_db();
    
    // Update file's is_need_approval flag (file may need re-approval after revert)
    file.is_need_approval = true;
    file.saveToDB(db, null, false);
}
```

### CSS Styling

Add CSS classes to buttons:

1. **Approve Button**:
   ```vala
   this.approve_button.add_css_class("oc-approve");
   this.approve_button.add_css_class("suggested-action");
   ```

2. **Reject Button**:
   ```vala
   this.reject_button.add_css_class("oc-reject");
   ```

**CSS Classes** (add to `resources/style.css`):

```css
/* Approve button - uses suggested-action for primary styling */
.oc-approve {
  /* No styling currently, class exists for potential future use */
}

/* Reject button - no styling currently */
.oc-reject {
  /* No styling currently, class exists for potential future use */
}
```

## Implementation Tasks

### Approvals Widget Refactoring
- [ ] Change `Approvals` from `extends Gtk.Button` to `extends Gtk.Box`
- [ ] Set orientation to `Gtk.Orientation.HORIZONTAL`
- [ ] Create `next_button` as internal `Gtk.Button` with "task-due" icon
- [ ] Move all existing popover functionality from `this` to `next_button`
- [ ] Move motion controllers from `this` to `next_button`
- [ ] Set popover parent to `next_button`
- [ ] Create `approve_button` as `Gtk.Button`
- [ ] Create `reject_button` as `Gtk.Button` with "edit-undo" icon
- [ ] Append all three buttons to the box
- [ ] Add CSS classes to approve and reject buttons

### Functionality
- [ ] Connect approve button click handler
- [ ] Connect reject button click handler
- [ ] Implement `approve_file_history()` method
- [ ] Implement `update_button_visibility()` method
- [ ] Update `update_selected_file()` to call `update_button_visibility()`
- [ ] Connect to `review_files.items_changed` signal to update button visibility
- [ ] Update overall widget visibility based on button visibility

### FileHistory Revert Method
- [ ] Add `revert(File file)` async method to FileHistory class
- [ ] Implement backup file restoration logic
- [ ] Handle "modified" change type (restore from backup)
- [ ] Handle "deleted" change type (restore from backup, create parent dir if needed)
- [ ] Handle "added" change type (throw error, cannot revert)
- [ ] Update File object metadata after restore
- [ ] Update FileHistory status to -1 (rejected) after revert
- [ ] Set file.is_need_approval = true after revert
- [ ] Add error handling for missing backup files

### CSS Styling
- [ ] Add `.oc-approve` CSS class to `resources/style.css` (no styling currently)
- [ ] Add `.oc-reject` CSS class to `resources/style.css` (no styling currently)

### UI Integration
- [ ] Add Approvals widget to main UI (toolbar/header area)
- [ ] Test all workflows

## Testing

- Test Approvals widget appears as horizontal box with three buttons
- Test next button shows task-due icon and popover on mouseover
- Test approve button only visible when file selected
- Test approve button disappears when file approved
- Test reject button only visible when file selected and has backup
- Test reject button disappears when no file selected or no backup
- Test widget visibility updates based on ReviewFiles count
- Test approve button approves file and FileHistory
- Test reject button restores file from backup
- Test clicking files in popover selects them and updates button visibility
- Test ReviewFiles.items_changed signal updates button visibility
- Test all buttons update correctly when selection changes
- Test FileHistory.revert() method works correctly
- Test revert updates FileHistory status to rejected
- Test revert sets file.is_need_approval = true
