# 1.7. Agent Management System

## Overview

Add agent management to the application, allowing users to select between different prompt agents (like "Code Assistant" and "Just Ask"). The agent selector will appear before the model selector in the UI. Rename `agent_name` to `name` in BaseAgent and make it public. Default to "Just Ask" agent.

## Status

‚è≥ **TODO** - Implementation in progress.

## Components

### 1. Rename agent_name to name in BaseAgent
**File**: `libollmchat/Prompt/BaseAgent.vala`

- Rename protected `agent_name` property to public `name` property
- Update all internal references from `agent_name` to `name` (lines 34, 90, 110)
- Add public `title` property: `string` - Display name for UI (e.g., "Code Assistant", "Just Ask")

### 2. Update CodeAssistant
**File**: `libollmchat/Prompt/CodeAssistant.vala`

- Update `protected override string agent_name` to `protected override string name`
- Set `title` property in constructor: "Code Assistant"

### 3. Just Ask Agent
**File**: `libollmchat/Prompt/JustAsk.vala` (new file)

Create a simple pass-through agent that extends BaseAgent:
- Override `name` property: "just-ask"
- Set `title` property: "Just Ask"
- Returns empty system prompt (default BaseAgent behavior)
- Passes user input through unchanged (default BaseAgent behavior)

### 4. Manager Agent Management
**File**: `libollmchat/History/Manager.vala`

Add agent management:
- `agents` property: `Gee.HashMap<string, Prompt.BaseAgent>` to store registered agents (keyed by name)
- `active_agent_name` property: `string` to track current active agent name (default: "just-ask")
- `register_agent(Prompt.BaseAgent agent)` method: Register an agent by its name property
- `get_active_agent()` method: Get the first agent from agents HashMap (simple iteration)
- Update `new_client()` to set `prompt_assistant` from active agent (no copying needed, agents are stateless)

### 5. Agent Registration in Window
**File**: `ollmchat/Window.vala`

In `initialize_client()`:
- Create CodeAssistant agent (already sets name and title)
- Create JustAsk agent (sets name and title)
- Register both agents with manager using `register_agent()`
- Set default active agent name to "just-ask" (or let it default)

### 6. Agent Selector UI
**File**: `libollmchatgtk/ChatInput.vala`

Add agent dropdown before model dropdown:
- Create `agent_dropdown` Gtk.DropDown widget
- Create `agent_store` GLib.ListStore for BaseAgent objects
- Add `setup_agent_dropdown()` method similar to `setup_model_dropdown()`
- Position agent dropdown before model dropdown in button_box (line ~159)
- Connect selection change to update `manager.active_agent_name`
- Update session's client `prompt_assistant` when agent changes (direct assignment, no copying)
- Handle session_activated signal to update agent selection

### 7. Update Manager.new_client()
**File**: `libollmchat/History/Manager.vala`

Modify `new_client()` to:
- Get active agent from `get_active_agent()`
- Set `client.prompt_assistant` to the active agent directly (agents are stateless, no copying needed)

## Implementation Details

### BaseAgent Changes
```vala
public class BaseAgent : Object {
    // Rename from agent_name to name, make public
    public virtual string name { get; set; default = ""; }
    
    // New public property for UI display
    public string title { get; set; default = ""; }
    
    // Update load_section to use this.name instead of this.agent_name
    // ... rest of existing code
}
```

### Just Ask Implementation
```vala
public class JustAsk : BaseAgent {
    protected override string name { get; set; default = "just-ask"; }
    
    public JustAsk() {
        base();
        this.title = "Just Ask";
    }
    
    // Default BaseAgent behavior already passes through user input
    // No need to override generate_system_prompt() or generate_user_prompt()
}
```

### CodeAssistant Updates
```vala
public class CodeAssistant : BaseAgent {
    // Change from agent_name to name
    protected override string name { get; set; default = "code-assistant"; }
    
    public CodeAssistant(AgentInterface? provider = null) {
        base();
        this.provider = provider ?? new CodeAssistantDummy();
        this.title = "Code Assistant";
    }
}
```

### Manager Changes
- Add `public Gee.HashMap<string, Prompt.BaseAgent> agents { get; private set; }`
- Add `public string active_agent_name { get; set; default = "just-ask"; }`
- Add `public void register_agent(Prompt.BaseAgent agent)`
- Add `public BaseAgent? get_active_agent()` - returns first agent from agents HashMap
- Update `new_client()` to use active agent (direct assignment, no copying)

### get_active_agent() Implementation
```vala
public BaseAgent? get_active_agent() {
    if (this.agents.size == 0) {
        return null;
    }
    // Return first agent from HashMap
    return this.agents.values.to_array()[0];
}
```

### UI Integration
- Agent dropdown uses same pattern as model dropdown
- Factory shows agent title property
- Selection updates manager.active_agent_name
- When agent changes, update current session's client.prompt_assistant (direct assignment)
- On session_activated, sync dropdown selection with session's agent

## Files to Modify

1. **New Files**:
   - `libollmchat/Prompt/JustAsk.vala` - Just Ask agent implementation

2. **Modified Files**:
   - `libollmchat/Prompt/BaseAgent.vala` - Rename agent_name to name (public), add title property, update references (lines 34, 90, 110)
   - `libollmchat/Prompt/CodeAssistant.vala` - Update to use name instead of agent_name, set title
   - `libollmchat/History/Manager.vala` - Add agent management
   - `libollmchatgtk/ChatInput.vala` - Add agent selector UI
   - `ollmchat/Window.vala` - Register agents on initialization
   - `libollmchat/meson.build` - Add JustAsk.vala to sources

## Testing Considerations

- Verify agent selection persists across sessions
- Verify agent change updates current session's prompt_assistant
- Verify new sessions use active agent
- Verify "Just Ask" agent passes through user input without modification
- Verify "Code Assistant" agent still works as before
- Verify default agent is "Just Ask"
