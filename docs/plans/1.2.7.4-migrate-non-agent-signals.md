# 1.2.7.4. Migrate Tool Signal Connections to Direct Method Calls

## Overview

Update tools that connect to signals to use direct method calls through the agent handler instead. Since agents own tools and the agent infrastructure uses direct method calls (not signals), tools should register callbacks with the agent handler to receive streaming chunks.

**Note**: After investigation, there is no actual "non-agent usage" that connects to signals. The UI connects to Manager signals (which come from Session → AgentHandler), and all Chat usage goes through agents. However, there is one tool (`RequestEditMode`) that connects to `chat_call.client.stream_chunk` which should be migrated to use direct method calls via the agent handler.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md)

## Status

⏳ **TODO** - Third phase of signal migration.

## Goal

Update tools to use direct method calls through the agent handler instead of connecting to signals. Tools are owned by agents and should follow the agent infrastructure pattern of direct method calls.

## Implementation Steps

### Step 3.1: Add Agent Property to RequestBase and Remove chat_call

**Goal**: Ensure tool handlers have access to the agent handler via a property. Remove `chat_call` property - tools access chat_call via `agent.chat` instead.

**Changes**:
1. Add to `libollmchat/Tool/RequestBase.vala`:
   ```vala
   /**
    * Reference to the agent handler for this tool request.
    * Tools use this to communicate with the UI via the agent.
    * Tools access chat_call via agent.chat.
    */
   public Prompt.AgentHandler? agent { get; set; }
   ```

2. Remove `chat_call` property from `RequestBase`:
   - Remove `public Call.Chat chat_call { get; set; }` property
   - Update `deserialize_property()` to exclude "agent" instead of "chat-call"

2. Update tool request creation to set agent property:

   **Current flow** (in `libollmchat/Tool/Tool.vala`, `BaseTool.execute()` method):
   ```vala
   // Line 472-489
   public virtual async string execute(Call.Chat chat_call, Json.Object parameters)
   {
       // Convert parameters Json.Object to Json.Node for deserialization
       var parameters_node = new Json.Node(Json.NodeType.OBJECT);
       parameters_node.set_object(parameters);
       
       // Deserialize parameters JSON into Request object
       // This calls tool-specific deserialize() method (e.g., EditMode.deserialize())
       // which uses Json.gobject_deserialize() to create RequestBase instance
       var request = this.deserialize(parameters_node);
       if (request == null) {
           return "ERROR: Failed to create request object";
       }
       
       // Set tool and chat_call (not in JSON, set after deserialization)
       request.tool = this;
       request.chat_call = chat_call;
       
       return yield request.execute();
   }
   ```

   **Change needed**: 
   - Remove line 486: `request.chat_call = chat_call;`
   - Add after line 485:
     ```vala
     // Set agent property (from chat_call, set after deserialization)
     request.agent = chat_call.agent;
     ```
   
   **Result**: All tool request objects will have `agent` property set immediately after creation. Tools access chat_call via `agent.chat`.

**Result**: Tool handlers have agent property for all communication

### Step 3.2: Update All Tools to Use agent.chat Instead of chat_call

**Goal**: Update all tool code to access chat_call via `agent.chat` instead of `this.chat_call`.

**Files to modify**:
- `libollmchat/Tool/RequestBase.vala` - Replace all `this.chat_call` with `this.agent.chat`
- `libollmchat/Tools/RequestEditMode.vala` - Replace all `this.chat_call` with `this.agent.chat`
- `libollmchat/Tools/RequestRunCommand.vala` - Replace all `this.chat_call` with `this.agent.chat`
- `libollmchat/Tools/RequestReadFile.vala` - Replace all `this.chat_call` with `this.agent.chat`
- `libollmchat/Tools/RequestWebFetch.vala` - Replace all `this.chat_call` with `this.agent.chat`

**Changes**:
1. In `RequestBase.normalize_file_path()`:
   ```vala
   // Change from:
   var permission_provider = this.chat_call.permission_provider;
   // To: (Note: permission_provider migration is in plan 1.2.7.9)
   var permission_provider = this.agent != null ? this.agent.chat.permission_provider : null;
   ```

2. In `RequestBase.send_ui()`:
   ```vala
   // Change from:
   var ui_msg = new OLLMchat.Message(this.chat_call, "ui", message);
   if (this.chat_call.agent != null && this.chat_call.agent.session != null) {
   // To:
   var ui_msg = new OLLMchat.Message(this.agent.chat, "ui", message);
   if (this.agent != null && this.agent.session != null) {
   ```

3. In `RequestBase.execute()`:
   ```vala
   // Change from:
   var permission_provider = this.chat_call.permission_provider;
   // To: (Note: permission_provider migration is in plan 1.2.7.9)
   var permission_provider = this.agent != null ? this.agent.chat.permission_provider : null;
   ```

4. In all tool request classes, replace:
   - `this.chat_call` → `this.agent.chat`
   - `this.chat_call.agent` → `this.agent`
   - `this.chat_call.permission_provider` → `this.agent.chat.permission_provider` (will be `this.agent.permission_provider` after 1.2.7.9)
   - `this.chat_call.stream` → `this.agent.chat.stream`
   - `this.chat_call.client` → Remove (client access being removed)
   - `this.chat_call.reply.begin(...)` → `this.agent.chat.reply.begin(...)`

5. In `RequestEditMode.connect_signals()`:
   - Remove `this.chat_call.client.stream_chunk.connect(...)`
   - Remove `stream_content_id` field
   - Update any checks from `this.chat_call == null` to `this.agent == null || this.agent.chat == null`

**Result**: All tools access chat_call via `agent.chat`, no direct `chat_call` property

## Files to Modify

- `libollmchat/Tool/RequestBase.vala` - Add `agent` property, remove `chat_call` property, update all references to use `agent.chat`
- `libollmchat/Tool/Tool.vala` - Set `request.agent = chat_call.agent` in `BaseTool.execute()`, remove `request.chat_call = chat_call`
- `libollmchat/Tools/RequestEditMode.vala` - Replace all `chat_call` with `agent.chat`, remove signal connections
- `libollmchat/Tools/RequestRunCommand.vala` - Replace all `chat_call` with `agent.chat`
- `libollmchat/Tools/RequestReadFile.vala` - Replace all `chat_call` with `agent.chat`
- `libollmchat/Tools/RequestWebFetch.vala` - Replace all `chat_call` with `agent.chat`

## Testing Checklist

- [ ] `RequestBase` has `agent` property
- [ ] `RequestBase` no longer has `chat_call` property
- [ ] Tool requests have `agent` property set when created (not `chat_call`)
- [ ] All tools access chat_call via `agent.chat` (not `this.chat_call`)
- [ ] All tools access permission_provider via `agent.chat.permission_provider` (will be `agent.permission_provider` after 1.2.7.9)
- [ ] `RequestEditMode` uses agent property for all communication (no signals)
- [ ] `RequestEditMode` still works correctly when processing streaming responses
- [ ] All tool execution flows work correctly with agent-based access
- [ ] Client signals still exist (for backward compatibility during transition)

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md) - Parent plan
- [1.2.7.3. Update Agent Usage to Direct Method Calls](./1.2.7.3-update-agent-usage-direct-calls.md) - Previous phase
- [1.2.7.5. Rename exec_chat() to send()](./1.2.7.5-rename-exec-chat-to-send.md) - Next phase
- [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md) - Grandparent plan

