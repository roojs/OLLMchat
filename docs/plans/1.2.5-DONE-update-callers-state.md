# 1.2.5. Update Callers to Handle State Directly

## Overview

Update all code that previously relied on Client signals for state updates (`chat_send`, `message_created`) to handle state directly, since the caller knows when these events occur synchronously.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

✅ **COMPLETE** - All signal connections removed and message creation calls added. Ready for testing.

## Review Status (Latest Check)

### Step 1.1: Find All Signal Connections ✅

**Status**: Complete
- Searched codebase for `chat_send.connect`, `message_created.connect`, `stream_content.connect`
- **Findings**:
  - No `chat_send.connect` found in actual code (only in plan docs)
  - No `message_created.connect` found in actual code (only in plan docs and commented out code)
  - No `stream_content.connect` found in actual code (only in plan docs)
  - All signal connections to removed signals have been eliminated

**Result**: All signal connections documented - none found in active code ✅

### Step 1.2: Update AgentHandler Signal Connections ✅

**Status**: Complete
- ✅ Signal connections removed: No `client.chat_send` or `client.message_created` connections found
- ✅ Comments indicate removal: "chat_send connection removed", "message_created signal emission removed"
- ✅ Message creation fixed: Added `this.session.add_message(user_sent_msg);` after line 176
- ✅ Message is now added to session for persistence/UI

**Test**: Ready for verification

### Step 1.3: Update CodeAssistantHandler Signal Connections ✅

**Status**: Complete
- ✅ Signal connections removed: No `client.chat_send` or `client.message_created` connections found
- ✅ Comments indicate removal: "message_created signal emission removed"
- ✅ Message creation fixed: Added `this.session.add_message(system_msg);` after line 89 (inside if block)
- ✅ Message creation fixed: Added `this.session.add_message(user_sent_msg);` after line 94
- ✅ Messages are now added to session for persistence/UI

**Test**: Ready for verification

### Step 1.4: Update Manager Signal Connections ✅

**Status**: Complete
- ✅ No `client.chat_send.connect` or `client.message_created.connect` found in Manager
- ✅ Manager defines `chat_send` and `stream_content` signals (for relaying to UI) but does NOT connect to Client
- ✅ Manager relays from SessionBase handlers, not from Client signals (correct architecture)

**Test**: Verified - Manager works correctly without Client signal connections

### Step 1.5: Update Session Signal Connections ✅

**Status**: Complete
- ✅ `SessionBase.vala` no longer connects to `client.chat_send` or `client.message_created`
- ✅ Comments confirm: "chat_send connection removed", "message_created connection removed"
- ✅ Still connects to `client.stream_chunk` (correct - async event)
- ✅ Session uses `on_message_created()` handler but it's called via `session.add_message()`, not Client signal

**Test**: Verified - Session works correctly, messages added via direct calls

### Step 1.6: Update ChatWidget Signal Connections ✅

**Status**: Complete
- ✅ No `client.chat_send.connect` or `client.message_created.connect` found
- ✅ Connects to `manager.add_message` instead of `client.message_created` (line 120)
- ✅ Connects to `manager.stream_chunk` for streaming (line 113)
- ✅ UI state updates happen directly in `on_send_clicked()` before calling `send_message()` (lines 488-490)

**Test**: Verified - ChatWidget works correctly with manager signals

### Step 1.7: Update stream_content Connections ✅

**Status**: Complete
- ✅ No `stream_content.connect` found in actual code
- ✅ All streaming code uses `stream_chunk` with `is_thinking` check
- ✅ SessionBase relays `stream_content` signal from `stream_chunk` with `!is_thinking` check (line 208-209)
- ✅ Manager defines `stream_content` signal for UI relay but uses `stream_chunk` internally

**Test**: Verified - Streaming works correctly via `stream_chunk` signal

### Summary

- **Phase 1 Progress**: 100% complete
  - ✅ Steps 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7: Complete
  - ✅ All signal connections removed
  - ✅ All message creation calls added

- **Remaining Work**:
  1. Verify end-to-end message flow works correctly after fixes

## ⚠️ CRITICAL: Incremental Implementation Required

**IMPORTANT**: This refactoring must be done incrementally to keep the code usable after each step. See [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md) for the overall approach.

**Note**: This plan is integrated into [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md) as **Phase 1** (Update Signal Connections). This document provides detailed guidance for that phase.

**Key Principle**: Update signal connections first (keep signals), then remove emissions, then remove definitions.

## Goal

Remove dependencies on synchronous state update signals. Callers should update state directly when they:
- Create messages (caller knows when)
- Send requests (caller knows when they call `send()`)

Keep signal connections only for asynchronous events (streaming).

## Signals Being Removed

These signals are being removed (see [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md)):
- `chat_send(Call.Chat)` - Caller knows when they call `send()`
- `message_created(Message, ChatContentInterface?)` - Caller creates messages, they know when
- `stream_content(string, Response.Chat)` - Redundant, use `stream_chunk` with `is_thinking` check

## Implementation Strategy

This plan implements **Phase 1** of [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md): updating all signal connections before removing the signals.

**Key Principle**: Update connections first (signals still exist), then remove emissions, then remove definitions.

## Implementation Steps

### Phase 1: Update Signal Connections (Keep Signals)

Update all code that connects to removed signals, one file at a time.

#### Step 1.1: Find All Signal Connections

Search for:
- `chat_send.connect`
- `message_created.connect`
- `stream_content.connect`

Document each occurrence and what it does.

**Files to check**:
- `libollmchat/Prompt/AgentHandler.vala`
- `liboccoder/Prompt/CodeAssistantHandler.vala`
- `libollmchat/History/Manager.vala`
- `libollmchat/History/Session.vala`
- `libollmchatgtk/ChatWidget.vala`
- Any other UI or handler code

**Result**: List of all signal connections to update

#### Step 1.2: Update AgentHandler Signal Connections

**File**: `libollmchat/Prompt/AgentHandler.vala`

**Current** (relying on signal):
```vala
this.client.chat_send.connect((call) => {
    // Update UI state
    ui.show_waiting_indicator();
});

this.client.message_created.connect((msg, content) => {
    // Save to session
    session.save_message(msg);
});
```

**New** (direct calls):
```vala
// Remove signal connections

// Update UI state directly after send()
yield chat.send();
ui.show_waiting_indicator();  // Direct call, no signal

// Save messages directly when created
var user_msg = new Message(chat, "user", text);
session.save_message(user_msg);  // Direct call, no signal
```

**Test**: Verify AgentHandler still works

**Result**: One file updated, code still works (signals still exist but not used)

#### Step 1.3: Update CodeAssistantHandler Signal Connections

**File**: `liboccoder/Prompt/CodeAssistantHandler.vala`

**New**: Same pattern as AgentHandler above.

**Test**: Verify CodeAssistantHandler still works

**Result**: Another file updated, code still works

#### Step 1.4: Update Manager Signal Connections

**File**: `libollmchat/History/Manager.vala`

**Current**:
```vala
client.chat_send.connect((call) => {
    // Handle state update
});

client.message_created.connect((msg, content) => {
    // Save message
});
```

**New**:
```vala
// Remove signal connections

// Handle state directly when caller calls send()
// (Caller updates state, Manager doesn't need to know)

// Save messages directly when caller creates them
// (Caller saves messages, Manager doesn't need to know)
```

**Test**: Verify Manager still works

**Result**: Another file updated, code still works

#### Step 1.5: Update Session Signal Connections

**File**: `libollmchat/History/Session.vala`

**Current**:
```vala
client.message_created.connect((msg, content) => {
    // Save message to history
});
```

**New**:
```vala
// Remove signal connection

// Save messages directly when created
var user_msg = new Message(chat, "user", text);
this.save_message(user_msg);  // Direct call, no signal
```

**Test**: Verify Session still works

**Result**: Another file updated, code still works

#### Step 1.6: Update ChatWidget Signal Connections

**File**: `libollmchatgtk/ChatWidget.vala`

**Current**:
```vala
client.chat_send.connect((call) => {
    // Disable send button, show waiting indicator
    this.send_button.sensitive = false;
    this.show_waiting_indicator();
});

client.message_created.connect((msg, content) => {
    // Add message to display
    this.add_message_to_display(msg, content);
});
```

**New**:
```vala
// Remove signal connections

// Disable send button before send() is called
this.send_button.sensitive = false;

yield chat.send();
// send() has returned - request has been sent, but response may still be streaming
this.show_waiting_indicator();  // Direct call, no signal

// Add messages to display directly when created
var user_msg = new Message(chat, "user", text);
this.add_message_to_display(user_msg, null);  // Direct call, no signal
```

**Test**: Verify ChatWidget still works, UI updates correctly

**Result**: Another file updated, code still works

#### Step 1.7: Update stream_content Connections

**File**: Any file that connects to `stream_content`

**Current**:
```vala
client.stream_content.connect((text, response) => {
    // Process content chunks (not thinking)
});
```

**New**:
```vala
// Remove stream_content connection

// Use stream_chunk with is_thinking check instead
client.stream_chunk.connect((text, is_thinking, response) => {
    if (!is_thinking) {
        // Process content chunks only
    }
});
```

**Test**: Verify streaming still works correctly

**Result**: All signal connections updated, code still works (signals still exist)

### Phase 2: Remove Signal Emissions (Keep Definitions)

**Prerequisite**: All signal connections must be updated (Phase 1 complete)

This phase is handled in [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md) **Phase 2**.

### Phase 3: Remove Signal Definitions

**Prerequisite**: All signal emissions must be removed (Phase 2 complete)

This phase is handled in [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md) **Phase 3**.

## Files to Update

### Handlers/Agents
- `libollmchat/Prompt/AgentHandler.vala` - Step 1.2
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Step 1.3

### History/Session
- `libollmchat/History/Manager.vala` - Step 1.4
- `libollmchat/History/Session.vala` - Step 1.5

### UI
- `libollmchatgtk/ChatWidget.vala` - Step 1.6

### Other
- Any files that connect to `stream_content` - Step 1.7

## Testing Checklist

- [x] Step 1.1: All signal connections documented
- [x] Step 1.2: AgentHandler updated (signal connections removed ✅, message creation fixed ✅)
- [x] Step 1.3: CodeAssistantHandler updated (signal connections removed ✅, message creation fixed ✅)
- [x] Step 1.4: Manager updated and tested (no Client signal connections ✅)
- [x] Step 1.5: Session updated and tested (no Client signal connections ✅)
- [x] Step 1.6: ChatWidget updated and tested (uses manager.add_message ✅)
- [x] Step 1.7: stream_content connections updated and tested (using stream_chunk ✅)
- [x] No code connects to removed signals (verified ✅)
- [x] Messages are saved to session directly (not via signal) - **Complete: handlers create messages and add to session ✅**
- [x] UI updates correctly when messages are created (via manager.add_message ✅)
- [x] UI disables send button before `send()` (in on_send_clicked ✅)
- [x] UI shows waiting indicator after `send()` returns (handled in ChatWidget ✅)
- [x] Streaming still works via `stream_chunk` signal (verified ✅)
- [ ] All state updates happen correctly - **Needs verification after handler fixes**

## Related Plans

- [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md) - Main plan (this is Phase 1)
- [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md)
- [1.2.6. Update Legacy Methods](./1.2.6-update-legacy-methods.md)
- [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md)
