# 2.6.1. Sandbox: Playground Space and Git Cloning

## Overview

The LLM/agent attempted to clone a repository into the project directory via `run_command`. This plan addresses how to handle git cloning, provide a dedicated playground for agent experimentation, and make run_command’s network isolation explicit to the LLM.

## Status

⏳ **PLANNING** – Design phase.

## Problem

1. **Cloning into the project**  
   The agent used `run_command` to run `git clone <url>` (or similar) in the project root. That:
   - Risks polluting the project with arbitrary cloned repos.
   - Is not something we want to allow by default in the project tree.

2. **Network and run_command**  
   - In the bwrap sandbox, `run_command` uses `--unshare-net`, so **`git clone` already fails** (no network).
   - The **tool description does not state** that commands have no network. The LLM has no reason to avoid `git clone` or to expect it to fail.

3. **No dedicated space for experiments**  
   - There is no designated writable area for “try cloning / run experiments” that is separate from the project.
   - All writable space in the sandbox is project roots (from `build_roots()`).

## Goals

1. **Document run_command’s isolation**  
   Make it explicit in the tool description that:
   - Commands run in an isolated environment **with no network access**.
   - `git clone`, `curl`, `wget`, `pip install`, etc. will not work.

2. **Introduce an agent playground**  
   - A dedicated, writable directory for experiments (clone, scratch files, etc.) that is **outside** the project.
   - The LLM can be instructed to use this for git clones and similar operations when we add support (e.g. git tool or network-capable run_command).

3. **Evaluate a Git tool**  
   - Decide whether a dedicated **git tool** is useful to:
     - Restrict `git clone` (and similar) to the playground only.
     - Expose a small, controlled set of git operations (e.g. clone, status, log, diff) with clear semantics and permission/network handling.

4. **Keep project and playground clearly separate**  
   - By default, `run_command` continues to run in the project; we do not auto‑redirect clones into the project.
   - Any future ability to clone or fetch must target the playground (or an explicit, user‑approved path), not the project, unless the user explicitly approves.

---

## 1. Run Command: Explicit “No Network” in the Description

### Current state

- `liboctools/RunCommand/Tool.vala`: `description` does not mention network.
- `liboctools/RunCommand/Bubble.vala`: uses `--unshare-net` when `allow_network` is false (default).

### Change

Add a short, explicit note to **`Tool.description`** (and, if present, any user-facing docstring or help text), e.g.:

- “Commands run in an isolated environment **with no network access**. Network-dependent commands (e.g. `git clone`, `curl`, `wget`, `pip install`) will not work.”

### Optional: failure hint in tool output

When a command fails and the output suggests network (e.g. “Could not resolve host”, “Connection refused”, “fatal: unable to access”), we could append a one-line hint: “(Note: run_command has no network access.)”  
- **Scope:** Optional, can be a follow-up. Main requirement is the description.

### Files to modify

- `liboctools/RunCommand/Tool.vala` – extend `description` with the no‑network statement.

### Dependencies

- None.

---

## 2. Agent Playground

### Idea

- A **playground** directory: a writable, agent‑accessible area **outside** the project for:
  - Cloning repos (when we allow it, e.g. via a git tool or network‑enabled run).
  - Scratch files, build artifacts, downloads, etc.
- The project directory remains for project work; the playground is for “try things without touching the project”.

### Location

- **Proposed:** `~/.local/share/ollmchat/playground/` (or `{data_dir}/playground/` when `data_dir` is available).
- Alternatives: `~/.cache/ollmchat/playground/` (cache semantics; may be purged), or a subdir under a session/chat ID for better isolation (more complex; can be a later phase).

- For this plan: a **single shared playground** is enough. Per‑session subdirs can be a later refinement.

### When is it available?

- **Bubble/bwrap:**  
  - Playground must be **writable** in the sandbox.  
  - Today only `build_roots()` entries get overlay mounts.  
  - We need to add the playground path as an extra writable root (extra `--overlay` / overlay upper) in `Bubble` (and `Overlay` / `Scan` if they are responsible for defining roots).

- **Non‑bwrap (Subprocess) fallback:**  
  - `execute_with_subprocess()` uses `base_directory` (project) as `cd` target.  
  - Playground could be used as the working directory only when we explicitly choose “run in playground” (e.g. a parameter or a separate code path). For Phase 1, we can keep run_command’s cwd as project and only add playground as a **writable extra** in bwrap; the agent would use `cd /path/to/playground && ...` when we document it.

- **Visibility to the LLM:**  
  - Once the path exists and is writable, we need to **tell the model** about it (system prompt, or tool description, or both). E.g.:  
    - “A playground directory is available at `{playground_path}` for experiments (e.g. cloning repositories). Do not clone into the project root; use the playground when you need to fetch external code.”

### Implementation outline

1. **Define playground path**
   - `ApplicationInterface.data_dir` → `{data_dir}/playground`, or `~/.local/share/ollmchat/playground` as fallback.
   - Ensure the directory exists on first use (similar to `promptsets` in 5.3).

2. **Bubble/Overlay**
   - In `Bubble` (and `Overlay` if it owns the roots), add the playground path as an extra writable root:
     - One more `--overlay` (or equivalent) for the playground.
     - `Overlay` / `Scan` must know about it so that writes under the playground are merged back (or, if we treat playground as disposable, we might not need to merge back; that’s a product decision).
   - Simpler product choice for now: **merge playground writes back** like project roots, so that clones and files persist across runs.

3. **run_command and cwd**
   - Option A: Keep `run_command` cwd = project; LLM uses `cd $PLAYGROUND && git clone ...` when we allow network and document the playground.
   - Option B: Add a parameter like `run_in_playground: bool` to run_command; when true, `--chdir` (and `cd` in subprocess fallback) points to the playground.  
   - For a first step, **Option A** is enough: we add the playground as writable, document it, and (later) a git tool or network‑allowed run can use it. No need to change run_command’s cwd logic yet.

4. **Expose path to the agent**
   - Agent/Factory or a small helper: `get_playground_path() -> string`.  
   - Injected into system prompt or tool descriptions (e.g. run_command, or a future git tool) so the LLM knows the path.

### Files to create or modify

- **New or shared:**
  - Playground path helper (e.g. in `ApplicationInterface`, or in a small `Playground`/paths module used by RunCommand and agents).
- **Modify:**
  - `liboctools/RunCommand/Bubble.vala` – add playground as extra writable root when path is non‑empty.
  - `liboctools/RunCommand/Overlay.vala` – if Overlay owns the list of roots, add playground there and in `overlay_map` / `Scan` so writes are merged.
  - `liboctools/RunCommand/Overlay.vala` / `Scan.vala` – ensure Scan includes the playground upper in its copy‑back logic if we merge back.
  - `libollmchat/Agent/Factory.vala` (or equivalent) – `get_playground_path()` if we centralize it there; plus wiring into system prompts or tool descriptions.
  - `ollmapp/Application.vala` or similar – ensure `data_dir` (or home) and `playground` dir exist on startup if we create on first use.

### Dependencies

- `ApplicationInterface.data_dir` or a clear fallback.
- Decision: do we merge playground writes back? (Proposed: yes, for predictability.)

### Open points

- Per‑session vs shared playground.
- Whether `run_command` should ever take `run_in_playground` (or similar) in this plan or a later one.

---

## 3. Git Tool (Optional / Future)

### Motivation

- **Control of clone target:**  
  A dedicated git tool can enforce “clone only into the playground” (or another explicitly allowed path), instead of relying on the LLM to `cd` correctly when using `run_command`.

- **Network and permissions:**  
  - `git clone` (and `fetch`, `pull`) need network.  
  - This fits with **2.14-network-access-support**: a git tool would request network permission when the operation needs it.

- **Clearer semantics:**  
  - `git_clone(url, dir?)` with `dir` defaulting to `{playground}/{repo_basename}` and forbidden to be inside the project (or only allowed with an explicit “yes, clone into project” permission).  
  - Other operations like `status`, `log`, `diff` can be local‑only and not require network.

### Scope for this plan

- **This plan:** Only **decide** whether we want a git tool and outline its interface and rules. No implementation yet.
- **Later plan(s):** Implement the tool, integrate with playground and 2.14.

### Proposed rules for a future Git tool

- **clone**
  - Parameters: `url` (required), optional `destination` or `subdir`.
  - If `destination` omitted: clone into `{playground}/{repo_basename}` (or similar).  
  - If `destination` given:  
    - Must be under the playground (or another allow‑listed root we define).  
    - If under the project: require an extra, explicit user permission (“clone into project”).
  - Requires **network**. Must go through the same “allow_network” / permission flow as in 2.14.

- **status, log, diff, show, etc.**
  - Local‑only; no network.  
  - Paths must be under project or playground (or both, depending on policy). Reuse read‑path checks similar to `read_file` / `edit_file`.

### Relationship to run_command

- **run_command** stays the main “run any shell command” tool; it remains **without network** by default.
- A **git tool** is an alternative, controlled way to do git operations:
  - Enforces where clone goes.
  - Clearly separates “needs network” (clone, fetch, pull) from “local only” (status, log, diff).
- The run_command description will state that `git clone` does not work there; if we add a git tool, we can add: “For cloning, use the `git` tool and the playground.”

### Dependencies

- 2.14 (network and permission for `allow_network`‑style requests).
- Playground (Section 2) so that `clone` has a well‑defined default target.

---

## 4. Summary of Recommendations

| Item | Action |
|------|--------|
| **run_command description** | Add explicit “no network access” and examples (`git clone`, `curl`, `wget`, `pip install`) so the LLM does not attempt `git clone` there expecting it to work. |
| **Playground** | Introduce `{data_dir}/playground`, create on first use, add as extra writable root in Bubble/Overlay, and expose path to the agent (system prompt or tool text). Merge writes back for now. |
| **run_command cwd** | Leave as project root; document that for experiments (e.g. future clones) the agent should use the playground path. No `run_in_playground` in this plan. |
| **Git tool** | Plan for a dedicated git tool that restricts clone to the playground (or an approved path) and uses the 2.14 network‑permission flow. Detail and implement in a separate plan. |

---

## 5. Phases

| Phase | Description |
|-------|-------------|
| **1** | Update `run_command` tool description to state no network and that `git clone`, `curl`, `wget`, `pip install` do not work. |
| **2** | Introduce playground: path, create‑on‑first‑use, add as writable in Bubble/Overlay/Scan, and expose `get_playground_path()` (or equivalent) to agents. |
| **3** | Document playground in system prompt or run_command text: “Use `{playground_path}` for experiments (e.g. cloning); do not clone into the project.” |
| **4** | (Future) Implement git tool with clone→playground and network permission; optionally add a hint to run_command output when a failure looks network‑related. |

---

## 6. Files to Create or Modify

### Phase 1

- `liboctools/RunCommand/Tool.vala` – extend `description` with no‑network text.

### Phase 2

- Playground path: `ApplicationInterface` or a small shared helper + `ollmapp` startup.
- `liboctools/RunCommand/Bubble.vala` – add playground to writable roots when available.
- `liboctools/RunCommand/Overlay.vala` – add playground to roots/`overlay_map` and to Scan so writes are merged.
- `liboctools/RunCommand/Scan.vala` – if needed, include playground upper in copy‑back.

### Phase 3

- Agent/Factory or Chat/Manager: inject playground path into system prompt or run_command’s description / `parameter_description` (e.g. a line that includes the path). Alternatively, a short “sandbox rules” block in the system prompt.

### Phase 4 (separate plan)

- New `liboctools/Git/` or similar: `Tool.vala`, `Request.vala`, operations (clone, status, log, diff), integration with 2.14 for network.

---

## 7. Dependencies

- **2.14-network-access-support** – for any future git tool that performs `clone`/`fetch`/`pull`.
- **5.3-agent-sandbox** – not required for playground or run_command changes; prompt‑sandbox could later use a similar “playground” idea if we generalize.
- **ApplicationInterface.data_dir** – for `{data_dir}/playground` (or a documented fallback to `~/.local/share/ollmchat/playground`).

---

## 8. Open Points

- Per‑session vs shared playground; lifecycle (e.g. periodic cleanup of old playground content).
- Whether to add a one‑line “no network” hint in run_command output when a command fails with a network‑like error.
- Exact place to inject playground path: run_command `description`/`parameter_description` vs system prompt vs both.
- Whether `run_command` will ever support a `run_in_playground` (or `cwd`) parameter; if yes, in this plan or a later one.
