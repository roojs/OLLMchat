# 2.6.1. Sandbox: Playground Space, Working Directory, and Network Access

## Overview

This plan modifies the run command tool to:
1. Add a Playground directory to bubble wrap that appears as `$HOME/playground` (user's home directory) but maps to `$DATA_DIR/playground`
2. Add a `working_dir` parameter to the run command tool (default: project directory)
3. Add comprehensive documentation about file system permissions
4. Add a `network` parameter with special permission handling that requires approval every time (no caching)

## Status

⏳ **PLANNING** – Design phase.

## Problem

1. **No dedicated playground space**  
   The agent needs a writable area for experiments (cloning repos, scratch files, etc.) that is separate from the project directory.

2. **No working directory control**  
   The run command tool always executes in the project directory with no way to specify a different working directory.

3. **Network access not documented**  
   The tool description does not explicitly state that commands have no network access by default, and there's no way for the LLM to request network access.

4. **Network permissions need special handling**  
   Network access should always require approval and never be cached, as it's a high-risk operation.

## Goals

1. **Add Playground directory to bubble wrap**
   - Create `$DATA_DIR/playground` directory if it doesn't exist
   - Mount it in bubble wrap as `$HOME/playground` (user's home directory) with read-write access
   - Always mount when bubble is running

2. **Add `working_dir` parameter**
   - Add `working_dir` parameter to run command tool (default: project directory)
   - Allow LLM to specify where commands should execute
   - Playground will be read-write accessible

3. **Document file system permissions**
   - Update tool description to clearly state:
     - Commands normally run in the project directory
     - Read-write access to `$HOME/playground` (user's home directory) and the project directory
     - Everything else is read-only
     - Network access is blocked by default

4. **Add `network` parameter with special permission handling**
   - Add `network` boolean parameter (default: false)
   - When `network` is true, require approval every time (no caching)
   - Commands requesting network access must be approved and will not be saved for future usage

---

## 1. Playground Directory

### Location

- **Real path:** `$DATA_DIR/playground` (where `$DATA_DIR` is from `ApplicationInterface.data_dir`)
- **Sandbox path:** `$HOME/playground` (where `$HOME` is the user's home directory)
- **Access:** Read-write

**Note:** Throughout this document, `/home/user` refers to the user's home directory (`$HOME`), which is obtained via `GLib.Environment.get_home_dir()`. The actual path may vary (e.g., `/home/username` on Linux, `/Users/username` on macOS).

### Implementation

1. **Get playground path**
   - Use fixed path: `~/.local/share/ollmchat/playground` (standard XDG data directory)
   - Build path: `GLib.Path.build_filename(GLib.Environment.get_home_dir(), ".local", "share", "ollmchat", "playground")`
   - Create directory if it doesn't exist (similar to how history directory is created)

2. **Add to Bubble class**
   - Compute playground path directly in `Bubble` class (no constructor parameter needed)
   - Add playground to mounts in `build_bubble_args()`
   - Use `--bind` (not overlay) for playground since it's outside project roots
   - Mount as `$HOME/playground` (user's home directory) in sandbox using `GLib.Environment.get_home_dir()`
   - Create directory if it doesn't exist before mounting

3. **Ensure directory exists**
   - Create playground directory in `build_bubble_args()` or before mounting
   - Use `GLib.File.make_directory_with_parents()` to create if missing

### Files to Modify

- `liboctools/RunCommand/Bubble.vala`
  - Add method to get playground path (fixed: `~/.local/share/ollmchat/playground`)
  - Add `--bind` mount for playground in `build_bubble_args()`
  - Create directory if it doesn't exist before mounting

### Dependencies

- `ApplicationInterface.data_dir` must be available
- Need to pass `ApplicationInterface` reference to `Bubble` or get it via tool/agent

---

## 2. Working Directory Parameter

### Parameter Details

- **Name:** `working_dir`
- **Type:** `string` (optional)
- **Default:** Project directory (first project root)
- **Description:** The working directory where the command will be executed

### Implementation

1. **Add parameter to Request class**
   - Add `working_dir` property to `Request.vala`
   - Default to empty string (will use project directory)

2. **Normalize working directory**
   - Normalize `working_dir` to absolute path before validation
   - Special case: if `working_dir` is "playground", normalize to `$HOME/playground` (user's home directory)
   - Use `GLib.Path.is_absolute()` to check if path is already absolute
   - If not absolute, treat as relative to sandbox root (but document that absolute paths are preferred)
   - For "playground" specifically, map to `$HOME/playground` (sandbox path, where `$HOME` is obtained via `GLib.Environment.get_home_dir()`)

3. **Validate working directory**
   - Check if normalized `working_dir` exists before executing command
   - If directory doesn't exist, return error: `"ERROR: Working directory does not exist: {working_dir}"`
   - No path restriction validation needed - bubblewrap permissions already handle access restrictions
   - Allow tool to run in any directory (permissions are enforced by the sandbox)

3. **Update Bubble.exec()**
   - Modify `build_bubble_args()` to use `working_dir` if provided
   - Use `--chdir` flag with the specified directory
   - Only proceed if directory exists (validation done in Request.execute())

4. **Update Tool description**
   - Add `working_dir` to `parameter_description`
   - Document default behavior (project directory)
   - Document that directory must exist
   - Document that `working_dir` should be an absolute path
   - Document special case: "playground" is normalized to `$HOME/playground` (user's home directory)

5. **Update subprocess fallback**
   - Modify `execute_with_subprocess()` to use `working_dir` if provided
   - Validate directory exists before executing
   - Use `cd` command or `GLib.Subprocess` working directory

### Files to Modify

- `liboctools/RunCommand/Tool.vala`
  - Add `working_dir` to `parameter_description`
- `liboctools/RunCommand/Request.vala`
  - Add `working_dir` property
  - Add normalization method to convert `working_dir` to absolute path
  - Special case: normalize "playground" to `$HOME/playground` (user's home directory, obtained via `GLib.Environment.get_home_dir()`)
  - Add validation in `execute()` to check if normalized directory exists
  - Return `"ERROR: Working directory does not exist: {working_dir}"` if directory doesn't exist
  - Pass normalized path to `Bubble.exec()` or use in command execution (only if directory exists)
  - No path restriction validation - bubblewrap handles permissions
- `liboctools/RunCommand/Bubble.vala`
  - Modify `exec()` to accept `working_dir` parameter
  - Update `build_bubble_args()` to use `--chdir` with `working_dir`
  - No path validation needed - bubblewrap sandbox enforces permissions

---

## 3. Documentation Updates

### Tool Description

Update `Tool.description` to include:

```
Run a terminal command in the project's root directory (or specified working directory) and return the output.

File System Permissions:
- The Run command tool normally works in the project directory and has read-write access to:
  - The project directory
  - $HOME/playground (playground directory for experiments, where $HOME is the user's home directory)
- Everything else is read-only

Network Access:
- By default, this tool does not have access to the network.
- If you require access to the network, you must set the `network` parameter to `true`.
- For fetching websites or web content, you should use the `web_fetch` tool instead of this tool.

If the command fails, you should handle the error gracefully and provide a helpful error message to the user.
```

### Parameter Description

Update `parameter_description` to include:

```
@param command {string} [required] The terminal command to run.
@param working_dir {string} [optional] The working directory where the command will be executed. Should be an absolute path. Defaults to the project directory. Special case: "playground" is normalized to `$HOME/playground` (user's home directory).
@param network {boolean} [optional] Whether to allow network access. Defaults to false. For fetching websites or web content, use the `web_fetch` tool instead.
```

### Files to Modify

- `liboctools/RunCommand/Tool.vala`
  - Update `description` property
  - Update `parameter_description` property

---

## 4. Network Parameter with Special Permission Handling

### Parameter Details

- **Name:** `network`
- **Type:** `boolean` (optional)
- **Default:** `false`
- **Description:** Whether to allow network access. Requires user approval every time.

### Permission Handling

1. **Always require approval**
   - When `network` is `true`, always require user approval
   - Never cache permissions for network access
   - Use unique permission target path to bypass cache

2. **Permission question**
   - Format: "Run command with network access: {command}?"

3. **No permission caching**
   - Use a unique identifier (timestamp or UUID) in `permission_target_path`
   - This ensures the permission system always asks, never uses cached permissions
   - Similar to how complex commands bypass cache

4. **Pass to Bubble**
   - If permission granted, pass `allow_network=true` to `Bubble` constructor
   - If permission denied, execute with `allow_network=false` and return error

### Implementation

1. **Add network property to Request**
   - Add `network` boolean property (default: false)

2. **Add one_time_only property to RequestBase**
   - Add `one_time_only` boolean property to `RequestBase` (default: false)
   - This property indicates that the permission should only show "Approve" and "Deny" buttons (no "Always" options)

3. **Modify build_perm_question()**
   - If `network` is true, always require approval
   - Set `one_time_only = true` when network is requested
   - Set unique `permission_target_path` to bypass cache
   - Set appropriate `permission_question`

4. **Update execute()**
   - Check if `network` is true
   - If true, request permission (always ask, never cache)
   - Pass `allow_network` to `Bubble` based on permission result

5. **Update Bubble usage**
   - Pass `allow_network` parameter from `Request.network` (after permission check)

6. **Modify permission widget to support one_time_only**
   - Update `ChatPermission.request()` to accept `RequestBase` instead of just string
   - Check `request.one_time_only` property
   - If `one_time_only` is true, only show "Allow" (ALLOW_ONCE) and "Deny" (DENY_ONCE) buttons
   - Hide "Deny Always", "Allow Always", and "Allow for this session" buttons when `one_time_only` is true

7. **Update Permission provider**
   - Modify `request_user()` to pass `RequestBase` object to permission widget instead of just the question string

### Files to Modify

- `libollmchat/Tool/RequestBase.vala`
  - Add `one_time_only` boolean property (default: false)
- `liboctools/RunCommand/Request.vala`
  - Add `network` property
  - Modify `build_perm_question()` to handle network requests
  - Set `one_time_only = true` when network is requested
  - Update `execute()` to request permission for network access
  - Pass `allow_network` to `Bubble` constructor
- `liboctools/RunCommand/Bubble.vala`
  - Already supports `allow_network` parameter (no changes needed)
- `libollmchatgtk/ChatPermission.vala`
  - Modify `request()` method to accept `RequestBase` parameter instead of just string
  - Store button references so they can be shown/hidden dynamically
  - Check `request.one_time_only` and hide/show buttons accordingly
  - When `one_time_only` is true, only show "Allow" (ALLOW_ONCE) and "Deny" (DENY_ONCE) buttons
- `libollmchatgtk/Tools/Permission.vala`
  - Update `request_user()` to pass `RequestBase` object to `permission_widget.request()` instead of just the question string

---

## 5. Implementation Phases

### Phase 1: Playground Directory
- [ ] Add method to get playground path (fixed: `~/.local/share/ollmchat/playground`)
- [ ] Create playground directory if it doesn't exist
- [ ] Add playground mount to `Bubble.build_bubble_args()`
- [ ] Test playground is writable in sandbox

### Phase 2: Working Directory Parameter
- [ ] Add `working_dir` property to `Request`
- [ ] Add normalization method to convert to absolute path
- [ ] Implement special case: normalize "playground" to `$HOME/playground` (user's home directory)
- [ ] Add validation in `execute()` to check if normalized directory exists
- [ ] Return error message if directory doesn't exist
- [ ] Update `Tool.parameter_description` (document absolute path requirement)
- [ ] Modify `Bubble.exec()` to accept and use normalized `working_dir`
- [ ] Update `build_bubble_args()` to set `--chdir`
- [ ] Update subprocess fallback to use normalized `working_dir` with validation
- [ ] Test commands execute in specified directory
- [ ] Test "playground" normalization to `$HOME/playground` (user's home directory)
- [ ] Test error handling when directory doesn't exist
- [ ] Verify bubblewrap permissions restrict access appropriately

### Phase 3: Documentation
- [ ] Update `Tool.description` with file system permissions
- [ ] Update `Tool.description` with network access information
- [ ] Update `Tool.parameter_description` with new parameters

### Phase 4: Network Parameter
- [ ] Add `one_time_only` property to `RequestBase`
- [ ] Add `network` property to `Request`
- [ ] Modify `build_perm_question()` to handle network requests
- [ ] Set `one_time_only = true` when network is requested
- [ ] Implement unique permission path for network requests (bypass cache)
- [ ] Update `execute()` to request permission for network access
- [ ] Pass `allow_network` to `Bubble` based on permission
- [ ] Modify `ChatPermission.request()` to accept `RequestBase` instead of string
- [ ] Update permission widget to show/hide buttons based on `one_time_only`
- [ ] Update `Permission.request_user()` to pass `RequestBase` to widget
- [ ] Test network blocking (default)
- [ ] Test network access with permission (verify only "Allow" and "Deny" buttons shown)
- [ ] Test permission denial
- [ ] Verify network requests are never cached
- [ ] Verify one-time-only requests only show "Allow" and "Deny" buttons

---

## 6. Files to Create or Modify

### Phase 1: Playground
- `liboctools/RunCommand/Bubble.vala`
  - Add method to get playground path (fixed: `~/.local/share/ollmchat/playground`)
  - Add `--bind` mount for playground
  - Create directory if missing

### Phase 2: Working Directory
- `liboctools/RunCommand/Tool.vala`
  - Update `parameter_description`
- `liboctools/RunCommand/Request.vala`
  - Add `working_dir` property
  - Pass to `Bubble.exec()` or use in execution
- `liboctools/RunCommand/Bubble.vala`
  - Modify `exec()` signature to accept `working_dir`
  - Update `build_bubble_args()` to use `--chdir`
  - Validate `working_dir` is within allowed paths

### Phase 3: Documentation
- `liboctools/RunCommand/Tool.vala`
  - Update `description`
  - Update `parameter_description`

### Phase 4: Network Parameter
- `libollmchat/Tool/RequestBase.vala`
  - Add `one_time_only` boolean property (default: false)
- `liboctools/RunCommand/Request.vala`
  - Add `network` property
  - Modify `build_perm_question()` for network requests
  - Set `one_time_only = true` when network is requested
  - Update `execute()` to handle network permissions
  - Pass `allow_network` to `Bubble`
- `libollmchatgtk/ChatPermission.vala`
  - Modify `request()` to accept `RequestBase` instead of string
  - Store button references for dynamic show/hide
  - Check `request.one_time_only` and show/hide buttons accordingly
  - When `one_time_only` is true, only show "Allow" (ALLOW_ONCE) and "Deny" (DENY_ONCE) buttons
- `libollmchatgtk/Tools/Permission.vala`
  - Update `request_user()` to pass `RequestBase` object to `permission_widget.request()`

---

## 7. Dependencies

- Existing `Bubble.allow_network` support (already implemented)
- Standard XDG data directory location (`~/.local/share/ollmchat/playground`)

---

## 8. Testing

### Playground
- [ ] Verify playground directory is created if missing
- [ ] Verify playground is mounted as `$HOME/playground` (user's home directory) in sandbox
- [ ] Verify playground is writable in sandbox
- [ ] Test creating files in playground
- [ ] Test files persist after command execution

### Working Directory
- [ ] Test default working directory (project directory)
- [ ] Test specifying project directory explicitly (absolute path)
- [ ] Test specifying playground directory with absolute path `$HOME/playground` (user's home directory)
- [ ] Test "playground" normalization to `$HOME/playground` (user's home directory)
- [ ] Test non-existent working directory - should return "ERROR: Working directory does not exist: {path}"
- [ ] Test with subprocess fallback (no bubblewrap)
- [ ] Verify error messages are returned in standard format (starting with "ERROR:")
- [ ] Verify bubblewrap permissions restrict write access to project/playground only

### Network Parameter
- [ ] Test network blocked by default (no network parameter)
- [ ] Test network access with permission granted
- [ ] Test network access with permission denied
- [ ] Verify network requests are never cached (always ask)
- [ ] Test with various network commands (curl, wget, git clone, etc.)

---

## 9. Open Points

- Playground cleanup and size reporting will be handled in a future enhancement to tool configuration (see 1.3.5 Future Considerations: Tool-Specific Settings UI Extensions).
- Working directory validation: We validate that the directory exists and error out if it doesn't. Otherwise, we allow the tool to run in any directory because bubblewrap permissions already enforce access restrictions (read-write only for project and playground, read-only for everything else).

---

## 10. Summary

This plan adds:
1. **Playground directory** - A dedicated writable space at `$HOME/playground` (user's home directory) for agent experiments
2. **Working directory parameter** - Allows LLM to specify where commands execute
3. **Comprehensive documentation** - Clear explanation of file system permissions and network access
4. **Network parameter with special handling** - Network access requires approval every time, never cached

All changes maintain backward compatibility (defaults preserve existing behavior) while adding new capabilities for the LLM to use.

**Note:** The playground directory is mounted at `$HOME/playground` where `$HOME` is the user's home directory (obtained via `GLib.Environment.get_home_dir()`). The actual path may vary by system (e.g., `/home/username` on Linux, `/Users/username` on macOS).
