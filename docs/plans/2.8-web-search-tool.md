# 2.8. Web Search Tool

## Overview

Implementation of GoogleSearchTool for performing web searches using Google Custom Search API.

## Status

⚠️ **MOSTLY DONE** - Implementation complete, but pending tool settings configuration integration.

## TODO

**PENDING: Tool Settings Configuration Integration**

The Google Search Tool currently uses a temporary config file at `~/.config/ollmchat/google.json`. This needs to be integrated with the main tool settings configuration system when that is implemented. The config should be moved from the standalone JSON file to the unified settings system.

## Implementation Details

### Features
- Use Google Custom Search API for web searches
- Parse JSON search results and convert to markdown format
- API integration using Google Custom Search API
- **Configuration**
  - Config file location: `~/.config/ollmchat/google.json`
  - Config file format:
    ```json
    {
      "api_key": "YOUR_API_KEY",
      "engine_id": "YOUR_SEARCH_ENGINE_ID"
    }
    ```
  - Need a simple config holder class `GoogleSearchConfig` to deserialize the JSON
  - Follow the same pattern as `Config1`/`Config2` (Json.Serializable, static `load()` method, `loaded` property)
- **Google Custom Search API**
  - Endpoint: `https://www.googleapis.com/customsearch/v1?key=YOUR_API_KEY&cx=YOUR_SEARCH_ENGINE_ID&q=QUERY&start=INDEX`
  - Returns JSON containing:
    - `totalResults` (total number of results)
```vala
using GLib;
using Gee;

public class ResultItem : Object, Json.Serializable {
    public string title { get; set; default = ""; }
    public string snippet { get; set; default = ""; }
    public string link { get; set; default = ""; }

    public ResultItem () {
    }

    public unowned ParamSpec? find_property(string name) {
        return this.get_class().find_property(name);
    }

    public new void Json.Serializable.set_property(ParamSpec pspec, Value value) {
        base.set_property(pspec.get_name(), value);
    }

    public new Value Json.Serializable.get_property(ParamSpec pspec) {
        Value val = Value(pspec.value_type);
        base.get_property(pspec.get_name(), ref val);
        return val;
    }

    public override Json.Node serialize_property(string property_name, Value value, ParamSpec pspec) {
        return default_serialize_property(property_name, value, pspec);
    }

    public override bool deserialize_property(string property_name, out Value value, ParamSpec pspec, Json.Node property_node) {
        return default_deserialize_property(property_name, out value, pspec, property_node);
    }

    public string to_markdown () {
        // Returns markdown for a single result item
        return "### [" + title + "](" + link + ")\n" + snippet + "\n";
    }
}

public class Result : Object, Json.Serializable {
    public int total_results { get; set; default = 0; }
    public ArrayList<ResultItem> items { get; set; default = new ArrayList<ResultItem>(); }

    public Result () {
    }

    public unowned ParamSpec? find_property(string name) {
        return this.get_class().find_property(name);
    }

    public new void Json.Serializable.set_property(ParamSpec pspec, Value value) {
        base.set_property(pspec.get_name(), value);
    }

    public new Value Json.Serializable.get_property(ParamSpec pspec) {
        Value val = Value(pspec.value_type);
        base.get_property(pspec.get_name(), ref val);
        return val;
    }

    public override Json.Node serialize_property(string property_name, Value value, ParamSpec pspec) {
        return default_serialize_property(property_name, value, pspec);
    }

    public override bool deserialize_property(string property_name, out Value value, ParamSpec pspec, Json.Node property_node) {
        // Handle "totalResults" from JSON (camelCase) mapping to "total_results" (snake_case)
        if (property_name == "totalResults") {
            value = Value(typeof(int));
            value.set_int((int)property_node.get_int());
            this.total_results = (int)property_node.get_int();
            return true;
        }
        
        // Handle "items" array deserialization
        if (property_name == "items") {
            this.items.clear();
            if (property_node.get_node_type() == Json.NodeType.ARRAY) {
                var json_array = property_node.get_array();
                for (uint i = 0; i < json_array.get_length(); i++) {
                    var element_node = json_array.get_element(i);
                    var item = Json.gobject_deserialize(typeof(ResultItem), element_node) as ResultItem;
                    if (item != null) {
                        this.items.add(item);
                    }
                }
            }
            value = Value(typeof(ArrayList));
            value.set_object(this.items);
            return true;
        }
        
        return default_deserialize_property(property_name, out value, pspec, property_node);
    }

    public string to_markdown () {
        var result = "**Total results:** " + total_results.to_string() + "\n\n";
        foreach (var item in items) {
            result += item.to_markdown ();
        }
        return result;
    }
}
```

### Files
- ✅ `liboctools/GoogleSearchTool.vala` (created, namespace: `OLLMtools`) - Tool class extending `OLLMchat.Tool.Interface` (defines schema: name, description, parameter_description)
- ✅ `liboctools/GoogleSearchRequest.vala` (created, namespace: `OLLMtools`) - Request class extending `OLLMchat.Tool.RequestBase` (handles execution, permissions, etc.)
- ✅ `liboctools/GoogleSearchConfig.vala` (created, namespace: `OLLMtools`) - Config class for deserializing Google API credentials

### Implementation Notes

- **totalResults extraction**: The `totalResults` value is extracted from `searchInformation.totalResults` in the JSON response (as a string) and parsed to an integer after deserialization.
- **Message formatting**: Request and response messages follow the same format as codebase search tool:
  - Request: ````txt Google Search request for {query}`
  - Response: ````markdown Google Search reply\n{markdown}`
- **Config loading**: Currently uses temporary config file at `~/.config/ollmchat/google.json`. This will be integrated with the main tool settings configuration system.

### Testing
- ✅ Added to meson.build
- ✅ Registered in ollmchat/Window.vala
- ⏳ Test with PermissionProviderDummy (pending)
