# 1.3.9. Agent Configuration and Window State

## Overview

Implement agent configuration system in Config2, similar to how tools are configured. This includes:
1. Adding `agents` HashMap property to Config2 (similar to `tools`)
2. Creating BaseAgentConfig class (similar to BaseToolConfig)
3. Agent registration system that registers config types with Config2
4. Settings dialog page for managing agent configurations
5. For code-assistant agent (Osea Coda): Store window state (open project, open file) in agent config instead of using `is_active` flags in file system

## Status

‚è≥ **TODO** - Not implemented yet.

## Related Plans

- **1.3** - Configuration Overview (see 1.3-DONE-configuration-overview.md)
- **1.3.2** - Configuration Interface (see done/1.3.2-DONE-configuration-interface.md)
- **1.3.5** - Tools Page and Tool Configuration (reference for implementation pattern)
- **1.7** - Agent Management System (agent selector UI, multiple agents)

## Settings Dialog Location

Settings dialogues are located in `ollmapp/SettingsDialog/`:
- **MainDialog.vala** - Main settings dialog with ViewStack for tabs
- **SettingsPage.vala** - Base class for settings pages
- **ToolsPage.vala** - Reference implementation for tools configuration
- **ConnectionsPage.vala** - Reference implementation for connections
- **ModelsPage.vala** - Reference implementation for models

## Config2 Agents Property

### Implementation Pattern (Similar to Tools)

The `agents` property should follow the same pattern as `tools`:

1. **Config2 Property**:
   ```vala
   public Gee.Map<string, BaseAgentConfig> agents { get; set; default = new Gee.HashMap<string, BaseAgentConfig>(); }
   public Gee.Map<string, Json.Node> agents_unregistered { get; set; default = new Gee.HashMap<string, Json.Node>(); }
   ```

2. **Static Registry**:
   ```vala
   private static Gee.HashMap<string, Type>? agents_types = null;
   ```

3. **Registration Method**:
   ```vala
   public static void register_agent_type(string agent_name, Type gtype)
   ```

4. **Serialization/Deserialization**:
   - Similar to `tools` property in Config2
   - Handles both registered and unregistered agent config types
   - Stores unregistered types as Json.Node for later serialization

### BaseAgentConfig Class

Create `libollmchat/Settings/BaseAgentConfig.vala`:

- Base class for all agent configurations (similar to `BaseToolConfig`)
- Implements `Json.Serializable`
- Simple agents can use this directly
- Complex agents (like code-assistant) extend this class

### Agent Registration Pattern

Agents should register their config type when they are registered, similar to how tools work:

1. **Agent Factory Registration**:
   - When an agent factory is created/registered, it should call `setup_agent_config(config)`
   - This creates default config if it doesn't exist in `config.agents`

2. **Config Type Registration**:
   - Agents should register their config GType with `Config2.register_agent_type(agent_name, config_gtype)`
   - This happens during application initialization (Phase 1: before loading config)

3. **Setup Method**:
   ```vala
   public virtual void setup_agent_config(Settings.Config2 config)
   {
       if (config.agents.has_key(this.name)) {
           return;
       }
       config.agents.set(this.name, Object.new(this.config_class()) as Settings.BaseAgentConfig);
   }
   ```

## Code-Assistant Agent Configuration

### Current Problem

Currently, the code-assistant agent (Osea Coda) stores "executive stuff" (window state: open project, open file) in the file system using `is_active` flags:
- Projects have `is_active` boolean flag in database
- Files have `is_active` boolean flag in database
- `ProjectManager.restore_active_state()` finds active project/file using `is_active` flags
- This approach doesn't scale to multiple windows/agents

### Solution: Store Window State in Agent Config

For the code-assistant agent, we need to store window state in the agent configuration:

1. **Agent Config Structure**:
   ```vala
   public class CodeAssistantConfig : BaseAgentConfig
   {
       public Gee.HashMap<string, WindowState> windows { get; set; default = new Gee.HashMap<string, WindowState>(); }
   }
   
   public class WindowState : Object, Json.Serializable
   {
       public string window_id { get; set; }
       public string? open_project_path { get; set; default = null; }
       public string? open_file_path { get; set; default = null; }
       public int window_width { get; set; default = 0; }
       public int window_height { get; set; default = 0; }
       // Note: Window position storage may be added later
       // Wayland doesn't support window position well, may require GNOME Shell extension
   }
   ```

2. **Window State Management**:
   - Each window has a unique ID and its own state (open project, open file, dimensions)
   - Windows are stored in a HashMap keyed by window ID for easy lookup
   - When a window opens a project/file, save to agent config using window ID as key
   - When restoring, use agent config (lookup by window ID) instead of `is_active` flags

3. **Migration from `is_active`**:
   - Need to find all locations where `is_active` is used for projects/files
   - Replace with config-based approach
   - See "Locations to Update" section below

### Restoring Project and File State

When the agent is initialized or when switching to the code-assistant agent, we need to restore the previously active project and file. This includes:

1. **Restoring the active project** - The project that was open in the previous session
2. **Restoring the active file** - The file that was open within that project
3. **Restoring cursor position** - The line number where the cursor was positioned
4. **Restoring scroll position** - The scroll position in the editor

#### Current Implementation (Using `is_active` flags)

Currently, the restoration process works as follows:

**Initialization Flow**:
1. `AgentFactory.initialize_widget()` calls:
   - `load_projects_from_db()` - loads projects from database (project has `is_active = true` from previous session)
   - `restore_active_state()` - finds project with `is_active = true`, calls `activate_project()` which:
     - Sets `this.active_project = project`
     - Resets `is_active = false` in memory to force fresh activation
     - Calls `activate_project()` which sets `is_active = true`, saves to DB, and emits `active_project_changed` signal
   - `apply_manager_state()` - applies UI state from manager properties:
     - Updates project dropdown placeholder
     - Updates file dropdown's project
     - Opens the active file (if any) which restores cursor/scroll position

**ProjectManager.restore_active_state()**:
```vala
public async void restore_active_state()
{
    // Find active project using ProjectList internal method
    // This requires is_active = true to find the project
    var project = this.projects.get_active_project();
    if (project == null) {
        // Reset is_active for all projects if no active project found
        // (in case multiple projects were marked active in database)
        foreach (var other_project in this.projects.project_map.values) {
            if (other_project.is_project && other_project.is_active) {
                other_project.is_active = false;
                other_project.saveToDB(this.db, null, false);
                this.db.is_dirty = true;
            }
        }
        return;
    }
    
    // Reset is_active to false in memory to force fresh activation
    // activate_project() will set it back to true and save it, so no need to save here
    if (project.is_active) {
        project.is_active = false;
    }
    
    // This will set this.active_project, set is_active=true, save to DB, emit signal
    yield this.activate_project(project);
    
    // Find active file using ProjectFiles internal method
    var file = project.project_files.get_active_file();
    if (file != null) {
        // This will set this.active_file, deactivate previous, update DB, emit signal
        yield this.activate_file(file);
    }
}
```

**SourceView.apply_manager_state()**:
```vala
public async void apply_manager_state()
{
    // Only apply UI state from manager properties - all data is already loaded
    // Use manager's active_project and active_file properties
    
    if (this.manager.active_project == null) {
        return;
    }
    
    // Check if we're already on the same project - if so, don't change active file
    bool same_project = (this.project_dropdown.selected_project != null && 
                         this.project_dropdown.selected_project.path == this.manager.active_project.path);
    
    // Project is already activated by restore_active_state(), just update UI
    // Update file dropdown's project
    this.file_dropdown.project = this.manager.active_project;
    
    // Update project dropdown placeholder only if it's different (avoid unnecessary updates)
    var expected_placeholder = this.manager.active_project.path_basename;
    if (this.project_dropdown.placeholder_text != expected_placeholder) {
        this.project_dropdown.placeholder_text = expected_placeholder;
    }
    
    // If we're switching to the same project, don't change the active file
    if (same_project) {
        return;
    }
    
    if (this.manager.active_file == null) {
        return;
    }
    
    // Open file (will restore cursor/scroll position from file.cursor_line, etc.)
    yield this.open_file(this.manager.active_file);
}
```

**Key Points**:
- `restore_active_state()` finds the active project using `is_active = true` flag, then resets it to `false` before calling `activate_project()` to ensure full activation with signal emission
- `apply_manager_state()` only handles UI updates - it doesn't modify database state
- File restoration happens via `open_file()` which reads cursor/scroll position from the file's properties
- The separation ensures: ProjectManager handles data/DB, SourceView handles UI

#### Future Implementation (Using Agent Config)

When migrating to agent config, the restoration process should:

1. Get the current window ID
2. Read window state from `CodeAssistantConfig.windows[window_id]` (lookup by window ID)
3. Find the project by path from `open_project_path`
4. Find the file by path from `open_file_path`
5. Activate project and file (same as current flow)
6. Restore cursor/scroll position from file properties
7. Restore window dimensions from `window_width` and `window_height`

### Locations to Update

Need to go through all locations where `is_active` or "use active" patterns are used:

1. **ProjectManager.vala**:
   - `restore_active_state()` - Currently uses `get_active_project()` which looks for `is_active = true`
   - `activate_project()` - Currently sets `is_active = true` in database
   - `activate_file()` - Currently sets `is_active = true` in database
   - Should instead read/write from agent config

2. **ProjectFiles.vala**:
   - `get_active_file()` - Currently looks for file with `is_active = true`
   - Should instead read from agent config

3. **ProjectList.vala**:
   - `get_active_project()` - Currently looks for project with `is_active = true`
   - Should instead read from agent config

4. **SourceView.vala**:
   - `apply_manager_state()` - Currently uses `manager.active_project` and `manager.active_file`
   - `initialize_widget()` - Calls `restore_active_state()` which uses `is_active`
   - Should instead restore from agent config

5. **AgentFactory.vala**:
   - `initialize_widget()` - Calls `restore_active_state()` which uses `is_active`
   - Should instead restore from agent config

6. **FileBase.vala**:
   - `is_active` property - May need to keep for backward compatibility, but primary storage should be in config

### Implementation Steps

1. **Create BaseAgentConfig**:
   - `libollmchat/Settings/BaseAgentConfig.vala`
   - Similar structure to `BaseToolConfig`

2. **Create CodeAssistantConfig**:
   - `libollmchat/Settings/CodeAssistantConfig.vala`
   - Extends `BaseAgentConfig`
   - Contains `windows` HashMap (keyed by window ID) with `WindowState` objects

3. **Add agents property to Config2**:
   - Add `agents` HashMap property
   - Add `agents_unregistered` HashMap property
   - Add `agents_types` static registry
   - Add `register_agent_type()` static method
   - Add serialization/deserialization logic (similar to `tools`)

4. **Update Agent Factory**:
   - Add `config_class()` abstract method (similar to tools)
   - Add `setup_agent_config()` method
   - Update code-assistant agent factory to register config type

5. **Update Application Initialization**:
   - Register agent config types before loading config (Phase 1)
   - Call `setup_agent_config()` for all registered agents

6. **Replace `is_active` Usage**:
   - Update `ProjectManager.restore_active_state()` to read from agent config
   - Update `ProjectManager.activate_project()` to write to agent config
   - Update `ProjectManager.activate_file()` to write to agent config
   - Update `ProjectFiles.get_active_file()` to read from agent config
   - Update `ProjectList.get_active_project()` to read from agent config

7. **Create AgentsPage**:
   - `ollmapp/SettingsDialog/AgentsPage.vala`
   - Similar structure to `ToolsPage.vala`
   - Uses `Adw.PreferencesPage` with `Adw.BoxedList`
   - Agent rows use `Adw.ExpanderRow` for inline editing

8. **Add Agents Tab to Settings Dialog**:
   - Update `ollmapp/SettingsDialog/MainDialog.vala`
   - Add AgentsPage to ViewStack
   - Add action widget to action bar area

## Agents Tab UI

**Purpose**: Manage agent configurations (add, edit, remove agents).

**Components**:
- **Horizontal Box (Action Bar)**: Top horizontal container with action buttons
  - **Add Agent Button**: Opens dialog for adding new agent configuration
  - **Adw.SearchBar**: Search bar for filtering agents (optional)
- **Adw.PreferencesGroup**: Contains the agent list
  - Wraps `Adw.BoxedList` for consistent styling
- **Agent List**: Uses `Adw.BoxedList` to display all agent configurations
  - Each agent uses `Adw.ExpanderRow` to show/edit agent details inline
  - Each agent shows: name, type, description (when collapsed)
  - When expanded: Shows editable form fields with Remove button at bottom
  - Editing is inline - no separate edit mode needed
- **Agent Details Panel**: Uses `Adw.ExpanderRow` - inline editable form for agent properties
  - Settings widgets are added as children to the `Adw.ExpanderRow` using `add_row()`
  - Uses `Adw.ActionRow` with suffix widgets for form fields
  - Name: Agent name/identifier (Gtk.Entry as suffix)
  - Type: Agent type (e.g., "Code Assistant", "Just Ask") (Gtk.DropDown as suffix)
  - Description: Agent description (Gtk.Entry as suffix)
  - Model: Default model for this agent (Gtk.DropDown as suffix)
  - Tools: Enabled tools for this agent (multi-select widget)
  - **Action Buttons** (shown at bottom, in Gtk.Box):
    - **Remove Button** (red, left side): Removes agent from configuration
    - **Save Button** (green/blue, right side): Saves agent configuration

**Data Source**: `Config2.agents` (Gee.Map<string, BaseAgentConfig>)

## Implementation Details

### Files to Create

**BaseAgentConfig**
- **Location**: `libollmchat/Settings/BaseAgentConfig.vala`
- **Purpose**: Base configuration class for agents
- **Structure**: Similar to `BaseToolConfig.vala`

**CodeAssistantConfig**
- **Location**: `libollmchat/Settings/CodeAssistantConfig.vala`
- **Purpose**: Configuration for code-assistant agent
- **Properties**:
  - `windows` (Gee.HashMap<string, WindowState>) - Map of window states keyed by window ID

**WindowState**
- **Location**: `libollmchat/Settings/WindowState.vala` (or in CodeAssistantConfig.vala)
- **Purpose**: Stores window state (open project, open file, window dimensions)
- **Properties**:
  - `window_id` (string) - Unique identifier for the window
  - `open_project_path` (string?) - Path to open project
  - `open_file_path` (string?) - Path to open file
  - `window_width` (int) - Window width in pixels
  - `window_height` (int) - Window height in pixels
  - **Note**: Window position storage may be added later (Wayland limitations may require GNOME Shell extension)

**AgentsPage**
- **Location**: `ollmapp/SettingsDialog/AgentsPage.vala`
- **UI Framework**: Uses `Adw.PreferencesPage` with:
  - Horizontal box at top containing Add Agent button and optional search bar
  - `Adw.PreferencesGroup` wrapping `Adw.BoxedList` for agent list
  - Agent rows use `Adw.ExpanderRow` for expandable agent settings panels
  - Settings widgets added to `Adw.ExpanderRow` via `add_row()` method
  - See [Adw.ExpanderRow documentation](https://valadoc.org/libadwaita-1/Adw.ExpanderRow.html)
- **Purpose**: Agents tab content
- **Properties**:
  - `settings_dialog` (MainDialog) - Reference to parent MainDialog (which has the config object)
- **Methods**:
  - `add_agent()` - Opens dialog for adding new agent
  - `remove_agent(string agent_id)` - Removes agent from `config.agents` map
  - `render_agents()` - Creates UI entries from `config.agents` map
  - `add_agent_row(string agent_id, BaseAgentConfig agent)` - Creates expandable row for an agent with form fields

### Files to Modify

- `libollmchat/Settings/Config2.vala`:
  - Add `agents` HashMap property
  - Add `agents_unregistered` HashMap property
  - Add `agents_types` static registry
  - Add `register_agent_type()` static method
  - Add serialization/deserialization logic for `agents` property

- `libollmchat/Agent/Factory.vala`:
  - Add abstract `config_class()` method
  - Add `setup_agent_config()` method (similar to `setup_tool_config()`)
  - Add static `setup_all_agent_configs()` method

- `liboccoder/AgentFactory.vala`:
  - Override `config_class()` to return `typeof(CodeAssistantConfig)`
  - Register config type in application initialization

- `libocfiles/ProjectManager.vala`:
  - Update `restore_active_state()` to read from agent config instead of `is_active`
  - Update `activate_project()` to write to agent config instead of `is_active`
  - Update `activate_file()` to write to agent config instead of `is_active`

- `libocfiles/ProjectFiles.vala`:
  - Update `get_active_file()` to read from agent config instead of `is_active`

- `libocfiles/ProjectList.vala`:
  - Update `get_active_project()` to read from agent config instead of `is_active`

- `liboccoder/SourceView.vala`:
  - Update `apply_manager_state()` to use agent config
  - Update `initialize_widget()` to restore from agent config

- `ollmapp/SettingsDialog/MainDialog.vala`:
  - Add AgentsPage to ViewStack
  - Add action widget to action bar area

- `ollmapp/Application.vala`:
  - Register agent config types before loading config (Phase 1)
  - Call `setup_all_agent_configs()` after config is loaded

## Integration Points

- **Config2**: Agent configurations stored in `Config2.agents` map
- **SettingsDialog**: Main dialog window that contains the Agents tab
- **Agent Management**: Integrates with agent system from plan 1.7
- **ProjectManager**: Uses agent config for window state instead of `is_active` flags

## Future Considerations

- **Agent Templates**: Pre-defined agent templates for common use cases
- **Agent Import/Export**: Share agent configurations between installations
- **Agent Presets**: Quick switching between agent configurations
- **Multiple Windows**: Support for multiple windows with separate state per window
