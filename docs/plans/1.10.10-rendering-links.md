# Rendering of links (1.10.10)

- **Goal:** Render parsed links (from plan 1.10.9) as styled text showing the **link text**, store the **URL** on the tag, and handle click (open URL) and hover (e.g. tooltip).
- **Current:** **libocmarkdowngtk/Render.vala** `on_a()` adds a state with blue + underline but then immediately adds the **href** as text and closes the state. So the link text is wrong and the URL is not stored for events.

**Status: open.**

---

## Prerequisite

- Plan 1.10.9 (parser of links) must emit `on_a(true, href, title, is_reference)`, `on_text(link_text)`, `on_a(false, ...)`. When **is_reference** is true, **href** is the reference label; the renderer (or consumer) resolves it to a URL if it has link reference definitions, then stores/opens that URL.

---

## Target behaviour

- On `on_a(true, href, title, is_reference)`: if **is_reference** is true, resolve **href** (ref label) to a URL using link reference definitions if available. Open a link state (styled: e.g. blue, underline), and **associate this state’s tag with the URL** so we can resolve it on click/hover. Do **not** add href as text; do not close the state.
- The following `on_text(link_text)` will be rendered inside this state (so the user sees the link text).
- On `on_a(false, ...)`: close the link state as today.

---

## Storing the URL on the tag

- **Option A:** In **Render**, keep a `Gee.HashMap<Gtk.TextTag, string>` (e.g. `link_url_by_tag`). When we create the link state in `on_a(true, href, ...)`, after `add_state()` do `link_url_by_tag[link_state.style] = href`. Event handlers can then look up the tag under the cursor in this map.
- **Option B:** Use `Gtk.TextTag` custom data (e.g. `tag.set_data("href", href)`) if available in Vala/GTK4; otherwise Option A is simpler and avoids binding quirks.

**Recommendation:** **Option A** — Render holds `Gee.HashMap<unowned Gtk.TextTag, string> link_url_by_tag` (or similar), register in `on_a(true, ...)`, and do not remove when the state closes (the tag remains applied to a range). Clear or prune the map only when the buffer/widget is destroyed or when a full re-render happens, as appropriate.

---

## Event handling: click and hover

**Where:** The widget that actually displays the text must handle events. That is either:

- The **Gtk.Box** that holds the TextViews (Render’s `box`), with logic to find which child TextView received the event and the position in that view, or
- **Each Gtk.TextView** created by Render (in `create_textview()` and anywhere table cells get a TextView).

**Click (open link):** On `button-release-event` (or similar), get the event coordinates, convert to buffer coordinates (e.g. `get_iter_at_position` / `get_iter_at_location`), get the list of tags at that iter, and for each tag check whether it is in `link_url_by_tag`. If so, open the URL (e.g. `Gtk.show_uri()` or app-specific handler) and stop.

**Hover (show URL):** On `motion-notify-event`, get the iter at the pointer, look up tags in `link_url_by_tag`. If one is a link tag, set the widget tooltip to the URL (or “Open: &lt;url&gt;”); otherwise clear or set default tooltip. So the handler must be on the same widget that has the buffer (the TextView), or the box must delegate to the correct child and set tooltip on the appropriate widget.

Prefer connecting **per TextView** in Render when creating each TextView (and each table-cell TextView): connect `button-release-event` and `motion-notify-event`. The handler has direct access to that view’s buffer and can use Render’s `link_url_by_tag` to resolve tags. Render must expose or use `link_url_by_tag` in these handlers (e.g. pass Render reference or store it where the handler can read it). If the box is the only place we can attach signals (e.g. for dynamically added children), the box’s handler must find the child at the event coordinates and forward to the same logic using that child’s buffer.

**Cursor:** Optionally set the cursor to a “pointer” when over a link (same tag lookup); reset when not over a link.

---

## Summary

| Component | Change |
|-----------|--------|
| **libocmarkdowngtk/Render.vala** | Add `Gee.HashMap<unowned Gtk.TextTag, string> link_url_by_tag`. In `on_a(true, href, ...)`: add link state (blue, underline), register `link_url_by_tag[link_state.style] = href`; do not add href as text or close state. In `on_a(false, ...)`: only close state. When creating each TextView (and table cell TextView), connect `button-release-event` and `motion-notify-event` to a handler that gets iter at position, looks up tags in `link_url_by_tag`, and on click opens the URL (e.g. `Gtk.show_uri`), on motion sets/clears tooltip and optionally cursor. |

---

## Verification

- Manual or automated test: input `[OpenAI](https://openai.com)` and confirm the visible text is “OpenAI”, styled (e.g. blue, underline), and that click opens the URL and hover shows it (e.g. tooltip).
- Test with title: `[text](url "title")` and ensure title is handled (stored if needed; tooltip can show title or URL as desired).

---

## Dependencies

- Plan 1.10.9 (parser of links) must be done first so that `on_a` and `on_text` are emitted correctly.
