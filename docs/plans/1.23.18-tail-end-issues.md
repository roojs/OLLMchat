# 1.23.18 Tail-end issues — remaining tasks

**Parent:** 1.23.18. **Source:** Moved from 1.23.14-outstanding (remaining work after §1–6 and reference resolution are done).

**Coding standards:** `.cursor/rules/CODING_STANDARDS.md`.

---

## 1. Task naming and output references (critical)

- **When:** On initial task list creation and whenever the task list is later updated.
- **Assign a name to each task.** Normal format: **skill_name + " " + number** (e.g. `MySkill 1`, `MySkill 2`). Store on task (e.g. Details) so it is stable and referrable.
- **Output reference format:** To refer to a task's output we use **`#{slug}-{number}-results`** where:
  - **slug** = skill name with non-ascii replaced by `-` and lowercased (e.g. "My Skill" → `my-skill`).
  - **number** = task index/number (same as in task name).
  - Example: `#my-skill-1-results`, `#my-skill-2-results`.
- This is the **'output'** reference we use: when References say `output:…` or a ref points at another task's results, the target is this anchor. **reference_content** (or the resolver) must resolve `#slug-number-results` to that task's result content (e.g. from user_request or stored task outputs).

---

## 2. validate_reference_targets — #anchor validation

- **validate_reference_targets()** (Details): Currently validates href forms (#, output:, http, absolute path exists); does not fetch content.
- **FIXME:** Validate #anchor format and existence (e.g. anchor present in user_request or known task-output anchors).

---

## 3. validate_task_list_reference_lengths (low priority)

- **Runner method.** Per-task resolved reference content length (same as Details); if any over max return issues string. send_async would append to parser.issues and retry. Deferred from main 1.23.14 flow.

---

## 4. Naming / other

- List: **run_until_user_approval** (line 105) → align with plan **run_until_writer**; add **has_writer_tasks** (or has_tasks_requiring_approval per 1.23.14-existing-skill-code-updates).
- PromptTemplate, Factory, Manager, Definition, prompt format: per 1.23.14 main plan and 1.23.17.

---

## 5. project_description (low priority)

- **task_creation** and **Details.refine()** currently pass **project_description** as `""`. When OLLMfiles.Folder (or active_project) has a summary/catalog API, fill from active_project; see 1.23.14-existing-skill-code-updates (task_creation sample).

---

## 6. Markdown block types in output

- **Markdown blocks we output need types** (e.g. markdown vs code, and code language when applicable). Ensure generated content uses explicit block types (e.g. fenced code with language tag, or explicit markdown vs code) so rendering and tooling can handle them correctly.

---

## 7. Task list iteration — code vs prompts (policy)

- **Policy:** Only **prompts** (e.g. `resources/skill-prompts/*.md`) and **filename references** to them (gresources, docs, template keys) are modified unless code changes are explicitly requested or added to this plan.
- **Current state:** Prompt file is **task_list_iteration.md**; Runner calls **run_task_list_iteration()** as a stub after each round. Implementation is specified in §8 below.

---

## 8. Task list iteration — implementation (to implement)

Implement **run_task_list_iteration()** and supporting types so that after each round of task execution the Runner sends the current task list (with completed outputs in precursor) to the LLM using **task_list_iteration.md**, then replaces **this.task_list** with the parsed response.

**List (Task/List.vala):**
- Add properties: **original_prompt_md**, **goals_summary_md**, **general_information_md** (strings, default ""). Used when serialising the list for the iteration prompt.
- Add **to_markdown()**: returns full task list as markdown — lead sections (original_prompt_md, goals_summary_md, general_information_md) then `## Tasks` then for each step `### Task section N` and each task’s line (use Details method below). Used as **current_task_list** in the prompt.

**ResultParser (Task/ResultParser.vala):**
- In **parse_task_list()**, after building steps and adding them to task_list, set:
  - `task_list.original_prompt_md = document.headings.get("original-prompt").to_markdown_with_content();`
  - `task_list.goals_summary_md = document.headings.get("goals-summary").to_markdown_with_content();`
  - `task_list.general_information_md = document.headings.get("general-information-for-all-tasks").to_markdown_with_content();`

**Details (Task/Details.vala):**
- Add **to_markdown_for_list()**: returns task as bullet list (same as coarse_task_markdown: What is needed, Skill, References, Expected output). When **exec_done** and **result** non-empty, append `\n- **Output** — ` plus result as a single line (e.g. result.strip().replace("\n", " ")). Used by List.to_markdown().

**Runner (Skill/Runner.vala) — run_task_list_iteration():**
- If **this.task_list == null** return.
- Build **precursor_with_completed_outputs**: for each task in task_list (steps → children) where **exec_done** and **result != ""**, append a headed block e.g. `### Completed task output N` and the task result text.
- Load template **task_list_iteration.md**; fill: **skill_catalog**, **current_task_list** (header "Current task list" + task_list.to_markdown(), no code block), **environment**, **project_description** (""), **precursor_with_completed_outputs** (header "Outputs from completed tasks" when non-empty), **previous_proposal_issues** (header "Issues with the tasks" when non-empty).
- Send system + user messages; get response; **ResultParser(this, response).parse_task_list()**; if **parser.issues == ""** and **parser.task_list.validate_skills() == ""**, set **this.task_list = parser.task_list** and return.
- Otherwise set previous_proposal_issues = parser.issues and retry (e.g. up to 5 times). On final failure add_message "Task list iteration: could not get valid task list after 5 tries."
