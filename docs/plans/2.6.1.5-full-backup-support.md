# 2.6.1.5. Full Backup Support

## Overview

Implement full backup support using the same system as the edit file tool. Create backups for modified and deleted files, update ProjectManager file data, and handle file metadata.

## Status

â³ **PLANNING** - Design phase.

## Prerequisites

- Phase 1 (2.6.1.1) must be completed
- Phase 2 (2.6.1.2) must be completed
- Phase 3 (2.6.1.3) must be completed
- Phase 4 (2.6.1.4) must be completed
- See main plan: `2.6.1-code-exec-improvements.md` for backup system details

## Goals

1. Create backups for modified and deleted files (same system as edit file tool)
2. Update ProjectManager file data for all changed files
3. Handle file metadata (last_modified, last_approved_copy_path, etc.)
4. Integrate with ProjectManager database

## Implementation Details

### Files to Modify

- `liboctools/RunCommand/Request.vala` - Add backup creation and ProjectManager integration
- Pass ProjectManager instance to tool execution system

### Backup System

- **Use same backup system as edit file tool**: `~/.cache/ollmchat/edited/`
- **Same storage format**: `{id}-{date YY-MM-DD}-{basename}`
- **Same logic**: Replicate `FileBuffer.create_backup_if_needed()` behavior
- **Backup rules**:
  - Only for files in database (id > 0)
  - One backup per file per day (skips if backup exists for today)
  - Backup path stored in `file.last_approved_copy_path`

### Post-execution Processing

1. **For modified files**:
   - Get File object from ProjectManager (must be in database, id > 0)
   - Copy original file (from overlay lower directory) to backup location
   - Create backup using same logic as `FileBuffer.create_backup_if_needed()`
   - Set `file.last_approved_copy_path` to backup path
   - Copy modified file from overlay upper directory to project directory
   - Update file metadata (last_modified, etc.)
   - Save File entry to database via `file.saveToDB()`

2. **For new files**:
   - Create File entry in ProjectManager file_cache
   - Save File entry to database first (to get id > 0)
   - No backup needed (file didn't exist before), set `last_approved_copy_path` to empty string
   - Copy new file from overlay upper directory to project directory
   - Handle directory creation if needed
   - Save File entry to database via `file.saveToDB()`

3. **For deleted files**:
   - Get File object from ProjectManager (must be in database, id > 0)
   - Copy original file (from overlay lower directory) to backup location
   - Create backup using same logic as `FileBuffer.create_backup_if_needed()`
   - Set `file.last_approved_copy_path` to backup path
   - Set `file.is_deleted = true` to mark file as deleted
   - Remove file from project directory (if it exists)
   - Update file metadata, save to database
   - Keep File record in database (do NOT remove)

## Implementation Tasks

- [ ] Implement pre-execution baseline:
  - [ ] Initialize inotify monitor on overlay upper directory (starts empty)
  - [ ] **Note**: Do NOT create backups before execution - backups created after execution for modified files only
- [ ] Implement post-execution change processing:
  - [ ] Map overlay paths to project paths
  - [ ] For modified files: Create backup, copy to live system, update ProjectManager
  - [ ] For new files: Create File entry, copy to live system, update ProjectManager
  - [ ] For deleted files: Create backup, set is_deleted flag, remove from live system, update ProjectManager
  - [ ] Save all file changes to database via ProjectManager
  - [ ] Verify `last_approved_copy_path` is set correctly (uses same format as edit file tool)
- [ ] Pass ProjectManager instance to tool execution system
- [ ] Generate change reports
- [ ] Include changes in tool response
- [ ] Verify backups are created using same system as edit file tool (`~/.cache/ollmchat/edited/`)

## Testing

- Test backup creation for modified files
- Test backup creation for deleted files
- Test ProjectManager file data updates
- Test file metadata updates
- Test database persistence
- Verify backups use same format as edit file tool

## Notes

- Uses exact same backup system as `FileBuffer.write()` in edit file tool
- Backups cleaned up by `ProjectManager.cleanup_old_backups()` (files older than 7 days)
- File scanner updates (is_deleted flag) will be added in Phase 6

