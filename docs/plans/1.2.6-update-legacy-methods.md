# 1.2.6. Update Legacy Methods and Maintain Backward Compatibility

## Overview

Update Client convenience methods (`chat()`, `embed()`, `generate()`) to work with the new architecture while maintaining backward compatibility where possible.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

‚è≥ **TODO** - Refactoring needed.

## Goal

Ensure Client convenience methods still work for simple use cases, but use the new architecture internally (Connection, explicit properties, etc.).

## Methods to Update

### 1. Client.chat(string)

**Current**:
```vala
public async Response.Chat chat(string text, GLib.Cancellable? cancellable = null) throws Error
{
    var call = new Call.Chat(this, this.model) {
        cancellable = cancellable
    };
    // ... rest of implementation
}
```

**New**:
```vala
public async Response.Chat chat(string text, string? model = null, GLib.Cancellable? cancellable = null) throws Error
{
    // Get model from parameter, config, or default
    var chat_model = model ?? get_model_from_config() ?? "llama3.2";
    
    // Get options from config
    var options = get_options_from_config(chat_model);
    
    // Create Chat with Connection
    var call = new Call.Chat(this.connection, chat_model, options) {
        cancellable = cancellable,
        stream = true  // Or get from config
    };
    
    // Create dummy user-sent Message with original text
    var user_sent_msg = new Message(call, "user-sent", text);
    // Note: No signal emission - caller handles state
    
    // Set chat_content to user text
    call.chat_content = text;
    
    // Prepare messages array for API request
    call.messages.add(new Message(call, "user", call.chat_content));
    
    var result = yield call.send();
    return result;
}
```

**Changes**:
- Takes `Connection` instead of `Client`
- Gets `model` from parameter or config (no longer uses `this.model`)
- Gets `options` from config (no longer uses `this.options`)
- Creates Chat with explicit properties
- No signal emissions for `message_created` or `chat_send`

### 2. Client.embed(string)

**Current**:
```vala
public async Response.Embed embed(
    string input,
    int dimensions = -1,
    bool truncate = false,
    GLib.Cancellable? cancellable = null
) throws Error
{
    var call = new Call.Embed(this, this.model) {
        dimensions = dimensions,
        truncate = truncate,
        cancellable = cancellable
    };
    // ... rest of implementation
}
```

**New**:
```vala
public async Response.Embed embed(
    string model,
    string input,
    int dimensions = -1,
    bool truncate = false,
    GLib.Cancellable? cancellable = null
) throws Error
{
    // Get options from config
    var options = get_options_from_config(model);
    
    // Create Embed with Connection
    var call = new Call.Embed(this.connection, model, options) {
        dimensions = dimensions,
        truncate = truncate,
        cancellable = cancellable
    };
    
    call.input = input;
    var result = yield call.exec_embed();
    return result;
}
```

**Changes**:
- Added `model` parameter (required, no longer uses `this.model`)
- Takes `Connection` instead of `Client`
- Gets `options` from config

### 3. Client.embed_array()

**Current**:
```vala
public async Response.Embed embed_array(
    Gee.ArrayList<string> input_array,
    int dimensions = -1,
    bool truncate = false,
    GLib.Cancellable? cancellable = null
) throws Error
{
    var call = new Call.Embed(this, this.model) {
        dimensions = dimensions,
        truncate = truncate,
        cancellable = cancellable
    };
    // ... rest of implementation
}
```

**New**: Same pattern as `embed()` - add `model` parameter.

### 4. Client.generate(string)

**Current**:
```vala
public async Response.Generate generate(
    string prompt,
    string system = "",
    GLib.Cancellable? cancellable = null
) throws Error
{
    var call = new Call.Generate(this) {
        cancellable = cancellable
    };
    // ... rest of implementation
}
```

**New**:
```vala
public async Response.Generate generate(
    string model,
    string prompt,
    string system = "",
    GLib.Cancellable? cancellable = null
) throws Error
{
    // Get options from config
    var options = get_options_from_config(model);
    
    // Create Generate with Connection
    var call = new Call.Generate(this.connection, model, options) {
        cancellable = cancellable,
        stream = true  // Or get from config
    };
    
    call.prompt = prompt;
    call.system = system;
    var result = yield call.exec_generate();
    return result;
}
```

**Changes**:
- Added `model` parameter (required)
- Takes `Connection` instead of `Client`
- Gets `options` from config
- Sets properties explicitly

## Helper Functions Needed

Create helper functions in Client or Config2:

```vala
// In Client or Config2
private string? get_model_from_config() {
    // Get default model from Config2 or return null
    if (this.config != null) {
        // Get from usage map or default
    }
    return null;
}

private Call.Options get_options_from_config(string model) {
    if (this.config != null && this.config.model_options.has_key(model)) {
        return this.config.model_options.get(model);
    }
    return new Call.Options();
}
```

## Backward Compatibility

### Breaking Changes

These are intentional breaking changes for cleaner API:
- `Client.chat()` now requires `model` parameter (or gets from config)
- `Client.embed()` now requires `model` parameter
- `Client.embed_array()` now requires `model` parameter
- `Client.generate()` now requires `model` parameter

### Migration Path

For code using these methods:
1. Update to pass `model` parameter explicitly
2. Or ensure Config2 has default model configured
3. Update to handle state directly (no signal dependencies)

## Files to Modify

### Client
- `libollmchat/Client.vala` - Update all convenience methods

### Config2 (if helper functions go there)
- `libollmchat/Settings/Config2.vala` - Add helper functions if needed

## Testing Checklist

- [ ] `Client.chat()` works with new signature
- [ ] `Client.embed()` works with new signature
- [ ] `Client.embed_array()` works with new signature
- [ ] `Client.generate()` works with new signature
- [ ] All methods use Connection internally
- [ ] All methods get model/options from config or parameters
- [ ] No signal emissions in convenience methods
- [ ] Backward compatibility maintained where possible

## Related Plans

- [1.2.1. Remove Configuration from Client](./1.2.1-remove-config-from-client.md)
- [1.2.3. Update Call.Base to Take Connection](./1.2.3-update-call-base-connection.md)
- [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md)

