# 1.2.6. Update Legacy Methods and Maintain Backward Compatibility

## Overview

Update Client convenience methods (`chat()`, `embed()`, `generate()`) to work with the new architecture while maintaining backward compatibility where possible.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

✅ **MOSTLY COMPLETE** - Core functionality migrated, minor improvements possible.

## Summary & Progress Checklist

### ✅ Completed Tasks

- [x] **Step 1.1: Client.chat() migrated** - Uses `this.connection`, gets model from config via `config.get_default_model()`, creates `Call.Chat` with Connection constructor
- [x] **Step 1.2: Client.embed() migrated** - Uses `this.connection`, gets model and options from config, creates `Call.Embed` with Connection constructor
- [x] **Step 1.3: Client.embed_array() migrated** - Uses `this.connection`, gets model and options from config, creates `Call.Embed` with Connection constructor
- [x] **Step 1.4: Client.generate() migrated** - Uses `this.connection`, gets model and options from config, creates `Call.Generate` with Connection constructor
- [x] **All methods use Connection internally** - All convenience methods now use `this.connection` instead of `this`
- [x] **All methods get model from config** - All methods use `config.get_default_model()` when config is available
- [x] **Backward compatibility maintained** - Method signatures unchanged, existing call sites continue to work
- [x] **No signal emissions in convenience methods** - Methods don't emit signals (callers handle state directly)

### ⚠️ Partially Complete / Minor Issues

- [ ] **Client.chat() options from config** - Currently has TODO comment (line 189) to add options from config (similar to embed/generate)

### ❌ Not Done / Not Applicable

- [ ] **Model as required parameter** - **TODO**: Should be implemented - simple wrapper methods should require model parameter explicitly
- [ ] **Options as optional parameter** - **TODO**: Should be implemented - simple wrapper methods should accept optional options parameter
- [ ] **refactor_* properties** - Plan mentioned these, but they don't exist in current codebase (Phase 3 architecture doesn't use them)
- [ ] **new_connection_refactor constructors** - Plan mentioned these, but Call classes now take Connection directly (simpler approach)
- [ ] [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) - **TODO**: Make `model` required parameter
- [ ] [1.2.6.2. Update Session.chat()](./1.2.6.2-update-session-chat.md) - **TODO**: Use `this.chat.connection` instead of `this.client`
- [ ] [1.2.6.3. Update TitleGenerator](./1.2.6.3-update-title-generator.md) - **TODO**: Take `Connection` and `model` instead of `Client`
- [ ] [1.2.6.4. Update VectorBuilder](./1.2.6.4-update-vector-builder.md) - **TODO**: Take `Connection` and `model` instead of `Client`
- [ ] [1.2.6.5. Update Database](./1.2.6.5-update-database.md) - **TODO**: Take `Connection` and `model` instead of `Client`
- [ ] [1.2.6.6. Update Search](./1.2.6.6-update-search.md) - **TODO**: Take `Connection` and `model` instead of `Client`

### Current Implementation Notes

**What's Working:**
- All four convenience methods (`chat()`, `embed()`, `embed_array()`, `generate()`) have been migrated to use Connection-based architecture
- Methods get model from `config.get_default_model()` when config is available
- Methods get options from config (except `chat()` which has a TODO)
- All methods throw helpful errors if model is not available
- Existing call sites in `Session.vala`, `TitleGenerator.vala`, and `libocvector` continue to work

**Minor Improvements Possible:**
- Add options support to `chat()` method (currently has TODO comment)

**TODO - Required Changes:**

**Phase 1: Update Method Signatures**
- [ ] [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) - Make `model` required and `options` optional

**Phase 2: Update Call Sites (Should Use Connection, Not Client)**
- [ ] [1.2.6.2. Update Session.chat()](./1.2.6.2-update-session-chat.md) - Use `this.chat.connection` instead of `this.client`
- [ ] [1.2.6.3. Update TitleGenerator](./1.2.6.3-update-title-generator.md) - Take `Connection` and `model` instead of `Client`
- [ ] [1.2.6.4. Update VectorBuilder](./1.2.6.4-update-vector-builder.md) - Take `Connection` and `model` instead of `Client`
- [ ] [1.2.6.5. Update Database](./1.2.6.5-update-database.md) - Take `Connection` and `model` instead of `Client`
- [ ] [1.2.6.6. Update Search](./1.2.6.6-update-search.md) - Take `Connection` and `model` instead of `Client`

## ⚠️ CRITICAL: Incremental Implementation Required

**IMPORTANT**: This refactoring must be done incrementally to keep the code usable after each step. See [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md) for the overall approach.

**Key Principle**: Migrate methods incrementally (one at a time), ensuring code remains usable after each migration.

## Goal

Ensure Client convenience methods still work for simple use cases, but use the new architecture internally (Connection, explicit properties, etc.).

## Implementation Strategy

This plan migrates Client convenience methods to use the Connection-based architecture while maintaining backward compatibility.

**Prerequisites**:
- Call.Base and Call subclasses support Connection-based constructors
- Config2.get_default_model() available for getting default model from config

## Implementation Steps

### Phase 1: Migrate Methods Incrementally

Migrate each Client convenience method **one at a time**, test after each migration.

#### Step 1.1: Migrate Client.chat()

**File**: `libollmchat/Client.vala`

**Current** (line ~317):
```vala
public async Response.Chat chat(string text, GLib.Cancellable? cancellable = null) throws Error
{
    var call = new Call.Chat(this, this.model) {
        cancellable = cancellable
    };
    // ... rest of implementation
}
```

**New** (actual implementation):
```vala
public async Response.Chat chat(string text, GLib.Cancellable? cancellable = null) throws Error
{
    // Get model from config
    string model = "";
    if (this.config != null) {
        model = this.config.get_default_model();
    }
    if (model == "") {
        throw new OllamaError.INVALID_ARGUMENT("Client.chat() requires a model. Set config and default_model, or use Call.Chat directly.");
    }
    
    // Create chat call with Connection
    var call = new Call.Chat(this.connection, model) {
        cancellable = cancellable,
        stream = true,
        think = true
    };
    
    // Create dummy user-sent Message with original text
    var user_sent_msg = new Message(call, "user-sent", text);
    // Note: No signal emission - caller handles state
    
    // Set chat_content to user text
    call.chat_content = text;
    
    // Prepare messages array for API request
    call.messages.add(new Message(call, "user", call.chat_content));
    
    var result = yield call.exec_chat();
    return result;
}
```

**Test**: Verify `Client.chat()` still works with both old and new signatures

**Result**: One method migrated, code still works

#### Step 1.2: Migrate Client.embed()

**File**: `libollmchat/Client.vala`

**Current** (line ~484):
```vala
public async Response.Embed embed(
    string input,
    int dimensions = -1,
    bool truncate = false,
    GLib.Cancellable? cancellable = null
) throws Error
{
    var call = new Call.Embed(this, this.model, new Call.Options()) {
        cancellable = cancellable,
        input = input,
        dimensions = dimensions,
        truncate = truncate
    };
    // ... rest of implementation
}
```

**New** (actual implementation):
```vala
public async Response.Embed embed(
    string input,
    int dimensions = -1,
    bool truncate = false,
    GLib.Cancellable? cancellable = null
) throws Error
{
    // Get model from config
    string model = "";
    if (this.config != null) {
        model = this.config.get_default_model();
    }
    if (model == "") {
        throw new OllamaError.INVALID_ARGUMENT("Client.embed() requires a model. Set config and default_model, or use Call.Embed directly.");
    }
    
    // Get options from config if available
    Call.Options? options = null;
    if (this.config != null) {
        var default_usage = this.config.usage.get("default_model") as Settings.ModelUsage;
        if (default_usage != null) {
            options = default_usage.options;
        }
    }
    if (options == null) {
        options = new Call.Options();
    }
    
    // Create Embed with Connection
    var call = new Call.Embed(this.connection, model, options) {
        cancellable = cancellable,
        input = input,
        dimensions = dimensions,
        truncate = truncate
    };
    
    var result = yield call.exec_embed();
    return result;
}
```

**Test**: Verify `Client.embed()` works with new signature

**Result**: Another method migrated, code still works

#### Step 1.3: Migrate Client.embed_array()

**File**: `libollmchat/Client.vala`

**Current** (line ~516):
```vala
public async Response.Embed embed_array(
    Gee.ArrayList<string> input_array,
    int dimensions = -1,
    bool truncate = false,
    GLib.Cancellable? cancellable = null
) throws Error
{
    var call = new Call.Embed(this, this.model, new Call.Options()) {
        cancellable = cancellable,
        input_array = input_array,
        dimensions = dimensions,
        truncate = truncate
    };
    // ... rest of implementation
}
```

**New** (actual implementation): Same pattern as `embed()`:
```vala
public async Response.Embed embed_array(
    Gee.ArrayList<string> input_array,
    int dimensions = -1,
    bool truncate = false,
    GLib.Cancellable? cancellable = null
) throws Error
{
    // Get model from config
    string model = "";
    if (this.config != null) {
        model = this.config.get_default_model();
    }
    if (model == "") {
        throw new OllamaError.INVALID_ARGUMENT("Client.embed_array() requires a model. Set config and default_model, or use Call.Embed directly.");
    }
    
    // Get options from config if available
    Call.Options? options = null;
    if (this.config != null) {
        var default_usage = this.config.usage.get("default_model") as Settings.ModelUsage;
        if (default_usage != null) {
            options = default_usage.options;
        }
    }
    if (options == null) {
        options = new Call.Options();
    }
    
    // Create Embed with Connection
    var call = new Call.Embed(this.connection, model, options) {
        cancellable = cancellable,
        input_array = input_array,
        dimensions = dimensions,
        truncate = truncate
    };
    
    var result = yield call.exec_embed();
    return result;
}
```

**Test**: Verify `Client.embed_array()` works with new signature

**Result**: Another method migrated, code still works

#### Step 1.4: Migrate Client.generate()

**File**: `libollmchat/Client.vala`

**Current** (line ~547):
```vala
public async Response.Generate generate(
    string prompt,
    string system = "",
    GLib.Cancellable? cancellable = null
) throws Error
{
    var call = new Call.Generate(this) {
        cancellable = cancellable,
        prompt = prompt,
        system = system
    };
    // ... rest of implementation
}
```

**New** (actual implementation):
```vala
public async Response.Generate generate(
    string prompt,
    string system = "",
    GLib.Cancellable? cancellable = null
) throws Error
{
    // Get model from config
    string model = "";
    if (this.config != null) {
        model = this.config.get_default_model();
    }
    if (model == "") {
        throw new OllamaError.INVALID_ARGUMENT("Client.generate() requires a model. Set config and default_model, or use Call.Generate directly.");
    }
    
    // Get options from config if available
    Call.Options? options = null;
    if (this.config != null) {
        var default_usage = this.config.usage.get("default_model") as Settings.ModelUsage;
        if (default_usage != null) {
            options = default_usage.options;
        }
    }
    if (options == null) {
        options = new Call.Options();
    }
    
    // Create Generate with Connection
    var call = new Call.Generate(this.connection) {
        cancellable = cancellable,
        prompt = prompt,
        system = system,
        model = model,
        stream = false,
        think = false,
        options = options
    };
    
    var result = yield call.exec_generate();
    return result;
}
```

**Test**: Verify `Client.generate()` works with new signature

**Result**: All convenience methods migrated, code still works

### Phase 2: Update Call Sites to Use Connection Instead of Client

**Prerequisite**: [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) must be complete

**Important**: According to plan 1.2, `config` should be removed from Client. **History.Manager owns the config** (see `libollmchat/History/Manager.vala` line 60). These call sites should:
1. Not use `this.client` - create their own Client from Connection
2. Not pass `config` to Client - Manager owns config, not Client
3. Take `model` explicitly as a parameter, or get it from Manager if they have access to it

See separate plan files for each call site:
- [1.2.6.2. Update Session.chat()](./1.2.6.2-update-session-chat.md)
- [1.2.6.3. Update TitleGenerator](./1.2.6.3-update-title-generator.md)
- [1.2.6.4. Update VectorBuilder](./1.2.6.4-update-vector-builder.md)
- [1.2.6.5. Update Database](./1.2.6.5-update-database.md)
- [1.2.6.6. Update Search](./1.2.6.6-update-search.md)

See separate plan files for detailed implementation:
- [1.2.6.2. Update Session.chat()](./1.2.6.2-update-session-chat.md) - Update Session to use `this.chat.connection`
- [1.2.6.3. Update TitleGenerator](./1.2.6.3-update-title-generator.md) - Update TitleGenerator to take Connection and model
- [1.2.6.4. Update VectorBuilder](./1.2.6.4-update-vector-builder.md) - Update VectorBuilder to take Connection and model
- [1.2.6.5. Update Database](./1.2.6.5-update-database.md) - Update Database to take Connection and model
- [1.2.6.6. Update Search](./1.2.6.6-update-search.md) - Update Search to take Connection and model

## Backward Compatibility

### Breaking Changes

**Note**: The plan originally suggested requiring `model` as a parameter, but the actual implementation maintains backward compatibility by getting the model from config instead. This is better for existing code.

**Current Implementation:**
- `Client.chat()` - Gets model from config (via `config.get_default_model()`), throws error if not available
- `Client.embed()` - Gets model from config (via `config.get_default_model()`), throws error if not available
- `Client.embed_array()` - Gets model from config (via `config.get_default_model()`), throws error if not available
- `Client.generate()` - Gets model from config (via `config.get_default_model()`), throws error if not available

**Planned Change (TODO):**
- `Client.chat(string model, string text, Call.Options? options = null, Cancellable? cancellable = null)` - Model required, options optional
- `Client.embed(string model, string input, Call.Options? options = null, int dimensions = -1, bool truncate = false, Cancellable? cancellable = null)` - Model required, options optional
- `Client.embed_array(string model, Gee.ArrayList<string> input_array, Call.Options? options = null, int dimensions = -1, bool truncate = false, Cancellable? cancellable = null)` - Model required, options optional
- `Client.generate(string model, string prompt, Call.Options? options = null, string system = "", Cancellable? cancellable = null)` - Model required, options optional

**Breaking Change**: Methods will require `model` as explicit parameter instead of getting from config. This makes the simple wrapper API more explicit and clear.

### Migration Path

For code using these methods:
1. Update to pass `model` parameter explicitly
2. Or ensure Config2 has default model configured
3. Update to handle state directly (no signal dependencies)

## Files to Modify

### Client
- `libollmchat/Client.vala` - Steps 1.1, 1.2, 1.3, 1.4

### Call Sites (if needed)
- Examples, tests, etc. - Step 2.1

## Testing Checklist

- [x] Step 1.1: Client.chat() migrated and tested - **Done**: Uses Connection, gets model from config
- [x] Step 1.2: Client.embed() migrated and tested - **Done**: Uses Connection, gets model and options from config
- [x] Step 1.3: Client.embed_array() migrated and tested - **Done**: Uses Connection, gets model and options from config
- [x] Step 1.4: Client.generate() migrated and tested - **Done**: Uses Connection, gets model and options from config
- [x] Step 2.1: All call sites updated and tested - **Not needed**: Method signatures unchanged, existing call sites work
- [x] All methods use Connection internally - **Done**: All use `this.connection` (not `new_connection_refactor` - that pattern doesn't exist)
- [x] All methods get model/options from config or parameters - **Done**: All get from config via `config.get_default_model()` and config usage map
- [ ] All methods set `refactor_*` properties explicitly - **N/A**: `refactor_*` properties don't exist in Phase 3 architecture
- [x] No signal emissions in convenience methods - **Done**: Methods don't emit signals
- [x] Backward compatibility maintained where possible - **Done**: Method signatures unchanged, all existing call sites work

## Sub-Plans

- [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) - Make `model` required parameter
- [1.2.6.2. Update Session.chat()](./1.2.6.2-update-session-chat.md) - Update Session call site
- [1.2.6.3. Update TitleGenerator](./1.2.6.3-update-title-generator.md) - Update TitleGenerator call site
- [1.2.6.4. Update VectorBuilder](./1.2.6.4-update-vector-builder.md) - Update VectorBuilder call site
- [1.2.6.5. Update Database](./1.2.6.5-update-database.md) - Update Database call site
- [1.2.6.6. Update Search](./1.2.6.6-update-search.md) - Update Search call site

## Related Plans

- [1.2.1. Remove Configuration from Client](./1.2.1-remove-config-from-client.md)
- [1.2.3. Update Call.Base to Take Connection](./1.2.3-update-call-base-connection.md)
- [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md)
- [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md)
