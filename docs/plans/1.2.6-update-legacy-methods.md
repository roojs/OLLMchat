# 1.2.6. Update Legacy Methods and Maintain Backward Compatibility

## Overview

Update Client convenience methods (`chat()`, `embed()`, `generate()`) to work with the new architecture while maintaining backward compatibility where possible.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

⏳ **TODO** - Refactoring needed.

## ⚠️ CRITICAL: Incremental Implementation Required

**IMPORTANT**: This refactoring must be done incrementally to keep the code usable after each step. See [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md) for the overall approach.

**Key Principle**: Migrate methods incrementally (one at a time), ensuring code remains usable after each migration.

## Goal

Ensure Client convenience methods still work for simple use cases, but use the new architecture internally (Connection, explicit properties, etc.).

## Implementation Strategy

This plan implements **Phase 2, Step 2.1** of the incremental strategy: migrating Client convenience methods.

**Prerequisites**:
- Phase 1.1 complete: Chat supports both realized and real properties (with `refactor_` prefix)
- Phase 1.2 complete: Call.Base supports both Client and Connection (with `new_connection_refactor` constructor)

## Implementation Steps

### Phase 1: Prepare Helper Functions

#### Step 1.1: Create Helper Functions

Create helper functions in Client or Config2:

```vala
// In Client or Config2
private string? get_model_from_config() {
    // Get default model from Config2 or return null
    if (this.config != null) {
        // Get from usage map or default
    }
    return null;
}

private Call.Options get_options_from_config(string model) {
    if (this.config != null && this.config.model_options.has_key(model)) {
        return this.config.model_options.get(model);
    }
    return new Call.Options();
}
```

**Result**: Helper functions available for use during migration

### Phase 2: Migrate Methods Incrementally

Migrate each Client convenience method **one at a time**, test after each migration.

#### Step 2.1: Migrate Client.chat()

**File**: `libollmchat/Client.vala`

**Current** (line ~317):
```vala
public async Response.Chat chat(string text, GLib.Cancellable? cancellable = null) throws Error
{
    var call = new Call.Chat(this, this.model) {
        cancellable = cancellable
    };
    // ... rest of implementation
}
```

**New** (incremental - still uses Client constructor but sets real properties):
```vala
public async Response.Chat chat(string text, string? model = null, GLib.Cancellable? cancellable = null) throws Error
{
    // Get model from parameter, config, or Client property (still available)
    var chat_model = model ?? this.model ?? get_model_from_config() ?? "llama3.2";
    
    // Get options from config (or use Client.options if still available)
    var options = get_options_from_config(chat_model) ?? this.options;
    
    // Create Chat with Client constructor (still works) but set real properties
    var call = new Call.Chat(this, chat_model, options) {
        cancellable = cancellable,
        refactor_stream = this.stream,  // Set real property
        refactor_format = this.format,
        refactor_think = this.think,
        refactor_keep_alive = this.keep_alive
    };
    
    // ... rest of implementation (no signal emissions)
}
```

**Or** (if Phase 1.2 is complete, use new_connection_refactor):
```vala
public async Response.Chat chat(string text, string? model = null, GLib.Cancellable? cancellable = null) throws Error
{
    // Get model from parameter, config, or Client property (still available)
    var chat_model = model ?? this.model ?? get_model_from_config() ?? "llama3.2";
    
    // Get options from config
    var options = get_options_from_config(chat_model) ?? this.options;
    
    // Create Chat with Connection (using new_connection_refactor constructor)
    var call = new Call.Chat.new_connection_refactor(this.connection, chat_model, options) {
        cancellable = cancellable,
        refactor_stream = this.stream,
        refactor_format = this.format,
        refactor_think = this.think,
        refactor_keep_alive = this.keep_alive
    };
    
    // Create dummy user-sent Message with original text
    var user_sent_msg = new Message(call, "user-sent", text);
    // Note: No signal emission - caller handles state
    
    // Set chat_content to user text
    call.chat_content = text;
    
    // Prepare messages array for API request
    call.messages.add(new Message(call, "user", call.chat_content));
    
    var result = yield call.exec_chat();
    return result;
}
```

**Test**: Verify `Client.chat()` still works with both old and new signatures

**Result**: One method migrated, code still works

#### Step 2.2: Migrate Client.embed()

**File**: `libollmchat/Client.vala`

**Current** (line ~484):
```vala
public async Response.Embed embed(
    string input,
    int dimensions = -1,
    bool truncate = false,
    GLib.Cancellable? cancellable = null
) throws Error
{
    var call = new Call.Embed(this, this.model, new Call.Options()) {
        cancellable = cancellable,
        input = input,
        dimensions = dimensions,
        truncate = truncate
    };
    // ... rest of implementation
}
```

**New**:
```vala
public async Response.Embed embed(
    string model,  // Now required parameter
    string input,
    int dimensions = -1,
    bool truncate = false,
    GLib.Cancellable? cancellable = null
) throws Error
{
    // Get options from config
    var options = get_options_from_config(model);
    
    // Create Embed with Connection (using new_connection_refactor constructor)
    var call = new Call.Embed.new_connection_refactor(this.connection, model, options) {
        cancellable = cancellable,
        input = input,
        dimensions = dimensions,
        truncate = truncate
    };
    
    var result = yield call.exec_embed();
    return result;
}
```

**Test**: Verify `Client.embed()` works with new signature

**Result**: Another method migrated, code still works

#### Step 2.3: Migrate Client.embed_array()

**File**: `libollmchat/Client.vala`

**Current** (line ~516):
```vala
public async Response.Embed embed_array(
    Gee.ArrayList<string> input_array,
    int dimensions = -1,
    bool truncate = false,
    GLib.Cancellable? cancellable = null
) throws Error
{
    var call = new Call.Embed(this, this.model, new Call.Options()) {
        cancellable = cancellable,
        input_array = input_array,
        dimensions = dimensions,
        truncate = truncate
    };
    // ... rest of implementation
}
```

**New**: Same pattern as `embed()` - add `model` parameter:
```vala
public async Response.Embed embed_array(
    string model,  // Now required parameter
    Gee.ArrayList<string> input_array,
    int dimensions = -1,
    bool truncate = false,
    GLib.Cancellable? cancellable = null
) throws Error
{
    // Get options from config
    var options = get_options_from_config(model);
    
    // Create Embed with Connection
    var call = new Call.Embed.new_connection_refactor(this.connection, model, options) {
        cancellable = cancellable,
        input_array = input_array,
        dimensions = dimensions,
        truncate = truncate
    };
    
    var result = yield call.exec_embed();
    return result;
}
```

**Test**: Verify `Client.embed_array()` works with new signature

**Result**: Another method migrated, code still works

#### Step 2.4: Migrate Client.generate()

**File**: `libollmchat/Client.vala`

**Current** (line ~547):
```vala
public async Response.Generate generate(
    string prompt,
    string system = "",
    GLib.Cancellable? cancellable = null
) throws Error
{
    var call = new Call.Generate(this) {
        cancellable = cancellable,
        prompt = prompt,
        system = system
    };
    // ... rest of implementation
}
```

**New**:
```vala
public async Response.Generate generate(
    string model,  // Now required parameter
    string prompt,
    string system = "",
    GLib.Cancellable? cancellable = null
) throws Error
{
    // Get options from config
    var options = get_options_from_config(model);
    
    // Create Generate with Connection
    var call = new Call.Generate.new_connection_refactor(this.connection, model, options) {
        cancellable = cancellable,
        prompt = prompt,
        system = system,
        refactor_stream = this.stream,
        refactor_format = this.format,
        refactor_think = this.think,
        refactor_keep_alive = this.keep_alive
    };
    
    var result = yield call.exec_generate();
    return result;
}
```

**Test**: Verify `Client.generate()` works with new signature

**Result**: All convenience methods migrated, code still works

### Phase 3: Update Call Sites (If Needed)

#### Step 3.1: Update Code Using Client Methods

**Prerequisite**: All Client methods migrated (Phase 2 complete)

Find all code that calls these methods and update to use new signatures:

- `Client.chat()` - May need to pass `model` parameter
- `Client.embed()` - Must pass `model` parameter
- `Client.embed_array()` - Must pass `model` parameter
- `Client.generate()` - Must pass `model` parameter

**Files to check**:
- Examples
- Tests
- Any other code using these methods

**Test**: Verify all call sites work with new signatures

**Result**: All call sites updated, code still works

## Backward Compatibility

### Breaking Changes

These are intentional breaking changes for cleaner API:
- `Client.chat()` now requires `model` parameter (or gets from config)
- `Client.embed()` now requires `model` parameter
- `Client.embed_array()` now requires `model` parameter
- `Client.generate()` now requires `model` parameter

### Migration Path

For code using these methods:
1. Update to pass `model` parameter explicitly
2. Or ensure Config2 has default model configured
3. Update to handle state directly (no signal dependencies)

## Files to Modify

### Client
- `libollmchat/Client.vala` - Steps 2.1, 2.2, 2.3, 2.4

### Config2 (if helper functions go there)
- `libollmchat/Settings/Config2.vala` - Step 1.1 (optional)

### Call Sites (if needed)
- Examples, tests, etc. - Step 3.1

## Testing Checklist

- [ ] Step 1.1: Helper functions created (if needed)
- [ ] Step 2.1: Client.chat() migrated and tested
- [ ] Step 2.2: Client.embed() migrated and tested
- [ ] Step 2.3: Client.embed_array() migrated and tested
- [ ] Step 2.4: Client.generate() migrated and tested
- [ ] Step 3.1: All call sites updated and tested
- [ ] All methods use Connection internally (via `new_connection_refactor`)
- [ ] All methods get model/options from config or parameters
- [ ] All methods set `refactor_*` properties explicitly
- [ ] No signal emissions in convenience methods
- [ ] Backward compatibility maintained where possible

## Related Plans

- [1.2.1. Remove Configuration from Client](./1.2.1-remove-config-from-client.md)
- [1.2.3. Update Call.Base to Take Connection](./1.2.3-update-call-base-connection.md)
- [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md)
- [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md)
