# 2.6.1.4. Integrate Basic Overlay Support

## Overview

Integrate Overlay and Monitor classes with Bwrap class to create a complete workflow: overlay creation → command execution → file copying → cleanup.

## Status

⏳ **PLANNING** - Design phase.

## Prerequisites

- Phase 1 (2.6.1.1) must be completed
- Phase 2 (2.6.1.2) must be completed
- Phase 3 (2.6.1.3) must be completed
- See main plan: `2.6.1-code-exec-improvements.md` for integration details

## Goals

1. Integrate Overlay with Bwrap class
2. Integrate Monitor with Overlay (monitor overlay upper directory)
3. Update RunCommand/Request to use complete overlay system
4. Test full workflow end-to-end

## Implementation Details

### Files to Modify

- `liboctools/RunCommand/Request.vala` - Integrate Bwrap, Overlay, and Monitor
- `liboctools/RunCommand/Bwrap.vala` - Add overlay mount point support

### Integration Workflow

1. **Pre-execution**:
   - Create Overlay instance
   - Create overlay directory structure
   - Mount overlay filesystem
   - Create Monitor instance for overlay upper directory
   - Start monitoring

2. **Execution**:
   - Create Bwrap instance with overlay mount point
   - Execute command in bwrap sandbox (writes go to overlay upper directory)
   - Monitor tracks changes during execution

3. **Post-execution**:
   - Stop monitoring
   - Get change lists from Monitor
   - Copy files from overlay to live system (using change lists)
   - Unmount overlay
   - Cleanup overlay directory

### Bwrap Integration

- Bwrap needs to bind-mount overlay mount point at project directory location
- Use `--bind` to mount overlay at project path within bwrap sandbox
- Project directory writes go to overlay upper directory

### Monitor Integration

- Monitor overlay upper directory (starts empty)
- Track all changes during command execution
- Provide change lists for file copying

## Implementation Tasks

- [ ] Integrate Overlay with Bwrap class
- [ ] Integrate Monitor with Overlay (monitor overlay upper directory)
- [ ] Update RunCommand/Request to use overlay system
- [ ] Test full workflow: overlay creation → command execution → file copying → cleanup
- [ ] Test with various command types (build, test, git, etc.)
- [ ] Test with complex commands (pipes, redirects, etc.)

## Testing

- Test full workflow end-to-end
- Test with various command types (build, test, git, etc.)
- Test with complex commands (pipes, redirects, etc.)
- Test overlay cleanup on success
- Test overlay cleanup on error

## Notes

- This phase completes the basic overlay workflow
- Backup support will be added in Phase 5
- Network access will be added in Phase 7

