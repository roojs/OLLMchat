# 2.1.4. AST Path Support for EditFile Integration

## Overview

Add AST path support to EditFile/EditMode tool, allowing LLMs to reference code blocks using AST paths like `ast-path: Namespace-Class-Method` instead of line numbers in edit operations. This enables more intuitive code editing commands that work even when code changes.

## Status

ðŸš§ **IN PROGRESS** - Phases 1, 2, 3, 4, and 5 complete. Core infrastructure, AST path resolution method, code block format support, all edit operation types (replace, insert before, insert after, delete), and AST cache invalidation infrastructure implemented. Phase 6 (Stream class refactoring) is planned.

## Related Plans

- **2.1.2** - AST Path Support for ReadFile and EditFile (infrastructure and ReadFile integration)
- **2.1.5** - AST Path Comment Support (optional enhancement)
- **2.1.6** - Stream Class Refactoring for EditMode
- **2.1.7** - Line Number Mode (Legacy) and Mode Separation
- **2.1.8** - AST Path Mode (Incremental Application)
- **2.4** - Edit File and Edit Mode Tool (current line-based implementation)
- **2.4.1** - Edit Tool Migrate to Buffer (buffer-based editing)

## Purpose

Enable LLMs to use AST paths in edit operations:
- `ast-path: Namespace-Class-Method` - Replace/edit a method
- `ast-path: Namespace-Class` - Replace/edit an entire class
- `ast-path: Namespace-Class-Property` - Replace/edit a property

Instead of requiring precise line numbers:
- `replace lines 45-67 with ...` â†’ `replace ast-path: MyClass/myMethod with ...`
- `insert after line 89` â†’ `insert after ast-path: MyClass/myMethod`

## Implementation Phases

### Phase 1: Core Infrastructure and File Reference
- [x] Get File object early in `execute_request()` (similar to ReadFile)
- [x] Store in `this.file` property for AST path resolution
- [x] Create fake file if not in project (after AST path check, since AST doesn't work on fake files)
- [x] Ensure AST path resolution only works for files in active project (same as ReadFile)

### Phase 2: AST Path Resolution Method
- [x] Add `resolve_ast_path()` method to RequestEditMode similar to ReadFile's implementation
  ```vala
  private async bool resolve_ast_path(string ast_path, out int start_line, out int end_line) throws GLib.Error
  {
      if (ast_path == "" || this.file == null) {
          return false;
      }
      
      var project_manager = ((Tool) this.tool).project_manager;
      
      // Get Tree instance and parse
      var tree = project_manager.tree_factory(this.file);
      yield tree.parse();
      
      // Lookup AST path
      if (tree.lookup_path(ast_path, out start_line, out end_line)) {
          return true;
      }
      
      return false;
  }
  ```
- [x] Use same resolution pattern: `project_manager.tree_factory(file)` â†’ `tree.parse()` â†’ `tree.lookup_path()`

### Phase 3: Code Block Format Support
- [x] Update `try_parse_code_block_opener()` to detect `ast-path:` prefix
- [x] Support AST paths in code block format: `type:Namespace-Class-Method` (alternative to `type:startline:endline`)
- [x] Support both formats - AST path takes precedence if both provided
- [x] Resolve AST path to line range before calling `enter_code_block()`
- [x] Error handling: if AST path not found, show error and skip code block
- [ ] **Note:** Phase 6 will add mode enforcement - `use_line_numbers` parameter will prevent mixing formats

### Phase 4: Edit Operation Types with AST Paths
- [x] **Replace Operation:**
  - [x] Format: `type:Namespace-Class-Method` with replacement content
  - [x] Resolve AST path to `start_line` and `end_line`
  - [x] Create FileChange: `start=start_line, end=end_line, replacement=content`
  - [x] Replaces the entire AST element with new content
  
- [x] **Insert Before Operation:**
  - [x] Format: `type:Namespace-Class-Method:before` or similar marker
  - [x] Resolve AST path to `start_line` (use start of element)
  - [x] Create FileChange: `start=start_line, end=start_line, replacement=content`
  - [x] Inserts new content before the AST element
  
- [x] **Insert After Operation:**
  - [x] Format: `type:Namespace-Class-Method:after` or similar marker
  - [x] Resolve AST path to `end_line` (use end of element)
  - [x] Create FileChange: `start=end_line, end=end_line, replacement=content`
  - [x] Inserts new content after the AST element
  
- [x] **Delete Operation:**
  - [x] Format: `type:Namespace-Class-Method` with empty replacement
  - [x] Resolve AST path to `start_line` and `end_line`
  - [x] Create FileChange: `start=start_line, end=end_line, replacement=""`
  - [x] Deletes the entire AST element

**Note:** The current EditMode implementation uses FileChange objects with `start`, `end`, and `replacement` properties. All operation types are supported through this model:
- Replace: `start != end` with content
- Insert: `start == end` with content  
- Delete: `start != end` with empty string

### Phase 5: AST Cache Invalidation
- [x] Add `needs_reparse` flag to `Tree` class (boolean property)
  ```vala
  // In Tree class
  public bool needs_reparse { get; set; default = false; }
  ```
- [x] Update `Tree.parse()` to check `needs_reparse` flag in addition to mtime check
  ```vala
  // In Tree.parse() - check flag before mtime check
  if (file_mtime > 0 && file_mtime == this.last_parsed && !this.needs_reparse) {
      // Skip parsing - file unchanged and no reparse flag
      return;
  }
  // Clear reparse flag if it was set
  if (this.needs_reparse) {
      this.needs_reparse = false;
  }
  // ... existing parse logic ...
  ```
- [x] **Note:** Phase 5 only adds the infrastructure (flag and parse() check). The actual marking of `tree.needs_reparse = true` will be done in Phase 8 when incremental changes are applied to the buffer.
- [x] **Note:** When the file is synced to disk at the end of the session, the mtime update will naturally trigger reparse. The `needs_reparse` flag is needed for incremental edits that are applied to the buffer but not yet synced to disk (so mtime hasn't changed yet).

### Phase 6: Refactor Streaming Mode into Separate Stream Class
- [ ] See separate plan: **2.1.6** - Stream Class Refactoring for EditMode

### Phase 7: Line Number Mode (Legacy) and Mode Separation
- [ ] See separate plan: **2.1.7** - Line Number Mode (Legacy) and Mode Separation

### Phase 8: AST Path Mode (Incremental Application)
- [ ] See separate plan: **2.1.8** - AST Path Mode (Incremental Application)

### Phase 9: UI Messages and Validation
- [ ] Show AST path in UI messages when code blocks use AST paths
- [ ] Include resolved line range in UI output (e.g., "Edit: ast-path: OLLMchat-Client-chat (lines 45-67)")
- [ ] Permission questions already handled by existing file permission system
- [ ] Validate AST path exists before creating FileChange
- [ ] If AST path not found, show error message and skip the code block
- [ ] Ensure resolved line range is valid (start_line >= 1, end_line >= start_line)
- [ ] Use resolved line range for FileChange (same as line-number-based edits)

### Phase 10: Documentation and Testing
- [ ] Update `liboctools/EditMode/Tool.vala` - Document AST path support and `use_line_numbers` parameter in parameter_description
- [ ] Test all edit operation types (replace, insert before, insert after, delete)
- [ ] Test incremental edits in same session (AST path mode)
- [ ] Test mode enforcement: reject line number format when `use_line_numbers = false`
- [ ] Test mode enforcement: reject AST path format when `use_line_numbers = true`
- [ ] Test error handling (path not found, parse errors)
- [ ] Test with files in project and fake files

## Files to Modify

### EditFile Tool
- [x] `liboctools/EditMode/Request.vala` - Add AST path support to edit operations (Phases 1-4 complete)
  - [ ] Refactor streaming into Stream class (Phase 6)
  - [ ] Add `use_line_numbers` parameter and line number mode enforcement (Phase 7)
  - [ ] Add AST path mode enforcement and incremental application (Phase 8)
- [ ] `liboctools/EditMode/Stream.vala` - New class for streaming content processing (Phase 6)
- [ ] `libocfiles/FileChange.vala` - Add AST path resolution support (Phase 6)
  - [ ] Add `ast_path`, `completed`, `operation_type` properties
  - [ ] Add `resolve_ast_path()` async method
- [ ] `liboctools/EditMode/Tool.vala` - Document AST path support and `use_line_numbers` parameter in parameter_description (Phase 7)
- [x] `libocfiles/Tree.vala` - Add `needs_reparse` flag for cache invalidation (Phase 5 complete)
- [ ] `libocfiles/FileBuffer.vala` - Add incremental edit support (skip sync option) (Phase 8)

## Example Usage

### EditFile with AST Path - Replace
```
Tool: edit_mode
Code block:
```vala:OLLMchat-Client-chat
public void chat() {
    // new implementation
}
```
```

**Result**: Replaces the `chat` method with new content.

### EditFile with AST Path - Insert Before
```
Tool: edit_mode
Code block:
```vala:OLLMchat-Client-chat:before
// New helper method before chat()
public void helper() {
    // implementation
}
```
```

**Result**: Inserts new code before the `chat` method.

### EditFile with AST Path - Insert After
```
Tool: edit_mode
Code block:
```vala:OLLMchat-Client-chat:after
// New method after chat()
public void cleanup() {
    // implementation
}
```
```

**Result**: Inserts new code after the `chat` method.

### EditFile with AST Path - Delete
```
Tool: edit_mode
Code block:
```vala:OLLMchat-Client-chat

```
```

**Result**: Deletes the `chat` method (empty replacement = delete).

## Error Handling

**Path Not Found:**
- Return clear error message
- Show resolved line range if available
- Skip the code block and continue with other changes

**Multiple Matches:**
- For partial `ast-path:` (e.g., just method name), return first match with warning
- For full `ast-path:`, require complete path to disambiguate

**Parse Errors:**
- Fall back to line numbers if AST parsing fails
- Log parse error for debugging
- Continue with partial AST if possible

## Ignored Changes Examples

### Example 1: AST Path in Line Number Mode
**Scenario:** `use_line_numbers=true` is set, but LLM provides AST path format

**Code Block:**
```
```vala:OLLMchat-Client-chat
public void chat() {
    // new implementation
}
```
```

**Immediate UI Error:**
```
Ignored: Change to `ast-path:OLLMchat-Client-chat` - AST path format specified but line number mode is active. Use `type:startline:endline` format instead.
Active mode: Line numbers (use_line_numbers=true)
Required format: `vala:45:67`
```

**End-of-Session LLM Reply:**
```
File 'example.vala' has been updated. It now has 150 lines.

1 code block(s) were ignored due to mode mismatch:
  â€¢ Change to `ast-path:OLLMchat-Client-chat` was ignored: AST path format was specified, but line number mode is active (use_line_numbers=true). Use format: `type:startline:endline` instead.

All code blocks in a session must use the same format. Use line number format: `type:startline:endline`
```

### Example 2: Line Numbers in AST Path Mode
**Scenario:** `use_line_numbers=false` (default), but LLM provides line number format

**Code Block:**
```
```vala:45:67
public void chat() {
    // new implementation
}
```
```

**Immediate UI Error:**
```
Ignored: Change at lines 45-67 - Line number format specified but AST path mode is active. Use `type:Namespace-Class-Method` format instead.
Active mode: AST paths (use_line_numbers=false)
Required format: `vala:OLLMchat-Client-chat`
```

**End-of-Session LLM Reply:**
```
File 'example.vala' has been updated. It now has 150 lines.

1 code block(s) were ignored due to mode mismatch:
  â€¢ Change at lines 45-67 was ignored: Line number format was specified, but AST path mode is active (use_line_numbers=false). Use format: `type:Namespace-Class-Method` instead.

All code blocks in a session must use the same format. Use AST path format: `type:Namespace-Class-Method`
```

### Example 3: Multiple Ignored Changes
**Scenario:** Mixed formats in same session (AST path mode active)

**Code Blocks:**
```
```vala:OLLMchat-Client-chat
// First change - accepted (AST path format)
```

```vala:100:120
// Second change - ignored (line number format)
```

```vala:OLLMchat-Client-helper
// Third change - accepted (AST path format)
```

```vala:150:170
// Fourth change - ignored (line number format)
```
```

**End-of-Session LLM Reply:**
```
File 'example.vala' has been updated. It now has 200 lines.

2 code block(s) were ignored due to mode mismatch:
  â€¢ Change at lines 100-120 was ignored: Line number format was specified, but AST path mode is active (use_line_numbers=false). Use format: `type:Namespace-Class-Method` instead.
  â€¢ Change at lines 150-170 was ignored: Line number format was specified, but AST path mode is active (use_line_numbers=false). Use format: `type:Namespace-Class-Method` instead.

All code blocks in a session must use the same format. Use AST path format: `type:Namespace-Class-Method`
```

**End-of-Session UI Message:**
```
2 code block(s) were ignored:

  â€¢ Change at lines 100-120 was ignored: Line number format was specified, but AST path mode is active (use_line_numbers=false). Use format: `type:Namespace-Class-Method` instead.
  â€¢ Change at lines 150-170 was ignored: Line number format was specified, but AST path mode is active (use_line_numbers=false). Use format: `type:Namespace-Class-Method` instead.

Reason: Mode mismatch. All code blocks must use the same format.
Active mode: AST paths
```
