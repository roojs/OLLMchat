# 1.3.1. Configuration Classes

## Overview

Summary of all configuration classes mentioned in plans 1.3, 1.4, and 1.5. This document catalogs existing configuration classes and identifies new ones that need to be created, along with suggested library locations.

## Status

✅ **IN PROGRESS** - Core configuration classes implemented. UI components partially implemented.

## Completed Items

✅ **Core Configuration Classes**:
- `Settings/Config1.vala` - Version 1 config with `toV2()` migration method
- `Settings/Config2.vala` - Main config holder with connections, model_options, usage maps. GType registration support. Custom Gee collection serialization.
- `Settings/Connection.vala` - Connection configuration with hidden_models support
- `Settings/ModelUsage.vala` - Model usage configuration (connection, model, options)
- `Call/Options.vala` - Updated serialization to handle underscore/hyphen conversion (hyphens for config, underscores for Ollama API)

✅ **Configuration Migration**:
- Config1 to Config2 migration working (`toV2()` method)
- Config file migration from `config.json` to `config.2.json` working
- Static property initialization fixed

✅ **Serialization Fixes**:
- Gee collection serialization fixed (connections, model_options, usage, hidden_models)
- Options serialization with all properties working (including num_ctx for embed/analysis)
- Underscore/hyphen conversion working correctly (hyphens in config, underscores for API)

✅ **UI Components**:
- `SettingsDialog` - Main dialog using `Adw.PreferencesDialog` with `closed` signal
- `ConnectionsPage` - Connections tab with add/edit/remove functionality
- `ConnectionAdd` - Dialog for adding/editing connections

⏳ **Pending**:
- ModelsPage, ToolsPage, ModelUsageEditor, OptionsEditor - Not yet implemented

## Related Plans

- **1.3** - Multiple Client Configuration
- **1.4** - Client Configuration Setup
- **1.5** - Model List Management

## Config2 Format Structure

High-level tree view of the Config2 configuration format:

```
Config2 (Settings.Config2)
├── connections (Map<string, Connection>)
│   └── [connection_url] → Connection
│       ├── name (string)
│       ├── url (string)
│       ├── api_key (string)
│       ├── is_default (bool)
│       └── hidden_models (ArrayList<string>)
│
├── model_options (Map<string, Call.Options>)
│   └── [model_name] → Call.Options
│       ├── seed (int, default: -1)
│       ├── temperature (double, default: -1.0)
│       ├── top_p (double, default: -1.0)
│       ├── top_k (int, default: -1)
│       ├── num_predict (int, default: -1)
│       ├── repeat_penalty (double, default: -1.0)
│       ├── min_p (double, default: -1.0)
│       ├── num_ctx (int, default: -1)
│       └── stop (string, default: "")
│
└── usage (Map<string, Object>)
    └── [usage_key] → Object (registered via register_type())
        ├── "default_model" → ModelUsage
        │   ├── connection (string) - references key in connections map
        │   ├── model (string)
        │   └── options (Call.Options)
        │       └── (same properties as model_options above)
        │
        ├── "title_model" → ModelUsage
        │   ├── connection (string) - references key in connections map
        │   ├── model (string)
        │   └── options (Call.Options)
        │       └── (same properties as model_options above)
        │
        └── Example: "ocvector" → ModelUsage
            ├── connection (string) - references key in connections map
            ├── model (string)
            └── options (Call.Options)
                └── (same properties as model_options above)
```

**Notes:**
- `connections`: Map keyed by connection URL, contains `Settings.Connection` objects
- `model_options`: Map keyed by model name (e.g., "default", "llama3"), contains `Call.Options` objects
- `usage`: Map for model usage configurations, uses GType registration via `register_type()`
  - `"default_model"`: ModelUsage object for the default chat model configuration
  - `"title_model"`: ModelUsage object for title generation model configuration
  - Other keys (e.g., `"ocvector"`): External library configurations using ModelUsage or other registered types
- All objects implement `Json.Serializable` for persistence

## Configuration Classes Summary

### 1. Connection Configuration

**Purpose**: Represents a single server connection configuration (name, URL, API key, default flag).

**Properties**:
- `name` (string) - Connection alias/name (e.g., "Local Ollama", "OpenAI", "Remote Server")
- `url` (string) - Server URL (e.g., `http://127.0.0.1:11434/api`)
- `api_key` (string) - Optional API key for authentication (plain text storage)
- `default` (bool) - Whether this is the default connection

**Status**: ✅ **IMPLEMENTED** - Connection class created with all properties

**Location**: `libollmchat/Settings/Connection.vala`

**References**:
- Plan 1.3: Connection Settings section
- Plan 1.3: Files to Create section

---

### 2. Model Options (Per-Model Overrides)

**Purpose**: Per-model option overrides stored as a map in Config2.

**Structure**:
- Map of model name → `Call.Options` overrides
- Stored directly in Config2 as `model_options` map (Gee.Map<string, Call.Options>)

**Status**: ⏳ **NEW** - Not yet implemented (uses existing `Call.Options` class)

**Note**: This is just a map in Config2, not a separate class. Uses existing `Call.Options` class (`libollmchat/Call/Options.vala`) for the actual option values. A separate `Settings/ModelOptions` class is only needed if we want a wrapper/helper class, otherwise just use the map directly.

**References**:
- Plan 1.3: Configuration Storage Format section (model_options object)
- Plan 1.5: Default Model Options section
- Plan 1.5: Model Configuration Storage section

---

### 3. Model Usage

**Purpose**: Represents model usage configuration (connection, model, and optional options).

**Properties**:
- `connection` (string) - Connection URL key (references a connection from the connections map)
- `model` (string) - Model name to use
- `options` (Call.Options) - Optional runtime options (temperature, top_p, top_k, num_ctx, etc.)

**Note**: The `think` property is not stored in ModelUsage. The code decides whether to enable thinking output (defaults to on), and this is not configurable via ModelUsage.

**Status**: ✅ **IMPLEMENTED** - ModelUsage class created with connection, model, and options properties

**Location**: `libollmchat/Settings/ModelUsage.vala`

**Note**: This is a reusable class for any feature that needs to specify a connection, model, and optional options. The connection property references a connection URL from Config2's connections map. Options are optional and use the same Call.Options class.

**Usage**: External libraries (like ocvector) register their GType for ModelUsage with Config2 using `register_type()`.

**References**:
- Used by ocvector configuration
- Can be used by other features that need model selection

---

### 4. Chat Defaults

**Purpose**: Chat-specific settings separate from Client class (not to be confused with Options class).

**Properties**:
- `model` (string) - Model name to use
- `stream` (bool) - Whether to stream responses
- `format` (string) - Response format (json, schema, etc.)
- `think` (bool) - Whether to return thinking output
- `keep_alive` (string/int) - Model keep-alive duration

**Status**: ⏳ **NEW** - Not yet implemented (low priority per plan 1.4)

**Suggested Location**: `libollmchat/Settings/ChatDefaults.vala`

**Note**: Runtime options (seed, temperature, top_p, etc.) remain in `Call.Options` class - do not overlap.

**References**:
- Plan 1.4: Phase 6: Chat Defaults section
- Plan 1.4: Files to Create section

---

### 5. Config (Existing - Version 1)

**Purpose**: Current single-client configuration management.

**Properties**:
- `url` (string) - Server URL ✅
- `api_key` (string) - Optional API key ✅
- `model` (string) - Model name ✅
- `title_model` (string) - Title generation model ✅
- `think` (bool) - Whether to return thinking output ✅

**Status**: ✅ **EXISTS** - Implemented

**Location**: `libollmchat/Config.vala`

**References**:
- Plan 1.4: Phase 2: Basic Configuration Persistence section
- Plan 1.4: Files Created section

---

### 6. Call.Options (Existing)

**Purpose**: Runtime options for Ollama API calls (temperature, top_p, top_k, num_ctx, etc.).

**Properties**:
- `seed` (int) - Random seed ✅
- `temperature` (double) - Temperature setting ✅
- `top_p` (double) - Top-p sampling ✅
- `top_k` (int) - Top-k sampling ✅
- `num_predict` (int) - Maximum tokens to predict ✅
- `repeat_penalty` (double) - Repeat penalty ✅
- `min_p` (double) - Minimum probability ✅
- `num_ctx` (int) - Context window size ✅
- `stop` (string) - Stop sequences ✅

**Status**: ✅ **IMPLEMENTED** - Options class exists. Serialization updated to handle underscore/hyphen conversion for Ollama API (hyphens in config, underscores for API).

**Location**: `libollmchat/Call/Options.vala`

**References**:
- Plan 1.3: System Models Management UI section (uses Call.Options)
- Plan 1.5: Default Model Options section (uses Call.Options)
- Used directly in Config2's model_options map

---

### 7. Config1 (Version 1 Configuration)

**Purpose**: Version 1 configuration class - copy of original Config class for reading version 1 format and migrating to Config2.

**Status**: ✅ **IMPLEMENTED** - Config1 class created with `toV2()` migration method. Migration from config.json to config.2.json working correctly.

**Location**: `libollmchat/Settings/Config1.vala`

**Methods**:
- `toV2()` - Converts this Config1 instance to a Config2 instance, creating a default connection from the Config1's url and api_key

**Note**: This is a copy of the original `Config.vala` class, moved to Settings namespace. Same code as Config, but in Settings namespace with an additional `toV2()` method for migration. Used for reading old Config format and converting to Config2. **Note**: In phase 1, these files are not added to the build system - will be reviewed after implementation.

**References**:
- Plan 1.4: Phase 3: Configuration Version Management section
- Plan 1.4: Files to Create section

---

### 8. Config2 (Main Configuration Holder)

**Purpose**: Main serializable configuration holder for version 2 format (multiple clients, extended structure). This is the top-level container class that holds all configuration data.

**Properties**:
- `connections` (Gee.Map<string, Settings.Connection>) - Map of connection URL → Connection objects
- `model_options` (Gee.Map<string, Call.Options>) - Map of model name → Call.Options (per-model option overrides)
- `usage` (Gee.Map<string, Object>) - Map of usage key → model usage objects (handled by registered GTypes)
  - Contains "default_model", "title_model", and external library configurations like "ocvector"

**Methods**:
- `register_type(string key, Type gtype)` - Register GType for a property/section key

**Status**: ✅ **IMPLEMENTED** - Config2 class created with connections, model_options, and usage maps. Supports GType registration via register_type() method. Custom serialization for Gee collections implemented.

**Location**: `libollmchat/Settings/Config2.vala`

**Note**: This is the main serializable holder class, not just a reader. It implements `Json.Serializable` and contains all configuration data. Model options are stored as a simple map of model name to options - connection is not important here. Model usage configurations (default_model, title_model, and external configs like ocvector) are stored in the `usage` map and handled via GType registration to avoid dependencies.

**References**:
- Plan 1.3: Configuration Storage Format section (config.2.json)
- Plan 1.3: Files to Create section
- Plan 1.4: Phase 3: Configuration Version Management section

---

### 9. Usage Configuration Sections

**Purpose**: Allow model usage configurations (default_model, title_model) and external libraries (like ocvector) to have configuration sections in Config2 without creating dependencies. Uses GType registration for deserialization of any property.

**Status**: ⏳ **NEW** - Not yet implemented

**Usage Pattern**:
- Libraries register key/GType pairs for any property/section with Config2
- Config2 stores usage config sections in `usage` map as `Gee.Map<string, Object>` (usage key → deserialized object)
- Standard keys: "default_model" and "title_model" use ModelUsage type
- External libraries can register additional keys (e.g., "ocvector") with their own types
- During JSON deserialization, Config2 uses registered GType to deserialize via standard Json.Serializable
- During JSON serialization, Config2 uses standard Json.Serializable for registered types

**Methods in Config2**:
- `register_type(string key, Type gtype)` - Register GType for a property/section key

**Note**: This allows Config2 to reference model usage configurations and external configurations without creating dependencies. Libraries register key/GType pairs, and standard GObject JSON serialization handles the rest. Can be used for any property in the usage map.

**References**:
- Need for ocvector settings in config
- GType-based deserialization without interface dependencies

---

### 10. OCVector Configuration

**Purpose**: Configuration for ocvector (vector search/embedding) settings. Uses ModelUsage class.

**Status**: ✅ **IMPLEMENTED** - ocvector configuration integrated into Config2. Uses ModelUsage class registered as "ocvector.embed" and "ocvector.analysis" in Config2's usage map. Auto-creation via Database.setup_embed_usage() and Analysis.setup_analysis_usage() methods.

**Implementation**: ocvector uses `Settings.ModelUsage` class for its configuration. ocvector registers the GType for ModelUsage with Config2 using `register_type("ocvector.embed", typeof(Settings.ModelUsage))` and `register_type("ocvector.analysis", typeof(Settings.ModelUsage))`. The configuration is stored in Config2's `usage` map.

**Properties** (via ModelUsage):
- `connection` (string) - Connection URL key (references a connection from the connections map)
- `model` (string) - Embedding model name to use
- `options` (Call.Options) - Optional runtime options for embeddings (temperature, top_p, etc.)

**Example JSON** (stored in `usage` map):
```json
{
  "usage": {
    "ocvector": {
      "connection": "http://127.0.0.1:11434/api",
      "model": "nomic-embed-text",
      "options": {
        "temperature": 0.7
      }
    }
  }
}
```

**Registration**: ocvector registers ModelUsage GType:
```vala
config2.register_type("ocvector", typeof(Settings.ModelUsage));
```

**References**:
- ocvector needs embedding model configuration
- Uses ModelUsage class from Settings
- Connection reference to existing connections in Config2

---

## Configuration Storage Structure

### Version 1 (Current - config.json)
```json
{
  "url": "http://localhost:11434/api",
  "api_key": "",
  "model": "",
  "title_model": "",
  "think": true
}
```

### Version 2 (Future - config.2.json)
```json
{
  "connections": {
    "http://127.0.0.1:11434/api": {
      "name": "Local Ollama",
      "url": "http://127.0.0.1:11434/api",
      "api_key": "",
      "is_default": true
    }
  },
  "model_options": {
    "default": {
      "temperature": 0.7,
      "top_p": 0.9,
      "top_k": 40,
      "num_ctx": 2048
    },
    "llama3": {
      "temperature": 0.5,
      "num_ctx": 4096
    }
  },
  "usage": {
    "default_model": {
      "connection": "http://127.0.0.1:11434/api",
      "model": "llama3",
      "options": {}
    },
    "title_model": {
      "connection": "http://127.0.0.1:11434/api",
      "model": "llama3",
      "options": {}
    },
    "ocvector": {
      "connection": "http://127.0.0.1:11434/api",
      "model": "nomic-embed-text",
      "options": {
        "temperature": 0.7
      }
    }
  }
}
```

**Note**: The `usage` map contains model usage configurations. Standard keys like "default_model" and "title_model" use ModelUsage type. External libraries (like ocvector) register their GType with Config2 using `register_type()`. During JSON deserialization, Config2 uses registered GType to deserialize via standard Json.Serializable.

## Library Organization

### libollmchat/
Core configuration classes for the OLLMchat library.

**Existing**:
- `Config.vala` - Version 1 config (single client)
- `Call/Options.vala` - Runtime API options

**To Create**:
- `Settings/Connection.vala` - Connection configuration
- `Settings/ModelUsage.vala` - Model usage configuration (connection, model, options)
- `Settings/ChatDefaults.vala` - Chat-specific settings (low priority)
- `Settings/ModelOptions.vala` - Model options defaults and overrides (if needed as separate class, otherwise just use map in Config2)
- `Settings/Config2.vala` - Main serializable configuration holder (version 2)

**Created**:
- `Settings/Config1.vala` - Version 1 configuration (copy of Config.vala) ✅
- `Settings/Config2.vala` - Main configuration holder (version 2) ✅
- `Settings/Connection.vala` - Connection configuration ✅
- `Settings/ModelUsage.vala` - Model usage configuration ✅

### Rationale

- **Settings/** subdirectory: All ollmchat configuration classes go here (Connection, ModelUsage, ChatDefaults, Config1, Config2, ModelOptions if needed)
- **Settings/Config2.vala**: Main serializable holder in Settings namespace - contains connections map and model_options map (model name → Call.Options)
- **Settings/Config1.vala**: Copy of original Config class in Settings namespace for version 1 format support
- **Call/Options.vala**: Remains in Call/ as it's part of the API call infrastructure (not a settings class), used directly in Config2's model_options map
- **Note**: In phase 1, Settings files are not added to the build system - will be reviewed after implementation

## Implementation Priority

1. **High Priority**:
   - `Settings/Connection.vala` - Required for multiple client support (1.3)
   - `Settings/ModelUsage.vala` - Model usage configuration (connection, model, options) - used by ocvector and other features
   - `Settings/Config2.vala` - Main serializable holder for version 2 config format (1.3) - contains connections map and model_options map (model name → Call.Options), supports GType registration for external configs
   - `Settings/ModelOptions.vala` - Only if needed as separate class, otherwise model_options is just a map in Config2 (1.3, 1.5)

2. **Medium Priority**:
   - `Settings/Config1.vala` - ✅ Created (copy of Config.vala), required for migration from version 1 (1.4)

3. **Low Priority**:
   - `Settings/ChatDefaults.vala` - Nice to have, not critical (1.4 Phase 6)

## Dependencies

- All Settings classes should implement `Json.Serializable` for persistence
- `Config2` is the main serializable holder that contains:
  - `connections` map: `Gee.Map<string, Settings.Connection>`
  - `model_options` map: `Gee.Map<string, Call.Options>` (model name → options)
  - `usage` map: `Gee.Map<string, Object>` (usage key → model usage objects)
    - Standard keys: "default_model", "title_model" (ModelUsage type)
    - External keys: e.g., "ocvector" (registered types)
- `Config2` uses `Settings/Connection` for connections and `Call.Options` directly for model options
- `Config2` uses GType registration (key/GType pairs) for property deserialization (avoids dependencies, uses standard Json.Serializable)
- `Settings/ModelOptions` class only needed if we want a wrapper/helper class, otherwise just use the map directly in Config2
- Migration path: `Settings.Config1` reads old `Config.vala` format and creates new `Config2` instance
- External libraries (like ocvector) register GType with Config2 using `register_type()` to handle their config sections in the `usage` map

## Notes

- `Call.Options` is already implemented and should be reused for model options
- All Settings classes should follow the same pattern as existing `Config.vala` (Json.Serializable, clone method, etc.)
- `Config2` is the main serializable holder class - it contains:
  - Connections map (connection URL → Settings.Connection)
  - Model options map (model name → Call.Options) - connection is not important here
- No separate ModelConfig class needed - just use a map of model name to Call.Options in Config2
- `Settings.Config1` is a copy of the original Config class, moved to Settings namespace for version 1 format support
- All ollmchat configuration classes go in `Settings/` subdirectory (Connection, ModelUsage, ChatDefaults, Config1, Config2, ModelOptions if needed)
- ocvector uses `Settings.ModelUsage` and registers it with Config2 using `register_type("ocvector", typeof(Settings.ModelUsage))`
- Property deserialization uses GType registration - libraries register key/GType pairs with Config2 for any property
- Model usage configurations (default_model, title_model) and external configs (like ocvector) are stored in Config2's `usage` map via key/GType registration
- **Note**: In phase 1, these Settings files are not added to the build system - will be reviewed after implementation

