# 2.1.7. Line Number Mode (Legacy) and Mode Separation

## Overview

Add mode separation to EditMode tool, preventing mixing of AST path and line number formats in the same session. This ensures consistency and prevents errors from format mismatches.

## Status

ðŸ“‹ **PLANNED (UPDATED FOR STREAM REFACTOR)** - Aligns with 2.1.6 Stream class migration

## Related Plans

- **2.1.4** - AST Path Support for EditFile Integration (main plan)
- **2.1.6** - Stream Class Refactoring (prerequisite)
- **2.1.8** - AST Path Mode (Incremental Application)

## Purpose

Prevent mixing AST path and line number changes in same session, which would cause inconsistencies. Enforce mode consistency and provide clear error messages when formats are mixed.

## Implementation

- [ ] **Mode Tracking (Request-owned):**
  - [ ] Default to AST path mode when edit mode is enabled
  - [ ] Add `edit_mode` to `Request` (get/set/default for serialization):
    ```vala
    public string edit_mode { get; set; default = "ast_path"; } // "line_numbers" or "ast_path"
    ```
  - [ ] `Stream` reads/writes `request.edit_mode` when enforcing mode
  - [ ] **Rationale:** `Request` is serialized; `Stream` is transient

- [ ] **Request: Enable Response Format (AST default):**
  - [ ] Extend `INSTRUCTIONS_LINE_RANGE` (or add a new string) to describe
    AST path format as the default expected format
  - [ ] Update `execute_request()` LLM message to include:
    - [ ] "Default mode: AST path"
    - [ ] Expected format example: `type:Namespace-Class-Method`
    - [ ] Note that line-number mode is only used if a line-number block
      is provided first
  - [ ] Keep `complete_file=true` instructions unchanged (bare language tag)

- [ ] **Mode Detection and Enforcement (Stream.try_parse_code_block_opener):**
  - [ ] Determine detected format:
    - [ ] AST path format when tag does not end with `:start:end`
    - [ ] Line number format when tag ends with `:start:end`
- [ ] If the first valid block is line-number format, switch `request.edit_mode`
    to line-number mode for the remainder of the session
  - [ ] If `edit_mode` is set and the detected format mismatches:
    - [ ] Build descriptive error message
    - [ ] Create `FileChange.with_error(...)` and attach the message
    - [ ] Allow parsing to continue; report the error in the final reply
  - [ ] If format matches mode: continue normal parsing

- [ ] **Complete File Interaction:**
  - [ ] When `complete_file=true`, only allow bare language tag
  - [ ] If a line/AST tag is supplied, treat it as a format error
  - [ ] Report via `FileChange.with_error(...)` in the final reply

- [ ] **Error Aggregation (Final Reply):**
  - [ ] Ensure `FileChange.with_error(...)` entries are retained in
    `Stream.changes` so they appear in `send_response()` summaries
  - [ ] Use `FileChange.get_description()` plus the error message to
    produce consistent "was not applied" lines
  - [ ] Do not emit per-block UI errors while the message is streaming

- [ ] **Line Number Mode Behavior (`request.edit_mode == "line_numbers"`):**
  - [ ] Required format: `type:startline:endline`
  - [ ] Changes are applied after message completion via
    `finalize_and_handle_response()` â†’ `apply_line_based_changes()`
  - [ ] File history created once via `create_file_history()`

- [ ] **AST Path Mode Behavior (`request.edit_mode == "ast_path"`):**
  - [ ] Required format: `type:Namespace-Class-Method`
  - [ ] Changes are queued and applied incrementally via
    `pending_changes` â†’ `process_next_change()`
  - [ ] Response is sent once queue is empty and message is completed

- [ ] **Error Messages (Final Reply):**
  - [ ] Use consistent messages in the final reply:
    - [ ] Line mode + AST path detected
    - [ ] AST mode + line numbers detected
  - [ ] Include required format in the message

- [ ] **Tool Documentation:**
  - [ ] Update `Tool.description` to be explicit about default AST path mode
  - [ ] Document mode separation and format requirements
  - [ ] No new parameters required; mode is inferred from first valid block

- [ ] **Enable Response Messaging:**
  - [ ] When edit mode is enabled, include the expected format in the
    response message (AST path format by default, line numbers if switched)

## Files to Modify

- [ ] `liboctools/EditMode/Request.vala`
  - [ ] Add `edit_mode` property (get/set/default so it serializes):
    ```vala
    public string edit_mode { get; set; default = "ast_path"; }
    ```
  - [ ] Validate `edit_mode` on request start and return error if invalid:
    ```vala
    if (this.edit_mode != "ast_path"
        && this.edit_mode != "line_numbers"
        && this.edit_mode != "complete_file") {
        throw new GLib.IOError.INVALID_ARGUMENT(
            "edit_mode must be one of: ast_path, line_numbers, complete_file");
    }
    ```
  - [ ] Expand the enable response to state default format:
    ```vala
    string instructions = (this.edit_mode == "line_numbers"
        ? INSTRUCTIONS_LINE_RANGE
        : (this.edit_mode == "complete_file" ? INSTRUCTIONS_COMPLETE_FILE : INSTRUCTIONS_AST));
    ```
  - [ ] `INSTRUCTIONS_LINE_RANGE` (line numbers required):
    ```text
    Code blocks must include line range in format type:startline:endline e.g.,
    
    ```javascript:10:15
    the output goes here
    ```
    
    The range is inclusive of the start line and exclusive of the end line. Line numbers are 1-based.
    ```
- [ ] `INSTRUCTIONS_AST` (default mode):
  ```text
  Code blocks must include AST path in format type:Namespace-Class-Method e.g.
  Any other format will be ignored.
  
  ```vala:OLLMchat-Client-chat
  public void chat() {
      // new implementation
  }
  ```
  
  AST path operations:
  - Default (no suffix) = replace target
  - `:before` = insert before target
  - `:after` = insert after target
  - `:remove` = remove target
  
  Example (before):
  ```vala:OLLMchat-Client-chat:before
  // inserted before chat()
  ```
  
  Example (after):
  ```vala:OLLMchat-Client-chat:after
  // inserted after chat()
  ```
  
  Example (remove):
  ```vala:OLLMchat-Client-chat:remove
  ```
  ```

- [ ] `liboctools/EditMode/Stream.vala`
  - [ ] Enforce mode using `request.edit_mode`:
    ```vala
    // Mode is one of: complete_file, ast_path, line_numbers
    var active_mode = this.request.edit_mode; // "complete_file", "ast_path", or "line_numbers"

    // If complete_file, only accept bare language tag blocks.
    // If line_numbers, only accept line ranges.
    // If ast_path, only accept ast-path blocks.
    // If mismatch, create FileChange.with_error(...) and return true.
    ```
  - [ ] For mismatches, create `FileChange.with_error(...)` and store it in
    `changes` so `send_response()` reports it at the end.

- [ ] `liboctools/EditMode/Tool.vala`
  - [ ] Update description text:
    ```vala
    Supported formats:
    - ast_path (default, preferred): use type:Namespace-Class-Method
    - complete_file: replace or create a full file with a bare language tag
    - line_numbers (not recommended): edit an existing file with type:startline:endline
    An editing session cannot mix output formats.
    ```

## Example Usage

### Example 1: AST Path After Line Number Mode Established
**Scenario:** The first valid block used line numbers, then an AST path block appears

**Code Block:**
```
```vala:OLLMchat-Client-chat
public void chat() {
    // new implementation
}
```
```

**End-of-Message Reply Error:**
```
Change to `ast-path:OLLMchat-Client-chat` rejected: AST path format specified but line number mode is active. Use `type:startline:endline` format instead.
Active mode: Line numbers
Required format: `vala:45:67`
```

**End-of-Session LLM Reply:**
```
File 'example.vala' has been updated. It now has 150 lines.

Some changes were applied.

  â€¢ Change to `ast-path:OLLMchat-Client-chat` was not applied: AST path format specified but line number mode is active. Use format: `type:startline:endline` instead.
```

### Example 2: Line Numbers After AST Path Mode Established
**Scenario:** The first valid block used AST path, then a line number block appears

**Code Block:**
```
```vala:45:67
public void chat() {
    // new implementation
}
```
```

**End-of-Message Reply Error:**
```
Change at lines 45-67 rejected: Line number format specified but AST path mode is active. Use `type:Namespace-Class-Method` format instead.
Active mode: AST paths
Required format: `vala:OLLMchat-Client-chat`
```

**End-of-Session LLM Reply:**
```
File 'example.vala' has been updated. It now has 150 lines.

Some changes were applied.

  â€¢ Change at lines 45-67 was not applied: Line number format specified but AST path mode is active. Use format: `type:Namespace-Class-Method` instead.
```
