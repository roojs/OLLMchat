# 2.1.7. Line Number Mode (Legacy) and Mode Separation

## Overview

Add mode separation to EditMode tool, preventing mixing of AST path and line number formats in the same session. This ensures consistency and prevents errors from format mismatches.

## Status

ðŸ“‹ **PLANNED** - Part of 2.1.4 AST Path Support for EditFile Integration

## Related Plans

- **2.1.4** - AST Path Support for EditFile Integration (main plan)
- **2.1.6** - Stream Class Refactoring (prerequisite)
- **2.1.8** - AST Path Mode (Incremental Application)

## Purpose

Prevent mixing AST path and line number changes in same session, which would cause inconsistencies. Enforce mode consistency and provide clear error messages when formats are mixed.

## Implementation

- [ ] **Mode Selection Parameter:**
  - [ ] Add `use_line_numbers` boolean parameter to Request class (default = false)
  - [ ] When `use_line_numbers = true`: Use line number mode (legacy behavior)
  - [ ] When `use_line_numbers = false` (default): Use AST path mode (new behavior)
  - [ ] **Rationale:** Prevents mixing AST path and line number changes in same session, which would cause inconsistencies

- [ ] **Mode Detection and Enforcement:**
  - [ ] Add `edit_mode` property to Request class to track active mode:
    ```vala
    private string? edit_mode = null; // "line_numbers" or "ast_path" or null (not yet determined)
    ```
  - [ ] Add `ignored_changes` tracking to Request class:
    ```vala
    private Gee.ArrayList<string> ignored_changes = new Gee.ArrayList<string>();
    // Store detailed descriptions of ignored changes for reporting
    // Format: "Change to [target] was ignored: [reason]"
    ```
  - [ ] Update `Stream.try_parse_code_block_opener()` to detect and enforce mode:
    - [ ] **First code block detection:** Determine mode from format detected:
      - [ ] If AST path format detected (`ast-path:` prefix): Set `edit_mode = "ast_path"`
      - [ ] If line number format detected (`type:startline:endline`): Set `edit_mode = "line_numbers"`
      - [ ] If `use_line_numbers = true` parameter is set: Force `edit_mode = "line_numbers"` (override detection)
      - [ ] If `use_line_numbers = false` (default): Allow detection or force `edit_mode = "ast_path"` if parameter explicitly set
    - [ ] **Subsequent code blocks:** Enforce mode consistency:
      - [ ] If `edit_mode == "line_numbers"` and AST path format detected:
        - [ ] Extract AST path from code block opener (e.g., "Namespace-Class-Method")
        - [ ] Build descriptive message: "Change to `ast-path:XXX` was ignored: AST path format was specified, but line number mode is active (use_line_numbers=true). Use format: `type:startline:endline` instead."
        - [ ] Add descriptive message to `ignored_changes`
        - [ ] Send UI error with same descriptive message
        - [ ] Return `false` from `try_parse_code_block_opener()` to skip the code block
        - [ ] Do NOT add change to `changes` array
      - [ ] If `edit_mode == "ast_path"` and line number format detected:
        - [ ] Extract line numbers from code block opener (e.g., "10:15")
        - [ ] Build descriptive message: "Change at lines XXX-YYY was ignored: Line number format was specified, but AST path mode is active (use_line_numbers=false). Use format: `type:ast-path:Namespace-Class-Method` instead."
        - [ ] Add descriptive message to `ignored_changes`
        - [ ] Send UI error with same descriptive message
        - [ ] Return `false` from `try_parse_code_block_opener()` to skip the code block
        - [ ] Do NOT add change to `changes` array
      - [ ] If format matches active mode: Process normally and add to `changes` array

- [ ] **Line Number Mode Behavior (`use_line_numbers = true` or `edit_mode == "line_numbers"`):**
  - [ ] Line numbers are required in code block format: `type:startline:endline`
  - [ ] All changes accumulate in `changes` array (existing behavior)
  - [ ] Changes are applied at end of session via `apply_all_changes()` (no incremental application)
  - [ ] File history is created in `apply_all_changes()` before applying changes (existing behavior)
  - [ ] If AST path format is detected: Ignore the code block and track in `ignored_changes`

- [ ] **AST Path Mode Behavior (`use_line_numbers = false` and `edit_mode == "ast_path"`):**
  - [ ] AST paths are required in code block format: `type:ast-path:Namespace-Class-Method`
  - [ ] If line number format is detected: Ignore the code block and track in `ignored_changes`
  - [ ] **Note:** Incremental application will be implemented in Phase 8, but mode separation must be done first

- [ ] **Ignored Changes Reporting:**
  - [ ] At end of session (`on_message_completed()` â†’ `handle_apply_changes_response()`):
    - [ ] Check if `ignored_changes.size > 0`
    - [ ] If ignored changes exist, append detailed summary to success/error message:
      ```vala
      if (this.ignored_changes.size > 0) {
          message += "\n\n" + this.ignored_changes.size.to_string() + " code block(s) were ignored due to mode mismatch:\n";
          foreach (var ignored in this.ignored_changes) {
              message += "  â€¢ " + ignored + "\n";
          }
          message += "\nAll code blocks in a session must use the same format. ";
          message += (this.edit_mode == "line_numbers") 
              ? "Use line number format: `type:startline:endline`"
              : "Use AST path format: `type:ast-path:Namespace-Class-Method`";
      }
      ```
    - [ ] Also send UI message with detailed ignored changes summary:
      ```vala
      if (this.ignored_changes.size > 0) {
          var ignored_msg = this.ignored_changes.size.to_string() + " code block(s) were ignored:\n\n";
          foreach (var ignored in this.ignored_changes) {
              ignored_msg += "  â€¢ " + ignored + "\n";
          }
          ignored_msg += "\nReason: Mode mismatch. All code blocks must use the same format.\n";
          ignored_msg += "Active mode: " + (this.edit_mode == "line_numbers" ? "Line numbers" : "AST paths");
          this.send_ui("txt", "Ignored Changes", ignored_msg);
      }
      ```

- [ ] **Error Messages (Real-time):**
  - [ ] When code block is ignored, send immediate UI error with full context:
    - [ ] Line number mode + AST path detected:
      - [ ] Extract AST path (e.g., "OLLMchat-Client-chat")
      - [ ] Message: "Ignored: Change to `ast-path:XXX` - AST path format specified but line number mode is active. Use `type:startline:endline` format instead."
    - [ ] AST path mode + line numbers detected:
      - [ ] Extract line numbers (e.g., "45:67")
      - [ ] Message: "Ignored: Change at lines XXX-YYY - Line number format specified but AST path mode is active. Use `type:ast-path:Namespace-Class-Method` format instead."
  - [ ] Include active mode and parameter setting in error messages:
    - [ ] "Active mode: [mode] (use_line_numbers=[value])"
    - [ ] "Required format: [format example]"

- [ ] **Tool Documentation:**
  - [ ] Update `Tool.parameter_description` to document `use_line_numbers` parameter:
    ```vala
    @param use_line_numbers {boolean} [optional] If true, use legacy line number mode. All code blocks must use type:startline:endline format. AST path format will be ignored. If false (default), use AST path mode. All code blocks must use type:ast-path:Namespace-Class-Method format. Line number format will be ignored. Default is false.
    ```
  - [ ] Update `Tool.description` to mention mode separation and format requirements

- [ ] **Implementation Details:**
  - [ ] In `Stream.try_parse_code_block_opener()`:
    - [ ] Check `use_line_numbers` parameter first to set initial mode if not yet determined
    - [ ] Detect format from code block opener
    - [ ] If mode not yet set: Set mode based on detected format (or parameter)
    - [ ] If mode already set: Check if format matches mode
      - [ ] If mismatch: 
        - [ ] Extract target identifier (AST path or line numbers) from code block opener
        - [ ] Build descriptive ignored message using helper method (see below)
        - [ ] Add to `ignored_changes` with descriptive message
        - [ ] Send immediate UI error with descriptive message
        - [ ] Return `false` to skip code block
      - [ ] If match: Process normally
  - [ ] Add helper method to build descriptive ignored change messages:
    ```vala
    private string build_ignored_change_message(string detected_format, string target_identifier)
    {
        if (this.edit_mode == "line_numbers" && detected_format == "ast_path") {
            return "Change to `ast-path:" + target_identifier + "` was ignored: AST path format was specified, but line number mode is active (use_line_numbers=true). Use format: `type:startline:endline` instead.";
        } else if (this.edit_mode == "ast_path" && detected_format == "line_numbers") {
            return "Change at lines " + target_identifier + " was ignored: Line number format was specified, but AST path mode is active (use_line_numbers=false). Use format: `type:ast-path:Namespace-Class-Method` instead.";
        }
        return "Change was ignored: Format mismatch.";
    }
    ```
  - [ ] In `Stream.add_linebreak()` when code block closes:
    - [ ] Only add to `changes` array if code block was successfully parsed (not ignored)
    - [ ] Skip adding change if `try_parse_code_block_opener()` returned `false` due to mode mismatch
    - [ ] Check if code block was ignored (tracked via flag or state) before adding to changes
  - [ ] In `reply_with_errors()` and `handle_apply_changes_response()`:
    - [ ] Include ignored changes summary in reply message to LLM with full context
    - [ ] Send separate detailed UI message about ignored changes with active mode information
    - [ ] Format messages to be clear and actionable (show what was attempted, why it failed, what to use instead)

## Files to Modify

- [ ] `liboctools/EditMode/Request.vala` - Add `use_line_numbers` parameter, `edit_mode` property, `ignored_changes` tracking
- [ ] `liboctools/EditMode/Stream.vala` - Add mode detection and enforcement in `try_parse_code_block_opener()`
- [ ] `liboctools/EditMode/Tool.vala` - Document `use_line_numbers` parameter in parameter_description

## Example Usage

### Example 1: AST Path in Line Number Mode
**Scenario:** `use_line_numbers=true` is set, but LLM provides AST path format

**Code Block:**
```
```vala:ast-path:OLLMchat-Client-chat
public void chat() {
    // new implementation
}
```
```

**Immediate UI Error:**
```
Ignored: Change to `ast-path:OLLMchat-Client-chat` - AST path format specified but line number mode is active. Use `type:startline:endline` format instead.
Active mode: Line numbers (use_line_numbers=true)
Required format: `vala:45:67`
```

**End-of-Session LLM Reply:**
```
File 'example.vala' has been updated. It now has 150 lines.

1 code block(s) were ignored due to mode mismatch:
  â€¢ Change to `ast-path:OLLMchat-Client-chat` was ignored: AST path format was specified, but line number mode is active (use_line_numbers=true). Use format: `type:startline:endline` instead.

All code blocks in a session must use the same format. Use line number format: `type:startline:endline`
```

### Example 2: Line Numbers in AST Path Mode
**Scenario:** `use_line_numbers=false` (default), but LLM provides line number format

**Code Block:**
```
```vala:45:67
public void chat() {
    // new implementation
}
```
```

**Immediate UI Error:**
```
Ignored: Change at lines 45-67 - Line number format specified but AST path mode is active. Use `type:ast-path:Namespace-Class-Method` format instead.
Active mode: AST paths (use_line_numbers=false)
Required format: `vala:ast-path:OLLMchat-Client-chat`
```

**End-of-Session LLM Reply:**
```
File 'example.vala' has been updated. It now has 150 lines.

1 code block(s) were ignored due to mode mismatch:
  â€¢ Change at lines 45-67 was ignored: Line number format was specified, but AST path mode is active (use_line_numbers=false). Use format: `type:ast-path:Namespace-Class-Method` instead.

All code blocks in a session must use the same format. Use AST path format: `type:ast-path:Namespace-Class-Method`
```
