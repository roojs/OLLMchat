# 1.2 Incremental Refactor Strategy

## Problem

The original 1.2.* plans (1.2.1, 1.2.2, 1.2.3) are structured as "big bang" changes that would leave the code in an unusable state after each step:

- **1.2.1**: Removing properties from Client breaks all code that uses `client.model`, `client.options`, etc.
- **1.2.2**: Removing signals breaks all code that connects to them
- **1.2.3**: Changing Call.Base to take Connection breaks all Call creation points

## Solution: Incremental "Stride" Approach

Instead of removing old code first, we:
1. **Add new code paths** (make things support both old and new ways)
2. **Migrate call sites incrementally** (one file/feature at a time)
3. **Remove old code paths last** (only after all call sites are migrated)

This ensures the code remains usable after each step.

## Revised Implementation Order

### Phase 1: Add New Code Paths (Backward Compatible)

#### Step 1.1: Make Chat Support Both Realized and Real Properties

**Goal**: Allow Chat to have real properties while still supporting realized properties that delegate to Client.

**Changes**:
- Add real properties to Chat: `refactor_stream`, `refactor_format`, `refactor_think`, `refactor_keep_alive`, `refactor_tools`
  - **Note**: `refactor_` prefix makes it clear these are temporary properties for refactoring
- Update getters to check if real property is set, otherwise fall back to `client.*`
- Update setters to set real properties
- This allows gradual migration: some Chats use real properties, others use realized

**Files**:
- `libollmchat/Call/Chat.vala` - Add real properties with fallback logic

**Result**: Code still works, but Chat can now have independent properties

#### Step 1.2: Add Connection Support to Call.Base (Keep Client Support)

**Goal**: Allow Call.Base to accept either Client or Connection.

**Changes**:
- Add named constructor: `Base.new_connection_refactor(Connection connection)` (Vala doesn't support overloaded constructors)
- Keep existing constructor: `Base(Client client)` for backward compatibility
- Store both `client` and `connection` (connection can be derived from client)
- Update methods to use `connection` when available, fall back to `client.connection`
- This allows gradual migration: some Calls use Connection directly, others use Client

**Files**:
- `libollmchat/OllamaBase.vala` - Support both client and connection
- `libollmchat/Call/Base.vala` - Support both constructors

**Result**: Code still works, but Calls can now take Connection directly

#### Step 1.3: Add Session Permission Provider (Keep Client Support)

**Goal**: Allow permission_provider to be on Session while still supporting Client.

**Changes**:
- Add `permission_provider` property to Session
- Update tools to check `chat_call.session.permission_provider` first, fall back to `chat_call.client.permission_provider`
- This allows gradual migration: some Sessions have permission_provider, others use Client

**Files**:
- `libollmchat/History/Session.vala` - Add permission_provider property
- `libollmchat/Tool/RequestBase.vala` - Update to check Session first, then Client

**Result**: Code still works, but Session can now have permission_provider

### Phase 2: Migrate Call Sites Incrementally

#### Step 2.1: Migrate One Chat Creation Point

**Goal**: Update one file to use new patterns, verify it works.

**Strategy**: Start with the simplest/most isolated file.

**Example**: Update `Client.chat()` method:
- Create Chat with real properties instead of relying on Client defaults
- Pass explicit model/options
- Verify it still works

**Files**:
- `libollmchat/Client.vala` - Update `chat()` method

**Result**: One call site migrated, code still works

#### Step 2.2-N: Migrate Remaining Call Sites One by One

**Goal**: Update each Chat creation point individually.

**Order** (from simplest to most complex):
1. `Client.chat()` - Simple, isolated
2. `Client.embed()` / `embed_array()` - Simple, isolated
3. `Client.generate()` - Simple, isolated
4. `Config2.create_chat()` - Already uses explicit options (good pattern)
5. `Analysis` - Already uses explicit options (good pattern)
6. `EmptySession.send_message()` - More complex
7. `SessionPlaceholder` - More complex
8. `Manager.new_client()` - More complex
9. `AgentHandler` - Most complex (has tools, signals)
10. `CodeAssistantHandler` - Most complex (has tools, signals)

**For each**:
- Update to create Chat with real properties
- Update to pass Connection instead of Client (if Phase 1.2 is done)
- Update to add tools to Chat directly
- Update to use Session.permission_provider (if Phase 1.3 is done)
- Test that it still works

**Result**: All call sites migrated, code still works

### Phase 3: Remove Old Code Paths

#### Step 3.1: Remove Realized Properties from Chat

**Goal**: Remove fallback logic, Chat now only uses real properties.

**Prerequisite**: All Chat creation points must be migrated (Phase 2 complete)

**Changes**:
- Remove realized property getters that delegate to `client.*`
- Remove fallback logic
- Chat now only has real properties

**Files**:
- `libollmchat/Call/Chat.vala` - Remove realized properties

**Result**: Chat is simpler, but Client still has properties (for backward compatibility)

#### Step 3.2: Remove Properties from Client

**Goal**: Remove properties from Client that are no longer needed.

**Prerequisite**: All Chat creation points use real properties (Step 3.1 complete)

**Changes**:
- Remove `model`, `stream`, `format`, `think`, `keep_alive`, `options` from Client
- Remove `tools`, `permission_provider`, `streaming_response` from Client
- Update Client documentation

**Files**:
- `libollmchat/Client.vala` - Remove properties

**Result**: Client is thinner, but code still works (Chats have their own properties)

#### Step 3.3: Remove Client Support from Call.Base

**Goal**: Call.Base only takes Connection, not Client.

**Prerequisite**: All Call creation points use Connection (Phase 2 complete)

**Changes**:
- Remove `Base(Client client)` constructor
- Remove `client` property from OllamaBase
- Update all methods to only use `connection`

**Files**:
- `libollmchat/OllamaBase.vala` - Remove client support
- `libollmchat/Call/Base.vala` - Remove client constructor

**Result**: Call.Base is simpler, but code still works

#### Step 3.4: Remove Signals from Client

**Goal**: Remove synchronous signals, keep only asynchronous ones.

**Prerequisite**: All signal connections must be updated (separate migration)

**Changes**:
- Remove `chat_send`, `message_created`, `stream_content` signals
- Keep `stream_chunk`, `stream_start`, `tool_message` (asynchronous only)

**Files**:
- `libollmchat/Client.vala` - Remove signal declarations and emissions

**Result**: Client has fewer signals, but code still works (callers handle state directly)

## Key Principles

1. **Never break existing code** - Each step must leave the code in a usable state
2. **Add before removing** - Always add new code paths before removing old ones
3. **Migrate incrementally** - Update one file/feature at a time, test, then move on
4. **Remove last** - Only remove old code after all call sites are migrated

## Benefits

- **Incremental progress** - Can stop at any step and code still works
- **Easier testing** - Each step can be tested independently
- **Lower risk** - If something breaks, it's isolated to one file
- **Easier review** - Smaller, focused changes are easier to review

## Migration Checklist

### Phase 1: Add New Code Paths
- [ ] Step 1.1: Chat supports both realized and real properties
- [ ] Step 1.2: Call.Base supports both Client and Connection
- [ ] Step 1.3: Session has permission_provider with Client fallback

### Phase 2: Migrate Call Sites
- [ ] Step 2.1: Client.chat() migrated
- [ ] Step 2.2: Client.embed() / embed_array() migrated
- [ ] Step 2.3: Client.generate() migrated
- [ ] Step 2.4: Config2.create_chat() migrated
- [ ] Step 2.5: Analysis migrated
- [ ] Step 2.6: EmptySession.send_message() migrated
- [ ] Step 2.7: SessionPlaceholder migrated
- [ ] Step 2.8: Manager.new_client() migrated
- [ ] Step 2.9: AgentHandler migrated
- [ ] Step 2.10: CodeAssistantHandler migrated

### Phase 3: Remove Old Code Paths
- [ ] Step 3.1: Remove realized properties from Chat
- [ ] Step 3.2: Remove properties from Client
- [ ] Step 3.3: Remove Client support from Call.Base
- [ ] Step 3.4: Remove signals from Client

## Notes

- **Signal migration** (1.2.2) should be done separately, as it requires updating all signal connections first
- **Connection migration** (1.2.3) can be done in parallel with property migration (1.2.1)
- **Priority**: Focus on property migration first (1.2.1), as it's the most impactful

