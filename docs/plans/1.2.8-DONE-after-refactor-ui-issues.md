# 1.2.8. After-Refactor UI Issues

## Overview

Fix UI issue discovered after the message creation refactor: User messages not appearing in chat window because "user-sent" messages are not being created.

## Problem Summary

**Root Cause**: When `Session.send()` receives a "user" message, it doesn't create a "user-sent" message for UI display:
- `"user"` role messages have `is_ui_visible = false` (see [`libollmchat/Message.vala:90`](libollmchat/Message.vala))
- `ChatWidget.on_message_created()` filters out messages where `!m.is_ui_visible` (line 306)
- Only `"user-sent"` messages have `is_ui_visible = true` and are displayed (line 318)
- The agent needs "user" messages for API requests (filters session.messages for "user" role)

**Impact**: 
- User messages don't appear in the chat window
- Waiting indicator doesn't show (because the "user-sent" message never appears, so the indicator code at line 320 never executes)

**Solution**: 
- `Session.send()` should create a "user-sent" message from the "user" message, add it to session.messages, and emit the signal
- `Agent.send_async()` should add the "user" message to session.messages after processing the content

## Implementation Steps

### Step 1: Create "user-sent" Message in Session.send() for UI Display

**File**: [`libollmchat/History/Session.vala`](libollmchat/History/Session.vala)

**Problem**: The AgentHandler filters `session.messages` and only includes messages with role "user" for API requests (see [`libollmchat/Agent/Base.vala:285-286`](libollmchat/Agent/Base.vala)). The UI needs "user-sent" messages for display (is_ui_visible = true), but the API needs "user" messages.

**Solution**: When `Session.send()` receives a "user" message, it should:
1. Create a "user-sent" message from the "user" message content
2. Add "user-sent" to `session.messages`
3. Emit `message_added` signal for "user-sent" (so UI displays it immediately)
4. Pass the "user" message to `agent.send_async()` (agent will add "user" message after processing)

**Update `Session.send()`** (around line 559):
```vala
public override async void send(Message message, GLib.Cancellable? cancellable = null) throws Error
{
    // If "user" message, create "user-sent" first for UI display
    if (message.role == "user") {
        // Create "user-sent" message for UI (is_ui_visible = true)
        var user_sent_msg = new Message("user-sent", message.content);
        
        // Add "user-sent" to session.messages
        this.messages.add(user_sent_msg);
        
        // Emit message_added signal for "user-sent" so UI displays it immediately
        this.manager.message_added(user_sent_msg, this);
    } else {
        // For non-user messages, add directly to session history
        this.messages.add(message);
        
        // Emit message_added signal to notify UI
        this.manager.message_added(message, this);
    }
    
    // If not user message, we're done
    if (message.role != "user") {
        return;
    }
    
    // User message - ensure agent handler is set (create if needed)
    this.ensure_agent_handler();
    
    // Session has reference to AgentHandler
    if (this.agent != null) {
        yield this.agent.send_async(message, cancellable);
        // Set running state to true after request starts
        this.is_running = true;
    } else {
        throw new OllamaError.INVALID_ARGUMENT("No agent available for session");
    }
}
```

### Step 2: Agent Adds "user" Message After Processing

**File**: [`libollmchat/Agent/Base.vala`](libollmchat/Agent/Base.vala) and [`liboccoder/Agent.vala`](liboccoder/Agent.vala)

**Solution**: After the agent processes the user content (builds system prompt, filters messages, etc.), it should add the "user" message to `session.messages` before sending to API.

**Update `Agent.send_async()`** (around line 272 in Base.vala, line 52 in Agent.vala):
```vala
public virtual async void send_async(Message message, GLib.Cancellable? cancellable = null) throws GLib.Error
{
    // Build full message history from this.session
    var messages = new Gee.ArrayList<Message>();
    
    // ... existing system prompt generation ...
    
    // Add the current "user" message to session.messages (after processing)
    // This ensures the "user" message is in session.messages for API filtering
    this.session.messages.add(message);
    
    // Filter and add messages from this.session.messages (full conversation history)
    // Filter to get API-compatible messages (system, user, assistant, tool)
    foreach (var msg in this.session.messages) {
        // Filter: only include API-compatible message roles
        if (msg.role == "user" 
            || msg.role == "assistant" || msg.role == "tool") {
            messages.add(msg);
        }
        // Skip: "user-sent", "ui", "think-stream", "content-stream", "end-stream", "done", etc.
    }
    
    // ... rest of existing code ...
}
```

**Why this works**:
- UI creates "user" message → Session.send() receives it
- Session.send() creates "user-sent" → adds to session.messages → emits signal → UI displays it
- Session.send() passes "user" message to agent.send_async()
- Agent processes content, then adds "user" message to session.messages
- Agent filters session.messages and uses "user" messages for API
- Both "user-sent" (UI) and "user" (API) messages are in session.messages

## Testing

1. Send a message - verify it appears in chat window immediately
2. Verify waiting indicator appears when "user-sent" message is displayed
3. Verify waiting indicator clears when first stream chunk arrives
4. Verify message is sent to API correctly (both "user-sent" and "user" messages in session.messages)

## Files Modified

- [`libollmchat/History/Session.vala`](libollmchat/History/Session.vala) - Create "user-sent" message from "user" message, add to session.messages, emit signal
- [`libollmchat/Agent/Base.vala`](libollmchat/Agent/Base.vala) - Add "user" message to session.messages after processing
- [`liboccoder/Agent.vala`](liboccoder/Agent.vala) - Add "user" message to session.messages after processing (if overridden)

