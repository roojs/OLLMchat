# 2.6.1.9. Overlay-Only Critical Test Suite

## Overview

Comprehensive test suite for overlay filesystem operations in bubblewrap sandbox. Tests all critical file operations that must work correctly with the overlay system.

## Status

⏳ **PLANNING** - Design phase.

## Prerequisites

- Phase 1 (2.6.1.1) must be completed
- Phase 2 (2.6.1.2) must be completed
- Phase 3 (2.6.1.3) must be completed
- Phase 4 (2.6.1.4) must be completed
- See main plan: `2.6.1-code-exec-improvements.md` for overlay details

## Goals

1. Test all critical file operations in overlay environment
2. Verify overlay correctly isolates writes
3. Verify overlay correctly copies files back to live system
4. Verify overlay cleanup works correctly
5. Ensure 100% test coverage of critical operations

## Test Structure

Tests are organized into 6 categories with 40 total tests:

### 1. Basic Creation (6 tests)
- Create empty file - `touch newfile`
- Create file with content - `echo "data" > file`
- Create nested directories + file - `mkdir -p a/b/c && touch a/b/c/file`
- Create symlink to overlay file - `ln -s target link`
- Create symlink to overlay directory - `ln -s dir linkdir`
- Create hard link - `ln file hardlink`

### 2. File Operations (6 tests)
- Append to file - `echo "more" >> file`
- Overwrite file content - `echo "new" > file`
- Truncate file - `truncate -s 0 file`
- Read file - `cat file` (verify content)
- Modify file permissions - `chmod 644 file`
- Modify file timestamps - `touch -t 202401010000 file`

### 3. Directory Operations (4 tests)
- List directory - `ls -la` (mixed upper/lower)
- Create/remove empty directory - `mkdir dir && rmdir dir`
- Traverse directory tree - `find .` (verify structure)
- Change directory permissions - `chmod 755 dir`

### 4. Move/Rename (6 tests)
- Rename file - `mv old new`
- Rename directory - `mv olddir newdir`
- Move file between directories - `mv file dir/`
- Move directory tree - `mv tree newlocation/`
- Rename open file - File with active read handle
- Move to replace existing - `mv newfile existingfile`

### 5. Deletion (5 tests)
- Delete file - `rm file`
- Delete empty directory - `rmdir dir`
- Delete directory tree - `rm -rf tree`
- Delete symlink - `rm link` (target unaffected)
- Delete with open handle - File being actively written

### 6. Type Swaps (4 tests)
- File → Directory - `rm file && mkdir file`
- Directory → File - `rmdir dir && touch dir`
- File → Symlink - `rm file && ln -s target file`
- Symlink → File - `rm link && touch link`

## Implementation Details

### Test Script: `tests/test-bubble.sh`

- Uses `test-common.sh` for shared utilities
- Uses `build` directory as target location for `oc-test-bubble` binary
- Stores test data files in `tests/data/` directory
- Each test:
  1. Sets up test environment in temporary directory
  2. Creates project structure
  3. Executes command via `oc-test-bubble --project=DIR "command"`
  4. Verifies results (file existence, content, permissions, etc.)
  5. Verifies overlay copied files correctly to live system
  6. Cleans up test environment

### Test Data Files

Test data files stored in `tests/data/`:
- Helper scripts for creating test file trees
- Expected output files for comparison
- Test fixtures (sample files, directory structures)

### Test Execution

Tests can be run individually or as a suite:
```bash
# Run all tests
./tests/test-bubble.sh

# Run specific test category
./tests/test-bubble.sh --category basic-creation

# Generate expected output files
GENERATE_EXPECTED_MODE=1 ./tests/test-bubble.sh
```

## Implementation Tasks

- [ ] Create `tests/test-bubble.sh` test script
- [ ] Create test data directory structure in `tests/data/`
- [ ] Create helper scripts for test data generation
- [ ] Implement Basic Creation tests (6 tests)
- [ ] Implement File Operations tests (6 tests)
- [ ] Implement Directory Operations tests (4 tests)
- [ ] Implement Move/Rename tests (6 tests)
- [ ] Implement Deletion tests (5 tests)
- [ ] Implement Type Swaps tests (4 tests)
- [ ] Add test summary and reporting
- [ ] Verify all tests pass with overlay system
- [ ] Document test execution and expected results

## Testing

### Test Execution

1. Build project: `meson compile -C build`
2. Run tests: `./tests/test-bubble.sh`
3. Verify all 40 tests pass
4. Check test output for any failures
5. Review test coverage

### Expected Results

- All 40 tests should pass
- Overlay should correctly isolate writes
- Overlay should correctly copy files back
- Overlay should clean up after execution
- No files should be left in overlay directories after cleanup

## Notes

- Tests focus on overlay-only operations (no network, no external dependencies)
- Tests verify both overlay isolation and file copying
- Tests verify cleanup happens correctly
- All tests use temporary directories that are cleaned up after execution
- Test data files are version-controlled for reproducibility
