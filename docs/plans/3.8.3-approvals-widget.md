# 3.8.3. Approvals Widget

## Overview

Create Approvals widget (Gtk.Box with Gtk.ListView) that displays files needing approval. Allows selecting files and opening them in codeview.

## Status

‚è≥ **TODO** - To be implemented.

## Prerequisites

- Phase 3.8.2 must be completed (ReviewFiles class)

## Goals

1. Create Approvals widget (Gtk.Box)
2. Display list of files needing approval using Gtk.ListView
3. Show file basename with visual indicators (+, strikethrough)
4. Show tooltips with full path and change type
5. Allow clicking files to open in codeview
6. Support programmatic selection with blocked handler
7. Hold reference to Gtk.Paned for size adjustments

## Implementation Details

### File to Create

- `liboccoder/Approvals.vala`

### Class Structure

```vala
namespace OLLMcoder
{
    /**
     * Widget for displaying and managing files that need approval.
     * 
     * Displays a list of files that need approval, ordered by last_modified (most recent first).
     * Allows selecting files to open in codeview. Supports visual indicators for new/deleted files.
     * Tied to ProjectManager and monitors active_project for changes.
     */
    public class Approvals : Gtk.Box
    {
        private ProjectManager project_manager;
        private Gtk.ListView list_view;
        private Gtk.SingleSelection selection;
        private Gtk.SortListModel sorted_model;
        private Gtk.Paned paned;
        private bool changing_selection = false;  // Block selection handler
        
        /**
         * Currently selected file (or null).
         */
        public File? selected_file { get; private set; default = null; }
        
        /**
         * Emitted when a file is selected/clicked.
         */
        public signal void file_selected(File file);
        
        /**
         * Emitted when approve is requested for a file.
         */
        public signal void approve_requested(File file);
        
        /**
         * Emitted when next file is requested.
         */
        public signal void next_requested();
        
        /**
         * Constructor.
         * 
         * @param project_manager The ProjectManager instance (required)
         * @param paned The Gtk.Paned widget for size adjustments (required)
         */
        public Approvals(ProjectManager project_manager, Gtk.Paned paned)
        {
            this.project_manager = project_manager;
            this.paned = paned;
            // ... initialization ...
        }
        
        // ... methods ...
    }
}
```

### Methods

1. **Setup**:
   - Constructor takes `ProjectManager` and `Gtk.Paned` as parameters
   - Monitor `project_manager.active_project_changed` signal to update backing store
   - When active_project changes: update ReviewFiles backing store from `active_project.review_files`

2. **Selection**:
   - `select_file(File file)` - Programmatically select a file (blocks handler)
   - `select_next()` - Select next file in list (blocks handler)
   - `selected_file` - Property to get currently selected file (or null)
   - `clear_selection()` - Clear selection (blocks handler)

3. **Internal**:
   - `on_selection_changed()` - Handle selection changes (only when not blocked)
   - `on_item_activated(uint position)` - Handle item click/activation
   - `create_factory()` - Create factory for list items
   - `on_items_changed(uint position, uint removed, uint added)` - Handle ReviewFiles.items_changed signal (resize pane)

### FileBase Properties

**File**: `libocfiles/FileBase.vala`

Add two new properties for approval display:

1. **`display_approval_text`** (string property):
   - Returns formatted text for display in approvals list
   - Format: "+ filename" for new files, `<s>filename</s>` for deleted files, "filename" for modified files
   - Uses Pango markup for strikethrough on deleted files
   - Determines file state from FileHistory records (check for "added", "deleted", "modified" change_type)

2. **`display_approval_tooltip`** (string property):
   - Returns tooltip text with full path and change type
   - Format: "Added /path/to/file" or "Modified /path/to/file" or "Deleted /path/to/file"
   - Determines file state from FileHistory records

**Implementation Notes**:
- Query FileHistory table to determine file state (most recent change_type for the file)
- For new files: change_type == "added" and no previous history
- For deleted files: change_type == "deleted" or file doesn't exist but record does
- For modified files: change_type == "modified" and file exists

### Factory Implementation

Create factory that binds to File properties:
- Bind label text to `file.display_approval_text`
- Bind tooltip to `file.display_approval_tooltip`
- Use Gtk.PropertyExpression for automatic updates when properties change

### Visual Indicators

- **New files**: Show "+ filename" (from `display_approval_text` property)
- **Deleted files**: Show strikethrough using Pango markup: `<s>filename</s>` (from `display_approval_text` property)
- **Modified files**: Show normal filename (from `display_approval_text` property)
- **Tooltip**: From `display_approval_tooltip` property ("Added /path/to/file" or "Modified /path/to/file" or "Deleted /path/to/file")

### Selection Management

- Block selection change handler when programmatically changing selection:
  ```vala
  private void select_file(File file) {
      this.changing_selection = true;
      // Find position of file in model
      // Set selection
      this.changing_selection = false;
  }
  ```

- Only process selection changes when not blocked:
  ```vala
  private void on_selection_changed() {
      if (this.changing_selection) {
          return;
      }
      // Update selected_file property
      // Process selection change
  }
  ```

### Active Project Monitoring

- Connect to `project_manager.active_project_changed` signal
- When active_project changes:
  - Disconnect from previous project's `review_files.items_changed` signal (if any)
  - Connect to new active_project's `review_files.items_changed` signal
  - Update backing store model to use `active_project.review_files`
  - If active_project is null, clear the list

### Pane Resizing

- Method to handle pane resizing when list changes:
  - `on_items_changed(uint position, uint removed, uint added)` - Called when ReviewFiles.items_changed signal is emitted
  - Always adjusts pane position when list changes (no conditional checks)
  - Uses `paned.set_position()` to adjust the divider position
  - May use `Idle.add()` for async adjustments (similar to WindowPane pattern)
  - Adjusts pane size within min/max constraints
  - Ensures chat widget still has reasonable minimum size
  - Reference: See `ollmapp/WindowPane.vala` for similar paned resizing patterns

## Implementation Tasks

### FileBase Properties
- [ ] Add `display_approval_text` property to FileBase class
- [ ] Add `display_approval_tooltip` property to FileBase class
- [ ] Implement logic to determine file state from FileHistory records
- [ ] Format text with "+" prefix for new files
- [ ] Format text with strikethrough for deleted files
- [ ] Format tooltip with change type and full path

### Approvals Widget
- [ ] Create `liboccoder/Approvals.vala` class
- [ ] Extend Gtk.Box
- [ ] Constructor takes `ProjectManager` and `Gtk.Paned` parameters
- [ ] Store `project_manager` and `paned` as private fields
- [ ] Create Gtk.ListView with Gtk.SingleSelection
- [ ] Create Gtk.SortListModel to sort by last_modified (descending)
- [ ] Create factory for list items (bind to `display_approval_text` and `display_approval_tooltip`)
- [ ] Add `selected_file` property
- [ ] Implement selection management with blocking
- [ ] Implement `select_file()` method
- [ ] Implement `select_next()` method
- [ ] Implement `clear_selection()` method
- [ ] Connect to `project_manager.active_project_changed` signal
- [ ] Update backing store when active_project changes
- [ ] Connect to `active_project.review_files.items_changed` signal
- [ ] Implement `on_items_changed(uint position, uint removed, uint added)` method (resize pane)
- [ ] Emit file_selected signal when file clicked
- [ ] Handle item activation (click)

## Testing

### FileBase Properties
- Test `display_approval_text` returns "+ filename" for new files
- Test `display_approval_text` returns strikethrough for deleted files
- Test `display_approval_text` returns normal filename for modified files
- Test `display_approval_tooltip` returns "Added /path/to/file" for new files
- Test `display_approval_tooltip` returns "Modified /path/to/file" for modified files
- Test `display_approval_tooltip` returns "Deleted /path/to/file" for deleted files
- Test properties update when FileHistory records change

### Approvals Widget
- Test Approvals widget displays files correctly
- Test Approvals widget shows "+" prefix for new files (from property)
- Test Approvals widget shows strikethrough for deleted files (from property)
- Test Approvals widget tooltips show correct state (from property)
- Test clicking file in Approvals opens it in codeview
- Test select_file() blocks selection handler
- Test select_next() blocks selection handler
- Test clear_selection() blocks selection handler
- Test selection handler processes user clicks correctly
- Test widget updates when ReviewFiles changes
- Test widget handles empty ReviewFiles
- Test widget monitors active_project_changed signal
- Test widget updates backing store when active_project changes
- Test widget disconnects from previous project's signals
- Test widget connects to new project's review_files signals
- Test pane resizes when items_changed signal is emitted
- Test pane hides when count goes to 0
- Test pane shows when count goes from 0 to >0
- Test pane respects min/max size constraints
