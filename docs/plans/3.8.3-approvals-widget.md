# 3.8.3. Approvals Widget

## Overview

Create Approvals widget (Gtk.Button that extends button functionality) with an internal popover containing Gtk.ListView that displays files needing approval. The button shows task-due icon and the popover appears on mouseover. Allows selecting files and opening them in codeview.

## Status

‚è≥ **TODO** - To be implemented.

## Prerequisites

- Phase 3.8.2 must be completed (ReviewFiles class)

## Goals

1. Create Approvals button (extends Gtk.Button)
2. Implement internal popover with Gtk.ListView
3. Display list of files needing approval in popover
4. Show file basename with visual indicators (+, strikethrough)
5. Show tooltips with full path and change type
6. Allow clicking files to open in codeview
7. Support programmatic selection with blocked handler
8. Popover height based on list size
9. Button shows task-due icon
10. Popover appears on mouseover of button

## Implementation Details

### File to Create

- `liboccoder/Approvals.vala`

### Class Structure

```vala
namespace OLLMcoder
{
    /**
     * Button widget for displaying and managing files that need approval.
     * 
     * Extends Gtk.Button and contains an internal popover with a list of files that need approval,
     * ordered by last_modified (most recent first). The button shows a task-due icon and the popover
     * appears on mouseover. Allows selecting files to open in codeview. Supports visual indicators
     * for new/deleted files. Tied to ProjectManager and monitors active_project for changes.
     */
    public class Approvals : Gtk.Button
    {
        private ProjectManager project_manager;
        private Gtk.Popover popover;  // Internal popover
        private Gtk.ListView list_view;
        private Gtk.SingleSelection selection;
        private Gtk.SortListModel sorted_model;
        private bool changing_selection = false;  // Block selection handler
        private uint hide_timeout_id = 0;  // Timeout ID for delayed hide
        private uint cooldown_timeout_id = 0;  // Timeout ID for click cooldown
        private bool in_cooldown = false;  // Whether we're in click cooldown period
        
        /**
         * Currently selected file (or null).
         */
        public File? selected_file { get; private set; default = null; }
        
        /**
         * Emitted when a file is selected/clicked.
         */
        public signal void file_selected(File file);
        
        /**
         * Emitted when approve is requested for a file.
         */
        public signal void approve_requested(File file);
        
        /**
         * Emitted when next file is requested.
         */
        public signal void next_requested();
        
        /**
         * Constructor.
         * 
         * @param project_manager The ProjectManager instance (required)
         */
        public Approvals(ProjectManager project_manager)
        {
            this.project_manager = project_manager;
            // Set button icon to task-due
            this.icon_name = "task-due";
            // ... initialization ...
        }
        
        // ... methods ...
    }
}
```

### Methods

1. **Setup**:
   - Constructor takes `ProjectManager` as parameter
   - Extend Gtk.Button, set icon to "task-due"
   - Create internal Gtk.Popover and set parent to `this` (the button) using `set_parent()`
   - Create Gtk.ListView inside popover
   - Monitor `project_manager.active_project_changed` signal to update backing store
   - When active_project changes: update ReviewFiles backing store from `active_project.review_files`
   - Connect mouseover events to `this` (the button) to show popover
   - Update selected row when popover is shown

2. **Selection**:
   - `select_file(File file)` - Programmatically select a file (blocks handler)
   - `select_next()` - Select next file in list (blocks handler)
   - `selected_file` - Property to get currently selected file (or null)
   - `clear_selection()` - Clear selection (blocks handler)

3. **Internal**:
   - `on_selection_changed()` - Handle selection changes (only when not blocked)
   - `on_item_activated(uint position)` - Handle item click/activation
   - `create_factory()` - Create factory for list items
   - `on_popover_shown()` - Update selected row when popover appears
   - `update_popover_size()` - Adjust popover height based on list size
   - `on_button_motion_enter()` - Handle mouse entering button
   - `on_button_motion_leave()` - Handle mouse leaving button
   - `on_popover_motion_enter()` - Handle mouse entering popover
   - `on_popover_motion_leave()` - Handle mouse leaving popover
   - `on_button_clicked()` - Handle button click (hide popover, start cooldown)
   - `cancel_hide_timeout()` - Cancel pending hide timeout
   - `schedule_hide()` - Schedule popover to hide in 3 seconds
   - `on_hide_timeout()` - Callback for hide timeout
   - `start_cooldown()` - Start 3 second cooldown after button click
   - `on_cooldown_timeout()` - Callback for cooldown timeout

### FileBase Properties

**File**: `libocfiles/FileBase.vala`

Add two new properties for approval display:

1. **`display_approval_text`** (string property):
   - Returns formatted text for display in approvals list
   - Format: "+ filename" for new files, `<s>filename</s>` for deleted files, "filename" for modified files
   - Uses Pango markup for strikethrough on deleted files
   - Determines file state from FileHistory records (check for "added", "deleted", "modified" change_type)

2. **`display_approval_tooltip`** (string property):
   - Returns tooltip text with full path and change type
   - Format: "Added /path/to/file" or "Modified /path/to/file" or "Deleted /path/to/file"
   - Determines file state from FileHistory records

**Implementation Notes**:
- Query FileHistory table to determine file state (most recent change_type for the file)
- For new files: change_type == "added" and no previous history
- For deleted files: change_type == "deleted" or file doesn't exist but record does
- For modified files: change_type == "modified" and file exists

### Factory Implementation

Create factory that binds to File properties:
- Bind label text to `file.display_approval_text`
- Bind tooltip to `file.display_approval_tooltip`
- Use Gtk.PropertyExpression for automatic updates when properties change

### Visual Indicators

- **New files**: Show "+ filename" (from `display_approval_text` property)
- **Deleted files**: Show strikethrough using Pango markup: `<s>filename</s>` (from `display_approval_text` property)
- **Modified files**: Show normal filename (from `display_approval_text` property)
- **Tooltip**: From `display_approval_tooltip` property ("Added /path/to/file" or "Modified /path/to/file" or "Deleted /path/to/file")

### Selection Management

- Block selection change handler when programmatically changing selection:
  ```vala
  private void select_file(File file) {
      this.changing_selection = true;
      // Find position of file in model
      // Set selection
      this.changing_selection = false;
  }
  ```

- Only process selection changes when not blocked:
  ```vala
  private void on_selection_changed() {
      if (this.changing_selection) {
          return;
      }
      // Update selected_file property
      // Process selection change
  }
  ```

### Active Project Monitoring

- Connect to `project_manager.active_project_changed` signal
- When active_project changes:
  - Disconnect from previous project's `review_files.items_changed` signal (if any)
  - Connect to new active_project's `review_files.items_changed` signal
  - Update backing store model to use `active_project.review_files`
  - If active_project is null, clear the list
- Since we update selected row when showing popover, less monitoring needed

### Popover Display

- Use `Gtk.EventControllerMotion` for mouse tracking:
  - Add motion controller to button (`this`)
  - Add motion controller to popover
  - Set popover parent to `this` using `popover.set_parent(this)`

- Show/hide behavior with delayed hiding:
  - **Mouse enters button**: Show popover immediately
  - **Mouse leaves button**: Start 3 second timer to hide popover
  - **Mouse enters popover** (within 3 seconds): Cancel hide timer, keep popover visible
  - **Mouse leaves popover**: Start 3 second timer to hide popover
  - **Mouse enters button** (while popover visible): Cancel any hide timer, keep popover visible
  - **Button clicked**: Hide popover immediately, set 3 second cooldown (ignore mouseover during cooldown)
  - **Click outside button/popover** (within 3 seconds of leaving): Hide popover immediately

- Implementation details:
  - Use `TimeoutSource` or `GLib.Timeout.add_seconds()` for 3 second delays
  - Store timeout ID to cancel when needed
  - Track cooldown state (boolean flag + timeout) for button click behavior
  - Connect to button's `clicked` signal for click handling
  - Use `Gtk.EventControllerKey` or similar to detect clicks outside (or use popover's `closed` signal)
  - Update selected row when popover is shown (in `on_popover_shown()` handler)
  - This reduces need for continuous monitoring

### Popover Sizing

- Popover height based on list size:
  - `update_popover_size()` - Calculate height based on number of items
  - Set minimum height (e.g., 100px) and maximum height (e.g., 400px)
  - Use `set_size_request()` or similar to set popover content size
  - Adjust when list changes (connect to ReviewFiles.items_changed)

### Button Configuration

- The Approvals button (extends Gtk.Button):
  - Shows task-due icon (set `icon_name = "task-due"` in constructor)
  - Is the container element for the popover (popover parent is `this`)
  - Uses `Gtk.EventControllerMotion` for mouse tracking
  - Shows popover on mouseover with delayed hide behavior (see Popover Display section)

## Implementation Tasks

### FileBase Properties
- [ ] Add `display_approval_text` property to FileBase class
- [ ] Add `display_approval_tooltip` property to FileBase class
- [ ] Implement logic to determine file state from FileHistory records
- [ ] Format text with "+" prefix for new files
- [ ] Format text with strikethrough for deleted files
- [ ] Format tooltip with change type and full path

### Approvals Widget
- [ ] Create `liboccoder/Approvals.vala` class
- [ ] Extend Gtk.Button
- [ ] Constructor takes `ProjectManager` parameter
- [ ] Set button icon_name to "task-due" in constructor
- [ ] Store `project_manager` as private field
- [ ] Create internal Gtk.Popover
- [ ] Set popover parent to `this` (the button) using `popover.set_parent(this)`
- [ ] Create Gtk.ListView inside popover with Gtk.SingleSelection
- [ ] Create Gtk.SortListModel to sort by last_modified (descending)
- [ ] Create factory for list items (bind to `display_approval_text` and `display_approval_tooltip`)
- [ ] Add `selected_file` property
- [ ] Implement selection management with blocking
- [ ] Implement `select_file()` method
- [ ] Implement `select_next()` method
- [ ] Implement `clear_selection()` method
- [ ] Connect to `project_manager.active_project_changed` signal
- [ ] Update backing store when active_project changes
- [ ] Connect to `active_project.review_files.items_changed` signal
- [ ] Implement `update_popover_size()` method (adjust height based on list size)
- [ ] Implement `on_popover_shown()` method (update selected row when popover appears)
- [ ] Add `Gtk.EventControllerMotion` to button (`this`)
- [ ] Add `Gtk.EventControllerMotion` to popover
- [ ] Implement `on_button_motion_enter()` method (show popover, cancel hide timeout)
- [ ] Implement `on_button_motion_leave()` method (schedule hide in 3 seconds)
- [ ] Implement `on_popover_motion_enter()` method (cancel hide timeout)
- [ ] Implement `on_popover_motion_leave()` method (schedule hide in 3 seconds)
- [ ] Implement `cancel_hide_timeout()` method
- [ ] Implement `schedule_hide()` method (3 second delay)
- [ ] Implement `on_hide_timeout()` callback
- [ ] Connect button's `clicked` signal to `on_button_clicked()`
- [ ] Implement `on_button_clicked()` method (hide popover, start cooldown)
- [ ] Implement `start_cooldown()` method (3 second cooldown, ignore mouseover)
- [ ] Implement `on_cooldown_timeout()` callback
- [ ] Handle clicks outside button/popover (instant hide if within 3 seconds of leaving)
- [ ] Emit file_selected signal when file clicked
- [ ] Handle item activation (click)

## Testing

### FileBase Properties
- Test `display_approval_text` returns "+ filename" for new files
- Test `display_approval_text` returns strikethrough for deleted files
- Test `display_approval_text` returns normal filename for modified files
- Test `display_approval_tooltip` returns "Added /path/to/file" for new files
- Test `display_approval_tooltip` returns "Modified /path/to/file" for modified files
- Test `display_approval_tooltip` returns "Deleted /path/to/file" for deleted files
- Test properties update when FileHistory records change

### Approvals Widget
- Test Approvals button displays correctly
- Test Approvals button shows task-due icon
- Test Approvals popover displays files correctly
- Test Approvals popover shows "+" prefix for new files (from property)
- Test Approvals popover shows strikethrough for deleted files (from property)
- Test Approvals popover tooltips show correct state (from property)
- Test clicking file in Approvals opens it in codeview
- Test select_file() blocks selection handler
- Test select_next() blocks selection handler
- Test clear_selection() blocks selection handler
- Test selection handler processes user clicks correctly
- Test popover updates when ReviewFiles changes
- Test popover handles empty ReviewFiles
- Test button monitors active_project_changed signal
- Test button updates backing store when active_project changes
- Test button disconnects from previous project's signals
- Test button connects to new project's review_files signals
- Test popover appears immediately when mouse enters button
- Test popover hides 3 seconds after mouse leaves button (if not entering popover)
- Test popover stays visible when mouse enters popover from button
- Test popover hides 3 seconds after mouse leaves popover (if not entering button)
- Test popover stays visible when mouse enters button from popover
- Test popover hides immediately when button is clicked
- Test popover ignores mouseover for 3 seconds after button click
- Test popover appears again after cooldown period ends
- Test popover hides immediately when clicking outside button/popover (within 3 seconds of leaving)
- Test hide timeout is cancelled when mouse enters popover
- Test hide timeout is cancelled when mouse enters button
- Test popover height adjusts based on list size
- Test popover updates selected row when shown
