# 2.6.1. Code Execution Improvements

## Overview

Enhance code execution security and monitoring by implementing bwrap (bubblewrap) sandboxing, filesystem monitoring, and improved permission handling for command execution.

## Status

‚è≥ **PLANNING** - Design phase.

## Goals

1. Implement bwrap sandboxing for all code execution
2. Restrict file writes to project files only
3. Monitor filesystem changes during command execution
4. Build allowlist of safe commands/methods that don't need approval
5. Integrate allowlist with bwrap settings
6. Investigate bwrap dry-run/rejection reporting capabilities

## Implementation Details

### 1. bwrap Integration

#### 1.1. Core bwrap Implementation
- Replace direct `GLib.Subprocess` execution with bwrap-wrapped execution
- Create bwrap wrapper class/utility for command execution
- Configure bwrap with appropriate sandbox settings:
  - Read-only bind mounts for system directories
  - Read-write bind mount for project directory only
  - Network access (if needed, or restrict based on command)
  - No access to user home directory (except project files)
  - No access to system directories outside of read-only binaries/libs

#### 1.2. bwrap Configuration
- Determine project root directory for read-write access
- Set up read-only bind mounts for:
  - `/usr` (binaries, libraries)
  - `/lib` (system libraries)
  - `/lib64` (if applicable)
  - `/bin` (essential binaries)
  - `/sbin` (system binaries)
  - `/etc` (configuration files, read-only)
- Set up read-write bind mount for:
  - Project root directory (or subdirectory if specified)
- Consider:
  - `/tmp` access (may need temporary directory)
  - `/dev` access (may need limited device access)
  - `/proc` and `/sys` (may need limited access for some commands)

#### 1.3. bwrap Command Construction
- Build bwrap command with appropriate flags
- Handle working directory within sandbox
- Preserve environment variables needed for commands
- Handle stdin/stdout/stderr redirection

#### 1.4. Nested bwrap Support
- **Important**: If the application is already running in a bwrap container, bwrap can be nested
- Use different bwrap command/method for nesting (slightly different flags or approach)
- Detect if application is running in bwrap container (check for bwrap-specific environment variables or filesystem indicators)
- When nested, use appropriate bwrap nesting flags/methods
- Ensure nested bwrap still provides proper sandboxing
- Test both scenarios: application in bwrap and application not in bwrap

### 2. Filesystem Write Restrictions

#### 2.1. Project File Detection
- Identify project root directory
- Determine what constitutes "project files"
- Handle subdirectories and nested projects
- Consider symlinks and special files

#### 2.2. bwrap Write Restrictions
- Configure bwrap to only allow writes to project directory
- Use `--bind` with read-write only for project directory
- Use `--ro-bind` for all other directories
- Test that writes outside project directory are blocked

#### 2.3. Error Handling
- Detect when bwrap blocks a write operation
- Report clear error messages when writes are rejected
- Distinguish between command errors and sandbox violations

### 3. Filesystem Monitoring

#### 3.1. Pre-execution Snapshot
- Before command execution:
  - Scan project directory for existing files
  - Record file metadata (size, mtime, etc.)
  - Build baseline state

#### 3.2. Post-execution Comparison
- After command execution:
  - Rescan project directory
  - Compare with baseline
  - Identify:
    - New files created
    - Files modified
    - Files deleted
    - Files moved/renamed

#### 3.3. Change Reporting
- Generate report of filesystem changes
- Present changes to user (if needed)
- Log changes for audit purposes
- Include in tool response to LLM

#### 3.4. Implementation Options
- Use `inotify` for real-time monitoring (complex, may miss some changes)
- Use pre/post directory scanning (simpler, more reliable)
- Consider using `find` or similar tools to build file lists
- Handle large directories efficiently

### 4. Safe Command Allowlist

#### 4.1. Allowlist Design
- Build list of commands/methods that are considered safe
- Criteria for "safe":
  - Read-only operations (e.g., `ls`, `cat`, `grep`, `find`)
  - Common development tools (e.g., `git status`, `git log`, `meson compile`)
  - Build tools that only write to project directory
  - Version control commands (read-only or project-scoped)

#### 4.2. Allowlist Storage
- Store allowlist in configuration file or code
- Make it configurable/extensible
- Consider per-project allowlists

#### 4.3. Allowlist Matching
- Match commands against allowlist before execution
- Handle command arguments (e.g., `git status` vs `git push`)
- Consider command patterns (e.g., `meson compile *`)
- Handle complex commands (may need parsing)

#### 4.4. Permission Integration
- Commands in allowlist skip permission request
- Still execute within bwrap sandbox
- Still monitor filesystem changes
- Log allowlist usage

### 5. bwrap Settings Integration

#### 5.1. Allowlist-Based bwrap Configuration
- Different bwrap settings for allowlisted vs non-allowlisted commands
- Allowlisted commands:
  - May have more permissive settings (if safe)
  - Still restricted to project directory writes
  - May have additional read-only mounts
- Non-allowlisted commands:
  - Stricter sandbox settings
  - May require additional restrictions

#### 5.2. Dynamic bwrap Configuration
- Configure bwrap based on command type
- Example: build commands may need access to build directories
- Example: test commands may need temporary directories
- Example: git commands may need `.git` directory access

### 6. bwrap Rejection Detection

#### 6.1. Investigation
- Research bwrap capabilities:
  - Does bwrap provide dry-run mode?
  - Can bwrap report what operations would be rejected?
  - Are there bwrap flags for verbose/reporting mode?
  - Can we detect sandbox violations from exit codes/stderr?

#### 6.2. Rejection Detection Strategy
- Monitor bwrap stderr for rejection messages
- Parse bwrap output for violation reports
- Use exit codes to detect sandbox failures
- Distinguish between:
  - Command execution failures
  - Sandbox violations
  - Permission denied errors

#### 6.3. Pre-execution Validation
- If dry-run available: validate command before execution
- If not available: execute and detect rejections
- Report rejections clearly to user
- Suggest alternatives if command is rejected

#### 6.4. Error Reporting
- Clear error messages when bwrap rejects operations
- Include information about what was rejected
- Suggest how to fix (e.g., "Command tried to write to /tmp, use project directory instead")

## Files to Modify/Create

### New Files
- `liboctools/BwrapExecutor.vala` - bwrap wrapper class
- `liboctools/FilesystemMonitor.vala` - Filesystem change detection
- `liboctools/CommandAllowlist.vala` - Safe command allowlist management
- `resources/command-allowlist.json` (or similar) - Allowlist configuration

### Modified Files
- `libollmchat/Tools/RequestRunCommand.vala` - Integrate bwrap and monitoring
- `libollmchat/Tools/RunCommand.vala` - Update tool description if needed

## Implementation Phases

### Phase 1: Basic bwrap Integration
- [ ] Create `BwrapExecutor` class
- [ ] Implement basic bwrap command execution
- [ ] Configure read-only system mounts
- [ ] Configure read-write project mount
- [ ] Detect if application is running in bwrap container
- [ ] Implement nested bwrap support (different command/method when already in bwrap)
- [ ] Replace `GLib.Subprocess` with bwrap execution
- [ ] Test basic command execution (both nested and non-nested scenarios)

### Phase 2: Write Restrictions
- [ ] Verify writes are restricted to project directory
- [ ] Test write attempts outside project directory
- [ ] Implement error handling for blocked writes
- [ ] Add clear error messages

### Phase 3: Filesystem Monitoring
- [ ] Create `FilesystemMonitor` class
- [ ] Implement pre-execution snapshot
- [ ] Implement post-execution comparison
- [ ] Generate change reports
- [ ] Integrate with command execution
- [ ] Include changes in tool response

### Phase 4: Command Allowlist
- [ ] Create `CommandAllowlist` class
- [ ] Define initial allowlist of safe commands
- [ ] Implement allowlist matching
- [ ] Integrate with permission system
- [ ] Skip permission requests for allowlisted commands
- [ ] Test allowlist functionality

### Phase 5: Advanced bwrap Configuration
- [ ] Implement allowlist-based bwrap settings
- [ ] Add dynamic bwrap configuration
- [ ] Test different configurations for different command types

### Phase 6: Rejection Detection
- [ ] Research bwrap dry-run capabilities
- [ ] Implement rejection detection
- [ ] Parse bwrap error messages
- [ ] Report rejections clearly
- [ ] Test rejection scenarios

## Testing Considerations

- Test commands that should work (read-only, project writes)
- Test commands that should be blocked (system writes)
- Test allowlisted commands (should skip approval)
- Test non-allowlisted commands (should require approval)
- Test filesystem monitoring accuracy
- Test bwrap rejection detection
- Test error handling and reporting
- Test with various command types (build, test, git, etc.)
- Test with complex commands (pipes, redirects, etc.)

## Dependencies

- `bwrap` (bubblewrap) - Must be installed on system
- May need additional Vala bindings or subprocess handling for bwrap

## Research Needed

- bwrap documentation and capabilities
- bwrap dry-run or validation modes
- bwrap error message formats
- Best practices for bwrap sandboxing
- **bwrap nesting**: How to detect if running in bwrap container and how to nest bwrap (different command/method)
- Filesystem monitoring approaches in Vala
- inotify vs directory scanning trade-offs

## Notes

- bwrap may not be available on all systems - need fallback or requirement check
- Filesystem monitoring may have performance impact on large directories
- Allowlist needs to be maintained and updated
- Some commands may need special bwrap configuration (e.g., network access, device access)
- Consider user configuration for bwrap settings and allowlist

