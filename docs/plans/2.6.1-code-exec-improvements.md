# 2.6.1. Code Execution Improvements

## Overview

Enhance code execution security and monitoring by implementing bwrap (bubblewrap) sandboxing, filesystem monitoring, and improved permission handling for command execution.

## Status

â³ **PLANNING** - Design phase.

## Goals

1. Implement bwrap sandboxing for all code execution
2. Restrict file writes to project files only
3. Monitor filesystem changes during command execution

## Implementation Details

### 1. bwrap Integration

#### 1.1. Core bwrap Implementation
- Replace direct `GLib.Subprocess` execution with bwrap-wrapped execution
- Create bwrap wrapper class/utility for command execution
- Configure bwrap with appropriate sandbox settings:
  - Read-only bind mounts for system directories
  - Read-write bind mount for project directory only
  - Network access (if needed, or restrict based on command)
  - No access to user home directory (except project files)
  - No access to system directories outside of read-only binaries/libs

#### 1.2. bwrap Configuration
- **Read-only access to all files**: Use `--ro-bind / /` to bind entire root filesystem as read-only
- **Write access to project directory only**: Use overlay filesystem for project directory
  - Project root directory mounted with overlay support
  - All writes go to overlay upper directory (isolated from original files)
- **Network access**: Blocked by default
  - Use `--unshare-net` to block network access by default
  - Only allow network access if explicitly requested and permission granted
  - If network access is requested and permission granted, omit `--unshare-net` flag
- Consider:
  - `/tmp` access (may need temporary directory)
  - `/dev` access (may need limited device access)
  - `/proc` and `/sys` (may need limited access for some commands)

#### 1.3. bwrap Command Construction
- Build bwrap command with appropriate flags
- Handle working directory within sandbox
- Preserve environment variables needed for commands
- Handle stdin/stdout/stderr redirection
- **Network access control**:
  - Default: Include `--unshare-net` flag to block network access
  - If network access requested and permission granted: Omit `--unshare-net` flag
  - Check permission before building bwrap command

#### 1.4. Overlay Filesystem Support
- **Create overlay for project directory**: Use overlayfs to isolate writes
  - Create overlay temporary directory in `.cache/ollmchat/{overlay-datetime}/`
  - Overlay structure (required by overlayfs, not bwrap):
    - Lower directory: Original project directory (read-only)
    - Upper directory: `.cache/ollmchat/{overlay-datetime}/upper/` (writable layer)
      - **Multiple folder structure**: Upper directory contains subdirectories for each project root:
        - `upper/overlay1/` - Writes for first project root
        - `upper/overlay2/` - Writes for second project root
        - `upper/overlay3/` - Writes for third project root
        - etc.
      - Each subdirectory name (overlay1, overlay2, etc.) maps to a project root path
      - Overlay map: HashMap mapping subdirectory names to real project paths (e.g., `"overlay1" -> "/home/alan/project"`)
    - Work directory: `.cache/ollmchat/{overlay-datetime}/work/` (required by overlayfs for internal atomic operations - file renames, deletions, etc.)
  - Mount overlay filesystem (using `mount -t overlay`) before bwrap execution
  - Bind-mount the overlay mount point into bwrap sandbox at project directory location
  - All writes go to upper directory subdirectories, original files remain unchanged
  - **Note**: The work directory is not directly accessible to users - it's used internally by overlayfs
- **Backup system** (replicates edit file tool behavior):
  - **Use the same backup system as edit file tool**: `~/.cache/ollmchat/edited/`
  - **Same storage format**: `{id}-{date YY-MM-DD}-{basename}`
  - **Same logic**: Replicate `FileBuffer.create_backup_if_needed()` behavior
  - **Backup rules** (same as edit tool):
    - Only for files in database (id > 0)
    - One backup per file per day (skips if backup exists for today)
    - Backup path stored in `file.last_approved_copy_path`
  - **For code execution**: Create backups AFTER execution for files that were actually modified
    - Monitor changes with inotify during execution
    - After execution: For each modified file, copy original file (from overlay lower directory) to backup location
    - Use same backup creation logic as edit tool
    - For new files: No backup needed (file didn't exist before)
- **Overlay lifecycle**:
  - Create overlay directory before command execution
  - Clean up overlay directory after command execution (or keep for inspection)
  - Use unique timestamp-based directory names to avoid conflicts
  - Handle cleanup on application exit or error
  - **Note**: Backups are stored in `~/.cache/ollmchat/edited/` (same as edit file tool), cleaned up by `ProjectManager.cleanup_old_backups()` (files older than 7 days)

#### 1.5. Nested bwrap Support
- **Important**: If the application is already running in a bwrap container, bwrap can be nested
- Use different bwrap command/method for nesting (slightly different flags or approach)
- Detect if application is running in bwrap container (check for bwrap-specific environment variables or filesystem indicators)
- When nested, use appropriate bwrap nesting flags/methods
- Ensure nested bwrap still provides proper sandboxing
- Test both scenarios: application in bwrap and application not in bwrap

### 2. Filesystem Write Restrictions

#### 2.1. Project File Detection
- Identify project root directory
- Determine what constitutes "project files"
- Handle subdirectories and nested projects
- Consider symlinks and special files

#### 2.2. bwrap Write Restrictions
- Configure bwrap to only allow writes to project directory via overlay
- Use overlay filesystem mount for project directory (writable)
- Use `--ro-bind / /` for entire root filesystem (read-only access)
- Test that writes outside project directory are blocked
- Verify that writes to project directory go to overlay upper directory

#### 2.3. Error Handling
- **No special handling needed**: bwrap errors will appear in command output (stdout/stderr)
- LLM will read and interpret command output including any bwrap sandbox violations
- Command output is returned to LLM as-is for interpretation

### 3. Filesystem Monitoring

#### 3.1. inotify Monitoring on Overlay
- **Set up inotify monitor on overlay directory**: Monitor the overlay upper directory for changes
  - Monitor `.cache/ollmchat/{overlay-datetime}/upper/` directory
  - Use `GLib.FileMonitor` or direct inotify API to watch for:
    - File creation (`G_FILE_MONITOR_EVENT_CREATED`)
    - File modification (`G_FILE_MONITOR_EVENT_CHANGED`)
    - File deletion (`G_FILE_MONITOR_EVENT_DELETED`)
    - File moves/renames (`G_FILE_MONITOR_EVENT_MOVED`)
    - Directory creation (`G_FILE_MONITOR_EVENT_CREATED` for directories)
  - Start monitoring before command execution
  - Stop monitoring after command execution completes
- **Dynamic recursive directory monitoring**:
  - Overlay upper directory starts empty (no subdirectories initially)
  - When a directory creation event is detected (`G_FILE_MONITOR_EVENT_CREATED` for directory):
    - Create a new monitor for the newly created directory
    - Track the new monitor in a list/map of active monitors
    - The new monitor will detect changes in that subdirectory
  - Recursively handle nested directory creation (create monitors for subdirectories of subdirectories)
  - Keep track of all active monitors to stop them after execution
- **Simple change tracking**:
  - Maintain lists of files/folders that were written/added during execution
  - Track files that were created/modified (add to list when detected)
  - Track directories that were created (add to list when detected)
  - No need to record all individual events - just maintain simple lists

#### 3.2. Pre-execution Baseline
- Before command execution:
  - Initialize inotify monitor on overlay upper directory (starts empty)
  - **Note**: We do NOT create backups before execution - backups are created after execution for files that were actually modified

#### 3.3. Post-execution Change Detection
- After command execution:
  - Stop inotify monitoring
  - Scan overlay upper directory to get final state (list of all files/folders in upper directory)
  - Compare final state with original state to determine changes:
    - **Modified files**: Files that exist in both original and overlay upper directory
    - **New files**: Files that exist only in overlay upper directory
    - **Deleted files**: Files that exist in original but not in overlay upper directory (and not in our "written" list)
  - Use the lists of files/folders that were written/added during execution to help determine state differences
- **Map overlay paths to project paths**:
  - Convert paths from overlay upper directory to original project paths
  - Handle path mapping correctly for nested directories
- **Create backups for changed files**:
  - For modified files: Copy original file (from overlay lower directory) to backup location
  - For deleted files: Copy original file (from overlay lower directory) to backup location
  - Use same backup system as edit file tool (`~/.cache/ollmchat/edited/{id}-{date YY-MM-DD}-{basename}`)
- **Copy files from overlay to live system**:
  - After backups are created, copy files from overlay upper directory to original project directory
  - For modified files: Copy from overlay upper directory to project directory (overwrites original)
  - For new files: Copy from overlay upper directory to project directory
  - For deleted files: Remove from project directory (file already deleted in overlay)
  - Handle directory creation if needed (for new files in new directories)
- **Update ProjectManager file data**:
  - **For modified files**:
    - Get File object from ProjectManager (must be in database, id > 0)
    - **Create backup from original file**: Copy original file (from overlay lower directory) to backup location
    - **Use same backup system as edit file tool**: `~/.cache/ollmchat/edited/{id}-{date YY-MM-DD}-{basename}`
    - **Backup creation**: Replicate `FileBuffer.create_backup_if_needed()` logic:
      - Only create if file is in database (id > 0)
      - Only one backup per file per day (skip if exists)
      - Copy original file content to backup location
      - Set `file.last_approved_copy_path` to backup path
    - **Copy from overlay to live system**: Copy modified file from overlay upper directory to project directory (overwrites original)
    - Update file metadata (last_modified, etc.)
    - Save File entry to database via `file.saveToDB()`
  - **For new files**:
    - Create new File entry in ProjectManager file_cache
    - Save File entry to database first (to get id > 0)
    - **For new files**: No backup needed (file didn't exist before), set `last_approved_copy_path` to empty string
    - **Copy from overlay to live system**: Copy new file from overlay upper directory to project directory
    - Handle directory creation if needed (for new files in new directories)
    - Save File entry to database via `file.saveToDB()`
  - **Note**: Uses the same backup system and storage format as `FileBuffer.write()` in the edit file tool
  - **For deleted files**:
    - Get File object from ProjectManager (must be in database, id > 0)
    - **Create backup of deleted file**: Copy original file (from overlay lower directory) to backup location
    - **Use same backup system as edit file tool**: `~/.cache/ollmchat/edited/{id}-{date YY-MM-DD}-{basename}`
    - **Backup creation**: Replicate `FileBuffer.create_backup_if_needed()` logic:
      - Only create if file is in database (id > 0)
      - Only one backup per file per day (skip if exists)
      - Copy original file content to backup location
      - Set `file.last_approved_copy_path` to backup path
    - **Set is_deleted flag**: Set `file.is_deleted = true` to mark file as deleted
    - **Copy from overlay to live system**: Remove file from project directory (file already deleted in overlay)
    - **Fill in file details**: Update file metadata, save to database
    - **Keep File record**: Do NOT remove from database or file_cache - keep until backup is deleted
    - Save File entry to database via `file.saveToDB()`

#### 3.4. Change Reporting and ProjectManager Integration
- **Tools have access to ProjectManager**: Pass ProjectManager instance to tool execution system
- **Update file data in ProjectManager**:
  - For each modified file: Update File entry, set `last_approved_copy_path` to backup location
  - For each new file: Create File entry, create empty file in temp store, set `last_approved_copy_path` to empty file location
  - Save all changes to database via ProjectManager
- **Temporary file store** (separate from bwrap overlay):
  - Location: `.cache/ollmchat/temp-files/{execution-id}/`
  - Stores pre-change versions of modified files (backups)
  - Stores empty files for new files (to represent "before" state)
  - Cleanup after processing (or keep for inspection)
- Generate report of filesystem changes
- Present changes to user (if needed)
- Log changes for audit purposes
- Include in tool response to LLM

#### 3.5. Implementation Details
- Use `GLib.FileMonitor` for inotify integration (Vala-friendly API)
- Handle inotify event queue properly (events may arrive after command completes)
- Monitor overlay upper directory recursively
- Handle edge cases: rapid file changes, large numbers of files, deep directory structures

### 4. bwrap Settings Configuration

#### 4.1. Dynamic bwrap Configuration
- Configure bwrap based on command type
- Example: build commands may need access to build directories
- Example: test commands may need temporary directories
- Example: git commands may need `.git` directory access

## Files to Modify/Create

### New Files
- `liboctools/RunCommand/Bwrap.vala` - bwrap wrapper class with overlay support
- `liboctools/RunCommand/Overlay.vala` - Overlay filesystem creation and management
- `liboctools/RunCommand/Monitor.vala` - inotify-based filesystem change detection on overlay

### Modified Files
- `liboctools/RunCommand/Request.vala` - Integrate bwrap, overlay, monitoring, ProjectManager, and network access permission
- `liboctools/RunCommand/Tool.vala` - Update tool description if needed
- Pass ProjectManager instance to tool execution system for file data updates
- Add `allow_network` boolean parameter to RunCommand tool (default: false)
- Integrate network access with permission system (request permission if `allow_network` is true)
- `libocfiles/FileBase.vala` - Add `is_deleted` boolean property and database column
- `libocfiles/Folder.vala` - Modify `read_dir_remove()` to check if backup exists or `is_deleted` flag before removing File record
- `libocfiles/ProjectFiles.vala` - Modify `update_from()` to check if backup exists or `is_deleted` flag before removing ProjectFile

## Implementation Phases

See separate phase files for detailed implementation plans:
- **Phase 1**: `2.6.1.1-simple-bwrap-support.md` - Simple bwrap support (no overlay)
- **Phase 2**: `2.6.1.2-file-monitor-support.md` - File monitor support
- **Phase 3**: `2.6.1.3-basic-overlay-support.md` - Basic overlay support (string copying)
- **Phase 4**: `2.6.1.4-integrate-overlay-support.md` - Integrate basic overlay support
- **Phase 5**: `2.6.1.5-full-backup-support.md` - Full backup support
- **Phase 6**: `2.6.1.6-file-scanner-updates.md` - File scanner updates and is_deleted flag
- **Phase 7**: `2.6.1.7-network-access-support.md` - Network access support

## Testing Considerations

- Test commands that should work (read-only, project writes)
- Test commands that should be blocked (system writes)
- Test network blocking (commands cannot access network by default)
- Test network access with permission (commands can access network when permission granted)
- Test filesystem monitoring accuracy
- Test error handling and reporting
- Test with various command types (build, test, git, etc.)
- Test with complex commands (pipes, redirects, etc.)
- **Test symlink handling in bwrap**:
  - Test creating symlinks to files outside of the bwrap sandbox (should be allowed by bwrap)
  - Verify how bwrap handles symlinks that point outside the sandbox
  - Test creating symlinks inside the bwrap sandbox that point to other files inside the sandbox
  - Verify that symlinks created inside bwrap work correctly and are properly tracked by the monitor

## Dependencies

- `bwrap` (bubblewrap) - Must be installed on system
- May need additional Vala bindings or subprocess handling for bwrap

## Research Needed

- bwrap documentation and capabilities
- bwrap error message formats
- Best practices for bwrap sandboxing
- **bwrap nesting**: How to detect if running in bwrap container and how to nest bwrap (different command/method)
- **Overlay filesystem**: How to create and mount overlayfs with bwrap
  - Overlayfs mount options and requirements (lower, upper, work directories)
  - Mount overlayfs outside bwrap, then bind-mount into bwrap (bwrap may not support direct overlay mounts)
  - Work directory purpose: Required by overlayfs for internal atomic operations (not directly accessible)
  - Handling overlay cleanup and persistence
- **inotify monitoring**: GLib.FileMonitor API and usage
  - Recursive directory monitoring
  - Event handling and queuing
  - Performance considerations for large directories
- **ProjectManager integration**: How to update file data for modified and new files
  - **Replicate edit file tool backup behavior**: Use same system as `FileBuffer.create_backup_if_needed()`
  - Backup location: `~/.cache/ollmchat/edited/` (same as edit file tool)
  - Backup format: `{id}-{date YY-MM-DD}-{basename}` (same as edit file tool)
  - Backup rules: Only for files in database (id > 0), one per file per day
  - **For modified files**: After execution, copy original file (from overlay lower directory) to backup location
  - **For deleted files**: After execution, copy original file (from overlay lower directory) to backup location, keep File record
  - **For new files**: Create File entry first, no backup needed (file didn't exist before)
  - Storage: Backup path stored in `file.last_approved_copy_path` (same field as edit tool)
- **File scanner modification**: Update file removal logic to check for backups and `is_deleted` flag
  - Add `is_deleted` boolean flag to `FileBase` class and database schema
  - `Folder.read_dir_remove()`: Check if `file.is_deleted == true` OR if `file.last_approved_copy_path` exists before removing File record
  - `ProjectFiles.update_from()`: Check if `project_file.file.is_deleted == true` OR if `project_file.file.last_approved_copy_path` exists before removing ProjectFile
  - Only remove File record if `is_deleted == false` AND both original file AND backup don't exist
  - Keep File record if `is_deleted == true` OR if backup exists (allows restoration until backup is deleted)

## Notes

- bwrap may not be available on all systems - need fallback or requirement check
- Overlay filesystem requires kernel support (overlayfs) - should be available on modern Linux systems
- Overlay directories in `.cache/ollmchat/` may accumulate - consider cleanup strategy
- Temporary file store directories in `.cache/ollmchat/temp-files/` may accumulate - consider cleanup strategy
- inotify monitoring may have performance impact on large directories, but monitoring overlay upper directory should be more efficient than monitoring entire project
- Some commands may need special bwrap configuration (e.g., network access, device access)
- Consider user configuration for bwrap settings
- **ProjectManager integration**: Tools have access to ProjectManager to update file data
  - **Replicate edit file tool behavior**: Use same backup system and storage format
  - **Modified files**: After execution, copy original file (from overlay lower directory) to backup location
  - Backup location: `~/.cache/ollmchat/edited/{id}-{date YY-MM-DD}-{basename}` (same format as edit tool)
  - Backup creation: Replicate `FileBuffer.create_backup_if_needed()` logic (same as edit tool)
  - Backup automatically stored in `file.last_approved_copy_path` (same field as edit tool)
  - New files: Create File entry first, no backup needed (file didn't exist before)
  - All changes saved to database via ProjectManager
  - **Same backup system**: Uses exact same backup logic as `FileBuffer.write()` in edit file tool
  - **Cleanup**: Backups cleaned up by `ProjectManager.cleanup_old_backups()` (files older than 7 days)

