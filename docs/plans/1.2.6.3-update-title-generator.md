# 1.2.6.3. Update TitleGenerator

## Overview

Update TitleGenerator to take `Connection` and `model` instead of `Client`, or take Manager reference to access config.

**Parent Plan**: [1.2.6. Update Legacy Methods](./1.2.6-update-legacy-methods.md)

**Prerequisite**: [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) must be complete

## Status

‚è≥ **TODO** - Needs implementation.

## Goal

TitleGenerator should not depend on `Client` with config. According to plan 1.2, Manager owns the config, not Client.

## Current Implementation

**File**: `libollmchat/History/TitleGenerator.vala` (line 81)

```vala
public TitleGenerator(OLLMchat.Client client)
{
    this.client = client;
}
// ...
var response = yield this.client.generate(prompt);
```

**Problem**: TitleGenerator takes `Client` but should take `Connection` and model, or get model from Manager's config.

## Proposed Fix

### Option A: Take Connection and Model (Simpler)

```vala
private Settings.Connection connection;
private string model;

public TitleGenerator(Settings.Connection connection, string model)
{
    this.connection = connection;
    this.model = model;
}

public async string to_title(SessionBase session)
{
    if (this.model == "") {
        return this.get_default_title(session);
    }
    
    // ... find first message ...
    
    try {
        var prompt = "Generate a concise title (maximum 8 words) for this chat conversation based on the first user message:\n\n" +
            "\"" + first_message + "\"\n\n" +
            "Respond with ONLY the title, no explanation or quotes.";
        
        // Create client from connection (no config - Manager owns config)
        var client = new Client(this.connection);
        var response = yield client.generate(this.model, prompt);
        
        // ... extract title ...
    } catch (Error e) {
        GLib.warning("Title generation failed: %s", e.message);
        return this.get_default_title(session);
    }
}
```

### Option B: Take Manager Reference

```vala
private History.Manager manager;

public TitleGenerator(History.Manager manager)
{
    this.manager = manager;
}

public async string to_title(SessionBase session)
{
    // Get model from manager's config
    string model = "";
    if (this.manager.config != null) {
        model = this.manager.config.get_default_model();
    }
    if (model == "") {
        return this.get_default_title(session);
    }
    
    // ... find first message ...
    
    try {
        var prompt = "Generate a concise title (maximum 8 words) for this chat conversation based on the first user message:\n\n" +
            "\"" + first_message + "\"\n\n" +
            "Respond with ONLY the title, no explanation or quotes.";
        
        // Create client from manager's base_client connection
        var client = new Client(this.manager.base_client.connection);
        var response = yield client.generate(model, prompt);
        
        // ... extract title ...
    } catch (Error e) {
        GLib.warning("Title generation failed: %s", e.message);
        return this.get_default_title(session);
    }
}
```

**Recommendation**: Option A is simpler if model can be passed explicitly. Option B is better if TitleGenerator needs access to other Manager features.

## Implementation Steps

1. Update `TitleGenerator` constructor
2. Update `to_title()` method to create Client from Connection
3. Update Manager constructor where TitleGenerator is created (line ~161)
4. Test that title generation still works

## Test

Verify title generation still works for new conversations.

## Result

TitleGenerator uses model parameter explicitly and no longer depends on Client with config.

## Files to Modify

- `libollmchat/History/TitleGenerator.vala` - Update constructor and `to_title()` method
- `libollmchat/History/Manager.vala` - Update TitleGenerator creation (line ~161)

## Related Plans

- [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) - Prerequisite

