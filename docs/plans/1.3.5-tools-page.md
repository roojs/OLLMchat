# 1.3.5. Tools Page and Management

## Overview

Implement the Tools tab in the Settings dialog and the underlying tool management system for configuring tools, setting up models for tools, managing tool-specific settings, enabling/disabling tools, and managing tool permissions. This includes the ToolsPage UI component, tool registry system, and tool configuration management.

## Status

⏳ **TODO** - Not yet implemented

## Related Plans

- **1.3** - Configuration Overview
- **1.3.1** - Configuration Classes
- **1.3.2** - Configuration Interface
- **1.4** - Client Configuration Setup (uses client connections for tool setup)

## Tools Tab

**Purpose**: Configure tools, set up models for tools, manage tool-specific settings.

**Components**:
- **Horizontal Box (Action Bar)**: Top horizontal container with search
  - **Adw.SearchBar**: Search bar for filtering tools
    - Filters tool list in real-time as user types
    - Searches by tool name and description
  - (No action buttons - tools are auto-discovered from registry)
- **Adw.PreferencesGroup**: Contains the tool list
  - Wraps `Adw.BoxedList` for consistent styling
- **Tool List**: Uses `Adw.BoxedList` to display all registered tools
  - Shows: tool name, enabled status, description
  - Each tool uses `Adw.ExpanderRow` to show/edit tool configuration
  - Each tool has one configuration entry (not multiple configs per tool)
- **Tool Configuration Panel**: Uses `Adw.ExpanderRow` - when a tool row is expanded
  - Settings widgets are added as children to the `Adw.ExpanderRow` using `add_row()`
  - **Simple Tools** (BaseToolConfig): Just shows Enabled checkbox
  - **Single Model Tools** (ToolConfig): Shows:
    - Enabled: Checkbox to enable/disable tool
    - Model Configuration: `ModelUsage` editor (connection, model, options)
      - Connection dropdown: References `Config2.connections`
      - Model dropdown: Models available from selected connection
      - Separator (visual divider)
      - Options fields listed directly: Temperature, Top P, Top K, Num Ctx, etc.
    - Tool-Specific Settings: Dynamic UI based on tool type
  - **Multiple Model Tools** (e.g., CodebaseSearchToolConfig): Shows:
    - Enabled: Checkbox to enable/disable tool
    - Embed Model Configuration: `ModelUsage` editor (connection, model, options)
      - Section header: "Embedding Model"
      - Connection, model, options fields
    - Analysis Model Configuration: `ModelUsage` editor (connection, model, options)
      - Section header: "Analysis Model"
      - Connection, model, options fields
    - Tool-Specific Settings: Dynamic UI (vector_db_path, auto_index, index_frequency, etc.)
  - Tool-Specific Settings: Dynamic UI based on tool type
    - Uses tool registration system or UI provider to discover configurable properties
    - Each tool can provide UI provider or property schema

**Data Sources**:
- Tool registry: `Client.tools` (Gee.HashMap<string, Tool>)
- Tool configurations: `Config2.tools` (Gee.Map<string, ToolConfig>)
  - Tool configs stored with tool name as key: `tools["codebase_search"]` → ToolConfig object
  - Each tool has one configuration entry (not multiple configs per tool)
  - Tool configs follow ModelUsage pattern: connection, model, options + tool-specific settings

**Tool Configuration Structure**:
- New `tools` map in Config2 (similar to `model_options`)
- ToolConfig class follows ModelUsage pattern:
  - `connection` (string) - Connection URL key
  - `model` (string) - Model name (if tool needs a model)
  - `options` (Call.Options) - Model options (if tool needs a model)
  - Tool-specific properties (varies by tool)
- Tools that require config:
  - `codebase_search` - Currently in `usage` map, needs moving to `tools` map
  - `web_search` - Search engine selection, API keys
- ModelUsage may be deprecated in favor of ToolConfig pattern

## Files to Create

**4. ToolsPage**
- **Location**: `ollmchat/Settings/ToolsPage.vala`
- **Status**: ⏳ **NOT YET IMPLEMENTED**
- **UI Framework**: Uses `Adw.PreferencesPage` with:
  - Horizontal box at top containing `Adw.SearchBar` (no action buttons - tools auto-discovered)
  - `Adw.PreferencesGroup` wrapping `Adw.BoxedList` for tool list
  - Tool rows use `Adw.ExpanderRow` for expandable configuration panels
  - Settings widgets added to `Adw.ExpanderRow` via `add_row()` method
  - See [Adw.ExpanderRow documentation](https://valadoc.org/libadwaita-1/Adw.ExpanderRow.html)
- **Purpose**: Tools tab content
- **Properties**:
  - `settings_dialog` (SettingsDialog) - Reference to parent SettingsDialog (which has the config object)
  - `selected_tool` (string?) - Currently selected tool name
  - `selected_config` (string?) - Currently selected config name (format: `tool_name.config_name`)
- **Methods**:
  - `get_tool_configs(string tool_name)` - Get all configurations for a tool (returns list of config keys)
  - `configure_tool(string tool_name, string? config_name)` - Configure tool settings (config_name null = add new)
  - `add_tool_config(string tool_name, string config_name, string display_name)` - Add new configuration for tool
  - `remove_tool_config(string tool_name, string config_name)` - Remove configuration for tool
  - `get_tool_config_ui(Tool tool, string config_name)` - Generate dynamic UI for tool-specific config
  - Note: Tools are auto-discovered from Client registry, no refresh needed

**5. BaseToolConfig (Base Tool Configuration Class)**
- **Location**: `libollmchat/Settings/BaseToolConfig.vala`
- **Purpose**: Base configuration class for simple tools that only need enabled/disabled
- **Properties**:
  - `enabled` (bool) - Whether tool is enabled (default: true)
- **Usage**: For simple tools like ReadFile, EditFile, WebFetch that don't need complex configuration
- **Note**: Implements Json.Serializable for persistence

**6. ToolConfig (Extended Tool Configuration Class)**
- **Location**: `libollmchat/Settings/ToolConfig.vala`
- **Purpose**: Extended configuration class for tools that need model configuration
- **Extends**: BaseToolConfig
- **Pattern**: Follows ModelUsage pattern (connection, model, options + tool-specific)
- **Properties**:
  - `enabled` (bool) - Inherited from BaseToolConfig
  - `connection` (string) - Connection URL key (references Config2.connections)
  - `model` (string) - Model name (if tool needs a single model, optional)
  - `options` (Call.Options) - Model options (if tool needs a single model, optional)
  - Tool-specific properties (varies by tool type)
- **Usage**: For tools that need a single model configuration like WebSearch
- **Note**: Tools can extend ToolConfig or BaseToolConfig depending on their needs

**7. CodebaseSearchToolConfig (Tool-Specific Configuration Class)**
- **Location**: `libocvector/Tool/CodebaseSearchToolConfig.vala` (or in libollmchat/Settings/)
- **Purpose**: Tool-specific configuration for codebase search with multiple model usages
- **Extends**: BaseToolConfig
- **Properties**:
  - `enabled` (bool) - Inherited from BaseToolConfig
  - `embed` (ModelUsage) - Embedding model configuration (connection, model, options)
  - `analysis` (ModelUsage) - Analysis model configuration (connection, model, options)
  - `vector_db_path` (string) - Vector database path
  - `auto_index` (bool) - Auto-index on file changes
  - `index_frequency` (int) - Indexing frequency/interval
- **Usage**: For codebase search tool which needs two model configurations (embed and analysis)
- **Migration**: Currently uses `Config2.usage["ocvector.embed"]` and `Config2.usage["ocvector.analysis"]`, needs moving to `Config2.tools["codebase_search"]` with CodebaseSearchToolConfig

## Implementation Considerations

### Tool Configuration Discovery
**Problem**: Tools need to register their configuration schema, but we need UI to discover what's configurable.

**Solution - UI Provider Pattern**:
- Tools implement `get_config_ui_provider()` method that returns a UI provider
- UI provider is simpler than markup - returns a function/widget builder
- UI provider generates tool-specific settings widgets dynamically
- Tool config classes must implement `Json.Serializable` for persistence
- ToolsPage queries Client or tool registry to discover available tools
- Tool-specific configs are stored in `Config2.tools` map (not `usage` map)
- Each tool has one config entry in `tools` map (keyed by tool name)

**UI Provider Interface**:
```vala
public interface ToolConfigUIProvider {
    public abstract Gtk.Widget create_config_widget(BaseToolConfig config);
    public abstract void update_config_from_widget(Gtk.Widget widget, BaseToolConfig config);
}
```

**Simple Tools (BaseToolConfig)**:
- For tools using BaseToolConfig (just enabled/disabled), ToolsPage can generate a simple checkbox automatically
- No UI provider needed for simple tools - standard enabled checkbox is sufficient
- ToolsPage checks if config is BaseToolConfig and generates simple UI

**Complex Tools (ToolConfig or Tool-Specific Configs)**:
- Tools using ToolConfig (single model) can provide UI provider
- Tools using tool-specific configs (like CodebaseSearchToolConfig with multiple ModelUsage sub-settings) need custom UI:
  - Embed ModelUsage editor (connection, model, options)
  - Analysis ModelUsage editor (connection, model, options)
  - Tool-specific settings (vector_db_path, auto_index, etc.)
- Alternative (Simpler): Tool provides a method that returns a list of configurable properties with types, and ToolsPage generates standard UI widgets (text entry, dropdown, checkbox, etc.) based on property types
- For nested ModelUsage properties: ToolsPage can reuse ModelUsage editor component (same as used in ModelsPage)

### Tool Configuration Storage in Config2
**New Structure**:
- Add `tools` map to Config2: `Gee.Map<string, BaseToolConfig>` (or ToolConfig for complex tools)
- Follows same pattern as `model_options` map
- Tool configs stored with tool name as key: `tools["codebase_search"]` → ToolConfig, `tools["read_file"]` → BaseToolConfig
- Each tool has one configuration entry (not multiple configs per tool)
- Simple tools use BaseToolConfig (just enabled), complex tools use ToolConfig (extends BaseToolConfig)

**Migration from ModelUsage**:
- Codebase search currently uses ModelUsage in `Config2.usage` map
- Needs to be moved to `Config2.tools` map with ToolConfig
- ToolConfig follows ModelUsage pattern (connection, model, options) but adds tool-specific properties
- ModelUsage may be deprecated in favor of ToolConfig pattern for tools

**Tool Model Configuration vs. Global Model Options**:
- Tool model configuration (ToolConfig.model, ToolConfig.options) is separate from global model options
- Tool configs use their own model/options for tool-specific operations (e.g., embeddings, analysis)
- Global model options (Config2.model_options) are per-model option overrides for chat operations
- Clear separation: tool configs in `tools` map, model options in `model_options` map
- When a tool needs model options, it uses its own ToolConfig.options, not Config2.model_options

## Tool Management System

### Current Situation
- Tools are registered with Client
- Chat may have specific tool configurations
- Need to ensure tools work correctly with Chat configuration

### Tool Registry System
- **Tool Registry**: List of available tools (stored in `Client.tools`)
- **Dynamic Tool Loading**: Support for loading tools at runtime
- **Tool Discovery**: Auto-discover tools from Client registry
- **Tool Dependencies**: Handle tool dependencies
- **Custom Tools**: Future support for user-defined tools

### Tool Properties
- **Enabled/Disabled State**: Per-tool enable/disable toggle
- **Tool-Specific Configuration**: Each tool can have custom settings
- **Permission Settings**: Tool permission management per chat
- **Tool Dependencies**: Handle tool dependencies

### Tool Enablement and Permissions
- Tools available from client
- Tools active based on Chat configuration
- Tool enablement/disablement per chat
- Tool permission management per chat
- Ensure tools respect Chat configuration
- Handle tool availability per chat
- Verify tool permissions work correctly with multiple chats

### Tool Configuration Interface
- **Tool Interface Extension**: Add `get_config_schema()` method to Tool interface
- **Configuration UI**: Generate UI from schema
- **Validation**: Validate tool configurations

## Tool-Specific Configurations

### Codebase Search Tool (Multiple Model Usages)
- **Current State**: Uses two separate ModelUsage entries in `Config2.usage` map:
  - `usage["ocvector.embed"]` → ModelUsage (embedding model)
  - `usage["ocvector.analysis"]` → ModelUsage (analysis model)
- **New State**: Single CodebaseSearchToolConfig in `Config2.tools["codebase_search"]` with sub-settings:
  - `embed` (ModelUsage) - Embedding model configuration
  - `analysis` (ModelUsage) - Analysis model configuration
- **Configuration Properties**:
  - `enabled` (bool) - Whether tool is enabled
  - `embed` (ModelUsage) - Embedding model config (connection, model, options)
    - Connection for embedding model
    - Model name (e.g., "bge-m3:latest")
    - Options (temperature: 0.0, num_ctx: 2048, etc.)
  - `analysis` (ModelUsage) - Analysis model config (connection, model, options)
    - Connection for analysis model
    - Model name (e.g., "qwen3-coder:30b")
    - Options (temperature: 0.0, etc.)
  - `vector_db_path` (string) - Vector database path
  - `auto_index` (bool) - Auto-index on file changes
  - `index_frequency` (int) - Indexing frequency/interval
- **Migration**: 
  - Move from `usage["ocvector.embed"]` and `usage["ocvector.analysis"]` to `tools["codebase_search"]`
  - Consolidate into single CodebaseSearchToolConfig with embed and analysis as sub-settings
- **Note**: Currently may use `embed.json` config file - should integrate into main settings

### File Tools (Simple Config - BaseToolConfig)
- **Read File**: 
  - Uses `BaseToolConfig` (just enabled/disabled)
  - Simple tool, no complex configuration needed
- **Edit File**: 
  - Uses `BaseToolConfig` (just enabled/disabled)
  - Simple tool, no complex configuration needed
- **Note**: Future enhancements could add properties like max_file_size, allowed_extensions, backup_settings, but for now just enabled/disabled

### Terminal Command Tool
- **Working Directory**: Default directory
- **Allowed Commands**: Whitelist/blacklist
- **Timeout Settings**: Command execution timeout

### Web Search Tool
- **Configuration Properties**:
  - `enabled` (bool) - Whether tool is enabled
  - `search_engine` (string) - Search engine selection (Google, DuckDuckGo, etc.)
  - `api_key` (string) - API key for search engine (if required)
  - `max_results` (int) - Maximum number of results to return
  - `timeout` (int) - Request timeout in seconds
- **Storage**: Stored in `Config2.tools["web_search"]` with ToolConfig

### Web Fetch Tool (Simple Config - BaseToolConfig)
- **Configuration Properties**:
  - `enabled` (bool) - Whether tool is enabled
- **Storage**: Stored in `Config2.tools["web_fetch"]` with BaseToolConfig
- **Note**: Simple tool, just needs enabled/disabled. Future enhancements could add timeout, max_response_size, but for now just enabled/disabled

## Files to Create

### Configuration Classes
- `libollmchat/Settings/BaseToolConfig.vala` - Base tool configuration class for simple tools
  - Just has `enabled` property
  - For tools like ReadFile, EditFile, WebFetch
  - Implements Json.Serializable
- `libollmchat/Settings/ToolConfig.vala` - Extended tool configuration class
  - Extends BaseToolConfig
  - Follows ModelUsage pattern (connection, model, options)
  - Adds tool-specific properties
  - For tools like WebSearch that need a single model configuration
  - Implements Json.Serializable
- `libocvector/Tool/CodebaseSearchToolConfig.vala` - Tool-specific configuration for codebase search
  - Extends BaseToolConfig
  - Has `embed` (ModelUsage) and `analysis` (ModelUsage) as sub-settings
  - Adds tool-specific properties (vector_db_path, auto_index, etc.)
  - For codebase search tool which needs two model configurations
  - Implements Json.Serializable

### UI Components
- `libollmchat/Settings/ToolConfigUIProvider.vala` - Interface for tool UI providers
  - `create_config_widget(ToolConfig config)` - Generate UI widgets
  - `update_config_from_widget(Gtk.Widget widget, ToolConfig config)` - Update config from UI

## Files to Modify

### Config2
- `libollmchat/Settings/Config2.vala` - Add `tools` map
  - Add `public Gee.Map<string, BaseToolConfig> tools { get; set; }`
  - Similar to `model_options` map structure
  - Can store BaseToolConfig, ToolConfig, or tool-specific configs (like CodebaseSearchToolConfig)

### Tool System Files
- `libollmchat/Client.vala` - Tool registration and management
- `libollmchat/Call/Chat.vala` - Tool configuration per chat
- `libollmchat/Tool/Interface.vala` - Add configuration interface for tools
  - Add `get_config_ui_provider()` method (returns UI provider)
  - Add configuration validation methods
- `ollmchat/Window.vala` - Register tools based on settings

### Migration Files
- `libocvector/Database.vala` - Migrate codebase search config
  - Move from `Config2.usage["ocvector.embed"]` and `Config2.usage["ocvector.analysis"]` to `Config2.tools["codebase_search"]`
  - Update to use CodebaseSearchToolConfig with embed and analysis as sub-settings
  - Update `setup_embed_usage()` and related methods
- `libocvector/Indexing/Analysis.vala` - Migrate analysis config
  - Update `setup_analysis_usage()` to work with CodebaseSearchToolConfig
  - Remove separate registration of "ocvector.analysis"

### Implementation Notes
- Review current tool system (should be better after refactoring)
- Ensure tools respect Chat configuration
- Handle tool availability per chat
- Verify tool permissions work correctly with multiple chats

## Future Considerations

- **Tool Plugin System**: Support for loading external tools
- **Tool Marketplace**: Repository of community tools
- **Tool Development**: API for creating custom tools

## Config2 Structure

**New `tools` Map in Config2**:
```json
{
  "tools": {
    "read_file": {
      "enabled": true
    },
    "edit_file": {
      "enabled": true
    },
    "codebase_search": {
      "enabled": true,
      "embed": {
        "connection": "http://127.0.0.1:11434/api",
        "model": "bge-m3:latest",
        "options": {
          "temperature": 0.0,
          "num_ctx": 2048
        }
      },
      "analysis": {
        "connection": "http://127.0.0.1:11434/api",
        "model": "qwen3-coder:30b",
        "options": {
          "temperature": 0.0
        }
      },
      "vector_db_path": "~/.local/share/ollmchat/codedb.faiss.vectors",
      "auto_index": true,
      "index_frequency": 300
    },
    "web_search": {
      "enabled": true,
      "search_engine": "google",
      "api_key": "",
      "max_results": 10,
      "timeout": 30
    },
    "web_fetch": {
      "enabled": true
    }
  }
}
```

**Tool Config Types**:
- **Simple Tools** (BaseToolConfig): `read_file`, `edit_file`, `web_fetch` - Just enabled/disabled
- **Single Model Tools** (ToolConfig): `web_search` - Need one model configuration
- **Multiple Model Tools** (Tool-Specific Config): `codebase_search` (CodebaseSearchToolConfig) - Needs multiple model configurations (embed + analysis)

## Integration Points

- **Config2**: All settings stored in Config2 (connections, model_options, tools)
  - Tool configs stored in `tools` map with tool name as key: `tools["codebase_search"]` → BaseToolConfig (or subclass)
  - Each tool has one configuration entry (not multiple configs per tool)
  - Simple tools use BaseToolConfig (just enabled)
  - Single model tools use ToolConfig (connection, model, options + tool-specific)
  - Multiple model tools use tool-specific configs (e.g., CodebaseSearchToolConfig with embed and analysis sub-settings)
- **Client**: Used for fetching models, testing connections, tool registry
- **Tool Registry**: Access via `Client.tools` or global registry
- **BaseToolConfig**: Base class for simple tools (just enabled/disabled)
- **ToolConfig**: Extended class for tools needing one model (follows ModelUsage pattern: connection, model, options + tool-specific)
- **CodebaseSearchToolConfig**: Tool-specific class for codebase search (has embed and analysis ModelUsage sub-settings)
- **ModelUsage**: Used as sub-settings within tool configs (e.g., embed and analysis in CodebaseSearchToolConfig)
- **Call.Options**: Used for model options in ModelUsage sub-settings
- **UI Provider**: Tools provide UI provider for generating configuration widgets

