# 3.8.1. EditMode and RunCommand is_need_approval Flag Updates

## Overview

Set `is_need_approval = true` flag when files are created or modified by EditMode or RunCommand tools. Do NOT set this flag during scanning - scanner changes are assumed to be user-initiated and don't need approval.

## Status

âœ… **DONE** - Implementation complete.

## Prerequisites

- Phase 3.8 (main plan) must be reviewed
- `is_need_approval` flag exists in `FileBase` (already verified)
- Database schema includes `is_need_approval` column
- `copy_db_fields_to()` includes `is_need_approval`

## Goals

1. Rename `needs_approval` to `is_need_approval` for consistency with other properties
2. Add `is_need_approval` to database schema
3. Add `is_need_approval` to `copy_db_fields_to()` method
4. Set `is_need_approval = true` when EditMode applies changes
5. Set `is_need_approval = true` when RunCommand modifies files
6. Update `last_modified` timestamp when files are modified
7. Do NOT set flag during scanning (user changes don't need approval)

## Implementation Details

### Files to Modify

1. `libocfiles/FileBase.vala` - Rename property, add to database schema, add to copy_db_fields_to
2. `libocfiles/File.vala` - Rename property
3. `libocfiles/FileAlias.vala` - Rename property
4. `libocfiles/ProjectFile.vala` - Rename property
5. `liboctools/EditMode/Request.vala` - Set flag after applying changes
6. `liboctools/RunCommand/Scan.vala` - Set flag when detecting new/modified files

### Changes Required

#### 1. FileBase.vala - Property Rename and Database Schema

**Changes**:

1. **Rename property** (line ~204):
   ```vala
   /**
    * Whether the file needs approval.
    * true = needs approval, false = approved.
    */
   public bool is_need_approval { get; set; default = false; }
   ```

2. **Add to database schema** (line ~271):
   ```vala
   var query = "CREATE TABLE IF NOT EXISTS filebase (" +
       // ... existing columns ...
       "is_need_approval INTEGER NOT NULL DEFAULT 0" +
       ");";
   ```

3. **Add migration** (after line ~312):
   ```vala
   // Migrate existing databases: add is_need_approval column if it doesn't exist
   var migrate_is_need_approval = "ALTER TABLE filebase ADD COLUMN is_need_approval INTEGER NOT NULL DEFAULT 0";
   if (Sqlite.OK != db.db.exec(migrate_is_need_approval, null, out errmsg)) {
       // Column might already exist, which is fine
       if (!errmsg.contains("duplicate column name")) {
           GLib.debug("Migration note (may be expected): %s", errmsg);
       }
   }
   ```

4. **Add to copy_db_fields_to()** (line ~399):
   ```vala
   target.is_need_approval = this.is_need_approval;
   ```

#### 2. EditMode/Request.vala (liboctools/EditMode/Request.vala)

**Location**: After line ~650, after successfully applying changes

**Changes**:

```vala
// Log and send status message after successful write with more detail
GLib.debug("Request.apply_all_changes: Successfully applied changes to file %s", this.normalized_path);

// ... existing success_message code ...

this.send_ui("txt", "Changes Applied", success_message);

// Set is_need_approval flag after applying changes (our app modified the file)
file.is_need_approval = true;
// Update last_modified timestamp
file.last_modified = new GLib.DateTime.now_local().to_unix();
// Save to database with updated flag
file.saveToDB(project_manager.db, null, false);

// Emit change_done signal for each change
var edit_tool = (Tool) this.tool;
foreach (var change in this.changes) {
    edit_tool.change_done(this.normalized_path, change);
}
```

#### 3. RunCommand/Scan.vala (liboctools/RunCommand/Scan.vala)

**Location**: Around lines 210-280

**Changes**:

1. **When new file detected** (line ~224, `change_type == "added"`):
   ```vala
   if (change_type == "added") {
       // Set is_need_approval for new files created by our app (RunCommand)
       file.is_need_approval = true;
       // Update last_modified timestamp from filesystem
       file.last_modified = file.mtime_on_disk();
       
       try {
           var fake_file = new OLLMfiles.File.new_fake(this.project_folder.manager, file.path);
           yield this.project_folder.manager.convert_fake_file_to_real(fake_file, file.path);
       } catch (GLib.Error e) {
           GLib.warning("Cannot convert fake file to real (%s): %s", file.path, e.message);
       }
       return;
   }
   ```

2. **When file modified** (line ~211, `change_type == "modified"`):
   ```vala
   var file = filebase as OLLMfiles.File?;
   var change_type = "modified";
   
   if (file == null) {
       // ... existing code for creating new file ...
   }
   
   // ... existing FileHistory creation code ...
   
   // Copy file from overlay to real path
   try {
       GLib.File.new_for_path(overlay_path).copy(
           GLib.File.new_for_path(real_path),
           GLib.FileCopyFlags.OVERWRITE,
           null,
           null
       );
   } catch (GLib.Error e) {
       GLib.warning("Cannot copy file from overlay to real path (%s -> %s): %s", 
           overlay_path, real_path, e.message);
       return;
   }
   
   this.copy_permissions(overlay_path, real_path);
   
   // Set is_need_approval for modified files (our app modified the file via RunCommand)
   if (change_type == "modified") {
       file.is_need_approval = true;
       // Update last_modified timestamp from filesystem
       file.last_modified = file.mtime_on_disk();
   }
   
   // ... rest of existing code ...
   ```

## Implementation Tasks

- [x] Rename `needs_approval` to `is_need_approval` in FileBase.vala
- [x] Add `is_need_approval` to database schema in FileBase.vala
- [x] Add migration for `is_need_approval` column in FileBase.vala
- [x] Add `is_need_approval` to `copy_db_fields_to()` in FileBase.vala
- [x] Rename `needs_approval` to `is_need_approval` in File.vala
- [x] Rename `needs_approval` to `is_need_approval` in FileAlias.vala
- [x] Rename `needs_approval` to `is_need_approval` in ProjectFile.vala
- [x] Update `EditMode/Request.vala` to set `is_need_approval = true` after applying changes
- [x] Update `EditMode/Request.vala` to update `last_modified` timestamp
- [x] Update `RunCommand/Scan.vala` to set `is_need_approval = true` for new files
- [x] Update `RunCommand/Scan.vala` to set `is_need_approval = true` for modified files
- [x] Update `RunCommand/Scan.vala` to update `last_modified` timestamp (uses `mtime_on_disk()` for accuracy)
- [x] Verify scanner does NOT set `is_need_approval` flag

## Testing

- Test property renamed to `is_need_approval` in all files
- Test database schema includes `is_need_approval` column
- Test migration adds `is_need_approval` column to existing databases
- Test `copy_db_fields_to()` copies `is_need_approval` flag
- Test EditMode sets `is_need_approval = true` after applying changes
- Test EditMode updates `last_modified` after applying changes
- Test RunCommand sets `is_need_approval = true` for new files
- Test RunCommand sets `is_need_approval = true` for modified files
- Test RunCommand updates `last_modified` for modified files
- Test scanner does NOT set `is_need_approval` flag (user changes don't need approval)
- Test flag is persisted to database
- Test flag is loaded from database correctly
- Test default value is `false` (files are approved by default)