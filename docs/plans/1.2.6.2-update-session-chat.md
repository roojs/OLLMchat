# 1.2.6.2. Update Session to Use Agent Instead of Direct Chat Access

## Overview

Remove `this.chat` from SessionBase (it was a temporary solution). Session should only have access to the agent, and users can get the chat from the agent of the session. Also update Chat's `send()` method to take messages array as argument and reset everything when called.

**Parent Plan**: [1.2.6. Update Legacy Methods](./1.2.6-update-legacy-methods.md)

**Prerequisite**: [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) must be complete

## Status

⏳ **TODO** - Needs implementation.

## Architectural Changes

### 1. Remove `this.chat` from SessionBase

**Current State**:
- `SessionBase` has `public Call.Chat? chat { get; set; }` (line 32 in `SessionBase.vala`)
- `SessionBase` constructor creates `this.chat` (line 157)
- Session uses `this.chat` for various operations (fid, reply, cancellation, etc.)

**New State**:
- Remove `this.chat` property from `SessionBase`
- Session should only have access to agent (via `session.agent_name` and `manager.get_active_agent()`)
- Users can get chat from agent: `agent.get_chat()` or similar method
- **Note**: AgentHandler creates Chat objects per request, so there may not be a persistent Chat on Session. Need to determine how UI accesses Chat for display.

**Impact**:
- `Session.fid` currently returns `this.chat.fid` (line 54) - needs alternative
- `Session.send_message()` uses `this.chat` for reply() and cancellation - needs refactoring
- UI accesses `session.chat` - needs alternative access pattern
- `SessionPlaceholder` and `EmptySession` create/use `this.chat` - needs refactoring

### 2. Update Chat's `send()` Method

**Current State**:
- `Chat.exec_chat()` uses `this.messages` array (line 447)
- Messages array must be prepared before calling `exec_chat()`

**New State**:
- Rename `exec_chat()` to `send()` (planned in [1.2.7](./1.2.7-move-signals-to-chat.md) Phase 4)
- `send()` should take messages array as argument: `public async Response.Chat send(Gee.ArrayList<Message> messages)`
- `send()` should reset all state when called:
  - Clear/reset `streaming_response`
  - Clear/reset any internal state
  - Use the provided messages array instead of `this.messages`

**Benefits**:
- Makes Chat more stateless and reusable
- Each call is independent
- No need to clear messages array before calling
- Clearer API - messages are passed explicitly

## Flow Context

**Who calls `Session.send_message()`?**
- **UI (ChatWidget)** calls `manager.session.send_message(text, cancellable)` directly (line 511 in `ChatWidget.vala`)
- This is the **legacy/non-agent flow** that bypasses the Agent system

**Current Architecture (Temporary)**:
- `SessionBase` has `this.chat` created in constructor
- Session uses `this.chat` for operations
- UI accesses `session.chat` for display

**New Architecture (Target)**:
- `SessionBase` does NOT have `this.chat`
- Session has access to agent via `manager.get_active_agent()`
- AgentHandler creates Chat objects per request
- UI gets Chat from agent: `session.get_chat()` or `agent.get_chat()` or similar
- **Question**: How does UI access Chat for display if AgentHandler creates temporary Chat objects per request?
  - **Option A**: AgentHandler stores last Chat in Session or Manager
  - **Option B**: Session maintains reference to current/last AgentHandler
  - **Option C**: Manager tracks active handler and exposes Chat via signal
  - **Option D**: Messages carry Chat reference via `message.message_interface`

**Two Separate Flows**:
1. **Legacy flow (non-agent)**: UI → `Session.send_message()` → needs refactoring
   - **Current**: UI calls `manager.session.send_message(text, cancellable)` directly
   - **Problem**: Uses `this.chat` which should be removed
   - **Solution**: Session should create Chat via agent or directly
2. **Agent flow (planned)**: UI → Manager → Agent → `AgentHandler.send_message_async()` → creates NEW Chat → `send()`
   - **Planned in**: [1.10. Refactor Agents as Interface](./1.10-refactor-agents-interface.md) Phase 4
   - **Status**: TODO - not yet implemented
   - **AgentHandler**: Already exists and works correctly - creates its own Chat objects per request

**How Session Messages Get Updated in Agent Flow**:
- **AgentHandler** creates messages and calls `session.add_message(message)` (line 177 in `AgentHandler.vala`)
- **SessionBase.add_message()** (line 299):
  - Adds message to `session.messages` array
  - Relays to UI via `manager.add_message(message, this)` signal
  - UI receives `SessionBase` so it can access `session.client` and `session.chat` (but `session.chat` will be removed)
- **Manager.add_message()** signal (line 93 in `Manager.vala`):
  - Emitted with `(Message, SessionBase?)` parameters
  - UI connects to this signal to display messages
  - **Note**: Messages have `message.message_interface` which can be a Chat object

**How UI Gets to Chat in New Architecture**:
- **Option 1**: Via Message: `message.message_interface` is the Chat object (if Message is Chat)
- **Option 2**: Via AgentHandler: Session maintains reference to current handler, handler exposes Chat
- **Option 3**: Via Manager: Manager tracks active handler and exposes Chat
- **Option 4**: Via Agent: Agent has method to get current/last Chat
- **Recommendation**: Use Option 1 (via Message) as it's already implemented - Messages have `message_interface` property

## Goal

1. Remove `this.chat` from `SessionBase` - Session should only have access to agent
2. Update Chat's `send()` method to take messages array as argument and reset state
3. Refactor all code that uses `session.chat` to use alternative access pattern
4. Ensure UI can still access Chat for display purposes

## Current Implementation

### SessionBase.chat Property

**File**: `libollmchat/History/SessionBase.vala` (line 32)

```vala
public Call.Chat? chat { get; set; }
```

**Created in constructor** (line 157):
```vala
this.chat = new Call.Chat(this.client.connection, model) {
    stream = true,
    think = false
};
```

**Used in**:
- `Session.fid` getter (line 54): `return this.chat.fid;`
- `Session.send_message()` (line 425, 429, 434, 469): Uses `this.chat` for stream, reply, cancellation
- `Session.on_message_created()` (line 108-115): Updates `this.chat` properties from new chat
- `Session.on_stream_chunk()` (line 172, 184, 203, 208): Creates Messages with `this.chat`
- `SessionPlaceholder.load()` (line 69, 79, 106, 120, 129): Uses `this.chat`
- `EmptySession.send_message()` (line 36, 76): Uses `this.chat`
- `SessionBase.permission_provider` setter (line 50): Sets on `this.chat`

### Chat.exec_chat() Method

**File**: `libollmchat/Call/Chat.vala` (line 444)

```vala
public async Response.Chat exec_chat() throws Error
{
    // Agent/handler must prepare the messages array before calling exec_chat()
    if (this.messages.size == 0) {
        throw new OllamaError.INVALID_ARGUMENT("Chat messages array is empty...");
    }
    // ... uses this.messages
}
```

**Problem**: Uses `this.messages` array, requires preparation before calling.

## Proposed Changes

### 1. Remove `this.chat` from SessionBase

**Steps**:
1. Remove `public Call.Chat? chat { get; set; }` from `SessionBase`
2. Remove Chat creation from `SessionBase` constructor
3. Update `Session.fid` to get from agent or store separately
4. Update `Session.send_message()` to create Chat via agent or directly
5. Update `Session.on_message_created()` to not update `this.chat` (chat doesn't exist)
6. Update `Session.on_stream_chunk()` to get Chat from message or agent
7. Update `SessionPlaceholder` and `EmptySession` to not use `this.chat`
8. Update `SessionBase.permission_provider` setter to not set on `this.chat`
9. Update UI code that accesses `session.chat` to use alternative pattern

**Alternative Access Patterns**:
- **For fid**: Store `fid` directly on Session (not via chat)
- **For reply()**: Create new Chat or get from agent
- **For cancellation**: Track cancellable separately or via agent
- **For Messages**: Messages have `message_interface` which can be Chat
- **For UI**: Access Chat via `message.message_interface` or via agent

### 2. Update Chat.send() Method

**New Signature**:
```vala
public async Response.Chat send(Gee.ArrayList<Message> messages, GLib.Cancellable? cancellable = null) throws Error
```

**Behavior**:
- Takes messages array as argument (instead of using `this.messages`)
- Resets all state when called:
  - `this.streaming_response = null`
  - Clear any internal state
  - Use provided messages array (don't modify `this.messages`)
- Returns Response.Chat

**Implementation**:
```vala
public async Response.Chat send(Gee.ArrayList<Message> messages, GLib.Cancellable? cancellable = null) throws Error
{
    if (messages.size == 0) {
        throw new OllamaError.INVALID_ARGUMENT("Chat messages array is empty. Provide messages to send.");
    }
    
    // Reset state
    this.streaming_response = null;
    this.cancellable = cancellable;
    
    // Use provided messages (create temporary array for API call)
    var api_messages = new Gee.ArrayList<Message>();
    foreach (var msg in messages) {
        api_messages.add(msg);
    }
    
    // Store messages in this.messages for serialization/access (but don't require it for send)
    this.messages = api_messages;
    
    if (this.stream) {
        return yield this.execute_streaming();
    }
    
    return yield this.execute_non_streaming();
}
```

**Update call sites**:
- `AgentHandler.send_message_async()`: Change `call.exec_chat()` to `call.send(call.messages, cancellable)`
- `CodeAssistantHandler.send_message_async()`: Same change
- `Session.send_message()`: Create Chat, prepare messages, call `chat.send(messages, cancellable)`
- `Client.chat()`: Prepare messages, call `call.send(messages, cancellable)`

## Implementation Steps

### Phase 1: Update Chat.send() Method
1. Rename `exec_chat()` to `send()` in `Call.Chat`
2. Update signature to take messages array: `send(Gee.ArrayList<Message> messages, GLib.Cancellable? cancellable = null)`
3. Add state reset logic
4. Update all call sites to pass messages array

### Phase 2: Remove `this.chat` from SessionBase
1. Store `fid` directly on Session (not via chat)
2. Update `Session.send_message()` to create Chat directly or via agent
3. Update `Session.on_message_created()` to not update `this.chat`
4. Update `Session.on_stream_chunk()` to get Chat from message or agent
5. Update `SessionPlaceholder` and `EmptySession`
6. Update `SessionBase.permission_provider` setter
7. Remove `this.chat` property from `SessionBase`
8. Remove Chat creation from `SessionBase` constructor

### Phase 3: Update UI Access Pattern
1. Update UI code that accesses `session.chat` to use `message.message_interface` or agent
2. Test UI still works for displaying messages

## Test

1. Verify Session still works for first message
2. Verify reply() still works for subsequent messages
3. Verify UI can still access Chat for display
4. Verify cancellation still works
5. Verify fid is still accessible

## Result

- Session no longer has `this.chat` - only has access to agent
- Chat's `send()` method takes messages array and resets state
- UI accesses Chat via message or agent, not directly from Session

## Files to Modify

- `libollmchat/Call/Chat.vala` - Rename `exec_chat()` to `send()`, update signature
- `libollmchat/History/SessionBase.vala` - Remove `this.chat` property and creation
- `libollmchat/History/Session.vala` - Update to not use `this.chat`
- `libollmchat/History/SessionPlaceholder.vala` - Update to not use `this.chat`
- `libollmchat/History/EmptySession.vala` - Update to not use `this.chat`
- `libollmchat/Prompt/AgentHandler.vala` - Update to use `chat.send(messages, cancellable)`
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Update to use `chat.send(messages, cancellable)`
- `libollmchat/Client.vala` - Update to use `chat.send(messages, cancellable)`
- UI files that access `session.chat` - Update to use alternative pattern

## Related Plans

- [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) - Prerequisite
- [1.2.7. Move Signals to Chat](./1.2.7-move-signals-to-chat.md) - Phase 4 renames `exec_chat()` to `send()`
- [1.10. Refactor Agents as Interface](./1.10-refactor-agents-interface.md) - Documents the planned UI → Manager → Agent → Chat flow
