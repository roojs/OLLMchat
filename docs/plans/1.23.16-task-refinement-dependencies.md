# 1.23.16 Task refinement dependencies

**FORBIDDEN:** Never write long paragraphs in this plan. They are unreadable. **ALWAYS** use short bullet points and nested bullet points only.

**Scope:** Prerequisites that must exist or change before **Task.Tool** (Tool.vala) can be wired into the build and used by ResultParser/Details. Does **not** add Tool.vala to meson.

**Coding standards:** Follow `.cursor/rules/CODING_STANDARDS.md`.

---

## Overview

- **Purpose:** Implement the dependencies listed in 1.23.15 §5 (Prerequisites) so that Tool.vala can later be added to meson and used.
- **Dependencies:** 1.23.15 (task refinements); 1.23.13 (task-related code, DONE)
- **Status:** PLAN

---

## 1. Markdown.Document headings keyed by anchor — DONE

- **Current:** Document keys headings by heading text (e.g. `"Result summary"`, `"Tool Calls"`). 1.23.15 uses "Tool Calls" for the Tool Calls section.
- **Deliverable:** Key headings by GFM-style anchor (no separate helper). Update Document only at add-heading time; update all consumers to use anchor keys.
- **Rules for key:** Lowercase; each run of non-alphanumeric (spaces, punctuation) → single hyphen; trim leading/trailing hyphens. Examples: "Task" → "task", "Tool Calls" → "tool-calls", "Result summary" → "result-summary", "aa+++aaa" → "aa-aaa".
- **Done:** `Document.register_heading()` in libocmarkdown/document/Document.vala now computes anchor from `b.text_content().strip()` using GLib.Regex (`[^a-z0-9]+` → hyphen, then trim leading/trailing hyphens) and uses that as the key.

- **Update all consumers** to use anchor keys (string literals only, no variables for keys):
  - ResultParser: extract_refinement() use **task** (section "Task"); Tool Calls walk use **tool-calls**; extract_exec() use **result-summary** (replace "Result summary").
  - Any other code that uses document.headings (e.g. Skill.Definition **available-skills**) must use the anchor for that section.

---

## 2. ResultParser.extract_refinement() — DONE

- **Current:** Walk of Tool Calls section (anchor key **tool-calls**); for each fenced block, create Tool instance, parse block, add to task.tools.
- **Status:** Fixed.

---

## 3. OLLMchat.Tool.BaseTool — title and example_call abstract + examples

- **Current:** `title` and `example_call` are concrete properties (get; set; default = ""). Task.Tool.to_instructions() appends example when non-empty.
- **Design (planning only):**
  - **Abstract:** Make `title` and `example_call` abstract getters (same pattern as `description`); every child class implements them. No private backing, no null strings.
  - **Wrapped:** For a start, wrapped clones use the base tool’s title/example_call. If per-.tool title/example is needed later, use a wrapper type or constructor args, not backing on BaseTool.
  - **Example format:** One-line JSON matching the Tool Calls block shape: `{"name": "<tool_name>", "arguments": { ... }}`. Same schema the LLM is asked to emit; to_instructions() appends "Example: " + example_call.
- **Proposed examples for current tools:**

| Tool | title (existing or fix) | example_call |
|------|-------------------------|--------------|
| ReadFile.Tool | "Read File Tool" | `{"name": "read_file", "arguments": {"file_path": "src/main.vala", "start_line": 1, "end_line": 30}}` |
| RunCommand.Tool | "Run Shell Commands Tool" | `{"name": "run_command", "arguments": {"command": "ls -la"}}` |
| WebFetch.Tool | "Web Fetch URL Tool" | `{"name": "web_fetch", "arguments": {"url": "https://example.com"}}` |
| EditMode.Tool | "Edit Mode Tool" | `{"name": "edit_mode", "arguments": {"file_path": "src/main.vala", "edit_mode": "ast_path"}}` |
| GoogleSearch.Tool | "Google Search Tool" | `{"name": "google_search", "arguments": {"query": "Vala programming"}}` |
| Child.Tool | From agent (e.g. agent_name or "Agent: " + name) | `{"name": "<agent_name>", "arguments": {"query": "Summarize the project"}}` — name is dynamic so example uses this.name in doc; actual string uses agent_name. |
| CodebaseSearchTool | "Semantic Codebase Search Tool" (fix typo "Sematic") | `{"name": "codebase_search", "arguments": {"query": "where is file reading implemented"}}` |

- **Wrapped tools (.tool files):**
  - **Format:** Add optional `@example` to .tool definition (single line, JSON string). Same shape: `{"name": "<wrapped_tool_name>", "arguments": { ... }}` so the example matches the wrapper’s name and parameters (same as base or custom @param).
  - **Behaviour:** ToolBuilder after clone sets the wrapped title from existing `@title`; set example from `@example` when present, else fall back to base tool’s example_call with `"name"` replaced by parser.name so the LLM sees the correct tool name.
  - **ParamParser:** Add `@example` parsing (single value, rest of line or next line); expose as e.g. `parser.example` for ToolBuilder.
- **Deliverable:** Implement abstract title/example_call (same pattern as `description`), and the above examples; add @example to .tool format and ParamParser when implementing. No private backing fields; no null strings. Wrapped-tool display (different title/example per .tool) can be handled later if needed (e.g. wrapper type or constructor args), without backing on BaseTool.

**Concrete code changes:**

- **libollmchat/Tool/BaseTool.vala** — Same pattern as `description`: abstract getters only.

```vala
// Replace: public string title { get; set; default = ""; }
// Replace: public string example_call { get; set; default = ""; }
// With (same style as description):
public abstract string title { get; }
public abstract string example_call { get; }
```

- **Each concrete tool** — Override like `description`: implement getters; remove any `this.title = "..."` from constructors.

```vala
// ReadFile.Tool
public override string title { get { return "Read File Tool"; } }
public override string example_call {
	get { return "{\"name\": \"read_file\", \"arguments\": {\"file_path\": \"src/main.vala\", \"start_line\": 1, \"end_line\": 30}}"; }
}
// Remove from constructor: this.title = "Read File Tool";
```

```vala
// CodebaseSearchTool (fix typo "Sematic")
public override string title { get { return "Semantic Codebase Search Tool"; } }
public override string example_call {
	get { return "{\"name\": \"codebase_search\", \"arguments\": {\"query\": \"where is file reading implemented\"}}"; }
}
```

```vala
// Child.Tool (dynamic)
public override string title { get { return this.agent_name; } }
public override string example_call {
	get { return "{\"name\": \"" + this.agent_name + "\", \"arguments\": {\"query\": \"Summarize the project\"}}"; }
}
```

- **libollmchat/Tool/ParamParser.vala** — Add `@example` (same style as `@title`): property `public string example { get; private set; default = ""; }` and in the annotation switch `case "@example":` with rest-of-line value like `@title`.

- **liboctools/ToolBuilder.vala** — Remove assignment to `new_tool.title` (title is get-only). Wrapped clones will show the base tool’s title/example_call until a later mechanism (e.g. wrapper or constructor args) is added.

- **Task.Tool.to_instructions()** — No change: already uses `base_tool.example_call`.

---

## 4. Task namespace — add to meson (after §1–§3)

- **Current:** No Task/*.vala files are in liboccoder’s meson.build. Details.vala, ResultParser.vala, Tool.vala (and any Task/ deps) exist but are not built by meson.
- **Deliverable:** Add Task namespace to liboccoder meson: Task sources (Tool.vala, Details.vala, ResultParser.vala; plus Task/List.vala, Task/Step.vala if dependencies) so the library builds. Then Details.tools and run_tools() (already in code) work: ResultParser (§2) populates task.tools; run_tools() iterates and yields tool.execute().
- **Depends on:** §3 (example_call design) so Task.Tool.to_instructions() has a stable contract.
- **Task code uses:** `task.runner.session.manager.tools`, `BaseTool.function`, `BaseTool.example_call`, `task.tool_outputs`, `task.tool_calls`; Tool.parse(), validate(), execute().

---

## References

- 1.23.15 (task refinements — §5 Prerequisites, §4 Build/meson)
- 1.23.13 (task-related code, DONE)
- [Ollama tool calling](https://docs.ollama.com/capabilities/tool-calling)
