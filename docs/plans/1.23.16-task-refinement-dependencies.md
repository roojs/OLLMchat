# 1.23.16 Task refinement dependencies

**FORBIDDEN:** Never write long paragraphs in this plan. They are unreadable. **ALWAYS** use short bullet points and nested bullet points only.

**Scope:** Prerequisites that must exist or change before **Task.Tool** (Tool.vala) can be wired into the build and used by ResultParser/Details. Does **not** add Tool.vala to meson.

**Coding standards:** Follow `.cursor/rules/CODING_STANDARDS.md`.

---

## Overview

- **Purpose:** Implement the dependencies listed in 1.23.15 §5 (Prerequisites) so that Tool.vala can later be added to meson and used.
- **Dependencies:** 1.23.15 (task refinements); 1.23.13 (task-related code, DONE)
- **Status:** PLAN

---

## 1. Markdown.Document headings keyed by anchor — DONE

- **Current:** Document keys headings by heading text (e.g. `"Result summary"`, `"Tool Calls"`). 1.23.15 uses "Tool Calls" for the Tool Calls section.
- **Deliverable:** Key headings by GFM-style anchor (no separate helper). Update Document only at add-heading time; update all consumers to use anchor keys.
- **Rules for key:** Lowercase; each run of non-alphanumeric (spaces, punctuation) → single hyphen; trim leading/trailing hyphens. Examples: "Task" → "task", "Tool Calls" → "tool-calls", "Result summary" → "result-summary", "aa+++aaa" → "aa-aaa".
- **Done:** `Document.register_heading()` in libocmarkdown/document/Document.vala now computes anchor from `b.text_content().strip()` using GLib.Regex (`[^a-z0-9]+` → hyphen, then trim leading/trailing hyphens) and uses that as the key.

- **Update all consumers** to use anchor keys (string literals only, no variables for keys):
  - ResultParser: extract_refinement() use **task** (section "Task"); Tool Calls walk use **tool-calls**; extract_exec() use **result-summary** (replace "Result summary").
  - Any other code that uses document.headings (e.g. Skill.Definition **available-skills**) must use the anchor for that section.

---

## 2. ResultParser.extract_refinement() — DONE

- **Current:** Walk of Tool Calls section (anchor key **tool-calls**); for each fenced block, create Tool instance, parse block, add to task.tools.
- **Status:** Fixed.

---

## 3. OLLMchat.Tool.BaseTool — title and example_call abstract + examples — DONE

- **Current:** `title` and `example_call` were concrete properties (get; set; default = ""). Task.Tool.to_instructions() appends example when non-empty.
- **Design:**
  - **Abstract:** `title` and `example_call` are abstract getters (same pattern as `description`); every child class implements them. No private backing, no null strings.
  - **Wrapped:** Wrapped clones use the base tool’s title/example_call. ParamParser has `@example`; resources/wrapped-tools/*.tool have @example; ToolBuilder uses parser.title (no assignment to tool.title; title is get-only).
  - **Example format:** One-line JSON `{"name": "<tool_name>", "arguments": { ... }}`. to_instructions() appends "Example: " + example_call when non-empty.
- **Done:** BaseTool has abstract `title` and `example_call`. All concrete tools (ReadFile, RunCommand, WebFetch, EditMode, GoogleSearch, CodebaseSearchTool, Child.Tool) override both; Child.Tool uses `agent_example` from frontmatter. ParamParser has `example` and `@example`; all wrapped .tool files have @example. ToolBuilder does not set title on clone (get-only).

---

## 4. Task namespace — add to meson (after §1–§3)

- **Current:** No Task/*.vala files are in liboccoder’s meson.build. Details.vala, ResultParser.vala, Tool.vala (and any Task/ deps) exist but are not built by meson.
- **Deliverable:** Add Task namespace to liboccoder meson: Task sources (Tool.vala, Details.vala, ResultParser.vala; plus Task/List.vala, Task/Step.vala if dependencies) so the library builds. Then Details.tools and run_tools() (already in code) work: ResultParser (§2) populates task.tools; run_tools() iterates and yields tool.execute().
- **Depends on:** §3 (example_call design) so Task.Tool.to_instructions() has a stable contract.
- **Task code uses:** `task.runner.session.manager.tools`, `BaseTool.function`, `BaseTool.example_call`, `task.tool_outputs`, `task.tool_calls`; Tool.parse(), validate(), execute().

---

## References

- 1.23.15 (task refinements — §5 Prerequisites, §4 Build/meson)
- 1.23.13 (task-related code, DONE)
- [Ollama tool calling](https://docs.ollama.com/capabilities/tool-calling)
