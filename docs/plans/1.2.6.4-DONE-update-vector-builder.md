# 1.2.6.4. Update VectorBuilder

## Overview

Update VectorBuilder to take `Config2` instead of `Client` and get the model from the "embed_model" usage entry, similar to how TitleGenerator uses "title_model". This allows test tools/examples (which have Config2 access but not Manager) to use VectorBuilder.

**Parent Plan**: [1.2.6. Update Legacy Methods](./1.2.6-update-legacy-methods.md)

**Prerequisite**: [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) must be complete

## Status

âœ… **DONE** - Implementation complete.

## Goal

VectorBuilder should not depend on `Client` with config. According to plan 1.2, Manager owns the config, not Client. VectorBuilder should take `Config2` and get the model from a usage entry (e.g., "embed_model"), similar to how TitleGenerator uses "title_model". This allows test tools/examples (which have Config2 access but not Manager) to use VectorBuilder.

## Current Implementation

**File**: `libocvector/Indexing/VectorBuilder.vala` (line 106)

```vala
public VectorBuilder(OLLMchat.Client client, Database database, SQ.Database sql_db)
{
    this.client = client;
    // ...
}
// ...
var model = this.client.config.get_default_model();
var embed_response = yield this.client.embed_array(model, documents);
```

**Problem**: VectorBuilder takes `Client` but should take `Config2` and get the model from a usage entry (e.g., "embed_model"), similar to TitleGenerator.

## Proposed Fix

```vala
private Settings.Config2 config;

public VectorBuilder(Settings.Config2 config, Database database, SQ.Database sql_db)
{
    this.config = config;
    this.database = database;
    this.sql_db = sql_db;
    
    // Initialize SQL schema if needed
    VectorMetadata.initDB(sql_db);
}

public async void process_file(Tree tree) throws GLib.Error
{
    // ... prepare documents ...
    
    // Return early if embed_model is not configured or invalid
    if (!this.config.usage.has_key("embed_model")) {
        throw new GLib.IOError.FAILED("No embed_model configured for embeddings");
    }
    
    var embed_model_usage = this.config.usage.get("embed_model") as Settings.ModelUsage;
    var model = embed_model_usage.model;
    
    if (model == "" || embed_model_usage.connection == "" || !this.config.connections.has_key(embed_model_usage.connection)) {
        throw new GLib.IOError.FAILED("Invalid embed_model configuration");
    }
    
    var connection = this.config.connections.get(embed_model_usage.connection);
    
    // Create client from connection (no config - Manager owns config)
    var client = new Client(connection);
    // Pass model and options from embed_model usage entry
    var embed_response = yield client.embed_array(
        model, 
        documents,
        -1,  // dimensions (default)
        false,  // truncate (default)
        embed_model_usage.options  // Use options from embed_model usage entry
    );
    
    // ... rest of implementation ...
}
```

**Note**: 
- VectorBuilder takes `Config2` and gets the model from the "embed_model" usage entry
- This allows test tools/examples (which have Config2 access) to use VectorBuilder without needing Manager
- Similar approach to TitleGenerator which uses "title_model" usage entry

## Implementation Steps

1. Update `VectorBuilder` constructor to take `Config2` instead of `Client`
2. Update `process_file()` method to:
   - Get model from "embed_model" usage entry in config
   - Get connection from config.connections using embed_model_usage.connection key
   - Create Client from Connection (no config)
   - Use model and options from embed_model usage entry for embed_array call
3. Update `Indexer` to:
   - Pass `Config2` to VectorBuilder instead of `Client`
   - Indexer already has access to config (via embed_client.config)
4. Find all other call sites of VectorBuilder constructor and update them to pass Config2
5. Test that vector building still works

## Test

Verify vector building still works for code indexing.

## Result

VectorBuilder uses `Config2` and gets the model from the "embed_model" usage entry, similar to TitleGenerator. This allows test tools/examples (which have Config2 access) to use VectorBuilder without needing Manager access.

## Files to Modify

- `libocvector/Indexing/VectorBuilder.vala` - Update constructor to take `Config2`, update `process_file()` method to get model from "embed_model" usage entry
- `libocvector/Indexing/Indexer.vala` - Update to pass `Config2` instead of `Client` to VectorBuilder (can get from embed_client.config)
- Find and update all VectorBuilder constructor call sites (e.g., examples, tools) to pass Config2

## Related Plans

- [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) - Prerequisite

