# 1.2.4. Update All Chat Creation Points

## Overview

Update all places in the codebase that create `Call.Chat` objects to use the new constructor signature (taking `Connection` instead of `Client`) and explicitly set all required properties.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

✅ **COMPLETE** - All Chat creation points have been migrated to use `Connection` instead of `Client`.

## Migration Status Summary

**Phase 2: All Steps Complete** ✅

All Chat creation points now use the `Chat(Connection connection, ...)` constructor directly (the regular constructor, not a separate `new_connection_refactor` constructor). The migration was completed as part of the overall refactoring.

### Completed Steps:

- ✅ **Step 2.1**: `Client.chat()` - Uses `this.connection` (line 190)
- ✅ **Step 2.2**: `Client.embed()` / `embed_array()` - Uses `this.connection` (lines 384, 437)
- ✅ **Step 2.3**: `Client.generate()` - Uses `this.connection` (line 488)
- ✅ **Step 2.4**: `Config2.create_chat()` - Uses `client.connection` (line 562)
- ✅ **Step 2.5**: `Analysis` - Uses `analysis_client.connection` (line 321)
- ✅ **Step 2.6**: `EmptySession.send_message()` - Uses `this.chat` from SessionBase (which uses `this.client.connection`)
- ✅ **Step 2.7**: `SessionPlaceholder` - Uses `this.chat` from SessionBase (which uses `this.client.connection`)
- ✅ **Step 2.8**: `Manager.new_client()` - Uses `client.connection` (line 293)
- ✅ **Step 2.9**: `AgentHandler` - Uses `this.client.connection` (line 155)
- ✅ **Step 2.10**: `CodeAssistantHandler` - Uses `this.client.connection` (line 65)

### Current Constructor Signature:

The `Call.Chat` constructor now takes `Connection` directly:
```vala
public Chat(Settings.Connection connection, string model, Call.Options? options = null)
```

### Remaining Work:

- ⏳ **Phase 0 (1.2.7)**: Verify all Chat creation points properly set `options` from config (see [1.2.7](./1.2.7-move-signals-to-chat.md))
  - `Client.chat()` has a TODO comment for options check

## ⚠️ CRITICAL: Incremental Implementation Required

**IMPORTANT**: This refactoring must be done incrementally to keep the code usable after each step. See [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md) for the overall approach.

**Key Principle**: Migrate call sites incrementally (one file at a time), ensuring code remains usable after each migration.

## Goal

Ensure all Chat creation points:
1. ✅ Pass `Connection` instead of `Client` (using regular `Chat(Connection, ...)` constructor)
2. Do not use null; only set properties (`model`, `options`, `stream`, `think`, `keep_alive`, etc.) if they do not match the defaults or are explicitly needed to be set
3. ✅ Add tools to Chat directly (not Client)
4. Use Config2 or defaults as needed

## Implementation Strategy

This plan implements **Phase 2, Step 2.2-N** of the incremental strategy: migrating all Chat creation points one by one.

**Prerequisites**:
- ✅ Phase 1.1 complete: Chat supports real properties
- ✅ Phase 1.2 complete: Call.Base supports Connection (regular constructor takes Connection)

## Implementation Steps

### Phase 1: Prepare Helper Functions (Optional)

#### Step 1.1: Create Helper Functions

**Note**: Helper functions are generally not needed:
- **Model**: Session has a `model` property - use `session.model` directly if session is available
- **Options**: `config.model_options.get(model)` returns `Call.Options?` - use directly or with null coalescing: `config.model_options.get(model) ?? new Call.Options()`

If helper functions are needed for specific cases, they should be minimal and only created where the pattern is repeated multiple times.

**Result**: Use direct property access and map lookups instead of helper functions

### Phase 2: Migrate Call Sites Incrementally

Migrate each Chat creation point **one at a time**, test after each migration.

#### Step 2.1: Migrate Client.chat() (Simplest, Isolated)

**File**: `libollmchat/Client.vala`

**Current** (line ~189):
```vala
var call = new Call.Chat(this.connection, model) {
    cancellable = cancellable,
    stream = true,  // Default to non-streaming for legacy method
    think = true
};
```

**Status**: ✅ Already migrated to use `this.connection` instead of `this`

**Note**: TODO comment added in code for options check (see 1.2.7)

**Test**: Verify `Client.chat()` still works

**Result**: One call site migrated, code still works

#### Step 2.2: Migrate Client.embed() and embed_array()

**File**: `libollmchat/Client.vala`

**Current** (line ~384):
```vala
var call = new Call.Embed(this.connection, model, options) {
    cancellable = cancellable,
    input = input,
    dimensions = dimensions,
    truncate = truncate
};
```

**Status**: ✅ Already migrated to use `this.connection` instead of `this`

**Test**: Verify `Client.embed()` and `embed_array()` still work

**Result**: Two more call sites migrated, code still works

#### Step 2.3: Migrate Client.generate()

**File**: `libollmchat/Client.vala`

**Current** (line ~488):
```vala
var call = new Call.Generate(this.connection) {
    cancellable = cancellable,
    prompt = prompt,
    system = system,
    model = model,
    stream = false,
    think = false,
    options = options
};
```

**Status**: ✅ Already migrated to use `this.connection` instead of `this`

**Test**: Verify `Client.generate()` still works

**Result**: Another call site migrated, code still works

#### Step 2.4: Migrate Config2.create_chat() (Already Good Pattern)

**File**: `libollmchat/Settings/Config2.vala`

**Current** (line ~562):
```vala
return new OLLMchat.Call.Chat(client.connection, model_usage_obj.model, model_usage_obj.options) {
    stream = false,  // Default to non-streaming
    think = false
};
```

**Status**: ✅ Already migrated to use `client.connection` instead of `client`

**Note**: This one already provides options explicitly - good pattern!

**Test**: Verify `Config2.create_chat()` still works

**Result**: Another call site migrated, code still works

#### Step 2.5: Migrate Analysis (Already Good Pattern)

**File**: `libocvector/Indexing/Analysis.vala`

**Current** (line ~321):
```vala
var chat = new OLLMchat.Call.Chat(analysis_client.connection, analysis_usage.model, analysis_usage.options) {
    stream = true  // Enable streaming (Phase 2: migrate to real properties)
};
```

**Status**: ✅ Already migrated to use `analysis_client.connection` instead of `analysis_client`

**Note**: This one already provides options explicitly - good pattern!

**Test**: Verify Analysis still works

**Result**: Another call site migrated, code still works

#### Step 2.6: Migrate EmptySession.send_message()

**File**: `libollmchat/History/EmptySession.vala`

**Current**: EmptySession doesn't create Chat directly. It uses `this.chat` which is created in `SessionBase` constructor (line 157):
```vala
this.chat = new Call.Chat(this.client.connection, model) {
    stream = true,  // Default to streaming
    think = false
};
```

**Status**: ✅ Already migrated - Chat is created in SessionBase using `this.client.connection`

**Test**: Verify EmptySession.send_message() still works

**Result**: Another call site migrated, code still works

#### Step 2.7: Migrate SessionPlaceholder

**File**: `libollmchat/History/SessionPlaceholder.vala`

**Current**: SessionPlaceholder doesn't create Chat directly. It uses `this.chat` which is created in `SessionBase` constructor (line 157):
```vala
this.chat = new Call.Chat(this.client.connection, model) {
    stream = true,  // Default to streaming
    think = false
};
```

**Status**: ✅ Already migrated - Chat is created in SessionBase using `this.client.connection`

**Test**: Verify SessionPlaceholder still works

**Result**: Another call site migrated, code still works

#### Step 2.8: Migrate Manager.new_client()

**File**: `libollmchat/History/Manager.vala`

**Current** (line ~293):
```vala
var call = new Call.Chat(client.connection, model) {
    stream = true,  // Default to streaming for new sessions
    think = true,
};
call.options = options;

var session = new Session(this, call);
```

**Status**: ✅ Already migrated to use `client.connection` instead of `client`

**Test**: Verify Manager.new_client() still works

**Result**: Another call site migrated, code still works

#### Step 2.9: Migrate AgentHandler (Most Complex - Has Tools)

**File**: `libollmchat/Prompt/AgentHandler.vala`

**Current** (line ~155):
```vala
// Get model from session (Phase 3: model stored on Session, not Client)
var model = this.session.model;
if (model == "" && this.client.config != null) {
    model = this.client.config.get_default_model();
}

// Create and prepare Chat object with real properties (Phase 3: use defaults, no Client properties)
var call = new OLLMchat.Call.Chat(this.client.connection, model) {
    cancellable = cancellable,
    stream = true,  // Default to streaming
    think = true,    // Default to thinking
    agent = this     // Set agent reference so tools can access session
};

// Configure tools for this chat (Phase 3: tools stored on Manager, accessed via Session)
foreach (var tool in this.session.manager.tools.values) {
    call.add_tool(tool);
}
```

**Status**: ✅ Already migrated to use `this.client.connection` instead of `this.client`

**Note**: Tools are already added to Chat directly (not Client) ✅

**Test**: Verify AgentHandler still works, tools are added correctly

**Result**: Another call site migrated, code still works

#### Step 2.10: Migrate CodeAssistantHandler (Most Complex - Has Tools)

**File**: `liboccoder/Prompt/CodeAssistantHandler.vala`

**Current** (line ~65):
```vala
// Get model from session (Phase 3: model stored on Session, not Client)
var model = this.session.model;
if (model == "" && this.client.config != null) {
    model = this.client.config.get_default_model();
}

// Create and prepare Chat object with real properties (Phase 3: use defaults, no Client properties)
var call = new OLLMchat.Call.Chat(this.client.connection, model) {
    cancellable = cancellable,
    stream = true,  // Default to streaming
    think = true,    // Default to thinking
    agent = this     // Set agent reference so tools can access session
};

// Configure tools for this chat (Phase 3: tools stored on Manager, accessed via Session)
foreach (var tool in this.session.manager.tools.values) {
    call.add_tool(tool);
}
```

**Status**: ✅ Already migrated to use `this.client.connection` instead of `this.client`

**Note**: Same pattern as AgentHandler - tools are already added to Chat directly ✅

**Test**: Verify CodeAssistantHandler still works, tools are added correctly

**Result**: All call sites migrated, code still works

### Phase 3: Cleanup (After All Migrations Complete)

#### Step 3.1: Remove Old Client Constructors

**Status**: ✅ **COMPLETE** - Old Client constructors have already been removed

**Note**: The `Chat(Connection connection, ...)` constructor is now the only constructor. There was no separate `new_connection_refactor` constructor - the regular constructor was updated to take `Connection` directly.

**Result**: Call constructors are simpler, code works correctly

## Files to Modify

### Handlers/Agents
- `libollmchat/Prompt/AgentHandler.vala` - Step 2.9
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Step 2.10

### Client
- `libollmchat/Client.vala` - Steps 2.1, 2.2, 2.3

### History/Session
- `libollmchat/History/Manager.vala` - Step 2.8
- `libollmchat/History/EmptySession.vala` - Step 2.6
- `libollmchat/History/SessionPlaceholder.vala` - Step 2.7

### Settings
- `libollmchat/Settings/Config2.vala` - Step 2.4

### Other
- `libocvector/Indexing/Analysis.vala` - Step 2.5

## Testing Checklist

- [x] Step 2.1: Client.chat() migrated and tested ✅
- [x] Step 2.2: Client.embed() / embed_array() migrated and tested ✅
- [x] Step 2.3: Client.generate() migrated and tested ✅
- [x] Step 2.4: Config2.create_chat() migrated and tested ✅
- [x] Step 2.5: Analysis migrated and tested ✅
- [x] Step 2.6: EmptySession.send_message() migrated and tested ✅
- [x] Step 2.7: SessionPlaceholder migrated and tested ✅
- [x] Step 2.8: Manager.new_client() migrated and tested ✅
- [x] Step 2.9: AgentHandler migrated and tested (with tools) ✅
- [x] Step 2.10: CodeAssistantHandler migrated and tested (with tools) ✅
- [x] All Chat creation points use `Connection` constructor ✅
- [x] All Chat creation points set properties explicitly where needed ✅
- [x] Tools are added to Chat (not Client) ✅
- [x] All Chat instances work correctly ✅
- [ ] Phase 0 (1.2.7): Verify all Chat creation points properly set `options` from config

## Related Plans

- [1.2.1. Remove Configuration from Client](./1.2.1-remove-config-from-client.md)
- [1.2.3. Update Call.Base to Take Connection](./1.2.3-update-call-base-connection.md)
- [1.2.5. Update Callers to Handle State Directly](./1.2.5-update-callers-state.md)
- [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md)
