# 4.1. Code Editor Bugs

## Overview

Bug tracking for code editor integration issues discovered during development and testing.

## Status

ðŸ”´ **ACTIVE** - Multiple bugs identified, investigation in progress

## Bug Checklist

### ðŸ”´ Critical Bugs

#### Placeholder Issues
- [x] **Placeholder on project disappears after files finish loading** (works second time around) - RESOLVED
  - **Root Cause**: Focus loss on project dropdown was calling `on_selection_changed()` which reset the placeholder even when no selection was made
  - **Fix**: Removed focus loss handler that triggered selection changes. Renamed `on_selection_changed()` to `on_selected()` to reflect it's only called on actual user selection (click or Enter). Now placeholder is only updated when user actually selects a project.
  - **Location**: `ProjectDropdown.on_selected()`, `SearchableDropdown` focus handler
  - **Implementation**: Removed focus loss call to `on_selected()`, simplified selection logic

#### Project List Building

**Current Flow:**
1. `load_projects_from_db()` - Loads just project Folder objects (minimal data, no tree structure)
2. `activate_project()` - When project is activated:
   - Currently: Just starts filesystem scan via `read_dir()`
   - After scan completes: `process_folders()` calls `project_files.update_from(project)` at line 172

**What `load_files_from_db()` does:**
- Loads files/folders/aliases from DB into `id_map`
- Builds tree structure via `build_tree_structure()` which populates `folder.children`
- **After completion**: Folder has complete tree structure in `folder.children`

**What `update_from()` does:**
- Takes a Folder (the project)
- Recursively walks `folder.children.items` 
- Adds files to `ProjectFiles` list
- **Can be called after either**: DB load OR filesystem scan (both populate `folder.children`)

- [x] **Load project file tree from DB when project is activated (for fast initial display)** - RESOLVED
  - **Implementation**: In `ProjectManager.activate_project()`, before starting filesystem scan:
    1. Check if `project.children.items.size == 0` (tree not loaded yet)
    2. If not loaded, call `yield project.load_files_from_db()` to build tree from DB
    3. After DB load completes, call `project.project_files.update_from(project)` to populate file list
    4. Then start background filesystem scan via `read_dir()`
    5. When scan completes, `process_folders()` already calls `update_from()` again to refresh
  - **Important**: Only load tree for the active project, NOT all projects (that would be insane)
  - **Result**: File list appears immediately from DB, then refreshes after scan completes
  - **Location**: `ProjectManager.activate_project()` method
  - **Fix**: Added DB tree loading check and `update_from()` call before filesystem scan in `ProjectManager.activate_project()`

- [x] **Never add `is_ignored` files to project list** (git ignore files should not appear) - RESOLVED
  - **Database Schema Change**: Add `is_ignored INTEGER NOT NULL DEFAULT 0` column to `filebase` table in `FileBase.initDB()`
  - **Property**: Add `is_ignored` boolean property to `FileBase` class
  - **Implementation**: 
    1. Set `is_ignored` during file scanning (requires gitg - see scanning-files-gitg task)
    2. In `ProjectFiles.add_file_if_new()` and `update_from_recursive()`, check `file.is_ignored` before adding
    3. If `is_ignored` is true, skip adding the file
  - **Dependency**: Requires git ignore functionality to be implemented first (see scanning-files-gitg task)
  - **Location**: `FileBase.initDB()`, `FileBase` class, `ProjectFiles.add_file_if_new()`, `ProjectFiles.update_from_recursive()`
  - **Note**: Database will be manually trashed (no live deployments yet)
  - **Fix**: Added `is_ignored` property and database column. Added checks in `ProjectFiles.add_file_if_new()` and `update_from_recursive()` to skip ignored files. Note: Setting `is_ignored` during scanning still requires gitg implementation.

- [x] **Exclude non-text files from project list - only show text files** - RESOLVED
  - **Database Schema Change**: Add `is_text INTEGER NOT NULL DEFAULT 0` column to `filebase` table in `FileBase.initDB()`
  - **Property**: Add `is_text` boolean property to `FileBase` class (or `File` class if only files need it)
  - **Implementation**: 
    1. During file scanning in `File.new_from_info()` or `Folder.read_dir_scan()`, detect content type using `GLib.ContentType.guess()` or `file_info.get_content_type()`
    2. Set `is_text = true` if content type starts with `"text/"`, otherwise `is_text = false`
    3. Store `is_text` in database when saving file
    4. In `ProjectFiles.add_file_if_new()`, check `file.is_text` before adding
    5. If `is_text` is false, skip adding the file
  - **Alternative Approach**: Check content type on-the-fly without storing, but storing `is_text` boolean is more efficient
  - **Location**: `FileBase.initDB()`, `FileBase` or `File` class, `Folder.read_dir_scan()`, `ProjectFiles.add_file_if_new()`
  - **Note**: We store `is_text` boolean instead of full mimetype - mimetype not relevant for our use case
  - **Icon Storage**: `icon_name` is currently computed on-the-fly but comment suggests storing it in DB. Consider adding `icon_name TEXT` column to avoid recomputing during file scanning.
  - **Fix**: Added `is_text` property and database column. Implemented content type detection in `File.new_from_info()` using `FileInfo.get_content_type()` with fallback to `GLib.ContentType.guess()`. Added checks in `ProjectFiles.add_file_if_new()` and `update_from_recursive()` to skip non-text files. Updated `copy_db_fields_to()` to preserve `is_text` field.

#### File Scanning
- [x] **Add libgit2-glib-1.0 dependency to support `is_ignored` functionality**
  - **Steps**:
    1. Add `libgit2-glib-1.0` dependency to `liboccoder/meson.build` (in `occoder_deps` and `vala_args`)
    2. Add `is_repo` property to `FileBase` (integer: -1 = not checked, 0 = checked and not a repo, 1 = it is a repo)
    3. Add `is_repo` column to database in `FileBase.initDB()` (INTEGER NOT NULL DEFAULT -1)
    4. Add `repo` property to `Folder` class (nullable `Ggit.Repository?`) to store repository reference
    5. In `Folder.read_dir()` or `Folder.read_dir_scan()`, check if folder is a git repository:
       - If `is_repo == -1` (not checked), use `Ggit.Repository.discover(GLib.File.new_for_path(this.path))` to find repository
       - If repository found, set `is_repo = 1` and store `repo` reference, then open with `Ggit.Repository.open()`
       - If not found, set `is_repo = 0` and `repo = null`
       - If `is_repo == 1` and `repo == null`, use `Ggit.Repository.discover()` to find repository location, then open with `Ggit.Repository.open()`
       - **Check for `.git` folder**: If a `.git` folder exists in the current directory, it might be a different repository (e.g., when following aliases). In this case, use `Ggit.Repository.discover()` on the current folder to check if it's a separate repo root
    6. When scanning child folders in `Folder.read_dir()` (recursive), pass both `is_repo` value and `repo` reference to child folders if they're within the same repository:
       - Check if child path is within `repo.get_workdir()` (if `repo != null`)
       - Check if child folder has its own `.git` directory - if so, it's a different repo and should be discovered separately
       - Pass `is_repo` and `repo` to child folders to avoid re-checking
    7. For each file/folder during scanning, if `repo != null`, use `repo.path_is_ignored(relative_path)` to check if ignored
    8. Set `is_ignored` property (already added in previous task) during file scanning in `Folder.read_dir_scan()` or `File.new_from_info()`
    9. `is_ignored` and `is_repo` are automatically stored in database when file/folder is saved
  - **Dependency**: Requires `is_ignored` property and database column to be added first (see projectlist-exclude-ignored task)
  - **Location**: Build config (`liboccoder/meson.build`), `FileBase.vala` (add `is_repo` property and DB column), `Folder.vala` (repository discovery, scanning, passing repo to children)
  - **Note**: Use `Ggit.Repository.discover()` on the folder to find repository root, then pass `repo` reference to child folders during recursive scanning to avoid re-checking

#### File List UI Issues
- [ ] **Fix wrong icons in file list** (currently using folder icon for most files)
  - **Investigation**: In `FileDropdown.create_factory()`, the `file_icon` is bound to `project_file.icon_name` property
  - **Check**: Verify `File.icon_name` property implementation - should return proper icon based on content type
  - **Verify**: `FileBase.icon_name` and `File.icon_name` correctly derive icons from `GLib.ContentType.get_generic_icon_name()`
  - **Fix**: Ensure `icon_name` is set during file creation or when content type is detected
  - **Location**: `FileDropdown.create_factory()`, `File.icon_name` property

- [ ] **Fix relative path display in file list** (can't see relative path, need to verify projectfiles bound property)
  - **Investigation**: Check `ProjectFile.display_relpath` property and how it's used in `FileDropdown`
  - **Current**: `FileDropdown` uses `display_with_indicators` for label
  - **Fix**: May need to use `display_relpath` or `display_with_path` instead, or add new property binding
  - **Verify**: `ProjectFile.display_relpath` correctly calculates relative path from project root
  - **Location**: `FileDropdown.create_factory()`, `ProjectFile.display_relpath`

- [ ] **Fix text search on file dropdown not finding anything**
  - **Investigation**: Check `FileDropdown.on_entry_changed()` and `SearchableDropdown` filtering logic
  - **Verify**: `string_filter` is correctly configured with `get_filter_property()` returning `"display_name"`
  - **Check**: `filtered_items` model is properly connected
  - **Test**: Verify `ProjectFile.display_name` property is correctly set and accessible for filtering
  - **Debug**: Add logging to see if filter is being applied
  - **Location**: `FileDropdown.on_entry_changed()`, `SearchableDropdown` filtering

- [ ] **Fix filtered list being empty after clearing text search**
  - **Investigation**: When entry text is cleared, the filter should show all items again
  - **Check**: `SearchableDropdown.on_entry_changed()` - when `search_text` is empty, `string_filter.search` should be set to empty string or filter should be disabled
  - **Verify**: `filtered_items` model updates correctly when filter changes
  - **Fix**: May need to explicitly reset filter or recreate `filtered_items` when search is cleared
  - **Location**: `SearchableDropdown.on_entry_changed()`

- [ ] **When showing file dropdown popup, select active file and scroll to it** (if no file selected, scroll to top)
  - **Implementation**: In `FileDropdown` or `SearchableDropdown`, when popup is shown (`set_popup_visible(true)`):
    - Find the active file in the list using `ProjectFiles.get_active_file()` or by checking `is_active` on items
    - Set `selection.selected` to that item position
    - Use `list.scroll_to()` to scroll to selected item
    - If no active file, set scroll position to 0
  - **Location**: `SearchableDropdown.set_popup_visible()` method

- [ ] **Fix file list not sorted by basename**
  - **Current**: In `FileDropdown.set_item_model()`, the sorter currently sorts by `is_open` first, then by `path`
  - **Fix**: Change to sort by `is_open` first, then by `display_basename` or `Path.get_basename(file.path)`
  - **Update**: `CustomSorter` comparison function to use basename comparison instead of full path comparison
  - **Location**: `FileDropdown.set_item_model()`

- [ ] **Fix mouse wheel scrolling on dropdown popup passing through to background SourceView**
  - **Implementation**: In `SearchableDropdown` popup (`Gtk.Popover`), ensure the popup/list widget handles scroll events and stops propagation
  - **Add**: Event controller or signal handler on popup/list to call `event.stop_propagation()` on scroll events
  - **May Need**: Set `can_focus=true` on list and ensure it grabs focus when popup is shown
  - **Location**: `SearchableDropdown` popup/list widget

-- other criitcal ones
  Just ask is broken at start - as the provider is null - it should be set up? - presumable at the start when we add the providers.?





### ðŸŸ¡ Medium Priority

- [ ] **Window resize broken** (deferred)
  - **Description**: Coding assistant window does not expand correctly when right pane is shown
  - **Location**: `ollmchat/WindowPane.vala`
  - **Status**: User requested to "leave till later"
  - **Note**: Initial attempts with `queue_resize()` and `present()` didn't fully resolve

- [ ] **Arrow position still broken**
  - **Description**: Arrow for pulldown is not positioned correctly (should be inside/on right of entry)
  - **Location**: `liboccoder/SearchableDropdown.vala` `size_allocate()`
  - **Current State**: Transform-based positioning implemented, but visual appearance still incorrect
  - **Investigation Needed**: Check CSS, check if transform is being applied correctly


  ENTER not firing on_selected - for the selected item on the pulldown item (project) - not tested files


### ðŸŸ¢ Low Priority / Resolved

- [x] **Project pulldown showing no data** - RESOLVED
  - Fixed by using property binding with `path_basename` and `path`
  - Removed manual `display_name` and `tooltip` setting

- [ ] **Search files visible without project** - PARTIALLY RESOLVED
  - `file_dropdown.visible` now toggles based on project selection
  - Still needs verification

- [ ] **Arrow position still broken** - IN PROGRESS
  - **Description**: Pulldown arrow icons are still positioned to the right of the text entry, not overlaid on top
  - **Location**: `liboccoder/SearchableDropdown.vala`
  - **Current State**: 
    - Entry gets full width, arrow overlays using transform
    - Entry has `margin_end` set to make room for arrow
    - CSS file created (`resources/pulldown.css`) with styling rules
    - CSS loaded in `SearchableDropdown` constructor
    - Entry has `suggestion` CSS class added
  - **Investigation Needed**:
    - Verify CSS is being applied correctly
    - Check if arrow positioning needs CSS adjustments
    - May need to adjust transform or use different overlay approach

- [x] **SourceView visible before file opened** - RESOLVED
  - `scrolled_window.visible = false` initially, set to `true` in `open_file()`

- [x] **Save icon looks like download** - RESOLVED
  - Changed to `"media-floppy"` icon

- [x] **Save button not disabled when no file** - RESOLVED
  - `save_button.sensitive = false` initially, set to `true` in `open_file()`

## Debug Logging

Debug logs are written to: `~/.cache/ollmchat/ollmchat.debug.log`

### Current Debug Points

1. **SearchableDropdown**:
   - `set_popup_visible()`: Logs visibility changes
   - `on_entry_changed()`: Logs search text and filtered item count
   - `popup.notify["visible"]`: Logs when popup visibility property changes
   - `list.activate`: Logs when list item is activated

2. **FileBase.saveToDB()**:
   - Logs path, id, new_values presence, sync status
   - Logs insert vs update operations
   - **TODO**: Add stack trace logging

3. **ProjectManager.load_projects_from_db()**:
   - Logs project count found
   - Logs each project path and path_basename when added

## Next Steps

1. Add stack trace logging to `saveToDB()` to identify excessive callers
2. Add focus event logging to `SearchableDropdown` to track popup hiding
3. Add selection change logging to track auto-select behavior
4. Review all `saveToDB()` call sites to identify unnecessary saves
5. Test popup behavior with different focus management strategies
