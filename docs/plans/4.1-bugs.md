# 4.1. Code Editor Bugs

## Overview

Bug tracking for code editor integration issues discovered during development and testing.

## Status

ðŸ”´ **ACTIVE** - Multiple bugs identified, investigation in progress

## Bug Checklist

### ðŸ”´ Critical Bugs

- [ ] **Project dropdown auto-selects on open**
  - **Description**: Project list populates correctly, but automatically selects an item whenever the dropdown appears
  - **Location**: `liboccoder/SearchableDropdown.vala`, `liboccoder/ProjectDropdown.vala`
  - **Current State**: 
    - `autoselect = false` is set in both constructor (line 124) and `set_item_store()` (line 50)
    - `this.selection.selected = Gtk.INVALID_LIST_POSITION;` is set when showing popup (line 346)
    - Still auto-selects despite these settings
  - **Investigation Needed**: 
    - Check if `SingleSelection` is being reset elsewhere
    - Check if `on_selection_changed()` is being triggered unexpectedly
    - Check if property bindings or model updates are causing selection changes
    - Add debug logging to track when/why selection changes

- [ ] **Popup disappears immediately on mouse move or selection**
  - **Description**: Popup hides as soon as mouse moves over it or when something is selected
  - **Location**: `liboccoder/SearchableDropdown.vala`
  - **Current State**:
    - `autohide = false` is set (line 138)
    - `can_focus = true` is set (line 141)
    - `popup.present()` calls were removed
    - Debug logging shows popup visibility changes but doesn't explain why
  - **Investigation Needed**:
    - Check if focus changes are causing popup to hide
    - Check if entry focus loss triggers popdown
    - Check if mouse events are causing focus changes
    - Check if `popup()` vs `present()` behavior differs
    - Add debug logging for focus events and mouse events
    - Check if parent widget focus changes affect popup

- [ ] **Excessive saveToDB calls**
  - **Description**: Database save operations (`saveToDB`) are being called excessively, but debug logging isn't showing why
  - **Location**: `liboccoder/Files/FileBase.vala`, various callers
  - **Current State**:
    - Debug logging added to `FileBase.saveToDB()` (line 326-339)
    - Logs show path, id, new_values, sync status
    - But not showing call stack or what triggers the saves
  - **Investigation Needed**:
    - Add stack trace logging to `saveToDB()` to see callers
    - Check all call sites:
      - `Folder.vala`: lines 236, 258, 270, 278
      - `File.vala`: lines 250, 320, 376
      - `ProjectManager.vala`: lines 93, 103, 123, 134, 158, 172
      - `ProjectMigrate.vala`: line 285
    - Check if property change notifications are triggering saves
    - Check if bindings or model updates are causing saves
    - Check if cursor position changes are triggering saves
    - Consider batching saves or using `sync=false` more aggressively

### ðŸŸ¡ Medium Priority

- [ ] **Window resize broken** (deferred)
  - **Description**: Coding assistant window does not expand correctly when right pane is shown
  - **Location**: `ollmchat/WindowPane.vala`
  - **Status**: User requested to "leave till later"
  - **Note**: Initial attempts with `queue_resize()` and `present()` didn't fully resolve

- [ ] **Arrow position still broken**
  - **Description**: Arrow for pulldown is not positioned correctly (should be inside/on right of entry)
  - **Location**: `liboccoder/SearchableDropdown.vala` `size_allocate()`
  - **Current State**: Transform-based positioning implemented, but visual appearance still incorrect
  - **Investigation Needed**: Check CSS, check if transform is being applied correctly

### ðŸŸ¢ Low Priority / Resolved

- [x] **Project pulldown showing no data** - RESOLVED
  - Fixed by using property binding with `path_basename` and `path`
  - Removed manual `display_name` and `tooltip` setting

- [ ] **Search files visible without project** - PARTIALLY RESOLVED
  - `file_dropdown.visible` now toggles based on project selection
  - Still needs verification

- [ ] **Arrow position still broken** - IN PROGRESS
  - **Description**: Pulldown arrow icons are still positioned to the right of the text entry, not overlaid on top
  - **Location**: `liboccoder/SearchableDropdown.vala`
  - **Current State**: 
    - Entry gets full width, arrow overlays using transform
    - Entry has `margin_end` set to make room for arrow
    - CSS file created (`resources/pulldown.css`) with styling rules
    - CSS loaded in `SearchableDropdown` constructor
    - Entry has `suggestion` CSS class added
  - **Investigation Needed**:
    - Verify CSS is being applied correctly
    - Check if arrow positioning needs CSS adjustments
    - May need to adjust transform or use different overlay approach

- [x] **SourceView visible before file opened** - RESOLVED
  - `scrolled_window.visible = false` initially, set to `true` in `open_file()`

- [x] **Save icon looks like download** - RESOLVED
  - Changed to `"media-floppy"` icon

- [x] **Save button not disabled when no file** - RESOLVED
  - `save_button.sensitive = false` initially, set to `true` in `open_file()`

## Debug Logging

Debug logs are written to: `~/.cache/ollmchat/ollmchat.debug.log`

### Current Debug Points

1. **SearchableDropdown**:
   - `set_popup_visible()`: Logs visibility changes
   - `on_entry_changed()`: Logs search text and filtered item count
   - `popup.notify["visible"]`: Logs when popup visibility property changes
   - `list.activate`: Logs when list item is activated

2. **FileBase.saveToDB()**:
   - Logs path, id, new_values presence, sync status
   - Logs insert vs update operations
   - **TODO**: Add stack trace logging

3. **ProjectManager.load_projects_from_db()**:
   - Logs project count found
   - Logs each project path and path_basename when added

## Next Steps

1. Add stack trace logging to `saveToDB()` to identify excessive callers
2. Add focus event logging to `SearchableDropdown` to track popup hiding
3. Add selection change logging to track auto-select behavior
4. Review all `saveToDB()` call sites to identify unnecessary saves
5. Test popup behavior with different focus management strategies
