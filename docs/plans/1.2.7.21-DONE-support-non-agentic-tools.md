# 1.2.7.21. Support Non-Agentic Tools

## Overview

Create an interface for tools to work without an agent handler. Currently, all tools assume `request.agent` is always set and access `agent.chat_call`, `agent.session.manager.permission_provider`, etc. For non-agentic usage (external code using Chat directly), tools need an alternative way to access these resources.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md)

## Status

✅ **DONE** - Interface for non-agentic tool support created and implemented.

## Goal

Create an Agent interface that provides the resources tools need (chat(), get_permission_provider(), config(), add_message()) without requiring a session. Tools can interact with the Agent interface rather than the Base class directly. Document how to create a dummy agent implementation for non-agentic usage (without session) if needed.

## Current State

- `RequestBase.agent` is `Agent.Base?` (nullable)
- Tools access resources via `agent.chat_call` (property), `agent.session.manager.permission_provider`
- Tools call `agent.session.add_message()` for UI messages
- For non-agentic usage, `chat_call.agent` is null, so `request.agent` would be null
- Tools would fail when trying to access `this.agent.chat_call` or `this.agent.session`
- Base agent class requires a session (for model_usage, tools, event relaying, message history)

## TODO Summary

- [x] **Step 1**: Create `Agent.Interface` with `chat()`, `get_permission_provider()`, `config()`, and `add_message()`
- [x] **Step 2**: Rename `chat` property to `chat_call` in Base, update all internal references (Base + liboccoder/Agent), implement Agent.Interface, update Session classes to use `agent.chat()` (reads) and `agent.chat_call =` (writes)
- [x] **Step 3**: Update `RequestBase.agent` type to `Agent.Interface?`
- [x] **Step 4**: Update all tools to use `agent.chat()`, `agent.get_permission_provider()`, `agent.config()`, and `agent.add_message()` instead of accessing session directly
- [x] **Step 5**: Add documentation to BaseTool about creating dummy agent for non-agentic usage

## Implementation Steps

### Step 1: Create Agent Interface

**Goal**: Create an Agent interface that provides the resources tools need.

**Changes**:
1. Add to `libollmchat/Agent/Interface.vala` (new file):
   ```vala
   namespace OLLMchat.Agent
   {
       /**
        * Interface for agent implementations.
        * 
        * Provides the resources tools need: chat(), get_permission_provider(), config(), and add_message().
        * This allows tools to interact with the interface rather than the Base class directly.
        * 
        * Base implements this interface for agentic usage (with session).
        * A dummy agent can implement this interface for non-agentic usage (without session).
        * 
        * @since 1.2.7.21
        */
       public interface Interface : Object
       {
           /**
            * Get the chat instance for this agent.
            * Tools use this to create Message objects and access chat properties/methods.
            * 
            * @return The chat instance
            */
           public abstract Call.Chat chat();
           
           /**
            * Get the permission provider for tool execution.
            * Tools use this to request permissions for file access, command execution, etc.
            * 
            * @return The permission provider instance
            */
           public abstract ChatPermission.Provider get_permission_provider();
           
           /**
            * Get the configuration instance for tool execution.
            * Tools use this to access tool-specific configuration (e.g., API keys).
            * 
            * For agentic usage: Returns config from session.manager.config.
            * For non-agentic usage: Dummy agent must provide a config instance.
            * 
            * @return The config instance
            */
           public abstract Settings.Config2 config();
           
           /**
            * Add a UI message to the conversation.
            * 
            * For agentic usage: Adds message to session.
            * For non-agentic usage: Adds message to chat.messages or emits signal.
            * 
            * @param message The message to add
            */
           public abstract void add_message(Message message);
       }
   }
   ```

**Result**: Agent.Interface defined with the four members tools need: chat(), get_permission_provider(), config(), and add_message().

### Step 2: Rename chat Property to chat_call and Implement Agent Interface

**Goal**: Rename the `chat` property to `chat_call` in Base, and implement Agent.Interface.

**Changes**:
1. Update `libollmchat/Agent/Base.vala`:
   - Rename property: `public Call.Chat chat;` → `public Call.Chat chat_call;`
   - Update constructor: `this.chat = new ...` → `this.chat_call = new ...`
   - Update all internal references to `this.chat` → `this.chat_call` (classes extending Base use property directly, not method):
     - Line 106: `this.chat = new ...` → `this.chat_call = new ...`
     - Line 117: `this.chat.add_tool()` → `this.chat_call.add_tool()`
     - Line 120: `this.factory.configure_tools(this.chat)` → `this.chat_call`
     - Line 187: `this.chat.tools.has_key()` → `this.chat_call.tools.has_key()`
     - Line 189: `this.chat.tools.size` → `this.chat_call.tools.size`
     - Line 190: `this.chat.tools.keys` → `this.chat_call.tools.keys`
     - Line 196: `new Message(this.chat, ...)` → `new Message(this.chat_call, ...)`
     - Line 198: `new Message.tool_call_invalid(this.chat, ...)` → `this.chat_call`
     - Line 202: `this.chat.tools.get()` → `this.chat_call.tools.get()`
     - Line 205: `new Message(this.chat, ...)` → `new Message(this.chat_call, ...)`
     - Line 210: `tool.execute(this.chat, ...)` → `this.chat_call`
     - Line 219: `new Message(this.chat, ...)` → `new Message(this.chat_call, ...)`
     - Line 228: `new Message.tool_reply(this.chat, ...)` → `this.chat_call`
     - Line 238: `new Message(this.chat, ...)` → `new Message(this.chat_call, ...)`
     - Line 240: `new Message.tool_call_fail(this.chat, ...)` → `this.chat_call`
     - Line 259: `this.chat.tools =` → `this.chat_call.tools =`
     - Line 262: `this.factory.configure_tools(this.chat)` → `this.chat_call`
     - Line 298: `this.chat.cancellable` → `this.chat_call.cancellable`
     - Line 301: `this.chat.send()` → `this.chat_call.send()`
   - Implement Agent.Interface:
   ```vala
   public class Base : Object, Interface
   {
       // ... existing code ...
       public Call.Chat chat_call;  // Renamed from 'chat'
       
       // Constructor updates:
       public Base(Factory factory, History.SessionBase session)
       {
           // ... existing code ...
           this.chat_call = new OLLMchat.Call.Chat(this.connection, model) {
               // ... existing code ...
           };
           foreach (var tool in this.session.manager.tools.values) {
               this.chat_call.add_tool(tool);
           }
           this.factory.configure_tools(this.chat_call);
       }
       
       // Implement Agent.Interface
       public Call.Chat chat()
       {
           return this.chat_call;
       }
       
       public ChatPermission.Provider get_permission_provider()
       {
           return this.session.manager.permission_provider;
       }
       
       public void add_message(Message message)
       {
           this.session.add_message(message);
       }
   }
   ```

2. Update `libollmchat/History/SessionBase.vala` (reads - use interface method):
   - Change all `this.agent.chat` → `this.agent.chat()`:
     - Line 188: `if (this.agent != null && this.agent.chat != null)` → `if (this.agent != null && this.agent.chat() != null)`
     - Line 190: `this.agent.chat.model` → `this.agent.chat().model`
     - Line 194: `this.agent.chat.connection` → `this.agent.chat().connection`
     - Line 198: `this.agent.chat.options` → `this.agent.chat().options`

3. Update `libollmchat/History/Session.vala` (reads - use interface method):
   - Change all `this.agent.chat` → `this.agent.chat()`:
     - Line 106: `if (this.agent != null && this.agent.chat != null)` → `if (this.agent != null && this.agent.chat() != null)`
     - Line 107: `var current_chat = this.agent.chat;` → `var current_chat = this.agent.chat();`
     - Line 177: `new Message(this.agent.chat, ...)` → `new Message(this.agent.chat(), ...)`
     - Line 204: `new Message(this.agent.chat, ...)` → `new Message(this.agent.chat(), ...)`
     - Line 228: `response.message.message_interface = this.agent.chat;` → `this.agent.chat()`
     - Line 234: `new Message(this.agent.chat, ...)` → `new Message(this.agent.chat(), ...)`
     - Line 244: `new Message(this.agent.chat, ...)` → `new Message(this.agent.chat(), ...)`
     - Line 472: `this.agent.chat.cancellable` → `this.agent.chat().cancellable`
     - Line 558: `this.agent.chat.model` → `this.agent.chat().model`
     - Line 562: `this.agent.chat.connection` → `this.agent.chat().connection`
     - Line 565: `this.agent.chat.options` → `this.agent.chat().options`

4. Update `libollmchat/History/Session.vala` (writes):
   - Line 533: `agent.chat = old_agent.chat;` → `agent.chat_call = old_agent.chat();` (write to property, read via method)
   - Line 535: `agent.chat.agent = agent;` → `agent.chat_call.agent = agent;` (after assignment, use property)

5. Update `libollmchat/History/EmptySession.vala` (write):
   - Line 121: `agent.chat = this.agent.chat;` → `agent.chat_call = this.agent.chat();` (write to property, read via method)

6. Update `liboccoder/Agent.vala` (subclass of Base - use property internally):
   - Line 64: Change `new OLLMchat.Message(this.chat, ...)` → `new OLLMchat.Message(this.chat_call, ...)`
   - Line 86: Change `this.chat.cancellable` → `this.chat_call.cancellable`
   - Line 89: Change `this.chat.send()` → `this.chat_call.send()`

**Result**: Base property renamed to `chat_call` and implements Agent.Interface. All internal references in Base and subclasses updated to use `chat_call` property. External access uses `chat()` method.

### Step 3: Update RequestBase to Use Agent Interface

**Goal**: RequestBase uses Agent.Interface instead of Base class directly.

**Changes**:
1. Update `libollmchat/Tool/RequestBase.vala`:
   ```vala
   /**
    * Reference to the agent for this tool request.
    * 
    * For agentic usage: This is the Base agent (implements Agent.Interface).
    * For non-agentic usage: This is a dummy agent implementation (implements Agent.Interface).
    * 
    * Tools access resources via this.agent.chat(), this.agent.get_permission_provider(), this.agent.config(), this.agent.add_message().
    */
   public Agent.Interface? agent { get; set; }
   ```

**Result**: RequestBase uses Agent.Interface type. Tool updates are in Step 4.

### Step 4: Update Tools to Use Agent Interface Methods

**Goal**: Update tools to use interface methods instead of accessing session directly. Change all reads of `agent.chat` to `agent.chat()`.

**Changes**:

#### A. Update Tools - Read `agent.chat` → `agent.chat()`

1. **`libollmchat/Tool/RequestBase.vala`**:
   - Line 43: Update comment `agent.chat` → `agent.chat()`
   - Line 138: Change `this.agent.chat` → `this.agent.chat()` (in Message constructor)
   - `normalize_file_path()`: Change `this.agent.session.manager.permission_provider` → `this.agent.get_permission_provider()`
   - `send_ui()`: Change `this.agent.session.add_message()` → `this.agent.add_message()`
   - `execute()`: Change `this.agent.session.manager.permission_provider` → `this.agent.get_permission_provider()`

2. **`libollmchat/Tools/RequestRunCommand.vala`**:
   - Line 215: Change `this.agent.chat` → `this.agent.chat()` (in Message constructor)
   - Line 322: Change `this.agent.chat` → `this.agent.chat()` (in Message constructor)
   - Change `agent.session.add_message()` → `agent.add_message()`
   - Change `agent.session.manager.permission_provider` → `agent.get_permission_provider()`

3. **`libollmchat/Tools/RequestReadFile.vala`**:
   - Line 119: Change `this.agent.chat` → `this.agent.chat()` (in Message constructor)
   - Change `agent.session.add_message()` → `agent.add_message()`

4. **`libollmchat/Tools/RequestWebFetch.vala`**:
   - Line 81: Change `this.agent.chat` → `this.agent.chat()` (in Message constructor)
   - Line 123: Change `this.agent.chat` → `this.agent.chat()` (in Message constructor)
   - Change `agent.session.add_message()` → `agent.add_message()`

5. **`libollmchat/Tools/RequestEditMode.vala`**:
   - Line 334: Change `this.agent.chat.stream` → `this.agent.chat().stream`
   - Line 414: Change `this.agent.chat.reply.begin()` → `this.agent.chat().reply.begin()`
   - Line 397: Update comment `agent.chat.reply()` → `agent.chat().reply()`
   - Change `agent.session.manager.permission_provider` → `agent.get_permission_provider()`

#### B. Update Session Classes - Read `agent.chat` → `agent.chat()`

6. **`libollmchat/History/SessionBase.vala`**:
   - Line 188: Change `this.agent.chat != null` → `this.agent.chat() != null` (null check)
   - Line 190: Change `this.agent.chat.model` → `this.agent.chat().model`
   - Line 194: Change `this.agent.chat.connection` → `this.agent.chat().connection`
   - Line 198: Change `this.agent.chat.options` → `this.agent.chat().options`

7. **`libollmchat/History/Session.vala`** (reads):
   - Line 106: Change `this.agent.chat != null` → `this.agent.chat() != null` (null check)
   - Line 107: Change `var current_chat = this.agent.chat;` → `var current_chat = this.agent.chat();`
   - Line 177: Change `new Message(this.agent.chat, ...)` → `new Message(this.agent.chat(), ...)`
   - Line 204: Change `new Message(this.agent.chat, ...)` → `new Message(this.agent.chat(), ...)`
   - Line 228: Change `response.message.message_interface = this.agent.chat;` → `this.agent.chat()`
   - Line 234: Change `new Message(this.agent.chat, ...)` → `new Message(this.agent.chat(), ...)`
   - Line 244: Change `new Message(this.agent.chat, ...)` → `new Message(this.agent.chat(), ...)`
   - Line 472: Change `this.agent.chat.cancellable` → `this.agent.chat().cancellable`
   - Line 558: Change `this.agent.chat.model` → `this.agent.chat().model`
   - Line 562: Change `this.agent.chat.connection` → `this.agent.chat().connection`
   - Line 565: Change `this.agent.chat.options` → `this.agent.chat().options`

#### C. Update Session Classes - Write `agent.chat =` → `agent.chat_call =`

8. **`libollmchat/History/Session.vala`** (writes):
   - Line 533: Change `agent.chat = old_agent.chat;` → `agent.chat_call = old_agent.chat();` (write to property, read via method)
   - Line 535: Change `agent.chat.agent = agent;` → `agent.chat_call.agent = agent;` (after assignment, use property)

9. **`libollmchat/History/EmptySession.vala`** (write):
   - Line 121: Change `agent.chat = this.agent.chat;` → `agent.chat_call = this.agent.chat();` (write to property, read via method)

**Result**: All reads of `agent.chat` changed to `agent.chat()`, all writes changed to `agent.chat_call =`. Tools use Agent interface methods instead of accessing session directly.

### Step 5: Document Dummy Agent for Non-Agentic Usage

**Goal**: Document how to create a dummy agent implementation for non-agentic tool usage.

**Changes**:
1. Add documentation to `libollmchat/Tool/Tool.vala` (BaseTool class):
   ```vala
   /**
    * Base class for tools.
    * 
    * Tools require an Agent.Interface instance to access chat, permission_provider,
    * and add_message(). For agentic usage (with session), use Agent.Base.
    * 
    * For non-agentic usage (without session), you can create a simple dummy agent
    * that implements Agent.Interface with chat(), get_permission_provider(), config(),
    * and add_message() methods. The dummy agent should store the chat_call, permission_provider,
    * and config instances, and implement add_message() to add messages to chat.messages
    * or emit signals for UI updates.
    */
   ```

**Result**: Documentation added for creating dummy agent for non-agentic tool usage.

## Files to Modify

- `libollmchat/Agent/Interface.vala` - Create new Agent.Interface file
- `libollmchat/Agent/Base.vala` - Rename `chat` property to `chat_call`, update constructor and all internal references (use property, not method), implement Agent.Interface (add chat(), get_permission_provider(), config(), add_message())
- `liboccoder/Agent.vala` - Update all `this.chat` → `this.chat_call` (subclass uses property internally)
- `libollmchat/History/SessionBase.vala` - Update all `agent.chat` → `agent.chat()` (external access via interface)
- `libollmchat/History/Session.vala` - Update all `agent.chat` → `agent.chat()` (reads) and `agent.chat =` → `agent.chat_call =` (writes)
- `libollmchat/History/EmptySession.vala` - Update `agent.chat =` → `agent.chat_call =` (write)
- `libollmchat/Tool/Tool.vala` - Add documentation for creating dummy agent for non-agentic usage
- `libollmchat/Tool/RequestBase.vala` - Change agent type to `Agent.Agent?`, update to use interface methods
- `libollmchat/Tool/Tool.vala` - Add documentation for dummy agent usage
- `libollmchat/Tool/RequestBase.vala` - Update to use `agent.chat()`, `agent.get_permission_provider()`, `agent.add_message()`
- `libollmchat/Tools/RequestEditMode.vala` - Update to use `agent.chat()`, `agent.get_permission_provider()`
- `libollmchat/Tools/RequestRunCommand.vala` - Update to use `agent.chat()`, `agent.add_message()`, `agent.get_permission_provider()`
- `libollmchat/Tools/RequestReadFile.vala` - Update to use `agent.chat()`, `agent.add_message()`
- `libollmchat/Tools/RequestWebFetch.vala` - Update to use `agent.chat()`, `agent.add_message()`

## Testing Checklist

- [ ] Agent.Interface is defined with chat(), get_permission_provider(), config(), and add_message()
- [ ] Base property `chat` renamed to `chat_call`
- [ ] Base constructor and all internal references updated to use `chat_call` property (not method)
- [ ] liboccoder/Agent.vala updated to use `this.chat_call` property (subclass uses property internally)
- [ ] SessionBase.vala updated to use `agent.chat()` (external access via interface)
- [ ] Session.vala updated to use `agent.chat()` (reads) and `agent.chat_call =` (writes)
- [ ] EmptySession.vala updated to use `agent.chat_call =` (write)
- [ ] Base implements Agent.Interface
- [ ] RequestBase.agent uses Agent.Interface type
- [ ] All tool files updated: `agent.chat` → `agent.chat()` (reads)
- [ ] All Session files updated: `agent.chat` → `agent.chat()` (reads) and `agent.chat =` → `agent.chat_call =` (writes)
- [ ] Tools use `agent.chat()`, `agent.get_permission_provider()`, `agent.config()`, and `agent.add_message()` via interface
- [ ] BaseTool documentation includes example dummy agent implementation
- [ ] Agentic tools still work with Base agent

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md) - Parent plan
- [1.2.7.10. Move Tool Execution to Agent](./1.2.7.10-move-tool-execution-to-agent.md) - Related (agent handles tool execution)

