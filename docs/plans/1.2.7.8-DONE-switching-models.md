# 1.2.7.8. Switching Models

## Overview

Various cleanup items identified during the signal migration process that need to be addressed.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md)

## Status

✅ **DONE** - All cleanup items completed.

## Goal

Address various cleanup items and technical debt identified during the signal migration process.

## Cleanup Items

### Model and Options Setting Location

**Issue**: Currently in `AgentHandler.send_async()`, model and options are being updated on the Chat instance just before sending the message. This is too late in the flow.

**Decision**: **Option D - Combination approach**:
- **When session converts to real session**: Set model/connection/options when Chat is created in AgentHandler constructor (Option A - already implemented)
  - `EmptySession.send()` → creates `Session` → `Session.send()` → `ensure_agent_handler()` → creates `AgentHandler` → constructor creates `Chat` with model/options from `session.model_usage`
  - This is the correct initial setup point
- **When UI updates model**: Update Chat's model/connection/options when `session.activate_model()` is called (Option B)
  - `ChatInput` calls `session.activate_model(model_usage)` which updates `session.model_usage`
  - `Session.activate_model()` should directly update `agent.chat.model`, `agent.chat.connection`, and set `agent.chat.options = model_usage.options` (no cloning - Chat is just a user of the options)
  - No need for agent method - just update Chat properties directly (agent.chat is public)
- **When config changes**: Update Chat's model/options when config.model_options changes
  - Session should listen to `config.changed()` signal
  - When config changes, directly update `agent.chat.model` and set `agent.chat.options = model_usage.options` (no cloning)
  - Chat doesn't own the options, it just references them, so no need to clone

**Current State**: 
- ✅ Model and options update code removed from `AgentHandler.send_async()` (FIXME comment removed)
- ✅ Chat is created in constructor with initial values from `session.model_usage` (correct)
- ✅ Chat is updated when `session.activate_model()` is called (implemented)
- ✅ Chat is updated when config changes (implemented)

**Action**: ✅ **DONE** - Implemented proper model/options update flow:
1. ✅ In `SessionBase.activate_model()`, directly update Chat properties:
   - Set `agent.chat.model = model_usage.model`
   - Set `agent.chat.connection` from `model_usage.connection` (get Connection object from manager.config.connections)
     - Connection property is now public, so can be set directly
   - Set `agent.chat.options = model_usage.options` (no cloning - Chat just references the Options object)
2. ✅ Added config change handler to Session that listens to `config.changed()` signal and directly updates Chat:
   - Set `agent.chat.model = model_usage.model`
   - Set `agent.chat.options = model_usage.options` (no cloning)
   - When config changes, `model_usage.options` may have been updated (if it references config.model_options)

**Status**: ✅ **DONE** - All changes implemented.

**Files Modified**:
- ✅ `libollmchat/Prompt/AgentHandler.vala` - Removed FIXME from `send_async()`, updated constructor to not clone options (set `chat.options = mu.options` directly)
- ✅ `libollmchat/History/SessionBase.vala` - Updated `activate_model()` to directly set `agent.chat.model`, `agent.chat.connection`, and `agent.chat.options = model_usage.options`
- ✅ `libollmchat/History/Session.vala` - Added config change handler that listens to `config.changed()` signal and directly updates `agent.chat.model`, `agent.chat.connection`, and `agent.chat.options`
- ✅ `libollmchat/OllamaBase.vala` - Made `connection` property public (changed from `protected set` to `set`) to allow direct assignment

### Agent Activation Chat Copying

**Issue**: When activating a new agent, a new AgentHandler is created which creates a new Chat instance. The previous agent's Chat instance (with its configuration, model, options, etc.) was being discarded.

**Decision**: Copy the Chat instance from the previous agent to the new agent when activating an agent, preserving all Chat state (model, options, stream settings, etc.).

**Implementation**: 
- In `Session.activate_agent()`, after creating the new AgentHandler:
  - If there was a previous agent handler, copy its Chat instance to the new handler
  - Set the Chat's `agent` property to point to the new handler
  - This preserves all Chat configuration while ensuring the Chat references the correct agent handler

**Status**: ✅ **DONE** - Implemented in `libollmchat/History/Session.vala` `activate_agent()` method.

**Files Modified**:
- `libollmchat/History/Session.vala` - Updated `activate_agent()` to copy Chat from old agent to new agent and connect agent property

## Testing Checklist

- [ ] Model and options are set correctly for Chat instances
- [ ] Model updates in UI propagate correctly to Chat instances
- [ ] Config changes update Chat model and options correctly
- [ ] All functionality still works correctly after cleanup

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md) - Parent plan
- [1.2.7.7. Remove Client from Session](./1.2.7.7-DONE-remove-client-from-session.md) - Previous phase
- [1.2. Refactor Client and Chat Relationship](./1.2-DONE-refactor-client-chat-relationship.md) - Grandparent plan

