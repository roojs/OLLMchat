# Chat History System Plan

This document outlines the plan for implementing a comprehensive chat history system for OLLMchat, including persistent storage, browsing, restoration, and advanced features like chat rewinding and multiple chat sessions.

## Overview

The chat history system will:
- Save all chat conversations to disk in a structured format
- Provide a summary index for quick browsing
- Use LLM to generate meaningful titles for conversations
- Enable browsing and restoring old conversations
- Support advanced features like hidden messages and chat rewinding
- Support multiple concurrent chat sessions
- Transform the test-window into a proper `ollmchat` application with about dialog and polished UI

## Directory Structure

### Storage Locations

```
~/.local/share/ollmchat/
├── history/
│   ├── 2025-01-15-14-30-45.json    # Individual chat session files
│   ├── 2025-01-15-15-22-10.json
│   └── ...
└── history.json                     # Summary index of all chats
```

### File Format

#### Individual Chat File (`{y-m-d-h-i-s}.json`)

Each chat session is saved as a JSON file with the following structure:

```json
{
  "id": "2025-01-15-14-30-45",
  "created_at": "2025-01-15T14:30:45Z",
  "updated_at": "2025-01-15T15:22:10Z",
  "title": "System log analysis and kernel version check",
  "model": "llama3.2:latest",
  "client_config": {
    "url": "http://192.168.88.14:11434/api",
    "api_key": "...",
    "keep_alive": "5m"
  },
  "messages": [
    {
      "role": "user",
      "content": "Please read the first few lines of /var/log/syslog...",
      "thinking": "",
      "timestamp": "2025-01-15T14:30:45Z",
      "hidden": false
    },
    {
      "role": "assistant",
      "content": "I'll read the syslog file for you...",
      "thinking": "",
      "timestamp": "2025-01-15T14:30:52Z",
      "hidden": false,
      "tool_calls": [...]
    }
  ],
  "metadata": {
    "total_messages": 4,
    "total_tokens": 1234,
    "duration_seconds": 45
  }
}
```

**Key Points**:
- `id` is the filename (without extension) - timestamp format `{y-m-d-h-i-s}`
- `title` is generated by LLM from the first user message (or updated if conversation evolves)
- `messages` array contains all messages in the conversation
- `hidden` flag on messages allows storing messages that weren't sent to the server
- `client_config` stores the client configuration at the time of the chat (for restoration)
- `metadata` provides quick stats about the conversation

#### Summary Index File (`history.json`)

A lightweight index for quick browsing:

```json
{
  "version": 1,
  "chats": [
    {
      "id": "2025-01-15-14-30-45",
      "title": "System log analysis and kernel version check",
      "created_at": "2025-01-15T14:30:45Z",
      "updated_at": "2025-01-15T15:22:10Z",
      "model": "llama3.2:latest",
      "message_count": 4,
      "preview": "Please read the first few lines of /var/log/syslog..."
    },
    {
      "id": "2025-01-15-16-10-20",
      "title": "Code refactoring discussion",
      "created_at": "2025-01-15T16:10:20Z",
      "updated_at": "2025-01-15T16:45:30Z",
      "model": "llama3.2:latest",
      "message_count": 12,
      "preview": "How can I refactor this function to be more modular?"
    }
  ]
}
```

**Key Points**:
- `version` field for future format migrations
- `chats` array sorted by `updated_at` (most recent first)
- `preview` is the first 100 characters of the first user message
- `title` is the LLM-generated summary

## Implementation Plan

### Phase 1: Core Storage Infrastructure

#### 1.1 Chat History Manager (`History/Manager.vala`)

**Namespace**: `OLLMchat.History`

**Responsibilities**:
- Manage chat session files in `~/.local/share/ollmchat/history/`
- Maintain the summary index file
- Provide methods to save, load, and list chat sessions
- Handle file I/O and JSON serialization/deserialization

**Key Methods**:
```vala
public class Manager : Object
{
    public string history_dir { get; private set; }
    public string index_file { get; private set; }
    
    // Save a chat session
    public async string save_chat(ChatSession session) throws Error;
    
    // Load a chat session by ID
    public async ChatSession? load_chat(string id) throws Error;
    
    // List all chat sessions (from index)
    public Gee.ArrayList<ChatSummary> list_chats();
    
    // Update the summary index
    private async void update_index() throws Error;
    
    // Generate unique ID from current timestamp
    public static string generate_id();
}
```

**File Location**: `src/OLLMchat/History/Manager.vala`

#### 1.2 Chat Session Data Classes

**ChatSession** (`History/Session.vala`):
```vala
public class Session : Object, Json.Serializable
{
    public string id { get; set; }
    public string created_at { get; set; }
    public string updated_at { get; set; }
    public string title { get; set; default = ""; }
    public string model { get; set; default = ""; }
    public ClientConfig client_config { get; set; }
    public Gee.ArrayList<Message> messages { get; set; }
    public SessionMetadata metadata { get; set; }
}
```

**ChatSummary** (`History/Summary.vala`):
```vala
public class Summary : Object, Json.Serializable
{
    public string id { get; set; }
    public string title { get; set; }
    public string created_at { get; set; }
    public string updated_at { get; set; }
    public string model { get; set; }
    public int message_count { get; set; }
    public string preview { get; set; }
}
```

**ClientConfig** (`History/ClientConfig.vala`):
```vala
public class ClientConfig : Object, Json.Serializable
{
    public string url { get; set; }
    public string? api_key { get; set; }
    public string? keep_alive { get; set; }
    // Store other relevant client settings
}
```

**SessionMetadata** (`History/Metadata.vala`):
```vala
public class Metadata : Object, Json.Serializable
{
    public int total_messages { get; set; }
    public int64 total_tokens { get; set; default = 0; }
    public int64 duration_seconds { get; set; default = 0; }
}
```

#### 1.3 Integration with ChatWidget

**Modifications to `UI/ChatWidget.vala`**:
- Add `History.Manager` instance
- Add `current_session_id` property to track active session
- Auto-save chat after each message exchange
- Load chat state when restoring a session

**Key Changes**:
```vala
private History.Manager? history_manager = null;
private string? current_session_id = null;
private bool is_restored_session = false;

// Save chat after response received
private async void save_chat_to_history();

// Restore chat from history
public async void restore_chat(string session_id) throws Error;
```

### Phase 2: LLM Title Generation

#### 2.1 Title Generator (`History/TitleGenerator.vala`)

**Namespace**: `OLLMchat.History`

**Responsibilities**:
- Generate concise, meaningful titles from chat conversations
- Use the Ollama client to call a lightweight model for title generation
- Cache titles to avoid redundant API calls

**Implementation**:
```vala
public class TitleGenerator : Object
{
    private Ollama.Client client;
    
    public async string generate_title(Gee.ArrayList<Message> messages) throws Error;
    
    // Generate title from first user message (quick)
    public async string generate_title_from_preview(string first_message) throws Error;
}
```

**Title Generation Prompt**:
```
Generate a concise title (maximum 8 words) for this chat conversation based on the first user message:

"{first_message}"

Respond with ONLY the title, no explanation or quotes.
```

**Usage**:
- Generate title asynchronously after first message exchange
- Update title if conversation significantly diverges (optional enhancement)
- Store in both session file and summary index

### Phase 3: UI Features

#### 3.1 History Browser Widget (`UI/HistoryBrowser.vala`)

**Namespace**: `OLLMchat.UI`

**Responsibilities**:
- Display list of past chat sessions
- Show title, preview, date, and model for each session
- Allow filtering and searching
- Enable selection and restoration of chats

**UI Design**:
- Use `Adw.OverlaySplitView` (libadwaita) for side panel
- List view with search entry at top
- Each item shows:
  - Title (bold)
  - Preview text (truncated)
  - Date/time (relative: "2 hours ago", "Yesterday", etc.)
  - Model name (small, secondary text)

**Key Methods**:
```vala
public class HistoryBrowser : Adw.Bin
{
    public signal void chat_selected(string session_id);
    public signal void chat_deleted(string session_id);
    
    public void refresh_list();
    public void set_search_query(string query);
}
```

#### 3.2 History Overlay Integration

**Modifications to Main Window**:
- Add `Adw.OverlaySplitView` as main container
- Left side: History browser (collapsible)
- Right side: Chat widget
- Toggle button to show/hide history panel

**File**: Transform `TestWindow.vala` → `OllmchatWindow.vala` or enhance `TestWindow.vala`

**Structure**:
```vala
public class OllmchatWindow : Adw.ApplicationWindow
{
    private Adw.OverlaySplitView split_view;
    private UI.HistoryBrowser history_browser;
    private UI.ChatWidget chat_widget;
    private Adw.HeaderBar header_bar;
    
    // Toggle history panel
    private void toggle_history();
}
```

#### 3.3 About Dialog

**Add About Dialog** (`UI/AboutDialog.vala`):
```vala
public class AboutDialog : Adw.AboutWindow
{
    public AboutDialog(Gtk.Window parent)
    {
        this.application_icon = "org.roojs.ollmchat";
        this.application_name = "OLLMchat";
        this.version = "1.0.0";
        this.developer_name = "Alan Knowles";
        this.website = "https://github.com/...";
        this.issue_url = "https://github.com/.../issues";
        this.copyright = "© 2025 Alan Knowles";
        this.license_type = Gtk.License.LGPL_3_0;
        this.transient_for = parent;
    }
}
```

**Add to Header Bar**:
- Menu button with "About" option
- Or direct "About" button in header bar

### Phase 4: Advanced Features

#### 4.1 Hidden Messages

**Purpose**: Store messages that are not sent to the server but are part of the conversation context (e.g., draft messages, notes, annotations).

**Implementation**:
- Add `hidden` boolean property to `Message` class (already exists in plan)
- Hidden messages are:
  - Serialized in chat history files
  - Not included in API calls to Ollama
  - Displayed in UI with visual distinction (grayed out, italic, or with icon)
  - Can be toggled to visible/hidden state

**UI Indicator**:
- Show hidden messages with reduced opacity or special styling
- Toggle button to show/hide hidden messages in chat view
- Context menu option to mark message as hidden/visible

**Modifications**:
- `Ollama/Message.vala`: Add `hidden` property
- `UI/ChatView.vala`: Render hidden messages with special styling
- `Ollama/Call/ChatCall.vala`: Filter out hidden messages when building API request

#### 4.2 Chat Rewinding

**Purpose**: Allow users to "rewind" a conversation to a previous point, edit messages, and continue from there (creating a new branch/version).

**Concept**:
- User can select a message in the chat
- Click "Rewind to here" action
- All messages after that point are removed from active conversation
- User can edit the selected message or add new messages
- This creates a new chat session (new ID) that branches from the original

**Implementation**:
```vala
// In ChatWidget
public async void rewind_to_message(int message_index) throws Error;
public async void create_branch_from_session(string session_id, int message_index) throws Error;
```

**UI**:
- Context menu on messages: "Rewind to here"
- Confirmation dialog: "This will remove all messages after this point. Continue?"
- After rewinding, show indicator that this is a branched conversation
- Store reference to parent session in metadata

**Session Metadata Enhancement**:
```json
{
  "parent_session_id": "2025-01-15-14-30-45",
  "branch_point": 3,
  "is_branch": true
}
```

#### 4.3 Multiple Chat Sessions

**Current State**: Application designed for single chat widget.

**Challenges**:
- `clear/reload` operations affect permissions
- Single `ChatWidget` instance
- Client state management

**Proposed Solution**:
- **Option A**: Single chat widget with session switching
  - When restoring/starting new chat, clear current widget and load new session
  - Simpler implementation
  - One chat at a time
  
- **Option B**: Multiple chat widgets with tabs
  - `Adw.TabView` with multiple `ChatWidget` instances
  - Each tab is a separate chat session
  - More complex but allows true multi-chat
  
- **Option C**: Single widget with session management
  - Dropdown/selector to switch between active sessions
  - Only one visible at a time, but can switch quickly
  - Middle ground

**Recommendation**: Start with **Option A** (session switching), then consider **Option C** if needed.

**Implementation for Option A**:
```vala
// In ChatWidget
public async void start_new_chat();
public async void switch_to_chat(string session_id) throws Error;

// Clear current state
private void clear_chat_state();
```

**Permission Handling**:
- Permissions are tied to the client, not the chat session
- When switching sessions, permissions remain (they're application-level)
- If needed, can store permission state per session in metadata

### Phase 5: Application Transformation

#### 5.1 Rename TestWindow to OllmchatWindow

**File**: `TestWindow.vala` → `OllmchatWindow.vala` (or keep name but enhance)

**Changes**:
- Update class name
- Add proper application ID: `org.roojs.ollmchat`
- Add about dialog
- Improve styling and polish
- Set default directory to user's home (already done via `~/.config/ollmchat/`)

#### 5.2 Build Configuration

**Update `meson.build`**:
- Rename `test-window` executable to `ollmchat`
- Update install configuration (optional: install to system)
- Add proper application metadata

**Changes**:
```meson
ollmchat = executable('ollmchat',
  dependencies: test_window_deps,
  sources: ['OllmchatWindow.vala', ollmchat_resources],
  link_with: [ollmchat_base_lib, ollmchat_ui_lib],
  install: true  # Install to system
)
```

#### 5.3 Application Metadata

**Create `.desktop` file** (`data/org.roojs.ollmchat.desktop`):
```ini
[Desktop Entry]
Name=OLLMchat
Comment=Chat with Ollama LLM models
Exec=ollmchat
Icon=org.roojs.ollmchat
Terminal=false
Type=Application
Categories=Network;Chat;
StartupNotify=true
```

**Create app icon** (`data/org.roojs.ollmchat.svg` or `.png`)

#### 5.4 Styling Improvements

**Enhancements**:
- Use libadwaita styling throughout
- Consistent spacing and margins
- Better color scheme
- Smooth animations for history panel
- Professional header bar with menu

**CSS Updates** (`resources/style.css`):
- Add styles for history browser
- Style hidden messages
- Improve overall polish

## Implementation Order

### Phase 1: Foundation (Core Storage)
1. Create `History/Manager.vala` with basic save/load
2. Create data classes (`Session`, `Summary`, `ClientConfig`, `Metadata`)
3. Integrate auto-save into `ChatWidget`
4. Test: Save and load a simple chat

### Phase 2: Title Generation
1. Create `History/TitleGenerator.vala`
2. Integrate async title generation after first message
3. Update summary index with titles
4. Test: Verify titles are generated and stored

### Phase 3: Basic UI
1. Create `UI/HistoryBrowser.vala` with list view
2. Add `Adw.OverlaySplitView` to main window
3. Implement chat selection and restoration
4. Test: Browse and restore old chats

### Phase 4: Polish
1. Add about dialog
2. Improve styling
3. Add search/filter to history browser
4. Test: Full user experience

### Phase 5: Advanced Features (Post-MVP)
1. Implement hidden messages
2. Implement chat rewinding
3. Consider multiple chat sessions if needed
4. Test: Advanced workflows

### Phase 6: Application Transformation
1. Rename/refactor main window
2. Update build configuration
3. Add desktop file and icon
4. Final polish and testing

## Technical Considerations

### File I/O
- Use `GLib.File` and `GLib.FileIOStream` for async file operations
- Handle file locking if multiple instances run (optional)
- Error handling for corrupted JSON files
- Migration path for future format changes

### Performance
- Lazy loading: Only load full chat when selected
- Index file keeps memory usage low for browsing
- Async operations to avoid blocking UI
- Consider pagination for large history lists

### Data Migration
- Version field in index file for future migrations
- Backward compatibility when possible
- Clear migration path documented

### Security
- API keys stored in history files (consider encryption option)
- File permissions: `~/.local/share/ollmchat/` should be user-readable only
- Option to clear history or export without sensitive data

## Open Questions

1. **Title Update Strategy**: Should titles be updated if conversation evolves significantly, or only generated once?
   - **Recommendation**: Generate once after first exchange, allow manual edit

2. **History Size Limits**: Should there be a maximum number of stored chats or automatic cleanup?
   - **Recommendation**: No hard limit initially, add cleanup option later

3. **Export/Import**: Should users be able to export chats for backup or sharing?
   - **Recommendation**: Add export to JSON/Markdown in future phase

4. **Search Functionality**: Full-text search across all chats?
   - **Recommendation**: Start with title/preview search, add full-text later

5. **Branch Visualization**: How to show chat branches in history browser?
   - **Recommendation**: Indent or tree view for branches, or separate "Branches" section

6. **Multiple Instances**: Should multiple app instances share the same history?
   - **Recommendation**: Yes, but handle file locking for concurrent writes

## Dependencies

### New Dependencies
- **libadwaita-1**: For `Adw.OverlaySplitView`, `Adw.AboutWindow`, modern UI components
  - Already likely available if using GTK4

### Existing Dependencies
- All current dependencies remain
- JSON serialization (json-glib)
- File I/O (GLib)

## Testing Strategy

1. **Unit Tests**:
   - History manager save/load
   - Title generation
   - Message serialization with hidden flag

2. **Integration Tests**:
   - Full chat save/restore cycle
   - History browser interaction
   - Rewind functionality

3. **Manual Testing**:
   - Create multiple chats
   - Browse and restore
   - Test rewinding
   - Test hidden messages
   - Verify UI polish

## Future Enhancements

- **Cloud Sync**: Optional sync to cloud storage
- **Tags/Categories**: Organize chats with tags
- **Favorites**: Mark important chats
- **Statistics**: Token usage, model performance over time
- **Export Formats**: Markdown, PDF, HTML
- **Search**: Full-text search across all messages
- **Chat Templates**: Save and reuse common conversation starters

