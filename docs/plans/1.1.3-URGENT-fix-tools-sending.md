# 1.1.3. URGENT - Fix Tools Listing and Tools Being Sent to Client

## Overview

Fixed an issue where tools were not being properly listed and sent to the client. The fix involved changing how we check if a model supports tools, and ensuring tools are properly initialized when created.

## Status

✅ **DONE** - Fixed in commit `9caccf34`

⚠️ **REVERT REQUIRED** - This change needs to be reverted due to conflicts with a big change on another branch. See "Revert Instructions" section below.

## Problem

The previous implementation had two issues:

1. **Model capability checking**: The code was using `client.available_models.has_key(model)` to check if a model supports tools, which was unreliable because:
   - The model might not be in `available_models` yet
   - It didn't properly check the model's capabilities across different connections

2. **Tool initialization**: Tools created via `Object.new()` with named parameters might not have their constructors called, leading to uninitialized tools that couldn't be properly serialized or used.

## Solution

### 1. Changed Model Capability Checking

**File**: `libollmchat/Call/Chat.vala`

Changed from:
```vala
if (!this.client.available_models.has_key(this.model) 
    || !this.client.available_models.get(this.model).can_call) {
    return null;
}
```

To:
```vala
// Use ConnectionModels to look up model info (via client.connection_models)
bool model_supports_tools = true;

var model_usage = this.client.connection_models.find_model(
        this.client.connection.url, this.model);

model_supports_tools = model_usage.model_obj.can_call;

// Only exclude tools if we know the model explicitly doesn't support them
if (!model_supports_tools) {
    return null;
}
```

This uses `ConnectionModels.find_model()` which properly looks up model information across connections and checks the `can_call` capability.

### 2. Added Tool Initialization Method

**File**: `libollmchat/Tool/Tool.vala`

Added a new `init()` method that:
- Creates the function instance
- Parses parameter descriptions
- Ensures tools are properly initialized even when created via `Object.new()`

The `init()` method is called:
- In the constructor (for normal instantiation)
- After `Object.new()` calls (for tools created with named parameters)

### 3. Added ConnectionModels Property to Client

**File**: `libollmchat/Client.vala`

Added:
```vala
/**
 * Optional ConnectionModels instance for looking up model information.
 * Set by Manager when creating clients. Temporary solution until Client is removed.
 */
public Settings.ConnectionModels? connection_models { get; set; default = null; }
```

### 4. Set ConnectionModels in Manager

**File**: `libollmchat/History/Manager.vala`

Added code to set `connection_models` on clients:
- When creating `base_client`: `this.base_client.connection_models = this.connection_models;`
- When creating new clients: `client.connection_models = this.connection_models;`

## Files Modified

1. `libollmchat/Call/Chat.vala` - Changed model capability checking
2. `libollmchat/Tool/Tool.vala` - Added `init()` method and ensured initialization
3. `libollmchat/Client.vala` - Added `connection_models` property
4. `libollmchat/History/Manager.vala` - Set `connection_models` on clients

## Revert Instructions

⚠️ **IMPORTANT**: This change needs to be reverted before merging the conflicting branch. 

**Note**: Only revert the 4 files listed below. The commit `9caccf34` also includes:
- A new model file (`docs/Modelfiles/roojs-minimax-m2:q2_k -f`) - **KEEP THIS**
- Documentation updates - **KEEP THESE**
- Removal of old tool files - **KEEP THESE CHANGES**

Follow these steps to revert only the tools-related changes:

### Step 1: Revert libollmchat/Call/Chat.vala

In the `serialize_property` method, case "tools", replace:

```vala
// Use ConnectionModels to look up model info (via client.connection_models)
bool model_supports_tools = true;

var model_usage = this.client.connection_models.find_model(
        this.client.connection.url, this.model);

model_supports_tools = model_usage.model_obj.can_call;

// Only exclude tools if we know the model explicitly doesn't support them
if (!model_supports_tools) {
    return null;
}
```

With:

```vala
if (!this.client.available_models.has_key(this.model) 
    || !this.client.available_models.get(this.model).can_call) {
    return null;
}
```

### Step 2: Revert libollmchat/Tool/Tool.vala

1. **Remove the `init()` method** (lines ~75-162 in the fixed version):
   - Remove the `private bool initialized = false;` field
   - Remove the entire `protected void init()` method
   - Remove all calls to `tool.init()` after `Object.new()` calls

2. **Restore the original constructor**:
   - Move the initialization code back into the constructor
   - The constructor should directly create `this.function = new Function(this);` and parse parameter descriptions

3. **Remove `init()` calls**:
   - In `setup_all_tool_configs()`: Remove `tool.init();` after `Object.new()`
   - In `register_all_tool_configs()`: Remove `tool.init();` after `Object.new()`
   - In `register_all_tools()`: Remove `tool.init();` after `Object.new()`

### Step 3: Revert libollmchat/Client.vala

Remove the `connection_models` property:

```vala
/**
 * Optional ConnectionModels instance for looking up model information.
 * Set by Manager when creating clients. Temporary solution until Client is removed.
 */
public Settings.ConnectionModels? connection_models { get; set; default = null; }
```

### Step 4: Revert libollmchat/History/Manager.vala

Remove the two lines that set `connection_models`:

1. In the constructor (after creating `base_client`):
   - Remove: `this.base_client.connection_models = this.connection_models;`

2. In `new_client()` method (after setting available_models):
   - Remove: `client.connection_models = this.connection_models;`

### Step 5: Verify Revert

After reverting, verify:
- Tools are still being serialized correctly
- Model capability checking works (may need to ensure models are in `available_models` first)
- Tools are properly initialized when created

### Git Revert Command (Alternative - Partial Revert)

⚠️ **DO NOT** use `git revert 9caccf34` as it will revert the entire commit, including the new model file (`docs/Modelfiles/roojs-minimax-m2:q2_k -f`) and other changes we want to keep.

To revert only the specific files related to the tools fix using `git show`:
```bash
# Revert only the relevant files
git show 9caccf34^:libollmchat/Call/Chat.vala > libollmchat/Call/Chat.vala
git show 9caccf34^:libollmchat/Tool/Tool.vala > libollmchat/Tool/Tool.vala
git show 9caccf34^:libollmchat/Client.vala > libollmchat/Client.vala
git show 9caccf34^:libollmchat/History/Manager.vala > libollmchat/History/Manager.vala

# Review the changes
git diff

# Stage and commit the partial revert
git add libollmchat/Call/Chat.vala libollmchat/Tool/Tool.vala libollmchat/Client.vala libollmchat/History/Manager.vala
git commit -m "Revert tools fix changes (keep model file and other changes)"
```

**Note**: The manual revert steps above are recommended as they give you full control and allow you to verify each change. The `git show` method writes directly to files and requires manual staging, which allows you to review changes before committing.

## Related Issues

- Tools were not being sent to the LLM API when they should have been
- Tools were not being properly initialized when created via `Object.new()`
- Model capability checking was unreliable

## Notes

- The `connection_models` property was marked as a "temporary solution until Client is removed"
- The `init()` method pattern ensures tools work correctly with Vala's `Object.new()` API
- The fix ensures tools are only sent to models that explicitly support them (via `can_call` check)
