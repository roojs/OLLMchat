# 4.5. Coding Agent Missing Bits

## Overview

Complete the coding agent implementation by adding a real Provider implementation for `CodeAssistant`. Currently, `CodeAssistant` uses `CodeAssistantDummy` which returns empty values. The code assistant needs to ask the provider what the current state of the editor is, including open files, cursor positions, selected code, and file contents.

The prompt engine would have the ability to scan files (not via a tool), and the provider would maintain the state of all open files in the editor.

## Status

✅ **DONE** - Implementation completed. CodeAssistantProvider and OpenFile classes created with full AgentInterface implementation.

## Current State

- `CodeAssistant` requires an `AgentInterface` provider
- Currently uses `CodeAssistantDummy` which returns empty values
- No real integration with editor state
- No awareness of open files, cursor positions, or selected code

### Current CodeAssistant Behavior

Looking at `CodeAssistant.generate_context_section()` (lines 121-169), the current implementation:

1. **Current File** (`<current_file>` section):
   - Uses `open_files[0]` as the "current file" (line 129) - **This is wrong!** It just takes the first file in the list, not the actually active/focused file
   - Shows only: path, cursor position (line number), and the single line content at cursor
   - Does NOT show full contents of the current file

2. **Attached Files** (`<attached_files>` section):
   - **Includes FULL contents of ALL open files** (lines 147-154)
   - Loops through every open file and includes complete file contents
   - This could be huge if many files are open or files are large

3. **Selected Code** (`<manually_added_selection>` section):
   - Shows selected code if any exists

**Issues:**
- No way to identify which file is actually active/focused (just uses first in list)
- Includes full contents of all files, which could be very large and expensive
- Should probably only include full contents of the active file, or limit what's included

## Implementation Details

### CodeAssistantProvider Implementation
**File**: `libollmchatgtk/Prompt/CodeAssistantProvider.vala` (new file)

Create a real implementation of `AgentInterface` that:

1. **Stores a list of opened files** - An array/list of file objects, where each file object contains:
   - `filename` - The file path
   - `sourceview` - Reference to the GTK SourceView widget (or similar editor widget)
   - Methods:
     - `get_contents(int max_lines=20)` - Get file contents (limited to first N lines for non-active files, full for active)
     - `get_line_count()` - Get total number of lines from text buffer (calculated when needed)
     - `get_mtime()` - Get file modification time from filesystem (for sorting by recency)
     - `get_selected_code()` - Get currently selected text (only for active file)
     - `get_line_content(int line)` - Get content of a specific line from text buffer (only for active file)
     - `get_cursor_position()` - Get current cursor position (line number) (only for active file)

2. **Tracks the currently active file** - The provider maintains a pointer/reference to the active file object
   - When files are added/removed, connect to `notify['active']` signal on the editor
   - Pass a reference to the provider in the signal handler
   - Update the `active_file` pointer when the signal fires
   - No need to check on each call - the pointer is always current

3. **Implements AgentInterface methods**:
   - `get_workspace_path()` - Returns the workspace root path
   - `get_open_files()` - Returns list of all open file paths (sorted by mtime, most recent first, up to 15)
   - `get_current_cursor_position()` - Gets cursor position for the active file (no file parameter needed)
   - `get_current_line_content(string cursor_pos)` - Gets line content for the active file (no file parameter needed)
   - `get_file_contents(string file)` - Gets full contents of a file (used for ALL open files in attached_files section)
   - `get_selected_code()` - Gets selected code from the active file only (no file parameter, implied to be active file)

### Integration Points

The provider needs to be:
- **Connected to file add/remove signals** - When files are opened/closed, add/remove from the list
- **Connected to `notify['active']` signal** - When active file changes, update the `active_file` pointer
  - Pass provider reference in signal handler: `editor.notify['active'].connect((obj, pspec) => { provider.update_active_file(obj); })`
- **Cursor position, text selection** - Can be queried when needed (no need to track changes)
- Connected to editor widgets (GTK SourceView or similar)

### File Scanning Capability

The prompt engine (CodeAssistant) would have the ability to scan files directly through the provider, not via a tool. This allows the agent to:
- See what files are open
- Access file contents without tool calls
- Understand current editor context
- Know where to output new files (current directory awareness)

### Context Section Improvements

The `generate_context_section()` method should be improved:

1. **Current File** - Should use the `active_file` pointer directly (no need to search)
2. **Attached Files** - Implement smart content limiting:
   - **Limit to 15 most recent files** - Sort by file `mtime` (modification time) and take top 15
   - **First 20 lines only** - For non-active files, only include first 20 lines of content
   - **Active file exception** - Include full contents (or larger range) for the currently active file
   - **Include metadata** - Show file path, mtime, and line count in file_contents tag
   - **Format**: `<file_contents path="..." mtime="..." lines="1-20" total_lines="150">...</file_contents>`
   - **Line count** - Get from text buffer when needed: `get_line_count()` method
3. **Performance** - Avoid including huge files that could bloat the prompt and waste tokens
4. **File sorting** - Use filesystem `mtime` (modification time) for recency - no need to track views

## Architecture

```
CodeAssistant
    ↓ (uses)
AgentInterface (interface)
    ↓ (implemented by)
CodeAssistantProvider (real implementation)
    ↓ (tracks)
Editor State:
    - List of OpenFile objects
    - active_file pointer (updated via notify['active'] signal)
    - Each OpenFile has:
      - filename
      - sourceview/widget reference
      - methods to get contents, selection, cursor, line content, mtime, line_count
```

## Files to Create/Modify

1. **New Files**:
   - `libollmchatgtk/Prompt/CodeAssistantProvider.vala` - Real AgentInterface implementation
   - `libollmchatgtk/Prompt/OpenFile.vala` - File object class (optional, could be internal)

2. **Modified Files**:
   - `libollmchat/Prompt/AgentInterface.vala` - Update interface methods:
     - Change `get_cursor_position(string file)` to `get_current_cursor_position()` (no file parameter)
     - Change `get_line_content(string file, string cursor_pos)` to `get_current_line_content(string cursor_pos)` (no file parameter)
   - `libollmchat/Prompt/CodeAssistant.vala` - Fix `generate_context_section()` to:
     - Use `active_file` pointer directly
     - Limit attached files to 15 most recent (sorted by mtime)
     - Limit non-active files to first 20 lines
   - `libollmchat/Prompt/CodeAssistantDummy.vala` - Update to match new interface signatures
   - `ollmchat/Window.vala` - Use `CodeAssistantProvider` instead of `CodeAssistantDummy`
   - `libollmchatgtk/meson.build` - Add new files
   - Editor/UI code - Connect `notify['active']` signal to provider to update active_file pointer

## Use Cases

- Agent can see what files are currently open in the editor
- Agent knows the current cursor position
- Agent can access selected code
- Agent understands the current file context
- Agent knows where files are located (workspace awareness)
- Agent can output files in the current directory (workspace awareness)

## Related Plans

- [5.0 - WebKit Control](5.0-webkit-control.md) - UI enhancements that may provide editor integration
- [2.1 - File Reading Tool](2.1-DONE-file-reading-tool.md) - Existing file reading capability (separate from provider)
- [1.7 - Agent Management System](1.7-DONE-agent-management.md) - Agent system where CodeAssistant is registered

## Design Reference

The CodeAssistant implementation is based on Cursor's agent design. The code comments in `CodeAssistant.vala` reference:
- Line 73: "Based on Cursor's implementation"
- Line 119: "Matches Cursor's format with <current_file>, <attached_files>, and <manually_added_selection>"

**Reference**: [Cursor's System Prompt](https://gist.githubusercontent.com/ScriptedAlchemy/6dad354fae5092d35fe0455acf147f5b/raw/ea5a240fde9a6adce8f6ea2d1e6235c0c179d819/conversation.md) - Example of Cursor's agent system prompt and format

The format includes:
- `<additional_data>` section with context information
- `<current_file>` - Current file path, cursor position, and line content
- `<attached_files>` - All open files with their full contents
- `<manually_added_selection>` - Selected code from the editor
- `<user_query>` - The actual user query

### File Content Limits

To avoid token bloat and improve performance, the attached files section should be limited:
- **Limit to 15 most recent files** - Only include the 15 most recently viewed/opened files
- **First 20 lines only** - For each file, only include the first 20 lines of content (not full file contents)
- **File metadata** - Include file path, updated date, and line count information
- **Active file exception** - The currently active file may include more context (full contents or larger range)

### File Info Data Structure

Each file in the provider should track:
- `filename` - File path
- `sourceview` - Reference to editor widget
- Methods to get data when needed:
  - `get_mtime()` - Get file modification time from filesystem (for sorting)
  - `get_line_count()` - Get total number of lines from text buffer (calculated when needed)

The provider maintains:
- `active_file` - Pointer/reference to the currently active file object (updated via signal)

## Implementation Notes

- Provider should work with GTK SourceView widgets
- Connect to `notify['active']` signal to update `active_file` pointer automatically
- Connect to file add/remove signals to maintain the file list
- Cursor position and selection can be queried when needed (no need to track changes)
- Provider should handle cases where files are closed (remove from list)
- Consider performance - don't scan entire files on every request if not needed
- Active file is tracked via pointer (updated via signal) - no need to check on each call
- File contents should come from text buffer, not re-reading from disk (to see unsaved changes)
- Use filesystem `mtime` for file sorting (no need to track view/access times)
- Line count can be calculated from text buffer when needed
