# 1.2.6.6. Update Search

## Overview

Update Search to take `Config2` instead of `Client`, using `tool_config()` to get embedding connection and model.

**Parent Plan**: [1.2.6. Update Legacy Methods](./1.2.6-update-legacy-methods.md)

**Prerequisite**: [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) must be complete

## Status

âœ… **DONE** - Search now takes Config2 and uses VectorBase for connection access.

## Goal

Search should not depend on `Client` with config. According to plan 1.2, Manager owns the config, not Client. Search should use `Config2` and `CodebaseSearchToolConfig.tool_config()` to get embedding connection and model, similar to how Database uses config.

## Current Implementation

**File**: `libocvector/Search/Search.vala` (line 187)

```vala
public Search(
    OLLMvector.Database vector_db,
    SQ.Database sql_db,
    OLLMchat.Client embedding_client,
    OLLMfiles.Folder folder,
    string query,
    // ...
)
{
    this.embedding_client = embedding_client;
    // ...
}
// ...
var embed_response = yield this.embedding_client.embed(normalized_query);
```

**Problem**: Search takes `Client` but should use `Config2` to get connection and model from tool config.

## Proposed Fix

```vala
private Settings.Config2 config;

public Search(
    OLLMvector.Database vector_db,
    SQ.Database sql_db,
    Settings.Config2 config,
    OLLMfiles.Folder folder,
    string query,
    // ...
)
{
    this.vector_db = vector_db;
    this.sql_db = sql_db;
    this.config = config;
    this.folder = folder;
    this.query = query;
    // ...
}

public async Gee.ArrayList<SearchResult> execute() throws GLib.Error
{
    // ... normalize query ...
    
    // Step 2: Query vectorization (convert text to embeddings)
    GLib.debug("Vectorizing query: %s", normalized_query);
    
    // Get tool config to access embedding connection and model
    var tool_config = yield OLLMvector.Tool.CodebaseSearchToolConfig.tool_config(this.config);
    if (!tool_config.enabled || !tool_config.embed.is_valid) {
        throw new GLib.IOError.FAILED("Codebase search tool not properly configured");
    }
    
    var connection = this.config.connections.get(tool_config.embed.connection);
    if (connection == null) {
        throw new GLib.IOError.FAILED("Embedding connection not found in config");
    }
    
    var client = new Client(connection) {
        config = this.config
    };
    var embed_response = yield client.embed(tool_config.embed.model, normalized_query);
    if (embed_response == null || embed_response.embeddings.size == 0) {
        throw new GLib.IOError.FAILED("Failed to get query embedding");
    }
    
    // ... rest of implementation ...
}
```

## Implementation Steps

1. Update `Search` constructor to take `Config2` instead of `Client`
2. Update `execute()` method to use `tool_config()` to get embedding connection and model
3. Find all call sites of Search constructor and update them to pass `config` instead of `embedding_client`
4. Test that search operations still work

## Test

Verify search operations still work for codebase search.

## Result

Search uses Config2 and tool config to get embedding connection and model, and no longer depends on Client with config.

## Files to Modify

- `libocvector/Search/Search.vala` - Update constructor and `execute()` method
- Find and update all Search constructor call sites

## Related Plans

- [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) - Prerequisite

