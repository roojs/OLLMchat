# 1.2.7.8. Cleanup Items

## Overview

Various cleanup items identified during the signal migration process that need to be addressed.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md)

## Status

⏳ **TODO** - Cleanup phase after signal migration.

## Goal

Address various cleanup items and technical debt identified during the signal migration process.

## Cleanup Items

### Model and Options Setting Location

**Issue**: Currently in `AgentHandler.send_async()`, model and options are being updated on the Chat instance just before sending the message. This is too late in the flow.

**Decision Needed**: Determine where model and options should be set for Chat:
- Option A: Set when Chat is created in AgentHandler constructor (current approach)
- Option B: Set when session properties change (model/options change on session)
- Option C: Set when AgentHandler is created/updated (when agent changes on session)
- Option D: Some combination of the above

**Current State**: Model and options update code is commented out in `AgentHandler.send_async()` with a FIXME. The Chat is created in the constructor with initial values, but they're not updated when session properties change.

**Action**: Decide on the correct approach and implement it during 1.2.7 cleanup.

**Files to Modify**:
- `libollmchat/Prompt/AgentHandler.vala` - Resolve FIXME and implement proper model/options update flow

### ChatInput Model Update - Propagate to Chat Instance

**Issue**: When the model is changed in `ChatInput`, it updates `session.model`, but there's a FIXME about whether `session.agent.chat.model` also needs to be updated.

**Current State**: 
- `libollmchatgtk/ChatInput.vala` lines 457-460:
```vala
// Update model on Session (Chat is created per request by AgentHandler)
// FIXME - manager.session.agent.chat.model update?
this.manager.session.model = model.name;
```

**Questions to Resolve**:
- Should the Chat instance model be updated when the model changes in the UI?
- If Chat is created per request by AgentHandler, does it need to be updated immediately or will it pick up the new model from session when created?
- Should this be handled automatically when session.model changes, or explicitly in ChatInput?

**Action**: Determine if Chat instance needs to be updated when model changes in UI, and implement the proper approach during 1.2.7 cleanup.

**Files to Modify**:
- `libollmchatgtk/ChatInput.vala` - Resolve FIXME and implement proper model update flow

### Implement BaseAgent.system_message() Method

**Issue**: Currently `CodeAssistantHandler.send_async()` uses `agent.fill(this.chat, "")` to get system prompt. This is a workaround - should use dedicated `system_message()` method.

**Current State**: 
- `BaseAgent.system_message(AgentHandler handler)` exists as placeholder that returns empty string
- `CodeAssistantHandler.send_async()` calls `this.agent.system_message(this)` which currently returns empty string
- CodeAssistant needs to override this to generate system prompt with current context

**Proposed Implementation**:
- `BaseAgent.system_message()` - Default returns empty string (for simple agents like JustAsk)
- `CodeAssistant.system_message()` - Override to generate system prompt with current context (open files, workspace, etc.)
- Method receives `AgentHandler` so it can access `handler.session`, `handler.client`, etc.

**Action**: Implement `CodeAssistant.system_message()` override during 1.2.7 cleanup to properly generate system prompt with current context.

**Files to Modify**:
- `libollmchat/Prompt/BaseAgent.vala` - Ensure `system_message()` method exists
- `liboccoder/Prompt/CodeAssistant.vala` - Override `system_message()` to generate system prompt

### Review generate_system_prompt() Implementation

**Issue**: `BaseAgent.generate_system_prompt()` only returns an empty string. Only `CodeAssistant.generate_system_prompt()` has a real implementation that builds a system prompt. This means the method is effectively only used by CodeAssistant, while other agents (like JustAsk) don't use it.

**Current State**: 
- `BaseAgent.generate_system_prompt()` returns empty string (line 222-225 in BaseAgent.vala)
- `CodeAssistant.generate_system_prompt()` has a real implementation that builds complex system prompt with sections
- `JustAsk` doesn't override it, so it uses the base implementation (empty string)
- `AgentHandler.send_async()` calls `this.agent.generate_system_prompt()` and adds it to messages if not empty (line 190-193 in AgentHandler.vala)

**Questions to Resolve**:
- Should `generate_system_prompt()` be removed from base implementation if only CodeAssistant uses it?
- Or should other agents have meaningful implementations?
- Is there a better pattern for this (e.g., only CodeAssistant should call it, or it should be abstract/virtual with CodeAssistant override)?

**Action**: Review and decide on the proper pattern for `generate_system_prompt()` during 1.2.7 cleanup. Either:
1. Make it abstract and require all agents to implement it (even if empty)
2. Remove it from base and only have CodeAssistant implement it
3. Keep current pattern but document that only CodeAssistant should override it
4. Refactor to a different pattern (e.g., `system_message()` method that receives handler context)

**Files to Modify**:
- `libollmchat/Prompt/BaseAgent.vala` - Review and potentially refactor `generate_system_prompt()`
- `liboccoder/Prompt/CodeAssistant.vala` - Review implementation

### Rename Agent-Related Code from Prompt/* to Agent/*

**Issue**: Agent-related classes (AgentHandler, BaseAgent, CodeAssistant, JustAsk, etc.) are currently in the `OLLMchat.Prompt` namespace, but they're really about agents, not prompts.

**Current State**: 
- `libollmchat/Prompt/AgentHandler.vala` → `OLLMchat.Prompt.AgentHandler`
- `libollmchat/Prompt/BaseAgent.vala` → `OLLMchat.Prompt.BaseAgent`
- `libollmchat/Prompt/CodeAssistant.vala` → `OLLMchat.Prompt.CodeAssistant`
- `libollmchat/Prompt/JustAsk.vala` → `OLLMchat.Prompt.JustAsk`
- `libollmchat/Prompt/AgentInterface.vala` → `OLLMchat.Prompt.AgentInterface`
- `libollmchat/Prompt/CodeAssistantDummy.vala` → `OLLMchat.Prompt.CodeAssistantDummy`

**Proposed Change**: 
- Move agent-related files from `libollmchat/Prompt/` to `libollmchat/Agent/`
- Change namespace from `OLLMchat.Prompt` to `OLLMchat.Agent`
- Update all imports and references throughout the codebase
- Keep prompt-related code (if any) in `Prompt/` namespace

**Action**: Rename namespace and move files during 1.2.7 cleanup.

**Files to Modify**:
- Move all agent-related files from `libollmchat/Prompt/` to `libollmchat/Agent/`
- Update all imports and references throughout the codebase

### Remove session_replaced Signal Emission

**Issue**: `SessionPlaceholder.load()` emits `manager.session_replaced()` signal, but this is no longer needed since the UI uses `SessionList` directly as a `ListModel`, which automatically emits `items_changed` signals when items are replaced.

**Current State**: 
- `libollmchat/History/SessionPlaceholder.vala` line 222-224 has FIXME comment: "is this needed anymore ? = since the UI uses the store."
- The `session_replaced` signal is emitted after replacing a placeholder with a real session
- `HistoryBrowser` still connects to this signal but doesn't need to since `SessionList.replace_at()` already emits `items_changed`

**Action**: 
- Remove `session_replaced` signal emission from `SessionPlaceholder.load()`
- Remove `session_replaced` signal declaration from `Manager`
- Remove `session_replaced` signal connection from `HistoryBrowser`
- Remove `on_session_replaced()` handler from `HistoryBrowser`

**Files to Modify**:
- `libollmchat/History/SessionPlaceholder.vala` - Remove `session_replaced` signal emission
- `libollmchat/History/Manager.vala` - Remove `session_replaced` signal declaration
- `libollmchatgtk/HistoryBrowser.vala` - Remove signal connection and handler

### Remove session_added Signal Emission

**Issue**: `session_added` signal is emitted when sessions are added to `manager.sessions`, but this is no longer needed since the UI uses `SessionList` directly as a `ListModel`, which automatically emits `items_changed` signals when items are added via `append()`.

**Current State**: 
- `libollmchat/History/EmptySession.vala` lines 98 and 136 have FIXME comments: "is this needed now?"
- `libollmchat/History/Session.vala` line 148 emits `session_added` after adding session to list
- `libollmchat/History/Manager.vala` line 311 emits `session_added` in `create_new_session()`
- `HistoryBrowser` connects to this signal for selection/scrolling, but could use `items_changed` from `SessionList` instead

**Action**: 
- Remove `session_added` signal emission from `EmptySession.send()` and `EmptySession.send_message()`
- Remove `session_added` signal emission from `Session` (when adding itself to list)
- Remove `session_added` signal emission from `Manager.create_new_session()`
- Remove `session_added` signal declaration from `Manager`
- Update `HistoryBrowser` to listen to `SessionList.items_changed` signal instead of `session_added` for selection/scrolling
- Remove `session_added` signal connection from `HistoryBrowser`
- Remove `on_session_added()` handler from `HistoryBrowser`

**Note**: `HistoryBrowser` currently uses `session_added` to select the new session and scroll to top. This can be done by listening to `SessionList.items_changed` signal and checking if the change is an addition at position 0 (after sorting).

**Files to Modify**:
- `libollmchat/History/EmptySession.vala` - Remove `session_added` signal emissions (2 places)
- `libollmchat/History/Session.vala` - Remove `session_added` signal emission
- `libollmchat/History/Manager.vala` - Remove `session_added` signal declaration and emission
- `libollmchatgtk/HistoryBrowser.vala` - Update to use `SessionList.items_changed` signal instead

### ChatView.append_complete_assistant_message() - Get Chat and Client from Session

**Issue**: `ChatView.append_complete_assistant_message()` currently tries to get Chat from `message.message_interface` with a fallback to `session.agent.chat`, and gets client from `session.client`. This approach has FIXME comments indicating it needs cleanup.

**Current State**: 
- `libollmchatgtk/ChatView.vala` lines 641-655:
```vala
// Get client and chat from message or session
// FIXME - we want to get rid of this message_interface klduget
var call = message.message_interface as OLLMchat.Call.Chat;
if (call == null) {
    // Fallback: try to get chat from session's agent
    if (session.agent != null && session.agent.chat != null) {
        call = session.agent.chat;
    } else {
        GLib.warning("ChatView.append_complete_assistant_message: cannot get Chat from message or session");
        return;
    }
}
// FIXME = need to get connection from elsewhere? sesison?
var client = session.client;
```

**Action**: 
- Review how Chat and Client should be obtained in this context
- Remove dependency on `message.message_interface` 
- Determine proper way to get connection/client (may relate to Phase 6 removal of `session.client`)
- Update code to use cleaner approach

**Files to Modify**:
- `libollmchatgtk/ChatView.vala` - Update `append_complete_assistant_message()` method

### Remove Unused chat Parameter from Session Constructor

**Issue**: `Session` constructor accepts a `Call.Chat? chat` parameter that is documented as "for backward compatibility only, not stored" and is never actually used in the constructor body.

**Current State**: 
- `libollmchat/History/Session.vala` line 79: `public Session(Manager manager, Call.Chat? chat = null)`
- Constructor comment says: "Note: chat parameter is for backward compatibility only, not stored"
- The parameter is never referenced in the constructor body
- Still being passed in `Manager.create_new_session()` line 303: `var session = new Session(this, call);`
- Other call sites pass `null`: `SessionPlaceholder.vala` line 92, `EmptySession.vala` line 78

**Action**: 
- Remove `chat` parameter from `Session` constructor
- Update `Manager.create_new_session()` to not pass the `call` parameter
- Update any other call sites (they already pass `null`, so just remove the argument)
- Remove the backward compatibility comment

**Files to Modify**:
- `libollmchat/History/Session.vala` - Remove `chat` parameter from constructor
- `libollmchat/History/Manager.vala` - Remove `call` argument from `new Session()` call
- `libollmchat/History/SessionPlaceholder.vala` - Remove `null` argument from `new Session()` call
- `libollmchat/History/EmptySession.vala` - Remove `null` argument from `new Session()` call

## Files to Modify

### Core Classes
- `libollmchat/Prompt/AgentHandler.vala` - Resolve model/options FIXME
- `libollmchat/Prompt/BaseAgent.vala` - Review `generate_system_prompt()`, ensure `system_message()` exists
- `liboccoder/Prompt/CodeAssistant.vala` - Override `system_message()`, review `generate_system_prompt()`

### History/Session
- `libollmchat/History/SessionPlaceholder.vala` - Remove `session_replaced` signal emission
- `libollmchat/History/EmptySession.vala` - Remove `session_added` signal emissions
- `libollmchat/History/Session.vala` - Remove `session_added` signal emission, remove unused `chat` parameter
- `libollmchat/History/Manager.vala` - Remove `session_replaced` and `session_added` signal declarations and emissions, remove `call` argument from `new Session()` call

### UI
- `libollmchatgtk/ChatInput.vala` - Resolve model update FIXME
- `libollmchatgtk/ChatView.vala` - Update `append_complete_assistant_message()` method
- `libollmchatgtk/HistoryBrowser.vala` - Remove `session_replaced` and `session_added` signal connections, use `SessionList.items_changed` instead

### Namespace Refactoring
- Move agent-related files from `libollmchat/Prompt/` to `libollmchat/Agent/`
- Update all imports and references throughout the codebase

## Testing Checklist

- [ ] Model and options are set correctly for Chat instances
- [ ] Model updates in UI propagate correctly to Chat instances
- [ ] `BaseAgent.system_message()` method works correctly
- [ ] `CodeAssistant.system_message()` generates system prompt with context
- [ ] `generate_system_prompt()` pattern is resolved and documented
- [ ] Agent-related code moved to `Agent/` namespace
- [ ] All imports and references updated after namespace change
- [ ] `session_replaced` signal removed and UI still works
- [ ] `session_added` signal removed and UI still works
- [ ] `ChatView.append_complete_assistant_message()` gets Chat and Client correctly
- [ ] Unused `chat` parameter removed from Session constructor
- [ ] All functionality still works correctly after cleanup

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md) - Parent plan
- [1.2.7.7. Remove Client from Session](./1.2.7.7-remove-client-from-session.md) - Previous phase
- [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md) - Grandparent plan

