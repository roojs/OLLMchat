# 1.2.7.8. Cleanup Items

## Overview

Various cleanup items identified during the signal migration process that need to be addressed.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md)

## Status

⏳ **TODO** - Cleanup phase after signal migration.

## Goal

Address various cleanup items and technical debt identified during the signal migration process.

## Cleanup Items

### Model and Options Setting Location

**Issue**: Currently in `AgentHandler.send_async()`, model and options are being updated on the Chat instance just before sending the message. This is too late in the flow.

**Decision**: **Option D - Combination approach**:
- **When session converts to real session**: Set model/connection/options when Chat is created in AgentHandler constructor (Option A - already implemented)
  - `EmptySession.send()` → creates `Session` → `Session.send()` → `ensure_agent_handler()` → creates `AgentHandler` → constructor creates `Chat` with model/options from `session.model_usage`
  - This is the correct initial setup point
- **When UI updates model**: Update Chat's model/connection/options when `session.activate_model()` is called (Option B)
  - `ChatInput` calls `session.activate_model(model_usage)` which updates `session.model_usage`
  - `Session.activate_model()` should directly update `agent.chat.model`, `agent.chat.connection`, and set `agent.chat.options = model_usage.options` (no cloning - Chat is just a user of the options)
  - No need for agent method - just update Chat properties directly (agent.chat is public)
- **When config changes**: Update Chat's model/options when config.model_options changes
  - Session should listen to `config.changed()` signal
  - When config changes, directly update `agent.chat.model` and set `agent.chat.options = model_usage.options` (no cloning)
  - Chat doesn't own the options, it just references them, so no need to clone

**Current State**: 
- Model and options update code is commented out in `AgentHandler.send_async()` with a FIXME (lines 198-201)
- Chat is created in constructor with initial values from `session.model_usage` (correct)
- Chat is NOT updated when `session.activate_model()` is called (needs fix)
- Chat is NOT updated when config changes (needs fix)

**Action**: Implement proper model/options update flow:
1. In `Session.activate_model()`, directly update Chat properties:
   - Set `agent.chat.model = model_usage.model`
   - Set `agent.chat.connection` from `model_usage.connection` (get Connection object from manager.config.connections)
     - Note: `connection` is `protected set` on OllamaBase, so may need to use `set_property()` or handle via reflection
   - Set `agent.chat.options = model_usage.options` (no cloning - Chat just references the Options object, Chat doesn't own it)
2. Add config change handler to Session that listens to `config.changed()` signal and directly updates Chat:
   - Set `agent.chat.model = model_usage.model` (if model changed)
   - Set `agent.chat.options = model_usage.options` (no cloning)
   - When config changes, `model_usage.options` may have been updated (if it references config.model_options)

**Files to Modify**:
- `libollmchat/Prompt/AgentHandler.vala` - Remove FIXME from `send_async()`, update constructor to not clone options (set `chat.options = mu.options` directly)
- `libollmchat/History/SessionBase.vala` - Update `activate_model()` to directly set `agent.chat.model`, `agent.chat.connection`, and `agent.chat.options = model_usage.options` (agent always exists)
- `libollmchat/History/Session.vala` - Add config change handler that listens to `config.changed()` signal and directly updates `agent.chat.model` and `agent.chat.options` (agent always exists)

## Testing Checklist

- [ ] Model and options are set correctly for Chat instances
- [ ] Model updates in UI propagate correctly to Chat instances
- [ ] Config changes update Chat model and options correctly
- [ ] All functionality still works correctly after cleanup

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md) - Parent plan
- [1.2.7.7. Remove Client from Session](./1.2.7.7-DONE-remove-client-from-session.md) - Previous phase
- [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md) - Grandparent plan

