# 2.6.1.8. Integrate Change System

## Overview

Integrate the FileHistory system (from 2.6.1.7) with runcommand, overlay, editmode, and filebase. This phase connects the file change history tracking to the actual file operations.

## Status

‚è≥ **PLANNING** - Design phase. Working out details in planning.

## Prerequisites

- Phase 1 (2.6.1.7) must be completed - FileHistory class and database table must exist
- See main plan: `2.6.1-code-exec-improvements.md` for context

## Goals

1. Integrate FileHistory with `liboctools/RunCommand/Monitor.vala` - Record file changes in history table
2. Integrate FileHistory with `liboctools/RunCommand/Overlay.vala` - Process file changes from history table
3. Remove `backup_path` from filebase table
4. Update editmode to use FileHistory
5. Ensure all file changes (command execution and edit file actions) are tracked in FileHistory

## Implementation Details

### Integration Points

**1. RunCommand/Monitor Integration**
- When Monitor detects file changes (added, modified, deleted), create FileHistory objects
- Call `commit()` on each FileHistory object to create backups and store in database
- Use same timestamp for all changes in the same command execution

**2. RunCommand/Overlay Integration**
- Process FileHistory records instead of directly copying files
- Apply approved changes (status = 1) to the filesystem
- Handle rejected changes (status = -1) by restoring from backup_path

**3. EditMode Integration**
- When edit file tool makes changes, create FileHistory objects
- Track edits in the same history system as command execution

**4. FileBase Changes**
- Remove `backup_path` column from filebase table
- Migration: Move existing backup_path values to file_history table if needed

## Files to Modify

- `liboctools/RunCommand/Monitor.vala` - Create FileHistory objects for detected changes
- `liboctools/RunCommand/Overlay.vala` - Process FileHistory records instead of direct file operations
- `liboctools/EditMode/` - Integrate FileHistory for edit file actions
- `libocfiles/FileBase.vala` - Remove backup_path column, add migration if needed
- Additional files TBD

## Notes

- This phase depends on 2.6.1.7 being complete
- Details are worked out during planning phase (not during implementation)
- This is a significant integration effort that will touch multiple subsystems
