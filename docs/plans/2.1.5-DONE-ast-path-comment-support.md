# 2.1.5. AST Path Comment Support

## Overview

Add support for including comments when reading and editing code via AST paths. By default, AST path resolution only includes the code element itself (excluding comments). This enhancement allows users to optionally include preceding comments when reading or editing code blocks.

## Status

✅ **DONE** - Comment-aware AST path resolution implemented for ReadFile and EditMode.

## Related Plans

- **2.1.2** - AST Path Support for ReadFile and EditFile (infrastructure and ReadFile integration)
- **2.1.4** - AST Path EditFile Integration (EditMode AST path support)

## Purpose

Enable LLMs to include documentation comments when reading or editing code:
- Read a method with its documentation comments
- Edit a method and preserve its documentation comments
- Include preceding comments that document the code element

## AST Path Resolution Behavior (Confirmed)

- ✅ **Confirmed**: AST path resolution by default does NOT include comments
- Tree-sitter treats comments as separate nodes, not part of code element nodes
- `Tree.lookup_path()` returns line ranges based on `node_get_start_point()` / `node_get_end_point()`
- These boundaries are the actual code element boundaries, excluding preceding comments

## Implementation Details

### 1. Add Comment Detection to Tree.lookup_path() ✅ DONE
- Extend `Tree.lookup_path()` to capture preceding comments
- Store `comment_start` per AST path during traversal
- Return `comment_start_line` as an out param from `lookup_path()`
- Comment detection should:
  - Walk backwards through sibling nodes to collect comment nodes
  - Check for comment node types: `comment`, `line_comment`, `block_comment`, `doc_comment`, etc.
  - Only include comments that are adjacent (within 2 lines) to the element
  - Stop at first non-comment node or when gap is too large
  - Include all consecutive comment nodes prior to the element

### 2. Update ReadFile to Support Comments ✅ DONE
- Use `comment_start_line` from `tree.lookup_path()` in `resolve_ast_path()`
- Default `start_line` to `comment_start_line` so reads include comments
- Update parameter description in `ReadFile/Tool.vala` to document default comment inclusion

### 3. Update EditMode to Support Comments ✅ DONE
- Add `include_comments` flag to `FileChange`
- Support `:with-comment`/`:before-comment` suffixes in code block parser
- Resolve AST path with comment inclusion when flag is set
- Use comment start line for FileChange boundaries
- Update UI messages to describe comment-aware suffixes

### 4. Implementation Details
```vala
// In Tree.lookup_path() - return comment_start_line
public bool lookup_path(string ast_path, out int start_line, out int end_line, out int comment_start_line)

// During traversal:
// 1. Find parent node
// 2. Look backwards through siblings for comment nodes
// 3. Set comment_start_line to first comment line (or start_line if none)
```

### 5. Comment Detection Logic
- Similar to `libocvector/Indexing/Tree.find_preceding_comments()`
- Check node types: `comment`, `line_comment`, `block_comment`, `doc_comment`, or contains "comment"/"doc"
- Verify comment is adjacent (within 2 lines of element start)
- Include all consecutive comment nodes before the element
- Stop at first non-comment node or when gap exceeds threshold

### 6. Edge Cases
- Handle files with no comments gracefully
- Handle comments that are too far from element (don't include)
- Handle multiple comment blocks (include all consecutive ones)
- Handle inline comments (typically not included, only preceding block/line comments)

## Files to Modify

### Tree Infrastructure
- `libocfiles/Tree.vala` - Return `comment_start_line` from `lookup_path()` method
- `libocfiles/Tree.vala` - Add comment detection logic (similar to `find_preceding_comments()`)

### ReadFile Tool
- `liboctools/ReadFile/Request.vala` - Use `comment_start_line` for read range
- `liboctools/ReadFile/Tool.vala` - Document default comment inclusion

### EditMode Tool
- `liboctools/EditMode/Request.vala` - Add `include_comments` parameter
- `liboctools/EditMode/Tool.vala` - Document `include_comments` parameter

## Example Usage

### ReadFile with Comments
```
Tool: read_file
Parameters:
  file_path: "libollmchat/Client.vala"
  ast_path: "OLLMchat/Client/chat"
```

**Result**: Returns the `chat` method including its preceding documentation comments.

### EditFile with Comments
```
Tool: edit_mode
Code block:
```vala:OLLMchat-Client-chat:include-comments
/**
 * Sends a chat message to the server.
 * @param message The message to send
 */
public void chat(string message) {
    // new implementation
}
```
```

**Result**: Replaces the method including its documentation comments.

## Error Handling

**No Comments Found:**
- If `include_comments=true` but no comments found, return element without comments
- Don't treat as error - just return the element as-is

**Comments Too Far:**
- If comments are more than 2 lines away, don't include them
- Return element without comments (same as if no comments found)

**Multiple Comment Blocks:**
- Include all consecutive comment blocks before the element
- Stop at first non-comment node or blank line
