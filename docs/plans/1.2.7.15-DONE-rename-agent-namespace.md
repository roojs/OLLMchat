# 1.2.7.15. Rename Agent-Related Code from Prompt/* to Agent/*

## Overview

Agent-related classes (AgentHandler, BaseAgent, CodeAssistant, JustAskFactory, etc.) are currently in the `OLLMchat.Prompt` namespace, but they're really about agents, not prompts.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md)

## Status

✅ **COMPLETE** - All phases complete. Old files deleted, build succeeds.

### Progress Summary

**Phase 1: ✅ COMPLETE**
- All new files created in `libollmchat/Agent/` and `liboccoder/`
- New files added to build system alongside old files
- Build succeeds with both old and new code

**Phase 2: ✅ COMPLETE**
- All references updated to use new namespaces (`OLLMchat.Agent.*`, `OLLMcoder.AgentFactory`, `OLLMcoder.Agent`)
- Old files removed from build system
- All code uses new namespaces and method names (`create_agent()`, `factory` property)
- Build succeeds with only new code

**Phase 3: ✅ COMPLETE**
- All old files deleted from filesystem
- Build succeeds with only new code
- Final functionality verified

## Current Structure

### Inheritance Hierarchy

```
BaseAgent (Factory)
  ├── JustAskFactory (extends Factory) → creates JustAsk
  └── CodeAssistantFactory (extends Factory, in liboccoder) → creates CodeAssistant

AgentHandler (Base Handler)
  ├── JustAsk (extends Base Handler)
  └── CodeAssistant (extends Base Handler, in liboccoder)
```

### Current Files

**libollmchat/Prompt/**
- `BaseAgent.vala` → Creates agents (Factory pattern)
- `AgentHandler.vala` → Base handler class (can be extended)
- `JustAsk.vala` → Simple agent factory (extends BaseAgent/Factory, creates agents)
- `AgentInterface.vala` → Context provider interface (only used by old CodeAssistant)
- `CodeAssistantDummy.vala` → Dummy context provider (only used by old CodeAssistant)
- `CodeAssistant.vala` → **LEGACY/UNUSED** (uses AgentInterface)

**liboccoder/Prompt/**
- `CodeAssistant.vala` → **ACTIVE** (extends BaseAgent, uses CodeAssistantProvider)
- `CodeAssistantHandler.vala` → Extends AgentHandler
- `CodeAssistantProvider.vala` → Provides context from ProjectManager

## Proposed Naming Strategy

### Core Agent Classes

1. **BaseAgent** → `Agent/Factory.vala` (`OLLMchat.Agent.Factory`)
   - Creates agents (Factory pattern)
   - Persistent, registered on Manager
   - Base class for all agent factories

2. **AgentHandler** → `Agent/Base.vala` (`OLLMchat.Agent.Base`)
   - Base handler class (can be extended)
   - Ephemeral, created per request
   - Handles request lifecycle

3. **JustAsk** → `Agent/JustAskFactory.vala` (`OLLMchat.Agent.JustAskFactory`)
   - Simple agent factory implementation
   - Extends Factory
   - Creates JustAsk agent instances

4. **JustAsk** → `Agent/JustAsk.vala` (`OLLMchat.Agent.JustAsk`)
   - Simple agent implementation
   - Extends Base
   - Created by JustAskFactory

### Context Provider (Separate Concern)

**Decision**: Remove ContextProvider entirely:
- `AgentInterface` → **REMOVE** (only used by legacy CodeAssistant in libollmchat)
- `CodeAssistantDummy` → **REMOVE** (only used by legacy CodeAssistant in libollmchat)
- **Note**: The active CodeAssistant in liboccoder uses `CodeAssistantProvider` instead, which is specific to occoder and doesn't need AgentInterface.

### CodeAssistant Location

- **Active CodeAssistant** (`liboccoder/Prompt/CodeAssistant.vala`):
  - Extends `OLLMchat.Agent.Factory` → **Should be renamed to `AgentFactory`**
  - Creates `Agent` (extends `OLLMchat.Agent.Base`)
  - Uses CodeAssistantProvider (not AgentInterface)
  - **Location**: `liboccoder/AgentFactory.vala` (top level, not in Prompt/ or Agent/)
  - **Provider**: Merge CodeAssistantProvider methods into AgentFactory
  - Keep in liboccoder (depends on ProjectManager)
  
**Naming**: Since it extends Factory, it IS a factory → `OLLMcoder.AgentFactory`
**Agent**: CodeAssistantHandler should be renamed to `OLLMcoder.Agent` (the actual agent)

- **Legacy CodeAssistant** (`libollmchat/Prompt/CodeAssistant.vala`):
  - Uses AgentInterface
  - **Should be removed** (not used anywhere)

## Proposed File Structure

```
libollmchat/Agent/
  ├── Factory.vala          (was BaseAgent.vala)
  ├── Base.vala             (was AgentHandler.vala)
  ├── JustAskFactory.vala   (was JustAsk.vala - factory that creates JustAsk agents)
  └── JustAsk.vala          (NEW - agent extends Base, created by JustAskFactory)

liboccoder/  (top level, not Prompt/ or Agent/)
  ├── AgentFactory.vala  (was Prompt/CodeAssistant.vala, extends OLLMchat.Agent.Factory, includes provider methods)
  └── Agent.vala         (was Prompt/CodeAssistantHandler.vala, extends OLLMchat.Agent.Base)

libollmchat/Prompt/  (legacy, can be removed)
  ├── CodeAssistant.vala        (UNUSED - remove, only uses AgentInterface)
  ├── AgentInterface.vala        (UNUSED - remove, only used by legacy CodeAssistant)
  └── CodeAssistantDummy.vala   (UNUSED - remove, only used by legacy CodeAssistant)
```

## Namespace Changes

- `OLLMchat.Prompt.BaseAgent` → `OLLMchat.Agent.Factory`
- `OLLMchat.Prompt.AgentHandler` → `OLLMchat.Agent.Base`
- `OLLMchat.Prompt.JustAsk` → `OLLMchat.Agent.JustAskFactory` (factory)
- NEW: `OLLMchat.Agent.JustAsk` (agent, extends Base, created by JustAskFactory)
- `OLLMcoder.Prompt.CodeAssistant` → `OLLMcoder.AgentFactory` (factory, extends OLLMchat.Agent.Factory)
- `OLLMcoder.Prompt.CodeAssistantHandler` → `OLLMcoder.Agent` (agent, extends OLLMchat.Agent.Base)

## Method Lists for Proposed Classes

### OLLMchat.Agent.Factory (was BaseAgent)

**Properties:**
- `name: string` (protected set)
- `title: string` (protected set)
- `shell: string` (public set)

**Methods:**
- `Factory()` - Constructor
- `create_agent(SessionBase session): Object` - Virtual, must override (was `create_handler`)
- `get_workspace_path(): string` - Public virtual (default: "", was signal - can be overridden)
- `get_os_version(): string` - Protected helper
- `load_section(string section_name): string` - Protected, loads resource files
- `generate_user_info_section(): string` - Protected virtual
- `get_working_directory(): string` - Public virtual (default: "")
- `get_widget(): Object?` - Public virtual async (default: null)
- `generate_user_prompt(string user_input): string` - Protected virtual (default: pass-through)
- `configure_tools(Call.Chat call): void` - Public virtual (default: no-op)
- `system_message(Base? handler): string` - Public virtual (default: "")

**Context Provider Methods (virtual, default empty implementations):**
- `get_open_files(): ArrayList<string>` - Public virtual (default: empty list)
- `get_current_cursor_position(): string` - Public virtual (default: "")
- `get_current_line_content(string cursor_pos): string` - Public virtual (default: "")
- `get_file_contents(string file): string` - Public virtual (default: "")
- `get_selected_code(): string` - Public virtual (default: "")

### OLLMchat.Agent.Base (was AgentHandler)

**Properties:**
- `factory: Factory` (protected, was `agent`)
- `connection: Settings.Connection` (protected)
- `session: History.SessionBase` (public)
- `chat: Call.Chat` (public)

**Signals:**
- `stream_chunk(string, bool, Response.Chat)`
- `stream_content(string, Response.Chat)`
- `chat_send(Call.Chat)`
- `stream_start()`

**Methods:**
- `Base(Factory factory, SessionBase session)` - Constructor (was `agent`)
- `~Base()` - Destructor
- `handle_stream_started(): void` - Public virtual
- `handle_stream_chunk(string, bool, Response.Chat): void` - Public virtual
- `handle_tool_message(Message): void` - Public virtual
- `execute_tools(ArrayList<Response.ToolCall>): ArrayList<Message>` - Public virtual async
- `rebuild_tools(): void` - Public
- `send_async(Message, Cancellable?): void` - Public virtual async

### OLLMchat.Agent.JustAskFactory (was JustAsk)

**Methods:**
- `JustAskFactory()` - Constructor (sets name="just-ask", title="Just Ask")
- `create_agent(SessionBase session): Object` - Override (creates JustAsk agent, was `create_handler`)

**Inherited from Factory:**
- All Factory methods (uses defaults - empty system prompt, pass-through user input)

### OLLMchat.Agent.JustAsk (NEW agent)

**Methods:**
- `JustAsk(JustAskFactory factory, SessionBase session)` - Constructor (calls base, was `agent`)

**Inherited from Base:**
- All Base methods (uses default implementation - no special handling)

### OLLMcoder.AgentFactory (was CodeAssistant)

**Properties:**
- `project_manager: ProjectManager` (public, private set)
- `widget: SourceView?` (private, cached)

**Methods:**
- `AgentFactory(ProjectManager project_manager)` - Constructor
- `get_working_directory(): string` - Override (returns active project path or home)
- `system_message(Base? handler): string` - Override (generates full system prompt)
- `generate_user_prompt(string user_query): string` - Override (adds context section)
- `generate_user_info_section(): string` - Override (uses provider methods)
- `create_agent(SessionBase session): Object` - Override (creates Agent, was `create_handler`)
- `get_widget(): Object?` - Override async (creates/manages SourceView widget)
- `initialize_widget(): void` - Private async (loads projects, restores state)

**Provider Methods (override Factory defaults):**
- `get_workspace_path(): string` - Override (gets active project path from ProjectManager)
- `get_open_files(): ArrayList<string>` - Override (gets list of open files, max 15 recent + active)
- `get_current_cursor_position(): string` - Override (gets cursor line number from active file)
- `get_current_line_content(string cursor_pos): string` - Override (gets line content at cursor)
- `get_file_contents(string file): string` - Override (gets file contents, full for active, 20 lines for others)
- `get_selected_code(): string` - Override (gets selected code from active file)

**Private Methods:**
- `generate_introduction(): string` - Generates introduction section
- `generate_context_section(): string` - Generates context data section

### OLLMcoder.Agent (was CodeAssistantHandler)

**Methods:**
- `Agent(AgentFactory factory, SessionBase session)` - Constructor (calls base, was `agent`)

**Methods:**
- `send_async(Message, Cancellable?): void` - Override async (regenerates system prompt on each call)

**Inherited from Base:**
- All other Base methods (uses default implementation)

## Implementation Plan (3 Phases)

### Phase 1: Create New Files and Add to Build

**Goal**: Create all new files alongside old ones, add to build system. Both old and new code exist simultaneously for review.

**Tasks:**
1. ✅ Analyze current structure
2. ✅ Choose naming: Factory, Base, JustAskFactory, JustAsk (agent)
3. ✅ Create `libollmchat/Agent/Factory.vala` (copy from BaseAgent.vala, update namespace and class name)
4. ✅ Create `libollmchat/Agent/Base.vala` (copy from AgentHandler.vala, update namespace, class name, and `agent` → `factory`)
5. ✅ Create `libollmchat/Agent/JustAskFactory.vala` (copy from JustAsk.vala, update namespace, class name, `create_handler` → `create_agent`)
6. ✅ Create `libollmchat/Agent/JustAsk.vala` (NEW - extends Base, created by JustAskFactory)
7. ✅ Add context provider methods to Factory base class (virtual, default empty implementations)
8. ✅ Create `liboccoder/AgentFactory.vala` (copy from CodeAssistant.vala, update namespace, class name, merge provider methods)
9. ✅ Create `liboccoder/Agent.vala` (copy from CodeAssistantHandler.vala, update namespace and class name)
10. ✅ Add all new files to meson.build (keep old files in build too)
11. ✅ Update valadoc meson configuration to include new files (keep old files too)
12. ✅ Build and verify compilation succeeds (both old and new code exist)

**Deliverable**: New files exist alongside old ones, build succeeds with both.

### Phase 2: Replace All References and Remove Old Files from Build

**Goal**: Update all code to use new namespaces/classes, remove old files from build system.

**Tasks:**
1. ✅ Update all imports from `OLLMchat.Prompt.*` to `OLLMchat.Agent.*`
2. ✅ Update all imports from `OLLMcoder.Prompt.*` to `OLLMcoder.*`
3. ✅ Replace `BaseAgent` → `Factory` throughout codebase
4. ✅ Replace `AgentHandler` → `Base` throughout codebase
5. ✅ Replace `JustAsk` (factory) → `JustAskFactory` throughout codebase
6. ✅ Replace `create_handler()` → `create_agent()` throughout codebase
7. ✅ Replace `agent` property → `factory` property in Base class usage
8. ✅ Replace `CodeAssistant` (factory) → `AgentFactory` in liboccoder
9. ✅ Replace `CodeAssistantHandler` → `Agent` in liboccoder
10. ✅ Remove old files from meson.build
11. ✅ Update valadoc meson configuration to remove old files and ensure new files are included
12. ✅ Build and verify everything compiles
13. ✅ Test functionality (agents work correctly)

**Deliverable**: All code uses new namespaces, old files removed from build, functionality verified.

### Phase 3: Delete Old Files

**Goal**: Clean up by deleting old files completely.

**Tasks:**
1. ✅ Delete `libollmchat/Prompt/BaseAgent.vala`
2. ✅ Delete `libollmchat/Prompt/AgentHandler.vala`
3. ✅ Delete `libollmchat/Prompt/JustAsk.vala`
4. ✅ Delete `libollmchat/Prompt/CodeAssistant.vala` (legacy/unused)
5. ✅ Delete `libollmchat/Prompt/AgentInterface.vala` (legacy/unused)
6. ✅ Delete `libollmchat/Prompt/CodeAssistantDummy.vala` (legacy/unused)
7. ✅ Delete `liboccoder/Prompt/CodeAssistant.vala`
8. ✅ Delete `liboccoder/Prompt/CodeAssistantHandler.vala`
9. ✅ Delete `liboccoder/Prompt/CodeAssistantProvider.vala`
10. ✅ Final build and test

**Deliverable**: Old files deleted, only new structure remains.

## Files to Create (Phase 1)

**libollmchat/Agent/**
- `Factory.vala` (copy from BaseAgent.vala)
- `Base.vala` (copy from AgentHandler.vala)
- `JustAskFactory.vala` (copy from JustAsk.vala)
- `JustAsk.vala` (NEW)

**liboccoder/**
- `AgentFactory.vala` (copy from Prompt/CodeAssistant.vala)
- `Agent.vala` (copy from Prompt/CodeAssistantHandler.vala)

## Files to Update (Phase 2)

All files that reference:
- `OLLMchat.Prompt.BaseAgent` → `OLLMchat.Agent.Factory`
- `OLLMchat.Prompt.AgentHandler` → `OLLMchat.Agent.Base`
- `OLLMchat.Prompt.JustAsk` → `OLLMchat.Agent.JustAskFactory`
- `OLLMcoder.Prompt.CodeAssistant` → `OLLMcoder.AgentFactory`
- `OLLMcoder.Prompt.CodeAssistantHandler` → `OLLMcoder.Agent`
- `create_handler()` → `create_agent()`
- `agent` property → `factory` property

## Files to Delete (Phase 3)

**libollmchat/Prompt/**
- `BaseAgent.vala`
- `AgentHandler.vala`
- `JustAsk.vala`
- `CodeAssistant.vala` (legacy)
- `AgentInterface.vala` (legacy)
- `CodeAssistantDummy.vala` (legacy)

**liboccoder/Prompt/**
- `CodeAssistant.vala`
- `CodeAssistantHandler.vala`
- `CodeAssistantProvider.vala`

## Testing Checklist

### Phase 1 Testing
- [x] New files created and compile successfully
- [x] Old files still compile (both exist in build)
- [x] No duplicate symbol errors
- [x] Build succeeds with both old and new code

### Phase 2 Testing
- [ ] All imports updated to new namespaces
- [ ] All references updated (`BaseAgent` → `Factory`, etc.)
- [ ] Old files removed from build
- [ ] Build succeeds with only new code
- [ ] Factory creates agents correctly
- [ ] JustAskFactory creates JustAsk agents correctly
- [ ] AgentFactory creates Agent instances correctly
- [ ] Context provider methods work in AgentFactory
- [ ] System prompt regeneration works in Agent
- [ ] All functionality works correctly

### Phase 3 Testing
- [x] Old files deleted
- [x] Build succeeds
- [x] Final functionality test passes
- [x] No references to old files remain

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md) - Parent plan
- [1.2.7.8. Cleanup Items](./1.2.7.8-cleanup-items.md) - Related cleanup item
