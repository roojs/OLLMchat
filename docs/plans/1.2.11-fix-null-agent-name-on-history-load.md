# 1.2.11 Fix Null Agent Name on History Load

## Problem

When loading a session from history, the error occurs:
```
Error: Invalid request: Agent '(null)' not found in manager. Please check your
```

This happens because `agent_name` can be `null` or empty when deserializing from JSON/database, but the code doesn't handle this case properly.

## Root Cause

**Investigation needed**: The `agent_name` property is non-nullable (`string`, not `string?`) with `default = "just-ask"`, so it cannot be null from deserialization.

**Database storage**: Yes, the database stores `agent_name`:
- Column: `agent_name TEXT NOT NULL DEFAULT 'just-ask'` (Session.vala line 240)
- ALTER TABLE exists to add column for older databases (line 251)
- Loaded via `SQ.Query` in `Manager.load_sessions()` (line 301-304)
- Also stored in JSON and copied from JSON when loading (SessionPlaceholder line 120-123)

The error message "Agent '(null)' not found in manager" at line 473 suggests that the `agent_name` variable is null when the error is thrown.

**Possible causes to investigate**:

1. **SQ.Query mapping issue**: Check if `SQ.Query` is properly mapping the `agent_name` column from database to the property
2. **Database column missing**: Very old databases might not have the column (though ALTER TABLE should add it)
3. **Line 468**: `var agent_name = this.agent_name == "" ? "just-ask" : this.agent_name;`
   - If `this.agent_name` is null (which shouldn't be possible), `agent_name` would be null
4. **Timing issue**: Check if `ensure_agent_handler()` is called before database/JSON loading completes
5. **Error message source**: Verify the error is actually coming from line 473 and not from another location (line 501 in `activate_agent()`)

**EmptySession creation**: When creating EmptySession:
- `Manager.create_new_session()` (line 268): **YES** - Sets `agent_name` from current session or defaults to "just-ask"
- `ChatWidget.start_new_chat_with_text()` (line 393-394): **YES** - Sets `agent_name` from current session if not empty
- `Manager` constructor (line 154): **NO** - Relies on default value "just-ask" from SessionBase

**Session creation from SessionPlaceholder**: When loading history (SessionPlaceholder.load() line 74):
- Creates Session with `agent_name = this.agent_name` (from SessionPlaceholder)
- SessionPlaceholder gets `agent_name` from database via `SQ.Query`
- If database column is missing or returns null, `this.agent_name` on SessionPlaceholder might be null/empty
- Then when Session is created, it gets that null/empty value
- When `ensure_agent_handler()` is called, line 468 checks `this.agent_name == ""` but if it's null, `agent_name` becomes null

**Next steps**: 
- Add debug logging to print `this.agent_name` and `agent_name` values at line 468
- Use gdb to break on line 473 and inspect the `agent_name` variable
- Check if `SQ.Query` is properly loading `agent_name` from the database when creating SessionPlaceholder
- Verify the database column exists and has data
- Check if Session is created from SessionPlaceholder with agent_name properly set

## Solution

Add null/empty checks in three places:

### Fix `Session.ensure_agent_handler()`

**File**: `libollmchat/History/Session.vala` (line 467-468)

**Current**:
```vala
// Get agent name (default to "just-ask" if not set)
var agent_name = this.agent_name == "" ? "just-ask" : this.agent_name;
```

**Problem**: If `this.agent_name` is `null` (which can happen during JSON deserialization), then `agent_name` becomes `null`, causing the error.

**Fix**: Add null check:
```vala
// Get agent name (default to "just-ask" if not set or null)
var agent_name = (this.agent_name == null || this.agent_name == "") ? "just-ask" : this.agent_name;
```

## Implementation Steps

1. **Fix Session.ensure_agent_handler()** - Add null check at line 468 to handle when `this.agent_name` is null

## Testing

1. Load an old session from history that doesn't have `agent_name` set
2. Load a session where `agent_name` is `null` in the JSON
3. Load a session where `agent_name` is empty string `""`
4. Verify all cases default to "just-ask" agent without errors

## Files to Modify

- `libollmchat/History/Session.vala` - Fix `ensure_agent_handler()` method (line 468)

