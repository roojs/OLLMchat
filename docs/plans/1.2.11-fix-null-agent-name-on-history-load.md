# 1.2.11 Fix Null Agent Name on History Load

## Problem

When loading a session from history or creating a new empty session, the error occurs:
```
Error: Invalid request: Agent '(null)' not found in manager. Please check your
```

This happens when `agent_name` is null in the Session/EmptySession, causing `ensure_agent_handler()` to fail.

## Problem Situations

### Situation 1: User Clicks on History Item

**Flow**:
1. User clicks on history item in `HistoryBrowser`
2. `HistoryBrowser.session_selected` signal emitted (HistoryBrowser.vala line 43)
3. `Window.vala` line 446-448: `chat_widget.switch_to_session.begin(session)`
4. `ChatWidget.switch_to_session()` (line 185): calls `manager.switch_to_session(session)`
5. `Manager.switch_to_session()` (line 220): calls `session.load()`
6. If `session` is `SessionPlaceholder`:
   - `SessionPlaceholder.load()` (line 65): Creates new `Session` with `agent_name = this.agent_name` (line 74)
   - If `this.agent_name` on SessionPlaceholder is null (from database), new Session gets null
7. `Manager.switch_to_session()`: Sets `this.session = loaded_session` and calls `loaded_session.activate()`
8. `Session.activate()` (SessionBase line 193): Sets `is_active = true` (does NOT create agent)
9. User sends message: `Session.send()` (line 569) calls `ensure_agent_handler()`
10. `Session.ensure_agent_handler()` (line 455): Uses `this.agent_name` which is null → error

### Situation 2: User Clicks + Button to Create New Session

**Flow**:
1. User clicks `+` button in header bar
2. `Window.vala` line 96-98: `new_chat_button.clicked` → `history_manager.create_new_session()`
3. `Manager.create_new_session()` (line 254):
   - Gets `agent_name` from current session or defaults to "just-ask" (line 257-260)
   - Creates `EmptySession` (line 263)
   - Sets `empty_session.agent_name = agent_name` (line 268)
4. `Window.vala`: `chat_widget.switch_to_session.begin(new_session)`
5. `ChatWidget.switch_to_session()`: calls `manager.switch_to_session(empty_session)`
6. `Manager.switch_to_session()`: calls `empty_session.load()` 
   - `EmptySession.load()` (line 89): Returns `this` (no-op, line 92)
7. `Manager.switch_to_session()`: Sets `this.session = empty_session` and calls `empty_session.activate()`
8. `EmptySession.activate()` (SessionBase line 193): Sets `is_active = true` (does NOT create agent)
9. User sends message: `EmptySession.send()` (line 62) creates new `Session` with `agent_name = this.agent_name` (line 66)
   - If `this.agent_name` on EmptySession is null, new Session gets null
10. `Session.send()` (line 569) calls `ensure_agent_handler()` (line 581)
11. `Session.ensure_agent_handler()` (line 455): Uses `this.agent_name` which is null → error

## Root Cause

**Investigation needed**: The `agent_name` property is non-nullable (`string`, not `string?`) with `default = "just-ask"`, so it cannot be null from deserialization.

**Database storage**: Yes, the database stores `agent_name`:
- Column: `agent_name TEXT NOT NULL DEFAULT 'just-ask'` (Session.vala line 240)
- ALTER TABLE exists to add column for older databases (line 251)
- Loaded via `SQ.Query` in `Manager.load_sessions()` (line 301-304)
- Also stored in JSON and copied from JSON when loading (SessionPlaceholder line 120-123)

The error message "Agent '(null)' not found in manager" at line 473 suggests that the `agent_name` variable is null when the error is thrown.

**Possible causes to investigate**:

1. **SQ.Query mapping issue**: Check if `SQ.Query` is properly mapping the `agent_name` column from database to the property
2. **Database column missing**: Very old databases might not have the column (though ALTER TABLE should add it)
3. **Line 468**: `var agent_name = this.agent_name == "" ? "just-ask" : this.agent_name;`
   - If `this.agent_name` is null (which shouldn't be possible), `agent_name` would be null
4. **Timing issue**: Check if `ensure_agent_handler()` is called before database/JSON loading completes
5. **Error message source**: Verify the error is actually coming from line 473 and not from another location (line 501 in `activate_agent()`)

**EmptySession creation**: When creating EmptySession:
- `Manager.create_new_session()` (line 268): **YES** - Sets `agent_name` from current session or defaults to "just-ask"
- `ChatWidget.start_new_chat_with_text()` (line 393-394): **YES** - Sets `agent_name` from current session if not empty
- `Manager` constructor (line 154): **NO** - Relies on default value "just-ask" from SessionBase

**Session creation from SessionPlaceholder**: When loading history (SessionPlaceholder.load() line 74):
- Creates Session with `agent_name = this.agent_name` (from SessionPlaceholder)
- SessionPlaceholder gets `agent_name` from database via `SQ.Query`
- If database column is missing or returns null, `this.agent_name` on SessionPlaceholder might be null/empty
- Then when Session is created, it gets that null/empty value
- When `ensure_agent_handler()` is called, line 468 checks `this.agent_name == ""` but if it's null, `agent_name` becomes null

**Next steps**: 
- Add debug logging to print `this.agent_name` and `agent_name` values at line 468
- Use gdb to break on line 473 and inspect the `agent_name` variable
- Check if `SQ.Query` is properly loading `agent_name` from the database when creating SessionPlaceholder
- Verify the database column exists and has data
- Check if Session is created from SessionPlaceholder with agent_name properly set

## Solution

Add null/empty checks in three places:

### Fix `Session.ensure_agent_handler()`

**File**: `libollmchat/History/Session.vala` (line 467-468)

**Current**:
```vala
// Get agent name (default to "just-ask" if not set)
var agent_name = this.agent_name == "" ? "just-ask" : this.agent_name;
```

**Problem**: If `this.agent_name` is `null` (which can happen during JSON deserialization), then `agent_name` becomes `null`, causing the error.

**Fix**: Add null check:
```vala
// Get agent name (default to "just-ask" if not set or null)
var agent_name = (this.agent_name == null || this.agent_name == "") ? "just-ask" : this.agent_name;
```

## Implementation Steps

1. **Fix Session.ensure_agent_handler()** - Add null check at line 468 to handle when `this.agent_name` is null

## Testing

1. Load an old session from history that doesn't have `agent_name` set
2. Load a session where `agent_name` is `null` in the JSON
3. Load a session where `agent_name` is empty string `""`
4. Verify all cases default to "just-ask" agent without errors

## Files to Modify

- `libollmchat/History/Session.vala` - Fix `ensure_agent_handler()` method (line 468)

