# 2.6.1.2. File Monitor Support

## Overview

Implement filesystem monitoring using inotify to track file changes during command execution. This phase creates the monitoring infrastructure that will be used by overlay and backup systems in later phases.

## Status

‚è≥ **PLANNING** - Design phase.

## Prerequisites

- Phase 1 (2.6.1.1) must be completed
- See main plan: `2.6.1-code-exec-improvements.md` for general architecture

## Goals

1. Create `Monitor` class for inotify-based filesystem monitoring
2. Implement dynamic recursive directory monitoring
3. Track files/folders that were written/added during execution
4. Provide simple lists of changes (not detailed event logs)

## Implementation Details

### Files to Create

- `liboctools/RunCommand/Monitor.vala` - inotify-based filesystem change detection

### Monitor Class Design

- **Constructor**: Accept directory path to monitor
- **Method**: `start()` - Start monitoring
- **Method**: `stop()` - Stop monitoring and return change lists
- **Properties**:
  - `modified_files` - List of files that were modified
  - `new_files` - List of files that were created
  - `deleted_files` - List of files that were deleted
  - `new_directories` - List of directories that were created

### Dynamic Recursive Directory Monitoring

- Overlay upper directory starts empty (no subdirectories initially)
- When a directory creation event is detected:
  - Create a new monitor for the newly created directory
  - Track the new monitor in a list/map of active monitors
  - Recursively handle nested directory creation
- Keep track of all active monitors to stop them after execution

### Simple Change Tracking

- Maintain lists of files/folders that were written/added during execution
- Track files that were created/modified (add to list when detected)
- Track directories that were created (add to list when detected)
- No need to record all individual events - just maintain simple lists

### inotify Events

- Use `GLib.FileMonitor` for inotify integration (Vala-friendly API)
- Monitor for:
  - File creation (`G_FILE_MONITOR_EVENT_CREATED`)
  - File modification (`G_FILE_MONITOR_EVENT_CHANGED`)
  - File deletion (`G_FILE_MONITOR_EVENT_DELETED`)
  - Directory creation (`G_FILE_MONITOR_EVENT_CREATED` for directories)

## Implementation Tasks

- [ ] Create `Monitor` class
- [ ] Implement inotify monitoring on directory
- [ ] Set up dynamic recursive directory monitoring (create monitors for new directories)
- [ ] Track files/folders that were written/added during execution (simple lists)
- [ ] Handle directory creation events (create monitors for new directories)
- [ ] Keep track of all active monitors to stop them after execution
- [ ] Test inotify monitoring on empty directory
- [ ] Test dynamic directory creation and monitoring
- [ ] Test file creation/modification/deletion detection

## Testing

- Test inotify monitoring on empty directory
- Test dynamic directory creation and monitoring
- Test file creation/modification/deletion detection
- Test with rapid file changes
- Test with large numbers of files
- Test with deep directory structures

## Notes

- This phase only implements monitoring - no overlay or backup support yet
- Monitor will be integrated with overlay in Phase 3
- Change lists will be used for file copying in Phase 3

