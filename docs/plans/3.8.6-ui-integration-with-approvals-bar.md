# 3.8.6. UI Integration with Approvals Bar

## Overview

Integrate the Approvals widget (approvals bar) into the main UI and implement the necessary signals and handlers in occoder to support bidirectional communication between the approvals bar and the code editor. The approvals bar needs to know when files change, and occoder needs to handle requests from the approvals bar to open files.

## Status

⏳ **TODO** - To be implemented.

## Prerequisites

- Phase 3.8.3 must be completed (Approvals widget)
- Phase 3.8.5 must be completed (Approvals Widget Integration - box with buttons)

## Goals

1. Connect approvals bar to ProjectManager signals for file changes
2. Connect approvals bar file_selected signal to SourceView for opening files
3. Update approvals bar selection when active file changes
4. Ensure approvals bar visibility updates when ReviewFiles changes
5. Handle file opening requests from approvals bar

## Implementation Details

### Files to Modify

- `ollmapp/Window.vala` - Add approvals bar to UI and connect file_selected signal
- `liboccoder/Approvals.vala` - Connect to ProjectManager.active_file_changed internally

### Signal Flow

#### 1. File Change Notifications (ProjectManager → Approvals Bar)

**Purpose**: Notify approvals bar when the active file changes so it can update its selection internally.

**Signal**: `ProjectManager.active_file_changed(File? file)`

**Handler in Approvals Widget (Internal)**:
- Approvals widget listens to `ProjectManager.active_file_changed` signal internally
- When active file changes, check if the file is in ReviewFiles
- If file is in ReviewFiles, call `select_file(file)` to update selection (blocks handler, no signal emitted)
- If file is not in ReviewFiles, call `clear_selection()` internally
- This is handled entirely within the Approvals widget - no Window.vala involvement needed

**Implementation**:
```vala
// In Approvals.vala constructor, connect to ProjectManager signal
this.project_manager.active_file_changed.connect(this.on_active_file_changed);

// Private method in Approvals.vala
private void on_active_file_changed(OLLMfiles.File? file)
{
    var project = this.project_manager.active_project;
    if (file != null && project != null) {
        // Check if file is in ReviewFiles
        if (project.review_files.file_map.has_key(file.path)) {
            // File is in ReviewFiles: select it (blocks handler, no signal emitted)
            this.select_file(file);
        } else {
            // File is not in ReviewFiles: clear selection internally
            this.clear_selection();
        }
    } else {
        // No file active: clear selection internally
        this.clear_selection();
    }
}
```

**Notes**:
- `Approvals.select_file()` blocks the selection handler, so no `file_selected` signal is emitted
- `Approvals.clear_selection()` remains private (internal use only)
- Selection updates are handled internally by the Approvals widget
- No circular loops: `select_file()` blocks handler, so `file_selected` signal is not emitted

#### 2. File Opening Requests (Approvals Bar → SourceView)

**Purpose**: Allow approvals bar to request opening a file in the code editor when user clicks a file in the popover.

**Signal**: `Approvals.file_selected(File file)`

**Handler in Window.vala**:
- When user clicks a file in approvals bar popover, `file_selected` signal is emitted
- Window.vala connects to this signal and opens the file in SourceView
- Use `SourceView.open_file()` method to open the file

**Implementation**:
```vala
// In Window.vala, connect approvals bar signal to source view
this.approvals.file_selected.connect((file) => {
    // Open file in source view
    this.source_view.open_file.begin(file, null);
});
```

**Notes**:
- `SourceView.open_file()` is async, so use `.begin()` and `.end()` if needed
- The file will be opened in the code editor
- `SourceView.open_file()` calls `manager.activate_file(file)` which triggers `active_file_changed` signal
- Approvals widget listens to `active_file_changed` internally and updates selection (but blocks handler, so no loop)
- **Circular loop prevention**: When `active_file_changed` fires and calls `select_file()`, the handler is blocked, so `file_selected` signal is NOT emitted again

#### 3. ReviewFiles Changes (ReviewFiles → Approvals Bar)

**Purpose**: Update approvals bar visibility and selection when ReviewFiles list changes.

**Signal**: `ReviewFiles.items_changed(uint position, uint removed, uint added)`

**Handler in Approvals Bar**:
- Already implemented in Approvals widget (3.8.3)
- Updates button visibility based on ReviewFiles count
- May need to clear selection if selected file is removed from ReviewFiles

**Implementation**:
```vala
// In Approvals.vala (already implemented in 3.8.3)
this.review_files_handler_id = project.review_files.items_changed.connect(() => {
    this.update_button_visibility();
    // Check if selected file is still in ReviewFiles
    if (this.selected_file != null) {
        if (!project.review_files.file_map.has_key(this.selected_file.path)) {
            // Selected file was removed from ReviewFiles: clear selection
            this.clear_selection();
        }
    }
});
```

**Notes**:
- This is already partially implemented in Approvals widget
- May need to add selection clearing logic when file is removed

### Integration Points

#### 1. Window.vala Integration

**Add Approvals Bar to UI**:
- Add approvals bar to header bar or toolbar area
- Create Approvals widget with ProjectManager (widget handles its own signal connections internally)
- Connect only the `file_selected` signal to open files

**Example**:
```vala
// In Window.vala constructor
this.approvals = new OLLMcoder.Approvals(this.project_manager);

// Add to header bar (or appropriate location)
this.header_bar.pack_end(this.approvals);

// Connect only file_selected signal for opening files
// Approvals widget handles active_file_changed internally
this.approvals.file_selected.connect((file) => {
    // Open file in source view
    this.source_view.open_file.begin(file, null);
});
```

**Notes**:
- Window.vala does NOT need to connect to `active_file_changed` signal
- Approvals widget handles all internal selection updates itself
- Window.vala only needs to handle `file_selected` signal to open files

#### 2. SourceView Integration

**Current State**:
- `SourceView.open_file()` already calls `manager.activate_file(file)`
- This triggers `ProjectManager.active_file_changed` signal
- Approvals widget listens to this signal internally and updates selection
- No additional changes needed in SourceView

#### 3. Approvals Widget Updates

**Connect to ProjectManager.active_file_changed Internally**:
- Approvals widget should connect to `project_manager.active_file_changed` in constructor
- Handle selection updates internally when active file changes
- Keep `clear_selection()` private (internal use only)

**Implementation**:
```vala
// In Approvals.vala constructor, after project_manager is set
this.project_manager.active_file_changed.connect(this.on_active_file_changed);

// Private method in Approvals.vala
private void on_active_file_changed(OLLMfiles.File? file)
{
    var project = this.project_manager.active_project;
    if (file != null && project != null) {
        if (project.review_files.file_map.has_key(file.path)) {
            // File is in ReviewFiles: select it (blocks handler, no signal emitted)
            this.select_file(file);
        } else {
            // File is not in ReviewFiles: clear selection internally
            this.clear_selection();
        }
    } else {
        // No file active: clear selection internally
        this.clear_selection();
    }
}
```

**Update Selection on ReviewFiles Changes**:
- When ReviewFiles items change, check if selected file is still in list
- Clear selection if file was removed

**Implementation**:
```vala
// In Approvals.vala, update activate_project() or items_changed handler
this.review_files_handler_id = project.review_files.items_changed.connect(() => {
    this.update_button_visibility();
    
    // Check if selected file is still in ReviewFiles
    if (this.selected_file != null) {
        if (!project.review_files.file_map.has_key(this.selected_file.path)) {
            // Selected file was removed: clear selection internally
            this.clear_selection();
        }
    }
});
```

**Notes**:
- `clear_selection()` remains private (internal use only)
- All selection management is handled internally by Approvals widget
- No public API needed for selection management from Window.vala

### Signal Flow Diagram

```
┌─────────────────┐
│ ProjectManager  │
│                 │
│ active_file_    │──┐
│ changed()       │  │
└─────────────────┘  │
                     │
                     ▼
              ┌──────────────┐
              │ Approvals    │
              │ (internal)   │
              │              │
              │ on_active_   │
              │ file_changed │
              │              │
              │ select_file()│ (blocks handler)
              │ or           │
              │ clear_       │ (internal)
              │ selection()  │
              └──────────────┘

┌─────────────────┐
│ User clicks     │
│ file in popover │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Approvals       │
│                 │
│ file_selected() │──┐ (user action, not blocked)
│                 │  │
└─────────────────┘  │
                     │
                     ▼
              ┌──────────────┐
              │ Window.vala  │
              │              │
              │ file_selected│
              │ handler      │
              └──────┬───────┘
                     │
                     ▼
              ┌──────────────┐
              │ SourceView   │
              │              │
              │ open_file()  │
              └──────┬───────┘
                     │
                     ▼
              ┌──────────────┐
              │ ProjectManager│
              │              │
              │ activate_    │
              │ file()       │
              └──────┬───────┘
                     │
                     ▼
              ┌──────────────┐
              │ ProjectManager│
              │              │
              │ active_file_ │
              │ changed()    │──┐ (back to Approvals, but blocked)
              └──────────────┘  │
```

**Key Points**:
- Approvals widget listens to `active_file_changed` internally
- When `select_file()` is called programmatically, handler is blocked (no `file_selected` signal)
- When user clicks file, `file_selected` signal is emitted (not blocked)
- This prevents circular loops while maintaining bidirectional communication

## Implementation Tasks

### Approvals Widget Updates
- [ ] Connect to `ProjectManager.active_file_changed` signal in constructor
- [ ] Implement `on_active_file_changed()` private method:
  - Check if file is in ReviewFiles
  - Call `select_file(file)` if in ReviewFiles (blocks handler, no signal)
  - Call `clear_selection()` if not in ReviewFiles (internal)
- [ ] Keep `clear_selection()` private (internal use only)
- [ ] Update `items_changed` handler to clear selection when selected file is removed from ReviewFiles
- [ ] Test selection clearing when file is removed from ReviewFiles
- [ ] Test selection updates when active file changes (internal handling)

### Window.vala Integration
- [ ] Create Approvals widget instance with ProjectManager
- [ ] Add approvals bar to header bar (or appropriate UI location)
- [ ] Connect `Approvals.file_selected` signal to handler
- [ ] Implement handler to call `source_view.open_file.begin(file, null)`
- [ ] Test file opening when file is selected in approvals bar
- [ ] Verify Window.vala does NOT need to connect to `active_file_changed` (handled internally)

### Signal Flow Testing
- [ ] Test: Open file in code editor → approvals bar selection updates
- [ ] Test: Select file in approvals bar → file opens in code editor
- [ ] Test: Open file not in ReviewFiles → approvals bar selection clears
- [ ] Test: Remove file from ReviewFiles → approvals bar selection clears
- [ ] Test: Approve file → file removed from ReviewFiles → approvals bar updates
- [ ] Test: Revert file → file may be updated in ReviewFiles → approvals bar updates

### Edge Cases
- [ ] Test: No active project → approvals bar handles null gracefully
- [ ] Test: No active file → approvals bar selection clears
- [ ] Test: File deleted while selected → approvals bar handles gracefully
- [ ] Test: Project changes → approvals bar updates correctly
- [ ] Test: Multiple rapid file changes → approvals bar updates correctly

## Testing

### Signal Integration
- Test approvals bar appears in UI when ReviewFiles has items
- Test approvals bar hides when ReviewFiles is empty
- Test active file change updates approvals bar selection
- Test file selection in approvals bar opens file in code editor
- Test opening file not in ReviewFiles clears approvals bar selection
- Test removing file from ReviewFiles clears approvals bar selection

### Bidirectional Communication
- Test: Code editor file change → approvals bar updates
- Test: Approvals bar file selection → code editor opens file
- Test: Circular updates don't cause infinite loops
- Test: Selection blocking works correctly during programmatic updates

### ReviewFiles Integration
- Test: Approve file → removed from ReviewFiles → approvals bar updates
- Test: Revert file → file updated in ReviewFiles → approvals bar updates
- Test: File added to ReviewFiles → approvals bar shows it
- Test: File removed from ReviewFiles → approvals bar hides it

### Error Handling
- Test: File doesn't exist when opening → error handled gracefully
- Test: File not in ReviewFiles when selecting → handled gracefully
- Test: Null file handling → no crashes
- Test: Project changes during operation → handled gracefully

## Implementation Notes

### Signal Handler Blocking

The Approvals widget uses `blocking_selection_handler` to prevent infinite loops when programmatically updating selection. This is important when:
- `select_file()` is called from `active_file_changed` handler
- `clear_selection()` is called from `active_file_changed` handler

The selection handler checks this flag and returns early if blocked, preventing the `file_selected` signal from being emitted during programmatic updates.

### Circular Signal Prevention

To prevent circular updates:
1. **User clicks file in approvals popover** → `file_selected` signal emitted (not blocked) → Window.vala opens file → `activate_file()` → `active_file_changed` fires
2. **Approvals widget receives `active_file_changed`** → calls `select_file()` internally → handler is blocked → `file_selected` signal is NOT emitted again
3. **Result**: No circular loop - selection updates internally without emitting signals

The `blocking_selection_handler` flag in Approvals widget prevents infinite loops:
- When `select_file()` is called programmatically (from `active_file_changed`), handler is blocked
- When user clicks file in popover, handler is NOT blocked, so `file_selected` signal is emitted
- This maintains bidirectional communication without loops

### Selection State Management

The approvals bar maintains its own `selected_file` property, which may differ from the active file in ProjectManager:
- Active file: The file currently open in the code editor
- Selected file: The file selected in the approvals bar popover

These should be kept in sync:
- When active file changes → update selected file (if in ReviewFiles)
- When selected file changes → open file in code editor → update active file

### Visibility Management

The approvals bar visibility is managed by the Approvals widget itself:
- Shows when `review_files.get_n_items() > 0`
- Hides when `review_files.get_n_items() == 0`
- Updates automatically when ReviewFiles changes

No additional visibility management needed in Window.vala.

## Related Plans

- **3.8.3**: Approvals Widget (completed) - Basic widget with popover
- **3.8.5**: Approvals Widget Integration (TODO) - Convert to box with buttons
- **3.8.6**: UI Integration with Approvals Bar (this plan) - Signal integration and file opening
