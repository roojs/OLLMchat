# 3.8.2. ReviewFiles Class

## Overview

Create ReviewFiles collection class that tracks files needing approval. Similar to ProjectFiles but only contains File objects where `is_need_approval == true`.

## Status

‚è≥ **TODO** - To be implemented.

## Prerequisites

- Phase 3.8.1 must be completed (is_need_approval flag updates)

## Goals

1. Create ReviewFiles class implementing GLib.ListModel
2. Extract File objects from ProjectFiles (not store ProjectFiles)
3. Maintain list of files where `is_need_approval == true`
4. Provide standard signals like ProjectFiles (items_changed)
5. Integrate with Folder class (only for projects)

## Implementation Details

### File to Create

- `libocfiles/ReviewFiles.vala`

### Class Structure

```vala
namespace OLLMfiles
{
    /**
     * Manages files in a project that need approval (flat list for approvals UI).
     * 
     * Provides flat list of all files in project that need approval (is_need_approval == true).
     * Implements ListModel interface. Uses database ID for equality comparison.
     * Extracts File objects from ProjectFiles, doesn't store ProjectFiles.
     */
    public class ReviewFiles : Object, GLib.ListModel
    {
        /**
         * The ProjectFiles collection to extract files from.
         */
        private ProjectFiles project_files;
        
        /**
         * Backing store: ArrayList containing File objects.
         * Uses database ID for equality checks.
         */
        private Gee.ArrayList<File> items { get; set; 
            default = new Gee.ArrayList<File>((a, b) => {
                return a.id == b.id;
            });
        }
        
        /**
         * Hashmap of file path => File object for quick lookup.
         */
        public Gee.HashMap<string, File> file_map { get; private set;
            default = new Gee.HashMap<string, File>(); }
        
        /**
         * Emitted when items are added, removed, or changed.
         * Standard ListModel signal.
         */
        public signal void items_changed(uint position, uint removed, uint added);
        
        /**
         * Constructor.
         * 
         * @param project_files The ProjectFiles collection to extract files from
         */
        public ReviewFiles(ProjectFiles project_files)
        {
            this.project_files = project_files;
        }
        
        // ... methods ...
    }
}
```

### Methods

1. **ListModel Interface**:
   - `get_item_type()` - Return `typeof(File)`
   - `get_n_items()` - Return count of items
   - `get_item(uint position)` - Get File at position

2. **Update Method**:
   - `refresh()` - Scan project_files and update ReviewFiles:
     - Extract File objects from project_files where `is_need_approval == true`
     - Add files not already in ReviewFiles
     - Remove files where `is_need_approval == false` or no longer in project_files
     - Maintain order by `last_modified` timestamp (most recent first)
     - Emit `items_changed` signal when items are added/removed

3. **Helper Methods**:
   - `clear()` - Clear all items
   - `contains(File file)` - Check if file is in list
   - `get_by_path(string path)` - Get file by path

### Integration with Folder

**File**: `libocfiles/Folder.vala`

**Changes**:

1. Add property:
   ```vala
   /**
    * List of files that need approval (only for projects).
    */
   public ReviewFiles review_files { get; private set; }
   ```

2. Initialize when project_files is created (in constructor or when is_project is set):
   ```vala
   if (this.is_project) {
       this.review_files = new ReviewFiles(this.project_files);
   }
   ```

3. Update review_files after project_files is updated:
   - After `project_files.update_from()` calls: call `this.review_files.refresh()`
   - After EditMode completes: call `this.review_files.refresh()`
   - After RunCommand completes: call `this.review_files.refresh()`

## Implementation Tasks

- [ ] Create `libocfiles/ReviewFiles.vala` class
- [ ] Implement GLib.ListModel interface
- [ ] Add project_files parameter to constructor
- [ ] Add items ArrayList and file_map HashMap
- [ ] Implement `refresh()` method
- [ ] Extract File objects from project_files
- [ ] Sort by `last_modified` (descending)
- [ ] Emit `items_changed` signal when items added/removed
- [ ] Add `review_files` property to Folder class
- [ ] Initialize review_files with project_files in constructor
- [ ] Call `review_files.refresh()` after project_files updates
- [ ] Call `review_files.refresh()` after EditMode completes
- [ ] Call `review_files.refresh()` after RunCommand completes

## Testing

- Test ReviewFiles creation when project is created (with project_files parameter)
- Test ReviewFiles.refresh() extracts files correctly
- Test ReviewFiles only contains files where is_need_approval == true
- Test ReviewFiles removes files when is_need_approval becomes false
- Test ReviewFiles adds files when is_need_approval becomes true
- Test ReviewFiles maintains order by last_modified (descending)
- Test ReviewFiles.items_changed signal is emitted correctly
- Test ReviewFiles only exists for project folders
- Test ReviewFiles is empty when no files need approval
- Test ReviewFiles updates after scanner detects changes
- Test ReviewFiles updates after EditMode applies changes
- Test ReviewFiles updates after RunCommand modifies files
