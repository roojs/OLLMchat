# 1.12. URGENT - Replace Version Check for Connection Verification

## Overview

Replace the version endpoint check with a models endpoint check for connection verification. The version endpoint is not portable across different Ollama-compatible servers, while the models endpoint is more universally supported. This change will improve compatibility and provide better error messages when connections fail.

## Status

ðŸš¨ **URGENT** - In Progress

## Problem

The current connection verification uses the `/api/version` endpoint, which:
- Is not available on all Ollama-compatible servers
- May not be portable across different implementations
- Doesn't provide clear error messages when the endpoint is missing

## Solution

Keep the `version()` method and `Call.Version` class as-is (they are Ollama-specific), but change all callers to use `models()` endpoint for connection verification instead. The models endpoint is more portable across different Ollama-compatible servers.

- Keep `Client.version()` method unchanged (Ollama-specific)
- Document that `Call.Version` is Ollama-specific
- Change all callers to use `models()` instead of `version()` for connection verification
- The models endpoint validates that the response is valid JSON (even if empty)
- Update error messages to show "fetch returned 404" format

## Implementation Details

### Phase 1: Document Version as Ollama-Specific

#### Changes to `libollmchat/Call/Version.vala`
- Add documentation noting this is Ollama-specific and not available on all servers
- Keep implementation unchanged

### Phase 2: Update All Callers to Use models()

#### Changes to callers (use `models()` instead of `version()`):
- `ollmapp/SettingsDialog/ConnectionAdd.vala` - Change to `yield test_client.models()`
- `ollmapp/SettingsDialog/ConnectionsPage.vala` - Change to `yield test_client.models()`
- `ollmapp/SettingsDialog/MainDialog.vala` - Change to `yield test_client.models()`
- `libollmchat/Settings/Config2.vala` - Change `check_connections()` to use `models()`
- `examples/TestAppBase.vala` - Change to `yield test_client.models()`
- `examples/oc-test-cli.vala` - Change to `yield test_client.models()`
- `examples/VectorAppBase.vala` - Change to `yield test_client.models()`

Note: `models()` returns `Gee.ArrayList<Response.Model>` and validates JSON even if the list is empty

#### Changes to `libollmchat/Call/Base.vala`
- Update error messages to show "fetch returned 404" format instead of "HTTP error: 404"
- Ensure all HTTP error messages follow the pattern: "fetch returned {status_code}"

### Phase 3: Update Error Messages

#### Changes to `libollmchat/Call/Base.vala`
- Update error messages to show "fetch returned 404" format instead of "HTTP error: 404"
- Ensure all HTTP error messages follow the pattern: "fetch returned {status_code}"

### Phase 4: Validation

- Test with standard Ollama server
- Test with empty models list (should still validate as valid JSON)
- Test with 404 error (should show "fetch returned 404")
- Test with other HTTP errors (should show appropriate error messages)

## Related Plans

- **1.4** - Client Configuration Setup (uses version check)
- **1.5** - Model List Management (uses models endpoint)

## Files to Modify

1. `libollmchat/Call/Version.vala` - Add documentation noting Ollama-specific
2. `libollmchat/Call/Base.vala` - Update error message format to "fetch returned {status_code}"
3. `ollmapp/SettingsDialog/ConnectionAdd.vala` - Change to use `models()` instead of `version()`
4. `ollmapp/SettingsDialog/ConnectionsPage.vala` - Change to use `models()` instead of `version()`
5. `ollmapp/SettingsDialog/MainDialog.vala` - Change to use `models()` instead of `version()`
6. `libollmchat/Settings/Config2.vala` - Change `check_connections()` to use `models()`
7. `examples/TestAppBase.vala` - Change to use `models()` instead of `version()`
8. `examples/oc-test-cli.vala` - Change to use `models()` instead of `version()`
9. `examples/VectorAppBase.vala` - Change to use `models()` instead of `version()`

## Notes

- The `version()` method and `Call.Version` class remain unchanged (Ollama-specific)
- The models endpoint (`/api/tags`) returns a JSON object with a "models" array
- Even if the array is empty, valid JSON indicates a working connection
- Error messages should be user-friendly and indicate the specific HTTP status code (e.g., "fetch returned 404")
- All connection verification should use `models()` instead of `version()` for better portability
