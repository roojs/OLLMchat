# 1.2 Refactor Plan - Summary of Changes

## Problem Identified

The original 1.2.* plans (1.2.1, 1.2.2, 1.2.3) were structured as "big bang" changes that would leave the code in an unusable state after each step:

- **1.2.1**: Removing properties from Client first would break all code using `client.model`, `client.options`, etc.
- **1.2.2**: Removing signals first would break all code connecting to them
- **1.2.3**: Changing Call.Base to take Connection first would break all Call creation points

## Solution Implemented

Created an incremental "stride" approach that ensures code remains usable after each step:

1. **Add new code paths first** (make things support both old and new ways)
2. **Migrate call sites incrementally** (one file/feature at a time)
3. **Remove old code paths last** (only after all call sites are migrated)

## Documents Created/Updated

### New Document

1. **`1.2-incremental-refactor-strategy.md`**
   - Overall strategy document explaining the incremental approach
   - Three-phase plan: Add → Migrate → Remove
   - Migration checklist
   - Key principles

### Updated Documents

2. **`1.2-refactor-client-chat-relationship.md`**
   - Added warning about incremental implementation requirement
   - References the incremental strategy document

3. **`1.2.1-remove-config-from-client.md`**
   - Restructured into three phases:
     - **Phase 1**: Add real properties with fallback logic (backward compatible)
     - **Phase 2**: Migrate call sites incrementally
     - **Phase 3**: Remove old code paths
   - Each step leaves code in a usable state

4. **`1.2.2-remove-signals-from-client.md`**
   - Restructured into three phases:
     - **Phase 1**: Update all signal connections first (keep signals)
     - **Phase 2**: Remove signal emissions (keep definitions)
     - **Phase 3**: Remove signal definitions last
   - Ensures no code breaks during migration

5. **`1.2.3-update-call-base-connection.md`**
   - Restructured into three phases:
     - **Phase 1**: Add Connection support while keeping Client support
     - **Phase 2**: Migrate call sites incrementally
     - **Phase 3**: Remove Client support last
   - Uses overloaded constructors for backward compatibility

## Key Changes to Implementation Approach

### Before (Big Bang)
```
Step 1: Remove properties from Client
  → ❌ All code using client.model breaks immediately

Step 2: Update all call sites
  → ❌ Code is broken during migration
```

### After (Incremental)
```
Phase 1: Add real properties to Chat with fallback
  → ✅ Code still works (Chat can use real properties OR fall back to Client)

Phase 2: Migrate call sites one by one
  → ✅ Code still works (some use new way, some use old way)

Phase 3: Remove fallback logic
  → ✅ Code still works (all use new way)
```

## Benefits

1. **Incremental progress** - Can stop at any step and code still works
2. **Easier testing** - Each step can be tested independently
3. **Lower risk** - If something breaks, it's isolated to one file
4. **Easier review** - Smaller, focused changes are easier to review
5. **Gradual migration** - Can migrate one file at a time, test, then move on

## Next Steps

1. Review the incremental strategy document
2. Start with Phase 1 of 1.2.1 (add real properties with fallback)
3. Test after each step
4. Migrate call sites one by one (Phase 2)
5. Remove old code paths only after all migrations complete (Phase 3)

## Migration Order

The plans now specify a clear migration order:

1. **Client convenience methods** (simplest, isolated)
2. **Config2.create_chat()** (already uses explicit options)
3. **Analysis** (already uses explicit options)
4. **EmptySession.send_message()** (more complex)
5. **SessionPlaceholder** (more complex)
6. **Manager.new_client()** (more complex)
7. **AgentHandler** (most complex - has tools, signals)
8. **CodeAssistantHandler** (most complex - has tools, signals)

This ensures we tackle the simplest cases first and build up to the most complex.

