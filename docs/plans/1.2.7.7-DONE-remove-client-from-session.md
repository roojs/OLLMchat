# 1.2.7.7. Remove Client from Session

## Overview

Remove `client` property from `SessionBase` since AgentHandler can get connection from Manager or Session should have connection directly. This is the final tidy-up step after all signal migrations are complete.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md)

## Status

✅ **DONE** - Client property removed from SessionBase and config property removed from Client. All references updated to use alternative approaches.

## Goal

1. Remove `client` property from `SessionBase` and update all references to use alternative approaches (e.g., `session.manager.base_client.connection` or add `connection` property to Session).
2. Remove `config` property from `Client` and update all references to get config from Manager or Session instead.

## Prerequisites

- ✅ All signal migrations complete (Phases 1-5)
- ✅ All signal connections use Chat or direct method calls

## Implementation Steps

### Step 6.1: Remove Client Property from SessionBase

**Goal**: Remove `client` property from `SessionBase` since AgentHandler can get connection from Manager or Session should have connection directly.

**Changes**:
- Remove `public Client client { get; protected set; }` from `SessionBase`
- Remove `this.client = manager.new_client()` from `SessionBase` constructor
- Update `AgentHandler` to get connection from `session.manager.base_client.connection` or add `connection` property to Session
- Update all references to `session.client` to use alternative approach
- Remove `new_client()` method from Manager (or keep for backward compatibility during transition)

**Files to Modify**:
- `libollmchat/History/SessionBase.vala` - Remove `client` property and initialization
- `libollmchat/Prompt/AgentHandler.vala` - Update to get connection from session/manager instead of `session.client.connection`
- `libollmchat/History/Manager.vala` - Consider removing `new_client()` or keeping for compatibility
- All files that reference `session.client` - Update to use alternative approach

**Note**: This is a breaking change and should be done as the final step after all signal migrations are complete.

**Result**: Session no longer has `client` property, all references updated to use alternative approaches

### Step 6.2: Remove Config Property from Client

**Goal**: Remove `config` property from `Client` since config should be accessed from Manager or Session, not from Client.

**Changes**:
- Remove `public Settings.Config2? config { get; set; }` from `Client`
- Remove `Config2.create_client()` method and inline it at call sites:
  - Inline in `Manager` (line 138) - replace `app.config.create_client("default_model")` with direct lookup and Client creation
  - Inline in examples (`oc-test-cli.vala`, `TestAppBase.vala`) - replace `config.create_client("default_model")` with direct lookup and Client creation
- Remove `Config2.create_chat()` method (unused - never called in codebase)
- Update `ConnectionModels.refresh_connection()` to not set `config = this.config` on created clients (line 118)
- Update `CodebaseSearchTool` to get config from Manager/Session instead of `client.config`
- Update `GoogleSearchRequest` to get config from Manager/Session instead of `client.config`
- Update `BackgroundScan` to get config from Manager/Session instead of `embedding_client.config`
- Update any other code that accesses `client.config` to use alternative approach (e.g., `session.manager.config` or `manager.config`)
- Update example code (e.g., `VectorAppBase.tool_config_client()`) to not set config on created clients

**Files to Modify**:
- `libollmchat/Client.vala` - Remove `config` property
- `libollmchat/Settings/Config2.vala` - Remove `create_client()` method (lines 516-534) and `create_chat()` method (lines 548-567)
- `libollmchat/History/Manager.vala` - Inline `create_client()` logic at line 138 (lookup ModelUsage, get connection, create Client)
- `libollmchat/Settings/ConnectionModels.vala` - Update `refresh_connection()` to not set `config = this.config` on client (line 118)
- `examples/oc-test-cli.vala` - Inline `create_client()` logic at lines 146 and 213
- `examples/TestAppBase.vala` - Inline `create_client()` logic at lines 172 and 239
- `libocvector/Tool/CodebaseSearchTool.vala` - Update to get config from Manager/Session instead of `client.config`
- `liboctools/GoogleSearchRequest.vala` - Update to get config from Manager/Session instead of `client.config`
- `libocvector/BackgroundScan.vala` - Update to get config from Manager/Session instead of `embedding_client.config`
- `examples/VectorAppBase.vala` - Update `tool_config_client()` to not set config on client (line 139)
- All files that reference `client.config` - Update to use alternative approach

**Note**: Config should be accessed from Manager (e.g., `session.manager.config` or `manager.config`), not from Client. Client should only hold connection information.

**Inlining Pattern**: Replace `config.create_client("default_model")` with:
```vala
var model_usage = config.usage.get("default_model") as Settings.ModelUsage;
if (model_usage == null || model_usage.connection == "" || 
    !config.connections.has_key(model_usage.connection)) {
    // Handle error
}
var client = new Client(config.connections.get(model_usage.connection));
```

**Result**: Client no longer has `config` property, all references updated to get config from Manager/Session

## Files to Modify

### For Step 6.1 (Remove Client from Session):
- `libollmchat/History/SessionBase.vala` - Remove `client` property and initialization
- `libollmchat/Prompt/AgentHandler.vala` - Update to get connection from session/manager
- `libollmchat/History/Manager.vala` - Consider removing `new_client()` or keeping for compatibility
- All files that reference `session.client` - Update to use alternative approach

### For Step 6.2 (Remove Config from Client):
- `libollmchat/Client.vala` - Remove `config` property
- `libollmchat/Settings/Config2.vala` - Remove `create_client()` method (lines 516-534) and `create_chat()` method (lines 548-567)
- `libollmchat/History/Manager.vala` - Inline `create_client()` logic at line 138
- `libollmchat/Settings/ConnectionModels.vala` - Update `refresh_connection()` to not set `config = this.config` on client (line 118)
- `examples/oc-test-cli.vala` - Inline `create_client()` logic at lines 146 and 213
- `examples/TestAppBase.vala` - Inline `create_client()` logic at lines 172 and 239
- `libocvector/Tool/CodebaseSearchTool.vala` - Update to get config from Manager/Session instead of `client.config`
- `liboctools/GoogleSearchRequest.vala` - Update to get config from Manager/Session instead of `client.config`
- `libocvector/BackgroundScan.vala` - Update to get config from Manager/Session instead of `embedding_client.config`
- `examples/VectorAppBase.vala` - Update `tool_config_client()` to not set config on client (line 139)
- All files that reference `client.config` - Update to use alternative approach

## Testing Checklist

### For Step 6.1 (Remove Client from Session):
- [x] SessionBase no longer has `client` property
- [x] AgentHandler gets connection from session/manager without requiring session.client
- [x] All references to `session.client` updated to use alternative approach
- [x] All functionality still works correctly
- [x] No regressions in agent or non-agent usage

### For Step 6.2 (Remove Config from Client):
- [x] Client no longer has `config` property
- [x] Config2.create_client() method removed and inlined at call sites
- [x] Config2.create_chat() method removed (unused)
- [x] Manager inlines create_client() logic to create base_client
- [x] Examples inline create_client() logic
- [x] CodebaseSearchTool gets config from Manager/Session instead of client.config
- [x] GoogleSearchRequest gets config from Manager/Session instead of client.config
- [x] BackgroundScan gets config from Manager/Session instead of embedding_client.config
- [x] All references to `client.config` updated to use alternative approach (e.g., `session.manager.config` or `manager.config`)
- [x] All functionality still works correctly
- [x] No regressions in tool usage or vector operations

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md) - Parent plan
- [1.2.7.6. Remove Signals from Client](./1.2.7.6-DONE-remove-signals-from-client.md) - Previous phase
- [1.2.7.8. Cleanup Items](./1.2.7.8-cleanup-items.md) - Next phase
- [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md) - Grandparent plan

