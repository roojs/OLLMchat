# 1.2.6.4. Update VectorBuilder

## Overview

Update VectorBuilder to take `ModelUsage` instead of `Client`.

**Parent Plan**: [1.2.6. Update Legacy Methods](./1.2.6-update-legacy-methods.md)

**Prerequisite**: [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) must be complete

## Status

‚è≥ **TODO** - Needs implementation.

## Goal

VectorBuilder should not depend on `Client` with config. According to plan 1.2, Manager owns the config, not Client. Using `ModelUsage` is more consistent with the rest of the codebase (SessionBase, AgentHandler, etc.) and bundles connection, model, and options together.

## Current Implementation

**File**: `libocvector/Indexing/VectorBuilder.vala` (line 106)

```vala
public VectorBuilder(OLLMchat.Client client, Database database, SQ.Database sql_db)
{
    this.client = client;
    // ...
}
// ...
var model = this.client.config.get_default_model();
var embed_response = yield this.client.embed_array(model, documents);
```

**Problem**: VectorBuilder takes `Client` but should take `ModelUsage` (which contains connection, model, and options).

## Proposed Fix

```vala
private Settings.ModelUsage model_usage;
private Settings.Connection connection;

public VectorBuilder(Settings.ModelUsage model_usage, Settings.Connection connection, Database database, SQ.Database sql_db)
{
    this.model_usage = model_usage;
    this.connection = connection;  // Resolved connection object (caller resolves from model_usage.connection key)
    this.database = database;
    this.sql_db = sql_db;
    
    // Initialize SQL schema if needed
    VectorMetadata.initDB(sql_db);
}

public async void process_file(Tree tree) throws GLib.Error
{
    // ... prepare documents ...
    
    // Create client from connection (no config - Manager owns config)
    var client = new Client(this.connection);
    // Pass model and options from ModelUsage
    var embed_response = yield client.embed_array(
        this.model_usage.model, 
        documents,
        -1,  // dimensions (default)
        false,  // truncate (default)
        this.model_usage.options  // Use options from ModelUsage
    );
    
    // ... rest of implementation ...
}
```

**Note**: 
- VectorBuilder takes both `ModelUsage` (for model and options) and resolved `Connection` object
- The caller (e.g., Indexer) resolves the connection from `model_usage.connection` key via config before creating VectorBuilder
- This approach keeps VectorBuilder simple (no config dependency) while using `ModelUsage` for consistency with the rest of the codebase

## Implementation Steps

1. Update `VectorBuilder` constructor to take `ModelUsage` and resolved `Connection`
2. Update `process_file()` method to:
   - Create Client from Connection (no config)
   - Use `model_usage.model` for embed_array call
3. Update `Indexer` to:
   - Take `ModelUsage` for embed instead of `Client`
   - Resolve connection from `model_usage.connection` key via config
   - Pass both `ModelUsage` and resolved `Connection` to VectorBuilder
4. Find all other call sites of VectorBuilder constructor and update them
5. Test that vector building still works

## Test

Verify vector building still works for code indexing.

## Result

VectorBuilder uses `ModelUsage` (consistent with SessionBase and other parts of codebase) and no longer depends on Client with config.

## Files to Modify

- `libocvector/Indexing/VectorBuilder.vala` - Update constructor to take `ModelUsage`, update `process_file()` method to create Client from connection
- `libocvector/Indexing/Indexer.vala` - Update to pass `ModelUsage` instead of `Client` to VectorBuilder
- Find and update all VectorBuilder constructor call sites (e.g., examples, tools)

## Related Plans

- [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) - Prerequisite

