# 1.3.8. Temporary Model Creation and Deletion

## Overview

Implementation of temporary model creation and deletion system for handling custom `num_ctx` settings. When users configure a model with a custom context window size, we need to create temporary model variants using Ollama's `create` API since `num_ctx` cannot be set via API options alone.

## Status

‚è≥ **TODO** - To be implemented.

## Related Plans

- **1.3.6** - Models Page (where model options including num_ctx are configured)
- **1.3.4** - Pulling Models (uses Ollama API for model operations)
- **1.5** - Model List Management

## Purpose

When users try to run a chat with a model that has a custom `num_ctx` setting, we need to create temporary model variants since `num_ctx` requires using Ollama's `create` API rather than just API options.

## Temp Model Creation

**When**: User tries to run a chat with a model that has a custom `num_ctx` setting

**Process**:
1. Check if temp model exists at `ollmchat-temp/{model-name}-oc{ctx_value}` (e.g., `ollmchat-temp/llama3-oc4096`)
2. If it doesn't exist, create it using Ollama's `create` API with the specified `num_ctx` value
3. Use this temporary model variant for the chat call
4. Temp model name format: `{model-name}-oc{ctx_value}` where ctx_value is the num_ctx setting

**Example**:
- Base model: `llama3`
- Custom num_ctx: `4096`
- Temp model name: `llama3-oc4096`
- Temp model path: `ollmchat-temp/llama3-oc4096`

## Temp Model Management

### Model Listings
- All model listings (from `Client.models()` and UI displays) must **always ignore** models in `ollmchat-temp` directory
- Temp models should never appear in the model selection UI
- Temp models are transparent to the user - they're created and used automatically

### Startup Cleanup
On application startup:
1. Check all models in `ollmchat-temp` directory
2. Check running processes (via `ps`) to see which ollmchat-temp models are currently in use
3. Delete all `ollmchat-temp` models that are **not** listed in running processes
4. This prevents accumulation of unused temporary model variants

### Lifecycle Management
- **Create**: When chat is initiated with custom num_ctx
- **Use**: Automatically used for chat calls when temp model exists
- **Cleanup**: On startup, remove unused temp models
- **Track**: Monitor which temp models are in active use

## Implementation Details

### Files to Create
- `libollmchat/Model/TempModelManager.vala` - Manages temp model lifecycle
  - `create_temp_model(string base_model, int num_ctx)` - Create temp model variant
  - `get_temp_model_name(string base_model, int num_ctx)` - Generate temp model name
  - `cleanup_unused_temp_models()` - Remove unused temp models on startup
  - `is_temp_model_in_use(string temp_model_name)` - Check if temp model is active
  - `get_temp_model_path(string temp_model_name)` - Get full path to temp model

### Files to Modify
- `libollmchat/Client.vala` - Integrate temp model creation before chat calls
  - Check if model has custom num_ctx
  - Create temp model if needed
  - Use temp model for chat call
- `libollmchat/Application.vala` - Add startup cleanup
  - Call `TempModelManager.cleanup_unused_temp_models()` on startup
- `libollmchat/Client.vala` - Filter temp models from model listings
  - Exclude `ollmchat-temp/` directory from model discovery

### API Integration
- Use Ollama's `POST /api/create` endpoint to create temp models
- Model creation requires:
  - Base model name (e.g., "llama3")
  - Modelfile with `PARAMETER num_ctx {ctx_value}`
  - Target model name (temp model name)

### Error Handling
- Handle cases where temp model creation fails
- Fall back to base model if temp model creation fails
- Log errors for debugging
- Show user-friendly error messages if needed

## Integration Points

- **Config2.model_options**: Source of custom num_ctx values
- **Client**: Chat call initiation point where temp model creation is triggered
- **Ollama API**: Model creation endpoint
- **Process Management**: Track active temp models via process monitoring

## Future Considerations

- **Model Variant Caching**: Cache frequently used temp models
- **Automatic Cleanup**: Periodic cleanup of unused temp models (not just on startup)
- **User Notification**: Optionally notify user when temp model is created
- **Temp Model Limits**: Limit number of temp models to prevent disk space issues

