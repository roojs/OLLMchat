# 1.3.7. Multiple Client Model Storage

## Overview

Create an `ConnectionModels` class (similar to `ProjectFiles`) that manages the list of available models from all configured connections. This class will be responsible for loading models from connections and can be used directly by dropdowns in the UI and configuration dialogs.

**Note**: This is different from the existing `AvailableModels` class which loads models from a cache/JSON file. This new class loads models directly from configured connections.

## Status

‚è≥ **TODO** - Feature to be implemented.

## Related Plans

- **1.3** - Configuration Overview
- **1.3.1** - Configuration Classes
- **1.3.2** - Configuration Interface
- **1.4** - Client Configuration Setup

## Implementation Details

### ConnectionModels Class

Similar to `ProjectFiles`, this class should:

- **Implement ListModel interface**: Can be used directly by dropdowns as a list store
- **Store model references**: Use `ModelUsage` objects to store references to models (connection, model name, options)
- **Internal storage**: Use `Gee.ArrayList` for the list and `Gee.HashMap` for quick lookups
- **Load all models**: Responsible for loading models from all configured connections (currently done in `ModelsPage` and `Model` widget)
- **Direct access**: Models can directly access the ArrayList

### Class Structure

```vala
public class ConnectionModels : Object, GLib.ListModel, Gee.Traversable<ModelUsage>, Gee.Iterable<ModelUsage>
{
    // Backing store: ArrayList containing ModelUsage objects
    private Gee.ArrayList<ModelUsage> items { get; set; }
    
    // Hashmap for quick lookup (e.g., connection_url#model_name => ModelUsage)
    public Gee.HashMap<string, ModelUsage> model_map { get; private set; }
    
    // Load models from all connections
    public async void load_all(Config2 config)
    
    // Load models from a specific connection
    public async void load_from_connection(string connection_url, Config2 config)
    
    // Get models for a specific connection
    public Gee.ArrayList<ModelUsage> get_models_for_connection(string connection_url)
    
    // ListModel interface methods
    public Type get_item_type() { return typeof(ModelUsage); }
    public uint get_n_items()
    public Object? get_item(uint position)
    
    // ListStore-compatible methods
    public void append(ModelUsage item)
    public void remove(ModelUsage item)
    public void remove_all()
    public bool contains(ModelUsage item)
}
```

### Responsibilities

This class will be responsible for:

1. **Loading models**: Fetch models from all configured connections (replaces current logic in `ModelsPage.render_models()` and `Model.load_models()`)
2. **Model storage**: Store model references using `ModelUsage` objects
3. **UI integration**: Can be used directly by dropdowns as a `ListModel` (replaces current `Gtk.StringList` usage)
4. **Configuration dialogs**: Used by `ModelConfigDialog` and other configuration dialogs for model selection

### Files to Create

- `libollmchat/Settings/ConnectionModels.vala` - ConnectionModels class (similar to ProjectFiles pattern)

### Files to Modify

- `ollmchat/SettingsDialog/Rows/Model.vala` - Use ConnectionModels instead of loading models directly
- `ollmchat/SettingsDialog/ModelsPage.vala` - Use ConnectionModels instead of managing models directly
- `ollmchat/SettingsDialog/ModelConfigDialog.vala` - Use ConnectionModels for model dropdown

### Implementation Notes

- Review how `ProjectFiles` implements `ListModel` and `Gee.Iterable` interfaces
- Models will be stored as `ModelUsage` objects (connection, model name, options)
- The class should handle loading models asynchronously from multiple connections
- Dropdowns can directly bind to this class as a `ListModel`
- Consider caching model lists per connection to avoid repeated API calls
- This replaces the current model loading logic in `ModelsPage.render_models()` and `Model.load_models()`

