# 1.3.7. Multiple Client Model Storage

## Overview

Create an `ConnectionModels` class (similar to `ProjectFiles`) that manages the list of available models from all configured connections. This class will be responsible for loading models from connections and can be used directly by dropdowns in the UI and configuration dialogs.

**Note**: This is different from the existing `AvailableModels` class which loads models from a cache/JSON file. This new class loads models directly from configured connections.

**Ownership**: `ConnectionModels` should be owned by `History.Manager` and accessed through it. Components that need to use it should get it from the history manager.

## Status

✅ **Phase 1 Complete** - ConnectionModels class created and integrated.

## Phase Checklist

### Phase 1: Create ConnectionModels Class ✅
- [x] Create `libollmchat/Settings/ConnectionModels.vala` class
- [x] Implement ListModel interface
- [x] Implement progressive refresh logic
- [x] Implement nested HashMap storage (`HashMap<connection_url, HashMap<model_name, ModelUsage>>`)
- [x] Add display methods to `libollmchat/Settings/ModelUsage.vala` (`display_name()`, `display_name_with_size()`)
- [x] Add `model_obj` field to `ModelUsage` to store `Response.Model` directly
- [ ] **Note**: Display methods (`display_markup()`) need sorting out later - removed from Response.Model, needs proper implementation
- [ ] **Note**: Connection filtering and sorting moved to UI layer (libollmchatgtk) - removed GTK-4 dependency from libollmchat

### Phase 2: Integration with Window and History Manager
- [ ] Add `connection_models` property to `libollmchat/History/Manager.vala`
- [ ] Create ConnectionModels instance in History.Manager constructor
- [ ] Update `ollmchat/Window.vala` to call `connection_models.refresh()` after connection validation

### Phase 3: Integration with ChatInput
- [ ] Replace `model_store` in `libollmchatgtk/ChatInput.vala` with ConnectionModels
- [ ] Update model dropdown to use ConnectionModels ListModel
- [ ] Use Response.Model objects from `response_model_map` for ChatInput display

### Phase 4: Integration with Settings Dialogs
- [ ] Update `ollmchat/SettingsDialog/Rows/Model.vala` to use ConnectionModels with connection filter
- [ ] Update `ollmchat/SettingsDialog/ModelsPage.vala` to use ConnectionModels
- [ ] Update `ollmchat/SettingsDialog/ModelConfigDialog.vala` to use ConnectionModels

## Related Plans

- **1.3** - Configuration Overview
- **1.3.1** - Configuration Classes
- **1.3.2** - Configuration Interface
- **1.4** - Client Configuration Setup

## Implementation Details

### ConnectionModels Class

Similar to `ProjectFiles`, this class should:

- **Implement ListModel interface**: Can be used directly by dropdowns as a list store
- **Store model references**: Use `ModelUsage` objects to store references to models (connection, model name, options)
- **Store Response.Model objects**: Also store the actual `Response.Model` objects for UI display (ChatInput needs these)
- **Internal storage**: Use `Gee.ArrayList` for the list and `Gee.HashMap` for quick lookups
- **Load all models**: Responsible for loading models from all configured connections (currently done in `ModelsPage` and `Model` widget)
- **Direct access**: Direct access to `items` ArrayList (no need for Traversable/Iterable interfaces)
- **Progressive updates**: When refreshing, add or remove missing models instead of clearing and reloading everything
- **Filtering**: Support filtering by connection URL
- **Sorting**: Provide default sorter that sorts by model family name (extracts family name from prefixed model names)
- **Display methods**: Provide methods to render model names for display in lists (factories will call these, no binding needed)

### Class Structure

```vala
public class ConnectionModels : Object, GLib.ListModel
{
    // Config2 instance (set via constructor)
    public Config2 config { get; construct; }
    
    // Backing store: ArrayList containing ModelUsage objects
    // Direct access to items (no need for Traversable/Iterable)
    public Gee.ArrayList<ModelUsage> items { get; private set; }
    
    // Hashmap for quick lookup (e.g., connection_url#model_name => ModelUsage)
    public Gee.HashMap<string, ModelUsage> model_map { get; private set; }
    
    // Hashmap for Response.Model objects (e.g., connection_url#model_name => Response.Model)
    // Used by ChatInput and other UI components that need full model details
    public Gee.HashMap<string, Response.Model> response_model_map { get; private set; }
    
    // Constructor
    public ConnectionModels(Config2 config)
    
    // Refresh models from all working connections (progressive update - adds/removes missing models)
    // Only processes connections where is_working = true
    public async void refresh()
    
    // Connection filter for filtering by connection URL
    // Returns Gtk.Filter that can be used with Gtk.FilterListModel
    public Gtk.Filter connection_filter(string connection_url)
    
    // Default sorter that sorts by model family name
    public Gtk.Sorter default_sorter()
    
    // ListModel interface methods
    public Type get_item_type() { return typeof(ModelUsage); }
    public uint get_n_items()
    public Object? get_item(uint position)
    
    // ListStore-compatible methods
    public void append(ModelUsage item)
    public void remove(ModelUsage item)
    public void remove_all()
    public bool contains(ModelUsage item)
}
```

### Responsibilities

This class will be responsible for:

1. **Loading models**: Fetch models from all working connections via `refresh()` using the Config2 instance from constructor (replaces current logic in `ModelsPage.render_models()` and `Model.load_models()`)
2. **Connection filtering**: Only processes connections where `is_working = true`, ignores non-working connections
3. **Progressive updates**: When `refresh()` is called, add new models and remove missing ones instead of clearing and reloading
4. **Model storage**: Store model references using `ModelUsage` objects
5. **Filtering**: Provide connection filter via `connection_filter()` that returns a `Gtk.Filter` for use with `Gtk.FilterListModel`
6. **Sorting**: Provide default sorter via `default_sorter()` that extracts family name from prefixed model names (e.g., "user/llama3" -> "llama3")
7. **UI integration**: Can be used directly by dropdowns as a `ListModel` (replaces current `Gtk.StringList` usage)
8. **Chat input**: Used by `ChatInput` model dropdown at the bottom of the window
9. **Configuration dialogs**: Used by `ModelConfigDialog` and other configuration dialogs for model selection

**Note**: Display methods (`display_name()`, `display_name_with_size()`, `display_markup()`) should be added to the `ModelUsage` class, not ConnectionModels. Factories can call these methods directly on ModelUsage objects.

## Implementation Phases

### Phase 1: Create ConnectionModels Class

**Files to Create:**
- `libollmchat/Settings/ConnectionModels.vala` - ConnectionModels class (similar to ProjectFiles pattern)

**Files to Modify:**
- `libollmchat/Settings/ModelUsage.vala` - Add display methods (`display_name()`, `display_name_with_size()`, `display_markup()`)

**Tasks:**
- Implement ConnectionModels class with ListModel interface
- Implement progressive refresh logic
- Implement connection filtering and sorting
- Add display methods to ModelUsage class

### Phase 2: Integration with Window and History Manager

**Files to Modify:**
- `libollmchat/History/Manager.vala` - Add `ConnectionModels` as a property, create it in constructor
- `ollmchat/Window.vala` - After connection validation at startup (version checks), call `connection_models.refresh()` to load all model data

**Tasks:**
- Add `connection_models` property to History.Manager
- Create ConnectionModels instance in History.Manager constructor
- Call `refresh()` from Window after connection validation completes

### Phase 3: Integration with ChatInput

**Files to Modify:**
- `libollmchatgtk/ChatInput.vala` - Use ConnectionModels from history manager for the model dropdown at the bottom (replaces current `model_store`)

**Tasks:**
- Replace current `model_store` with ConnectionModels from history manager
- Update model dropdown to use ConnectionModels ListModel
- Use Response.Model objects from `response_model_map` for ChatInput display

### Phase 4: Integration with Settings Dialogs

**Files to Modify:**
- `ollmchat/SettingsDialog/Rows/Model.vala` - Use ConnectionModels from history manager with connection filter instead of loading models directly
- `ollmchat/SettingsDialog/ModelsPage.vala` - Use ConnectionModels from history manager instead of managing models directly
- `ollmchat/SettingsDialog/ModelConfigDialog.vala` - Use ConnectionModels from history manager for model dropdown

**Tasks:**
- Replace direct model loading in Model widget with ConnectionModels filtered by connection
- Replace model management in ModelsPage with ConnectionModels
- Update ModelConfigDialog to use ConnectionModels for model selection

### Implementation Notes

- Review how `ProjectFiles` implements `ListModel` interface
- Constructor takes `Config2` object - no need to pass it to `refresh()` method
- **Avoid null checks**: Do not add null checks unless there is an absolutely valid reason why an object will be null. Null checks tend to hide bugs, which is why they're not put in the codebase. Only add null checks when explicitly required by the design.
- **Ownership**: `ConnectionModels` should be created and owned by `History.Manager`
- `History.Manager` should have a public property `connection_models` that exposes the ConnectionModels instance
- Components access ConnectionModels via `history_manager.connection_models` instead of creating their own instances
- **Startup sequence**: 
  - Window tests version on all connections at startup to verify they're working
  - After connection validation is complete, Window should call `connection_models.refresh()` to load all model data
- **Connection status**: `refresh()` should only process connections where `connection.is_working = true`, ignoring non-working connections
- **Connection observation**: The refresh logic should check `is_working` status for each connection before attempting to fetch models
- Direct access to `items` ArrayList and `response_model_map` HashMap (no Traversable/Iterable interfaces needed)
- Models will be stored as `ModelUsage` objects (connection, model name, options)
- Also store `Response.Model` objects in `response_model_map` for UI components that need full model details (like ChatInput)
- When loading models, create both ModelUsage and store the Response.Model object
- Access Response.Model objects directly via `response_model_map` using key format "connection_url#model_name"
- **Progressive updates**: When `refresh()` is called:
  - Only process connections where `connection.is_working = true`
  - Skip connections that are not working (don't attempt to fetch models from them)
  - Compare fetched models with existing models in the store
  - Add new models that don't exist
  - Remove models from connections that are no longer working or available
  - Don't clear and reload everything
- **Filtering**: `connection_filter()` returns a `Gtk.Filter` that filters by connection URL. Users wrap the ConnectionModels ListModel with `Gtk.FilterListModel`:
  ```vala
  var filter = connection_models.connection_filter(connection_url);
  var filtered = new Gtk.FilterListModel(connection_models, filter);
  ```
- **Sorting**: `default_sorter()` should extract family name from model names:
  - Split by "/" and use the second part if present (e.g., "user/llama3" -> "llama3")
  - Otherwise use the full name
  - Sort case-insensitively by family name
- **Display methods**: Should be added to `ModelUsage` class (not ConnectionModels):
  - `display_name()` - Returns just the model name
  - `display_name_with_size()` - Returns "model_name (size)" format (needs access to Response.Model from response_model_map)
  - `display_markup()` - Returns Pango markup for rich display (needs access to Response.Model from response_model_map)
  - These methods don't need property binding since model properties don't change after loading
  - Factories can call these methods directly on ModelUsage objects
- The class should handle loading models asynchronously from multiple connections
- Dropdowns can directly bind to this class as a `ListModel` or use filtered/sorted versions
- Consider caching model lists per connection to avoid repeated API calls
- This replaces the current model loading logic in:
  - `ModelsPage.render_models()` 
  - `Model.load_models()`
  - `ChatInput.update_models()` and `ChatInput.setup_model_dropdown()`

