# 2.20.9 Documentation Search Bugs

**Status:** ðŸ“‹ PLANNED

**Symptoms:** `oc-vector-search -c plans ...` can show File: (null) and assertion failures (`oll_mfiles_file_base_get_path: assertion 'self != NULL' failed`).

---

## Fixes (for approval)

1. **Empty filter â†’ no search, and say why**  
   When `filtered_vector_ids.size == 0`: (a) Donâ€™t run the searchâ€”return empty immediately (e.g. in `libocvector/Search/Search.vala` `execute()` at the start). (b) In the CLI/tool, before calling search (or when results are empty due to empty filter), output a clear message, e.g. **No document matches the criteria**, instead of continuing and showing a generic â€œNo results found.â€

2. **Propagate category to sections**  
   Category is set only on the document root; sections stay `""` and only section chunks are saved, so no DB row ever gets the generated category.  
   **Fix:** After `analyze_tree()` or at the start of `DocumentationVectorBuilder.process_file()`, set every elementâ€™s category from the document, e.g. `foreach (var el in tree.elements) { el.category = tree.category; }`. Then chunk metadata (and saved rows) get the documentâ€™s category.

3. **Category filter in SQL**  
   Restrict by category via file_id subquery:  
   `AND file_id IN (SELECT file_id FROM vector_metadata fvm WHERE fvm.category = $category)`  
   (So we only consider files that have at least one row with that category. Still need `element_type IN ('document','section')` and `file_id IN (file_id_list)`.)

4. **Category value / UX**  
   Optional: normalize `-c plans` â†’ `plan` when binding so the filter matches. Document valid values.

5. **Re-index for existing data**  
   If `vector_metadata` already has rows with `category = ''` (migration or pre-category indexer), re-index the docs so new rows get category written. No code change.

---

## Root cause (short)

- Category filter returns 0 vector_ids (e.g. `category = 'plans'` vs DB `'plan'`, or all rows have `category = ''` because we never wrote it to sections).
- With 0 filtered IDs we still call FAISS; null selector â†’ search all. We keep all results (post-filter only runs when `filtered_vector_ids.size > 0`).
- Those results can have `file_id` not in `file_id_list` â†’ file not in `project_files.items` â†’ `get_by_id()` returns null â†’ crash.

---

## Details (reference)

- **Where we look:** `SearchResult.file()` â†’ `folder.project_files.get_by_id(metadata.file_id)`; only searches `project_files.items`. Null if file not in items.
- **Filter build:** `file_id_list` = `get_ids("")` = IDs of files in `items` only (text files). SQL: `vector_id FROM vector_metadata WHERE file_id IN (file_id_list) AND category = $category AND element_type IN ('document','section')`.
- **Category flow:** DocumentationAnalysis sets `root_element.category` and `tree.category`; sections are created earlier with `category = ""` and never updated. VectorBuilder saves only leaf sections; chunk_meta copies `section.category` â†’ always `""`.
- **References:** `Search.vala` execute(), `DocumentationVectorBuilder.process_file()` / create_chunk_metadata(), `DocumentationAnalysis.analyze_document()`, `ProjectFiles.get_by_id()`.
