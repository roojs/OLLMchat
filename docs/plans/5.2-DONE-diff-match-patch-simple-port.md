# Port diff-match-patch to Vala (Simplified)

**STATUS: DONE**

This functionality has been implemented in `libocfiles/Diff/` with namespace `OLLMfiles.Diff`:
- `Patch.vala` - Patch class and PatchOperation enum
- `Differ.vala` - Patch creation class (equivalent to planned PatchCreator)
- `PatchApplier.vala` - Patch application class

**Note:** Implementation uses `Differ` class instead of `PatchCreator`, and is located in `libocfiles` rather than `liboccoder` as originally planned. The functionality matches the requirements with Myers diff algorithm and fuzzy matching support.

## Overview

Port a simplified version of the diff-match-patch library focused solely on patch creation and application. The API provides patches with line numbers that can be pure add, pure remove, or replace operations.

## Architecture

### Class Structure

The port will consist of three main classes:

1. **`PatchCreator`** - Creates patches from two text inputs
2. **`PatchApplier`** - Applies patches to text
3. **`Patch`** - Represents a single patch operation with line numbers

### File Organization

Create new files in `liboccoder/Diff/`:

- `Patch.vala` - Patch class and PatchOperation enum
- `PatchCreator.vala` - Patch creation class
- `PatchApplier.vala` - Patch application class
- Update `meson.build` to include new files

## Class Design

### 1. PatchOperation (Enum)

```vala
namespace OLLMcoder.Diff {
    public enum PatchOperation {
        ADD,      // Pure addition
        REMOVE,   // Pure removal
        REPLACE   // Remove + Add (replacement)
    }
}
```

### 2. Patch Class

Represents a patch with line numbers and operation type:

```vala
namespace OLLMcoder.Diff {
    /**
     * Represents a patch operation with line numbers.
     * 
     * Patches can be:
     * - ADD: Inserts new_lines at start_line
     * - REMOVE: Removes old_lines starting at start_line
     * - REPLACE: Removes old_lines and inserts new_lines at start_line
     */
    public class Patch : Object {
        public PatchOperation operation { get; set; }
        public int start_line { get; set; }
        public string[] old_lines { get; set; }
        public string[] new_lines { get; set; }
        
        public Patch(PatchOperation op, int start_line, string[] old_lines, string[] new_lines) {
            this.operation = op;
            this.start_line = start_line;
            this.old_lines = old_lines;
            this.new_lines = new_lines;
        }
    }
}
```

### 3. PatchCreator Class

Creates patches from two text inputs:

```vala
namespace OLLMcoder.Diff {
    /**
     * Creates patches from two text inputs.
     * 
     * Computes the differences between text1 and text2 and returns
     * a list of patches with line numbers.
     */
    public class PatchCreator : Object {
        // Configuration (optional, with defaults)
        public double diff_timeout { get; set; default = 1.0; }
        public int patch_margin { get; set; default = 4; }
        
        /**
         * Create patches from two texts.
         * 
         * @param text1 Original text
         * @param text2 Modified text
         * @return List of patches with line numbers
         */
        public Gee.ArrayList<Patch> create_patches(string text1, string text2);
        
        // Internal methods (private)
        private Gee.ArrayList<Diff> diff_main(string text1, string text2, bool check_lines, int64 deadline);
        private Gee.ArrayList<Diff> diff_compute(string text1, string text2, bool check_lines, int64 deadline);
        private int diff_common_prefix(string text1, string text2);
        private int diff_common_suffix(string text1, string text2);
        // ... other internal diff methods
    }
}
```

### 4. PatchApplier Class

Applies patches to text:

```vala
namespace OLLMcoder.Diff {
    /**
     * Applies patches to text.
     * 
     * Takes a list of patches and applies them to the given text,
     * returning the modified text.
     */
    public class PatchApplier : Object {
        // Configuration (optional, with defaults)
        public double match_threshold { get; set; default = 0.5; }
        public int match_distance { get; set; default = 1000; }
        public int match_max_bits { get; set; default = 32; }
        
        /**
         * Apply patches to text.
         * 
         * @param patches List of patches to apply
         * @param text Text to apply patches to
         * @return Modified text after applying patches
         * @throws Error if patch application fails
         */
        public string apply(Gee.ArrayList<Patch> patches, string text) throws Error;
        
        // Internal methods (private)
        private int match_main(string text, string pattern, int loc);
        private int match_bitap(string text, string pattern, int loc);
        // ... other internal match methods
    }
}
```

## Internal Diff Structure

Internally, the PatchCreator will use a simplified Diff class for algorithm implementation:

```vala
namespace OLLMcoder.Diff {
    // Internal use only
    private enum DiffOperation {
        DELETE = -1,
        EQUAL = 0,
        INSERT = 1
    }
    
    private class Diff : Object {
        public DiffOperation operation { get; set; }
        public string text { get; set; }
        
        public Diff(DiffOperation op, string text) {
            this.operation = op;
            this.text = text;
        }
    }
}
```

## Key Design Decisions

### 1. Line-Based Patches

- Patches work with line numbers (1-based for user-facing API)
- Text is split into lines for patch creation
- Patches contain arrays of lines (`string[]`) rather than single strings

### 2. Simplified Operations

- Only three operation types: ADD, REMOVE, REPLACE
- REPLACE combines remove+add into a single operation
- No need to expose diff operations to users

### 3. Separation of Concerns

- `PatchCreator` - Only creates patches, doesn't apply them
- `PatchApplier` - Only applies patches, doesn't create them
- Clear separation makes the API easier to understand

### 4. Internal Algorithms

- Keep diff algorithms internal to PatchCreator
- Keep match algorithms internal to PatchApplier
- Users don't need to know about diffs or matching

### 5. Collections

- Use `Gee.ArrayList<Patch>` for patch lists
- Use `string[]` for line arrays (native Vala arrays)
- Use `Gee.ArrayList<Diff>` internally for diff operations

### 6. Error Handling

- PatchApplier.apply() throws Error if application fails
- PatchCreator.create_patches() should not throw (always returns valid list, even if empty)

## Public API Summary

### Creating Patches

```vala
var creator = new PatchCreator();
var patches = creator.create_patches(original_text, modified_text);

// Patches contain:
// - operation: ADD, REMOVE, or REPLACE
// - start_line: Line number where patch applies (1-based)
// - old_lines: Lines to remove (empty for ADD)
// - new_lines: Lines to add (empty for REMOVE)
```

### Applying Patches

```vala
var applier = new PatchApplier();
string modified_text = applier.apply(patches, original_text);
```

## Implementation Details

### Patch Creation Flow

1. Split both texts into lines
2. Compute diff between line arrays using internal diff algorithm
3. Convert diffs to patches:

                                                - Group consecutive DELETE operations → REMOVE patch
                                                - Group consecutive INSERT operations → ADD patch
                                                - Group DELETE followed by INSERT → REPLACE patch

4. Calculate line numbers for each patch
5. Return list of patches

### Patch Application Flow

1. Split text into lines
2. For each patch:

                                                - Find location in text (using line numbers and fuzzy matching if needed)
                                                - Apply operation:
                                                                                - ADD: Insert new_lines at start_line
                                                                                - REMOVE: Remove old_lines starting at start_line
                                                                                - REPLACE: Remove old_lines, insert new_lines at start_line

3. Join lines back into text
4. Return modified text

## Removed Features

The following features from the original library are **not** included:

- HTML output (`diff_pretty_html`)
- Delta encoding (`diff_to_delta`, `diff_from_delta`)
- Levenshtein distance calculation
- Text extraction utilities (`diff_text1`, `diff_text2`)
- Patch serialization (`patch_to_text`, `patch_from_text`)
- Creating patches from diffs (`patch_make_from_diffs`)
- Direct diff operations (users only work with patches)
- Match operations (internal only)

## Implementation Phases

1. **Phase 1**: Create Patch class and PatchOperation enum
2. **Phase 2**: Implement internal Diff class and basic diff algorithm
3. **Phase 3**: Implement PatchCreator with patch creation logic
4. **Phase 4**: Implement PatchApplier with patch application logic
5. **Phase 5**: Implement match algorithm for fuzzy patch application
6. **Phase 6**: Update meson.build and integration
7. **Phase 7**: Testing

## Integration

- Add files to `liboccoder/meson.build`
- Use `OLLMcoder.Diff` namespace
- Follow existing code style (tabs for indentation, documentation comments)
- No new external dependencies (uses GLib/Gee only)