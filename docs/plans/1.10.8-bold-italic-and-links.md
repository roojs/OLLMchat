# Bold+Italic (1.10.8)

- **Bold+Italic:** We do not currently support `***bold italic***` / `___bold italic___`. The parser has `FormatType.BOLD_ITALIC` and `do_format` correctly calls `on_strong(true)`, `on_em(true)` and on close `on_em(false)`, `on_strong(false)`. The bug is in **MarkerMap.eat()**: when the loop consumes the whole chunk (e.g. `"***"`), it always returns `-1` if `!is_end_of_chunks`, so the 3‑char match is never committed and bold+italic never opens.

**Links** are covered in **plan 1.10.9** (parser) and **plan 1.10.10** (rendering).

**Status: open.**

---

## Part A: Bold+Italic (*** / ___)

### Goal

Support `***bold italic***` and `___bold italic___` so that opening and closing are recognized and the renderer receives `on_strong(true)`, `on_em(true)` and later `on_em(false)`, `on_strong(false)`.

### Root cause

In **libocmarkdown/MarkerMap.vala**, `eat()` builds the longest matching prefix in a loop. When the loop exits because `cp >= chunk.length` (end of chunk), the code does:

```vala
// Reached end of chunk
if (!is_end_of_chunks) {
    return -1;
}
return max_match_length;
```

So for `"***"` at the start of a chunk when more data may follow, `eat()` always returns `-1` and the parser defers the rest of the chunk; the 3‑char BOLD_ITALIC match is never applied.

### Fix (MarkerMap.eat)

After the loop, when we have reached the end of the chunk:

- If `is_end_of_chunks`: return `max_match_length` (current behaviour when at end of stream).
- If `!is_end_of_chunks` but the sequence we built is the **longest possible** for this marker (e.g. 3 characters for `*` and `_`), return `max_match_length` so we commit the match instead of deferring.
- Otherwise (e.g. `"**"` at end of chunk with more data coming) return `-1` so we can still see `"***"` in a later chunk.

Concretely: after the loop, keep a variable for the current sequence length (e.g. use `char_count` or `sequence.length`). Then:

- If `is_end_of_chunks`: `return max_match_length;`
- If `char_count >= 3`: `return max_match_length;` (no 4‑char format marker in FormatMap)
- Else: `return -1;`

So `"***"` always returns 3; `"**"` at end of chunk returns -1 until we see the next character or end of stream.

### Files (Part A)

| File | Change |
|------|--------|
| **libocmarkdown/MarkerMap.vala** | After the loop, when at end of chunk: if `is_end_of_chunks` return `max_match_length`; else if `char_count >= 3` return `max_match_length`; else return `-1`. |

### Verification

- Add or extend tests (e.g. in **examples/oc-test-gtkmd.vala** or parser tests) for `***bold italic***` and `___bold italic___` so that both open and close correctly and render as bold+italic.

---

## Dependencies

- None beyond current parser/renderer.

---

## Files to touch (summary)

| File | Change |
|------|--------|
| **libocmarkdown/MarkerMap.vala** | Fix end-of-chunk return for 3‑char match |
| **examples/oc-test-gtkmd.vala** or tests | Optional: bold+italic examples |

This plan gives a clear path to fix bold+italic (1.10.8). For links, see **plan 1.10.9** (parser) and **plan 1.10.10** (rendering).
