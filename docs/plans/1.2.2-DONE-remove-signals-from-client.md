# 1.2.2. Remove Unnecessary Signals from Client

## Overview

Remove synchronous state update signals from `Client`. Signals should only be used for truly asynchronous events that the caller cannot know about synchronously. The caller is responsible for updating state directly.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-DONE-refactor-client-chat-relationship.md)

## Status

✅ **COMPLETE** - All phases complete.

**Completed:**
- ✅ Phase 1: Update Signal Connections (all steps complete)
- ✅ Phase 2: Remove Signal Emissions (all steps complete, including Step 2.2: Tools add messages via Session)
- ✅ Phase 3: Remove Signal Definitions (all steps complete)

**Note on Soup Initialization**: When soup (Soup.Session) is added to Connection (or Base), it should be initialized immediately so it's never null. Soup should never be tested for null - it should always be initialized when added to base.

## Goal

Keep only asynchronous signals on Client. Remove signals for events that the caller knows about synchronously (e.g., "I called send()", "I created a message").

## Signals to Remove

### 1. `chat_send(Call.Chat)` Signal

- **Current**: Emitted when `chat.send()` is called
- **Remove**: Caller knows when they call `send()`, no signal needed
- **Impact**: Remove all connections to this signal
- **Replacement**: Caller updates state directly after calling `send()`

### 2. `message_created(Message, ChatContentInterface?)` Signal

- **Current**: Emitted when a message is created
- **Remove**: Caller creates messages, they know when
- **Impact**: Remove all connections to this signal
- **Replacement**: Caller updates state directly when creating messages

### 3. `stream_content(string, Response.Chat)` Signal

- **Current**: Emitted for streaming content chunks (not thinking)
- **Remove**: Redundant - `stream_chunk` has `is_thinking` parameter
- **Impact**: Remove all connections to this signal
- **Replacement**: Use `stream_chunk` with `is_thinking` check: `if (!is_thinking) { ... }`

## Signals to Keep Temporarily

These signals are kept on Client during the refactoring for backward compatibility, but will be moved to Chat in the final tidy-up step (see [1.2.7. Move Signals to Chat](./1.2.7-DONE-move-signals-to-chat.md)).

### 1. `stream_chunk(string, bool, Response.Chat)`

- **Keep Temporarily**: Asynchronous event - chunks arrive from HTTP stream
- **Future**: Will move to Chat in 1.2.7
- **Parameters**:
  - `string` - Chunk text (content or thinking)
  - `bool` - `true` if thinking, `false` if content (allows filtering)
  - `Response.Chat` - Response object with full state
- **Usage**: For non-agent usage (loosely coupled components)

### 2. `stream_start()`

- **Keep Temporarily**: Asynchronous event - streaming started (first chunk received)
- **Future**: Will move to Chat in 1.2.7
- **Usage**: For non-agent usage (loosely coupled components)

### 3. `tool_message(Message)`

- **Keep Temporarily**: Asynchronous event - tool status notifications
- **Future**: Will move to Chat in 1.2.7
- **Usage**: For non-agent usage (loosely coupled components)

**Note**: For agent usage, Chat calls handler methods directly (no signals). See [1.2. Refactor Client and Chat Relationship](./1.2-DONE-refactor-client-chat-relationship.md#signal-flow) for details. These signals will be moved to Chat in [1.2.7. Move Signals to Chat](./1.2.7-DONE-move-signals-to-chat.md) as the final tidy-up step.

## Implementation Strategy

**⚠️ CRITICAL**: This refactoring must be done incrementally to keep the code usable after each step. See [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md) for the overall approach.

**Key Principle**: Update all signal connections first, then remove signal emissions, then remove signal definitions.

## Implementation Steps

### Phase 1: Update Signal Connections (Keep Signals) ✅ COMPLETE

#### Step 1.1: Update `chat_send` Connections ✅

**Goal**: Update all code that connects to `chat_send` to handle state directly.

**Files to check**:
- `libollmchat/Prompt/AgentHandler.vala`
- `libollmchat/History/Manager.vala`
- `libollmchat/History/Session.vala`
- `libollmchatgtk/ChatWidget.vala`
- Any other UI or handler code

**For each connection**:
1. Remove the signal connection
2. Update caller to handle state directly after calling `send()`
3. Example: `ui.show_waiting_indicator()` after `yield chat.send()`

**Result**: Code no longer depends on `chat_send` signal, but signal still exists (for backward compatibility)

#### Step 1.2: Update `message_created` Connections ✅

**Goal**: Update all code that connects to `message_created` to handle state directly.

**Status**: ✅ Complete - Connections removed from SessionBase and RequestEditMode (with TODO for replacement mechanism)

**Files to check**:
- `libollmchat/Prompt/AgentHandler.vala`
- `libollmchat/History/Manager.vala`
- `libollmchat/History/Session.vala`
- `libollmchatgtk/ChatWidget.vala`
- Any other UI or handler code

**For each connection**:
1. Remove the signal connection
2. Update caller to handle state directly when creating messages
3. Example: `session.add_message(user_msg, chat)` after creating message

**Note**: Manager's `message_created` signal will be renamed to `add_message` in Step 2.2. UI code should connect to `manager.add_message` instead.

**Result**: Code no longer depends on Client's `message_created` signal, but Manager's `add_message` signal (renamed from `message_created`) still exists for UI connections

#### Step 1.3: Update `stream_content` Connections ✅

**Goal**: Update all code that connects to `stream_content` to use `stream_chunk` instead.

**Status**: ✅ Complete - All connections updated to use `stream_chunk` with `is_thinking` check

**Files to check**:
- `libollmchat/Prompt/AgentHandler.vala`
- `libollmchat/History/Manager.vala`
- `libollmchat/History/Session.vala`
- `libollmchatgtk/ChatWidget.vala`
- Any other UI or handler code

**For each connection**:
1. Remove the `stream_content` connection
2. Update to use `stream_chunk` with `is_thinking` check
3. Example: `client.stream_chunk.connect((text, is_thinking, response) => { if (!is_thinking) { ... } })`

**Result**: Code no longer depends on `stream_content` signal, but signal still exists (for backward compatibility)

### Phase 2: Remove Signal Emissions ✅ COMPLETE

#### Step 2.1: Remove Signal Emissions from Client ✅

**Goal**: Remove all signal emissions, but keep signal definitions (for now).

**Status**: ✅ Complete - All `chat_send()`, `message_created()`, and `stream_content()` emissions removed from Client and Call/Chat

**Changes**:
1. Find all `client.chat_send()` calls and remove
2. Find all `client.message_created()` calls and remove
3. Find all `client.stream_content()` calls and remove

**Files**:
- `libollmchat/Client.vala` - Remove signal emissions
- `libollmchat/Call/Chat.vala` - Remove signal emissions

**Result**: Signals are no longer emitted, but definitions still exist (for backward compatibility)

#### Step 2.2: Update Tools to Add Messages Directly to Session ✅

**Status**: ✅ Complete - Tools now add messages directly to session via Chat → Agent → Session path, and Session relays to UI via Manager's `add_message` signal with `SessionBase` parameter.

**Goal**: Tools should add messages directly to the session instead of emitting signals.

**Problem**: Tools have access to `chat_call` (Call.Chat) but not Session. They need a way to add messages to the session.

**Solution**: Add optional `agent` reference to `Call.Chat` (the handler, currently called AgentHandler):
1. Add `public Prompt.AgentHandler? agent { get; set; }` property to `Call.Chat`
   - Note: The handler is the real "agent" instance, while BaseAgent is the agent schema/template
2. Set `call.agent = this` in `AgentHandler` when creating Chat (in `send_message_async()`)
3. Tools can access session via `this.chat_call.agent.session` and add messages directly:
   ```vala
   if (this.chat_call.agent != null && this.chat_call.agent.session != null) {
       var ui_msg = new Message(this.chat_call, "ui", message);
       // Session.add_message() adds to messages array and relays to UI via Manager signal
       this.chat_call.agent.session.add_message(ui_msg);
   }
   ```
   
   The `session.add_message()` method:
   - Adds message to `session.messages` array
   - Relays to UI via `manager.add_message(message, this)` signal - passes session itself, not chat_call
   - Manager signal signature: `add_message(Message, SessionBase?)` - UI receives Session for accessing `session.client` and `session.chat`

**Files updated**:
- ✅ `libollmchat/Call/Chat.vala` - Added `agent` property (AgentHandler reference)
- ✅ `libollmchat/Prompt/AgentHandler.vala` - Set `call.agent = this` when creating Chat
- ✅ `liboccoder/Prompt/CodeAssistantHandler.vala` - Set `call.agent = this` when creating Chat
- ✅ `libollmchat/History/SessionBase.vala` - Added `add_message(Message)` method that adds to messages array and relays via Manager signal (passes `this` session)
- ✅ `libollmchat/History/Session.vala` - Updated `on_message_created()` to pass `this` session to manager signal
- ✅ `libollmchat/History/Manager.vala` - Renamed `message_created` signal to `add_message(Message, SessionBase?)` signal
- ✅ `libollmchatgtk/ChatWidget.vala` - Updated connection from `manager.message_created` to `manager.add_message`, updated handler to accept `SessionBase?`
- ✅ `libollmchatgtk/ChatView.vala` - Updated methods to accept `SessionBase` parameter and use `session.client` and `session.chat`
- ✅ `libollmchat/Tool/RequestBase.vala` - Updated `send_ui()` to call `session.add_message()` via agent
- ✅ `libollmchat/Tools/RequestRunCommand.vala` - Updated message creation to call `session.add_message()` via agent
- ✅ `libollmchat/Tools/RequestReadFile.vala` - Updated message creation to call `session.add_message()` via agent
- ✅ `libollmchat/Tools/RequestWebFetch.vala` - Updated message creation to call `session.add_message()` via agent

**Result**: ✅ Tools add messages directly to session (via Chat → Agent → Session) and Session relays to UI via Manager's `add_message(Message, SessionBase?)` signal. UI receives Session context and accesses Chat via `session.chat` and `session.client`, ensuring proper session management.

### Phase 3: Remove Signal Definitions ✅ COMPLETE

#### Step 3.1: Remove Signal Definitions from Client ✅

**Goal**: Remove signal declarations from Client.

**Prerequisite**: ✅ All signal connections updated (Phase 1 complete) and ✅ emissions removed (Phase 2 complete)

**Status**: ✅ Complete - All three signal declarations removed from Client class

**Changes**:
1. Removed signal declarations from `Client` class:
   - ✅ `public signal void chat_send(Call.Chat call);` - Removed
   - ✅ `public signal void message_created(Message m, ChatContentInterface? content_interface);` - Removed
   - ✅ `public signal void stream_content(string new_text, Response.Chat response);` - Removed

**Result**: ✅ Signals are completely removed, code still works (callers handle state directly)

## Files to Modify

### Core Classes
- `libollmchat/Client.vala` - Remove signal declarations and emissions

### Handlers/Agents
- `libollmchat/Prompt/AgentHandler.vala` - Remove signal connections, update state handling
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Remove signal connections, update state handling

### History/Session
- `libollmchat/History/Manager.vala` - Remove signal connections, update state handling
- `libollmchat/History/Session.vala` - Remove signal connections, update state handling

### UI
- `libollmchatgtk/ChatWidget.vala` - Remove signal connections, update state handling

## Testing Checklist

- [x] Removed signals no longer declared in Client (Phase 3 complete)
- [x] No code emits removed signals (Phase 2 complete)
- [x] No code connects to removed signals (Phase 1 complete)
- [x] Callers update state directly (no reliance on removed signals) (Phase 1 complete)
- [x] Streaming still works via `stream_chunk` signal (Phase 1 complete)
- [ ] UI updates correctly when messages are created/sent (needs testing)

## Related Plans

- [1.2.1. Remove Configuration from Client](./1.2.1-remove-config-from-client.md)
- [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md)
- [1.2.5. Update Callers to Handle State Directly](./1.2.5-update-callers-state.md)

