# 2.20.8. Model usage restrictions

## Coding standards

This plan follows **`.cursor/rules/CODING_STANDARDS.md`**. All new or modified code must comply. Summary checklist:

- **Nullable types**: Prefer default objects/flags over nullable where possible.
- **Brace placement**: Line breaks for namespaces/classes/methods; inline for control structures.
- **`this.` prefix**: Use for all instance members in Vala.
- **GLib prefix**: Use fully-qualified `GLib.*`; avoid `using` imports.
- **Field vs property**: Use a **field** for `model_type` (not a GObject property) so it is runtime-only and not serialized or shown in generic config UI.

## Status

⏳ **PENDING**

## Purpose

Introduce an extended model usage type that carries a usage restriction (`embedding`, `!embedding`, or `vision`). The vector/codebase-search config sets this so the settings UI can filter the model dropdown to only show models that match the usage (e.g. embedding models for the embed slot, chat models for the analysis slot, vision models for future image analysis).

## Background

- `OLLMchat.Settings.ModelUsage` holds connection, model, options; used for default_model, title_model, and tool configs (e.g. codebase_search embed/analysis).
- Vector/codebase search uses two roles: **embed** (embedding model) and **analysis** (chat model, not embedding). Future image analysis (plan 2.20.3) will use a **vision** model.
- Settings dialog builds rows from config property introspection; the Model row shows a dropdown of models from the selected connection but does not currently filter by capability.
- `Response.Model` has `capabilities` (e.g. "embed", "embedding", "vision", "tools", "thinking"); we can filter the list by these.

## Design

### ModelUsageType class

- **Name**: `ModelUsageType` (extends `ModelUsage`).
- **Location**: `libollmchat/Settings/ModelUsageType.vala` (or alongside `ModelUsage.vala`).
- **Extra member**: A **field** (not a property) named `model_type` of type `string`, default `""`.
  - Not serialized (no JSON, no property introspection).
  - Set by the codebase that owns the config (e.g. vector/CodebaseSearchToolConfig, future image config).

### model_type values

| Value         | Meaning                         | Filter in settings                          |
|---------------|----------------------------------|---------------------------------------------|
| `"embedding"` | Only embedding-capable models   | Show models where capabilities include embed/embedding |
| `"!embedding"`| Exclude embedding models        | Show models that are *not* embedding-only   |
| `"vision"`     | Only vision-capable models       | Show models where capabilities include vision |

- Empty `""`: no restriction (current behaviour; show all models for that connection).

### Who sets model_type

- **Vector / codebase search**: When creating or initialising `CodebaseSearchToolConfig`, set `embed.model_type = "embedding"` and `analysis.model_type = "!embedding"` (or equivalent after switching to `ModelUsageType`).
- **Future image/vision** (e.g. 2.20.3): When adding a vision model usage, set `model_type = "vision"`.

### Settings config filtering

- When the settings dialog builds the **Model** row for a property whose value is a `ModelUsageType` (or otherwise has a `model_type` field), read `model_type`.
- If non-empty, filter the model list passed to the dropdown:
  - `"embedding"`: include only models whose `model_obj.capabilities` indicates embedding (e.g. contains `"embed"` or `"embedding"`).
  - `"!embedding"`: exclude models that are embedding-only (e.g. exclude if capabilities only contain embedding-related).
  - `"vision"`: include only models whose `model_obj.capabilities` contains `"vision"`.
- If `model_type` is `""` or the value is plain `ModelUsage`, keep current behaviour (no capability filter).

## Code changes

### 1. Add ModelUsageType (libollmchat)

**New file**: `libollmchat/Settings/ModelUsageType.vala`

- Class `ModelUsageType` extending `OLLMchat.Settings.ModelUsage`.
- Add field: `public string model_type = "";` (field, not `get; set;`).
- No serialization of `model_type` (inherited serialization ignores it).
- Override `clone()` to copy `model_type` into the new instance.

### 2. CodebaseSearchToolConfig uses ModelUsageType

**File**: `libocvector/Tool/CodebaseSearchToolConfig.vala`

- Replace `OLLMchat.Settings.ModelUsage` with `OLLMchat.Settings.ModelUsageType` for `embed` and `analysis` properties.
- In `setup_defaults()` (and any other place that constructs these usages), set:
  - `this.embed.model_type = "embedding";`
  - `this.analysis.model_type = "!embedding";`
- Ensure default object initialisers for `embed` and `analysis` set `model_type` (e.g. in property default or in a single place used by both defaults).

### 3. VectorBase / connection() usage

**File**: `libocvector/VectorBase.vala`

- No change to `connection(string usage_type, …)` required if it still uses tool_config.embed / tool_config.analysis; those are now `ModelUsageType` which is a subclass of `ModelUsage`.

### 4. RequiresModelsInterface / required_models()

**File**: `libollmchat/Settings/RequiresModelsInterface.vala`

- Return type remains `Gee.ArrayList<ModelUsage>`; `ModelUsageType` is a `ModelUsage`, so existing code continues to work.

### 5. Settings dialog Model row: filter by model_type

**File**: `ollmapp/SettingsDialog/Rows/Model.vala`

- When loading models for the dropdown, obtain the **current property value** (the `ModelUsage` or `ModelUsageType` for this row).
- If the value is a `ModelUsageType` and `model_type` is non-empty, apply an extra filter to the list:
  - **embedding**: include only items where `(model_usage.model_obj != null && model_usage.model_obj.capabilities.contains("embed"))` or similar (check actual Ollama capability name: "embed" vs "embedding").
  - **!embedding**: exclude items that are embedding-only (e.g. exclude if capabilities contain "embed" and no "completion" or similar; define rule and document).
  - **vision**: include only items where `model_usage.model_obj != null && model_usage.model_obj.capabilities.contains("vision")`.
- Use a `Gtk.CustomFilter` or extend the existing filter chain so the dropdown only shows models matching the restriction.

### 6. Optional: ModelUsageFilter by model_type (libollmchatgtk)

If we want a reusable filter in libollmchatgtk:

- Add a filter (e.g. `ModelUsageTypeFilter` or extend `ModelUsageFilter`) that takes a `model_type` string and filters `ModelUsage`/`ModelUsageType` list items by the rules above.
- Settings Model row then uses this filter when the row’s config value is `ModelUsageType` with non-empty `model_type`.

### 7. Build and docs

- Add `ModelUsageType.vala` to the appropriate `libollmchat` sources in `meson.build`.
- If new public API: update `docs/meson.build` valadoc `input` list if needed.

## Testing

- Manual: Open settings → Codebase search (or equivalent) → Embedding model dropdown shows only embedding-capable models; Analysis model dropdown shows only non-embedding (chat) models.
- After vision support: Vision model dropdown shows only vision-capable models.

## Dependencies

- Plan 2.20.3 (binary/image analysis) may add a vision model usage and set `model_type = "vision"`; this plan only adds the type and settings filter, not the vision feature itself.

## Summary

| Item | Description |
|------|-------------|
| New class | `ModelUsageType` extends `ModelUsage` with field `model_type` (string, not serialized). |
| Values | `"embedding"`, `"!embedding"`, `"vision"`, or `""`. |
| Vector usage | CodebaseSearchToolConfig uses `ModelUsageType` for embed/analysis and sets `embedding` / `!embedding`. |
| Settings | Model row filters dropdown by `model_type` when the config value is `ModelUsageType` with non-empty `model_type`. |
