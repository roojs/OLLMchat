# 1.2.6.5. Update Database

## Overview

Update `Database` class to use the new architecture: extend `VectorBase`, take `Config2` instead of `Client`, and use `connection()` method from `VectorBase` for embedding operations.

**Parent Plan**: [1.2.6. Update Legacy Methods](./1.2.6-DONE-update-legacy-methods.md)

## Status

âœ… **DONE** - Database refactored to extend VectorBase and use Config2.

## Summary

The `Database` class has been successfully refactored to:
- Extend `VectorBase` instead of `Object`
- Take `Config2` in constructor instead of `Client`
- Use `this.connection("embed")` from `VectorBase` to get connection
- Use `this.config.tools.get("codebase_search")` to get tool config
- Have instance method `embed_dimension()` that uses VectorBase connection logic
- Support `DISABLE_INDEX` sentinel value for temporary instances used only for dimension checking

## Changes Made

### Database.vala

1. **Class Declaration**: Changed from `public class Database : Object` to `public class Database : VectorBase`

2. **Constructor**: 
   - Changed from `public Database(OLLMchat.Client ollama, string filename, uint64 dimension)` 
   - To `public Database(OLLMchat.Settings.Config2 config, string filename, int dimension)`
   - Added `DISABLE_INDEX` sentinel value support to skip index creation for temporary instances

3. **Removed Client Dependency**:
   - Removed `private OLLMchat.Client ollama;` field
   - All embedding operations now use `this.connection("embed")` from `VectorBase`

4. **Added embed_dimension() Instance Method**:
   - Replaced static `get_embedding_dimension()` with instance method
   - Uses `this.connection("embed")` and `this.config.tools.get("codebase_search")`
   - Returns dimension by making a test embedding call

5. **Updated Embedding Calls**:
   - `add_documents()` and `search()` now create `Call.Embed` directly using:
     - `connection` from `this.connection("embed")`
     - `model` from `tool_config.embed.model`
     - `options` from `tool_config.embed.options`

6. **Type Changes**:
   - Changed dimension type from `uint64` to `int` throughout
   - `DISABLE_INDEX` is now `-1` (int) instead of `(uint64)-1`

### Updated Call Sites

All call sites updated to:
1. Create temporary Database with `DISABLE_INDEX` to check dimension
2. Call `embed_dimension()` on the temporary instance
3. Create final Database with the actual dimension

**Files Updated**:
- `libocvector/Indexing/Indexer.vala`
- `libocvector/Tool/CodebaseSearchTool.vala`
- `examples/oc-vector-index.vala`
- `examples/oc-vector-search.vala`

## Implementation Details

### Before
```vala
public class Database : Object
{
    private OLLMchat.Client ollama;
    
    public Database(OLLMchat.Client ollama, string filename, uint64 dimension)
    {
        this.ollama = ollama;
        // ...
    }
    
    public static async uint64 get_embedding_dimension(OLLMchat.Settings.Config2 config)
    {
        // Static method using Client
    }
}
```

### After
```vala
public class Database : VectorBase
{
    public const int DISABLE_INDEX = -1;
    
    public Database(OLLMchat.Settings.Config2 config, string filename, int dimension)
    {
        base(config);
        if (dimension == DISABLE_INDEX) {
            return; // Skip index creation for temporary instances
        }
        this.index = new Index(this.filename, dimension);
    }
    
    public async int embed_dimension() throws GLib.Error
    {
        var connection = yield this.connection("embed");
        var tool_config = this.config.tools.get("codebase_search") as OLLMvector.Tool.CodebaseSearchToolConfig;
        // Create Call.Embed and get dimension
    }
}
```

## Usage Pattern

```vala
// Get dimension first, then create database
var temp_db = new OLLMvector.Database(config, "/path/to/index.faiss", OLLMvector.Database.DISABLE_INDEX);
var dimension = yield temp_db.embed_dimension();
var db = new OLLMvector.Database(config, "/path/to/index.faiss", dimension);

// Now use db for operations
yield db.add_documents({"document 1", "document 2"});
```

## Benefits

1. **Consistent Architecture**: Database now follows the same pattern as Search, Indexer, and Analysis (all extend VectorBase)
2. **No Client Dependency**: Database is now independent of Client, using Config2 and Connection directly
3. **Better Encapsulation**: Instance method `embed_dimension()` uses the same connection logic as other operations
4. **Lazy Index Initialization**: `DISABLE_INDEX` allows creating temporary instances just for dimension checking without initializing the index file

## Related Plans

- [1.2.6.6. Update Search](./1.2.6.6-DONE-update-search.md) - Similar refactoring for Search class
- [1.2.6.6.1. Refactor Search Config Access](./1.2.6.6.1-DONE-refactor-search-config-access.md) - Pattern for extending VectorBase

