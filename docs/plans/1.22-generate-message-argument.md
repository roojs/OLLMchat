# 1.22. Generate — Consider Message as argument (simplify code e.g. images)

## Status

⏳ **PENDING**

## Purpose

Add image support to Call.Generate and simplify its API by considering **Message** as the argument for Generate. That way image handling (path→base64 at send time) reuses Message.serialize_images and is not duplicated.

## Problem

- **Generate** today takes `prompt`, `system`, `images` (Gee.ArrayList<string> paths), etc. To send images to the vision API, Generate would need to serialize `images` as base64 at request time — the same logic as Message.serialize_images.
- Duplicating that logic in Generate is brittle and diverges from Chat, which uses Message.serialize_images.
- **2.20.3** (binary file / image analysis) ImageAnalyzer now uses **Call.Chat** (single user message with image), so it no longer depends on Generate image support. This plan is for other Generate-with-image use cases and for simplifying Generate’s API.

## Goal

1. **Add image support to Generate** so that when Generate is used with `images` (paths), the outgoing API request has base64 `images`. Not required for 2.20.3 (ImageAnalyzer uses Chat); useful for other Generate-with-image use.
2. **Consider using Message as the argument for Generate** so that:
   - Generate accepts a single **Message** (e.g. user message with optional `content` and `images`) instead of or in addition to raw `prompt` + `images`.
   - Serialization (including images→base64) is done via Message.serialize_images on that message’s JSON, so one code path for Chat and Generate.
   - Simplifies code and keeps image handling in one place.

## Options

- **A) Message as primary input for Generate**  
  Generate takes e.g. `Message message` (and optionally legacy `prompt` for backward compatibility). Request body is built from that message (content → prompt, message.images → base64 via serialize_images). No separate `images` list on Generate.

- **B) Keep prompt + images, reuse Message for serialization**  
  Generate keeps `prompt` and `images` (paths). In serialize_property for `"images"`, build a temporary Message with that content, call Message.serialize_images on a temporary JSON object, return the `images` node. Same as the approach previously described in 2.20.3 §1.3 (removed from that plan).

- **C) Hybrid**  
  Generate can accept either a Message or (prompt + images). If Message is provided, use it for serialization; otherwise fall back to current behaviour plus image serialization (e.g. via B).

Decide in this plan which option to implement; then add concrete code.

## Related Plans

- 2.20.3-binary-file-image-analysis.md — ImageAnalyzer uses **Call.Chat** (not Generate); no dependency on this plan for 2.20.3.
