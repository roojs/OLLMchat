# 1.2.7. Move Remaining Signals from Client to Chat

## Overview

Move the remaining asynchronous signals from `Client` to `Chat`. These signals (`stream_chunk`, `stream_start`, `tool_message`) are kept on Client during the refactoring for backward compatibility, but should ultimately live on Chat since Chat orchestrates the conversation.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

⏳ **TODO** - Final tidy-up step after all other 1.2.X refactoring is complete.

## Goal

Move asynchronous signals from Client to Chat, and update the flow for agent usage to use direct method calls instead of signals.

**For agent usage**: Chat → Agent (direct method calls) → Session (direct method calls) → Manager signals → UI
**For non-agent usage**: Chat signals → UI (loosely coupled components)

## Signals to Move

### 1. `stream_chunk(string, bool, Response.Chat)`

- **Current**: Emitted on `Client` when a streaming chunk is received
- **Move to**: `Call.Chat` - Chat orchestrates the conversation, emits streaming chunks
- **Usage**: For non-agent usage (loosely coupled components)

### 2. `stream_start()`

- **Current**: Emitted on `Client` when streaming starts (first chunk received)
- **Move to**: `Call.Chat` - Chat emits when streaming starts
- **Usage**: For non-agent usage (loosely coupled components)

### 3. `tool_message(Message)`

- **Current**: Emitted on `Client` when a tool sends a status message
- **Move to**: `Call.Chat` - Chat emits tool status messages
- **Usage**: For non-agent usage (loosely coupled components)

## Implementation Strategy

**⚠️ CRITICAL**: This should be done as the final step after all other 1.2.X refactoring is complete.

**Key Principle**: Add signals to Chat first, migrate connections incrementally, remove from Client last.

## Sub-Plans

This plan has been split into multiple sub-plans for better organization:

1. **[1.2.7.1. Verify Chat Creation Options](./1.2.7.1-verify-chat-creation-options.md)** - Prerequisite check
2. **[1.2.7.2. Add Signals to Chat](./1.2.7.2-DONE-add-signals-to-chat.md)** - Add signal declarations and emissions to Chat
3. **[1.2.7.3. Update Agent Usage to Direct Method Calls](./1.2.7.3-DONE-update-agent-usage-direct-calls.md)** - Replace signal connections with direct method calls for agent usage
4. **[1.2.7.4. Migrate Non-Agent Signal Connections](./1.2.7.4-migrate-non-agent-signals.md)** - Update non-agent code to connect to Chat signals
5. **[1.2.7.5. Rename exec_chat() to send()](./1.2.7.5-rename-exec-chat-to-send.md)** - Align method name with plan 1.2's ideal interface
6. **[1.2.7.6. Remove Signals from Client](./1.2.7.6-remove-signals-from-client.md)** - Remove signal declarations and emissions from Client
7. **[1.2.7.7. Remove Client from Session](./1.2.7.7-remove-client-from-session.md)** - Final tidy-up: remove client property from SessionBase
8. **[1.2.7.8. Cleanup Items](./1.2.7.8-cleanup-items.md)** - Various cleanup items and technical debt
9. **[1.2.7.9. Move Permission Provider to Agent](./1.2.7.9-move-permission-provider-to-agent.md)** - Move permission_provider from Chat to AgentHandler
10. **[1.2.7.10. Move Tool Execution to Agent](./1.2.7.10-move-tool-execution-to-agent.md)** - Move tool execution from Chat to AgentHandler, add placeholder signal for non-agent usage

## Files to Modify

### Core Classes
- `libollmchat/Client.vala` - Remove signal declarations and emissions
- `libollmchat/Call/Chat.vala` - Add signal declarations and emissions
- `libollmchat/Call/Base.vala` - Update to emit via Chat instead of Client

### Handlers/Agents
- `libollmchat/Prompt/AgentHandler.vala` - Add direct method calls, remove signal connections
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Inherits direct method calls from AgentHandler

### History/Session
- `libollmchat/History/SessionBase.vala` - Add direct method calls, remove signal connections, relay to Manager signals; Remove `client` property (Phase 6)
- `libollmchat/History/Session.vala` - Inherits direct method calls from SessionBase
- `libollmchat/History/Manager.vala` - Update to provide connection access without requiring client on session (Phase 6)

### UI
- `libollmchatgtk/ChatWidget.vala` - Update signal connections to use Chat
- `libollmchatgtk/ChatView.vala` - Update signal connections to use Chat

## Testing Checklist

- [ ] All Chat creation points properly set `options` from config when available (Phase 0.1)
- [ ] Chat has signal declarations (stream_chunk, stream_start, tool_message) for non-agent usage
- [ ] Chat calls agent methods directly when agent is set (on_stream_chunk, on_stream_start, on_tool_message)
- [ ] Chat emits signals when agent is not set (for non-agent usage)
- [ ] AgentHandler has direct method implementations that relay to Session
- [ ] SessionBase has direct method implementations that relay to Manager signals
- [ ] AgentHandler no longer connects to Client signals
- [ ] SessionBase no longer connects to Client signals
- [ ] All non-agent code connects to Chat signals (not Client signals)
- [ ] `exec_chat()` renamed to `send()` in Call.Chat
- [ ] All call sites updated to use `send()` instead of `exec_chat()`
- [ ] Client no longer has signal declarations
- [ ] Client no longer emits signals
- [ ] Streaming still works correctly for agent usage
- [ ] Streaming still works correctly for non-agent usage
- [ ] Tool messages still work correctly
- [ ] UI updates correctly when streaming starts
- [ ] SessionBase no longer has `client` property (Phase 6)
- [ ] AgentHandler gets connection from session/manager without requiring session.client (Phase 6)

## Related Plans

- [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md) - Removed synchronous signals, kept asynchronous ones temporarily
- [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md) - Parent plan
