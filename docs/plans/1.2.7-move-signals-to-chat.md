# 1.2.7. Move Remaining Signals from Client to Chat

## Overview

Move the remaining asynchronous signals from `Client` to `Chat`. These signals (`stream_chunk`, `stream_start`, `tool_message`) are kept on Client during the refactoring for backward compatibility, but should ultimately live on Chat since Chat orchestrates the conversation.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

⏳ **TODO** - Final tidy-up step after all other 1.2.X refactoring is complete.

## Goal

Move asynchronous signals from Client to Chat, and update the flow for agent usage to use direct method calls instead of signals.

**For agent usage**: Chat → Agent (direct method calls) → Session (direct method calls) → Manager signals → UI
**For non-agent usage**: Chat signals → UI (loosely coupled components)

## Signals to Move

### 1. `stream_chunk(string, bool, Response.Chat)`

- **Current**: Emitted on `Client` when a streaming chunk is received
- **Move to**: `Call.Chat` - Chat orchestrates the conversation, emits streaming chunks
- **Usage**: For non-agent usage (loosely coupled components)

### 2. `stream_start()`

- **Current**: Emitted on `Client` when streaming starts (first chunk received)
- **Move to**: `Call.Chat` - Chat emits when streaming starts
- **Usage**: For non-agent usage (loosely coupled components)

### 3. `tool_message(Message)`

- **Current**: Emitted on `Client` when a tool sends a status message
- **Move to**: `Call.Chat` - Chat emits tool status messages
- **Usage**: For non-agent usage (loosely coupled components)

## Implementation Strategy

**⚠️ CRITICAL**: This should be done as the final step after all other 1.2.X refactoring is complete.

**Key Principle**: Add signals to Chat first, migrate connections incrementally, remove from Client last.

## Implementation Steps

### Phase 1: Add Signals to Chat

#### Step 1.1: Add Signal Declarations to Call.Chat

**Goal**: Add the three signal declarations to `Call.Chat`.

**Changes**:
1. Add to `libollmchat/Call/Chat.vala`:
   ```vala
   /**
    * Emitted when a streaming chunk is received from the chat API.
    *
    * @param new_text The new text chunk received
    * @param is_thinking Whether this chunk is thinking content (true) or regular content (false)
    * @param response The Response object containing the streaming state
    * @since 1.0
    */
   public signal void stream_chunk(string new_text, bool is_thinking, Response.Chat response);

   /**
    * Emitted when the streaming response starts (first chunk received).
    * This signal is emitted when the first chunk of the response is processed,
    * indicating that the server has started sending data back.
    *
    * @since 1.0
    */
   public signal void stream_start();

   /**
    * Emitted when a tool sends a status message during execution.
    *
    * @param message The Message object from the tool (typically "ui" role)
    * @since 1.0
    */
   public signal void tool_message(Message message);
   ```

**Result**: Chat has the signals, but Client still has them too (for backward compatibility)

#### Step 1.2: Add Signal Emissions to Call.Chat

**Goal**: Emit signals from Chat in addition to (or instead of) Client.

**Changes**:
1. Find all places where `client.stream_chunk()` is emitted
2. Add `this.stream_chunk()` emission in the same place (or replace if Chat has access)
3. Repeat for `stream_start()` and `tool_message()`

**Files to check**:
- `libollmchat/Call/Chat.vala` - Add signal emissions
- `libollmchat/Call/Base.vala` - May need to emit via Chat reference

**Result**: Chat emits signals, Client still emits them too (for backward compatibility)

### Phase 2: Update Agent Usage to Direct Method Calls

#### Step 2.1: Add Agent Handler Methods

**Goal**: Add methods to AgentHandler that Chat can call directly (instead of using signals).

**Changes**:
1. Add to `libollmchat/Prompt/AgentHandler.vala`:
   ```vala
   /**
    * Called by Chat when a streaming chunk is received.
    * Agent handler should relay to Session.
    */
   public virtual void on_stream_chunk(string new_text, bool is_thinking, Response.Chat response)
   {
       // Default: relay to session
       if (this.session != null) {
           this.session.on_stream_chunk(new_text, is_thinking, response);
       }
   }
   
   /**
    * Called by Chat when streaming starts.
    * Agent handler should relay to Session.
    */
   public virtual void on_stream_start()
   {
       // Default: relay to session
       if (this.session != null) {
           this.session.on_stream_start();
       }
   }
   
   /**
    * Called by Chat when a tool sends a status message.
    * Agent handler should relay to Session.
    */
   public virtual void on_tool_message(Message message)
   {
       // Default: relay to session
       if (this.session != null) {
           this.session.on_tool_message(message);
       }
   }
   ```

2. Add to `libollmchat/History/SessionBase.vala`:
   ```vala
   /**
    * Called by AgentHandler when a streaming chunk is received.
    * Session relays to Manager signals (Manager doesn't process, just relays to UI).
    * 
    * Note: Manager signals are just a relay point - Manager doesn't need to process
    * these events, it just forwards them to UI components that are connected to Manager signals.
    */
   public void on_stream_chunk(string new_text, bool is_thinking, Response.Chat response)
   {
       // Relay directly to Manager signals (Manager is just a relay point, no processing needed)
       this.manager.stream_chunk(new_text, is_thinking, response);
       if (!is_thinking) {
           this.manager.stream_content(new_text, response);
       }
   }
   
   /**
    * Called by AgentHandler when streaming starts.
    * Session relays to Manager signals.
    */
   public void on_stream_start()
   {
       this.manager.stream_start();
   }
   
   /**
    * Called by AgentHandler when a tool sends a status message.
    * Session relays to Manager signals.
    */
   public void on_tool_message(Message message)
   {
       this.manager.tool_message(message);
   }
   ```

**Result**: Agent handlers and Session have methods that Chat can call directly

#### Step 2.2: Update Chat to Call Agent Methods Directly

**Goal**: When Chat has an agent reference, call agent methods directly instead of emitting signals.

**Changes**:
1. In `libollmchat/Call/Chat.vala`, update `process_streaming_chunk()`:
   ```vala
   // If Chat has agent reference, call agent method directly (no signal)
   if (this.agent != null) {
       this.agent.on_stream_chunk(new_text, is_thinking, this.streaming_response);
   } else {
       // For non-agent usage, emit signal for loosely coupled components
       this.stream_chunk(new_text, is_thinking, this.streaming_response);
   }
   ```

2. Similar updates for `stream_start()` and `tool_message()` emissions

**Result**: Agent usage uses direct method calls, non-agent usage uses signals

#### Step 2.3: Remove Signal Connections from AgentHandler and SessionBase

**Goal**: Remove signal connections since agent usage now uses direct method calls.

**Changes**:
1. Remove from `libollmchat/Prompt/AgentHandler.vala`:
   - Remove `stream_chunk_id`, `stream_start_id` fields
   - Remove signal connections in constructor
   - Remove signal disconnections in destructor
   - Remove `handle_stream_chunk()` method (replaced by `on_stream_chunk()`)

2. Remove from `libollmchat/History/SessionBase.vala`:
   - Remove `stream_chunk_id`, `stream_start_id`, `tool_message_id` fields
   - Remove signal connections in `activate()`
   - Remove signal disconnections in `deactivate()`
   - Remove `stream_chunk_handler_id` field and connection (replaced by direct method calls)

**Result**: Agent usage no longer uses signals, only direct method calls

### Phase 3: Migrate Non-Agent Signal Connections

#### Step 3.1: Update Non-Agent Signal Connections

**Goal**: Update code that uses Chat signals (for non-agent usage) to connect to Chat instead of Client.

**Files to check**:
- `libollmchatgtk/ChatWidget.vala` - May connect to Chat signals for non-agent usage
- `libollmchatgtk/ChatView.vala` - May connect to Chat signals for non-agent usage
- Any other UI or handler code that doesn't use agents

**For each connection**:
1. Find `client.stream_chunk.connect(...)` and change to `chat.stream_chunk.connect(...)`
2. Find `client.stream_start.connect(...)` and change to `chat.stream_start.connect(...)`
3. Find `client.tool_message.connect(...)` and change to `chat.tool_message.connect(...)`

**Result**: Non-agent code connects to Chat signals, but Client signals still exist (for backward compatibility)

### Phase 4: Remove Signals from Client

#### Step 4.1: Remove Signal Declarations from Client

**Goal**: Remove signal declarations from Client.

**Prerequisite**: ✅ All signal connections migrated to Chat (Phase 3 complete) and ✅ agent usage uses direct method calls (Phase 2 complete)

**Changes**:
1. Remove from `libollmchat/Client.vala`:
   ```vala
   // Remove these:
   public signal void stream_chunk(string new_text, bool is_thinking, Response.Chat response);
   public signal void stream_start();
   public signal void tool_message(Message message);
   ```

**Result**: Signals are completely removed from Client, code still works (all connections use Chat)

#### Step 4.2: Remove Signal Emissions from Client

**Goal**: Remove all signal emissions from Client.

**Prerequisite**: ✅ All signal declarations removed (Step 4.1 complete)

**Changes**:
1. Find all `client.stream_chunk()` calls and remove
2. Find all `client.stream_start()` calls and remove
3. Find all `client.tool_message()` calls and remove

**Files**:
- `libollmchat/Client.vala` - Remove signal emissions
- `libollmchat/Call/Base.vala` - Remove Client signal emissions (Chat emits instead)
- `libollmchat/Call/Chat.vala` - Remove Client signal emissions (Chat emits instead)

**Result**: Client no longer emits signals, Chat handles all signal emissions

## Files to Modify

### Core Classes
- `libollmchat/Client.vala` - Remove signal declarations and emissions
- `libollmchat/Call/Chat.vala` - Add signal declarations and emissions
- `libollmchat/Call/Base.vala` - Update to emit via Chat instead of Client

### Handlers/Agents
- `libollmchat/Prompt/AgentHandler.vala` - Add direct method calls, remove signal connections
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Inherits direct method calls from AgentHandler

### History/Session
- `libollmchat/History/SessionBase.vala` - Add direct method calls, remove signal connections, relay to Manager signals
- `libollmchat/History/Session.vala` - Inherits direct method calls from SessionBase

### UI
- `libollmchatgtk/ChatWidget.vala` - Update signal connections to use Chat
- `libollmchatgtk/ChatView.vala` - Update signal connections to use Chat

## Testing Checklist

- [ ] Chat has signal declarations (stream_chunk, stream_start, tool_message) for non-agent usage
- [ ] Chat calls agent methods directly when agent is set (on_stream_chunk, on_stream_start, on_tool_message)
- [ ] Chat emits signals when agent is not set (for non-agent usage)
- [ ] AgentHandler has direct method implementations that relay to Session
- [ ] SessionBase has direct method implementations that relay to Manager signals
- [ ] AgentHandler no longer connects to Client signals
- [ ] SessionBase no longer connects to Client signals
- [ ] All non-agent code connects to Chat signals (not Client signals)
- [ ] Client no longer has signal declarations
- [ ] Client no longer emits signals
- [ ] Streaming still works correctly for agent usage
- [ ] Streaming still works correctly for non-agent usage
- [ ] Tool messages still work correctly
- [ ] UI updates correctly when streaming starts

## Related Plans

- [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md) - Removed synchronous signals, kept asynchronous ones temporarily
- [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md) - Parent plan

