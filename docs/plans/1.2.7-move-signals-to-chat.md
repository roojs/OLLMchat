# 1.2.7. Move Remaining Signals from Client to Chat

## Overview

Move the remaining asynchronous signals from `Client` to `Chat`. These signals (`stream_chunk`, `stream_start`, `tool_message`) are kept on Client during the refactoring for backward compatibility, but should ultimately live on Chat since Chat orchestrates the conversation.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

⏳ **TODO** - Final tidy-up step after all other 1.2.X refactoring is complete.

## Goal

Move asynchronous signals from Client to Chat, and update the flow for agent usage to use direct method calls instead of signals.

**For agent usage**: Chat → Agent (direct method calls) → Session (direct method calls) → Manager signals → UI
**For non-agent usage**: Chat signals → UI (loosely coupled components)

## Signals to Move

### 1. `stream_chunk(string, bool, Response.Chat)`

- **Current**: Emitted on `Client` when a streaming chunk is received
- **Move to**: `Call.Chat` - Chat orchestrates the conversation, emits streaming chunks
- **Usage**: For non-agent usage (loosely coupled components)

### 2. `stream_start()`

- **Current**: Emitted on `Client` when streaming starts (first chunk received)
- **Move to**: `Call.Chat` - Chat emits when streaming starts
- **Usage**: For non-agent usage (loosely coupled components)

### 3. `tool_message(Message)`

- **Current**: Emitted on `Client` when a tool sends a status message
- **Move to**: `Call.Chat` - Chat emits tool status messages
- **Usage**: For non-agent usage (loosely coupled components)

## Implementation Strategy

**⚠️ CRITICAL**: This should be done as the final step after all other 1.2.X refactoring is complete.

**Key Principle**: Add signals to Chat first, migrate connections incrementally, remove from Client last.

## Implementation Steps

### Phase 0: Verify Chat Creation Options (Prerequisite Check)

#### Step 0.1: Verify All Chat Creation Points Set Options Properly

**Goal**: Ensure all Chat creation points properly set `options` from config when available, rather than always using defaults.

**Check**: Review all Chat creation points to ensure they:
1. Get `options` from config when available (using `config.model_options.get(model)` or `config.usage.get("default_model")`)
2. Fall back to `new Call.Options()` only when config is not available
3. Explicitly set `options` on the Chat object

**Files to check**:
- `libollmchat/Client.vala` - `chat()` (has TODO comment), `embed()`, `generate()` methods
- `libollmchat/Settings/Config2.vala` - `create_chat()` method
- `libocvector/Indexing/Analysis.vala` - Chat creation
- `libollmchat/History/Manager.vala` - `new_client()` method
- `libollmchat/History/SessionBase.vala` - Chat creation in constructor
- `libollmchat/Prompt/AgentHandler.vala` - Chat creation
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Chat creation

**Note**: `keep_alive` defaults to `null` (not set), which is acceptable for normal usage. Only set if explicitly needed.

**Result**: All Chat creation points properly handle options from config

### Phase 1: Add Signals to Chat

#### Step 1.1: Add Signal Declarations to Call.Chat

**Goal**: Add the three signal declarations to `Call.Chat`.

**Changes**:
1. Add to `libollmchat/Call/Chat.vala`:
   ```vala
   /**
    * Emitted when a streaming chunk is received from the chat API.
    *
    * @param new_text The new text chunk received
    * @param is_thinking Whether this chunk is thinking content (true) or regular content (false)
    * @param response The Response object containing the streaming state
    * @since 1.0
    */
   public signal void stream_chunk(string new_text, bool is_thinking, Response.Chat response);

   /**
    * Emitted when the streaming response starts (first chunk received).
    * This signal is emitted when the first chunk of the response is processed,
    * indicating that the server has started sending data back.
    *
    * @since 1.0
    */
   public signal void stream_start();

   /**
    * Emitted when a tool sends a status message during execution.
    *
    * @param message The Message object from the tool (typically "ui" role)
    * @since 1.0
    */
   public signal void tool_message(Message message);
   ```

**Result**: Chat has the signals, but Client still has them too (for backward compatibility)

#### Step 1.2: Add Signal Emissions to Call.Chat

**Goal**: Emit signals from Chat in addition to (or instead of) Client.

**Changes**:
1. Find all places where `client.stream_chunk()` is emitted
2. Add `this.stream_chunk()` emission in the same place (or replace if Chat has access)
3. Repeat for `stream_start()` and `tool_message()`

**Files to check**:
- `libollmchat/Call/Chat.vala` - Add signal emissions
- `libollmchat/Call/Base.vala` - May need to emit via Chat reference

**Result**: Chat emits signals, Client still emits them too (for backward compatibility)

### Phase 2: Update Agent Usage to Direct Method Calls

#### Step 2.1: Add Agent Handler Methods

**Goal**: Add methods to AgentHandler that Chat can call directly (instead of using signals).

**Changes**:
1. Add to `libollmchat/Prompt/AgentHandler.vala`:
   ```vala
   /**
    * Called by Chat when a streaming chunk is received.
    * Agent handler should relay to Session.
    */
   public virtual void on_stream_chunk(string new_text, bool is_thinking, Response.Chat response)
   {
       // Default: relay to session
       if (this.session != null) {
           this.session.on_stream_chunk(new_text, is_thinking, response);
       }
   }
   
   /**
    * Called by Chat when streaming starts.
    * Agent handler should relay to Session.
    */
   public virtual void on_stream_start()
   {
       // Default: relay to session
       if (this.session != null) {
           this.session.on_stream_start();
       }
   }
   
   /**
    * Called by Chat when a tool sends a status message.
    * Agent handler should relay to Session.
    */
   public virtual void on_tool_message(Message message)
   {
       // Default: relay to session
       if (this.session != null) {
           this.session.on_tool_message(message);
       }
   }
   ```

2. Add to `libollmchat/History/SessionBase.vala`:
   ```vala
   /**
    * Called by AgentHandler when a streaming chunk is received.
    * Session relays to Manager signals (Manager doesn't process, just relays to UI).
    * 
    * Note: Manager signals are just a relay point - Manager doesn't need to process
    * these events, it just forwards them to UI components that are connected to Manager signals.
    */
   public void on_stream_chunk(string new_text, bool is_thinking, Response.Chat response)
   {
       // Relay directly to Manager signals (Manager is just a relay point, no processing needed)
       this.manager.stream_chunk(new_text, is_thinking, response);
       if (!is_thinking) {
           this.manager.stream_content(new_text, response);
       }
   }
   
   /**
    * Called by AgentHandler when streaming starts.
    * Session relays to Manager signals.
    */
   public void on_stream_start()
   {
       this.manager.stream_start();
   }
   
   /**
    * Called by AgentHandler when a tool sends a status message.
    * Session relays to Manager signals.
    */
   public void on_tool_message(Message message)
   {
       this.manager.tool_message(message);
   }
   ```

**Result**: Agent handlers and Session have methods that Chat can call directly

#### Step 2.2: Update Chat to Call Agent Methods Directly

**Goal**: When Chat has an agent reference, call agent methods directly instead of emitting signals.

**Changes**:
1. In `libollmchat/Call/Chat.vala`, update `process_streaming_chunk()`:
   ```vala
   // If Chat has agent reference, call agent method directly (no signal)
   if (this.agent != null) {
       this.agent.on_stream_chunk(new_text, is_thinking, this.streaming_response);
   } else {
       // For non-agent usage, emit signal for loosely coupled components
       this.stream_chunk(new_text, is_thinking, this.streaming_response);
   }
   ```

2. Similar updates for `stream_start()` and `tool_message()` emissions

**Result**: Agent usage uses direct method calls, non-agent usage uses signals

#### Step 2.3: Remove Signal Connections from AgentHandler and SessionBase

**Goal**: Remove signal connections since agent usage now uses direct method calls.

**Changes**:
1. Remove from `libollmchat/Prompt/AgentHandler.vala`:
   - Remove `stream_chunk_id`, `stream_start_id` fields
   - Remove signal connections in constructor
   - Remove signal disconnections in destructor
   - Remove `handle_stream_chunk()` method (replaced by `on_stream_chunk()`)

2. Remove from `libollmchat/History/SessionBase.vala`:
   - Remove `stream_chunk_id`, `stream_start_id`, `tool_message_id` fields
   - Remove signal connections in `activate()`
   - Remove signal disconnections in `deactivate()`
   - Remove `stream_chunk_handler_id` field and connection (replaced by direct method calls)

**Result**: Agent usage no longer uses signals, only direct method calls

### Phase 3: Migrate Non-Agent Signal Connections

#### Step 3.1: Update Non-Agent Signal Connections

**Goal**: Update code that uses Chat signals (for non-agent usage) to connect to Chat instead of Client.

**Files to check**:
- `libollmchatgtk/ChatWidget.vala` - May connect to Chat signals for non-agent usage
- `libollmchatgtk/ChatView.vala` - May connect to Chat signals for non-agent usage
- Any other UI or handler code that doesn't use agents

**For each connection**:
1. Find `client.stream_chunk.connect(...)` and change to `chat.stream_chunk.connect(...)`
2. Find `client.stream_start.connect(...)` and change to `chat.stream_start.connect(...)`
3. Find `client.tool_message.connect(...)` and change to `chat.tool_message.connect(...)`

**Result**: Non-agent code connects to Chat signals, but Client signals still exist (for backward compatibility)

### Phase 4: Rename exec_chat() to send()

#### Step 4.1: Rename Method in Call.Chat

**Goal**: Rename `exec_chat()` to `send()` to align with plan 1.2's ideal interface design.

**Note**: Plan 1.2 specifies that Chat should have a `send()` method (see [1.2 Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md) line 185), but the current code uses `exec_chat()`. This step completes that alignment.

**Changes**:
1. In `libollmchat/Call/Chat.vala`:
   - Rename `exec_chat()` method to `send()`
   - Update method documentation to reflect new name
   - Update error messages that reference `exec_chat()`

2. Find all call sites of `exec_chat()` and update to `send()`:
   - `libollmchat/Client.vala` - `chat()` method
   - `libollmchat/Call/Chat.vala` - `reply()` method, `toolsReply()` method
   - `libollmchat/History/Session.vala` - `send_message_async()` method
   - `libollmchat/Prompt/AgentHandler.vala` - Any calls to `exec_chat()`
   - `liboccoder/Prompt/CodeAssistantHandler.vala` - Any calls to `exec_chat()`
   - Any other files that call `exec_chat()`

**Files to check**:
- `libollmchat/Call/Chat.vala` - Rename method
- All files that call `exec_chat()` - Update to `send()`

**Result**: Chat uses `send()` method name, matching plan 1.2's ideal interface

### Phase 5: Remove Signals from Client

#### Step 5.1: Remove Signal Declarations from Client

**Goal**: Remove signal declarations from Client.

**Prerequisite**: ✅ All signal connections migrated to Chat (Phase 3 complete) and ✅ agent usage uses direct method calls (Phase 2 complete)

**Changes**:
1. Remove from `libollmchat/Client.vala`:
   ```vala
   // Remove these:
   public signal void stream_chunk(string new_text, bool is_thinking, Response.Chat response);
   public signal void stream_start();
   public signal void tool_message(Message message);
   ```

**Result**: Signals are completely removed from Client, code still works (all connections use Chat)

#### Step 5.2: Remove Signal Emissions from Client

**Goal**: Remove all signal emissions from Client.

**Prerequisite**: ✅ All signal declarations removed (Step 5.1 complete)

**Changes**:
1. Find all `client.stream_chunk()` calls and remove
2. Find all `client.stream_start()` calls and remove
3. Find all `client.tool_message()` calls and remove

**Files**:
- `libollmchat/Client.vala` - Remove signal emissions
- `libollmchat/Call/Base.vala` - Remove Client signal emissions (Chat emits instead)
- `libollmchat/Call/Chat.vala` - Remove Client signal emissions (Chat emits instead)

**Result**: Client no longer emits signals, Chat handles all signal emissions

### Phase 6: Remove Client from Session (Final Tidy-Up)

#### Step 6.1: Remove Client Property from SessionBase

**Goal**: Remove `client` property from `SessionBase` since AgentHandler can get connection from Manager or Session should have connection directly.

**Changes**:
- Remove `public Client client { get; protected set; }` from `SessionBase`
- Remove `this.client = manager.new_client()` from `SessionBase` constructor
- Update `AgentHandler` to get connection from `session.manager.base_client.connection` or add `connection` property to Session
- Update all references to `session.client` to use alternative approach
- Remove `new_client()` method from Manager (or keep for backward compatibility during transition)

**Files to Modify**:
- `libollmchat/History/SessionBase.vala` - Remove `client` property and initialization
- `libollmchat/Prompt/AgentHandler.vala` - Update to get connection from session/manager instead of `session.client.connection`
- `libollmchat/History/Manager.vala` - Consider removing `new_client()` or keeping for compatibility
- All files that reference `session.client` - Update to use alternative approach

**Note**: This is a breaking change and should be done as the final step after all signal migrations are complete.

## Cleanup Items

### Model and Options Setting Location

**Issue**: Currently in `AgentHandler.send_async()`, model and options are being updated on the Chat instance just before sending the message. This is too late in the flow.

**Decision Needed**: Determine where model and options should be set for Chat:
- Option A: Set when Chat is created in AgentHandler constructor (current approach)
- Option B: Set when session properties change (model/options change on session)
- Option C: Set when AgentHandler is created/updated (when agent changes on session)
- Option D: Some combination of the above

**Current State**: Model and options update code is commented out in `AgentHandler.send_async()` with a FIXME. The Chat is created in the constructor with initial values, but they're not updated when session properties change.

**Action**: Decide on the correct approach and implement it during 1.2.7 cleanup.

### Implement BaseAgent.system_message() Method

**Issue**: Currently `CodeAssistantHandler.send_async()` uses `agent.fill(this.chat, "")` to get system prompt. This is a workaround - should use dedicated `system_message()` method.

**Current State**: 
- `BaseAgent.system_message(AgentHandler handler)` exists as placeholder that returns empty string
- `CodeAssistantHandler.send_async()` calls `this.agent.system_message(this)` which currently returns empty string
- CodeAssistant needs to override this to generate system prompt with current context

**Proposed Implementation**:
- `BaseAgent.system_message()` - Default returns empty string (for simple agents like JustAsk)
- `CodeAssistant.system_message()` - Override to generate system prompt with current context (open files, workspace, etc.)
- Method receives `AgentHandler` so it can access `handler.session`, `handler.client`, etc.

**Action**: Implement `CodeAssistant.system_message()` override during 1.2.7 cleanup to properly generate system prompt with current context.

### Rename Agent-Related Code from Prompt/* to Agent/*

**Issue**: Agent-related classes (AgentHandler, BaseAgent, CodeAssistant, JustAsk, etc.) are currently in the `OLLMchat.Prompt` namespace, but they're really about agents, not prompts.

**Current State**: 
- `libollmchat/Prompt/AgentHandler.vala` → `OLLMchat.Prompt.AgentHandler`
- `libollmchat/Prompt/BaseAgent.vala` → `OLLMchat.Prompt.BaseAgent`
- `libollmchat/Prompt/CodeAssistant.vala` → `OLLMchat.Prompt.CodeAssistant`
- `libollmchat/Prompt/JustAsk.vala` → `OLLMchat.Prompt.JustAsk`
- `libollmchat/Prompt/AgentInterface.vala` → `OLLMchat.Prompt.AgentInterface`
- `libollmchat/Prompt/CodeAssistantDummy.vala` → `OLLMchat.Prompt.CodeAssistantDummy`

**Proposed Change**: 
- Move agent-related files from `libollmchat/Prompt/` to `libollmchat/Agent/`
- Change namespace from `OLLMchat.Prompt` to `OLLMchat.Agent`
- Update all imports and references throughout the codebase
- Keep prompt-related code (if any) in `Prompt/` namespace

**Action**: Rename namespace and move files during 1.2.7 cleanup.

### Remove session_replaced Signal Emission

**Issue**: `SessionPlaceholder.load()` emits `manager.session_replaced()` signal, but this is no longer needed since the UI uses `SessionList` directly as a `ListModel`, which automatically emits `items_changed` signals when items are replaced.

**Current State**: 
- `libollmchat/History/SessionPlaceholder.vala` line 222-224 has FIXME comment: "is this needed anymore ? = since the UI uses the store."
- The `session_replaced` signal is emitted after replacing a placeholder with a real session
- `HistoryBrowser` still connects to this signal but doesn't need to since `SessionList.replace_at()` already emits `items_changed`

**Action**: 
- Remove `session_replaced` signal emission from `SessionPlaceholder.load()`
- Remove `session_replaced` signal declaration from `Manager`
- Remove `session_replaced` signal connection from `HistoryBrowser`
- Remove `on_session_replaced()` handler from `HistoryBrowser`

**Files to Modify**:
- `libollmchat/History/SessionPlaceholder.vala` - Remove `session_replaced` signal emission
- `libollmchat/History/Manager.vala` - Remove `session_replaced` signal declaration
- `libollmchatgtk/HistoryBrowser.vala` - Remove signal connection and handler

### Remove session_added Signal Emission

**Issue**: `session_added` signal is emitted when sessions are added to `manager.sessions`, but this is no longer needed since the UI uses `SessionList` directly as a `ListModel`, which automatically emits `items_changed` signals when items are added via `append()`.

**Current State**: 
- `libollmchat/History/EmptySession.vala` lines 98 and 136 have FIXME comments: "is this needed now?"
- `libollmchat/History/Session.vala` line 148 emits `session_added` after adding session to list
- `libollmchat/History/Manager.vala` line 311 emits `session_added` in `create_new_session()`
- `HistoryBrowser` connects to this signal for selection/scrolling, but could use `items_changed` from `SessionList` instead

**Action**: 
- Remove `session_added` signal emission from `EmptySession.send()` and `EmptySession.send_message()`
- Remove `session_added` signal emission from `Session` (when adding itself to list)
- Remove `session_added` signal emission from `Manager.create_new_session()`
- Remove `session_added` signal declaration from `Manager`
- Update `HistoryBrowser` to listen to `SessionList.items_changed` signal instead of `session_added` for selection/scrolling
- Remove `session_added` signal connection from `HistoryBrowser`
- Remove `on_session_added()` handler from `HistoryBrowser`

**Note**: `HistoryBrowser` currently uses `session_added` to select the new session and scroll to top. This can be done by listening to `SessionList.items_changed` signal and checking if the change is an addition at position 0 (after sorting).

**Files to Modify**:
- `libollmchat/History/EmptySession.vala` - Remove `session_added` signal emissions (2 places)
- `libollmchat/History/Session.vala` - Remove `session_added` signal emission
- `libollmchat/History/Manager.vala` - Remove `session_added` signal declaration and emission
- `libollmchatgtk/HistoryBrowser.vala` - Update to use `SessionList.items_changed` signal instead

## Files to Modify

### Core Classes
- `libollmchat/Client.vala` - Remove signal declarations and emissions
- `libollmchat/Call/Chat.vala` - Add signal declarations and emissions
- `libollmchat/Call/Base.vala` - Update to emit via Chat instead of Client

### Handlers/Agents
- `libollmchat/Prompt/AgentHandler.vala` - Add direct method calls, remove signal connections
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Inherits direct method calls from AgentHandler

### History/Session
- `libollmchat/History/SessionBase.vala` - Add direct method calls, remove signal connections, relay to Manager signals; Remove `client` property (Phase 6)
- `libollmchat/History/Session.vala` - Inherits direct method calls from SessionBase
- `libollmchat/History/Manager.vala` - Update to provide connection access without requiring client on session (Phase 6)

### UI
- `libollmchatgtk/ChatWidget.vala` - Update signal connections to use Chat
- `libollmchatgtk/ChatView.vala` - Update signal connections to use Chat

## Testing Checklist

- [ ] All Chat creation points properly set `options` from config when available (Phase 0.1)
- [ ] Chat has signal declarations (stream_chunk, stream_start, tool_message) for non-agent usage
- [ ] Chat calls agent methods directly when agent is set (on_stream_chunk, on_stream_start, on_tool_message)
- [ ] Chat emits signals when agent is not set (for non-agent usage)
- [ ] AgentHandler has direct method implementations that relay to Session
- [ ] SessionBase has direct method implementations that relay to Manager signals
- [ ] AgentHandler no longer connects to Client signals
- [ ] SessionBase no longer connects to Client signals
- [ ] All non-agent code connects to Chat signals (not Client signals)
- [ ] `exec_chat()` renamed to `send()` in Call.Chat
- [ ] All call sites updated to use `send()` instead of `exec_chat()`
- [ ] Client no longer has signal declarations
- [ ] Client no longer emits signals
- [ ] Streaming still works correctly for agent usage
- [ ] Streaming still works correctly for non-agent usage
- [ ] Tool messages still work correctly
- [ ] UI updates correctly when streaming starts
- [ ] SessionBase no longer has `client` property (Phase 6)
- [ ] AgentHandler gets connection from session/manager without requiring session.client (Phase 6)

## Related Plans

- [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md) - Removed synchronous signals, kept asynchronous ones temporarily
- [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md) - Parent plan

