# 1.2.7.3. Update Agent Usage to Direct Method Calls

## Overview

Update agent usage to use direct method calls in addition to signals. The flow will be: Chat → (always emit signals) + (if agent set: Agent direct method calls → Session direct method calls → Manager signals) → UI.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md)

## Status

✅ **DONE** - Second phase of signal migration completed.

## Goal

Add direct method calls for agent usage while keeping signals always firing. Chat will always emit signals, and additionally call agent methods directly when an agent is set. This provides both loose coupling (signals) and efficient direct communication (method calls) for agent usage.

## Implementation Steps

### Step 2.1: Add Agent Handler Methods

**Goal**: Add methods to AgentHandler that Chat can call directly (instead of using signals).

**Changes**:
1. Add to `libollmchat/Prompt/AgentHandler.vala`:
   ```vala
   /**
    * Called by Chat when streaming starts.
    * Agent handler should relay to Session.
    */
   public virtual void handle_stream_started()
   {
       // Default: relay to session
       if (this.session != null) {
           this.session.handle_stream_started();
       }
   }
   
   /**
    * Called by Chat when a streaming chunk is received.
    * Agent handler should relay to Session.
    */
   public virtual void handle_stream_chunk(string new_text, bool is_thinking, Response.Chat response)
   {
       // Default: relay to session
       if (this.session != null) {
           this.session.handle_stream_chunk(new_text, is_thinking, response);
       }
   }
   
   /**
    * Called by Chat when a tool sends a status message.
    * Agent handler should relay to Session.
    */
   public virtual void handle_tool_message(Message message)
   {
       // Default: relay to session
       if (this.session != null) {
           this.session.handle_tool_message(message);
       }
   }
   ```

2. Add to `libollmchat/History/SessionBase.vala`:
   ```vala
   /**
    * Called by AgentHandler when streaming starts.
    * Session relays to Manager signals.
    */
   public void handle_stream_started()
   {
       this.manager.stream_start();
   }
   
   /**
    * Called by AgentHandler when a streaming chunk is received.
    * Session relays to Manager signals (Manager doesn't process, just relays to UI).
    * 
    * Note: Manager signals are just a relay point - Manager doesn't need to process
    * these events, it just forwards them to UI components that are connected to Manager signals.
    */
   public void handle_stream_chunk(string new_text, bool is_thinking, Response.Chat response)
   {
       // Relay directly to Manager signals (Manager is just a relay point, no processing needed)
       this.manager.stream_chunk(new_text, is_thinking, response);
   }
   
   /**
    * Called by AgentHandler when a tool sends a status message.
    * Session relays to Manager signals.
    */
   public void handle_tool_message(Message message)
   {
       this.manager.tool_message(message);
   }
   ```

**Result**: Agent handlers and Session have methods that Chat can call directly

### Step 2.2: Update Chat to Call Agent Methods Directly

**Goal**: When Chat has an agent reference, call agent methods directly in addition to emitting signals (signals always fire).

**Changes**:
1. In `libollmchat/Call/Chat.vala`, update `process_streaming_chunk()`:
   ```vala
   // Always emit signal (for non-agent usage and any other listeners)
   this.stream_chunk(new_text, is_thinking, this.streaming_response);
   
   // If Chat has agent reference, also call agent method directly
   if (this.agent != null) {
       this.agent.handle_stream_chunk(new_text, is_thinking, this.streaming_response);
   }
   ```

2. Similar updates for `stream_start()` and `tool_message()` emissions:
   ```vala
   // Always emit signal
   this.stream_start();
   
   // If agent set, also call directly
   if (this.agent != null) {
       this.agent.handle_stream_started();
   }
   ```

**Result**: Signals always fire, and agent usage additionally uses direct method calls for efficient communication

### Step 2.3: Remove Signal Connections from AgentHandler and SessionBase

**Goal**: Remove signal connections from AgentHandler and SessionBase since agent usage now uses direct method calls (signals still fire from Chat for loose coupling).

**Changes**:
1. Remove from `libollmchat/Prompt/AgentHandler.vala`:
   - Remove `stream_chunk_id`, `stream_start_id` fields
   - Remove signal connections in constructor
   - Remove signal disconnections in destructor
   - Remove `handle_stream_chunk()` method (replaced by `handle_stream_chunk()`)

2. Remove from `libollmchat/History/SessionBase.vala`:
   - Remove `stream_chunk_id`, `stream_start_id`, `tool_message_id` fields
   - Remove signal connections in `activate()` (including the `stream_content` emission - no listeners use it)
   - Remove signal disconnections in `deactivate()`
   - Remove `stream_chunk_handler_id` field and connection (replaced by direct method calls)
   - Note: The current code emits `manager.stream_content()` in addition to `manager.stream_chunk()`, but no listeners connect to `stream_content`. The direct method call only emits `stream_chunk`.

**Result**: Agent usage uses direct method calls (in addition to signals that always fire from Chat)

## Files to Modify

- `libollmchat/Prompt/AgentHandler.vala` - Add direct method calls, remove signal connections
- `libollmchat/History/SessionBase.vala` - Add direct method calls, remove signal connections, relay to Manager signals
- `libollmchat/Call/Chat.vala` - Update to call agent methods directly when agent is set
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Inherits direct method calls from AgentHandler

## Testing Checklist

- [x] Chat always emits signals (regardless of agent presence)
- [x] Chat calls agent methods directly when agent is set (handle_stream_started, handle_stream_chunk, handle_tool_message)
- [x] AgentHandler has direct method implementations that relay to Session
- [x] SessionBase has direct method implementations that relay to Manager signals
- [x] SessionBase.handle_stream_chunk() only emits `manager.stream_chunk()` (not `stream_content`)
- [x] AgentHandler no longer connects to Client signals
- [x] SessionBase no longer connects to Client signals (removed `stream_content` emission)
- [ ] Streaming still works correctly for agent usage (requires runtime testing)
- [ ] Tool messages still work correctly for agent usage (requires runtime testing)
- [ ] UI updates correctly when streaming starts for agent usage (requires runtime testing)

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md) - Parent plan
- [1.2.7.2. Add Signals to Chat](./1.2.7.2-DONE-add-signals-to-chat.md) - Previous phase
- [1.2.7.4. Migrate Non-Agent Signal Connections](./1.2.7.4-migrate-non-agent-signals.md) - Next phase
- [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md) - Grandparent plan

