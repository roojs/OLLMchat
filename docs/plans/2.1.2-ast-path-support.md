# 2.1.2. AST Path Support for ReadFile and EditFile

## Overview

Add Abstract Syntax Tree (AST) path support to ReadFile and EditFile tools, allowing LLMs to reference code blocks using natural language paths like `ast-path: namespace/classname/methodname` instead of line numbers. This enables more intuitive code manipulation commands.

## Status

✅ **DONE** - All phases for this plan are complete. Infrastructure, path resolution, ReadFile integration, and Codebase Search integration are all implemented. See related plans 2.1.4 and 2.1.5 for additional enhancements.

### Completed
- ✅ **Phase 1**: AST Parser Infrastructure
  - ✅ `libocfiles/TreeBase` - Full AST parsing using TreeSitter
  - ✅ `parse_content()`, `init_parser()`, `load_file_content()` methods exist
  - ✅ Language detection and parser selection working
  - ✅ Used by `ReadFile/Summarize.vala` for file summaries
  - ✅ `traverse_ast()` method for AST traversal (used in indexing)

- ✅ **Phase 2**: Path Resolution (reverse lookup)
  - ✅ `Tree.lookup_path(string ast_path, out int start_line, out int end_line)` - **IMPLEMENTED** in `libocfiles/Tree.vala`
  - ✅ AST parsing infrastructure exists (can parse file and traverse AST)
  - ✅ Path building exists (`ast_path()` method)
  - ✅ Path resolution used by ReadFile and oc-test-files

- ✅ **Phase 3**: ReadFile Integration
  - ✅ Add `ast_path` parameter to `RequestReadFile` - **IMPLEMENTED** in `liboctools/ReadFile/Request.vala`
  - ✅ Resolve AST path to line range and use existing line reading logic - **IMPLEMENTED** via `resolve_ast_path()` method
  - ✅ AST path support in `oc-test-files.vala` - **IMPLEMENTED** (--ast-path option)

- ✅ **Phase 7**: Codebase Search Tool Integration
  - ✅ AST path generation in `libocfiles/Tree.vala` (`ast_path()` method)
  - ✅ AST path storage in `libocvector/VectorMetadata.vala` (property and database schema)
  - ✅ AST path population during indexing in `libocvector/Indexing/Tree.vala`
  - ✅ AST path output in search results (`libocvector/Tool/RequestCodebaseSearch.vala`)

### Remaining Work

- ✅ All planned phases for this plan are complete. See related plans:
  - **2.1.4** - AST Path EditFile Integration (EditMode support)
  - **2.1.5** - AST Path Comment Support (optional enhancement)

### Implementation Notes
- Current AST path format uses `-` separator: `Namespace-Class-Method` (not `/` as originally planned)
- AST paths are built from TreeSitter nodes by traversing up the AST tree
- Path format: `namespace.classname-classname-methodname` (namespace parts joined with `.`, class/method parts joined with `-`)

## Related Plans

- **2.1.4** - AST Path EditFile Integration (EditMode AST path support)
- **2.1.5** - AST Path Comment Support (optional enhancement)
- **2.1** - File Reading Tool (current line-based implementation)
- **2.1.1** - File Access for Tools (file buffer system)
- **2.4** - Edit File and Edit Mode Tool (current line-based implementation)
- **2.4.1** - Edit Tool Migrate to Buffer (buffer-based editing)
- **2.10** - Codebase Search Tool (AST path support implemented)

## Purpose

Enable LLMs to use natural language references to code blocks:
- `ast-path: namespace/classname/methodname` - Reference a method
- `ast-path: namespace/classname` - Reference a class
- `ast-path: namespace/classname/propertyname` - Reference a property
- `ast-path: markdown/heading` - Reference markdown sections

Instead of requiring precise line numbers:
- `read file.txt lines 45-67` → `read file.txt ast-path: MyClass/myMethod`
- `replace lines 45-67 with ...` → `replace ast-path: MyClass/myMethod with ...`
- `insert after line 89` → `insert after ast-path: MyClass/myMethod`

## AST Path Format

### Current Implementation (Phase 7 - Codebase Search)

**Actual Format (as implemented):**
- Uses `-` separator for class/method parts: `Namespace-Class-Method`
- Uses `.` separator for namespace parts: `Namespace.SubNamespace-Class-Method`
- Format: `{namespace}.{namespace}-{class}-{class}-{method}`

**Examples (current implementation):**
- `OLLMvector.Indexing-OuterClass-InnerClass-methodName` - Nested class method
- `Namespace-Class-methodName` - Simple class method
- `Namespace` - Just namespace (no class/method)

### Planned Format (for ReadFile/EditFile - Phases 1-5)

**Full Path (planned):**
```
ast-path: {namespace}/{classname}/{methodname}
ast-path: {namespace}/{classname}/{propertyname}
ast-path: {namespace}/{classname}/{fieldname}
ast-path: {namespace}/{classname} - Partial path (entire class)
ast-path: {methodname} - Partial path (first method/function with that name)
```

**Markdown Paths:**
```
ast-path: markdown/{heading-level}/{heading-text}
ast-path: markdown/{heading-text} - Partial path (first heading with that text)
```

**Examples (planned):**
- `ast-path: OLLMchat/Client/chat` - Method chat in class Client in namespace OLLMchat
- `ast-path: OLLMchat/Client` - Entire Client class
- `ast-path: chat` - First method/function named "chat" (partial path)
- `ast-path: markdown/1/Introduction` - Markdown heading "Introduction" at level 1
- `ast-path: markdown/Introduction` - First markdown heading with text "Introduction" (partial path)

**Note:** The current implementation uses `-` separator, but the planned ReadFile/EditFile integration may use `/` separator for consistency with natural language paths. A conversion layer may be needed between formats.

### Path Resolution

**Resolution Process:**
1. ✅ Parse file to build AST (language-specific parser) - **DONE** via `TreeBase.parse_content()`
2. ✅ Resolve path through AST (namespace → class → method) - **DONE** via `Tree.lookup_path()` method
3. ✅ Convert AST node to line range (start_line, end_line) - **DONE** via `TreeSitter.node_get_start_point()` / `node_get_end_point()`
4. ✅ Use line range with existing ReadFile/EditFile tools - **DONE** (ReadFile integration complete, EditFile in plan 2.1.4)

**What's Done:**
- ✅ Reverse lookup: Given an AST path string, find the matching node in the AST tree - **IMPLEMENTED** in `Tree.lookup_path()`
- ✅ Partial path resolution: Support partial paths (e.g., just method name) to find first match - **IMPLEMENTED** via suffix matching in `Tree.lookup_path()`

**Fallback:**
- If AST parsing fails, fall back to line numbers
- If path not found, return error with suggestions

## Implementation Details

### Phase 1: AST Parser Infrastructure ✅ DONE

**1. AST Parser Base** ✅
- ✅ `libocfiles/TreeBase` - Base AST parser class using TreeSitter
- ✅ `parse_content(string code_content)` - Parse file content to AST tree
- ✅ `init_parser()` - Initialize parser with language
- ✅ `load_file_content()` - Load and split file content
- ✅ `load_tree_sitter_language()` - Dynamic language loading
- ✅ Language detection from file extension (via `File.language`)

**2. AST Traversal** ✅
- ✅ `traverse_ast()` - Recursive AST traversal (used in indexing)
- ✅ `element_name()` - Extract element names from nodes
- ✅ `get_element_type()` - Determine element types from node types
- ✅ `ast_path()` - Build AST path from node (traverse up tree)

**3. Language Support** ✅
- ✅ TreeSitter-based parsing (supports all tree-sitter languages)
- ✅ Language-specific node type mapping
- ✅ Markdown heading support
- ✅ Vala, JavaScript, Python, C/C++, and more via tree-sitter

**4. Usage** ✅
- ✅ Used by `ReadFile/Summarize.vala` for file structure summaries
- ✅ Used by `libocvector/Indexing/Tree.vala` for codebase indexing
- ✅ AST parsing is available for any file via `TreeBase` class

### Phase 2: Path Resolution ✅ DONE

**Path Resolution Methods**

**1. Single File Lookup** - For resolving AST paths in a specific file
- ✅ `ProjectManager.tree_factory(File file)` - Get or create Tree instance for file (cached)
- ✅ `Tree.parse()` - Parse file and build AST path maps (async, cached based on file mtime)
- ✅ `Tree.lookup_path(string ast_path, out int start_line, out int end_line)` - Lookup AST path to line range
  - Tries exact match first
  - Falls back to suffix matching (finds first path that ends with the search path)
  - Returns `true` if found, `false` if not found
  - Sets `start_line` and `end_line` output parameters (1-indexed, -1 if not found)
  - **Existing infrastructure:** `Tree` class already implements this in `libocfiles/Tree.vala`
  - **Caching:** Tree instances are cached in `ProjectManager.tree_cache`, and parsing is skipped if file hasn't changed

**2. Multi-File Search** - For searching AST paths across multiple files (codebase search)
- ✅ `VectorMetadata.lookup_path(SQ.Database db, int64[] file_ids, string ast_path)` - Lookup AST path across multiple files
  - Searches within specified file_ids (empty array searches all files)
  - Tries exact match first, then falls back to suffix matching
  - Returns list of VectorMetadata objects ordered by exact matches first
  - **Use case:** Finding all occurrences of an AST path across the codebase
  - **Implementation:** Uses database query with LIKE pattern matching

**2. AST Traversal for Resolution**
- ✅ AST traversal infrastructure exists (`traverse_ast()` method)
- ✅ `Tree.lookup_path()` adapts traversal to search for specific path/name
- ✅ Supports partial matches (e.g., just classname) via suffix matching
- ✅ Returns best match (exact match first, then suffix match) or false if not found

### Phase 3: ReadFile Integration ✅ DONE

**1. Update RequestReadFile** ✅
- ✅ Add `ast_path` parameter (alternative to start_line/end_line) - **IMPLEMENTED** in `liboctools/ReadFile/Request.vala` line 30
- ✅ Resolve AST path to line range using `ProjectManager.tree_factory()` → `tree.parse()` → `tree.lookup_path()` - **IMPLEMENTED** in `resolve_ast_path()` method (lines 128-149)
- ✅ Use resolved line range with existing line range logic - **IMPLEMENTED** in `execute_request()` (lines 267-278)

**2. AST Path Resolution in ReadFile** ✅
- ✅ `ast_path` property added to `Request` class
- ✅ `resolve_ast_path()` method implemented (async, resolves AST path to start_line/end_line)
- ✅ AST path resolution integrated into `execute_request()` before line range validation
- ✅ Error handling for AST path not found or file not in project
- ✅ **Implementation:** `liboctools/ReadFile/Request.vala`

**3. Permission Questions** ✅
- ✅ `build_perm_question()` shows AST path if provided - **IMPLEMENTED** (lines 239-241)
- ✅ Format: "Read file 'file.vala' (ast-path: OLLMchat-Client-chat)?"
- ✅ AST path included in request message to UI (lines 291-293)
- ✅ Resolved line range shown in UI output when AST path is used (lines 427-432)

**4. Test Tool Support** ✅
- ✅ `oc-test-files.vala` supports `--ast-path` option - **IMPLEMENTED** (line 109)
- ✅ AST path resolution in `run_read()` method (lines 316-334)
- ✅ Help text updated to document AST path option (lines 55-56)

## Related Enhancement Plans

- **2.1.4** - AST Path EditFile Integration - Add AST path support to EditMode tool
- **2.1.5** - AST Path Comment Support - Add option to include comments when reading/editing via AST paths

### Phase 7: Codebase Search Tool Integration ✅ DONE

**1. Extend TreeBase in libocfiles** ✅
- ✅ `libocfiles/Tree.vala` (TreeBase class) - Added `ast_path()` method
- ✅ `ast_path(TreeSitter.Node node, string code_content)` - Builds AST path by traversing up AST tree
- ✅ `Tree.lookup_path(string ast_path, out int start_line, out int end_line)` - **IMPLEMENTED** (path resolution for ReadFile/EditFile)
- ⏳ `get_ast_node(string ast_path)` method - NOT YET IMPLEMENTED (optional enhancement)
- ✅ `Tree.parse()` - Builds AST path map internally (used by `lookup_path()`)

**Implementation Details:**
- AST path format: Uses `-` separator (e.g., `Namespace-Class-Method`)
- Namespace parts joined with `.` (e.g., `Namespace.SubNamespace`)
- Class hierarchy joined with `-` (e.g., `OuterClass-InnerClass`)
- Final format: `namespace.classname-classname-methodname`

**2. Update VectorMetadata** ✅
- ✅ Added `ast_path` property to VectorMetadata (string, default = "")
- ✅ Updated database schema: `ast_path TEXT NOT NULL DEFAULT ''`
- ✅ Database migration: `ALTER TABLE vector_metadata ADD COLUMN ast_path`
- ✅ Populate ast_path when creating VectorMetadata from AST nodes
- ✅ Store ast_path in database for search queries
- ✅ File elements use `ast_path = ""` (empty string)

**3. Update Codebase Search Tool** ✅
- ✅ `libocvector/Tool/RequestCodebaseSearch.vala` - Includes AST path in search results
- ✅ Search results include AST paths for matched elements
- ⏳ Searching by AST path filter - NOT YET IMPLEMENTED
- ⏳ AST path filters in search queries - NOT YET IMPLEMENTED

**4. Search Result Format** ✅
- ✅ Include AST path in search result metadata
- ✅ Format: `ast-path: {metadata.ast_path}` (only if ast_path is not empty)
- ✅ Output in `format_results()` method
- ⏳ Direct reference to search results using AST paths in ReadFile/EditFile - NOT YET IMPLEMENTED

**5. AST Path Indexing** ✅
- ✅ Index AST paths during codebase indexing (`libocvector/Indexing/Tree.vala`)
- ✅ Store AST paths in VectorMetadata database records
- ✅ AST paths built during `extract_element_metadata()` using `this.ast_path(node, code_content)`
- ⏳ Fast AST path lookups during search - NOT YET IMPLEMENTED (needs path resolution)
- ⏳ Reverse lookups (find file from AST path) - NOT YET IMPLEMENTED

## Files to Create

### AST Infrastructure
- ❌ **NOT NEEDED** - AST infrastructure already exists in `libocfiles/TreeBase`
  - No need for separate `libocast` library
  - TreeSitter parsing is already implemented
  - AST traversal methods exist
  - Just need to add path resolution methods to `TreeBase`

### TreeBase Extensions (libocfiles)
- ✅ `libocfiles/Tree.vala` (TreeBase class) - AST infrastructure exists
  - ✅ `ast_path(TreeSitter.Node node, string code_content)` - Generate AST path from node
  - ✅ `parse_content(string code_content)` - Parse file to AST tree
  - ✅ `init_parser()` - Initialize parser with language
  - ✅ `load_file_content()` - Load file content
  - ✅ `traverse_ast()` - Recursive AST traversal
  - ✅ `element_name()` - Extract element names
  - ✅ `get_element_type()` - Determine element types
  - ✅ `Tree.lookup_path(string ast_path, out int start_line, out int end_line)` - **IMPLEMENTED** in `libocfiles/Tree.vala` (resolves path to line range, supports full and partial paths)

### Language Parsers
- ❌ **NOT NEEDED** - TreeSitter provides language parsers dynamically
  - ✅ Vala, JavaScript, Python, C/C++, Markdown, and more supported via tree-sitter
  - ✅ Language detection and loading already implemented in `TreeBase`
  - ✅ No need for separate parser classes

### Integration Helpers (Optional)
- Removed - Natural language parsing is not planned

## Files to Modify

### ReadFile Tool
- ✅ `liboctools/ReadFile/Request.vala` - AST path parameter and resolution implemented
- ✅ `liboctools/ReadFile/Tool.vala` - AST path documented in parameter_description
- ✅ `examples/oc-test-files.vala` - AST path support via --ast-path option

### EditFile Tool
- See **2.1.4** - AST Path EditFile Integration plan for EditFile modifications

### Codebase Search Tool
- ✅ `libocvector/Indexing/Tree.vala` - Uses TreeBase `ast_path()` method in `extract_element_metadata()`
- ✅ `libocvector/VectorMetadata.vala` - Added `ast_path` property and database schema
- ✅ `libocfiles/Tree.vala` - AST path resolution via `Tree.lookup_path()` method (Phase 2)
- ✅ `libocvector/Tool/RequestCodebaseSearch.vala` - Includes AST path in search result output
- ✅ `libocvector/Indexing/VectorBuilder.vala` - Stores ast_path when building vectors
- ✅ `libocvector/Indexing/Analysis.vala` - Creates file elements with `ast_path = ""`

### Build System
- `meson.build` - Add libocast dependency
- `liboctools/meson.build` - Link to libocast
- `libocfiles/meson.build` - Ensure TreeBase has AST path support
- `libocvector/meson.build` - Link to libocast for AST path support

## Language Support

### Phase 1: Vala (Priority)
- Full Vala AST parsing
- Namespace, class, method, property support
- Signal and delegate support
- Use Vala compiler or custom parser

### Phase 2: Markdown
- Heading structure parsing
- Section boundaries
- List and code block support

### Phase 3: JavaScript/TypeScript
- Function, class, method support
- Module/namespace support
- Arrow function support

### Phase 4: Python
- Function, class, method support
- Module support
- Decorator support

### Phase 5: Other Languages
- C/C++ (basic support)
- Java (basic support)
- Rust (basic support)

## AST Parser Implementation Options

### Option A: Language-Specific Parsers
- Use existing parsers (Vala compiler, tree-sitter, etc.)
- More accurate, language-specific features
- Requires multiple dependencies

### Option B: Tree-Sitter
- Unified parser for multiple languages
- Good accuracy, active development
- Single dependency

### Option C: Custom Simple Parsers
- Regex-based or simple recursive descent
- Lightweight, no dependencies
- Less accurate, may miss edge cases

**Recommendation**: Start with Option C for Vala and Markdown, migrate to Option B (tree-sitter) for broader language support.

## Example Usage

### ReadFile with AST Path
```
Tool: read_file
Parameters:
  file_path: "libollmchat/Client.vala"
  ast_path: "OLLMchat/Client/chat"
```

**Result**: Returns the `chat` method from the `Client` class in the `OLLMchat` namespace.

**Note**: All EditFile examples have been moved to **2.1.4** - AST Path EditFile Integration plan.

### Codebase Search with AST Path
```
Tool: codebase_search
Parameters:
  query: "database connection"
  ast_path_filter: "OLLMchat/Client/*"  # Search only in Client class methods
```

**Result**: Returns search results with AST paths:
```
Results:
1. libollmchat/Client.vala:ast-path: OLLMchat/Client/connect
   "Establishes database connection..."
2. libollmchat/Client.vala:ast-path: OLLMchat/Client/disconnect
   "Closes database connection..."
```

**Usage**: Search results can be directly used with ReadFile/EditFile:
```
read_file(file_path: "libollmchat/Client.vala", ast_path: "OLLMchat/Client/connect")
```

## Error Handling

**Path Not Found:**
- Return clear error message
- Suggest similar paths (fuzzy matching)
- List available AST nodes
- Provide line number fallback

**Multiple Matches:**
- For partial `ast-path:` (e.g., just method name), return first match with warning
- For full `ast-path:`, require complete path to disambiguate
- List all matches for user selection when ambiguous

**Parse Errors:**
- Fall back to line numbers
- Log parse error for debugging
- Continue with partial AST if possible

## Performance Considerations

**Caching:**
- Cache AST for files (invalidate on file change)
- Cache path resolutions
- Use file modification time for cache invalidation

**Lazy Parsing:**
- Parse AST only when AST path is used
- Skip parsing for line-number-based operations
- Background parsing for large files

**Incremental Updates:**
- Update AST incrementally on file edits
- Re-parse only affected sections
- Maintain AST cache consistency

## Future Enhancements

- **Wildcard Support**: `ast-path: */Client/*` - Match all methods in Client class
- **Relative Paths**: `ast-path: ../ParentClass/method` - Relative AST navigation
- **AST Queries**: Query language for complex AST matching
- **Multi-File Paths**: Reference across multiple files
- **AST Diff**: Show AST-level diffs instead of line diffs
- **Refactoring Support**: AST-aware refactoring operations
- **Code Navigation**: Jump to AST node definitions
- **AST Visualization**: Visual representation of file structure
- **Search by AST Path**: Search codebase using AST path patterns
- **AST Path Completion**: Auto-complete AST paths in UI
- **Cross-Reference**: Find all references to an AST path across codebase

## Testing

**Unit Tests:**
- AST parsing for each language
- Path resolution accuracy
- Error handling
- Edge cases

**Integration Tests:**
- ReadFile with AST paths
- EditFile with AST paths
- Codebase search with AST paths
- Natural language parsing
- Multi-language support
- TreeBase AST path resolution
- VectorMetadata AST path storage

**Performance Tests:**
- Large file parsing
- Cache performance
- Path resolution speed

