# 2.1.2. AST Path Support for ReadFile and EditFile

## Overview

Add Abstract Syntax Tree (AST) path support to ReadFile and EditFile tools, allowing LLMs to reference code blocks using natural language paths like `ast-path: namespace/classname/methodname` instead of line numbers. This enables more intuitive code manipulation commands.

## Status

üü° **MOSTLY DONE** - Most infrastructure is complete. Only path resolution and ReadFile/EditFile integration remain.

### Completed
- ‚úÖ **Phase 1**: AST Parser Infrastructure
  - ‚úÖ `libocfiles/TreeBase` - Full AST parsing using TreeSitter
  - ‚úÖ `parse_content()`, `init_parser()`, `load_file_content()` methods exist
  - ‚úÖ Language detection and parser selection working
  - ‚úÖ Used by `ReadFile/Summarize.vala` for file summaries
  - ‚úÖ `traverse_ast()` method for AST traversal (used in indexing)

- ‚úÖ **Phase 6**: Codebase Search Tool Integration
  - ‚úÖ AST path generation in `libocfiles/Tree.vala` (`ast_path()` method)
  - ‚úÖ AST path storage in `libocvector/VectorMetadata.vala` (property and database schema)
  - ‚úÖ AST path population during indexing in `libocvector/Indexing/Tree.vala`
  - ‚úÖ AST path output in search results (`libocvector/Tool/RequestCodebaseSearch.vala`)

### Remaining Work
- ‚è≥ **Phase 2**: Path Resolution (reverse lookup)
  - ‚è≥ `resolve_ast_path(string ast_path)` - Resolve path string to node/line range
  - ‚è≥ `resolve_ast_name(string name)` - Find node by name (first match)
  - ‚úÖ AST parsing infrastructure exists (can parse file and traverse AST)
  - ‚úÖ Path building exists (`ast_path()` method)

- ‚è≥ **Phase 3**: ReadFile Integration
  - ‚è≥ Add `ast_path` and `ast_name` parameters to `RequestReadFile`
  - ‚è≥ Resolve AST path to line range and use existing line reading logic

- ‚è≥ **Phase 4**: EditFile Integration
  - ‚è≥ Add AST path support to `RequestEditMode`
  - ‚è≥ Resolve AST path to line range for edit operations

- ‚è≥ **Phase 5**: Natural Language Parsing (optional enhancement)
  - ‚è≥ Extract AST paths from natural language text

### Implementation Notes
- Current AST path format uses `-` separator: `Namespace-Class-Method` (not `/` as originally planned)
- AST paths are built from TreeSitter nodes by traversing up the AST tree
- Path format: `namespace.classname-classname-methodname` (namespace parts joined with `.`, class/method parts joined with `-`)

## Related Plans

- **2.1** - File Reading Tool (current line-based implementation)
- **2.1.1** - File Access for Tools (file buffer system)
- **2.4** - Edit File and Edit Mode Tool (current line-based implementation)
- **2.4.1** - Edit Tool Migrate to Buffer (buffer-based editing)
- **2.10** - Codebase Search Tool (needs AST path support for search results)

## Purpose

Enable LLMs to use natural language references to code blocks:
- `ast-path: namespace/classname/methodname` - Reference a method
- `ast-path: namespace/classname` - Reference a class
- `ast-path: namespace/classname/propertyname` - Reference a property
- `ast-name: methodname` - Reference by name (searches for first match)
- `ast-path: markdown/heading` - Reference markdown sections

Instead of requiring precise line numbers:
- `read file.txt lines 45-67` ‚Üí `read file.txt ast-path: MyClass/myMethod`
- `replace lines 45-67 with ...` ‚Üí `replace ast-path: MyClass/myMethod with ...`
- `insert after line 89` ‚Üí `insert after ast-name: myMethod`

## AST Path Format

### Current Implementation (Phase 6 - Codebase Search)

**Actual Format (as implemented):**
- Uses `-` separator for class/method parts: `Namespace-Class-Method`
- Uses `.` separator for namespace parts: `Namespace.SubNamespace-Class-Method`
- Format: `{namespace}.{namespace}-{class}-{class}-{method}`

**Examples (current implementation):**
- `OLLMvector.Indexing-OuterClass-InnerClass-methodName` - Nested class method
- `Namespace-Class-methodName` - Simple class method
- `Namespace` - Just namespace (no class/method)

### Planned Format (for ReadFile/EditFile - Phases 1-5)

**Full Path (planned):**
```
ast-path: {namespace}/{classname}/{methodname}
ast-path: {namespace}/{classname}/{propertyname}
ast-path: {namespace}/{classname}/{fieldname}
```

**Name-Only (searches for first match):**
```
ast-name: {methodname}
ast-name: {classname}
ast-name: {propertyname}
```

**Markdown Paths:**
```
ast-path: markdown/{heading-level}/{heading-text}
ast-name: {heading-text}
```

**Examples (planned):**
- `ast-path: OLLMchat/Client/chat` - Method chat in class Client in namespace OLLMchat
- `ast-path: OLLMchat/Client` - Entire Client class
- `ast-name: chat` - First method/function named "chat"
- `ast-path: markdown/1/Introduction` - Markdown heading "Introduction" at level 1
- `ast-name: Introduction` - First markdown heading with text "Introduction"

**Note:** The current implementation uses `-` separator, but the planned ReadFile/EditFile integration may use `/` separator for consistency with natural language paths. A conversion layer may be needed between formats.

### Path Resolution

**Resolution Process:**
1. ‚è≥ Parse AST path from natural language or structured format (TODO)
2. ‚úÖ Parse file to build AST (language-specific parser) - **ALREADY DONE** via `TreeBase.parse_content()`
3. ‚è≥ Resolve path through AST (namespace ‚Üí class ‚Üí method) - **TODO**: Add `resolve_ast_path()` method
4. ‚úÖ Convert AST node to line range (start_line, end_line) - **ALREADY DONE** via `TreeSitter.node_get_start_point()` / `node_get_end_point()`
5. ‚úÖ Use line range with existing ReadFile/EditFile tools - **ALREADY DONE** (line-based reading/editing works)

**What's Missing:**
- Reverse lookup: Given an AST path string, find the matching node in the AST tree
- Name search: Given an element name, find the first matching node

**Fallback:**
- If AST parsing fails, fall back to line numbers
- If path not found, return error with suggestions

## Implementation Details

### Phase 1: AST Parser Infrastructure ‚úÖ DONE

**1. AST Parser Base** ‚úÖ
- ‚úÖ `libocfiles/TreeBase` - Base AST parser class using TreeSitter
- ‚úÖ `parse_content(string code_content)` - Parse file content to AST tree
- ‚úÖ `init_parser()` - Initialize parser with language
- ‚úÖ `load_file_content()` - Load and split file content
- ‚úÖ `load_tree_sitter_language()` - Dynamic language loading
- ‚úÖ Language detection from file extension (via `File.language`)

**2. AST Traversal** ‚úÖ
- ‚úÖ `traverse_ast()` - Recursive AST traversal (used in indexing)
- ‚úÖ `element_name()` - Extract element names from nodes
- ‚úÖ `get_element_type()` - Determine element types from node types
- ‚úÖ `ast_path()` - Build AST path from node (traverse up tree)

**3. Language Support** ‚úÖ
- ‚úÖ TreeSitter-based parsing (supports all tree-sitter languages)
- ‚úÖ Language-specific node type mapping
- ‚úÖ Markdown heading support
- ‚úÖ Vala, JavaScript, Python, C/C++, and more via tree-sitter

**4. Usage** ‚úÖ
- ‚úÖ Used by `ReadFile/Summarize.vala` for file structure summaries
- ‚úÖ Used by `libocvector/Indexing/Tree.vala` for codebase indexing
- ‚úÖ AST parsing is available for any file via `TreeBase` class

### Phase 2: Path Resolution ‚è≥ TODO

**1. Path Resolver Methods** (to add to `TreeBase`)
- ‚è≥ `resolve_ast_path(string ast_path, string code_content)` - Resolve path string to node/line range
  - Parse AST path format (convert `-` separator to traversal logic)
  - Traverse AST tree to find matching node
  - Return `ASTRange` with start_line and end_line
- ‚è≥ `resolve_ast_name(string name, string code_content)` - Find node by name (first match)
  - Traverse AST tree searching for element with matching name
  - Return `ASTRange` with start_line and end_line

**2. Path Parsing**
- ‚è≥ Parse `ast-path:` format (handle `-` separator used in current implementation)
- ‚è≥ Extract namespace, class, method components
- ‚è≥ Handle markdown paths
- ‚è≥ Validate path format

**3. AST Traversal for Resolution**
- ‚úÖ AST traversal infrastructure exists (`traverse_ast()` method)
- ‚è≥ Need to adapt traversal to search for specific path/name
- ‚è≥ Support partial matches (e.g., just classname)
- ‚è≥ Return best match or error

**Note:** The infrastructure is already there - we just need to add the reverse lookup methods that find nodes by path/name instead of building paths from nodes.

### Phase 3: ReadFile Integration

**1. Update RequestReadFile**
- Add `ast_path` parameter (alternative to start_line/end_line)
- Add `ast_name` parameter (name-only search)
- Parse AST path if provided
- Resolve to line range
- Use existing line range logic

**2. AST Path Parsing in ReadFile**
```vala
public class RequestReadFile {
    public string ast_path { get; set; default = ""; }
    public string ast_name { get; set; default = ""; }
    
    private ASTRange? resolve_ast_path() {
        if (ast_path != "") {
            return path_resolver.resolve_path(file_path, ast_path);
        } else if (ast_name != "") {
            return path_resolver.resolve_name(file_path, ast_name);
        }
        return null;
    }
}
```

**3. Permission Questions**
- Update permission question to show AST path
- "Read file 'file.vala' (ast-path: OLLMchat/Client/chat)?"
- Fall back to line numbers if AST resolution succeeds

### Phase 4: EditFile Integration

**1. Update RequestEditMode**
- Add AST path support to edit operations
- `replace_ast_path` - Replace code block at AST path
- `insert_after_ast_path` - Insert after AST path
- `insert_before_ast_path` - Insert before AST path
- `delete_ast_path` - Delete code block at AST path

**2. AST Path in Edit Operations**
```vala
public class EditOperation {
    public string? ast_path { get; set; }
    public string? ast_name { get; set; }
    public EditType type { get; set; } // REPLACE, INSERT_AFTER, INSERT_BEFORE, DELETE
    
    public ASTRange? resolve_range() {
        if (ast_path != null) {
            return path_resolver.resolve_path(file_path, ast_path);
        } else if (ast_name != null) {
            return path_resolver.resolve_name(file_path, ast_name);
        }
        return null;
    }
}
```

**3. Edit Validation**
- Validate AST path exists before edit
- Ensure edit boundaries match AST node boundaries
- Warn if edit spans multiple AST nodes
- Support partial node edits (future enhancement)

### Phase 5: Natural Language Parsing

**1. AST Path Extraction**
- Parse natural language for AST path references
- Extract `ast-path:` and `ast-name:` patterns
- Support variations: "ast path", "ast-path", "AST path", etc.
- Extract from LLM tool call parameters

**2. Pattern Matching**
- Regex patterns for AST path extraction
- Support quoted paths: `ast-path: "namespace/class/method"`
- Support unquoted paths: `ast-path: namespace/class/method`
- Handle whitespace variations

**3. Error Messages**
- Clear error messages when AST path not found
- Suggest similar paths (fuzzy matching)
- List available AST nodes in file
- Provide line number fallback suggestions

### Phase 6: Codebase Search Tool Integration ‚úÖ DONE

**1. Extend TreeBase in libocfiles** ‚úÖ
- ‚úÖ `libocfiles/Tree.vala` (TreeBase class) - Added `ast_path()` method
- ‚úÖ `ast_path(TreeSitter.Node node, string code_content)` - Builds AST path by traversing up AST tree
- ‚è≥ `resolve_ast_path(string ast_path)` method - NOT YET IMPLEMENTED (needed for ReadFile/EditFile)
- ‚è≥ `resolve_ast_name(string name)` method - NOT YET IMPLEMENTED (needed for ReadFile/EditFile)
- ‚è≥ `get_ast_node(string ast_path)` method - NOT YET IMPLEMENTED
- ‚è≥ `build_ast_path_map()` method - NOT YET IMPLEMENTED

**Implementation Details:**
- AST path format: Uses `-` separator (e.g., `Namespace-Class-Method`)
- Namespace parts joined with `.` (e.g., `Namespace.SubNamespace`)
- Class hierarchy joined with `-` (e.g., `OuterClass-InnerClass`)
- Final format: `namespace.classname-classname-methodname`

**2. Update VectorMetadata** ‚úÖ
- ‚úÖ Added `ast_path` property to VectorMetadata (string, default = "")
- ‚úÖ Updated database schema: `ast_path TEXT NOT NULL DEFAULT ''`
- ‚úÖ Database migration: `ALTER TABLE vector_metadata ADD COLUMN ast_path`
- ‚úÖ Populate ast_path when creating VectorMetadata from AST nodes
- ‚úÖ Store ast_path in database for search queries
- ‚úÖ File elements use `ast_path = ""` (empty string)

**3. Update Codebase Search Tool** ‚úÖ
- ‚úÖ `libocvector/Tool/RequestCodebaseSearch.vala` - Includes AST path in search results
- ‚úÖ Search results include AST paths for matched elements
- ‚è≥ Searching by AST path filter - NOT YET IMPLEMENTED
- ‚è≥ AST path filters in search queries - NOT YET IMPLEMENTED

**4. Search Result Format** ‚úÖ
- ‚úÖ Include AST path in search result metadata
- ‚úÖ Format: `ast-path: {metadata.ast_path}` (only if ast_path is not empty)
- ‚úÖ Output in `format_results()` method
- ‚è≥ Direct reference to search results using AST paths in ReadFile/EditFile - NOT YET IMPLEMENTED

**5. AST Path Indexing** ‚úÖ
- ‚úÖ Index AST paths during codebase indexing (`libocvector/Indexing/Tree.vala`)
- ‚úÖ Store AST paths in VectorMetadata database records
- ‚úÖ AST paths built during `extract_element_metadata()` using `this.ast_path(node, code_content)`
- ‚è≥ Fast AST path lookups during search - NOT YET IMPLEMENTED (needs path resolution)
- ‚è≥ Reverse lookups (find file from AST path) - NOT YET IMPLEMENTED

## Files to Create

### AST Infrastructure
- ‚ùå **NOT NEEDED** - AST infrastructure already exists in `libocfiles/TreeBase`
  - No need for separate `libocast` library
  - TreeSitter parsing is already implemented
  - AST traversal methods exist
  - Just need to add path resolution methods to `TreeBase`

### TreeBase Extensions (libocfiles)
- ‚úÖ `libocfiles/Tree.vala` (TreeBase class) - AST infrastructure exists
  - ‚úÖ `ast_path(TreeSitter.Node node, string code_content)` - Generate AST path from node
  - ‚úÖ `parse_content(string code_content)` - Parse file to AST tree
  - ‚úÖ `init_parser()` - Initialize parser with language
  - ‚úÖ `load_file_content()` - Load file content
  - ‚úÖ `traverse_ast()` - Recursive AST traversal
  - ‚úÖ `element_name()` - Extract element names
  - ‚úÖ `get_element_type()` - Determine element types
  - ‚è≥ `resolve_ast_path(string ast_path, string code_content)` - Resolve path to node/range (TODO)
  - ‚è≥ `resolve_ast_name(string name, string code_content)` - Find node by name (TODO)

### Language Parsers
- ‚ùå **NOT NEEDED** - TreeSitter provides language parsers dynamically
  - ‚úÖ Vala, JavaScript, Python, C/C++, Markdown, and more supported via tree-sitter
  - ‚úÖ Language detection and loading already implemented in `TreeBase`
  - ‚úÖ No need for separate parser classes

### Integration Helpers (Optional)
- ‚è≥ `NaturalLanguageParser` - Extract AST paths from natural language text (optional enhancement)

## Files to Modify

### ReadFile Tool
- `liboctools/RequestReadFile.vala` - Add ast_path and ast_name parameters
- `liboctools/ReadFile.vala` - Integrate AST path resolution

### EditFile Tool
- `liboctools/RequestEditMode.vala` - Add AST path support to edit operations
- `liboctools/EditMode.vala` - Integrate AST path resolution

### Codebase Search Tool
- ‚úÖ `libocvector/Indexing/Tree.vala` - Uses TreeBase `ast_path()` method in `extract_element_metadata()`
- ‚úÖ `libocvector/VectorMetadata.vala` - Added `ast_path` property and database schema
- ‚úÖ `libocvector/Tool/RequestCodebaseSearch.vala` - Includes AST path in search result output
- ‚úÖ `libocvector/Indexing/VectorBuilder.vala` - Stores ast_path when building vectors
- ‚úÖ `libocvector/Indexing/Analysis.vala` - Creates file elements with `ast_path = ""`

### Build System
- `meson.build` - Add libocast dependency
- `liboctools/meson.build` - Link to libocast
- `libocfiles/meson.build` - Ensure TreeBase has AST path support
- `libocvector/meson.build` - Link to libocast for AST path support

## Language Support

### Phase 1: Vala (Priority)
- Full Vala AST parsing
- Namespace, class, method, property support
- Signal and delegate support
- Use Vala compiler or custom parser

### Phase 2: Markdown
- Heading structure parsing
- Section boundaries
- List and code block support

### Phase 3: JavaScript/TypeScript
- Function, class, method support
- Module/namespace support
- Arrow function support

### Phase 4: Python
- Function, class, method support
- Module support
- Decorator support

### Phase 5: Other Languages
- C/C++ (basic support)
- Java (basic support)
- Rust (basic support)

## AST Parser Implementation Options

### Option A: Language-Specific Parsers
- Use existing parsers (Vala compiler, tree-sitter, etc.)
- More accurate, language-specific features
- Requires multiple dependencies

### Option B: Tree-Sitter
- Unified parser for multiple languages
- Good accuracy, active development
- Single dependency

### Option C: Custom Simple Parsers
- Regex-based or simple recursive descent
- Lightweight, no dependencies
- Less accurate, may miss edge cases

**Recommendation**: Start with Option C for Vala and Markdown, migrate to Option B (tree-sitter) for broader language support.

## Example Usage

### ReadFile with AST Path
```
Tool: read_file
Parameters:
  file_path: "libollmchat/Client.vala"
  ast_path: "OLLMchat/Client/chat"
```

**Result**: Returns the `chat` method from the `Client` class in the `OLLMchat` namespace.

### EditFile with AST Path
```
Tool: edit_file
Parameters:
  file_path: "libollmchat/Client.vala"
  operations: [
    {
      type: "replace",
      ast_path: "OLLMchat/Client/chat",
      new_content: "..."
    }
  ]
```

**Result**: Replaces the `chat` method with new content.

### Natural Language
```
LLM: "Replace the chat method in Client with this new implementation..."
Tool extracts: ast_path = "OLLMchat/Client/chat"
```

### Codebase Search with AST Path
```
Tool: codebase_search
Parameters:
  query: "database connection"
  ast_path_filter: "OLLMchat/Client/*"  # Search only in Client class methods
```

**Result**: Returns search results with AST paths:
```
Results:
1. libollmchat/Client.vala:ast-path: OLLMchat/Client/connect
   "Establishes database connection..."
2. libollmchat/Client.vala:ast-path: OLLMchat/Client/disconnect
   "Closes database connection..."
```

**Usage**: Search results can be directly used with ReadFile/EditFile:
```
read_file(file_path: "libollmchat/Client.vala", ast_path: "OLLMchat/Client/connect")
```

## Error Handling

**Path Not Found:**
- Return clear error message
- Suggest similar paths (fuzzy matching)
- List available AST nodes
- Provide line number fallback

**Multiple Matches:**
- For `ast-name:`, return first match with warning
- For `ast-path:`, require full path to disambiguate
- List all matches for user selection

**Parse Errors:**
- Fall back to line numbers
- Log parse error for debugging
- Continue with partial AST if possible

## Performance Considerations

**Caching:**
- Cache AST for files (invalidate on file change)
- Cache path resolutions
- Use file modification time for cache invalidation

**Lazy Parsing:**
- Parse AST only when AST path is used
- Skip parsing for line-number-based operations
- Background parsing for large files

**Incremental Updates:**
- Update AST incrementally on file edits
- Re-parse only affected sections
- Maintain AST cache consistency

## Future Enhancements

- **Wildcard Support**: `ast-path: */Client/*` - Match all methods in Client class
- **Relative Paths**: `ast-path: ../ParentClass/method` - Relative AST navigation
- **AST Queries**: Query language for complex AST matching
- **Multi-File Paths**: Reference across multiple files
- **AST Diff**: Show AST-level diffs instead of line diffs
- **Refactoring Support**: AST-aware refactoring operations
- **Code Navigation**: Jump to AST node definitions
- **AST Visualization**: Visual representation of file structure
- **Search by AST Path**: Search codebase using AST path patterns
- **AST Path Completion**: Auto-complete AST paths in UI
- **Cross-Reference**: Find all references to an AST path across codebase

## Testing

**Unit Tests:**
- AST parsing for each language
- Path resolution accuracy
- Error handling
- Edge cases

**Integration Tests:**
- ReadFile with AST paths
- EditFile with AST paths
- Codebase search with AST paths
- Natural language parsing
- Multi-language support
- TreeBase AST path resolution
- VectorMetadata AST path storage

**Performance Tests:**
- Large file parsing
- Cache performance
- Path resolution speed

