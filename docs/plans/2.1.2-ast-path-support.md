# 2.1.2. AST Path Support for ReadFile and EditFile

## Overview

Add Abstract Syntax Tree (AST) path support to ReadFile and EditFile tools, allowing LLMs to reference code blocks using natural language paths like `ast-path: namespace/classname/methodname` instead of line numbers. This enables more intuitive code manipulation commands.

## Status

⏳ **TODO** - To be implemented.

## Related Plans

- **2.1** - File Reading Tool (current line-based implementation)
- **2.1.1** - File Access for Tools (file buffer system)
- **2.4** - Edit File and Edit Mode Tool (current line-based implementation)
- **2.4.1** - Edit Tool Migrate to Buffer (buffer-based editing)

## Purpose

Enable LLMs to use natural language references to code blocks:
- `ast-path: namespace/classname/methodname` - Reference a method
- `ast-path: namespace/classname` - Reference a class
- `ast-path: namespace/classname/propertyname` - Reference a property
- `ast-name: methodname` - Reference by name (searches for first match)
- `ast-path: markdown/heading` - Reference markdown sections

Instead of requiring precise line numbers:
- `read file.txt lines 45-67` → `read file.txt ast-path: MyClass/myMethod`
- `replace lines 45-67 with ...` → `replace ast-path: MyClass/myMethod with ...`
- `insert after line 89` → `insert after ast-name: myMethod`

## AST Path Format

### Path Syntax

**Full Path:**
```
ast-path: {namespace}/{classname}/{methodname}
ast-path: {namespace}/{classname}/{propertyname}
ast-path: {namespace}/{classname}/{fieldname}
```

**Name-Only (searches for first match):**
```
ast-name: {methodname}
ast-name: {classname}
ast-name: {propertyname}
```

**Markdown Paths:**
```
ast-path: markdown/{heading-level}/{heading-text}
ast-name: {heading-text}
```

**Examples:**
- `ast-path: OLLMchat/Client/chat` - Method chat in class Client in namespace OLLMchat
- `ast-path: OLLMchat/Client` - Entire Client class
- `ast-name: chat` - First method/function named "chat"
- `ast-path: markdown/1/Introduction` - Markdown heading "Introduction" at level 1
- `ast-name: Introduction` - First markdown heading with text "Introduction"

### Path Resolution

**Resolution Process:**
1. Parse AST path from natural language or structured format
2. Parse file to build AST (language-specific parser)
3. Resolve path through AST (namespace → class → method)
4. Convert AST node to line range (start_line, end_line)
5. Use line range with existing ReadFile/EditFile tools

**Fallback:**
- If AST parsing fails, fall back to line numbers
- If path not found, return error with suggestions

## Implementation Details

### Phase 1: AST Parser Infrastructure

**1. Create AST Parser Base**
- `libocast/AST/Parser.vala` - Base AST parser interface
- `libocast/AST/Node.vala` - AST node representation
- `libocast/AST/PathResolver.vala` - Path resolution engine

**2. AST Node Structure**
```vala
public class ASTNode {
    public string name { get; set; }
    public ASTNodeType type { get; set; } // CLASS, METHOD, PROPERTY, NAMESPACE, etc.
    public int start_line { get; set; }
    public int end_line { get; set; }
    public ASTNode? parent { get; set; }
    public Gee.List<ASTNode> children { get; set; }
    public string? namespace { get; set; }
}
```

**3. Language-Specific Parsers**
- `libocast/Parsers/ValaParser.vala` - Vala AST parser
- `libocast/Parsers/JavaScriptParser.vala` - JavaScript AST parser
- `libocast/Parsers/PythonParser.vala` - Python AST parser
- `libocast/Parsers/MarkdownParser.vala` - Markdown structure parser

**4. Parser Selection**
- Detect file language from extension
- Select appropriate parser
- Fall back to generic parser if language not supported

### Phase 2: Path Resolution

**1. Path Resolver**
- `libocast/PathResolver.vala` - Resolves AST paths to line ranges
- `resolve_path(string file_path, string ast_path)` - Main resolution method
- `resolve_name(string file_path, string name)` - Name-only resolution
- Returns `ASTRange` with start_line and end_line

**2. Path Parsing**
- Parse `ast-path:` or `ast-name:` format
- Extract namespace, class, method components
- Handle markdown paths
- Validate path format

**3. AST Traversal**
- Traverse AST tree to find matching node
- Support partial matches (e.g., just classname)
- Support wildcards (future enhancement)
- Return best match or error

### Phase 3: ReadFile Integration

**1. Update RequestReadFile**
- Add `ast_path` parameter (alternative to start_line/end_line)
- Add `ast_name` parameter (name-only search)
- Parse AST path if provided
- Resolve to line range
- Use existing line range logic

**2. AST Path Parsing in ReadFile**
```vala
public class RequestReadFile {
    public string ast_path { get; set; default = ""; }
    public string ast_name { get; set; default = ""; }
    
    private ASTRange? resolve_ast_path() {
        if (ast_path != "") {
            return path_resolver.resolve_path(file_path, ast_path);
        } else if (ast_name != "") {
            return path_resolver.resolve_name(file_path, ast_name);
        }
        return null;
    }
}
```

**3. Permission Questions**
- Update permission question to show AST path
- "Read file 'file.vala' (ast-path: OLLMchat/Client/chat)?"
- Fall back to line numbers if AST resolution succeeds

### Phase 4: EditFile Integration

**1. Update RequestEditMode**
- Add AST path support to edit operations
- `replace_ast_path` - Replace code block at AST path
- `insert_after_ast_path` - Insert after AST path
- `insert_before_ast_path` - Insert before AST path
- `delete_ast_path` - Delete code block at AST path

**2. AST Path in Edit Operations**
```vala
public class EditOperation {
    public string? ast_path { get; set; }
    public string? ast_name { get; set; }
    public EditType type { get; set; } // REPLACE, INSERT_AFTER, INSERT_BEFORE, DELETE
    
    public ASTRange? resolve_range() {
        if (ast_path != null) {
            return path_resolver.resolve_path(file_path, ast_path);
        } else if (ast_name != null) {
            return path_resolver.resolve_name(file_path, ast_name);
        }
        return null;
    }
}
```

**3. Edit Validation**
- Validate AST path exists before edit
- Ensure edit boundaries match AST node boundaries
- Warn if edit spans multiple AST nodes
- Support partial node edits (future enhancement)

### Phase 5: Natural Language Parsing

**1. AST Path Extraction**
- Parse natural language for AST path references
- Extract `ast-path:` and `ast-name:` patterns
- Support variations: "ast path", "ast-path", "AST path", etc.
- Extract from LLM tool call parameters

**2. Pattern Matching**
- Regex patterns for AST path extraction
- Support quoted paths: `ast-path: "namespace/class/method"`
- Support unquoted paths: `ast-path: namespace/class/method`
- Handle whitespace variations

**3. Error Messages**
- Clear error messages when AST path not found
- Suggest similar paths (fuzzy matching)
- List available AST nodes in file
- Provide line number fallback suggestions

## Files to Create

### AST Infrastructure
- `libocast/meson.build` - Build configuration for AST library
- `libocast/AST/Parser.vala` - Base AST parser interface
- `libocast/AST/Node.vala` - AST node representation
- `libocast/AST/PathResolver.vala` - Path resolution engine
- `libocast/AST/Range.vala` - AST range (start_line, end_line)

### Language Parsers
- `libocast/Parsers/ValaParser.vala` - Vala AST parser
- `libocast/Parsers/JavaScriptParser.vala` - JavaScript AST parser
- `libocast/Parsers/PythonParser.vala` - Python AST parser
- `libocast/Parsers/MarkdownParser.vala` - Markdown structure parser
- `libocast/Parsers/GenericParser.vala` - Generic fallback parser

### Integration
- `libocast/Tools/ASTPathHelper.vala` - Helper for tool integration
- `libocast/Tools/NaturalLanguageParser.vala` - Extract AST paths from text

## Files to Modify

### ReadFile Tool
- `liboctools/RequestReadFile.vala` - Add ast_path and ast_name parameters
- `liboctools/ReadFile.vala` - Integrate AST path resolution

### EditFile Tool
- `liboctools/RequestEditMode.vala` - Add AST path support to edit operations
- `liboctools/EditMode.vala` - Integrate AST path resolution

### Build System
- `meson.build` - Add libocast dependency
- `liboctools/meson.build` - Link to libocast

## Language Support

### Phase 1: Vala (Priority)
- Full Vala AST parsing
- Namespace, class, method, property support
- Signal and delegate support
- Use Vala compiler or custom parser

### Phase 2: Markdown
- Heading structure parsing
- Section boundaries
- List and code block support

### Phase 3: JavaScript/TypeScript
- Function, class, method support
- Module/namespace support
- Arrow function support

### Phase 4: Python
- Function, class, method support
- Module support
- Decorator support

### Phase 5: Other Languages
- C/C++ (basic support)
- Java (basic support)
- Rust (basic support)

## AST Parser Implementation Options

### Option A: Language-Specific Parsers
- Use existing parsers (Vala compiler, tree-sitter, etc.)
- More accurate, language-specific features
- Requires multiple dependencies

### Option B: Tree-Sitter
- Unified parser for multiple languages
- Good accuracy, active development
- Single dependency

### Option C: Custom Simple Parsers
- Regex-based or simple recursive descent
- Lightweight, no dependencies
- Less accurate, may miss edge cases

**Recommendation**: Start with Option C for Vala and Markdown, migrate to Option B (tree-sitter) for broader language support.

## Example Usage

### ReadFile with AST Path
```
Tool: read_file
Parameters:
  file_path: "libollmchat/Client.vala"
  ast_path: "OLLMchat/Client/chat"
```

**Result**: Returns the `chat` method from the `Client` class in the `OLLMchat` namespace.

### EditFile with AST Path
```
Tool: edit_file
Parameters:
  file_path: "libollmchat/Client.vala"
  operations: [
    {
      type: "replace",
      ast_path: "OLLMchat/Client/chat",
      new_content: "..."
    }
  ]
```

**Result**: Replaces the `chat` method with new content.

### Natural Language
```
LLM: "Replace the chat method in Client with this new implementation..."
Tool extracts: ast_path = "OLLMchat/Client/chat"
```

## Error Handling

**Path Not Found:**
- Return clear error message
- Suggest similar paths (fuzzy matching)
- List available AST nodes
- Provide line number fallback

**Multiple Matches:**
- For `ast-name:`, return first match with warning
- For `ast-path:`, require full path to disambiguate
- List all matches for user selection

**Parse Errors:**
- Fall back to line numbers
- Log parse error for debugging
- Continue with partial AST if possible

## Performance Considerations

**Caching:**
- Cache AST for files (invalidate on file change)
- Cache path resolutions
- Use file modification time for cache invalidation

**Lazy Parsing:**
- Parse AST only when AST path is used
- Skip parsing for line-number-based operations
- Background parsing for large files

**Incremental Updates:**
- Update AST incrementally on file edits
- Re-parse only affected sections
- Maintain AST cache consistency

## Future Enhancements

- **Wildcard Support**: `ast-path: */Client/*` - Match all methods in Client class
- **Relative Paths**: `ast-path: ../ParentClass/method` - Relative AST navigation
- **AST Queries**: Query language for complex AST matching
- **Multi-File Paths**: Reference across multiple files
- **AST Diff**: Show AST-level diffs instead of line diffs
- **Refactoring Support**: AST-aware refactoring operations
- **Code Navigation**: Jump to AST node definitions
- **AST Visualization**: Visual representation of file structure

## Testing

**Unit Tests:**
- AST parsing for each language
- Path resolution accuracy
- Error handling
- Edge cases

**Integration Tests:**
- ReadFile with AST paths
- EditFile with AST paths
- Natural language parsing
- Multi-language support

**Performance Tests:**
- Large file parsing
- Cache performance
- Path resolution speed

