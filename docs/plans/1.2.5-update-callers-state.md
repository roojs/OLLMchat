# 1.2.5. Update Callers to Handle State Directly

## Overview

Update all code that previously relied on Client signals for state updates (`chat_send`, `message_created`) to handle state directly, since the caller knows when these events occur synchronously.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

‚è≥ **TODO** - Refactoring needed.

## Goal

Remove dependencies on synchronous state update signals. Callers should update state directly when they:
- Create messages (caller knows when)
- Send requests (caller knows when they call `send()`)

Keep signal connections only for asynchronous events (streaming).

## Signals Removed

These signals are being removed (see [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md)):
- `chat_send(Call.Chat)` - Caller knows when they call `send()`
- `message_created(Message, ChatContentInterface?)` - Caller creates messages, they know when

## Code to Update

### 1. Remove Signal Connections

Find all code that connects to removed signals and remove the connections:

**Pattern to find**:
```vala
client.chat_send.connect(...)
client.message_created.connect(...)
```

### 2. Update Message Creation

**Current** (relying on signal):
```vala
var user_msg = new Message(chat, "user", text);
// Signal would notify UI/session
```

**New** (direct call):
```vala
var user_msg = new Message(chat, "user", text);
session.save_message(user_msg);  // Direct call, no signal
ui.add_message_to_display(user_msg);  // Direct call, no signal
```

### 3. Update Request Sending

**Current** (relying on signal):
```vala
yield chat.send();
// Signal would notify UI that request was sent
```

**New** (direct call):
```vala
// UI should block send button before send() is called
ui.disable_send_button();

yield chat.send();
// send() has returned - request has been sent, but response may still be streaming
ui.show_waiting_indicator();  // Direct call, no signal
```

**Note**: `send()` begins execution after message is sent and returns after sending, not waiting for response. Response comes via signals/callbacks.

## Files to Update

### Handlers/Agents
- `libollmchat/Prompt/AgentHandler.vala`
  - Remove `client.chat_send.connect()`
  - Remove `client.message_created.connect()`
  - Update to save messages directly to session
  - Update to update UI state directly after `send()`

- `liboccoder/Prompt/CodeAssistantHandler.vala`
  - Same updates as AgentHandler

### History/Session
- `libollmchat/History/Manager.vala`
  - Remove `client.chat_send.connect()`
  - Remove `client.message_created.connect()`
  - Update to handle state directly

- `libollmchat/History/Session.vala`
  - Remove signal connections
  - Update to save messages directly

### UI
- `libollmchatgtk/ChatWidget.vala`
  - Remove `client.chat_send.connect()`
  - Remove `client.message_created.connect()`
  - Update to disable send button before `send()`
  - Update to show waiting indicator after `send()` returns
  - Update to add messages to display directly when created

## Implementation Steps

### Step 1: Find All Signal Connections

Search for:
- `chat_send.connect`
- `message_created.connect`

Document each occurrence and what it does.

### Step 2: Replace with Direct Calls

For each signal connection:

1. **`chat_send` connections**:
   - Identify what the handler does (usually UI state update)
   - Move that logic to after `chat.send()` call
   - Example: `ui.show_waiting_indicator()` after `yield chat.send()`

2. **`message_created` connections**:
   - Identify what the handler does (usually save to session or display in UI)
   - Move that logic to after message creation
   - Example: `session.save_message(msg)` after creating message

### Step 3: Update UI State Management

Ensure UI properly manages state:
- Disable send button before calling `send()`
- Show waiting indicator after `send()` returns
- Add messages to display when created (not via signal)
- Update UI when streaming chunks arrive (via `stream_chunk` signal - this stays)

### Step 4: Update Session State Management

Ensure Session properly manages state:
- Save messages directly when created
- Track request state directly
- Update Manager directly (not via signals)

## Testing Checklist

- [ ] No code connects to removed signals
- [ ] Messages are saved to session directly (not via signal)
- [ ] UI updates correctly when messages are created
- [ ] UI disables send button before `send()`
- [ ] UI shows waiting indicator after `send()` returns
- [ ] Streaming still works via `stream_chunk` signal
- [ ] All state updates happen correctly

## Related Plans

- [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md)
- [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md)
- [1.2.6. Update Legacy Methods](./1.2.6-update-legacy-methods.md)

