# 1.2.5. Update Callers to Handle State Directly

## Overview

Update all code that previously relied on Client signals for state updates (`chat_send`, `message_created`) to handle state directly, since the caller knows when these events occur synchronously.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

⏳ **TODO** - Refactoring needed.

## ⚠️ CRITICAL: Incremental Implementation Required

**IMPORTANT**: This refactoring must be done incrementally to keep the code usable after each step. See [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md) for the overall approach.

**Note**: This plan is integrated into [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md) as **Phase 1** (Update Signal Connections). This document provides detailed guidance for that phase.

**Key Principle**: Update signal connections first (keep signals), then remove emissions, then remove definitions.

## Goal

Remove dependencies on synchronous state update signals. Callers should update state directly when they:
- Create messages (caller knows when)
- Send requests (caller knows when they call `send()`)

Keep signal connections only for asynchronous events (streaming).

## Signals Being Removed

These signals are being removed (see [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md)):
- `chat_send(Call.Chat)` - Caller knows when they call `send()`
- `message_created(Message, ChatContentInterface?)` - Caller creates messages, they know when
- `stream_content(string, Response.Chat)` - Redundant, use `stream_chunk` with `is_thinking` check

## Implementation Strategy

This plan implements **Phase 1** of [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md): updating all signal connections before removing the signals.

**Key Principle**: Update connections first (signals still exist), then remove emissions, then remove definitions.

## Implementation Steps

### Phase 1: Update Signal Connections (Keep Signals)

Update all code that connects to removed signals, one file at a time.

#### Step 1.1: Find All Signal Connections

Search for:
- `chat_send.connect`
- `message_created.connect`
- `stream_content.connect`

Document each occurrence and what it does.

**Files to check**:
- `libollmchat/Prompt/AgentHandler.vala`
- `liboccoder/Prompt/CodeAssistantHandler.vala`
- `libollmchat/History/Manager.vala`
- `libollmchat/History/Session.vala`
- `libollmchatgtk/ChatWidget.vala`
- Any other UI or handler code

**Result**: List of all signal connections to update

#### Step 1.2: Update AgentHandler Signal Connections

**File**: `libollmchat/Prompt/AgentHandler.vala`

**Current** (relying on signal):
```vala
this.client.chat_send.connect((call) => {
    // Update UI state
    ui.show_waiting_indicator();
});

this.client.message_created.connect((msg, content) => {
    // Save to session
    session.save_message(msg);
});
```

**New** (direct calls):
```vala
// Remove signal connections

// Update UI state directly after send()
yield chat.send();
ui.show_waiting_indicator();  // Direct call, no signal

// Save messages directly when created
var user_msg = new Message(chat, "user", text);
session.save_message(user_msg);  // Direct call, no signal
```

**Test**: Verify AgentHandler still works

**Result**: One file updated, code still works (signals still exist but not used)

#### Step 1.3: Update CodeAssistantHandler Signal Connections

**File**: `liboccoder/Prompt/CodeAssistantHandler.vala`

**New**: Same pattern as AgentHandler above.

**Test**: Verify CodeAssistantHandler still works

**Result**: Another file updated, code still works

#### Step 1.4: Update Manager Signal Connections

**File**: `libollmchat/History/Manager.vala`

**Current**:
```vala
client.chat_send.connect((call) => {
    // Handle state update
});

client.message_created.connect((msg, content) => {
    // Save message
});
```

**New**:
```vala
// Remove signal connections

// Handle state directly when caller calls send()
// (Caller updates state, Manager doesn't need to know)

// Save messages directly when caller creates them
// (Caller saves messages, Manager doesn't need to know)
```

**Test**: Verify Manager still works

**Result**: Another file updated, code still works

#### Step 1.5: Update Session Signal Connections

**File**: `libollmchat/History/Session.vala`

**Current**:
```vala
client.message_created.connect((msg, content) => {
    // Save message to history
});
```

**New**:
```vala
// Remove signal connection

// Save messages directly when created
var user_msg = new Message(chat, "user", text);
this.save_message(user_msg);  // Direct call, no signal
```

**Test**: Verify Session still works

**Result**: Another file updated, code still works

#### Step 1.6: Update ChatWidget Signal Connections

**File**: `libollmchatgtk/ChatWidget.vala`

**Current**:
```vala
client.chat_send.connect((call) => {
    // Disable send button, show waiting indicator
    this.send_button.sensitive = false;
    this.show_waiting_indicator();
});

client.message_created.connect((msg, content) => {
    // Add message to display
    this.add_message_to_display(msg, content);
});
```

**New**:
```vala
// Remove signal connections

// Disable send button before send() is called
this.send_button.sensitive = false;

yield chat.send();
// send() has returned - request has been sent, but response may still be streaming
this.show_waiting_indicator();  // Direct call, no signal

// Add messages to display directly when created
var user_msg = new Message(chat, "user", text);
this.add_message_to_display(user_msg, null);  // Direct call, no signal
```

**Test**: Verify ChatWidget still works, UI updates correctly

**Result**: Another file updated, code still works

#### Step 1.7: Update stream_content Connections

**File**: Any file that connects to `stream_content`

**Current**:
```vala
client.stream_content.connect((text, response) => {
    // Process content chunks (not thinking)
});
```

**New**:
```vala
// Remove stream_content connection

// Use stream_chunk with is_thinking check instead
client.stream_chunk.connect((text, is_thinking, response) => {
    if (!is_thinking) {
        // Process content chunks only
    }
});
```

**Test**: Verify streaming still works correctly

**Result**: All signal connections updated, code still works (signals still exist)

### Phase 2: Remove Signal Emissions (Keep Definitions)

**Prerequisite**: All signal connections must be updated (Phase 1 complete)

This phase is handled in [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md) **Phase 2**.

### Phase 3: Remove Signal Definitions

**Prerequisite**: All signal emissions must be removed (Phase 2 complete)

This phase is handled in [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md) **Phase 3**.

## Files to Update

### Handlers/Agents
- `libollmchat/Prompt/AgentHandler.vala` - Step 1.2
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Step 1.3

### History/Session
- `libollmchat/History/Manager.vala` - Step 1.4
- `libollmchat/History/Session.vala` - Step 1.5

### UI
- `libollmchatgtk/ChatWidget.vala` - Step 1.6

### Other
- Any files that connect to `stream_content` - Step 1.7

## Testing Checklist

- [ ] Step 1.1: All signal connections documented
- [ ] Step 1.2: AgentHandler updated and tested
- [ ] Step 1.3: CodeAssistantHandler updated and tested
- [ ] Step 1.4: Manager updated and tested
- [ ] Step 1.5: Session updated and tested
- [ ] Step 1.6: ChatWidget updated and tested
- [ ] Step 1.7: stream_content connections updated and tested
- [ ] No code connects to removed signals
- [ ] Messages are saved to session directly (not via signal)
- [ ] UI updates correctly when messages are created
- [ ] UI disables send button before `send()`
- [ ] UI shows waiting indicator after `send()` returns
- [ ] Streaming still works via `stream_chunk` signal
- [ ] All state updates happen correctly

## Related Plans

- [1.2.2. Remove Signals from Client](./1.2.2-remove-signals-from-client.md) - Main plan (this is Phase 1)
- [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md)
- [1.2.6. Update Legacy Methods](./1.2.6-update-legacy-methods.md)
- [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md)
