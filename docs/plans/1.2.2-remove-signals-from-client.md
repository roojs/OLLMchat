# 1.2.2. Remove Unnecessary Signals from Client

## Overview

Remove synchronous state update signals from `Client`. Signals should only be used for truly asynchronous events that the caller cannot know about synchronously. The caller is responsible for updating state directly.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

â³ **TODO** - Refactoring needed.

## Goal

Keep only asynchronous signals on Client. Remove signals for events that the caller knows about synchronously (e.g., "I called send()", "I created a message").

## Signals to Remove

### 1. `chat_send(Call.Chat)` Signal

- **Current**: Emitted when `chat.send()` is called
- **Remove**: Caller knows when they call `send()`, no signal needed
- **Impact**: Remove all connections to this signal
- **Replacement**: Caller updates state directly after calling `send()`

### 2. `message_created(Message, ChatContentInterface?)` Signal

- **Current**: Emitted when a message is created
- **Remove**: Caller creates messages, they know when
- **Impact**: Remove all connections to this signal
- **Replacement**: Caller updates state directly when creating messages

### 3. `stream_content(string, Response.Chat)` Signal

- **Current**: Emitted for streaming content chunks (not thinking)
- **Remove**: Redundant - `stream_chunk` has `is_thinking` parameter
- **Impact**: Remove all connections to this signal
- **Replacement**: Use `stream_chunk` with `is_thinking` check: `if (!is_thinking) { ... }`

## Signals to Keep

### 1. `stream_chunk(string, bool, Response.Chat)`

- **Keep**: Asynchronous event - chunks arrive from HTTP stream
- **Parameters**:
  - `string` - Chunk text (content or thinking)
  - `bool` - `true` if thinking, `false` if content (allows filtering)
  - `Response.Chat` - Response object with full state
- **Usage**: For non-agent usage (loosely coupled components)

### 2. `stream_start()`

- **Keep**: Asynchronous event - streaming started (first chunk received)
- **Usage**: For non-agent usage (loosely coupled components)

### 3. `tool_message(Message)`

- **Keep**: Asynchronous event - tool status notifications
- **Usage**: For non-agent usage (loosely coupled components)

**Note**: For agent usage, Chat calls handler methods directly (no signals). See [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md#signal-flow) for details.

## Implementation Steps

### Step 1: Remove Signal Definitions

1. Remove signal declarations from `Client` class:
   ```vala
   // Remove these:
   public signal void chat_send(Call.Chat call);
   public signal void message_created(Message m, ChatContentInterface? content_interface);
   public signal void stream_content(string new_text, Response.Chat response);
   ```

### Step 2: Remove Signal Emissions

1. Find all `client.chat_send()` calls and remove
2. Find all `client.message_created()` calls and remove
3. Find all `client.stream_content()` calls and remove

### Step 3: Remove Signal Connections

Find all code that connects to these signals and:
1. Remove the signal connection
2. Update caller to handle state directly

**Files to check**:
- `libollmchat/Prompt/AgentHandler.vala`
- `libollmchat/History/Manager.vala`
- `libollmchat/History/Session.vala`
- `libollmchatgtk/ChatWidget.vala`
- Any other UI or handler code

### Step 4: Update Callers to Handle State Directly

For each removed signal connection:

1. **`chat_send` connections**:
   - Caller knows when they call `chat.send()`
   - Update UI/state directly after calling `send()`
   - Example: `ui.show_waiting_indicator()` after `yield chat.send()`

2. **`message_created` connections**:
   - Caller knows when they create messages
   - Update UI/state directly when creating messages
   - Example: `session.save_message(user_msg)` after creating message

3. **`stream_content` connections**:
   - Use `stream_chunk` with `is_thinking` check instead
   - Example: `client.stream_chunk.connect((text, is_thinking, response) => { if (!is_thinking) { ... } })`

## Files to Modify

### Core Classes
- `libollmchat/Client.vala` - Remove signal declarations and emissions

### Handlers/Agents
- `libollmchat/Prompt/AgentHandler.vala` - Remove signal connections, update state handling
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Remove signal connections, update state handling

### History/Session
- `libollmchat/History/Manager.vala` - Remove signal connections, update state handling
- `libollmchat/History/Session.vala` - Remove signal connections, update state handling

### UI
- `libollmchatgtk/ChatWidget.vala` - Remove signal connections, update state handling

## Testing Checklist

- [ ] Removed signals no longer declared in Client
- [ ] No code emits removed signals
- [ ] No code connects to removed signals
- [ ] Callers update state directly (no reliance on removed signals)
- [ ] Streaming still works via `stream_chunk` signal
- [ ] UI updates correctly when messages are created/sent

## Related Plans

- [1.2.1. Remove Configuration from Client](./1.2.1-remove-config-from-client.md)
- [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md)
- [1.2.5. Update Callers to Handle State Directly](./1.2.5-update-callers-state.md)

