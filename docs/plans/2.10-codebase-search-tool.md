# 2.10. Codebase Search Tool

## Overview

Implementation of a semantic codebase search tool using vector embeddings and FAISS. The code will be migrated from the existing `VectorSearch/` directory into a new `libocvector` library with two main components: **Indexing** and **Search**. The library will integrate with `liboccoder`'s file/folder system to track indexed files and support incremental updates.

## Status

⏳ **TODO** - To be implemented.

## Architecture

### Library Structure: `libocvector`

The vector search functionality will be organized as a new library `libocvector` with the following structure:

```
libocvector/
├── meson.build
├── Indexing/
│   ├── Analysis.vala          # Code and documentation analysis
│   ├── VectorBuilder.vala      # Vector generation and FAISS storage
│   └── Indexer.vala            # Main indexing orchestrator
├── Search/
│   ├── Searcher.vala           # Search functionality with GPU support
│   └── QueryProcessor.vala     # Query processing and result formatting
└── Tool/
    └── CodebaseSearchTool.vala  # OLLM tool integration
```

### Component 1: Indexing

The indexing component consists of two layers:

#### Layer 1: Analysis
- **Purpose**: Process code files and send them to LLM to generate structured JSON data for vector generation
- **Input**: 
  - Code files (via `liboccoder.Files.File` and `liboccoder.Files.Folder`)
  - Code documentation (markdown, comments, etc.) - *Note: Documentation handling to be determined (may include downloaded content)*
- **Output**: Structured JSON data from LLM that can be used for vector generation
- **Responsibilities**:
  - Read source files from the codebase
  - Send source file content to LLM with a prompt requesting structured JSON output
  - LLM analyzes the code and returns JSON containing semantic elements (classes, functions, methods, etc.)
  - Extract and process the JSON response from LLM
  - Format the JSON data into vector-friendly text representations
  - Handle multiple programming languages
  - Track file metadata (path, modification time via liboccoder.Files.File)

#### Layer 2: Vector Building
- **Purpose**: Convert structured JSON data (from Analysis layer) into vectors and store in FAISS
- **Input**: Structured JSON data from Analysis layer (LLM output)
- **Output**: Vectors stored in FAISS index
- **Responsibilities**:
  - Generate embeddings using LLM embedding API
  - Store vectors in FAISS index
  - Maintain mapping between vectors and source files/elements
  - Handle batch processing for efficiency
  - Support incremental updates (add/update/remove vectors)

### Component 2: Search

The search component provides semantic search capabilities:

- **Purpose**: Perform semantic search on indexed codebase
- **Features**:
  - Use local GPU for search operations when available
  - Fallback to CPU if GPU unavailable
  - Return ranked results with similarity scores
  - Support various query types (functionality search, pattern search, etc.)
- **Responsibilities**:
  - Convert search queries to embedding vectors
  - Perform similarity search in FAISS index
  - Rank and filter results
  - Return formatted results with context

### Integration with liboccoder

The vector indexing system will use `liboccoder`'s file/folder system to:

- **Track Indexed Files**: Store vector metadata linked to `liboccoder.Files.File` objects
- **Detect Changes**: Use file modification times (`mtime`) from `liboccoder.Files.File` to detect when files need re-indexing
- **Incremental Updates**: Update vectors when code or documentation changes
- **Project Management**: Integrate with `liboccoder.ProjectManager` for project-wide indexing

Metadata storage (integrated with `liboccoder.Files.File`):
- File path and ID (via `liboccoder.Files.File`)
- File modification time (`mtime`) for change detection
- Last indexed timestamp
- Vector position in FAISS index
- Indexing status (indexed, needs update, error, etc.)

### Command-Line Tools

Command-line tools will be created in the `examples/` directory for testing:

#### Indexing Example (`examples/oc-vector-index.vala`)
- **Purpose**: Test single file indexing from command line
- **Features**:
  - Index a single file for testing
  - Show indexing progress
  - Simple interface for development/testing

#### Search Tool (`oc-vector-search`)
- **Namespace**: `OLLMvector.Tools.Search`
- **Purpose**: Search indexed codebases from command line
- **Features**:
  - Execute semantic search queries
  - Display ranked results
  - Filter by file type, language, etc.
  - Export results in various formats

### OLLM Library Tool Integration

A tool class will be created for use with the `libollmchat` tool system:

- **Class**: `OLLMvector.Tool.CodebaseSearchTool` (extends `OLLMchat.Tool.Interface`)
- **Purpose**: Provide semantic codebase search as a tool for LLM agents
- **Integration**: 
  - Implements `OLLMchat.Tool.Interface`
  - Provides `execute()` method for tool calling
  - Returns search results in structured format
  - Supports permission system integration

## Migration Plan: VectorSearch → libocvector

### Phase 1: Create libocvector Structure
1. Create `libocvector/` directory
2. Set up `meson.build` for the library
3. Create namespace structure (`OLLMvector.Indexing`, `OLLMvector.Search`, `OLLMvector.Tools.Search`, `OLLMvector.Tool`)

### Phase 2: Migrate FAISS Components
1. **Migrate FAISS Integration**:
   - Move `VectorSearch/Index.vala` → `libocvector/Index.vala`
   - Keep namespace as `Faiss` (or appropriate FAISS namespace)
   - Keep FAISS functionality intact

2. **Migrate Database**:
   - Move `VectorSearch/Database.vala` → `libocvector/Database.vala`
   - Update namespace to `OLLMvector`
   - Integrate with `liboccoder.Files.File` for metadata tracking

### Phase 3: Refactor Analysis Layer
1. **Create Analysis Component**:
   - Extract analysis logic from `VectorSearch/CodeImport.vala`
   - Create `libocvector/Indexing/Analysis.vala`
   - Implement LLM-based analysis: send source files to LLM, receive JSON output
   - Process JSON response to extract semantic elements
   - Integrate with `liboccoder.Files` for file tracking
   - *Note: Documentation handling (markdown, downloaded content) to be determined*

2. **Create Vector Builder**:
   - Extract vector generation from `VectorSearch/Database.vala`
   - Create `libocvector/Indexing/VectorBuilder.vala`
   - Separate embedding generation from storage
   - Add batch processing support

3. **Create Indexer**:
   - Refactor `VectorSearch/CodeIndexer.vala` → `libocvector/Indexing/Indexer.vala`
   - Combine Analysis and VectorBuilder
   - Add integration with `liboccoder` for file tracking
   - Implement incremental update logic

### Phase 4: Refactor Search Layer
1. **Create Searcher**:
   - Refactor `VectorSearch/CodeSearch.vala` → `libocvector/Search/Searcher.vala`
   - Add GPU support detection and usage
   - Enhance result formatting

2. **Create Query Processor**:
   - Extract query processing logic
   - Create `libocvector/Search/QueryProcessor.vala`
   - Add query type detection and routing

### Phase 5: Integrate Metadata with liboccoder
1. **Add features to File class**:
   - Add vector indexing metadata fields to `liboccoder.Files.File`
   - Use existing `mtime` for change detection
   - Store vector position and indexing status in database via `liboccoder`'s existing database system

### Phase 6: Create Command-Line Tools
1. **Create Indexing Example**:
   - Create `examples/oc-vector-index.vala`
   - Simple command-line tool for testing single file indexing
   - Focus on development/testing use cases

2. **Create Search Tool**:
   - Create `libocvector/Tools/SearchTool.vala`
   - Implement command-line interface
   - Add to `examples/` directory as `oc-vector-search.vala`
   - Create `oc-vector-search` executable

### Phase 7: Create OLLM Tool Integration
1. **Create CodebaseSearchTool**:
   - Create `libocvector/Tool/CodebaseSearchTool.vala`
   - Extend `OLLMchat.Tool.Interface`
   - Implement tool interface methods
   - Add to `libollmchat` tool registry

### Phase 8: Update Dependencies and Build
1. Update `meson.build`:
   - Add `libocvector` subdirectory
   - Add dependencies (libocsqlite, liboccoder, libollmchat, FAISS)
   - Create library, VAPI, and GIR files

2. Update library dependencies:
   - Add `libocvector` to libraries that need it
   - Update VAPI dependencies

### Phase 9: Testing and Cleanup
1. Test indexing with various codebases
2. Test search functionality
3. Test command-line tools
4. Test OLLM tool integration
5. Remove or deprecate `VectorSearch/` directory
6. Update documentation

## Existing Infrastructure

The project already has a `VectorSearch/` directory with:
- **FAISS Integration** (`Index.vala`, `Database.vala`) - Vector search using FAISS
- **Code Analysis** (`CodeImport.vala`, `CodeIndexer.vala`) - Code file analysis
- **Code Search** (`CodeSearch.vala`) - Search functionality
- **Code Elements** (`CodeElement.vala`, `CodeFile.vala`) - Code structure representation

This code will be migrated and refactored into the new `libocvector` structure.

## Dependencies

- **FAISS library** (already integrated via `vapi/fiass.vapi`)
- **libocsqlite** - For metadata storage
- **liboccoder** - For file/folder management and project integration
- **libollmchat** - For LLM client access and tool integration
- **libocagent** - For agent integration (if needed)

## Files to Create

### Library Files
- `libocvector/meson.build`
- `libocvector/Index.vala` (FAISS namespace)
- `libocvector/Database.vala`
- `libocvector/Indexing/Analysis.vala`
- `libocvector/Indexing/VectorBuilder.vala`
- `libocvector/Indexing/Indexer.vala`
- `libocvector/Search/Searcher.vala`
- `libocvector/Search/QueryProcessor.vala`
- `libocvector/Tool/CodebaseSearchTool.vala`
- `libocvector/Tools/SearchTool.vala`

### Example/Test Tools
- `examples/oc-vector-index.vala` (simple single-file indexing for testing)
- `examples/oc-vector-search.vala` (uses `libocvector/Tools/SearchTool.vala`)

## Features

- Semantic code search using FAISS vectors
- Support for both code and documentation indexing
- GPU-accelerated search (with CPU fallback)
- Incremental indexing with change detection
- Integration with liboccoder file system
- Command-line tools for testing and manual operations
- OLLM library tool integration for LLM agents
- Permission system integration

## Testing

- Test indexing with various codebases and languages
- Test search functionality with different query types
- Test file change detection and re-indexing
- Test command-line tools
- Test OLLM tool integration
- Test GPU vs CPU search performance
- Test incremental updates
- Add to meson.build
