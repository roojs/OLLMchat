# 1.2.7.1. Verify Chat Creation Options

## Overview

Ensure all Call class constructors (Chat, Embed, Generate, etc.) follow a consistent pattern: remove options parameter from constructors, always initialize with `new Call.Options()`, and set options after construction. This is a prerequisite check before moving signals from Client to Chat.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md)

## Status

✅ **DONE** - All Call class constructors standardized, options set after construction.

## Goal

1. **Standardize Call class constructors**: Remove options parameter from all Call class constructors (Chat, Embed, etc.), always initialize with `new Call.Options()` in constructors
2. **Standardize options setting**: All Call creation points should set options after construction (either via object initializer `{ options = ... }` or property assignment `call.options = ...`)
3. **Verify config usage**: Ensure all Call creation points that need config-based options properly get them from config and set them after construction

## Implementation Steps

### Step 0.1: Verify All Chat Creation Points Set Options Properly

**Goal**: Ensure all Chat creation points properly set `options` from config when available, rather than always using defaults.

**Check**: Review all Chat creation points to ensure they:
1. Get `options` from config when available (using `config.model_options.get(model)` or `config.usage.get("default_model")`)
2. Fall back to `new Call.Options()` only when config is not available
3. Explicitly set `options` on the Chat object

**Note**: `keep_alive` defaults to `null` (not set), which is acceptable for normal usage. Only set if explicitly needed.

### Step 0.1.1: Verify Client.chat() Method

**File**: `libollmchat/Client.vala` (line ~190)

**Current State**: 
- Creates Chat with `send_opts` parameter (line 188: `var send_opts = options == null ? new Call.Options() : options;`)
- Passes `send_opts` to Chat constructor (line 190)
- ✅ **ALREADY CORRECT**: Client is a lightweight usage method - it uses provided options or creates empty Options

**What to Check**:
1. ✅ Options parameter is accepted and passed through
2. ✅ Uses provided options or creates empty Options (correct behavior for lightweight Client)
3. ✅ No config lookup needed - Client should not be responsible for loading options from config

**Required Changes**: None - Client methods are correct as-is. Client is lightweight and should not check config.

**Note**: Client methods are meant to be simple, lightweight usage methods. Callers who need config-based options should get them from config themselves and pass them to Client methods.

### Step 0.1.2: Verify Client.embed() Method

**File**: `libollmchat/Client.vala` (line ~370)

**Current State**:
- Creates Chat with `send_opts` parameter (line 370: `var send_opts = options == null ? new Call.Options() : options;`)
- Passes `send_opts` to Embed constructor (line 371)
- ✅ **ALREADY CORRECT**: Client is a lightweight usage method - it uses provided options or creates empty Options

**What to Check**:
1. ✅ Options parameter is accepted and passed through
2. ✅ Uses provided options or creates empty Options (correct behavior for lightweight Client)
3. ✅ No config lookup needed - Client should not be responsible for loading options from config

**Required Changes**: None - Client methods are correct as-is.

### Step 0.1.3: Verify Client.generate() Method

**File**: `libollmchat/Client.vala` (line ~448)

**Current State**:
- Creates Chat with `send_opts` parameter (line 448: `var send_opts = options == null ? new Call.Options() : options;`)
- Passes `send_opts` to Generate constructor (line 449)
- Sets `options = send_opts` explicitly (line 456)
- ✅ **ALREADY CORRECT**: Client is a lightweight usage method - it uses provided options or creates empty Options

**What to Check**:
1. ✅ Options parameter is accepted and passed through
2. ✅ Options are explicitly set on the call object
3. ✅ Uses provided options or creates empty Options (correct behavior for lightweight Client)
4. ✅ No config lookup needed - Client should not be responsible for loading options from config

**Required Changes**: None - Client methods are correct as-is.

### Step 0.1.4: Verify Config2.create_chat() Method

**File**: `libollmchat/Settings/Config2.vala` (line ~562)

**Current State**:
- Gets `ModelUsage` from `this.usage.get(name)` (line 550)
- Creates Chat with `model_usage_obj.model` and `model_usage_obj.options` passed to constructor (line 562)
- ❌ **NEEDS FIX**: Should set options after construction, not in constructor

**What to Check**:
1. ✅ Gets options from config via ModelUsage
2. ❌ Options are passed to Chat constructor (should be set after)
3. ✅ Should use object initializer or property assignment instead

**Required Changes**:
- Remove `model_usage_obj.options` from constructor call
- Set options after construction using either:
  - Object initializer: `new Chat(...) { options = model_usage_obj.options }`
  - Or property assignment: `chat.options = model_usage_obj.options`

### Step 0.1.5: Verify Analysis Chat Creation

**File**: `libocvector/Indexing/Analysis.vala` (line ~316)

**Current State**:
- Gets `analysis_usage` from `tool_config.analysis` (line 314)
- Creates Chat with `analysis_usage.model` and `analysis_usage.options` passed to constructor (line 316)
- ❌ **NEEDS FIX**: Should set options after construction, not in constructor

**What to Check**:
1. ✅ Gets options from config via tool_config.analysis
2. ❌ Options are passed to Chat constructor (should be set after)
3. ✅ Should use object initializer or property assignment instead

**Required Changes**:
- Remove `analysis_usage.options` from constructor call
- Set options after construction using either:
  - Object initializer: `new Chat(...) { options = analysis_usage.options }`
  - Or property assignment: `chat.options = analysis_usage.options`

### Step 0.1.6: Verify Manager.create_new_session() Method

**File**: `libollmchat/History/Manager.vala` (line ~290)

**Current State**:
- Gets options from `this.config.usage.get("default_model")` (lines 285-288)
- Creates Chat with model but **NOT passing options to constructor** (line 290)
- Sets `call.options = options` **after** construction (line 294)
- ✅ **ALREADY CORRECT**: This is the correct pattern - options should be set after construction

**What to Check**:
1. ✅ Gets options from config
2. ✅ Options are set after construction (correct pattern)
3. ✅ This is the pattern we want for all Chat creation

**Required Changes**: None - this is the correct pattern. All Chat creation should follow this.

### Step 0.1.7: Verify SessionBase Constructor

**File**: `libollmchat/History/SessionBase.vala` (line ~155)

**Current State**:
- Constructor does NOT create Chat directly
- Chat is created per request by AgentHandler (see Step 0.1.8)
- ✅ **ALREADY CORRECT**: No Chat creation in constructor

**What to Check**:
1. ✅ No Chat creation in SessionBase constructor
2. ✅ Chat creation is handled by AgentHandler

**Required Changes**: None - Chat is created elsewhere

### Step 0.1.8: Verify AgentHandler Chat Creation

**File**: `libollmchat/Prompt/AgentHandler.vala` (line ~113)

**Current State**:
- Gets options from `session.model_usage.options.clone()` (line 106)
- Creates Chat with `options` explicitly set in object initializer (line 116)
- ✅ **ALREADY CORRECT**: Uses options from session.model_usage and sets them after construction via initializer

**What to Check**:
1. ✅ Gets options from config via session.model_usage
2. ✅ Options are set after construction using object initializer (correct pattern)
3. ✅ No changes needed - this is the correct pattern

**Required Changes**: None - this is already correct

### Step 0.1.9: Verify CodeAssistantHandler Chat Creation

**File**: `liboccoder/Prompt/CodeAssistantHandler.vala` (line ~37)

**Current State**:
- Extends `AgentHandler` and calls `base(agent, client, session)` (line 39)
- Does NOT create Chat directly - uses Chat from base class
- ✅ **ALREADY CORRECT**: Inherits correct Chat creation from AgentHandler

**What to Check**:
1. ✅ Does not create Chat directly
2. ✅ Uses Chat from base AgentHandler class
3. ✅ No changes needed

**Required Changes**: None - inherits correct behavior

## Summary of Required Changes

### Step 0.0: Remove Options Parameter from All Call Constructors

**Files**: 
- `libollmchat/Call/Chat.vala` (line ~98)
- `libollmchat/Call/Embed.vala` (line ~41)

**Current State**:
- **Chat constructor**: Takes `Call.Options? options = null` parameter ❌
- **Embed constructor**: Takes `Call.Options? options = null` parameter ❌
- **Generate constructor**: Does NOT take options parameter ✅ (already correct)
- **Other Call classes** (Pull, ShowModel, Models, Ps, Version): Don't have options properties (N/A)

**Required Changes**:
- Remove `Call.Options? options = null` parameter from Chat and Embed constructors
- Always set `this.options = new Call.Options()` in constructors
- This ensures all Call instances start with empty options, and callers set them after construction
- **Pattern to follow**: Generate already follows this pattern - it doesn't take options in constructor, has `options` as a property with default initialization

**New Constructor Signature**:
```vala
public Chat(Settings.Connection connection, string model)
{
    base(connection);
    if (model == "") {
        throw new OllamaError.INVALID_ARGUMENT("Model is required");
    }
    this.url_endpoint = "chat";
    this.http_method = "POST";
    this.model = model;
    this.options = new Call.Options();  // Always initialize with empty options
}
```

### Step 0.1: Update All Chat Creation Points

**Files that need fixes**:
1. **`libollmchat/Call/Chat.vala`**:
   - Constructor (line ~98): Remove options parameter, always initialize with `new Call.Options()`

2. **`libollmchat/Call/Embed.vala`**:
   - Constructor (line ~41): Remove options parameter, always initialize with `new Call.Options()`

2. **`libollmchat/Client.vala`**:
   - `chat()` method (line ~190): Remove options from constructor, set after using initializer or property
   - `embed()` method (line ~370): Remove options from constructor, set after using initializer or property
   - `generate()` method (line ~448): Remove options from constructor, set after using initializer or property

3. **`libollmchat/Settings/Config2.vala`**:
   - `create_chat()` method (line ~562): Remove options from constructor, set after using initializer

4. **`libocvector/Indexing/Analysis.vala`**:
   - Chat creation (line ~316): Remove options from constructor, set after using initializer

**Files that are already correct** (no changes needed):
- `libollmchat/History/Manager.vala` - Already sets options after construction (correct pattern)
- `libollmchat/Prompt/AgentHandler.vala` - Already sets options in object initializer (correct pattern)
- `libollmchat/History/SessionBase.vala` - No Chat creation in constructor
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Inherits correct behavior

**Result**: After fixes, all Call class creation (Chat, Embed, Generate, etc.) will follow the pattern: create Call instance, then set options after construction (either via object initializer `{ options = ... }` or property assignment `call.options = ...`). Generate already follows this pattern and serves as the reference implementation.

## Files to Modify

### Files Requiring Changes

1. **`libollmchat/Call/Chat.vala`** (constructor):
   - Remove `Call.Options? options = null` parameter
   - Always initialize with `this.options = new Call.Options()`

2. **`libollmchat/Call/Embed.vala`** (constructor):
   - Remove `Call.Options? options = null` parameter
   - Always initialize with `this.options = new Call.Options()`

3. **`libollmchat/Client.vala`** (3 methods):
   - `chat()` method (line ~190): Remove options from constructor, set after
   - `embed()` method (line ~370): Remove options from constructor, set after
   - `generate()` method (line ~448): Remove options from constructor, set after

4. **`libollmchat/Settings/Config2.vala`** (1 method):
   - `create_chat()` method (line ~562): Remove options from constructor, set after

5. **`libocvector/Indexing/Analysis.vala`** (1 location):
   - Chat creation (line ~316): Remove options from constructor, set after

6. **`libocvector/Database.vala`** (4 locations):
   - Embed creation (line ~117): Remove options from constructor, set after
   - Embed creation (line ~190): Remove options from constructor, set after
   - Embed creation (line ~222): Remove options from constructor, set after
   - Embed creation (line ~250): Remove options from constructor, set after

### Files to Verify (No Changes Expected)

- `libollmchat/History/Manager.vala` - Already sets options after construction (correct pattern)
- `libollmchat/Prompt/AgentHandler.vala` - Already sets options in object initializer (correct pattern)
- `libollmchat/History/SessionBase.vala` - No Chat creation here
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Inherits correct behavior

## Implementation Details

### Step 0.0: Update Call Constructors

#### Chat Constructor

**Location**: `libollmchat/Call/Chat.vala` line ~98

**Current Code**:
```vala
public Chat(Settings.Connection connection, string model, Call.Options? options = null)
{
    base(connection);
    if (model == "") {
        throw new OllamaError.INVALID_ARGUMENT("Model is required");
    }
    this.url_endpoint = "chat";
    this.http_method = "POST";
    this.model = model;
    
    if (options != null) {
        this.options = options;
        return;
    }
    this.options = new Call.Options();
}
```

**New Code**:
```vala
public Chat(Settings.Connection connection, string model)
{
    base(connection);
    if (model == "") {
        throw new OllamaError.INVALID_ARGUMENT("Model is required");
    }
    this.url_endpoint = "chat";
    this.http_method = "POST";
    this.model = model;
    this.options = new Call.Options();  // Always initialize with empty options
}
```

### Step 0.1: Update All Chat Creation Points

#### Client.chat() Method

**Location**: `libollmchat/Client.vala` line ~190

**Current Code**:
```vala
var send_opts = options == null ? new Call.Options() : options;
var call = new Call.Chat(this.connection, model, send_opts) {
    cancellable = cancellable,
    stream = true,
    think = true
};
```

**New Code** (using object initializer):
```vala
var send_opts = options == null ? new Call.Options() : options;
var call = new Call.Chat(this.connection, model) {
    cancellable = cancellable,
    stream = true,
    think = true,
    options = send_opts
};
```

#### Client.embed() Method

**Location**: `libollmchat/Client.vala` line ~370

**Current Code**:
```vala
var send_opts = options == null ? new Call.Options() : options;
var call = new Call.Embed(this.connection, model, send_opts) {
    // ...
};
```

**New Code** (using object initializer):
```vala
var send_opts = options == null ? new Call.Options() : options;
var call = new Call.Embed(this.connection, model) {
    // ...
    options = send_opts
};
```

**Note**: Embed and Generate also need the same change - remove options from constructor.

#### Client.generate() Method

**Location**: `libollmchat/Client.vala` line ~448

**Current Code**:
```vala
var send_opts = options == null ? new Call.Options() : options;
var call = new Call.Generate(this.connection) {
    cancellable = cancellable,
    prompt = prompt,
    system = system,
    model = model,
    stream = false,
    think = false,
    options = send_opts
};
```

**Status**: ✅ Already correct - Generate constructor doesn't take options parameter, and options are set in object initializer. This is the pattern we want for all Call classes.

#### Config2.create_chat() Method

**Location**: `libollmchat/Settings/Config2.vala` line ~562

**Current Code**:
```vala
return new OLLMchat.Call.Chat(client.connection, model_usage_obj.model, model_usage_obj.options) {
    stream = false,
    think = false
};
```

**New Code** (using object initializer):
```vala
return new OLLMchat.Call.Chat(client.connection, model_usage_obj.model) {
    stream = false,
    think = false,
    options = model_usage_obj.options
};
```

#### Analysis Chat Creation

**Location**: `libocvector/Indexing/Analysis.vala` line ~316

**Current Code**:
```vala
var chat = new OLLMchat.Call.Chat(analysis_client.connection, analysis_usage.model, analysis_usage.options) {
    stream = true
};
```

**New Code** (using object initializer):
```vala
var chat = new OLLMchat.Call.Chat(analysis_client.connection, analysis_usage.model) {
    stream = true,
    options = analysis_usage.options
};
```

#### Database Embed Creation (4 locations)

**Location**: `libocvector/Database.vala` lines ~117, ~190, ~222, ~250

**Current Code** (all 4 locations follow same pattern):
```vala
var embed_call = new OLLMchat.Call.Embed(
    connection,
    tool_config.embed.model,
    tool_config.embed.options
) {
    input = "test"  // or texts[0], texts[i], query
};
```

**New Code** (using object initializer):
```vala
var embed_call = new OLLMchat.Call.Embed(
    connection,
    tool_config.embed.model
) {
    input = "test",  // or texts[0], texts[i], query
    options = tool_config.embed.options
};
```

#### Manager.create_new_session() Method

**Location**: `libollmchat/History/Manager.vala` line ~290

**Current Code**:
```vala
var call = new Call.Chat(client.connection, model) {
    stream = true,
    think = true,
};
call.options = options;
```

**Status**: ✅ Already correct - sets options after construction. This is the pattern we want.

## Testing Checklist

### Verification Steps

- [ ] **Chat Constructor**: Verify options parameter is removed, always initializes with `new Call.Options()`
- [ ] **Embed Constructor**: Verify options parameter is removed, always initializes with `new Call.Options()`
- [ ] **Generate Constructor**: Verify it doesn't take options parameter (already correct)
- [ ] **Client.chat()**: Verify options are set after construction (via initializer or property)
- [ ] **Client.embed()**: Verify options are set after construction (via initializer or property)
- [ ] **Client.generate()**: Verify options are set after construction (via initializer or property)
- [ ] **Config2.create_chat()**: Verify options are set after construction (via initializer)
- [ ] **Analysis**: Verify options are set after construction (via initializer)
- [ ] **Database Embed creation** (4 locations): Verify options are set after construction (via initializer)
- [ ] **Manager.create_new_session()**: Verify options are set after construction (already correct)
- [ ] **AgentHandler**: Verify options are set in object initializer (already correct)

### Test Scenarios

1. **Test Chat constructor**:
   - Create Chat without setting options
   - Verify Chat.options is empty Call.Options() (not null)

2. **Test Client methods with provided options**:
   - Create Client (with or without config)
   - Call `chat()`, `embed()`, or `generate()` WITH options parameter
   - Verify Chat.options matches provided options (set after construction)

3. **Test Client methods without provided options**:
   - Create Client (with or without config)
   - Call method without options parameter
   - Verify Chat.options is empty Call.Options() (set after construction)

4. **Test Config2.create_chat()**:
   - Create chat with config containing model_options
   - Verify Chat.options matches model_usage.options (set after construction)

5. **Test Analysis**:
   - Run analysis with tool_config containing analysis options
   - Verify Chat.options matches tool_config.analysis.options (set after construction)

6. **Test Manager.create_new_session()**:
   - Create session with config containing default_model usage
   - Verify Chat.options matches default_model.options (set after construction)

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md) - Parent plan
- [1.2. Refactor Client and Chat Relationship](./1.2-DONE-refactor-client-chat-relationship.md) - Grandparent plan

