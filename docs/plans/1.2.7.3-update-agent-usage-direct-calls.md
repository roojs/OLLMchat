# 1.2.7.3. Update Agent Usage to Direct Method Calls

## Overview

Update agent usage to use direct method calls instead of signals. The flow will be: Chat → Agent (direct method calls) → Session (direct method calls) → Manager signals → UI.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md)

## Status

⏳ **TODO** - Second phase of signal migration.

## Goal

Replace signal connections in agent usage with direct method calls. Chat will call agent methods directly when an agent is set, and emit signals when no agent is set (for non-agent usage).

## Implementation Steps

### Step 2.1: Add Agent Handler Methods

**Goal**: Add methods to AgentHandler that Chat can call directly (instead of using signals).

**Changes**:
1. Add to `libollmchat/Prompt/AgentHandler.vala`:
   ```vala
   /**
    * Called by Chat when a streaming chunk is received.
    * Agent handler should relay to Session.
    */
   public virtual void on_stream_chunk(string new_text, bool is_thinking, Response.Chat response)
   {
       // Default: relay to session
       if (this.session != null) {
           this.session.on_stream_chunk(new_text, is_thinking, response);
       }
   }
   
   /**
    * Called by Chat when streaming starts.
    * Agent handler should relay to Session.
    */
   public virtual void on_stream_start()
   {
       // Default: relay to session
       if (this.session != null) {
           this.session.on_stream_start();
       }
   }
   
   /**
    * Called by Chat when a tool sends a status message.
    * Agent handler should relay to Session.
    */
   public virtual void on_tool_message(Message message)
   {
       // Default: relay to session
       if (this.session != null) {
           this.session.on_tool_message(message);
       }
   }
   ```

2. Add to `libollmchat/History/SessionBase.vala`:
   ```vala
   /**
    * Called by AgentHandler when a streaming chunk is received.
    * Session relays to Manager signals (Manager doesn't process, just relays to UI).
    * 
    * Note: Manager signals are just a relay point - Manager doesn't need to process
    * these events, it just forwards them to UI components that are connected to Manager signals.
    */
   public void on_stream_chunk(string new_text, bool is_thinking, Response.Chat response)
   {
       // Relay directly to Manager signals (Manager is just a relay point, no processing needed)
       this.manager.stream_chunk(new_text, is_thinking, response);
       if (!is_thinking) {
           this.manager.stream_content(new_text, response);
       }
   }
   
   /**
    * Called by AgentHandler when streaming starts.
    * Session relays to Manager signals.
    */
   public void on_stream_start()
   {
       this.manager.stream_start();
   }
   
   /**
    * Called by AgentHandler when a tool sends a status message.
    * Session relays to Manager signals.
    */
   public void on_tool_message(Message message)
   {
       this.manager.tool_message(message);
   }
   ```

**Result**: Agent handlers and Session have methods that Chat can call directly

### Step 2.2: Update Chat to Call Agent Methods Directly

**Goal**: When Chat has an agent reference, call agent methods directly instead of emitting signals.

**Changes**:
1. In `libollmchat/Call/Chat.vala`, update `process_streaming_chunk()`:
   ```vala
   // If Chat has agent reference, call agent method directly (no signal)
   if (this.agent != null) {
       this.agent.on_stream_chunk(new_text, is_thinking, this.streaming_response);
   } else {
       // For non-agent usage, emit signal for loosely coupled components
       this.stream_chunk(new_text, is_thinking, this.streaming_response);
   }
   ```

2. Similar updates for `stream_start()` and `tool_message()` emissions

**Result**: Agent usage uses direct method calls, non-agent usage uses signals

### Step 2.3: Remove Signal Connections from AgentHandler and SessionBase

**Goal**: Remove signal connections since agent usage now uses direct method calls.

**Changes**:
1. Remove from `libollmchat/Prompt/AgentHandler.vala`:
   - Remove `stream_chunk_id`, `stream_start_id` fields
   - Remove signal connections in constructor
   - Remove signal disconnections in destructor
   - Remove `handle_stream_chunk()` method (replaced by `on_stream_chunk()`)

2. Remove from `libollmchat/History/SessionBase.vala`:
   - Remove `stream_chunk_id`, `stream_start_id`, `tool_message_id` fields
   - Remove signal connections in `activate()`
   - Remove signal disconnections in `deactivate()`
   - Remove `stream_chunk_handler_id` field and connection (replaced by direct method calls)

**Result**: Agent usage no longer uses signals, only direct method calls

## Files to Modify

- `libollmchat/Prompt/AgentHandler.vala` - Add direct method calls, remove signal connections
- `libollmchat/History/SessionBase.vala` - Add direct method calls, remove signal connections, relay to Manager signals
- `libollmchat/Call/Chat.vala` - Update to call agent methods directly when agent is set
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Inherits direct method calls from AgentHandler

## Testing Checklist

- [ ] Chat calls agent methods directly when agent is set (on_stream_chunk, on_stream_start, on_tool_message)
- [ ] Chat emits signals when agent is not set (for non-agent usage)
- [ ] AgentHandler has direct method implementations that relay to Session
- [ ] SessionBase has direct method implementations that relay to Manager signals
- [ ] AgentHandler no longer connects to Client signals
- [ ] SessionBase no longer connects to Client signals
- [ ] Streaming still works correctly for agent usage
- [ ] Tool messages still work correctly for agent usage
- [ ] UI updates correctly when streaming starts for agent usage

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md) - Parent plan
- [1.2.7.2. Add Signals to Chat](./1.2.7.2-add-signals-to-chat.md) - Previous phase
- [1.2.7.4. Migrate Non-Agent Signal Connections](./1.2.7.4-migrate-non-agent-signals.md) - Next phase
- [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md) - Grandparent plan

