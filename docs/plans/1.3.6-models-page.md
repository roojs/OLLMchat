# 1.3.6. Models Page and Model Usage Configuration

## Summary

### ✅ Done
- **Add Model Button**: Implemented (see 1.3.4 - Pulling Models)
- **Configuration Structure**: Config2.model_options structure defined
- **Data Flow Design**: Model list synchronization approach defined
- **ModelsPage UI Component**: Main UI component implemented
- **Model List Display**: Connection-grouped model list with search
- **Model Options UI**: Settings panel for configuring model options
- **Refresh Button**: Refresh model list functionality

### ✅ Complete
- All core functionality implemented
- Temp model creation/deletion handled in plan 1.3.8

## Overview

Implement the Models tab in the Settings dialog for listing available models, configuring model-specific options, and managing model usage configurations. This includes the ModelsPage UI component and model configuration management.

## Status

✅ **COMPLETE** - All components implemented and complete

## Related Plans

- **1.3** - Configuration Overview
- **1.3.1** - Configuration Classes
- **1.3.2** - Configuration Interface
- **1.3.4** - Pulling Models (Add Model button implemented)
- **1.5** - Model List Management

## Models Tab

**Purpose**: List available models, add new models, configure model-specific options.

**Components**:
- **Horizontal Box (Action Bar)**: Top horizontal container with search and action buttons
  - **Adw.SearchBar**: Search bar for filtering models
    - Filters model list in real-time as user types using show/hide visibility (does not remove models from list)
    - Searches across all connections
    - Hides connection section headers with no matching models (using visibility, not removal)
  - **Add Model Button**: ✅ Implemented (see 1.3.4 - Pulling Models)
  - **Refresh Button**: ✅ Implemented - Refresh model list from all connections
    - Fetches latest models from all configured connections
    - Updates the model list dynamically
- **Adw.PreferencesGroup**: Contains the model list
  - Wraps `Adw.BoxedList` for consistent styling
- **Model List**: Uses `Adw.BoxedList` to display models grouped by connection
  - Models are organized under their connection name (e.g., "Local Ollama", "Remote Server")
  - Each connection group uses a section header (not expandable) to show the connection name
  - Models are sorted alphabetically by name within each connection group
  - Model rows are added directly to the list after each section header
  - Each model row uses `Adw.ExpanderRow` to show/edit model settings (expandable rows)
  - Shows: model name, connection name (implicit from section header grouping)
- **Model Settings Panel**: Uses `Adw.ExpanderRow` - when model row is expanded (lazy rendering)
  - Settings widgets are added as children to the `Adw.ExpanderRow` using `add_row()` only when expanded
  - Connection: Read-only label (models are fixed to their provider/connection, not changeable)
  - Model Name: Read-only label (model name from the connection)
  - Separator (visual divider)
  - Options fields listed directly (not nested): Temperature, Top P, Top K, Num Ctx, Num Predict, Repeat Penalty, Stop
  - Options widgets restrict invalid input based on value limitations (e.g., temperature 0.0-2.0, num_ctx > 0, etc.)
  - Saves changes on blur/unblur or focus events (when user finishes editing a field)
  - Note: Only models with user-set options are saved to config. Temporary model usage array contains all models on load, but only modified ones are persisted.

**Data Sources**:
- Model list: Fetched from `Client.models()` for each connection
- Model options: `Config2.model_options` (Gee.Map<string, Call.Options>) - Only contains models where user has set options. Key is model name only (e.g., "llama3").
- Models: `models` (Gee.Map<string, Call.Options>) - Copy of model_options with all models. Key format: "connection#model_name" (e.g., "http://127.0.0.1:11434/api#llama3"). Built on load with all models, merged with config values. Only models with user-set options are saved back to config (using model name only as key).

**Note**: Model list is dynamic (fetched from connections). Config2 only stores model options for models where the user has explicitly set values. The composite key format ("connection#model_name") is only used in the ModelsPage's `models` map for the UI dialog - Config2.model_options uses model name only as the key (e.g., "llama3").

**Ideas for Future Enhancement**:
- **Model Notes**: Add a notes field for each model to allow users to make personal notes about models (e.g., "Good for code generation", "Slow but accurate", "Use for creative writing"). This could be stored in `Config2.model_metadata` or a separate `model_notes` map.
- **Expected Tokens/Second (t/s)**: Track expected performance metrics for each model. This could be:
  - Manually set by the user
  - Automatically updated from actual usage statistics (track tokens/second during API calls)
  - Used for estimating response times and selecting appropriate models for different tasks
  - Stored in `Config2.model_metadata` alongside notes

## Files to Create

**4. ModelsPage**
- **Location**: `ollmchat/Settings/ModelsPage.vala`
- **Status**: ✅ **IMPLEMENTED**
- **UI Framework**: Uses `Adw.PreferencesPage` with:
  - Horizontal box at top containing `Adw.SearchBar`, Add Model, and Refresh buttons
  - `Adw.PreferencesGroup` wrapping `Adw.BoxedList` for model list
  - Connection groups use section headers (not expandable) to show connection names
  - Model rows use `Adw.ExpanderRow` for expandable model settings panels
  - Settings widgets added to `Adw.ExpanderRow` via `add_row()` method
  - See [Adw.ExpanderRow documentation](https://valadoc.org/libadwaita-1/Adw.ExpanderRow.html)
- **Purpose**: Models tab content
- **Properties**:
  - `settings_dialog` (SettingsDialog) - Reference to parent SettingsDialog (which has the config object and models_list)
  - `selected_model` (string?) - Currently selected model name
  - `search_filter` (string) - Current search filter text
  - `models` (Gee.Map<string, Call.Options>) - Copy of model_options with all models. Key format: "connection#model_name" (e.g., "http://127.0.0.1:11434/api#llama3"). Built on load with all models, merged with config values. Only models with user-set options are saved back to config (using model name only as key in Config2.model_options).
- **Methods**:
  - `render_models()` - Render models list, grouped by connection. Builds models map with all models on load using composite keys ("connection#model_name"). Models are sorted alphabetically by name within each connection group. Options/settings are rendered lazily when a model is expanded (not all at once). Saves on blur/unblur or focus events (when user finishes editing a field). Uses widgets that restrict invalid input based on option value limitations. Only saves models to config where user has set options (using model name only as key in Config2.model_options).
  - `filter_models(string search_text)` - Filter model list by search text using show/hide visibility (does not remove models from list)
  - `expand_model(string model_name)` - Expand a model's settings panel and collapse any currently expanded model
  - Note: Models list is managed by SettingsDialog (models_list property) or ModelManager

## Implementation Considerations

### Model List Synchronization
**Problem**: Model list is dynamic (fetched from connections), but model options are stored in Config2. Need to handle cases where:
- Model exists in Config2.model_options but not in any connection (stale config)
- Model exists in connection but not in Config2.model_options (no user-set options yet)

**Solution**:
- Model list shows all models from all connections (union)
- ModelsPage builds temporary `models` map with all models from connections, merged with Config2.model_options values
- Options are edited inline when model is expanded - no separate "Add Model Options" action needed
- Only models with user-set options are saved to Config2.model_options (using model name as key)
- Stale entries in Config2.model_options (models no longer in any connection) are ignored in UI but preserved in config

### Temp Model Creation and Deletion

**Purpose**: When users try to run a chat with a model that has a custom `num_ctx` setting, we need to create temporary model variants since `num_ctx` requires using ollama's `create` API rather than just API options.

**Temp Model Creation**:
- When user tries to run a chat with a model that has a custom `num_ctx`:
  1. Check if temp model exists at `ollmchat-temp/{model-name}-oc{ctx_value}` (e.g., `ollmchat-temp/llama3-oc4096`)
  2. If it doesn't exist, create it using ollama's `create` API with the specified `num_ctx` value
  3. Use this temporary model variant for the chat call
  4. Temp model name format: `{model-name}-oc{ctx_value}` where ctx_value is the num_ctx setting

**Temp Model Management**:
- **Model Listings**: All model listings (from `Client.models()` and UI displays) must **always ignore** models in `ollmchat-temp` directory
- **Startup Cleanup**: On application startup:
  1. Check all models in `ollmchat-temp` directory
  2. Check running processes (via `ps`) to see which ollmchat-temp models are currently in use
  3. Delete all `ollmchat-temp` models that are **not** listed in running processes
  4. This prevents accumulation of unused temporary model variants

## Integration Points

- **Config2**: Model options stored in `Config2.model_options` map (model name → Call.Options)
- **Client**: Used for fetching models from connections via `Client.models()`
- **Connections**: Models are grouped by connection in the UI
- **Call.Options**: Used for model option values (temperature, top_p, top_k, num_ctx, etc.)
- **PullManager**: Add Model button connects to PullManager for pulling new models (see 1.3.4)

## Completion Summary

✅ **All components complete** - The Models Page and Model Usage Configuration system has been fully implemented:
- ModelsPage UI component with connection-grouped model list
- Model options configuration with inline editing
- Search and filter functionality
- Refresh button for updating model list
- Integration with Config2.model_options for persistence

