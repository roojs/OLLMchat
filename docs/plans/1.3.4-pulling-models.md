# 1.3.4. Pulling Models

## Overview
Add an "Add Model" button to the Models page that opens a dialog with a searchable dropdown for selecting models to pull. The dialog manages model list caching, background pull operations with progress tracking, and persistence of pull state.

## Status

üöß **IN PROGRESS** - Core UI components completed, background pull operations pending

**Completed:**
- ‚úÖ Phase 1: Test tool (`oc-test-pull`)
- ‚úÖ Phase 2: `SearchablePulldown` widget
- ‚úÖ Phase 3: Model cache management (`AvailableModels`, `AvailableModel`)
- ‚úÖ Phase 4: `AddModelDialog` with connection and model selection
- ‚úÖ Phase 7.8: Add Model button wired up in `ModelsPage`
- ‚úÖ `Call.Pull` class for API calls

**Remaining:**
- ‚è≥ Phase 5: `ModelPullManager` for background pull operations
- ‚è≥ Phase 5.6: Progress banner in `ModelsPage`
- ‚è≥ Phase 6: `loading.json` persistence and recovery
- ‚è≥ Phase 7.9: `ModelsPage` initialization with pull manager integration

## Implementation Steps

### Phase 1: Test Tool for Ollama Pull Streaming
1. **Create `oc-test-pull` test tool** (`examples/oc-test-pull.vala`) ‚úÖ **COMPLETED**
   - Command-line tool to test `ollama pull` with streaming enabled
   - Uses `OLLMchat.Client` to call the `/api/pull` endpoint with `stream: true`
   - Parses and displays JSON progress chunks (status, progress percentages, etc.)
   - Helps understand the exact format of progress updates from ollama pull API
   - Add to `examples/meson.build` following the pattern of `oc-test-cli`
   
   **Findings from test output:**
   - Status messages: "pulling manifest" initially, then "pulling <short_hash>" (e.g., "pulling 415f8f959d80")
   - Each chunk includes: `status`, `digest` (full sha256 hash), `completed`, `total` (bytes)
   - Progress is calculated from `completed`/`total` fields
   - Multiple chunks with same status/progress are emitted (normal behavior)

### Phase 2: Extract SearchablePulldown Widget
2. **Create `SearchablePulldown` widget** (`ollmchat/Settings/SearchablePulldown.vala`) ‚úÖ **COMPLETED**
   - Generic searchable dropdown widget (not tied to FileBase like SearchableDropdown)
   - Extracts generic parts from `liboccoder/SearchableDropdown.vala`
   - Uses `GObject.ListModel` interface to work with any list model (e.g., `Gee.ArrayList`)
   - Accepts custom factory functions for creating list items and extracting display text
   - Provides text entry with filtering and popover list
   - Similar keyboard navigation and selection behavior

### Phase 3: Model List Cache Management
3. **Implement model cache download** ‚úÖ **COMPLETED** (`libollmchat/Settings/AvailableModels.vala`)
   - Created `AvailableModels` class that wraps `Gee.ArrayList<AvailableModel>`
   - Checks for `data_dir/models.cache.json` existence and age (3 day threshold)
   - If missing or older than 3 days, downloads from `https://ollama-models.zwz.workers.dev/models`
   - Uses `Soup.Session` and `Soup.Message` (similar to `libollmchat/Call/Base.vala`)
   - Parses JSON response and deserializes into `AvailableModel` objects
   - Saves cache file with timestamp
   - Provides `load()` method that loads from cache or refreshes if needed
   - Provides `refresh()` method to force refresh from remote URL
   - `AvailableModel` class handles nested `details` object flattening (format, family)

### Phase 4: Add Model Dialog
4. **Create `AddModelDialog` class** (`ollmchat/Settings/AddModelDialog.vala`) ‚úÖ **COMPLETED**
   - Similar structure to `ConnectionAdd` dialog (uses `Adw.PreferencesDialog`)
   - Three rows in `Adw.PreferencesGroup`:
     1. **Connection row** (`Adw.ActionRow`):
        - Simple `Gtk.DropDown` with `Gtk.StringList` containing connection URLs/names
        - Defaults to 'default' connection (use `Config2.get_default_connection()`)
        - Populate from `config.connections` map
     2. **Model row** (`Adw.ActionRow`):
        - `SearchablePulldown` widget (works with `GObject.ListModel`)
        - Uses `AvailableModels` as backing store with filter/sort chain
        - Custom factory displays model name, description, sizes, features, and downloads with Pango markup
        - Placeholder text: "Search models (e.g., gemma3, qwen3)"
        - Filter/search by model name with smart sorting (prefix matches first)
     3. **Size row** (`Adw.ActionRow`):
        - `Gtk.DropDown` with `ModelTag` objects for size variants
        - Hidden until model is selected
        - Sorts tags by size (cloud tags last), selects default (largest <= 100GB)
     4. **Start Download button** (in footer `Adw.PreferencesGroup`):
        - `Gtk.Button` with "Start Download" label and `suggested-action` CSS class
        - Currently: closes dialog and sets `selected_connection_url` and `selected_model_name` properties
        - ‚è≥ **TODO**: Wire up to `ModelPullManager` in Phase 5 to start pull operation
   - Creates `AvailableModels` instance in constructor, calls `load()` async to populate model list
   - Takes `SettingsDialog` as parameter to access connections and app config

### Phase 5: Background Pull with Progress
5. **Implement `ModelPullManager` class** (`ollmchat/Settings/ModelPullManager.vala`)
   - Manages background threads for `ollama pull` operations
   - Uses `OLLMchat.Client` to call `/api/pull` endpoint with streaming
   - Parses progress from JSON chunks (status, completed, total, etc.)
   - Uses `GLib.Idle.add()` to send progress updates to UI thread
   - **Rate limits UI updates**: Throttle progress updates to at most once every 2 seconds per model to avoid overwhelming the UI
     - Track last update time per model
     - Only emit progress signal if 2+ seconds have passed since last update, or if status changed
     - Always emit final status updates (complete/error) immediately
   - Tracks multiple concurrent pulls (one thread per model)
   - Writes to `data_dir/loading.json` when starting/finishing pulls
   - Format: `{"model_name": {"status": "pulling", "progress": 45, "started": "timestamp"}}`
   - **Error handling with retry logic**:
     - On error, retry up to 5 times with 1 minute delay between retries
     - Status "pending-retry" while waiting to retry (just progress indicator update, no notification)
     - Status "failed" after all retries exhausted (triggers `model_failed` signal for notification)
     - Reset retry count if data is received during retry (means retry is working)
     - Remove from cache and file when status is "failed" (same as "complete")
     - Track retry count in `LoadingStatus` object

6. **Add progress banner to ModelsPage**
   - Add `Adw.Banner` widget to display pull progress
   - Shows "Loading {model_name} {progress}% complete" message
   - Shows "Retrying {model_name} in {seconds}..." for pending-retry status
   - Updates via `Idle.add()` callbacks from `ModelPullManager`
   - Shows/hides based on active pull operations
   - Can display multiple models if pulling concurrently
   - Connect to `model_failed` signal to show notification when download fails after retries

### Phase 6: Pull State Persistence and Recovery
7. **Implement loading.json persistence**
   - `ModelPullManager` writes to `data_dir/loading.json` on:
     - Pull start: `{"model_name": {"status": "pulling", "progress": 0, "started": "..."}}`
     - Progress updates: update progress percentage
     - Pull complete: `{"model_name": {"status": "complete", "progress": 100}}`
     - Pull error: `{"model_name": {"status": "error", "error": "..."}}`
   - When `AddModelDialog` opens, check `loading.json` for incomplete pulls
   - If found and no active threads, attempt to restart/resume pull operations
   - Clean up completed entries from `loading.json`

### Phase 7: Integration
8. **Wire up Add Model button** (`ollmchat/Settings/ModelsPage.vala`) ‚úÖ **PARTIALLY COMPLETED**
   - ‚úÖ Add Model button enabled and connected to show `AddModelDialog`
   - ‚úÖ Dialog loads and displays correctly
   - ‚è≥ **TODO**: Pass `ModelPullManager` instance to dialog
   - ‚è≥ **TODO**: Connect `ModelPullManager` progress signals to update banner

9. **Update ModelsPage initialization** ‚è≥ **NOT STARTED**
   - ‚è≥ Create `ModelPullManager` instance in constructor
   - ‚è≥ Check `loading.json` on page activation
   - ‚è≥ Resume any incomplete pulls if threads aren't running
   - ‚è≥ Connect progress updates to banner display

## Files to Create/Modify

### New Files
- `examples/oc-test-pull.vala` - Test tool for pull streaming ‚úÖ **COMPLETED**
- `libollmchat/Settings/AvailableModel.vala` - Model data class with JSON serialization ‚úÖ **COMPLETED**
- `libollmchat/Settings/AvailableModels.vala` - Model cache management wrapper ‚úÖ **COMPLETED**
- `libollmchat/Settings/ModelTag.vala` - Model tag/size variant data class ‚úÖ **COMPLETED** (used by AddModelDialog for size selection)
- `ollmchat/Settings/SearchablePulldown.vala` - Generic searchable dropdown with ListModel support ‚úÖ **COMPLETED**
- `ollmchat/Settings/AddModelDialog.vala` - Dialog for selecting models to pull ‚úÖ **COMPLETED**
- `ollmchat/Settings/ModelPullManager.vala` - Manages background pull operations ‚è≥ **NOT STARTED**

### Modified Files
- `examples/meson.build` - Add `oc-test-pull` executable ‚úÖ **COMPLETED**
- `ollmchat/Settings/ModelsPage.vala` - Enable Add Model button ‚úÖ **COMPLETED**, add banner ‚è≥ **TODO**, integrate pull manager ‚è≥ **TODO**
- `libollmchat/Client.vala` - Add `pull()` method for `/api/pull` endpoint (if needed, or use Call.Pull) - ‚úÖ **NOT NEEDED** (using `Call.Pull` directly)
- `libollmchat/Call/Pull.vala` - Create new Call class for pull endpoint ‚úÖ **COMPLETED**

## Technical Details

### Ollama Pull API
- Endpoint: `POST /api/pull`
- Request body: `{"name": "model_name", "stream": true}`
- Response: Streaming JSON chunks with status updates:
  - `{"status": "pulling manifest", "digest": "sha256:...", ...}`
  - `{"status": "pulling <digest>", "digest": "sha256:...", "Progress": "completed/total (percentage%)", ...}`
  - Status values observed: "pulling manifest", "pulling <short_hash>" (e.g., "pulling 415f8f959d80")
  - Progress format: `"Progress": "430243/300796576 (0.1%)"` - shows completed bytes, total bytes, and percentage
  - Digest: Full sha256 hash (e.g., "sha256:415f8f959d807bd4d4da891f01225d7b330416947fb011a8473080ae4fd07885")
  - Final chunk: `{"status": "success", ...}` (or error status)

### Background Thread Pattern
- Use `Thread<bool>` for pull operations (similar to `libocfiles/Folder.vala:read_dir_scan`)
- Use `Idle.add((owned) callback)` to schedule UI updates from background thread
- Track threads in `ModelPullManager` to prevent duplicate pulls

### Progress Calculation
- Parse `completed` and `total` from JSON chunks (available during pull operations)
- Calculate percentage: `(completed / total) * 100`
- Progress updates occur during "pulling" status (not just "downloading")
- The JSON may also include a formatted `"Progress"` field: `"430243/300796576 (0.1%)"` but prefer parsing `completed`/`total` for accuracy
- Update banner text: `"Loading {model_name} {progress}% complete"`

## Dependencies
- `libsoup-3.0` for HTTP downloads (already in dependencies)
- `json-glib-1.0` for JSON parsing (already in dependencies)
- `gee-0.8` for collections (already in dependencies)

## Related Plans
- **1.3** - Multiple Client Configuration
- **1.5** - Model List Management

