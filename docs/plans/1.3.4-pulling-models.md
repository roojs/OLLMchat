# 1.3.4. Pulling Models

## Overview
Add an "Add Model" button to the Models page that opens a dialog with a searchable dropdown for selecting models to pull. The dialog manages model list caching, background pull operations with progress tracking, and persistence of pull state.

## Status

✅ **COMPLETED** - All phases implemented and integrated

**Completed:**
- ✅ Phase 1: Test tool (`oc-test-pull`)
- ✅ Phase 2: `SearchablePulldown` widget
- ✅ Phase 3: Model cache management (`AvailableModels`, `AvailableModel`)
- ✅ Phase 4: `AddModelDialog` with connection and model selection
- ✅ Phase 5: `PullManager` for background pull operations
  - ✅ `PullManager` class (main thread logic)
  - ✅ `PullManagerThread` class (background thread logic)
  - ✅ `PullStatus` class (status persistence)
  - ✅ Retry logic with exponential backoff (up to 5 retries)
  - ✅ Rate-limited UI updates (2 second throttle)
  - ✅ Multiple concurrent pulls support
- ✅ Phase 5.6: Progress banner (`PullManagerBanner`) integrated in `SettingsDialog`
- ✅ Phase 6: `loading.json` persistence and recovery
  - ✅ JSON array format for status storage
  - ✅ Automatic loading on startup
  - ✅ Rate-limited file writes (5 minutes or on start/finish)
  - ✅ Automatic resume of incomplete pulls on startup
- ✅ Phase 7.8: Add Model button fully wired up in `ModelsPage`
  - ✅ Dialog connected to `PullManager.start_pull()`
  - ✅ All integration complete
- ✅ Phase 7.9: `PullManager` initialization and integration
  - ✅ `PullManager` created in `SettingsDialog` (shared across pages)
  - ✅ Automatic loading of `loading.json` on construction
  - ✅ Resume incomplete pulls on startup
  - ✅ Progress signals connected to banner
  - ✅ `model_complete` and `model_failed` signals connected
- ✅ `Call.Pull` class for API calls
- ✅ `Response.Pull` class for typed pull responses

## Implementation Steps

### Phase 1: Test Tool for Ollama Pull Streaming
1. **Create `oc-test-pull` test tool** (`examples/oc-test-pull.vala`) ✅ **COMPLETED**
   - Command-line tool to test `ollama pull` with streaming enabled
   - Uses `OLLMchat.Client` to call the `/api/pull` endpoint with `stream: true`
   - Parses and displays JSON progress chunks (status, progress percentages, etc.)
   - Helps understand the exact format of progress updates from ollama pull API
   - Add to `examples/meson.build` following the pattern of `oc-test-cli`
   
   **Findings from test output:**
   - Status messages: "pulling manifest" initially, then "pulling <short_hash>" (e.g., "pulling 415f8f959d80")
   - Each chunk includes: `status`, `digest` (full sha256 hash), `completed`, `total` (bytes)
   - Progress is calculated from `completed`/`total` fields
   - Multiple chunks with same status/progress are emitted (normal behavior)

### Phase 2: Extract SearchablePulldown Widget
2. **Create `SearchablePulldown` widget** (`ollmchat/Settings/SearchablePulldown.vala`) ✅ **COMPLETED**
   - Generic searchable dropdown widget (not tied to FileBase like SearchableDropdown)
   - Extracts generic parts from `liboccoder/SearchableDropdown.vala`
   - Uses `GObject.ListModel` interface to work with any list model (e.g., `Gee.ArrayList`)
   - Accepts custom factory functions for creating list items and extracting display text
   - Provides text entry with filtering and popover list
   - Similar keyboard navigation and selection behavior

### Phase 3: Model List Cache Management
3. **Implement model cache download** ✅ **COMPLETED** (`libollmchat/Settings/AvailableModels.vala`)
   - Created `AvailableModels` class that wraps `Gee.ArrayList<AvailableModel>`
   - Checks for `data_dir/models.cache.json` existence and age (3 day threshold)
   - If missing or older than 3 days, downloads from `https://ollama-models.zwz.workers.dev/models`
   - Uses `Soup.Session` and `Soup.Message` (similar to `libollmchat/Call/Base.vala`)
   - Parses JSON response and deserializes into `AvailableModel` objects
   - Saves cache file with timestamp
   - Provides `load()` method that loads from cache or refreshes if needed
   - Provides `refresh()` method to force refresh from remote URL
   - `AvailableModel` class handles nested `details` object flattening (format, family)

### Phase 4: Add Model Dialog
4. **Create `AddModelDialog` class** (`ollmchat/Settings/AddModelDialog.vala`) ✅ **COMPLETED**
   - Similar structure to `ConnectionAdd` dialog (uses `Adw.PreferencesDialog`)
   - Three rows in `Adw.PreferencesGroup`:
     1. **Connection row** (`Adw.ActionRow`):
        - Simple `Gtk.DropDown` with `Gtk.StringList` containing connection URLs/names
        - Defaults to 'default' connection (use `Config2.get_default_connection()`)
        - Populate from `config.connections` map
     2. **Model row** (`Adw.ActionRow`):
        - `SearchablePulldown` widget (works with `GObject.ListModel`)
        - Uses `AvailableModels` as backing store with filter/sort chain
        - Custom factory displays model name, description, sizes, features, and downloads with Pango markup
        - Placeholder text: "Search models (e.g., gemma3, qwen3)"
        - Filter/search by model name with smart sorting (prefix matches first)
     3. **Size row** (`Adw.ActionRow`):
        - `Gtk.DropDown` with `ModelTag` objects for size variants
        - Hidden until model is selected
        - Sorts tags by size (cloud tags last), selects default (largest <= 100GB)
     4. **Start Download button** (in footer `Adw.PreferencesGroup`):
        - `Gtk.Button` with "Start Download" label and `suggested-action` CSS class
        - ✅ Connected to `PullManager.start_pull()` to start pull operation
        - ✅ Closes dialog after starting pull
   - Creates `AvailableModels` instance in constructor, calls `load()` async to populate model list
   - Takes `SettingsDialog` as parameter to access connections and app config

### Phase 5: Background Pull with Progress
5. **Implement `ModelPullManager` class** ✅ **COMPLETED** (`ollmchat/Settings/ModelPullManager.vala`)
   - ✅ Manages background thread for `ollama pull` operations (single thread handles all pulls concurrently)
   - ✅ Uses `OLLMchat.Client` to call `/api/pull` endpoint with streaming
   - ✅ Parses progress from JSON chunks using `Response.Pull` typed objects (status, completed, total, etc.)
   - ✅ Uses `GLib.MainContext.invoke()` to dispatch signals to main thread for UI updates
   - ✅ **Rate limits UI updates**: Throttle progress updates to at most once every 2 seconds per model
     - ✅ Track last update time per model
     - ✅ Only emit progress signal if 2+ seconds have passed since last update, or if status changed
     - ✅ Always emit final status updates (complete/error) immediately
   - ✅ Tracks multiple concurrent pulls (single background thread with MainLoop handles all)
   - ✅ Writes to `data_dir/loading.json` when starting/finishing pulls
   - ✅ Format: JSON array `[{"model_name": "...", "status": "pulling", "completed": 0, "total": 0, "started": "timestamp", ...}]`
   - ✅ **Error handling with retry logic**:
     - ✅ On error, retry up to 5 times with exponential backoff (10s, 30s, 1m, 2m, 5m)
     - ✅ Status "pending-retry" while waiting to retry (just progress indicator update, no notification)
     - ✅ Status "failed" after all retries exhausted (triggers `model_failed` signal for notification)
     - ✅ Reset retry count if data is received during retry (means retry is working)
     - ✅ Remove from cache and file when status is "failed" (same as "complete")
     - ✅ Track retry count in `LoadingStatus` object
   - ✅ Split into three classes for clarity:
     - ✅ `LoadingStatus` - Status data class with JSON serialization
     - ✅ `ModelPullManager` - Main thread logic, UI interaction, persistence
     - ✅ `ModelPullManagerThread` - Background thread logic, network operations

6. **Add progress banner to ModelsPage** ✅ **COMPLETED**
   - ✅ Created `PullManagerBanner` widget to display pull progress
   - ✅ Shows progress bars with percentage for each active pull
   - ✅ Shows retry status and completion status
   - ✅ Updates via `progress_updated` signal from `PullManager`
   - ✅ Shows/hides based on active pull operations
   - ✅ Can display multiple models if pulling concurrently
   - ✅ Connected to `model_failed` signal for failure notifications
   - ✅ Integrated in `SettingsDialog` action bar area (shared across all pages)

### Phase 6: Pull State Persistence and Recovery
7. **Implement loading.json persistence** ✅ **COMPLETED**
   - ✅ `ModelPullManager` writes to `data_dir/loading.json` on:
     - ✅ Pull start: Array format with status, completed, total, started timestamp
     - ✅ Progress updates: Rate-limited writes (every 5 minutes or on status change)
     - ✅ Pull complete: Removed from array when status is "complete"
     - ✅ Pull error/failed: Removed from array when status is "failed"
   - ✅ Format: JSON array `[{...}, {...}]` using `Json.gobject_to_data()` for each `LoadingStatus` object
   - ✅ Automatic loading on `ModelPullManager` construction
   - ✅ Uses `model_name` property in `LoadingStatus` for cache key
   - ✅ Clean up completed/failed entries from `loading.json` automatically

### Phase 7: Integration
8. **Wire up Add Model button** (`ollmchat/Settings/ModelsPage.vala`) ✅ **COMPLETED**
   - ✅ Add Model button enabled and connected to show `AddModelDialog`
   - ✅ Dialog loads and displays correctly
   - ✅ Dialog accesses `PullManager` via `settings_dialog.pull_manager`
   - ✅ Dialog's "Start Download" button connected to `PullManager.start_pull()`
   - ✅ `PullManager` progress signals connected to banner via `PullManagerBanner`

9. **Update ModelsPage initialization** ✅ **COMPLETED**
   - ✅ `PullManager` instance created in `SettingsDialog` constructor (shared across all pages)
   - ✅ `PullManager` automatically loads `loading.json` on construction
   - ✅ `PullManager.resume_incomplete_pulls()` resumes pulls with status "pulling" or "pending-retry"
   - ✅ `PullManagerBanner` connects to `progress_updated` signal for banner display
   - ✅ `ModelsPage` connects to `model_complete` signal to refresh model list
   - ✅ `PullManagerBanner` connects to `model_failed` signal for failure notifications

## Files to Create/Modify

### New Files
- `examples/oc-test-pull.vala` - Test tool for pull streaming ✅ **COMPLETED**
- `libollmchat/Settings/AvailableModel.vala` - Model data class with JSON serialization ✅ **COMPLETED**
- `libollmchat/Settings/AvailableModels.vala` - Model cache management wrapper ✅ **COMPLETED**
- `libollmchat/Settings/ModelTag.vala` - Model tag/size variant data class ✅ **COMPLETED** (used by AddModelDialog for size selection)
- `libollmchat/Response/Pull.vala` - Typed response class for pull API ✅ **COMPLETED**
- `ollmchat/Settings/SearchablePulldown.vala` - Generic searchable dropdown with ListModel support ✅ **COMPLETED**
- `ollmchat/Settings/AddModelDialog.vala` - Dialog for selecting models to pull ✅ **COMPLETED**
- `ollmchat/Settings/PullStatus.vala` - Status data class with JSON serialization ✅ **COMPLETED**
- `ollmchat/Settings/PullManager.vala` - Main thread logic for pull management ✅ **COMPLETED**
- `ollmchat/Settings/PullManagerThread.vala` - Background thread logic for pull operations ✅ **COMPLETED**
- `ollmchat/Settings/PullManagerBanner.vala` - Progress banner widget ✅ **COMPLETED**

### Modified Files
- `examples/meson.build` - Add `oc-test-pull` executable ✅ **COMPLETED**
- `examples/oc-test-pull.vala` - Updated to use `Json.gobject_to_data()` instead of Generator ✅ **COMPLETED**
- `ollmchat/Settings/ModelsPage.vala` - Enable Add Model button ✅ **COMPLETED**, connect to pull manager ✅ **COMPLETED**
- `ollmchat/Settings/SettingsDialog.vala` - Create PullManager instance ✅ **COMPLETED**, integrate PullManagerBanner ✅ **COMPLETED**
- `libollmchat/Client.vala` - Add `pull()` method for `/api/pull` endpoint (if needed, or use Call.Pull) - ✅ **NOT NEEDED** (using `Call.Pull` directly)
- `libollmchat/Call/Pull.vala` - Create new Call class for pull endpoint ✅ **COMPLETED**
  - ✅ Updated to use `Response.Pull` typed objects instead of `Json.Object`
  - ✅ Simplified JSON deserialization using `Json.gobject_deserialize()`
- `libollmchat/meson.build` - Added `Response/Pull.vala` to sources ✅ **COMPLETED**
- `ollmchat/meson.build` - Added `PullStatus.vala`, `PullManagerThread.vala`, and `PullManagerBanner.vala` to sources ✅ **COMPLETED**
- `docs/meson.build` - Added all new classes to valadoc input list ✅ **COMPLETED**

## Technical Details

### Ollama Pull API
- Endpoint: `POST /api/pull`
- Request body: `{"name": "model_name", "stream": true}`
- Response: Streaming JSON chunks with status updates:
  - `{"status": "pulling manifest", "digest": "sha256:...", ...}`
  - `{"status": "pulling <digest>", "digest": "sha256:...", "Progress": "completed/total (percentage%)", ...}`
  - Status values observed: "pulling manifest", "pulling <short_hash>" (e.g., "pulling 415f8f959d80")
  - Progress format: `"Progress": "430243/300796576 (0.1%)"` - shows completed bytes, total bytes, and percentage
  - Digest: Full sha256 hash (e.g., "sha256:415f8f959d807bd4d4da891f01225d7b330416947fb011a8473080ae4fd07885")
  - Final chunk: `{"status": "success", ...}` (or error status)

### Background Thread Pattern
- ✅ Use single `Thread<bool>` with `MainLoop` and `MainContext` for all pull operations
- ✅ Background thread creates its own `MainContext`, pushes it as thread default, runs `MainLoop`
- ✅ Use `MainContext.invoke()` to dispatch signals to main thread for UI updates
- ✅ Track active pulls in `ModelPullManager` to prevent duplicate pulls
- ✅ Thread safety: Pass primitive data between threads, avoid sharing objects directly

### Progress Calculation
- ✅ Parse `completed` and `total` from `Response.Pull` typed objects (available during pull operations)
- ✅ Calculate percentage: `(completed / total) * 100` (stored in `PullStatus.get_fraction()` method)
- ✅ Progress updates occur during "pulling" status (not just "downloading")
- ✅ Store `completed` and `total` as `int64` in `PullStatus` for persistence
- ✅ Progress is calculated on-demand from `completed`/`total` fields
- ✅ Banner displays progress via `PullStatus.get_progress_text()` method with model name and percentage

## Dependencies
- `libsoup-3.0` for HTTP downloads (already in dependencies)
- `json-glib-1.0` for JSON parsing (already in dependencies)
- `gee-0.8` for collections (already in dependencies)

## Related Plans
- **1.3** - Multiple Client Configuration
- **1.5** - Model List Management

