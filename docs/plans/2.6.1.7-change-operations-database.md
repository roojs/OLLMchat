# 2.6.1.7. Change Operations Database Table

## Overview

Create a new database table to track change operations (add, update, delete) separately from the active filesystem view. This will allow better handling of file/folder deletions and recreations, type mismatches, and change tracking.

## Status

⏳ **PLANNING** - Design phase. Details to be worked out.

## Prerequisites

- Phase 6 (2.6.1.6) must be completed
- See main plan: `2.6.1-code-exec-improvements.md` for context

## Goals

1. Create new `change_operations` database table to track file/folder changes
2. Separate active filesystem view (current `filebase` table) from change tracking
3. Better handle file/folder deletions and recreations
4. Better handle type mismatches (file→folder, folder→file)
5. Improve change tracking and audit trail

## Implementation Details

### Database Schema

**New table: `change_operations`**
- `id` INTEGER PRIMARY KEY
- `filebase_id` INT64 - Reference to filebase record (or NULL for new files)
- `operation_type` TEXT - "add", "update", "delete", "type_change"
- `overlay_path` TEXT - Path in overlay filesystem
- `real_path` TEXT - Real project path
- `old_type` TEXT - Previous base_type (for type changes)
- `new_type` TEXT - New base_type (for type changes)
- `timestamp` INT64 - When the change occurred
- `is_ignored` INTEGER - Whether the item is ignored
- `backup_created` INTEGER - Whether backup was created
- `status` TEXT - "pending", "completed", "failed"
- Additional fields TBD

### Benefits

- Active filesystem view (`filebase` table) remains clean - only current state
- Change operations tracked separately with full history
- Can handle complex scenarios:
  - File deleted then recreated as folder
  - Folder deleted then recreated as file
  - Multiple changes to same path
- Better audit trail for what happened during command execution
- Can replay/undo operations if needed

### Files to Modify

- `libocfiles/FileBase.vala` - Add change operations table initialization
- `liboctools/RunCommand/Monitor.vala` - Track changes in new table
- `liboctools/RunCommand/Overlay.vala` - Process changes from new table
- Additional files TBD

## Notes

- Details to be worked out during implementation
- This is a significant architectural change
- May require migration of existing change tracking logic
