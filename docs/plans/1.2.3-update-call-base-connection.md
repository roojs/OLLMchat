# 1.2.3. Update Call.Base to Take Connection Directly

## Overview

Update `Call.Base` and all Call constructors to take `Connection` directly instead of `Client`. This simplifies the design since Client is just a thin wrapper around Connection.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

‚è≥ **TODO** - Refactoring needed.

## Goal

Make Call objects take `Connection` directly, eliminating the need to pass `Client` when `Client` only holds `connection`. Client remains as a convenience wrapper for simple API methods.

## Changes Required

### 1. Update OllamaBase


**Current**:
```vala
public class OllamaBase : Object, Json.Serializable
{
    public Client? client { get; protected set; }
    
    protected OllamaBase(Client? client = null)
    {
        this.client = client;
    }
}
```

**New**:
```vala
public class OllamaBase : Object, Json.Serializable
{
    public Settings.Connection? connection { get; protected set; }
    
    protected OllamaBase(Settings.Connection? connection = null)
    {
        this.connection = connection;
    }
}
```

**Impact**: All classes that inherit from `OllamaBase` will now have `connection` instead of `client`.

### 2. Update Call.Base

**Current**:
```vala
protected Base(Client client) 
{
    base(client);
}

protected string build_url()
{
    var base_url = this.client.connection.url;
    // ...
}

protected async Bytes send_request(bool needs_body) throws Error
{
    if (this.client.session == null) {
        this.client.session = new Soup.Session();
    }
    this.client.session.timeout = this.client.timeout;
    var message = this.client.connection.soup_message(this.http_method, url);
    // ...
}
```

**New**:
```vala
protected Base(Settings.Connection connection) 
{
    base(connection);
}

protected string build_url()
{
    var base_url = this.connection.url;
    // ...
}

protected async Bytes send_request(bool needs_body) throws Error
{
    if (this.connection.session == null) {
        this.connection.session = new Soup.Session();
    }
    this.connection.session.timeout = this.connection.timeout;
    var message = this.connection.soup_message(this.http_method, url);
    // ...
}
```

### 3. Update All Call Constructors

Update all Call class constructors to take `Connection` instead of `Client`:

- `Call.Chat(Connection connection, string model, Call.Options? options = null)`
- `Call.Embed(Connection connection, string model, Call.Options? options = null)`
- `Call.Generate(Connection connection, string model, ...)`
- `Call.Models(Connection connection)`
- `Call.Ps(Connection connection)`
- `Call.Version(Connection connection)`
- `Call.Show(Connection connection, string model_name)`
- `Call.Pull(Connection connection, string model_name)`

### 4. Update Client Convenience Methods

Client methods that create Call objects should pass `this.connection`:

**Current**:
```vala
public async Response.Chat chat(string text, GLib.Cancellable? cancellable = null) throws Error
{
    var call = new Call.Chat(this, this.model) {
        cancellable = cancellable
    };
    // ...
}
```

**New**:
```vala
public async Response.Chat chat(string text, string model, GLib.Cancellable? cancellable = null) throws Error
{
    var call = new Call.Chat(this.connection, model) {
        cancellable = cancellable
    };
    // ...
}
```

## Implementation Steps

### Step 1: Update OllamaBase

1. Change `client` property to `connection`
2. Update constructor to take `Connection` instead of `Client`
3. Update serialization to exclude `connection` (same as it excluded `client`)

### Step 2: Update Call.Base

1. Update constructor to take `Connection`
2. Update `build_url()` to use `this.connection.url`
3. Update `send_request()` to use `this.connection.session` and `this.connection.timeout`
4. Update `handle_streaming_response()` to use `this.connection.session` and `this.connection.timeout`

### Step 3: Update All Call Constructors

For each Call class:
1. Change constructor parameter from `Client client` to `Settings.Connection connection`
2. Update `base(connection)` call
3. Remove any usage of `this.client.*` and replace with `this.connection.*`

### Step 4: Update All Call Creation Points

Find all places that create Call objects and update to pass `connection` instead of `client`:

- `AgentHandler` - Pass `connection` instead of `client`
- `Client` convenience methods - Pass `this.connection`
- `Manager` - Pass `connection` instead of `client`
- Any other code creating Call objects

See [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md) for detailed list.

### Step 5: Update Serialization

Ensure `connection` is excluded from JSON serialization (same as `client` was):
```vala
public override Json.Node serialize_property(string property_name, Value value, ParamSpec pspec)
{
    if (property_name == "connection") {
        return null;  // Exclude connection from serialization
    }
    // ...
}
```

## Files to Modify

### Core Classes
- `libollmchat/OllamaBase.vala` - Change `client` to `connection`
- `libollmchat/Call/Base.vala` - Update to use `connection`
- `libollmchat/Call/Chat.vala` - Update constructor
- `libollmchat/Call/Embed.vala` - Update constructor
- `libollmchat/Call/Generate.vala` - Update constructor
- `libollmchat/Call/Models.vala` - Update constructor
- `libollmchat/Call/Ps.vala` - Update constructor
- `libollmchat/Call/Version.vala` - Update constructor
- `libollmchat/Call/ShowModel.vala` - Update constructor
- `libollmchat/Call/Pull.vala` - Update constructor

### Client
- `libollmchat/Client.vala` - Update convenience methods to pass `this.connection`

### Handlers/Agents
- `libollmchat/Prompt/AgentHandler.vala` - Update to pass `connection` instead of `client`
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Update to pass `connection` instead of `client`

### History/Session
- `libollmchat/History/Manager.vala` - Update to pass `connection` instead of `client`
- `libollmchat/History/Session.vala` - Update to pass `connection` instead of `client`

## Testing Checklist

- [ ] OllamaBase has `connection` property (not `client`)
- [ ] All Call.Base methods use `this.connection.*` instead of `this.client.connection.*`
- [ ] All Call constructors take `Connection` instead of `Client`
- [ ] All Call creation points updated to pass `connection`
- [ ] Client convenience methods pass `this.connection` to Call constructors
- [ ] Serialization excludes `connection` properly
- [ ] All HTTP requests still work correctly

## Related Plans

- [1.2.1. Remove Configuration from Client](./1.2.1-remove-config-from-client.md)
- [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md)

