# 1.2.3. Update Call.Base to Take Connection Directly

## Overview

Update `Call.Base` and all Call constructors to take `Connection` directly instead of `Client`. This simplifies the design since Client is just a thin wrapper around Connection.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md)

## Status

⏳ **TODO** - Refactoring needed.

## Goal

Make Call objects take `Connection` directly, eliminating the need to pass `Client` when `Client` only holds `connection`. Client remains as a convenience wrapper for simple API methods.

## Changes Required

### 1. Update OllamaBase


**Current**:
```vala
public class OllamaBase : Object, Json.Serializable
{
    public Client? client { get; protected set; }
    
    protected OllamaBase(Client? client = null)
    {
        this.client = client;
    }
}
```

**New**:
```vala
public class OllamaBase : Object, Json.Serializable
{
    public Settings.Connection? connection { get; protected set; }
    
    protected OllamaBase(Settings.Connection? connection = null)
    {
        this.connection = connection;
    }
}
```

**Impact**: All classes that inherit from `OllamaBase` will now have `connection` instead of `client`.

### 2. Update Call.Base

**Current**:
```vala
protected Base(Client client) 
{
    base(client);
}

protected string build_url()
{
    var base_url = this.client.connection.url;
    // ...
}

protected async Bytes send_request(bool needs_body) throws Error
{
    // Soup is initialized when Connection is created or added to base, never null
    this.client.soup.timeout = this.client.timeout;
    var message = this.client.connection.soup_message(this.http_method, url);
    // ...
}
```

**New**:
```vala
protected Base(Settings.Connection connection) 
{
    base(connection);
}

protected string build_url()
{
    var base_url = this.connection.url;
    // ...
}

protected async Bytes send_request(bool needs_body) throws Error
{
    // Soup is initialized when Connection is created or added to base, never null
    this.connection.soup.timeout = this.connection.timeout;
    var message = this.connection.soup_message(this.http_method, url);
    // ...
}
```

### 3. Update All Call Constructors

Update all Call class constructors to take `Connection` instead of `Client`:

- `Call.Chat(Connection connection, string model, Call.Options? options = null)`
- `Call.Embed(Connection connection, string model, Call.Options? options = null)`
- `Call.Generate(Connection connection, string model, ...)`
- `Call.Models(Connection connection)`
- `Call.Ps(Connection connection)`
- `Call.Version(Connection connection)`
- `Call.Show(Connection connection, string model_name)`
- `Call.Pull(Connection connection, string model_name)`

### 4. Update Client Convenience Methods

Client methods that create Call objects should pass `this.connection`:

**Current**:
```vala
public async Response.Chat chat(string text, GLib.Cancellable? cancellable = null) throws Error
{
    var call = new Call.Chat(this, this.model) {
        cancellable = cancellable
    };
    // ...
}
```

**New**:
```vala
public async Response.Chat chat(string text, string model, GLib.Cancellable? cancellable = null) throws Error
{
    var call = new Call.Chat(this.connection, model) {
        cancellable = cancellable
    };
    // ...
}
```

## Implementation Strategy

**⚠️ CRITICAL**: This refactoring must be done incrementally to keep the code usable after each step. See [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md) for the overall approach.

**Key Principle**: Add Connection support first, migrate call sites incrementally, remove Client support last.

## Implementation Steps

### Phase 1: Add Connection Support (Keep Client Support) ✅ DONE

#### Step 1.1: Update OllamaBase to Support Both ✅ DONE

**Goal**: Allow OllamaBase to accept either Client or Connection.

**Changes**:
1. Add `connection` property to `OllamaBase`
2. Keep `client` property for backward compatibility
3. Add named constructor: `OllamaBase.new_connection_refactor(Connection connection)` (Vala doesn't support overloaded constructors)
4. Keep existing constructor: `OllamaBase(Client client)` for backward compatibility
5. If constructed with Client, derive connection from `client.connection`
6. Update serialization to exclude both `connection` and `client` (same as before)

**Example**:
```vala
public class OllamaBase : Object, Json.Serializable
{
    public Client? client { get; protected set; }
    public Settings.Connection? connection { 
        get { 
            if (refactor_connection != null) return refactor_connection;
            if (client != null) return client.connection;
            return null;
        }
        protected set { refactor_connection = value; }
    }
    private Settings.Connection? refactor_connection = null;
    
    protected OllamaBase(Client? client = null)
    {
        this.client = client;
    }
    
    protected OllamaBase.new_connection_refactor(Settings.Connection? connection = null)
    {
        this.refactor_connection = connection;
    }
}
```

**Result**: Code still works, but OllamaBase can now take Connection directly

#### Step 1.2: Update Call.Base to Support Both ✅ DONE

**Goal**: Allow Call.Base to accept either Client or Connection.

**Changes**:
1. Add named constructor: `Base.new_connection_refactor(Connection connection)` (Vala doesn't support overloaded constructors)
2. Keep existing constructor: `Base(Client client)` for backward compatibility
3. Update `build_url()` to use `this.connection.url` (works with both)
4. Update `send_request()` to use `this.connection.soup` and `this.connection.timeout` (works with both)
   - **Note**: Soup should be initialized when Connection is created or added to base, never null - remove null checks
5. Update `handle_streaming_response()` to use `this.connection.soup` and `this.connection.timeout` (works with both)
   - **Note**: Soup should be initialized when Connection is created or added to base, never null - remove null checks

**Result**: Code still works, but Call.Base can now take Connection directly

#### Step 1.3: Update All Call Constructors to Support Both ✅ DONE

**Goal**: Allow Call constructors to accept either Client or Connection.

**For each Call class**:
1. Add named constructor: `Chat.new_connection_refactor(Connection connection, ...)` (Vala doesn't support overloaded constructors)
2. Keep existing constructor: `Chat(Client client, ...)` for backward compatibility
3. Update `base()` call to use appropriate constructor
4. Update methods to use `this.connection.*` (works with both)

**Example**:
```vala
public Chat(Client client, string model, Call.Options? options = null)
{
    base(client);
    // ... existing code ...
}

public Chat.new_connection_refactor(Connection connection, string model, Call.Options? options = null)
{
    base.new_connection_refactor(connection);
    // ... same code ...
}
```

**Result**: Code still works, but Call constructors can now take Connection directly

### Phase 2: Migrate Call Creation Points Incrementally ✅ DONE

#### Step 2.1: Migrate Client Convenience Methods ✅ DONE

**Goal**: Update Client methods to pass Connection to Call constructors.

**Changes**:
1. **Update `Client.chat()`**:
   - Change `new Call.Chat(this, ...)` to `new Call.Chat.new_connection_refactor(this.connection, ...)`

2. **Update `Client.embed()` and `Client.embed_array()`**:
   - Change `new Call.Embed(this, ...)` to `new Call.Embed.new_connection_refactor(this.connection, ...)`

3. **Update `Client.generate()`**:
   - Change `new Call.Generate(this, ...)` to `new Call.Generate.new_connection_refactor(this.connection, ...)`

4. **Update other Client methods**:
   - `models()`, `ps()`, `version()`, `show_model()`, etc.
   - Change to use `new_connection_refactor` constructors

**Result**: Client methods work, but now pass Connection to Call constructors

#### Step 2.2-N: Migrate All Call Creation Points ✅ DONE

**Goal**: Update each Call creation point to use Connection.

**Order** (from simplest to most complex):
1. `Client` convenience methods - Already done in Step 2.1
2. `Config2.create_chat()` - Update to use Connection
3. `Analysis` - Update to use Connection
4. `EmptySession.send_message()` - Update to use Connection
5. `SessionPlaceholder` - Update to use Connection
6. `Manager.new_client()` - Update to use Connection
7. `AgentHandler` - Update to use Connection
8. `CodeAssistantHandler` - Update to use Connection

**For each**:
- Update to use `new_connection_refactor` constructors
- Pass `connection` instead of `client`
- Test that it still works

**Result**: All call sites migrated, code still works

### Phase 3: Remove Client Support

#### Step 3.1: Remove Client Constructors from Call Classes

**Goal**: Call constructors only take Connection, not Client.

**Prerequisite**: All Call creation points must be migrated (Phase 2 complete)

**Changes**:
1. Remove `Chat(Client client, ...)` constructors
2. Rename `Chat.new_connection_refactor(...)` to `Chat(...)` (now the only constructor)
3. Repeat for all Call classes

**Result**: Call constructors are simpler, but OllamaBase still supports Client

#### Step 3.2: Remove Client Support from Call.Base

**Goal**: Call.Base only takes Connection, not Client.

**Prerequisite**: All Call constructors only take Connection (Step 3.1 complete)

**Changes**:
1. Remove `Base(Client client)` constructor
2. Rename `Base.new_connection_refactor(...)` to `Base(...)` (now the only constructor)
3. Update all methods to only use `this.connection.*`

**Result**: Call.Base is simpler, but OllamaBase still supports Client

#### Step 3.3: Remove Client Support from OllamaBase

**Goal**: OllamaBase only takes Connection, not Client.

**Prerequisite**: All Call.Base usage only uses Connection (Step 3.2 complete)

**Changes**:
1. Remove `client` property from `OllamaBase`
2. Remove `OllamaBase(Client client)` constructor
3. Rename `OllamaBase.new_connection_refactor(...)` to `OllamaBase(...)` (now the only constructor)
4. Update serialization to only exclude `connection`

**Result**: OllamaBase is simpler, code still works (all Calls use Connection)

## Files to Modify

### Core Classes
- `libollmchat/OllamaBase.vala` - Change `client` to `connection`
- `libollmchat/Call/Base.vala` - Update to use `connection`
- `libollmchat/Call/Chat.vala` - Update constructor
- `libollmchat/Call/Embed.vala` - Update constructor
- `libollmchat/Call/Generate.vala` - Update constructor
- `libollmchat/Call/Models.vala` - Update constructor
- `libollmchat/Call/Ps.vala` - Update constructor
- `libollmchat/Call/Version.vala` - Update constructor
- `libollmchat/Call/ShowModel.vala` - Update constructor
- `libollmchat/Call/Pull.vala` - Update constructor

### Client
- `libollmchat/Client.vala` - Update convenience methods to pass `this.connection`

### Handlers/Agents
- `libollmchat/Prompt/AgentHandler.vala` - Update to pass `connection` instead of `client`
- `liboccoder/Prompt/CodeAssistantHandler.vala` - Update to pass `connection` instead of `client`

### History/Session
- `libollmchat/History/Manager.vala` - Update to pass `connection` instead of `client`
- `libollmchat/History/Session.vala` - Update to pass `connection` instead of `client`

## Testing Checklist

- [ ] OllamaBase has `connection` property (not `client`)
- [ ] All Call.Base methods use `this.connection.*` instead of `this.client.connection.*`
- [ ] All Call constructors take `Connection` instead of `Client`
- [ ] All Call creation points updated to pass `connection`
- [ ] Client convenience methods pass `this.connection` to Call constructors
- [ ] Serialization excludes `connection` properly
- [ ] All HTTP requests still work correctly

## Related Plans

- [1.2.1. Remove Configuration from Client](./1.2.1-remove-config-from-client.md)
- [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md)

