# 1.2.7.11. Move Model Storage from Client to Connection

## Overview

Move all model storage and loading from `Client` to `Connection`. Client methods should just execute API calls and return results - they should not store any state. Connection should own and manage the `models` cache.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md)

## Status

âœ… **DONE** - Model storage successfully moved from Client to Connection. Client methods now just execute API calls and return results without storing state.

## Goal

Refactor so that:
- **Client methods** just do as told - execute API calls and return results, no storage
- **Connection** owns `models` cache and provides `load_models()` method to populate it
- Remove all storage properties from Client (`models`, `session`, `timeout`)

## Architectural Principles

1. **Client methods should just do as told, nothing more** - They execute API calls and return results, but don't store state
2. **Connection owns connection-specific data** - Model lists are connection-specific, so Connection should own the cache
3. **No storage in Client** - Client is a thin convenience wrapper, not a state container

## Current State

Currently, `Client` stores:
- `available_models` (HashMap<string, Response.Model>) - Model cache populated by `fetch_all_model_details()` and `models()` (will be renamed to `models` in Connection)
- `session` (Soup.Session?) - HTTP session (duplicate of Connection.soup)
- `timeout` (uint) - HTTP timeout (duplicate of Connection.timeout)

Client methods that currently store state:
- `models()` - Populates `client.available_models` while returning list
- `show_model()` - Stores/updates model in `client.available_models`
- `fetch_all_model_details()` - Populates `client.available_models` with all model details (will be removed entirely)

**Current Usage**:
- `libollmchat/Settings/ConnectionModels.vala` line 117-128:
```vala
var client = new OLLMchat.Client(connection);
yield client.fetch_all_model_details();
foreach (var model in client.available_models.values) {
    // Process models
}
```

- `libollmchat/Settings/ModelUsage.vala` line 92-95:
```vala
var client = new OLLMchat.Client(connection_obj);
yield client.models();
this.is_valid = client.available_models.has_key(this.model);
```

**After refactoring**:
- `libollmchat/Settings/ConnectionModels.vala`:
```vala
yield connection.load_models();
foreach (var model in connection.models.values) {
    // Process models
}
```

- `libollmchat/Settings/ModelUsage.vala`:
```vala
yield connection.load_models();
this.is_valid = connection.models.has_key(this.model);
```

## Proposed Implementation

### 1. Add to Connection (`libollmchat/Settings/Connection.vala`)

Add `models` property:
```vala
/**
 * Models loaded from the server, keyed by model name.
 *
 * This map is populated by calling load_models().
 * Non-serialized property (runtime cache, not saved to config).
 *
 * @since 1.2.7.11
 */
public Gee.HashMap<string, Response.Model> models { get; private set; 
    default = new Gee.HashMap<string, Response.Model>(); }
```

Add `load_models()` method:
```vala
/**
 * Loads all available models from the server and stores them in models.
 *
 * Fetches the list of models, then gets detailed information for each model
 * including capabilities. Results are stored in models HashMap.
 *
 * @since 1.2.7.11
 */
public async void load_models() throws Error
{
    // Implementation: call models() API, then show_model() for each
    // Store results in this.models
}
```

Update `serialize_property()` to exclude `models` from serialization (runtime cache).

### 2. Remove from Client (`libollmchat/Client.vala`)

Remove storage properties:
- Remove `available_models` property (lines 108-109)
- Remove `session` property (line 99) - Connection already has `soup`
- Remove `timeout` property (lines 88) - Connection already has `timeout`

Update methods to NOT store state:
- `models()` - Remove lines 184-189 that populate `available_models`. Just return the list.
- `show_model()` - Remove lines 249-258 that check/store in `available_models`. Just fetch and return the model.
- `fetch_all_model_details()` - Remove entirely (lines 287-305). Functionality replaced by `Connection.load_models()`

### 3. Update ConnectionModels (`libollmchat/Settings/ConnectionModels.vala`)

Update `refresh_connection()` method (lines 115-150):
- Change from: `yield client.fetch_all_model_details();`
- Change to: `yield connection.load_models();`
- Change from: `foreach (var model in client.available_models.values)`
- Change to: `foreach (var model in connection.models.values)`
- Remove temporary Client creation (line 117)

### 4. Update ModelUsage (`libollmchat/Settings/ModelUsage.vala`)

Update `verify_model()` method (lines 78-101):
- Change from: `yield client.models();` then check `client.available_models`
- Change to: `yield connection.load_models();` then check `connection.models`
- Remove temporary Client creation (line 92)

## Files Affected

### `libollmchat/Settings/Connection.vala`
**What it does**: 
- Adds `models` property to store model cache
- Adds `load_models()` async method that fetches all models and stores them in `models`
- Updates serialization to exclude `models` (runtime cache)

### `libollmchat/Client.vala`
**What it does**:
- Removes `available_models` property (no storage)
- Removes `session` property (use `connection.soup` instead)
- Removes `timeout` property (use `connection.timeout` instead)
- Updates `models()` to just return list, don't populate storage
- Updates `show_model()` to just return model, don't store in cache
- Removes `fetch_all_model_details()` method entirely (functionality replaced by `Connection.load_models()`)

### `libollmchat/Settings/ConnectionModels.vala`
**What it does**:
- Updates `refresh_connection()` to call `connection.load_models()` instead of creating Client
- Updates to access `connection.models` instead of `client.available_models`
- Removes dependency on Client for model loading

### `libollmchat/Settings/ModelUsage.vala`
**What it does**:
- Updates `verify_model()` to call `connection.load_models()` instead of creating Client
- Updates to check `connection.models` instead of `client.available_models`
- Removes dependency on Client for model verification

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md) - Parent plan
- [1.2.7.7. Remove Client from Session](./1.2.7.7-DONE-remove-client-from-session.md) - Related: removing Client references
- [1.2. Refactor Client and Chat Relationship](./1.2-DONE-refactor-client-chat-relationship.md) - Grandparent plan (mentions moving models to Connection)

