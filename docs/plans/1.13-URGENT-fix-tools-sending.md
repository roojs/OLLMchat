# 1.13. DONE - Fix Tools Listing and Tools Being Sent to Client

## Overview

Fixed an issue where tools were not being properly listed and sent to the client. The fix involved changing how we check if a model supports tools, and ensuring tools are properly initialized when created.

## Status

✅ **DONE** - Fixed in commit `9caccf34` and successfully re-applied in plan 1.13.1

✅ **RE-APPLIED** - All changes have been successfully re-applied to the Phase 3 codebase structure. See plan 1.13.1 for details of the re-application.

## Problem

The previous implementation had two issues:

1. **Model capability checking**: The code was using `client.available_models.has_key(model)` to check if a model supports tools, which was unreliable because:
   - The model might not be in `available_models` yet
   - It didn't properly check the model's capabilities across different connections

2. **Tool initialization**: Tools created via `Object.new()` with named parameters might not have their constructors called, leading to uninitialized tools that couldn't be properly serialized or used.

## Solution

### 1. Changed Model Capability Checking

**File**: `libollmchat/Call/Chat.vala`

Changed from:
```vala
if (!this.client.available_models.has_key(this.model) 
    || !this.client.available_models.get(this.model).can_call) {
    return null;
}
```

To:
```vala
// Use ConnectionModels to look up model info (via client.connection_models)
bool model_supports_tools = true;

var model_usage = this.client.connection_models.find_model(
        this.client.connection.url, this.model);

model_supports_tools = model_usage.model_obj.can_call;

// Only exclude tools if we know the model explicitly doesn't support them
if (!model_supports_tools) {
    return null;
}
```

This uses `ConnectionModels.find_model()` which properly looks up model information across connections and checks the `can_call` capability.

### 2. Added Tool Initialization Method

**File**: `libollmchat/Tool/Tool.vala`

Added a new `init()` method that:
- Creates the function instance
- Parses parameter descriptions
- Ensures tools are properly initialized even when created via `Object.new()`

The `init()` method is called:
- In the constructor (for normal instantiation)
- After `Object.new()` calls (for tools created with named parameters)

### 3. Added ConnectionModels Property to Client

**File**: `libollmchat/Client.vala`

Added:
```vala
/**
 * Optional ConnectionModels instance for looking up model information.
 * Set by Manager when creating clients. Temporary solution until Client is removed.
 */
public Settings.ConnectionModels? connection_models { get; set; default = null; }
```

### 4. Set ConnectionModels in Manager

**File**: `libollmchat/History/Manager.vala`

Added code to set `connection_models` on clients:
- When creating `base_client`: `this.base_client.connection_models = this.connection_models;`
- When creating new clients: `client.connection_models = this.connection_models;`

## Files Modified

### Commit 9caccf34 (Tools Fix)
1. `libollmchat/Call/Chat.vala` - Changed model capability checking
2. `libollmchat/Tool/Tool.vala` - Added `init()` method and ensured initialization
3. `libollmchat/Client.vala` - Added `connection_models` property
4. `libollmchat/History/Manager.vala` - Set `connection_models` on clients

### Commit bc973f89 (Google Search Permission Fix)
5. `liboctools/GoogleSearchRequest.vala` - Removed permission check (changed to return false)
6. `liboctools/WebFetchTool.vala` - Fixed typo in description ("are" -> "and")

### Commit fd596313 (Test CLI Changes)
7. `examples/oc-test-cli.vala` - Added `--stats` and `--list-models` options, added `connection_models` setup

## Revert Instructions

⚠️ **IMPORTANT**: These changes need to be reverted before merging the conflicting branch. 

**Note**: Only revert the files listed below. The commits also include:
- A new model file (`docs/Modelfiles/roojs-minimax-m2:q2_k -f`) - **KEEP THIS**
- Documentation updates - **KEEP THESE**
- Removal of old tool files - **KEEP THESE CHANGES**
- Test files (`docs/tools/perf_test.php`) - **KEEP THIS**
- Plan documents (`docs/plans/*.md`) - **KEEP THESE**

Follow these steps to revert only the code-related changes:

### Step 1: Revert libollmchat/Call/Chat.vala

In the `serialize_property` method, case "tools", replace:

```vala
// Use ConnectionModels to look up model info (via client.connection_models)
bool model_supports_tools = true;

var model_usage = this.client.connection_models.find_model(
        this.client.connection.url, this.model);

model_supports_tools = model_usage.model_obj.can_call;

// Only exclude tools if we know the model explicitly doesn't support them
if (!model_supports_tools) {
    return null;
}
```

With:

```vala
if (!this.client.available_models.has_key(this.model) 
    || !this.client.available_models.get(this.model).can_call) {
    return null;
}
```

### Step 2: Revert libollmchat/Tool/Tool.vala

1. **Remove the `init()` method** (lines ~75-162 in the fixed version):
   - Remove the `private bool initialized = false;` field
   - Remove the entire `protected void init()` method
   - Remove all calls to `tool.init()` after `Object.new()` calls

2. **Restore the original constructor**:
   - Move the initialization code back into the constructor
   - The constructor should directly create `this.function = new Function(this);` and parse parameter descriptions

3. **Remove `init()` calls**:
   - In `setup_all_tool_configs()`: Remove `tool.init();` after `Object.new()`
   - In `register_all_tool_configs()`: Remove `tool.init();` after `Object.new()`
   - In `register_all_tools()`: Remove `tool.init();` after `Object.new()`

### Step 3: Revert libollmchat/Client.vala

Remove the `connection_models` property:

```vala
/**
 * Optional ConnectionModels instance for looking up model information.
 * Set by Manager when creating clients. Temporary solution until Client is removed.
 */
public Settings.ConnectionModels? connection_models { get; set; default = null; }
```

### Step 4: Revert libollmchat/History/Manager.vala

Remove the two lines that set `connection_models`:

1. In the constructor (after creating `base_client`):
   - Remove: `this.base_client.connection_models = this.connection_models;`

2. In `new_client()` method (after setting available_models):
   - Remove: `client.connection_models = this.connection_models;`

### Step 5: Revert Google Search Permission Fix (Commit bc973f89)

Revert the Google search permission changes:

```bash
# Revert GoogleSearchRequest.vala
git show bc973f89^:liboctools/GoogleSearchRequest.vala > liboctools/GoogleSearchRequest.vala

# Revert WebFetchTool.vala
git show bc973f89^:liboctools/WebFetchTool.vala > liboctools/WebFetchTool.vala
```

**Changes being reverted:**
- `GoogleSearchRequest.vala`: Restore permission check code (set permission properties and return true)
- `WebFetchTool.vala`: Fix typo in description back to "and" (from "are")

### Step 6: Revert Test CLI Changes (Commit fd596313)

Revert the test CLI changes:

```bash
# Revert oc-test-cli.vala
git show fd596313^:examples/oc-test-cli.vala > examples/oc-test-cli.vala
```

**Changes being reverted:**
- Remove `--stats` and `--list-models` command line options
- Remove `connection_models` setup code
- Remove `connection.is_working = true;` assignment

### Step 7: Verify Revert

After reverting, verify:
- Tools are still being serialized correctly
- Model capability checking works (may need to ensure models are in `available_models` first)
- Tools are properly initialized when created
- Google search permission check is restored
- Test CLI no longer has the new options

### Git Revert Command (Alternative - Partial Revert)

⚠️ **DO NOT** use `git revert 9caccf34` as it will revert the entire commit, including the new model file (`docs/Modelfiles/roojs-minimax-m2:q2_k -f`) and other changes we want to keep.

To revert all the relevant files using `git show`:
```bash
# Revert tools fix files (commit 9caccf34)
git show 9caccf34^:libollmchat/Call/Chat.vala > libollmchat/Call/Chat.vala
git show 9caccf34^:libollmchat/Tool/Tool.vala > libollmchat/Tool/Tool.vala
git show 9caccf34^:libollmchat/Client.vala > libollmchat/Client.vala
git show 9caccf34^:libollmchat/History/Manager.vala > libollmchat/History/Manager.vala

# Revert Google search permission fix (commit bc973f89)
git show bc973f89^:liboctools/GoogleSearchRequest.vala > liboctools/GoogleSearchRequest.vala
git show bc973f89^:liboctools/WebFetchTool.vala > liboctools/WebFetchTool.vala

# Revert test CLI changes (commit fd596313)
git show fd596313^:examples/oc-test-cli.vala > examples/oc-test-cli.vala

# Review the changes
git diff

# Stage and commit the partial revert
git add libollmchat/Call/Chat.vala libollmchat/Tool/Tool.vala libollmchat/Client.vala libollmchat/History/Manager.vala liboctools/GoogleSearchRequest.vala liboctools/WebFetchTool.vala examples/oc-test-cli.vala
git commit -m "Revert tools fix, google search, and test CLI changes (keep model file, docs, and other changes)"
```

**Note**: The manual revert steps above are recommended as they give you full control and allow you to verify each change. The `git show` method writes directly to files and requires manual staging, which allows you to review changes before committing.

## Related Issues

- Tools were not being sent to the LLM API when they should have been
- Tools were not being properly initialized when created via `Object.new()`
- Model capability checking was unreliable

## Notes

- The `connection_models` property was marked as a "temporary solution until Client is removed"
- The `init()` method pattern ensures tools work correctly with Vala's `Object.new()` API
- The fix ensures tools are only sent to models that explicitly support them (via `can_call` check)

## Re-Application After Merge

⚠️ **IMPORTANT**: After successfully merging the conflicting branch, these fixes need to be re-applied to the new codebase:

1. **Review the new codebase structure** - The conflicting branch may have changed how model capability checking works, how tools are initialized, or how clients are created.

2. **Re-apply the fixes** - Adapt the solutions described in this document to work with the new code structure:
   - Model capability checking may need to use a different approach if `available_models` or `connection_models` have changed
   - Tool initialization may need to be adapted if the tool creation pattern has changed
   - Google search permission handling may need adjustment if permission system has changed
   - Test CLI changes may need to be re-implemented if CLI structure has changed

3. **Test thoroughly** - Ensure that:
   - Tools are properly listed and sent to the client
   - Tools are correctly initialized when created
   - Model capability checking works reliably
   - Google search permission checks work correctly
   - Test CLI functions as expected

4. **Update this plan** - Once re-applied, update this document to reflect the new implementation details and mark as complete.
