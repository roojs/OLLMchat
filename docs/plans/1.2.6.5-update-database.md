# 1.2.6.5. Update Database

## Overview

Update Database to take `Connection` and `model` instead of `Client`.

**Parent Plan**: [1.2.6. Update Legacy Methods](./1.2.6-update-legacy-methods.md)

**Prerequisite**: [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) must be complete

## Status

‚è≥ **TODO** - Needs implementation.

## Goal

Database should not depend on `Client` with config. According to plan 1.2, Manager owns the config, not Client.

## Current Implementation

**File**: `libocvector/Database.vala` (lines 84, 167, 184, 200)

```vala
public Database(OLLMchat.Client ollama, string filename, uint64 dimension)
{
    this.ollama = ollama;
    // ...
}

public static async uint64 get_embedding_dimension(OLLMchat.Client ollama) throws GLib.Error
{
    var test_response = yield ollama.embed("test");
    // ...
}

// Multiple places using this.ollama.embed():
var first_response = yield this.ollama.embed(texts[0]);
var response = yield this.ollama.embed(texts[i]);
var response = yield this.ollama.embed(query);
```

**Problem**: Database takes `Client` but should take `Connection` and model.

## Proposed Fix

```vala
private Settings.Connection connection;
private string model;

public Database(Settings.Connection connection, string model, string filename, uint64 dimension)
{
    this.connection = connection;
    this.model = model;
    this.filename = filename;
    
    // Create Index immediately with the provided dimension
    this.index = new Index(this.filename, dimension);
}

public static async uint64 get_embedding_dimension(Settings.Connection connection, string model) throws GLib.Error
{
    var client = new Client(connection);
    var test_response = yield client.embed(model, "test");
    if (test_response == null || test_response.embeddings.size == 0) {
        throw new GLib.IOError.FAILED("Failed to get test embedding to determine dimension");
    }
    
    return (uint64)test_response.embeddings[0].size;
}

// In methods using embed():
var client = new Client(this.connection);
var first_response = yield client.embed(this.model, texts[0]);
// ... etc
```

## Implementation Steps

1. Update `Database` constructor to take `Connection` and `model`
2. Update `get_embedding_dimension()` static method to take `Connection` and `model`
3. Update all internal `embed()` calls to create Client from Connection
4. Find all call sites of Database constructor and `get_embedding_dimension()` and update them
5. Test that database operations still work

## Test

Verify database operations still work:
- Getting embedding dimension
- Adding vectors
- Querying vectors

## Result

Database uses model parameter explicitly and no longer depends on Client with config.

## Files to Modify

- `libocvector/Database.vala` - Update constructor, static method, and all embed() calls
- Find and update all Database constructor and `get_embedding_dimension()` call sites

## Related Plans

- [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) - Prerequisite

