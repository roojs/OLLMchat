# 1.2.7.9. Move Permission Provider to Agent

## Overview

Move `permission_provider` from `Chat` to `Manager`. Since the permission provider never changes and is shared across all sessions, it should be stored on `Manager`. Tools access it via `agent.session.manager.permission_provider` - agent is never null, so no null checks needed.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md)

## Status

âœ… **DONE** - Permission provider moved from Chat to Manager. All tools access it via `agent.session.manager.permission_provider`.

## Goal

Move `permission_provider` property from `Call.Chat` to `Manager`, and update all tool code to access it via `agent.session.manager.permission_provider` instead of `chat_call.permission_provider`.

## Current State

- `permission_provider` is currently on `Call.Chat` (line 82 in `Chat.vala`)
- `SessionBase` has `permission_provider` property and sets `agent.chat.permission_provider` when its own `permission_provider` is set (line 51 in `SessionBase.vala`)
- Window sets `history_manager.session.permission_provider` (line 458 in `Window.vala`)
- Tools access it via `this.chat_call.permission_provider`

## Implementation Steps

### Step 9.1: Add Permission Provider to Manager

**Goal**: Add `permission_provider` property to `Manager`.

**Changes**:
1. Add to `libollmchat/History/Manager.vala`:
   ```vala
   /**
    * Permission provider for tool execution.
    *
    * Handles permission requests when tools need to access files or execute commands.
    * Set by Window when creating the manager. Shared across all sessions.
    *
    * @since 1.2.7.9
    */
   public OLLMchat.ChatPermission.Provider permission_provider { get; set; default = new OLLMchat.ChatPermission.Dummy(); }
   ```

**Result**: Manager has permission_provider property (defaults to Dummy provider)

### Step 9.2: Update Window to Set Permission Provider on Manager

**Goal**: Update Window to set permission provider on Manager instead of Session.

**Current Flow**:
- Window sets `history_manager.session.permission_provider` (line 458 in `Window.vala`)
- SessionBase setter currently sets `this.agent.chat.permission_provider` (line 50 in `SessionBase.vala`)

**Changes**:
1. Update `ollmapp/Window.vala`:
   - Change: `this.history_manager.session.permission_provider = permission_provider;`
   - To: `this.history_manager.permission_provider = permission_provider;`

2. Remove `permission_provider` property from `libollmchat/History/SessionBase.vala`:
   - Remove the property declaration and setter
   - Remove initialization in constructor

**Note**: 
- Permission provider is set once on Manager and never changes
- Tools access it via `agent.session.manager.permission_provider` - no copying needed
- **Important**: The permission provider is project-agnostic. Tools handle project-aware logic themselves:
  - Tools check if files are in the active project via `tool.project_manager.get_file_from_active_project()`
  - Files in the active project are auto-approved (skip permission check)
  - Only files outside the active project call the permission provider
  - This separation keeps the permission provider simple and reusable

**Result**: Permission provider is on Manager, accessed via agent.session.manager chain

### Step 9.3: Update Tools to Access Permission Provider via Agent Chain

**Goal**: Update all tool code to access permission provider via `agent.session.manager.permission_provider` instead of `chat_call.permission_provider`.

**Note**: This step is mostly covered by plan 1.2.7.4 which removes `chat_call` property and makes tools use `agent.chat`. Tools will already be accessing everything via agent, so permission provider access will be updated as part of that migration.

**Important**: The permission provider doesn't know about active projects. Tools handle project-aware logic:
- Tools check `tool.project_manager.get_file_from_active_project()` before calling permission provider
- Files in active project are auto-approved (return false from `build_perm_question()`)
- Only non-project files call `permission_provider.request()` or `check_permission()`

**Files to modify**:
- `libollmchat/Tool/RequestBase.vala` - Update `normalize_file_path()` and `execute()` methods
- `libollmchat/Tools/RequestRunCommand.vala` - Update permission provider access
- `libollmchat/Tools/RequestEditMode.vala` - Update permission provider access

**Changes**:
1. In `RequestBase.normalize_file_path()`:
   ```vala
   // Change from:
   var permission_provider = this.chat_call.permission_provider;
   // To:
   var permission_provider = this.agent.session.manager.permission_provider;
   // No null checks - agent is never null, session is never null, manager is never null
   ```

2. In `RequestBase.execute()`:
   ```vala
   // Change from:
   var permission_provider = this.chat_call.permission_provider;
   // To:
   var permission_provider = this.agent.session.manager.permission_provider;
   // No null checks - agent is never null, session is never null, manager is never null
   ```

3. In `RequestRunCommand.execute()`:
   ```vala
   // Change from:
   if (this.chat_call.permission_provider == null) {
   // To:
   // No null check needed - permission_provider always exists on Manager (defaults to Dummy)
   ```

4. In `RequestEditMode` (wherever permission_provider is accessed):
   ```vala
   // Change from:
   this.chat_call.permission_provider
   // To:
   this.agent.session.manager.permission_provider
   // No null checks - chain is absolute
   ```

**Result**: All tools access permission provider via `agent.session.manager.permission_provider` chain (no null checks needed)

### Step 9.4: Remove Permission Provider from Chat

**Goal**: Remove `permission_provider` property from `Call.Chat` since it's now on Manager.

**Changes**:
1. In `libollmchat/Call/Chat.vala`:
   - Remove `permission_provider` property declaration (line 82)
   - Remove any code that sets or uses `this.permission_provider`

2. Update any remaining references to `chat.permission_provider` to use `agent.session.manager.permission_provider` instead

**Result**: Permission provider is only on Manager, accessed via agent.session.manager chain, not Chat

## Files to Modify

- `libollmchat/History/Manager.vala` - Add `permission_provider` property
- `libollmchat/History/SessionBase.vala` - Remove `permission_provider` property
- `ollmapp/Window.vala` - Set permission provider on Manager instead of Session
- `libollmchat/Tool/RequestBase.vala` - Access permission provider via `agent.session.manager.permission_provider`
- `libollmchat/Tools/RequestRunCommand.vala` - Access permission provider via `agent.session.manager.permission_provider`
- `libollmchat/Tools/RequestEditMode.vala` - Access permission provider via `agent.session.manager.permission_provider`
- `libollmchat/Call/Chat.vala` - Remove `permission_provider` property

## Testing Checklist

- [ ] `Manager` has `permission_provider` property (defaults to Dummy provider)
- [ ] `SessionBase` no longer has `permission_provider` property
- [ ] Window sets permission provider on Manager
- [ ] Tools access permission provider via `agent.session.manager.permission_provider` (no null checks)
- [ ] Permission requests still work correctly
- [ ] Permission checks still work correctly
- [ ] File path normalization still works correctly
- [ ] `Chat` no longer has `permission_provider` property
- [ ] All tool execution flows work correctly with manager-based permission provider accessed via agent chain

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md) - Parent plan
- [1.2.7.4. Migrate Tool Signal Connections to Direct Method Calls](./1.2.7.4-DONE-migrate-non-agent-signals.md) - Adds agent property to tools
- [1.2. Refactor Client and Chat Relationship](./1.2-DONE-refactor-client-chat-relationship.md) - Grandparent plan

