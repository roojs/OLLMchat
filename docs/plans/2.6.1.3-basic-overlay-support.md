# 2.6.1.3. Basic Overlay Support (String Copying)

## Overview

Implement overlay filesystem support to isolate writes during command execution. Files are copied from overlay to live system using simple string/file copying based on Monitor information.

## Status

â³ **PLANNING** - Design phase.

## Prerequisites

- Phase 1 (2.6.1.1) must be completed
- Phase 2 (2.6.1.2) must be completed
- See main plan: `2.6.1-code-exec-improvements.md` for overlay architecture details

## Goals

1. Create `Overlay` class for overlay filesystem management
2. Implement overlay creation and mounting
3. Integrate Monitor with overlay upper directory
4. Copy files from overlay to live system after execution (string copying)

## Implementation Details

### Files to Create

- `liboctools/RunCommand/Overlay.vala` - Overlay filesystem creation and management

### Files to Modify

- `liboctools/RunCommand/Request.vala` - Integrate Overlay class

### Overlay Class Design

- **Constructor**: Accept project folder and list of project root folders
- **Method**: `create()` - Create overlay directory structure with subdirectories for each root
- **Method**: `mount()` - Mount overlay filesystem
- **Method**: `unmount()` - Unmount overlay filesystem
- **Method**: `get_mount_point()` - Get overlay mount point path
- **Method**: `get_base_path()` - Get overlay upper directory path (for Monitor)
- **Method**: `get_overlay_map()` - Get HashMap mapping overlay subdirectory names to real paths
- **Method**: `cleanup()` - Clean up overlay directory

### Overlay Structure

- Create overlay temporary directory in `.cache/ollmchat/{overlay-datetime}/`
- Overlay structure (required by overlayfs):
  - Lower directory: Original project directory (read-only)
  - Upper directory: `.cache/ollmchat/{overlay-datetime}/upper/` (writable layer)
    - **Multiple folder structure**: Upper directory contains subdirectories for each project root:
      - `upper/overlay1/` - Writes for first project root
      - `upper/overlay2/` - Writes for second project root
      - `upper/overlay3/` - Writes for third project root
      - etc.
    - Each subdirectory name (overlay1, overlay2, etc.) maps to a project root path via `overlay_map`
  - Work directory: `.cache/ollmchat/{overlay-datetime}/work/` (required by overlayfs for internal atomic operations)
- Mount overlay filesystem (using `mount -t overlay`) before bwrap execution
- Bind-mount the overlay mount point into bwrap sandbox at project directory location
- **Overlay map**: HashMap mapping subdirectory names to real project paths:
  - `"overlay1" -> "/home/alan/project"`
  - `"overlay2" -> "/home/alan/other-project"`
  - Created from project root folders (from `project.build_roots()`)
  - Each project root gets a unique subdirectory name (overlay1, overlay2, etc.)
  - Used by Monitor to convert overlay paths to real paths
  - Example: File written to `upper/overlay1/src/main.c` maps to `/home/alan/project/src/main.c`

### Integration with Monitor

- Monitor overlay upper directory using Monitor class from Phase 2
- Pass `base_path` (upper directory path) and `overlay_map` to Monitor constructor
- Monitor converts overlay paths (e.g., `upper/overlay1/src/file.c`) to real paths (e.g., `/home/alan/project/src/file.c`)
- After execution: Use Monitor change lists to copy files from overlay to live system
  - For modified files: Copy from overlay upper directory (e.g., `upper/overlay1/path/to/file`) to project directory (e.g., `/home/alan/project/path/to/file`)
  - For new files: Copy from overlay upper directory to project directory
  - For deleted files: Remove from project directory
- After copying files: Check permissions on all files in Monitor change lists (added, updated, removed)
  - Compare permissions between overlay files and real project files
  - If permissions differ (e.g., chmod +x), copy permissions from overlay to real files
  - **Note**: Permission changes are NOT added to Monitor change lists (not tracked as modifications)
  - **Note**: Permission changes are NOT approved (permissions are copied silently)

### File Copying

- Use simple file copying (read file content, write to destination)
- Handle directory creation if needed (for new files in new directories)
- No backup support yet - that comes in Phase 5

## Implementation Tasks

- [ ] Create `Overlay` class for overlay filesystem management
- [ ] Implement overlay creation in `.cache/ollmchat/{overlay-datetime}/`
- [ ] Implement overlay structure (lower, upper, work directories)
- [ ] Create subdirectories in upper directory for each project root (overlay1, overlay2, etc.)
- [ ] Build overlay_map HashMap mapping subdirectory names to real project paths
- [ ] Mount overlay filesystem (using `mount -t overlay`) before bwrap execution
- [ ] Bind-mount the overlay mount point into bwrap sandbox at project directory location
- [ ] Integrate Monitor with overlay upper directory (pass base_path and overlay_map)
- [ ] After execution: Use Monitor info to copy files from overlay to live system
  - [ ] For modified files: Copy from overlay upper directory to project directory (string copying)
  - [ ] For new files: Copy from overlay upper directory to project directory
  - [ ] For deleted files: Remove from project directory
- [ ] After copying files: Check and copy permissions from overlay to real files
  - [ ] Compare permissions between overlay files and real project files for all files in Monitor change lists
  - [ ] If permissions differ, copy permissions from overlay to real files (e.g., chmod +x)
  - [ ] Do NOT add permission changes to Monitor change lists
  - [ ] Do NOT require approval for permission changes
- [ ] Test overlay filesystem creation and cleanup
- [ ] Test file copying from overlay to live system

## Testing

- Test overlay filesystem creation and cleanup
- Test file copying from overlay to live system
- Test with modified files
- Test with new files
- Test with deleted files
- Test with nested directories

## Notes

- This phase uses simple string/file copying - no backup support yet
- Backup support will be added in Phase 5
- Overlay will be integrated with Bwrap in Phase 4

