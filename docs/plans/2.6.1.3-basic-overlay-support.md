# 2.6.1.3. Basic Overlay Support (String Copying)

## Overview

Implement overlay filesystem support to isolate writes during command execution. Files are copied from overlay to live system using simple string/file copying based on Monitor information.

## Status

‚è≥ **PLANNING** - Design phase.

## Prerequisites

- Phase 1 (2.6.1.1) must be completed
- Phase 2 (2.6.1.2) must be completed
- See main plan: `2.6.1-code-exec-improvements.md` for overlay architecture details

## Goals

1. Create `Overlay` class for overlay filesystem management
2. Implement overlay creation and mounting
3. Integrate Monitor with overlay upper directory
4. Copy files from overlay to live system after execution (string copying)

## Implementation Details

### Files to Create

- `liboctools/RunCommand/Overlay.vala` - Overlay filesystem creation and management

### Files to Modify

- `liboctools/RunCommand/Request.vala` - Integrate Overlay class

### Overlay Class Design

- **Constructor**: Accept project directory path
- **Method**: `create()` - Create overlay directory structure
- **Method**: `mount()` - Mount overlay filesystem
- **Method**: `unmount()` - Unmount overlay filesystem
- **Method**: `get_mount_point()` - Get overlay mount point path
- **Method**: `cleanup()` - Clean up overlay directory

### Overlay Structure

- Create overlay temporary directory in `.cache/ollmchat/{overlay-datetime}/`
- Overlay structure (required by overlayfs):
  - Lower directory: Original project directory (read-only)
  - Upper directory: `.cache/ollmchat/{overlay-datetime}/upper/` (writable layer)
  - Work directory: `.cache/ollmchat/{overlay-datetime}/work/` (required by overlayfs for internal atomic operations)
- Mount overlay filesystem (using `mount -t overlay`) before bwrap execution
- Bind-mount the overlay mount point into bwrap sandbox at project directory location

### Integration with Monitor

- Monitor overlay upper directory using Monitor class from Phase 2
- After execution: Use Monitor change lists to copy files from overlay to live system
  - For modified files: Copy from overlay upper directory to project directory (string copying)
  - For new files: Copy from overlay upper directory to project directory
  - For deleted files: Remove from project directory

### File Copying

- Use simple file copying (read file content, write to destination)
- Handle directory creation if needed (for new files in new directories)
- No backup support yet - that comes in Phase 5

## Implementation Tasks

- [ ] Create `Overlay` class for overlay filesystem management
- [ ] Implement overlay creation in `.cache/ollmchat/{overlay-datetime}/`
- [ ] Implement overlay structure (lower, upper, work directories)
- [ ] Mount overlay filesystem (using `mount -t overlay`) before bwrap execution
- [ ] Bind-mount the overlay mount point into bwrap sandbox at project directory location
- [ ] Integrate Monitor with overlay upper directory
- [ ] After execution: Use Monitor info to copy files from overlay to live system
  - [ ] For modified files: Copy from overlay upper directory to project directory (string copying)
  - [ ] For new files: Copy from overlay upper directory to project directory
  - [ ] For deleted files: Remove from project directory
- [ ] Test overlay filesystem creation and cleanup
- [ ] Test file copying from overlay to live system

## Testing

- Test overlay filesystem creation and cleanup
- Test file copying from overlay to live system
- Test with modified files
- Test with new files
- Test with deleted files
- Test with nested directories

## Notes

- This phase uses simple string/file copying - no backup support yet
- Backup support will be added in Phase 5
- Overlay will be integrated with Bwrap in Phase 4

