# 1.2.7.9. Move Permission Provider to Agent

## Overview

Move `permission_provider` from `Chat` to `AgentHandler`. Since tools have an `agent` property and all communication from tools to UI goes through the agent, permission provider should also be accessed via the agent. This allows the agent to intercept and override permission handling if needed.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md)

## Status

‚è≥ **TODO** - Move permission provider from Chat to AgentHandler.

## Goal

Move `permission_provider` property from `Call.Chat` to `Prompt.AgentHandler`, and update all tool code to access it via `agent.permission_provider` instead of `chat_call.permission_provider`.

## Current State

- `permission_provider` is currently on `Call.Chat` (line 82 in `Chat.vala`)
- `SessionBase` sets `agent.chat.permission_provider` when its own `permission_provider` is set (line 51 in `SessionBase.vala`)
- Tools access it via `this.chat_call.permission_provider`

## Implementation Steps

### Step 9.1: Add Permission Provider to AgentHandler

**Goal**: Add `permission_provider` property to `AgentHandler`.

**Changes**:
1. Add to `libollmchat/Prompt/AgentHandler.vala`:
   ```vala
   /**
    * Permission provider for tool execution.
    *
    * Handles permission requests when tools need to access files or execute commands.
    * Set by Session when creating the agent handler.
    *
    * @since 1.2.7.9
    */
   public OLLMchat.ChatPermission.Provider? permission_provider { get; set; }
   ```

2. Update `AgentHandler` constructor to accept permission provider:
   - Option 1: Add as constructor parameter
   - Option 2: Set after construction (from Session)
   - **Decision needed**: Which approach?

**Result**: AgentHandler has permission_provider property

### Step 9.2: Update SessionBase to Set Permission Provider on Agent

**Goal**: Update `SessionBase` to set permission provider on agent handler instead of chat.

**Changes**:
1. In `libollmchat/History/SessionBase.vala`, update `permission_provider` setter:
   - Remove: `this.agent.chat.permission_provider = value;`
   - Add: `this.agent.permission_provider = value;` (if agent exists)

2. Ensure agent handler gets permission provider when created or updated

**Result**: Session sets permission provider on agent, not chat

### Step 9.3: Update Tools to Access Permission Provider via Agent

**Goal**: Update all tool code to access permission provider via `agent.permission_provider` instead of `chat_call.permission_provider`.

**Note**: This step is mostly covered by plan 1.2.7.4 which removes `chat_call` property and makes tools use `agent.chat`. Tools will already be accessing everything via agent, so permission provider access will be updated as part of that migration.

**Files to modify**:
- `libollmchat/Tool/RequestBase.vala` - Update `normalize_file_path()` and `execute()` methods
- `libollmchat/Tools/RequestRunCommand.vala` - Update permission provider access
- `libollmchat/Tools/RequestEditMode.vala` - Update permission provider access

**Changes**:
1. In `RequestBase.normalize_file_path()`:
   ```vala
   // Change from:
   var permission_provider = this.chat_call.permission_provider;
   // To:
   var permission_provider = this.agent != null ? this.agent.permission_provider : null;
   ```

2. In `RequestBase.execute()`:
   ```vala
   // Change from:
   var permission_provider = this.chat_call.permission_provider;
   // To:
   var permission_provider = this.agent != null ? this.agent.permission_provider : null;
   ```

3. In `RequestRunCommand.execute()`:
   ```vala
   // Change from:
   if (this.chat_call.permission_provider == null) {
   // To:
   if (this.agent == null || this.agent.permission_provider == null) {
   ```

4. In `RequestEditMode` (wherever permission_provider is accessed):
   ```vala
   // Change from:
   this.chat_call.permission_provider
   // To:
   this.agent != null ? this.agent.permission_provider : null
   ```

**Result**: All tools access permission provider via agent property (as part of 1.2.7.4 migration)

### Step 9.4: Remove Permission Provider from Chat

**Goal**: Remove `permission_provider` property from `Call.Chat` since it's now on AgentHandler.

**Changes**:
1. In `libollmchat/Call/Chat.vala`:
   - Remove `permission_provider` property declaration (line 82)
   - Remove any code that sets or uses `this.permission_provider`

2. Update any remaining references to `chat.permission_provider` to use agent instead

**Result**: Permission provider is only on AgentHandler, not Chat

## Files to Modify

- `libollmchat/Prompt/AgentHandler.vala` - Add `permission_provider` property
- `libollmchat/History/SessionBase.vala` - Set permission provider on agent instead of chat
- `libollmchat/Tool/RequestBase.vala` - Access permission provider via agent
- `libollmchat/Tools/RequestRunCommand.vala` - Access permission provider via agent
- `libollmchat/Tools/RequestEditMode.vala` - Access permission provider via agent
- `libollmchat/Call/Chat.vala` - Remove `permission_provider` property

## Testing Checklist

- [ ] `AgentHandler` has `permission_provider` property
- [ ] `SessionBase` sets permission provider on agent handler
- [ ] Tools access permission provider via `agent.permission_provider`
- [ ] Permission requests still work correctly
- [ ] Permission checks still work correctly
- [ ] File path normalization still works correctly
- [ ] `Chat` no longer has `permission_provider` property
- [ ] All tool execution flows work correctly with agent-based permission provider

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-move-signals-to-chat.md) - Parent plan
- [1.2.7.4. Migrate Tool Signal Connections to Direct Method Calls](./1.2.7.4-DONE-migrate-non-agent-signals.md) - Adds agent property to tools
- [1.2. Refactor Client and Chat Relationship](./1.2-refactor-client-chat-relationship.md) - Grandparent plan

