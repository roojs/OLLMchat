# 2.6.1.1. Simple bwrap Support (No Overlay)

## Overview

Implement basic bwrap (bubblewrap) sandboxing for code execution without overlay filesystem support. This phase establishes the foundation for secure command execution.

## Status

‚è≥ **PLANNING** - Design phase.

## Prerequisites

- See main plan: `2.6.1-code-exec-improvements.md` for general architecture and design decisions
- bwrap (bubblewrap) must be installed on system

## Goals

1. Create `Bwrap` class for bwrap command execution
2. Configure read-only root filesystem access
3. Block network access by default
4. Support nested bwrap (when application is already in bwrap container)
5. Replace `GLib.Subprocess` with bwrap execution

## Implementation Details

### Files to Create

- `liboctools/RunCommand/Bwrap.vala` - bwrap wrapper class

### Files to Modify

- `liboctools/RunCommand/Request.vala` - Integrate Bwrap class for command execution

### Bwrap Class Design

#### Class Structure

```vala
namespace OLLMtools.RunCommand {
    public class Bwrap {
        // Properties
        private OLLMfiles.Folder project;           // Project folder (is_project = true)
        private Gee.ArrayList<OLLMfiles.Folder> additional_folders;  // Additional folders to share (optional)
        private Gee.HashMap<string, OLLMfiles.Folder> shared_folders;  // Map of path -> Folder objects to share (read-write access)
        private bool allow_network;                 // Network access flag (default: false)
        private bool is_already_in_bwrap;            // Whether we're already in a bwrap container
        
        // Constructor
        public Bwrap(OLLMfiles.Folder project, Gee.ArrayList<OLLMfiles.Folder>? additional_folders = null, bool allow_network = false)
        
        // Public methods
        public async string exec(string command) throws Error
        
        // Private helper methods
        private bool detect_already_in_bwrap()
        private void build_shared_folders() throws Error
        private string[] build_bwrap_args(string command) throws Error
        private void add_ro_bind_args(StringBuilder args)
        private void add_shared_folder_bind_args(StringBuilder args) throws Error
        private void add_network_args(StringBuilder args)
        private void add_nested_args(StringBuilder args)
        private async string read_subprocess_output(Subprocess subprocess) throws Error
    }
}
```

**Note**: Implementation should be split into two parts:
1. **Part 1**: Create the Bwrap class with basic functionality
2. **Part 2**: Integrate Bwrap into RunCommand/Request.vala to replace GLib.Subprocess

#### Method Details

**Constructor: `Bwrap(OLLMfiles.Folder project, Gee.ArrayList<OLLMfiles.Folder>? additional_folders = null, bool allow_network = false)`**
- **Purpose**: Initialize Bwrap instance with configuration
- **Parameters**:
  - `project`: Project folder object (is_project = true) - the main project directory
  - `additional_folders`: Optional array of additional Folder objects to share (default: null)
  - `allow_network`: Whether to allow network access (default: false, Phase 7 feature)
- **Implementation**:
  - Store parameters as instance variables
  - Initialize `shared_folders` as empty HashMap
  - Call `detect_already_in_bwrap()` to check if already in bwrap container
  - Call `build_shared_folders()` to build the HashMap from Folder objects
  - Note: Environment variables are inherited from user's environment (no explicit handling needed)

**Method: `async string exec(string command) throws Error`**
- **Purpose**: Execute command string in bwrap sandbox and return output as string
- **Parameters**:
  - `command`: Command string to execute (e.g., `"ls -la"` or `"cd /path && make"`)
- **Returns**: String containing command output (stdout + stderr, with exit code if non-zero)
- **Implementation**:
  1. Build bwrap command arguments using `build_bwrap_args(command)`
  2. Create `GLib.Subprocess` with bwrap as executable
  3. Configure subprocess flags: `STDOUT_PIPE | STDERR_PIPE | STDIN_INHERIT`
  4. Read output using `read_subprocess_output()`
  5. Wait for process to complete and get exit status
  6. Format output: stdout + stderr + exit code (if non-zero)
  7. Return formatted string
- **How it works**:
  - Constructs bwrap command: `bwrap [args] -- /bin/sh -c "command"`
  - Uses `GLib.Subprocess.newv()` to create process
  - Handles all I/O internally and returns simple string result
  - LLM only sees command string in, string out - everything else is internal

**Method: `private void build_shared_folders() throws Error`**
- **Purpose**: Build the shared_folders HashMap from project and additional_folders using Folder methods
- **Implementation**:
  1. Clear existing `shared_folders` HashMap
  2. Add project folder:
     - Get path from `project.path` (realpath for Phase 1, will be overlay path in later phases)
     - Validate path exists and is absolute
     - Add to HashMap: `shared_folders.set(project.path, project)`
  3. Add additional folders (if provided):
     - For each folder in `additional_folders`:
       - Get path from `folder.path` (realpath for Phase 1, will be overlay path in later phases)
       - Validate path exists and is absolute
       - Add to HashMap: `shared_folders.set(folder.path, folder)`
- **How it works**:
  - Uses `folder.path` property from Folder objects to get the path
  - For Phase 1: `folder.path` is the realpath (actual filesystem path)
  - In later phases: `folder.path` will be updated to overlay mount points
  - The HashMap key (path) is what's used for bwrap bind mounting
  - The HashMap value (Folder object) is kept for reference and future use

**Method: `private bool detect_already_in_bwrap()`**
- **Purpose**: Detect if application is already running inside a bwrap container
- **Returns**: `true` if already in bwrap, `false` otherwise
- **Implementation**:
  - Check for bwrap-specific environment variables:
    - `BWRAP` or `BUBBLEWRAP` (if bwrap sets these)
  - Check filesystem indicators:
    - Check if `/proc/self/root` is different from `/` (indicates namespace isolation)
    - Check if `/proc/self/ns/user` exists and differs from parent (user namespace)
  - Check process tree:
    - Check if parent process is bwrap (read `/proc/self/status` or `/proc/self/comm`)
- **How it works**:
  - Multiple detection methods for reliability
  - Returns true if any indicator suggests already in bwrap
  - Cached result stored in `is_already_in_bwrap` property

**Method: `private string[] build_bwrap_args(string command) throws Error`**
- **Purpose**: Build complete bwrap command line arguments
- **Parameters**:
  - `command`: Command string to execute
- **Returns**: Array of arguments for bwrap command (including `/bin/sh -c "command"`)
- **Implementation**:
  1. Create `StringBuilder` for argument building
  2. Add read-only bind args: `add_ro_bind_args()`
  3. Add shared folder bind args: `add_shared_folder_bind_args()`
  4. Add network args: `add_network_args()`
  5. Add nested bwrap args if needed: `add_nested_args()`
  6. Add separator: `--`
  7. Add shell command: `"/bin/sh"`, `"-c"`, `command`
  8. Convert StringBuilder to string array
- **How it works**:
  - Builds complete bwrap command: `bwrap [flags] -- /bin/sh -c "command"`
  - Each helper method adds specific bwrap flags
  - Environment variables are inherited automatically (no explicit flags needed)
  - Working directory will be added in later phases when overlay support is added
  - Final array: `["bwrap", "--ro-bind", "/", "/", "--bind", folder1_path, folder1_path, ..., "--", "/bin/sh", "-c", "command"]`

**Method: `private async string read_subprocess_output(Subprocess subprocess) throws Error`**
- **Purpose**: Read stdout and stderr from subprocess and return combined output
- **Parameters**:
  - `subprocess`: The Subprocess instance to read from
- **Returns**: Combined stdout + stderr output as string
- **Implementation**:
  1. Get stdout and stderr streams from subprocess
  2. Read from both streams concurrently (async)
  3. Combine outputs (stdout first, then stderr if present)
  4. Wait for process to complete
  5. Get exit status
  6. Append exit code to output if non-zero
  7. Return formatted string
- **How it works**:
  - Uses async I/O to read both streams
  - Formats output similar to existing RunCommand behavior
  - Handles truncation if needed (similar to existing code)

**Method: `private void add_ro_bind_args(StringBuilder args)`**
- **Purpose**: Add read-only bind mount for entire root filesystem
- **Implementation**:
  - Append: `"--ro-bind"`, `"/"`, `"/"`
- **How it works**:
  - `--ro-bind / /` makes entire root filesystem available read-only
  - All system binaries, libraries, etc. are accessible but not writable

**Method: `private void add_shared_folder_bind_args(StringBuilder args) throws Error`**
- **Purpose**: Add read-write bind mounts for all shared folders (project + additional folders)
- **Implementation**:
  - Iterate over `shared_folders` HashMap entries:
    - For each entry: `path` (key) -> `folder` (value)
    - Validate path exists and is absolute
    - Append: `"--bind"`, `path`, `path`
  - Also bind the project folder itself (if not already in shared_folders):
    - Use `project.path` as the path (realpath for Phase 1)
    - Append: `"--bind"`, `project.path`, `project.path`
- **How it works**:
  - `--bind path path` mounts each folder at same location using the path from the HashMap key
  - Provides read-write access to all specified folders
  - In Phase 3, the HashMap keys (paths) will be overlay mount points instead of realpaths
  - The Folder objects (values) are kept for reference but the paths (keys) are what's used for mounting
  - Multiple folders can be shared (e.g., project directory + dependencies directory)

**Method: `private void add_network_args(StringBuilder args)`**
- **Purpose**: Add network access control flags
- **Implementation**:
  - If `allow_network == false`: Append `"--unshare-net"`
  - If `allow_network == true`: Do nothing (allow network access)
- **How it works**:
  - `--unshare-net` creates new network namespace (no network access)
  - Default behavior: network blocked
  - Phase 7: Network access requires explicit permission

**Note**: Working directory support will be added in later phases when overlay support is implemented. For Phase 1, commands execute from the project root directory.

**Note**: Environment variables are automatically inherited from the user's environment when using `GLib.Subprocess`. No explicit `--setenv` flags are needed. bwrap will inherit the environment from the parent process by default.

**Method: `private void add_nested_args(StringBuilder args)`**
- **Purpose**: Add flags for nested bwrap execution
- **Implementation**:
  - If `is_already_in_bwrap == true`:
    - Append `"--share-net` (if network was shared in parent)
    - May need additional flags depending on bwrap nesting behavior
  - If `is_already_in_bwrap == false`: Do nothing
- **How it works**:
  - Nested bwrap may need different flags
  - Some namespaces may already be shared/unshared
  - Research bwrap nesting behavior for exact flags needed
  - Default: Try without special flags first, add if needed

#### Integration with Request.vala

**Replace in `execute_tool_async()`:**
- Current: Creates `GLib.Subprocess` directly with `/bin/sh -c`, reads streams, formats output
- New: Create `Bwrap` instance, call `exec(command)`, get string back
- All stream reading and formatting is handled internally by Bwrap

**Example usage:**
```vala
// Get project folder from ProjectManager
var project_manager = this.agent.project_manager;
var project = project_manager.active_project;  // OLLMfiles.Folder

// Optionally create list of additional folders to share
var additional_folders = new Gee.ArrayList<OLLMfiles.Folder>();
// Can add more folders here if needed:
// additional_folders.add(some_other_folder);

// Create Bwrap instance (it will build shared_folders HashMap internally)
var bwrap = new Bwrap(
    project: project,
    additional_folders: additional_folders,  // Can be null if no additional folders
    allow_network: false
);

// Execute command - simple string in, string out
var output = yield bwrap.exec(this.command);

// Return output to LLM (already formatted with stdout + stderr + exit code)
return output;
```

### Nested bwrap Support

- Detect if application is already running in bwrap container (`detect_already_in_bwrap()`)
- Check for bwrap-specific environment variables or filesystem indicators
- Use appropriate bwrap nesting flags/methods when already in bwrap
- Ensure nested bwrap still provides proper sandboxing

### Integration

**Part 2: Integrate into RunCommand**
- Replace `GLib.Subprocess` calls in `RunCommand/Request.vala` with `Bwrap.exec()`
- Simplify `execute_tool_async()` to just call `bwrap.exec(command)` and return string
- All I/O handling is internal to Bwrap class
- LLM interface remains simple: command string in, output string out

## Implementation Tasks

**Part 1: Create Bwrap Class**
- [ ] Create `Bwrap` class structure
- [ ] Implement constructor with Folder objects
- [ ] Implement `build_shared_folders()` method
- [ ] Implement `detect_already_in_bwrap()` method
- [ ] Implement `build_bwrap_args()` method
- [ ] Implement helper methods for bwrap flags (`add_ro_bind_args`, `add_shared_folder_bind_args`, `add_network_args`, `add_nested_args`)
- [ ] Implement `read_subprocess_output()` method
- [ ] Implement `exec(string command)` method (main public API)
- [ ] Test Bwrap class in isolation

**Part 2: Integrate into RunCommand**
- [ ] Modify `RunCommand/Request.vala` to use Bwrap
- [ ] Replace `GLib.Subprocess` code with `Bwrap.exec()` call
- [ ] Simplify `execute_tool_async()` method
- [ ] Test integration with RunCommand tool
- [ ] Test basic command execution (both nested and non-nested scenarios)
- [ ] Test network blocking (verify commands cannot access network by default)
- [ ] Test write restrictions (writes to project directory only)

## Testing

- Test commands that should work (read-only, project writes)
- Test commands that should be blocked (system writes)
- Test network blocking (commands cannot access network)
- Test nested bwrap scenarios (application in bwrap and not in bwrap)

## Notes

- bwrap may not be available on all systems - need fallback or requirement check
- Network access will be added in Phase 7 (last phase)
- Overlay filesystem support will be added in Phase 3

