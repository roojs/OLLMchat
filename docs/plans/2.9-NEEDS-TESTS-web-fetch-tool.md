# 2.9. Web Fetch Tool

## Overview

Implementation of WebFetchTool for fetching web content with automatic format detection and conversion.

## Status

✅ **DONE** - Fully implemented and integrated.

## Implementation Details

### Design Considerations
- Designed to be extensible - WebSearchTool will extend this class
- Use protected methods for HTTP fetching logic so subclasses can reuse
- Keep core fetching logic separate from format conversion for reusability

### Format Handling Rules
- **Automatic format detection based on Content-Type**:
  - `image/*` → automatically converted to base64 (regardless of format parameter)
  - `text/*` → raw format (except HTML which converts to markdown if format="markdown")
  - `application/json` → raw format
  - Any non-text content type → base64 (regardless of format parameter)
- **User-specified format parameter** only applies when content is text/HTML

### Features
- HTTP method support (GET only - POST disabled for now)
- URL fetching
- Output format options: "markdown", "raw", or "base64" (default: "markdown")
- Return markdown version of fetched content (using HTML2Markdown utility)
- Authentication config file loading (`~/.config/ollama/tools/web_fetch.json`) - Future enhancement
- **POST support**: Disabled for initial implementation (will be added in future)

## Files to Create

### Core Tool Files
- `liboctools/WebFetchTool.vala` - Main tool class extending `OLLMchat.Tool.Interface` (namespace: `OLLMtools`)
- `liboctools/RequestWebFetch.vala` - Request handler class extending `OLLMchat.Tool.RequestBase` (namespace: `OLLMtools`)

### File Structure
```
liboctools/
├── WebFetchTool.vala          (new - main tool class, namespace: OLLMtools)
└── RequestWebFetch.vala        (new - request handler, namespace: OLLMtools)
```

## Implementation Tasks

### 1. Create WebFetchTool.vala
- **Location**: `liboctools/WebFetchTool.vala` (namespace: `OLLMtools`)
- **Namespace**: `OLLMtools`
- **Extends**: `OLLMchat.Tool.Interface`
- **Properties to implement**:
  - `name` → `"web_fetch"`
  - `description` → Tool description explaining what it does
  - `parameter_description` → Parameter documentation with `@param` tags
- **Methods to implement**:
  - `deserialize(Json.Node)` → Returns `RequestWebFetch` instance
- **Design notes**:
  - Keep tool class simple and stateless
  - All logic goes in Request class

### 2. Create RequestWebFetch.vala
- **Location**: `liboctools/RequestWebFetch.vala` (namespace: `OLLMtools`)
- **Namespace**: `OLLMtools`
- **Extends**: `OLLMchat.Tool.RequestBase`
- **Parameter properties** (must match parameter_description):
  - `url` (string, required) - URL to fetch
  - `format` (string, optional, default: "markdown") - Output format: "markdown", "raw", or "base64"
  - **Note**: POST support is disabled for now - only GET method is supported
- **Methods to implement**:
  - `build_perm_question()` → Build permission question for domain access (extracts domain from URL)
  - `execute_request()` → Async method that:
    1. Creates Soup.Session and Soup.Message
    2. Sets HTTP method to GET (POST disabled for now)
    3. Sends HTTP request
    4. Reads response body
    5. Detects Content-Type from response headers
    6. Converts content based on Content-Type and format parameter using switch/case
    7. Returns converted content
- **Protected methods for extensibility**:
  - `protected async Bytes fetch_url(string url)` → Core HTTP fetching logic (GET only)
  - `protected string extract_domain(string url)` → Extract domain from URL for permission checking
  - `protected string detect_content_type(Soup.MessageHeaders headers)` → Extract Content-Type from headers
  - `protected string convert_content(Bytes content, string content_type, string format)` → Format conversion logic (use switch/case)
  - `protected string convert_to_base64(Bytes content)` → Base64 encoding helper
  - `protected string convert_html_to_markdown(string html)` → HTML to markdown conversion using `Markdown.HtmlParser`

### 3. HTTP Request Implementation
- **Library**: Use `Soup.Session` and `Soup.Message` from libsoup-3.0 (already a dependency)
- **Pattern**: Follow pattern from `libollmchat/Call/Base.vala` for HTTP requests
- **Method**: Only GET requests are supported (POST disabled for now)
- **Example**:
  ```vala
  var session = new Soup.Session();
  var message = new Soup.Message("GET", url);
  var bytes = yield session.send_and_read_async(message, GLib.Priority.DEFAULT, null);
  ```
- **Coding Standards**: Use switch/case for Content-Type handling instead of long if/else chains

### 4. Format Conversion Logic
- **HTML to Markdown**: Use `Markdown.HtmlParser` from `libocmarkdown`
  - Import: `using Markdown;` (or use full namespace `Markdown.HtmlParser`)
  - Usage: `var parser = new Markdown.HtmlParser(html_string); var markdown = parser.convert();`
- **Base64 encoding**: Use `GLib.Base64.encode()` for binary content
- **Content-Type detection**: Parse `Content-Type` header from `Soup.Message.response_headers`
- **Format rules** (use switch/case, not if/else):
  - Content-Type starts with `image/` → always base64 (regardless of format parameter)
  - Content-Type is `text/html` and format="markdown" → convert to markdown
  - Content-Type is `text/html` and format="raw" → return raw HTML
  - Content-Type starts with `text/` (non-HTML) → return raw text
  - Content-Type is `application/json` → return raw JSON
  - Content-Type is anything else → base64
- **Coding Standards**: Use switch/case statement for Content-Type matching instead of long if/else chains

### 5. Permission System
- **Permission question**: "Fetch URL from domain: {domain}?"
- **Permission target**: Domain extracted from URL (e.g., "https://example.com/" or "http://example.com/")
- **Domain extraction**: Extract domain from URL and normalize to `https://{domain}/` format (works for http as well)
  - Example: `https://example.com/path` → `https://example.com/`
  - Example: `http://example.com/path` → `https://example.com/` (normalize http to https for permission)
- **Permission operation**: `OLLMchat.ChatPermission.Operation.READ`
- **Note**: When user approves, they're approving access to the entire domain, not just the specific URL
- **Implementation**: Create `extract_domain()` method that:
  1. Parses URL to extract domain
  2. Normalizes to `https://{domain}/` format (even if original was http)
  3. Returns normalized domain string for permission checking

### 6. Error Handling
- **Invalid URL**: Return error message prefixed with "ERROR: "
- **HTTP errors**: Check `message.status_code` and return appropriate error
- **Network errors**: Catch `GLib.IOError` and return error message
- **Format conversion errors**: Fall back to raw format if conversion fails
- **Coding Standards**: Follow all coding standards from `.cursor/rules/CODING_STANDARDS.md`:
  - Use `this.` prefix for properties/methods
  - Use switch/case instead of long if/else chains
  - Avoid temporary variables when possible
  - Use line breaks for braces in classes/methods, not in control structures
  - Use GLib namespace prefix (e.g., `GLib.Base64.encode()`)
  - No string interpolation (`@"`) unless explicitly needed
  - Check standards after each implementation step

### 7. Add to meson.build
- **File**: `libollmchat/meson.build`
- **Step 1**: Add files to `ollmchat_tools_src` files list:
  ```meson
  ollmchat_tools_src = files([
    'Tools/ReadFile.vala',
    'Tools/RequestReadFile.vala',
    'Tools/EditMode.vala',
    'Tools/RequestEditMode.vala',
    'Tools/EditModeChange.vala',
    'Tools/RunCommand.vala',
    'Tools/RequestRunCommand.vala',
    'Tools/WebFetchTool.vala',        # Add this
    'Tools/RequestWebFetch.vala',     # Add this
  ])
  ```
- **Step 2**: Add `ocmarkdown_vapi_dep` to library dependencies:
  - In `ollmchat_base_lib` definition, add `ocmarkdown_vapi_dep` to dependencies list:
    ```meson
    ollmchat_base_lib = library('ollmchat',
      dependencies: [ollmchat_deps, ocsqlite_vapi_dep, ocagent_vapi_dep, ocmarkdown_vapi_dep],  # Add ocmarkdown_vapi_dep
      ...
    )
    ```
  - **Note**: `ocmarkdown_vapi_dep` is defined in `libocmarkdown/meson.build` and should be accessible since meson processes subdirectories in order (libocmarkdown comes before libollmchat)
- **Step 3**: Add `--pkg=ocmarkdown` to `vala_args`:
  ```meson
  vala_args: ['--pkg=sqlite3', '--pkg=ocsqlite', '--pkg=ocagent', '--pkg=ocmarkdown', ...]
  ```
- **Step 4**: Add `libocmarkdown` to `lib_build_rpath` (verify it's already there):
  - Should already be present: `meson.current_build_dir() / '..' / 'libocmarkdown'`
- **Dependencies**: 
  - `libsoup-3.0` - Already in `ollmchat_deps` (no change needed)
  - `libocmarkdown` - Add `ocmarkdown_vapi_dep` and `--pkg=ocmarkdown` as above

### 8. Register Tool in Application
- **File**: `ollmchat/Window.vala`
- **Location**: In `initialize_client()` method, after other tool registrations
- **Code**:
  ```vala
  this.history_manager.base_client.addTool(
      new OLLMtools.WebFetchTool(this.history_manager.base_client, project_manager));
  ```
- **Note**: Tool registration happens in `ollmchat/Window.vala` around line 262-268

### 9. Create Test Tool (oc-test-fetch)
- **File**: `examples/oc-test-fetch.vala`
- **Purpose**: Command-line test tool for WebFetchTool functionality
- **Features**:
  - Accept URL as command-line argument (required)
  - Accept optional format parameter (markdown, raw, base64, default: markdown)
  - Create minimal Client instance (or use Dummy permission provider)
  - Create WebFetchTool instance
  - Create RequestWebFetch with URL and format
  - Execute fetch and display results to stdout
  - Handle errors gracefully with clear error messages
- **Usage**: `oc-test-fetch <url> [format]`
- **Example**: `oc-test-fetch https://example.com markdown`
- **Add to meson.build**: 
  - **File**: `examples/meson.build`
  - **Add executable definition** (after oc-html2md, around line 127):
    ```meson
    # Build oc-test-fetch executable (WebFetchTool test)
    test_web_fetch = executable('oc-test-fetch',
      dependencies: [test_ollama_deps, ollmchat_vapi_dep, ocmarkdown_vapi_dep],
      sources: ['oc-test-fetch.vala'],
      link_with: [ollmchat_base_lib],
      include_directories: include_directories('../libollmchat'),
      build_rpath: build_rpath,
      vala_args: [
        '--pkg=sqlite3',
        '--pkg=ocsqlite',
        '--pkg=ocagent',
        '--pkg=ocmarkdown',
        '--vapidir', meson.current_build_dir() / '..' / 'libocsqlite',
        '--vapidir', meson.current_build_dir() / '..' / 'libocagent',
        '--vapidir', meson.current_build_dir() / '..' / 'libocmarkdown'
      ],
      install: true,
      install_dir: get_option('datadir') / 'doc' / 'ollmchat'
    )
    ```
  - **Add to wrapper script list** in top-level `meson.build`:
    - Add `['oc-test-fetch', 'examples/oc-test-fetch']` to `executables_info` list
  - **Dependencies**: `test_ollama_deps`, `ollmchat_vapi_dep`, `ocmarkdown_vapi_dep`
  - **Pattern**: Follow pattern from `examples/oc-test-cli.vala` (uses ollmchat_base_lib)
- **Implementation notes**:
  - Use `OLLMchat.ChatPermission.Dummy` for permission provider (auto-approves)
  - Create minimal `OLLMchat.Client` instance
  - Create `OLLMtools.WebFetchTool` instance
  - Manually create `RequestWebFetch` and set properties
  - Call `execute_request()` directly (bypass permission check or use Dummy provider)
  - Output result to stdout

## Dependencies

### Existing Dependencies (already available)
- `libsoup-3.0` - HTTP client library (already in `ollmchat_deps`)
- `gio-2.0` - GLib I/O library (already in `ollmchat_deps`)
- `json-glib-1.0` - JSON handling (already in `ollmchat_deps`)

### New Dependencies Needed
- `libocmarkdown` - For HTML to Markdown conversion
  - **Action**: Add `ocmarkdown_vapi_dep` to `ollmchat_base_lib` dependencies in `libollmchat/meson.build`
  - **Action**: Add `--pkg=ocmarkdown` to `vala_args` in `libollmchat/meson.build`
  - **Action**: Verify `libocmarkdown` is in `lib_build_rpath` (should already be present)
  - **Note**: `ocmarkdown_vapi_dep` is defined in `libocmarkdown/meson.build` and is accessible since meson processes subdirectories in dependency order
  - **Pattern**: Follow pattern from `examples/meson.build` which uses `ocmarkdown_vapi_dep` in dependencies

## Testing Checklist

### Implementation Steps (with Coding Standards Check)
- [x] Step 1: Create WebFetchTool.vala - Check coding standards after completion
- [x] Step 2: Create RequestWebFetch.vala - Check coding standards after completion
- [x] Step 3: Implement HTTP fetching - Check coding standards after completion
- [x] Step 4: Implement format conversion (use switch/case) - Check coding standards after completion
- [x] Step 5: Implement permission system (domain-based) - Check coding standards after completion
- [x] Step 6: Add error handling - Check coding standards after completion
- [x] Step 7: Update meson.build - Verify build works
- [x] Step 8: Register tool - Test tool appears
- [x] Step 9: Create oc-test-fetch - Test command-line tool works

### Functional Tests
- [ ] Test with various Content-Types:
  - [ ] `text/html` with format="markdown" → should convert to markdown
  - [ ] `text/html` with format="raw" → should return raw HTML
  - [ ] `text/plain` → should return raw text
  - [ ] `application/json` → should return raw JSON
  - [ ] `image/png` → should return base64 (regardless of format parameter)
  - [ ] `application/pdf` → should return base64
- [ ] Test HTTP methods:
  - [ ] GET request works
  - [ ] POST is not available (parameter not in description)
- [ ] Test error handling:
  - [ ] Invalid URL
  - [ ] HTTP 404 error
  - [ ] Network timeout
  - [ ] Missing Content-Type header
- [ ] Test permission system:
  - [ ] Permission question appears with domain (not full URL)
  - [ ] Permission target is domain (e.g., "https://example.com/")
  - [ ] Permission works for both http and https URLs (normalized to https)
  - [ ] Permission denial works
  - [ ] Permission approval grants access to entire domain
- [ ] Test format conversion:
  - [ ] HTML to markdown conversion works
  - [ ] Base64 encoding works
  - [ ] Raw format returns original content
  - [ ] Switch/case logic handles all Content-Type cases correctly
- [ ] Test oc-test-fetch tool:
  - [ ] Command-line tool accepts URL argument
  - [ ] Command-line tool accepts optional format argument
  - [ ] Command-line tool displays fetched content
  - [ ] Command-line tool handles errors gracefully
- [ ] Verify tool registration:
  - [ ] Tool appears in available tools
  - [ ] Tool can be called by LLM
  - [ ] Tool execution works end-to-end

## Future Enhancements

- Authentication config file support (`~/.config/ollama/tools/web_fetch.json`)
  - Load API keys, headers, or authentication tokens from config file
  - Support for different authentication methods (Bearer token, API key, etc.)
- Rate limiting and caching
- User-agent customization
- Request timeout configuration
- Follow redirects configuration
