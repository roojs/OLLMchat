# 1.2.6. Update Legacy Methods and Maintain Backward Compatibility

## Overview

Update Client convenience methods (`chat()`, `embed()`, `generate()`) to work with the new architecture while maintaining backward compatibility where possible.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-DONE-refactor-client-chat-relationship.md)

## Status

✅ **DONE** - All Client convenience methods migrated to use Connection-based architecture with model as required parameter and options as optional parameter.

## Summary & Progress Checklist

### ✅ Completed Tasks

- [x] **Step 1.1: Client.chat() migrated** - Uses `this.connection`, requires `model` as parameter, accepts optional `options`, creates `Call.Chat` with Connection constructor
- [x] **Step 1.2: Client.embed() migrated** - Uses `this.connection`, requires `model` as parameter, accepts optional `options`, creates `Call.Embed` with Connection constructor
- [x] **Step 1.3: Client.embed_array() migrated** - Uses `this.connection`, requires `model` as parameter, accepts optional `options`, creates `Call.Embed` with Connection constructor
- [x] **Step 1.4: Client.generate() migrated** - Uses `this.connection`, requires `model` as parameter, accepts optional `options`, creates `Call.Generate` with Connection constructor
- [x] **All methods use Connection internally** - All convenience methods now use `this.connection` instead of `this`
- [x] **All methods require model as parameter** - All methods require `model` as the first parameter (explicit API)
- [x] **All methods accept options as optional parameter** - All methods accept `Call.Options?` as optional parameter
- [x] **No signal emissions in convenience methods** - Methods don't emit signals (callers handle state directly)

### ✅ All Tasks Complete

- [x] **Client.chat() options support** - **DONE**: Accepts `Call.Options?` as optional parameter
- [x] **Model as required parameter** - **DONE**: All methods require `model` as the first parameter
- [x] **Options as optional parameter** - **DONE**: All methods accept `Call.Options?` as optional parameter

### ❌ Not Applicable

- [x] **refactor_* properties** - **N/A**: These don't exist in current codebase (Phase 3 architecture doesn't use them)
- [x] **new_connection_refactor constructors** - **N/A**: Call classes now take Connection directly (simpler approach)
- [x] [1.2.6.1. Update Client Method Signatures](./1.2.6.1-DONE-update-client-method-signatures.md) - **DONE**: Method signatures updated
- [x] [1.2.6.2. Update Session.chat()](./1.2.6.2-DONE-update-session-chat.md) - **DONE**: Updated to use Agent instead of direct Chat access
- [x] [1.2.6.3. Update TitleGenerator](./1.2.6.3-DONE-update-title-generator.md) - **DONE**: Updated to take Manager reference instead of Client
- [x] [1.2.6.4. Update VectorBuilder](./1.2.6.4-DONE-update-vector-builder.md) - **DONE**: Take `Config2` and get model from "embed_model" usage entry
- [x] [1.2.6.5. Update Database](./1.2.6.5-DONE-update-database.md) - **DONE**: Updated to extend VectorBase and use Config2
- [x] [1.2.6.6. Update Search](./1.2.6.6-DONE-update-search.md) - **DONE**: Updated to take Config2 and use VectorBase

### Current Implementation Notes

**What's Working:**
- All four convenience methods (`chat()`, `embed()`, `embed_array()`, `generate()`) have been migrated to use Connection-based architecture
- All methods require `model` as the first parameter (explicit API design)
- All methods accept `Call.Options?` as an optional parameter
- All methods use `this.connection` internally instead of `this`
- All methods throw helpful errors if model is empty
- All methods create Call objects with Connection constructor

**TODO - Required Changes:**

**Phase 1: Update Method Signatures**
- [x] [1.2.6.1. Update Client Method Signatures](./1.2.6.1-DONE-update-client-method-signatures.md) - **DONE**: Method signatures updated

**Phase 2: Update Call Sites (Should Use Connection, Not Client)**
- [x] [1.2.6.2. Update Session.chat()](./1.2.6.2-DONE-update-session-chat.md) - **DONE**: Updated to use Agent instead of direct Chat access
- [x] [1.2.6.3. Update TitleGenerator](./1.2.6.3-DONE-update-title-generator.md) - **DONE**: Updated to take Manager reference instead of Client
- [x] [1.2.6.4. Update VectorBuilder](./1.2.6.4-DONE-update-vector-builder.md) - **DONE**: Take `Config2` and get model from "embed_model" usage entry
- [x] [1.2.6.5. Update Database](./1.2.6.5-DONE-update-database.md) - **DONE**: Updated to extend VectorBase and use Config2
- [x] [1.2.6.6. Update Search](./1.2.6.6-DONE-update-search.md) - **DONE**: Updated to take Config2 and use VectorBase

## ⚠️ CRITICAL: Incremental Implementation Required

**IMPORTANT**: This refactoring must be done incrementally to keep the code usable after each step. See [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md) for the overall approach.

**Key Principle**: Migrate methods incrementally (one at a time), ensuring code remains usable after each migration.

## Goal

Ensure Client convenience methods still work for simple use cases, but use the new architecture internally (Connection, explicit properties, etc.).

## Implementation Strategy

This plan migrates Client convenience methods to use the Connection-based architecture while maintaining backward compatibility.

**Prerequisites**:
- Call.Base and Call subclasses support Connection-based constructors
- Config2.get_default_model() available for getting default model from config

## Implementation Steps

### Phase 1: Migrate Methods Incrementally

Migrate each Client convenience method **one at a time**, test after each migration.

#### Step 1.1: Migrate Client.chat()

**File**: `libollmchat/Client.vala`

**Current** (line ~317):
```vala
public async Response.Chat chat(string text, GLib.Cancellable? cancellable = null) throws Error
{
    var call = new Call.Chat(this, this.model) {
        cancellable = cancellable
    };
    // ... rest of implementation
}
```

**New** (actual implementation):
```vala
public async Response.Chat chat(
    string model,
    string text,
    Call.Options? options = null,
    GLib.Cancellable? cancellable = null
) throws Error
{
    if (model == "") {
        throw new OllamaError.INVALID_ARGUMENT("Client.chat() requires a model parameter.");
    }
    var send_opts = options == null ? new Call.Options() : options; 
    // Create chat call with Connection
    var call = new Call.Chat(this.connection, model, send_opts) {
        cancellable = cancellable,
        stream = true,
        think = true
    };
    
    // Create dummy user-sent Message with original text
    var user_sent_msg = new Message(call, "user-sent", text);
    // Note: No signal emission - caller handles state
    
    // Set chat_content to user text
    call.chat_content = text;
    
    // Prepare messages array for API request
    call.messages.add(new Message(call, "user", call.chat_content));
    
    var result = yield call.send(call.messages, cancellable);
    return result;
}
```

**Test**: Verify `Client.chat()` still works with both old and new signatures

**Result**: One method migrated, code still works

#### Step 1.2: Migrate Client.embed()

**File**: `libollmchat/Client.vala`

**Current** (line ~484):
```vala
public async Response.Embed embed(
    string input,
    int dimensions = -1,
    bool truncate = false,
    GLib.Cancellable? cancellable = null
) throws Error
{
    var call = new Call.Embed(this, this.model, new Call.Options()) {
        cancellable = cancellable,
        input = input,
        dimensions = dimensions,
        truncate = truncate
    };
    // ... rest of implementation
}
```

**New** (actual implementation):
```vala
public async Response.Embed embed(
    string model,
    string input,
    int dimensions = -1,
    bool truncate = false,
    Call.Options? options = null,
    GLib.Cancellable? cancellable = null
) throws Error
{
    if (model == "") {
        throw new OllamaError.INVALID_ARGUMENT("Client.embed() requires a model parameter.");
    }
    var send_opts = options == null ? new Call.Options() : options;
    // Create Embed with Connection
    var call = new Call.Embed(this.connection, model, send_opts) {
        cancellable = cancellable,
        input = input,
        dimensions = dimensions,
        truncate = truncate
    };
    
    var result = yield call.exec_embed();
    return result;
}
```

**Test**: Verify `Client.embed()` works with new signature

**Result**: Another method migrated, code still works

#### Step 1.3: Migrate Client.embed_array()

**File**: `libollmchat/Client.vala`

**Current** (line ~516):
```vala
public async Response.Embed embed_array(
    Gee.ArrayList<string> input_array,
    int dimensions = -1,
    bool truncate = false,
    GLib.Cancellable? cancellable = null
) throws Error
{
    var call = new Call.Embed(this, this.model, new Call.Options()) {
        cancellable = cancellable,
        input_array = input_array,
        dimensions = dimensions,
        truncate = truncate
    };
    // ... rest of implementation
}
```

**New** (actual implementation): Same pattern as `embed()`:
```vala
public async Response.Embed embed_array(
    string model,
    Gee.ArrayList<string> input_array,
    int dimensions = -1,
    bool truncate = false,
    Call.Options? options = null,
    GLib.Cancellable? cancellable = null
) throws Error
{
    if (model == "") {
        throw new OllamaError.INVALID_ARGUMENT("Client.embed_array() requires a model parameter.");
    }
    var send_opts = options == null ? new Call.Options() : options;
    // Create Embed with Connection
    var call = new Call.Embed(this.connection, model, send_opts) {
        cancellable = cancellable,
        input_array = input_array,
        dimensions = dimensions,
        truncate = truncate
    };
    
    var result = yield call.exec_embed();
    return result;
}
```

**Test**: Verify `Client.embed_array()` works with new signature

**Result**: Another method migrated, code still works

#### Step 1.4: Migrate Client.generate()

**File**: `libollmchat/Client.vala`

**Current** (line ~547):
```vala
public async Response.Generate generate(
    string prompt,
    string system = "",
    GLib.Cancellable? cancellable = null
) throws Error
{
    var call = new Call.Generate(this) {
        cancellable = cancellable,
        prompt = prompt,
        system = system
    };
    // ... rest of implementation
}
```

**New** (actual implementation):
```vala
public async Response.Generate generate(
    string model,
    string prompt,
    string system = "",
    Call.Options? options = null,
    GLib.Cancellable? cancellable = null
) throws Error
{
    if (model == "") {
        throw new OllamaError.INVALID_ARGUMENT("Client.generate() requires a model parameter.");
    }
    var send_opts = options == null ? new Call.Options() : options;
    // Create Generate with Connection
    var call = new Call.Generate(this.connection) {
        cancellable = cancellable,
        prompt = prompt,
        system = system,
        model = model,
        stream = false,
        think = false,
        options = send_opts
    };
    
    var result = yield call.exec_generate();
    return result;
}
```

**Test**: Verify `Client.generate()` works with new signature

**Result**: All convenience methods migrated, code still works

### Phase 2: Update Call Sites to Use Connection Instead of Client

**Prerequisite**: [1.2.6.1. Update Client Method Signatures](./1.2.6.1-DONE-update-client-method-signatures.md) - **DONE**

**Important**: According to plan 1.2, `config` should be removed from Client. **History.Manager owns the config** (see `libollmchat/History/Manager.vala` line 60). These call sites should:
1. Not use `this.client` - create their own Client from Connection
2. Not pass `config` to Client - Manager owns config, not Client
3. Take `model` explicitly as a parameter, or get it from Manager if they have access to it

See separate plan files for each call site:
- [1.2.6.2. Update Session.chat()](./1.2.6.2-DONE-update-session-chat.md) - **DONE**
- [1.2.6.3. Update TitleGenerator](./1.2.6.3-DONE-update-title-generator.md)
- [1.2.6.4. Update VectorBuilder](./1.2.6.4-DONE-update-vector-builder.md)
- [1.2.6.5. Update Database](./1.2.6.5-DONE-update-database.md) - **DONE**
- [1.2.6.6. Update Search](./1.2.6.6-DONE-update-search.md) - **DONE**

See separate plan files for detailed implementation:
- [1.2.6.2. Update Session.chat()](./1.2.6.2-DONE-update-session-chat.md) - **DONE** - Update Session to use `this.chat.connection`
- [1.2.6.3. Update TitleGenerator](./1.2.6.3-DONE-update-title-generator.md) - **DONE**: Updated to take Manager reference instead of Client
- [1.2.6.4. Update VectorBuilder](./1.2.6.4-DONE-update-vector-builder.md) - **DONE**: Updated to take Config2 and get model from "embed_model" usage entry
- [1.2.6.5. Update Database](./1.2.6.5-DONE-update-database.md) - **DONE**: Updated to extend VectorBase and use Config2
- [1.2.6.6. Update Search](./1.2.6.6-DONE-update-search.md) - **DONE**: Updated to take Config2 and use VectorBase

## Backward Compatibility

### Breaking Changes

**Current Implementation (Completed):**
- `Client.chat(string model, string text, Call.Options? options = null, Cancellable? cancellable = null)` - Model required, options optional
- `Client.embed(string model, string input, Call.Options? options = null, int dimensions = -1, bool truncate = false, Cancellable? cancellable = null)` - Model required, options optional
- `Client.embed_array(string model, Gee.ArrayList<string> input_array, Call.Options? options = null, int dimensions = -1, bool truncate = false, Cancellable? cancellable = null)` - Model required, options optional
- `Client.generate(string model, string prompt, Call.Options? options = null, string system = "", Cancellable? cancellable = null)` - Model required, options optional

**Breaking Change**: Methods require `model` as explicit parameter. This makes the simple wrapper API more explicit and clear. All methods use Connection internally and accept optional options parameter.

### Migration Path

For code using these methods:
1. Update to pass `model` parameter explicitly
2. Or ensure Config2 has default model configured
3. Update to handle state directly (no signal dependencies)

## Files to Modify

### Client
- `libollmchat/Client.vala` - Steps 1.1, 1.2, 1.3, 1.4

### Call Sites (if needed)
- Examples, tests, etc. - Step 2.1

## Testing Checklist

- [x] Step 1.1: Client.chat() migrated and tested - **Done**: Uses Connection, requires model parameter, accepts optional options
- [x] Step 1.2: Client.embed() migrated and tested - **Done**: Uses Connection, requires model parameter, accepts optional options
- [x] Step 1.3: Client.embed_array() migrated and tested - **Done**: Uses Connection, requires model parameter, accepts optional options
- [x] Step 1.4: Client.generate() migrated and tested - **Done**: Uses Connection, requires model parameter, accepts optional options
- [x] Step 2.1: All call sites updated and tested - **Done**: All sub-plans completed
- [x] All methods use Connection internally - **Done**: All use `this.connection`
- [x] All methods require model as parameter - **Done**: Model is required first parameter for all methods
- [x] All methods accept options as optional parameter - **Done**: All methods accept `Call.Options?` as optional parameter
- [ ] All methods set `refactor_*` properties explicitly - **N/A**: `refactor_*` properties don't exist in Phase 3 architecture
- [x] No signal emissions in convenience methods - **Done**: Methods don't emit signals
- [x] Backward compatibility maintained where possible - **Done**: Method signatures unchanged, all existing call sites work

## Sub-Plans

- [1.2.6.1. Update Client Method Signatures](./1.2.6.1-DONE-update-client-method-signatures.md) - **DONE**: Method signatures updated
- [1.2.6.2. Update Session.chat()](./1.2.6.2-DONE-update-session-chat.md) - **DONE**: Updated to use Agent instead of direct Chat access
- [1.2.6.3. Update TitleGenerator](./1.2.6.3-DONE-update-title-generator.md) - **DONE**: Updated TitleGenerator call site
- [1.2.6.4. Update VectorBuilder](./1.2.6.4-DONE-update-vector-builder.md) - **DONE**: Updated VectorBuilder call site
- [1.2.6.5. Update Database](./1.2.6.5-DONE-update-database.md) - **DONE**: Updated to extend VectorBase and use Config2
- [1.2.6.6. Update Search](./1.2.6.6-DONE-update-search.md) - **DONE**: Updated Search call site

## Related Plans

- [1.2.1. Remove Configuration from Client](./1.2.1-remove-config-from-client.md)
- [1.2.3. Update Call.Base to Take Connection](./1.2.3-update-call-base-connection.md)
- [1.2.4. Update All Chat Creation](./1.2.4-update-all-chat-creation.md)
- [1.2 Incremental Refactor Strategy](./1.2-incremental-refactor-strategy.md)
