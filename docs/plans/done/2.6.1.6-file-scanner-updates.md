# 2.6.1.6. File Scanner Updates and is_deleted Flag

## Overview

Add `is_deleted` flag to FileBase and update file scanner to keep deleted files in database until their backups are deleted.

## Status

‚è≥ **PLANNING** - Design phase.

## Prerequisites

- Phase 5 (2.6.1.5) must be completed
- See main plan: `2.6.1-code-exec-improvements.md` for file scanner details

## Goals

1. Add `is_deleted` boolean flag to FileBase class and database schema
2. Modify file scanner to check for backups before removing File records
3. Keep deleted files in database until backup is deleted
4. Detect new files during scanning and flag them for approval
5. Keep new files flagged for approval until they are approved

## Implementation Details

### Files to Modify

- `libocfiles/FileBase.vala` - Add `is_deleted` boolean property and database column
- `libocfiles/Folder.vala` - Modify `read_dir_remove()` to check for backups
- `libocfiles/ProjectFiles.vala` - Modify `update_from()` to check for backups

### is_deleted Flag

- Add `is_deleted` boolean property to `FileBase` class (default: false)
- Add `is_deleted INTEGER NOT NULL DEFAULT 0` column to `filebase` table in `FileBase.initDB()`
- Add migration to add column to existing databases
- Update `FileBase.copyTo()` to copy `is_deleted` flag

### File Scanner Updates

- **Folder.read_dir_remove()**:
  - Before removing: Check if `file.is_deleted == true` OR if `file.last_approved_copy_path` exists and file exists at that path
  - Only remove File record if `is_deleted == false` AND both original file AND backup don't exist
  - Keep File record if `is_deleted == true` OR if backup exists (allows restoration)

- **Folder.read_dir_update()**:
  - When new file is detected (`old_item == null`): Set `needs_approval = true` for new File objects
  - New files should be flagged for approval until user explicitly approves them
  - This allows tracking of files that appeared on disk but haven't been reviewed/approved yet

- **ProjectFiles.update_from()**:
  - Before removing: Check if `project_file.file.is_deleted == true` OR if `project_file.file.last_approved_copy_path` exists and file exists at that path
  - Only remove ProjectFile if `is_deleted == false` AND both original file AND backup don't exist
  - Keep ProjectFile if `is_deleted == true` OR if backup exists (allows restoration)
  - When adding new files: Set `needs_approval = true` for newly discovered files

## Implementation Tasks

- [ ] Add `is_deleted` flag to `FileBase`:
  - [ ] Add `is_deleted` boolean property to `FileBase` class (default: false)
  - [ ] Add `is_deleted INTEGER NOT NULL DEFAULT 0` column to `filebase` table in `FileBase.initDB()`
  - [ ] Add migration to add column to existing databases
  - [ ] Update `FileBase.copyTo()` to copy `is_deleted` flag
- [ ] Modify `Folder.read_dir_remove()` to check if backup exists or `is_deleted` flag before removing File record
- [ ] Modify `Folder.read_dir_update()` to detect new files and set `needs_approval = true`:
  - [ ] When `old_item == null` (new file detected), check if it's a File object
  - [ ] Set `needs_approval = true` for new File objects before saving to database
- [ ] Modify `ProjectFiles.update_from()`:
  - [ ] Check if backup exists or `is_deleted` flag before removing ProjectFile
  - [ ] When adding new files, set `needs_approval = true` for newly discovered files
- [ ] Test file scanner behavior with deleted files that have backups
- [ ] Test file scanner behavior with deleted files that don't have backups
- [ ] Test file scanner behavior with `is_deleted` flag set
- [ ] Test file scanner behavior with new files (should set `needs_approval = true`)
- [ ] Test that new files remain flagged for approval until explicitly approved

## Testing

- Test file scanner with deleted files that have backups (should keep File record)
- Test file scanner with deleted files that don't have backups (should remove File record)
- Test file scanner with `is_deleted` flag set (should keep File record)
- Test database migration for `is_deleted` column
- Test file scanner with new files appearing on disk (should set `needs_approval = true`)
- Test that new files remain flagged for approval until user approves them
- Test that approved new files have `needs_approval = false` after approval

## Notes

- Deleted files are kept in database until backup is deleted
- This allows restoration of deleted files from backups
- File scanner only removes File records when both file and backup don't exist
- New files detected during scanning are automatically flagged with `needs_approval = true`
- This allows tracking of files that appeared on disk but haven't been reviewed/approved yet
- New files remain flagged for approval until user explicitly approves them (sets `needs_approval = false`)

