# 2.6.1.8. Integrate Change System

## Overview

Integrate the FileHistory system (from 2.6.1.7) with runcommand, overlay, editmode, and filebase. This phase connects the file change history tracking to the actual file operations.

## Status

â³ **PLANNING** - Design phase. Working out details in planning.

## Prerequisites

- Phase 1 (2.6.1.7) must be completed - FileHistory class and database table must exist
- See main plan: `2.6.1-code-exec-improvements.md` for context

## Goals

1. Integrate FileHistory with `liboctools/RunCommand/Monitor.vala` - Record file changes in history table
2. Integrate FileHistory with `liboctools/RunCommand/Overlay.vala` - Process file changes from history table
3. Remove `backup_path` from filebase table
4. Update editmode to use FileHistory
5. Ensure all file changes (command execution and edit file actions) are tracked in FileHistory

## Implementation Details

### Integration Points

**1. RunCommand/Monitor Integration**
- Monitor tracks changes in HashMaps as before (no FileHistory creation in Monitor)
- Add timestamp tracking to Monitor (set when monitoring starts)
- FileHistory objects are created later in Overlay when processing changes

**2. RunCommand/Overlay Integration**
- Create FileHistory objects when processing Monitor changes (in copy_files())
- Call `commit()` on each FileHistory object to create backups and store in database
- Use same timestamp for all changes in the same command execution (from monitor.command_timestamp)
- Apply changes after FileHistory tracking is complete
- Remove direct backup creation (now handled by FileHistory.commit())

**3. EditMode Integration**
- When edit file tool makes changes, create FileHistory objects
- Track edits in the same history system as command execution

**4. FileBase Changes**
- Remove `is_deleted` flag from FileBase (deletion tracking moved to FileHistory)
- Remove `last_approved_copy_path` from FileBase (backup paths moved to FileHistory.backup_path)
- Remove `File.create_backup()` method (backup creation moved to FileHistory.commit())
- Migration: Move existing `last_approved_copy_path` values to file_history table if needed

## Detailed Breakdown by Component

### 1. Monitor.vala Changes

**Current Behavior:**
- Tracks changes in HashMaps: `added`, `removed`, `updated` (overlay_path => FileBase)
- Changes are detected via inotify events during command execution
- Changes are stored in memory only (not persisted)

**Required Changes:**

- **No changes needed** - Monitor stays exactly the same
- Monitor continues to track changes in HashMaps as before
- No FileHistory creation in Monitor - that happens later in Overlay when processing changes

**Key Implementation Notes:**
- Monitor stays essentially the same - it just tracks changes in HashMaps as before
- No FileHistory creation in Monitor - that happens later in Overlay when processing changes
- Database access is available via `project_folder.manager.db` when needed

**Files to Modify:**
- `liboctools/RunCommand/Monitor.vala` - No changes needed

### 2. Overlay.vala Changes

**Current Behavior:**
- `copy_files()` method directly copies files from overlay to real filesystem
- Processes Monitor change lists (`monitor.added`, `monitor.updated`, `monitor.removed`)
- Creates backups via `file.create_backup()` for modified/deleted files
- Immediately applies all changes to filesystem

**Required Changes:**

1. **Set timestamp when processing starts:**
   - In `copy_files()`, at the start (after stopping monitor), set timestamp:
     - Add private field `int64 command_timestamp { get; private set; default = 0; }` to Overlay class
     - Set `this.command_timestamp = GLib.DateTime.now_local().to_unix()` at start of `copy_files()`
     - This timestamp will be used for all FileHistory records created during this processing session

2. **Create FileHistory objects in each handler method:**
   - At the start of each handler method, before processing the change:
     - **`file_removed()`**: Create FileHistory with `change_type = "deleted"`, `filebase_id = file.id`, `base_type = "f"`
     - **`folder_removed()`**: Create FileHistory with `change_type = "deleted"`, `filebase_id = folder.id`, `base_type = "d"`
     - **`file_updated()`**: Create FileHistory with `change_type = "modified"`, `filebase_id = file.id`, `base_type = "f"`
     - **`file_added()`**: Create FileHistory with `change_type = "added"`, `filebase_id = 0` (new files), `base_type = "f"`
     - **`folder_added()`**: Create FileHistory with `change_type = "added"`, `filebase_id = 0` (new folders), `base_type = "d"`
   - For all handlers:
     - Get timestamp from `this.command_timestamp` (set when copy_files() started)
     - Get database from `this.project.manager.db`
     - Create FileHistory object with appropriate parameters
     - Call `commit()` async (creates backup if needed, stores in database)
     - Wait for `commit()` to complete (yield) before proceeding with the change
   - This keeps FileHistory creation close to where the change is processed, no separate loop needed

2. **Remove direct backup creation:**
   - Remove calls to `file.create_backup()` in `file_updated()` and `file_removed()`
   - Backups are now created by FileHistory.commit() at the start of each handler

3. **Status and approval:**
   - All changes are applied immediately (status = 0, pending)
   - No approval workflow in this ticket - that's a separate ticket/issue
   - FileHistory records are created for tracking/audit purposes

**Key Implementation Notes:**
- Timestamp is set in Overlay.copy_files() when processing starts (not in Monitor)
- FileHistory objects are created at the start of each handler method (file_removed, folder_removed, file_updated, file_added, folder_added)
- All FileHistory records for same command execution use same timestamp (from this.command_timestamp in Overlay)
- Backups are created by FileHistory.commit() BEFORE files are modified/deleted (for "modified" and "deleted")
- For "added" files, no backup needed (backup_path = "")
- Ignored files are automatically filtered by FileHistory.commit() (checks `is_ignored`)
- Changes are applied immediately after FileHistory tracking (no approval workflow - that's a separate ticket)
- `copy_files()` method structure stays the same - it already calls the handler methods in the right order

**Files to Modify:**
- `liboctools/RunCommand/Overlay.vala` - Add FileHistory creation at start of each handler method, remove create_backup() calls

### 3. EditMode/Request.vala Changes

**Current Behavior:**
- `apply_all_changes()` directly applies edits to files using buffer operations
- `apply_edits()` uses `file.buffer.apply_edits()` to modify file
- `create_new_file_with_changes()` uses `file.buffer.write()` to create/overwrite file
- No backup or history tracking (backups handled by buffer system)

**Required Changes:**

1. **Create FileHistory objects before applying changes:**
   - In `apply_all_changes()`, before calling `apply_edits()` or `create_new_file_with_changes()`:
     - Get or create File object
     - Determine change type:
       - If file doesn't exist: `change_type = "added"`
       - If file exists and `complete_file = true`: `change_type = "modified"` (overwrite)
       - If file exists and `complete_file = false`: `change_type = "modified"` (edits)
     - Create FileHistory object with:
       - `change_type` as determined above
       - `timestamp = GLib.DateTime.now_local().to_unix()` (same for all changes in this edit session)
       - `filebase_object = file` (or create fake FileBase if new file)
     - Call `commit()` async (creates backup if needed, stores in database)

2. **Apply changes after FileHistory.commit():**
   - After FileHistory.commit() completes, proceed with current logic:
     - Call `apply_edits()` or `create_new_file_with_changes()` as before
     - Changes are now tracked in FileHistory

3. **Single file only:**
   - EditMode only handles a single file per edit session
   - File is either created (if doesn't exist) or edited (if exists)
   - EditMode never deletes files (use run command for that)
   - Only one FileHistory record per edit session (one file, one change)

4. **Status handling:**
   - FileHistory records created by EditMode start with `status = 0` (pending)
   - Changes are applied immediately (no approval workflow - that's a separate ticket)

**Key Implementation Notes:**
- FileHistory.commit() creates backup BEFORE file is modified (for "modified" changes)
- For "added" files, no backup needed (backup_path = "")
- EditMode only handles single file - either created or edited, never deleted
- Changes are applied immediately (no approval workflow - that's a separate ticket/issue)
- All changes use same timestamp for the edit session

**Files to Modify:**
- `liboctools/EditMode/Request.vala`

### 4. FileBase.vala Changes - Remove Fields

**Current State:**
- `is_deleted` flag exists in FileBase (property and database column)
- `last_approved_copy_path` exists in FileBase (property and database column)
- `backup_path` does NOT exist in FileBase (only in FileHistory)

**Required Removals:**

1. **Remove `is_deleted` flag:**
   - **Property**: Remove `public bool is_deleted { get; set; default = false; }` from FileBase class
   - **Database column**: Remove `"is_deleted INTEGER NOT NULL DEFAULT 0, "` from CREATE TABLE statement
   - **Migration**: Add migration to drop column from existing databases (or leave it, just stop using it)
   - **copy_db_fields_to()**: Remove `target.is_deleted = this.is_deleted;` line
   - **Usage in Overlay.vala**: Remove `filebase.is_deleted = true;` in `copy_files()` method
   - **Rationale**: Deletion tracking is now handled by FileHistory table (change_type="deleted"). Deleted files are removed from filebase table entirely, and their history is tracked in file_history table.

2. **Remove `last_approved_copy_path` field:**
   - **Property**: Remove `public string last_approved_copy_path { get; set; default = ""; }` from FileBase class
   - **Database column**: Remove `"last_approved_copy_path TEXT NOT NULL DEFAULT '', "` from CREATE TABLE statement
   - **Migration**: Add migration to drop column from existing databases (or migrate values to file_history table if needed)
   - **copy_db_fields_to()**: Remove `target.last_approved_copy_path = this.last_approved_copy_path;` line
   - **Usage in File.vala**: Remove `this.last_approved_copy_path = backup_path;` in `create_backup()` method
   - **Usage in FileAlias.vala**: Remove `last_approved_copy_path` property override (delegates to points_to)
   - **Rationale**: Backup paths are now stored in FileHistory.backup_path. The filebase table should only track current state, not backup locations.

3. **Remove `File.create_backup()` method:**
   - **Method**: Remove entire `public async void create_backup()` method from File class
   - **Includes removal of**:
     - Local `backup_path` variable (line 595 in File.vala)
     - Backup path building logic (lines 595-602)
     - Backup file creation/copying logic (lines 604-627)
     - Assignment to `this.last_approved_copy_path` (line 630)
     - Database save call (lines 632-635)
   - **Usage locations to remove**:
     - `Overlay.vala` line 279 - Remove `yield file.create_backup();` in `file_updated()` method (backup now created by FileHistory in Monitor)
     - `Overlay.vala` line 412 - Remove `yield file.create_backup();` in `file_removed()` method (backup now created by FileHistory in Monitor)
     - `FileBuffer.vala` line 367 - Remove `yield this.file.create_backup();` call in `write_real()` method (backup now created by FileHistory before edits are applied)
   - **Rationale**: All backup creation is now handled by FileHistory.commit(), which builds backup_path internally and stores it in FileHistory.backup_path

**Migration Strategy:**

1. **For `is_deleted` flag:**
   - Option A: Drop column entirely (cleanest)
   - Option B: Keep column but stop using it (safer, allows rollback)
   - Recommendation: Drop column after confirming FileHistory integration works

2. **For `last_approved_copy_path`:**
   - Before dropping: Query all files with non-empty `last_approved_copy_path`
   - For each file, check if there's a corresponding FileHistory record
   - If no FileHistory record exists, create one with:
     - `change_type = "modified"` (assume it was a modification)
     - `backup_path = last_approved_copy_path`
     - `status = 0` (pending) or `1` (approved) - user decision
     - `timestamp = file.last_modified` or current time
   - After migration, drop column

**Files to Modify:**
- `libocfiles/FileBase.vala` - Remove `is_deleted` and `last_approved_copy_path` properties, database columns, and copy logic
- `libocfiles/File.vala` - Remove entire `create_backup()` method (including all backup_path logic inside it) and `last_approved_copy_path` usage
- `libocfiles/FileAlias.vala` - Remove `last_approved_copy_path` property override
- `libocfiles/FileBuffer.vala` - Remove `yield this.file.create_backup();` call in `write_real()` method
- `liboctools/RunCommand/Overlay.vala` - Remove `is_deleted = true` assignment and `yield file.create_backup();` calls

**Key Implementation Notes:**
- Deleted files are now tracked in FileHistory table, not filebase table
- Backup paths are now stored in FileHistory.backup_path, not FileBase.last_approved_copy_path
- FileBase table should only contain current filesystem state
- FileHistory table contains change history and backup information

### 5. Additional Considerations

**Timestamp Matching:**
- Overlay sets `command_timestamp` when copy_files() starts processing changes
- Overlay uses `this.command_timestamp` for all FileHistory records created during that processing session
- All FileHistory records for same command execution share the same timestamp
- EditMode uses current timestamp for all changes in same edit session

**Rename Support (moved_to/moved_from):**
- Not currently supported - would require additional tracking in Monitor to correlate MOVED events
- For now, renames are tracked as separate "deleted" and "added" events
- FileHistory has moved_to/moved_from fields but they are not populated (removed from constructor)
- See FileHistory.vala comments for details - this is a future enhancement

**Approval Workflow:**
- Not part of this ticket - that's a separate ticket/issue
- All changes are applied immediately (status = 0, pending)
- FileHistory records are created for tracking/audit purposes

## Summary of Changes

**Monitor.vala:**
- No changes needed - Monitor stays exactly the same
- Monitor continues to track changes in HashMaps as before

**Overlay.vala:**
- Set timestamp at start of copy_files() when processing changes
- Create FileHistory objects at start of each handler method (file_removed, folder_removed, file_updated, file_added, folder_added)
- Call commit() on each FileHistory to create backups and store in database
- Remove direct backup creation calls
- Apply changes after FileHistory tracking is complete

**EditMode:**
- Create FileHistory objects before applying edits
- Call commit() to create backups and store in database
- Apply changes after FileHistory tracking is complete

## Summary of FileBase Removals

**Fields to Remove from FileBase:**

1. **`is_deleted` (bool)** - Deletion tracking moved to FileHistory table
   - Property, database column, copy logic, and all usages

2. **`last_approved_copy_path` (string)** - Backup paths moved to FileHistory.backup_path
   - Property, database column, copy logic, and all usages

3. **`File.create_backup()` method** - Backup creation moved to FileHistory.commit()
   - Entire method including all backup_path logic inside it (local variable, path building, file copying)
   - All usages: Overlay.vala (2 calls), FileBuffer.vala (1 call)

**Migration Required:**
- Migrate existing `last_approved_copy_path` values to FileHistory records before dropping column
- Drop `is_deleted` column (or leave unused for rollback safety)

## Files to Modify

- `liboctools/RunCommand/Monitor.vala` - No changes needed
- `liboctools/RunCommand/Overlay.vala` - Add timestamp property, set it at start of copy_files(), create FileHistory objects at start of each handler method, remove `create_backup()` calls and `is_deleted` usage
- `liboctools/EditMode/Request.vala` - Create FileHistory objects before applying edits
- `libocfiles/FileHistory.vala` - Add comments noting moved_to/moved_from are not supported yet
- `libocfiles/FileBase.vala` - Remove `is_deleted` and `last_approved_copy_path` fields, database columns, and copy logic
- `libocfiles/File.vala` - Remove `create_backup()` method and `last_approved_copy_path` usage
- `libocfiles/FileAlias.vala` - Remove `last_approved_copy_path` property override
- `libocfiles/FileBuffer.vala` - Remove `yield this.file.create_backup();` call

## Notes

- This phase depends on 2.6.1.7 being complete
- Monitor stays exactly the same - no changes needed
- Timestamp is set in Overlay when copy_files() starts processing changes
- FileHistory objects are created in Overlay when processing changes, not in Monitor
- EditMode handles single file only (create or edit, never delete)
- Rename tracking (moved_to/moved_from) is not supported yet - future enhancement
- All changes are applied immediately (no approval workflow - that's a separate ticket)
- This is a significant integration effort that will touch multiple subsystems
