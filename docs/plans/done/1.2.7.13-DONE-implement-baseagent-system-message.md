# 1.2.7.13. Implement BaseAgent.system_message() Method

## Overview

Currently `CodeAssistantHandler.send_async()` uses `agent.fill(this.chat, "")` to get system prompt. This is a workaround - should use dedicated `system_message()` method.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md)

## Status

✅ **DONE** - Implemented `system_message()` method and removed deprecated `fill()` method.

## Goal

Implement proper `system_message()` method for agents to generate system prompts with context.

## Issue

Currently `CodeAssistantHandler.send_async()` uses `agent.fill(this.chat, "")` to get system prompt. This is a workaround - should use dedicated `system_message()` method.

## Current State

- `BaseAgent.system_message(AgentHandler handler)` exists as placeholder that returns empty string
- `CodeAssistantHandler.send_async()` calls `this.agent.system_message(this)` which currently returns empty string
- CodeAssistant needs to override this to generate system prompt with current context

## Proposed Implementation

- `BaseAgent.system_message()` - Default returns empty string (for simple agents like JustAsk)
- `CodeAssistant.system_message()` - Override to generate system prompt with current context (open files, workspace, etc.)
- Method receives `AgentHandler` so it can access `handler.session`, `handler.client`, etc.

## Proposed Solution: Rename generate_system_prompt() to system_message()

Instead of having two separate methods, consolidate by renaming `generate_system_prompt()` to `system_message()` with optional handler parameter.

### Changes Required

1. **BaseAgent.system_message()** - Rename from `generate_system_prompt()`, make handler optional:
   ```vala
   public virtual string system_message(OLLMchat.Prompt.AgentHandler? handler = null) throws GLib.Error
   {
       return "";
   }
   ```
   Note: Keep `throws GLib.Error` since `fill()` and `AgentHandler.send_async()` already handle errors.

2. **CodeAssistant.system_message()** - Override to generate system prompt:
   ```vala
   public override string system_message(OLLMchat.Prompt.AgentHandler? handler = null) throws GLib.Error
   {
       // Generate the full system prompt
       // This includes: introduction, communication rules, tool calling,
       // search/reading rules, code changes rules, debugging, external APIs,
       // user info (OS, workspace, shell), and citation format
       return this.generate_introduction() + "\n\n" +
           "<communication>\n" +
           this.load_section("communication") +
           "\n</communication>\n\n" +
           this.load_section("tool_calling") + "\n\n" +
           "<search_and_reading>\n" +
           this.load_section("search_and_reading") +
           "\n</search_and_reading>\n\n" +
           "<making_code_changes>\n" +
           this.load_section("making_code_changes") +
           "\n</making_code_changes>\n\n" +
           this.load_section("debugging") + "\n\n" +
           this.load_section("calling_external_apis") + "\n\n" +
           this.generate_user_info_section() + "\n\n" +
           this.load_section("citation_format");
   }
   ```
   Note: This is the same logic currently in `CodeAssistant.generate_system_prompt()`, just moved to `system_message()`.

3. **Update callers**:
   - `BaseAgent.fill()`: Change `this.generate_system_prompt()` → `this.system_message(null)`
   - `AgentHandler.send_async()`: Change `this.agent.generate_system_prompt()` → `this.agent.system_message(null)`
   - `CodeAssistantHandler.send_async()`: Already calls `this.agent.system_message(this)` ✓

4. **Remove old method**: Delete `generate_system_prompt()` after all callers updated

### Notes

- Handler parameter is optional - existing code without handler can pass `null`
- `CodeAssistant` can keep its existing `generate_system_prompt()` implementation and call it from `system_message()`
- Error handling: `system_message()` should throw `Error` (like `generate_system_prompt()` does) since callers already handle it
- Context data (current_file, attached_files, selected_code) remains in user prompt via `generate_user_prompt()`

## Action

Implement `CodeAssistant.system_message()` override during 1.2.7 cleanup to properly generate system prompt with current context.

## Files to Modify

- `libollmchat/Prompt/BaseAgent.vala` - Ensure `system_message()` method exists
- `liboccoder/Prompt/CodeAssistant.vala` - Override `system_message()` to generate system prompt

## Testing Checklist

- [x] `BaseAgent.system_message()` method works correctly
- [x] `CodeAssistant.system_message()` generates system prompt with context
- [x] All functionality still works correctly after cleanup

## Implementation Notes

- Updated `BaseAgent.system_message()` to make handler parameter optional (`handler = null`)
- Added `throws GLib.Error` to `system_message()` signature
- Overrode `CodeAssistant.system_message()` in both `libollmchat` and `liboccoder` namespaces
- Updated `BaseAgent.fill()` to use `system_message(null)` (then removed `fill()` entirely)
- Updated `AgentHandler.send_async()` to use `system_message(null)`
- Removed deprecated `generate_system_prompt()` method from `BaseAgent` and both `CodeAssistant` classes
- Removed deprecated `fill()` method from `BaseAgent` (no longer used in codebase)
- Updated documentation examples to use new `system_message()` pattern

## Related Plans

- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md) - Parent plan
- [1.2.7.8. Cleanup Items](./1.2.7.8-cleanup-items.md) - Related cleanup item

