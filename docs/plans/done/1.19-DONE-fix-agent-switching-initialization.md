# Fix Agent Switching Initialization

## Status

✅ **DONE** - Fix startup flow to set default model before creating history manager.

## Problem

When switching agents, the application crashes with "Model is required" error at `Chat.vala:182`. The `default_model_usage.model` is empty, which gets copied to `EmptySession.model_usage`, causing Chat constructor to fail.

## Root Cause

**Startup flow issue**: The history manager is created before the default model is set in config.

**Current Flow (WRONG)**:
1. Check connections ✓
2. Create history manager (line 333) - **TOO EARLY, gets empty model from config**
3. Update default_model_usage connection (line 337-343)
4. Call ensure_model_usage() (line 351) - only verifies, doesn't set

The config's `default_model` starts with `model = ""` (created during bootstrap), and this empty model gets copied to `Manager.default_model_usage` when the history manager is created.

## Solution

Fix the startup flow in `initialize_unverified_client()` to ensure default model is set BEFORE creating history manager.

**Correct Flow**:
1. Check connections - see if any are working ✓
2. **Check if configured default model is set** - if empty, find first available model from working connection, set it in config, save config
3. **THEN create history manager** - which can use the default_model_usage from config that has now been updated

## Implementation

In `ollmapp/Window.vala`, in `initialize_unverified_client()`, BEFORE creating history manager (before line 333):

1. Get `default_model` from `config.usage.get("default_model")`
2. If `default_model.model == ""`:
   - Create temporary `ConnectionModels` instance with config
   - Refresh it to load models from working connection
   - Find first available model for the working connection
   - Set `default_model.model = first_model.model`
   - Set `default_model.connection = working_conn.url` (if not already set)
   - Save config so it persists
3. THEN create history manager (which will get the updated default_model_usage from config)
4. THEN call ensure_model_usage() to verify the model exists

## Files to Modify

- `ollmapp/Window.vala` - Fix startup flow in `initialize_unverified_client()` (around line 330)

## Related Plans

- [1.17-migrate-to-v1-model-api.md](./1.17-migrate-to-v1-model-api.md) - Model API migration
- [1.18-fix-background-scanner-not-starting.md](./1.18-fix-background-scanner-not-starting.md) - Agent initialization issues
