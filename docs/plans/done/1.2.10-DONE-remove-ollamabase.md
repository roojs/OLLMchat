# 1.2.10 Remove OllamaBase and Rename OllamaError to OllmError

## Overview

Remove the `OllamaBase` class and move its functionality directly into `Call.Base` and `Response.Base`. This simplifies the inheritance hierarchy since `OllamaBase` is only used by these two classes and doesn't provide significant abstraction value. Also rename `OllamaError` to `OllmError` for consistency with the project naming.

**Parent Plan**: [1.2. Refactor Client and Chat Relationship](./1.2-DONE-refactor-client-chat-relationship.md)

## Status

✅ **DONE** - Implementation complete.

## Goal

1. Eliminate the `OllamaBase` intermediate class by moving its functionality directly into `Call.Base` and `Response.Base`. This reduces the inheritance depth and makes the code structure clearer.
2. Rename `OllamaError` errordomain to `OllmError` for consistency with project naming conventions.

## Current State

`OllamaBase` is a base class that provides:
1. `connection` property - Used by `Call.Base` for making API requests and by `Response.Model` for caching
2. `chat_content` property - Used by `Call.Chat` and `Client` for storing user input text
3. `Json.Serializable` interface implementation - Required for JSON serialization/deserialization
4. Serialization helpers - `find_property`, `set_property`, `get_property`, `serialize_property`, `deserialize_property`

**Inheritance Chain**:
- `OllamaBase` → `Call.Base` → All Call classes (Chat, Embed, Models, etc.)
- `OllamaBase` → `Response.Base` → All Response classes (Chat, Model, Embed, etc.)

## Analysis

### Usage of OllamaBase Properties

1. **`connection` property**:
   - Used extensively in `Call.Base` (build_url, send_request, handle_streaming_response)
   - Used in `Response.Model` (line 414) for setting connection on cached models
   - Not used in other Response classes

2. **`chat_content` property**:
   - Used in `Call.Chat` (inherited from `Call.Base`)
   - Used in `Client.vala` (lines 138-139, 143)
   - Overridden in `Response.Chat` (implements `ChatContentInterface`)
   - Not used in other Call or Response classes

3. **`Json.Serializable` interface**:
   - Required by `Call.Base` for `Json.gobject_serialize(this)` in `get_request_body()` (line 100)
   - Required by `Response.Base` for deserializing API responses
   - Both need the serialization helpers

### Can OllamaBase Be Removed?

**Yes**, with the following changes:

1. Move `connection` property to both `Call.Base` and `Response.Base`
2. Move `chat_content` property to `Call.Base` only (since it's only used by Call classes)
3. Move `Json.Serializable` implementation to both `Call.Base` and `Response.Base`
4. Move serialization helper methods to both classes
5. Update `Response.Model` to access `connection` from `Response.Base` instead of `OllamaBase`

## Implementation Steps

### Step 1: Add Connection Property to Response.Base

**File**: [`libollmchat/Response/Base.vala`](libollmchat/Response/Base.vala)

**Changes**:
1. Add `connection` property
2. Update constructor to accept and store `connection`
3. Change inheritance from `OllamaBase` to `Object, Json.Serializable`

```vala
public abstract class Base : Object, Json.Serializable
{
    public Settings.Connection? connection { get; set; }
    protected string id = "";
    public Message? message { get; set; default = null; }

    protected Base(Settings.Connection? connection = null)
    {
        this.connection = connection;
    }
    
    // Add Json.Serializable implementation methods...
}
```

### Step 2: Move Json.Serializable Implementation to Response.Base

**File**: [`libollmchat/Response/Base.vala`](libollmchat/Response/Base.vala)

**Changes**: Add all Json.Serializable methods from OllamaBase:
- `find_property`
- `Json.Serializable.set_property`
- `Json.Serializable.get_property`
- `serialize_property` (exclude `connection` from serialization)
- `deserialize_property`

**Implementation** (copy from OllamaBase.vala lines 43-72):
```vala
public unowned ParamSpec? find_property(string name)
{
    return this.get_class().find_property(name);
}

public new void Json.Serializable.set_property(ParamSpec pspec, Value value)
{
    base.set_property(pspec.get_name(), value);
}

public new Value Json.Serializable.get_property(ParamSpec pspec)
{
    Value val = Value(pspec.value_type);
    base.get_property(pspec.get_name(), ref val);
    return val;
}

public virtual Json.Node serialize_property(string property_name, Value value, ParamSpec pspec)
{
    // Block connection from serialization - it's an internal reference, not API data
    if (property_name == "connection") {
        return null;
    }
    return default_serialize_property(property_name, value, pspec);
}

public virtual bool deserialize_property(string property_name, out Value value, ParamSpec pspec, Json.Node property_node)
{
    return default_deserialize_property(property_name, out value, pspec, property_node);
}
```

### Step 3: Add Connection and Chat Content to Call.Base

**File**: [`libollmchat/Call/Base.vala`](libollmchat/Call/Base.vala)

**Changes**:
1. Add `connection` property (currently inherited from OllamaBase)
2. Add `chat_content` property (currently inherited from OllamaBase)
3. Update constructor to accept and store `connection`
4. Change inheritance from `OllamaBase` to `Object, Json.Serializable`

```vala
public abstract class Base : Object, Json.Serializable
{
    public Settings.Connection? connection { get; set; }
    public string chat_content { get; set; default = ""; }
    protected string url_endpoint;
    // ... rest of class
}
```

### Step 4: Move Json.Serializable Implementation to Call.Base

**File**: [`libollmchat/Call/Base.vala`](libollmchat/Call/Base.vala)

**Changes**: Add all Json.Serializable methods from OllamaBase:
- `find_property`
- `Json.Serializable.set_property`
- `Json.Serializable.get_property`
- `serialize_property` (exclude `connection`, `chat_content`, `cancellable`, `streaming_response`)
- `deserialize_property`

**Implementation**: 
1. Add the base Json.Serializable methods (same as Response.Base)
2. Update the existing `serialize_property` method (line 106) to use `default_serialize_property` instead of `base.serialize_property`:

```vala
public unowned ParamSpec? find_property(string name)
{
    return this.get_class().find_property(name);
}

public new void Json.Serializable.set_property(ParamSpec pspec, Value value)
{
    base.set_property(pspec.get_name(), value);
}

public new Value Json.Serializable.get_property(ParamSpec pspec)
{
    Value val = Value(pspec.value_type);
    base.get_property(pspec.get_name(), ref val);
    return val;
}

public override Json.Node serialize_property(string property_name, Value value, ParamSpec pspec)
{
    switch (property_name) {
        case "chat-content":
        case "connection":
        case "cancellable":
        case "streaming-response":
            // Exclude these properties from serialization
            return null;
        default:
            // Changed from base.serialize_property to default_serialize_property
            return default_serialize_property(property_name, value, pspec);
    }
}

public virtual bool deserialize_property(string property_name, out Value value, ParamSpec pspec, Json.Node property_node)
{
    return default_deserialize_property(property_name, out value, pspec, property_node);
}
```

**Note**: The existing `serialize_property` method (line 106) calls `base.serialize_property` which will no longer exist. Change it to `default_serialize_property`.

### Step 5: Update Response.Model Connection Usage

**File**: [`libollmchat/Response/Model.vala`](libollmchat/Response/Model.vala)

**Changes**: No changes needed - `this.connection` will now come from `Response.Base` instead of `OllamaBase`.

### Step 6: Remove OllamaBase

**Files to modify**:
1. [`libollmchat/OllamaBase.vala`](libollmchat/OllamaBase.vala) - Delete file
2. [`libollmchat/meson.build`](libollmchat/meson.build) - Remove `OllamaBase.vala` from source list (line 48)
3. [`libollmchat/namespace.vala`](libollmchat/namespace.vala) - Remove any references to OllamaBase

**Note**: The `OllamaError` errordomain is defined in `OllamaBase.vala` but is used throughout the codebase. We need to move it to a separate file and rename it to `OllmError`.

### Step 7: Create OllmError File and Rename All References

**File**: Create [`libollmchat/OllmError.vala`](libollmchat/OllmError.vala)

**Content**:
```vala
namespace OLLMchat
{
    public errordomain OllmError {
        INVALID_ARGUMENT,
        FAILED
    }
}
```

**Update**: [`libollmchat/meson.build`](libollmchat/meson.build) - Add `OllmError.vala` to source list (before other files that use it, should be early in the list)

**Rename all references**: Search and replace `OllamaError` with `OllmError` in all files:
- `libollmchat/Client.vala` - 4 occurrences
- `libollmchat/History/Session.vala` - 3 occurrences
- `libollmchat/History/EmptySession.vala` - 1 occurrence
- `libollmchat/Call/Base.vala` - 15 occurrences
- `libollmchat/Call/Chat.vala` - 3 occurrences
- `libollmchat/Call/Version.vala` - 2 occurrences
- `libollmchat/Call/Pull.vala` - 1 occurrence
- `libollmchat/Call/Embed.vala` - 3 occurrences
- `libollmchat/Call/Generate.vala` - 2 occurrences
- `libollmchat/Call/ShowModel.vala` - 3 occurrences
- `libollmchat/History/Manager.vala` - 1 occurrence
- `libollmchatgtk/ChatWidget.vala` - 3 occurrences (catch blocks and type checks)

**Total**: ~40 occurrences across 12 files

### Step 8: Update base.serialize_property and base.deserialize_property Calls

Several classes call `base.serialize_property` or `base.deserialize_property` which will need to be updated after removing OllamaBase:

**Files that call `base.serialize_property`**:
- `libollmchat/Call/Base.vala` (line 116) - Will need to change to `default_serialize_property`
- `libollmchat/Call/Chat.vala` (line 317) - Will need to change to `default_serialize_property`
- `libollmchat/Call/Embed.vala` (lines 76, 85, 104) - Will need to change to `default_serialize_property`
- `libollmchat/Call/Generate.vala` (line 104) - Will need to change to `default_serialize_property`
- `libollmchat/Response/Chat.vala` (line 124) - Will need to change to `default_serialize_property`
- `libollmchat/Response/Embed.vala` (line 66) - Will need to change to `default_serialize_property`
- `libollmchat/Response/Generate.vala` (lines 57, 59) - Will need to change to `default_serialize_property`
- `libollmchat/Response/Model.vala` (line 263) - Will need to change to `default_serialize_property`
- `libollmchat/Tool/ParamArray.vala` (line 82) - Will need to change to `default_serialize_property`
- `libollmchat/Tool/ParamObject.vala` (line 107) - Will need to change to `default_serialize_property`

**Files that call `base.deserialize_property`**:
- `libollmchat/Response/Embed.vala` (line 98) - Will need to change to `default_deserialize_property`

**Note**: These changes are necessary because after removing OllamaBase, `Call.Base` and `Response.Base` will inherit directly from `Object, Json.Serializable`, so `base.serialize_property` will refer to `Object`'s implementation (which doesn't exist), not OllamaBase's implementation. We should use `default_serialize_property` and `default_deserialize_property` instead.

## Rationale

1. **Simpler Inheritance**: Removing an intermediate base class reduces complexity
2. **Clearer Ownership**: Properties are now directly in the classes that use them
3. **No Shared State**: `Call.Base` and `Response.Base` don't share much common functionality beyond JSON serialization
4. **Better Encapsulation**: `chat_content` is only needed by Call classes, so it belongs in `Call.Base`

## Deep Dive Analysis

### Code References to OllamaBase

**Direct inheritance** (will be changed):
- `libollmchat/Call/Base.vala` - Line 29: `public abstract class Base : OllamaBase`
- `libollmchat/Response/Base.vala` - Line 28: `public abstract class Base : OllamaBase`

**No type checks or casts**: No code uses `is OllamaBase`, `as OllamaBase`, or `typeof(OllamaBase)`, so no type checking code needs updating.

**Documentation references**: All references are in generated HTML documentation (`docs/ollmchat/`) which will be regenerated after the change.

**Plan references**: `docs/plans/1.2.3-DONE-update-call-base-connection.md` mentions OllamaBase but is a historical document.

### Code References to OllamaError

**Definition**: `libollmchat/OllamaBase.vala` - Line 21: `public errordomain OllamaError`

**Usage locations** (all need to be renamed to `OllmError`):
1. `libollmchat/Client.vala` - 4 throws
2. `libollmchat/History/Session.vala` - 3 throws
3. `libollmchat/History/EmptySession.vala` - 1 throw
4. `libollmchat/Call/Base.vala` - 15 throws (various error conditions)
5. `libollmchat/Call/Chat.vala` - 3 throws
6. `libollmchat/Call/Version.vala` - 2 throws
7. `libollmchat/Call/Pull.vala` - 1 throw
8. `libollmchat/Call/Embed.vala` - 3 throws
9. `libollmchat/Call/Generate.vala` - 2 throws
10. `libollmchat/Call/ShowModel.vala` - 3 throws (including method signature)
11. `libollmchat/History/Manager.vala` - 1 throw
12. `libollmchatgtk/ChatWidget.vala` - 3 occurrences (catch blocks: `catch (OLLMchat.OllamaError e)`, `if (e is OLLMchat.OllamaError.INVALID_ARGUMENT)`, `else if (e is OLLMchat.OllamaError.FAILED)`)

**Method signatures**: `Call.ShowModel.ShowModel()` has `throws OllamaError` in its signature (line 32).

### Serialization Method Dependencies

**Classes that override serialize_property/deserialize_property and call base methods**:
- These will break after removing OllamaBase because `base.serialize_property` will no longer exist
- Must change to `default_serialize_property` / `default_deserialize_property`

## Potential Issues

1. **OllmError Location**: Need to ensure `OllmError` is accessible after removing `OllamaBase` and renaming
2. **Serialization Consistency**: Both classes need identical serialization helper implementations
3. **Base Method Calls**: All `base.serialize_property` and `base.deserialize_property` calls need to be changed to `default_*` versions
4. **Documentation**: Update any documentation that references `OllamaBase` (mostly auto-generated HTML docs)
5. **Error Handling**: All catch blocks and error type checks need to be updated for `OllmError`

## Testing

1. **Compile**: Ensure the code compiles without errors
2. **API Calls**: Test all API call types (Chat, Embed, Models, Pull, etc.)
3. **Response Deserialization**: Test that all response types deserialize correctly
4. **Serialization**: Test that Call objects serialize correctly for API requests
5. **Connection Usage**: Verify `Response.Model` can still access `connection` for caching
6. **Chat Content**: Verify `Call.Chat` and `Client` can still access `chat_content`

## Files Modified

### Core Changes
- [`libollmchat/Response/Base.vala`](libollmchat/Response/Base.vala) - Add connection, Json.Serializable implementation, change inheritance
- [`libollmchat/Call/Base.vala`](libollmchat/Call/Base.vala) - Add connection, chat_content, Json.Serializable implementation, change inheritance, update serialize_property
- [`libollmchat/OllamaBase.vala`](libollmchat/OllamaBase.vala) - **DELETE**
- [`libollmchat/OllmError.vala`](libollmchat/OllmError.vala) - **CREATE** (move and rename errordomain here)
- [`libollmchat/meson.build`](libollmchat/meson.build) - Remove OllamaBase.vala, add OllmError.vala early in source list

### Error Rename (OllamaError → OllmError)
- [`libollmchat/Client.vala`](libollmchat/Client.vala) - Rename 4 occurrences
- [`libollmchat/History/Session.vala`](libollmchat/History/Session.vala) - Rename 3 occurrences
- [`libollmchat/History/EmptySession.vala`](libollmchat/History/EmptySession.vala) - Rename 1 occurrence
- [`libollmchat/Call/Base.vala`](libollmchat/Call/Base.vala) - Rename 15 occurrences
- [`libollmchat/Call/Chat.vala`](libollmchat/Call/Chat.vala) - Rename 3 occurrences
- [`libollmchat/Call/Version.vala`](libollmchat/Call/Version.vala) - Rename 2 occurrences
- [`libollmchat/Call/Pull.vala`](libollmchat/Call/Pull.vala) - Rename 1 occurrence
- [`libollmchat/Call/Embed.vala`](libollmchat/Call/Embed.vala) - Rename 3 occurrences
- [`libollmchat/Call/Generate.vala`](libollmchat/Call/Generate.vala) - Rename 2 occurrences
- [`libollmchat/Call/ShowModel.vala`](libollmchat/Call/ShowModel.vala) - Rename 3 occurrences (including method signature)
- [`libollmchat/History/Manager.vala`](libollmchat/History/Manager.vala) - Rename 1 occurrence
- [`libollmchatgtk/ChatWidget.vala`](libollmchatgtk/ChatWidget.vala) - Rename 3 occurrences (catch blocks)

### Serialization Method Updates (base.* → default_*)
- [`libollmchat/Call/Base.vala`](libollmchat/Call/Base.vala) - Change `base.serialize_property` to `default_serialize_property` (line 116)
- [`libollmchat/Call/Chat.vala`](libollmchat/Call/Chat.vala) - Change `base.serialize_property` to `default_serialize_property` (line 317)
- [`libollmchat/Call/Embed.vala`](libollmchat/Call/Embed.vala) - Change `base.serialize_property` to `default_serialize_property` (lines 76, 85, 104)
- [`libollmchat/Call/Generate.vala`](libollmchat/Call/Generate.vala) - Change `base.serialize_property` to `default_serialize_property` (line 104)
- [`libollmchat/Response/Chat.vala`](libollmchat/Response/Chat.vala) - Change `base.serialize_property` to `default_serialize_property` (line 124)
- [`libollmchat/Response/Embed.vala`](libollmchat/Response/Embed.vala) - Change `base.serialize_property` and `base.deserialize_property` to `default_*` (lines 66, 98)
- [`libollmchat/Response/Generate.vala`](libollmchat/Response/Generate.vala) - Change `base.serialize_property` to `default_serialize_property` (lines 57, 59)
- [`libollmchat/Response/Model.vala`](libollmchat/Response/Model.vala) - Change `base.serialize_property` to `default_serialize_property` (line 263)
- [`libollmchat/Tool/ParamArray.vala`](libollmchat/Tool/ParamArray.vala) - Change `base.serialize_property` to `default_serialize_property` (line 82)
- [`libollmchat/Tool/ParamObject.vala`](libollmchat/Tool/ParamObject.vala) - Change `base.serialize_property` to `default_serialize_property` (line 107)

## Notes

- This refactoring maintains all existing functionality while simplifying the class hierarchy
- The `OllmError` errordomain (renamed from `OllamaError`) must be accessible from all files that use it
- Both `Call.Base` and `Response.Base` will have duplicate serialization code, but this is acceptable since they don't share a common base class
- All `base.serialize_property`/`base.deserialize_property` calls must be changed to `default_serialize_property`/`default_deserialize_property` because `Object` doesn't provide these methods
- Consider creating a shared mixin or interface for serialization helpers if duplication becomes a concern in the future
- Documentation in `docs/ollmchat/` is auto-generated and will be updated on next build

