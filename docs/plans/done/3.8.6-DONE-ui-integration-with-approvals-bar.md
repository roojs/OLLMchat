# 3.8.6. UI Integration with Approvals Bar

## Overview

Integrate the Approvals widget (approvals bar) into the main UI and implement the necessary signals and handlers in occoder to support bidirectional communication between the approvals bar and the code editor. The approvals bar needs to know when files change, and occoder needs to handle requests from the approvals bar to open files.

## Status

✅ **COMPLETED** - Implementation is complete. All signal connections and UI integration are in place.

## Prerequisites

- Phase 3.8.3 must be completed (Approvals widget)
- Phase 3.8.5 must be completed (Approvals Widget Integration - box with buttons)

## Goals

1. Connect approvals bar to ProjectManager signals for file changes
2. Connect approvals bar file_selected signal to SourceView for opening files
3. Update approvals bar selection when active file changes
4. Ensure approvals bar visibility updates when ReviewFiles changes
5. Handle file opening requests from approvals bar

## Implementation Details

### Files Modified

- `liboccoder/SourceView.vala` - Added approvals bar to header bar and connected file_selected signal
- `liboccoder/Approvals.vala` - Connected to ProjectManager.active_file_changed internally

### Signal Flow

#### 1. File Change Notifications (ProjectManager → Approvals Bar)

**Purpose**: Notify approvals bar when the active file changes so it can update its selection internally.

**Signal**: `ProjectManager.active_file_changed(File? file)`

**Handler in Approvals Widget (Internal)**:
- Approvals widget listens to `ProjectManager.active_file_changed` signal internally
- When active file changes, check if the file is in ReviewFiles
- If file is in ReviewFiles, call `select_file(file)` to update selection (blocks handler, no signal emitted)
- If file is not in ReviewFiles, call `clear_selection()` internally
- This is handled entirely within the Approvals widget - no Window.vala involvement needed

**Implementation** (completed in `liboccoder/Approvals.vala`):
```126:208:liboccoder/Approvals.vala
// Connect to active_file_changed signal (internal handling)
this.project_manager.active_file_changed.connect(this.on_active_file_changed);

// ... later in the file ...

/**
 * Handle active file change (internal).
 * 
 * Updates selection when active file changes:
 * - If file is in ReviewFiles, select it (blocks handler, no signal emitted)
 * - If file is not in ReviewFiles, clear selection internally
 */
private void on_active_file_changed(OLLMfiles.File? file)
{
    if (file == null || this.project_manager.active_project == null) {
        // No file active or no project: clear selection internally
        this.clear_selection();
        return;
    }
    
    // Check if file is in ReviewFiles
    if (this.project_manager.active_project.project_files.review_files.file_map.has_key(file.path)) {
        // File is in ReviewFiles: select it (blocks handler, no signal emitted)
        this.select_file(file);
        return;
    } 
    // File is not in ReviewFiles: clear selection internally
    this.clear_selection();
}
```

**Notes**:
- `Approvals.select_file()` blocks the selection handler, so no `file_selected` signal is emitted
- `Approvals.clear_selection()` remains private (internal use only)
- Selection updates are handled internally by the Approvals widget
- No circular loops: `select_file()` blocks handler, so `file_selected` signal is not emitted

#### 2. File Opening Requests (Approvals Bar → SourceView)

**Purpose**: Allow approvals bar to request opening a file in the code editor when user clicks a file in the popover.

**Signal**: `Approvals.file_selected(File file)`

**Handler in Window.vala**:
- When user clicks a file in approvals bar popover, `file_selected` signal is emitted
- Window.vala connects to this signal and opens the file in SourceView
- Use `SourceView.open_file()` method to open the file

**Implementation** (completed in `liboccoder/SourceView.vala`):
```148:151:liboccoder/SourceView.vala
// Connect file_selected signal to open files
this.approvals.file_selected.connect((file) => {
    this.open_file.begin(file, null);
});
```

**Notes**:
- `SourceView.open_file()` is async, so use `.begin()` and `.end()` if needed
- The file will be opened in the code editor
- `SourceView.open_file()` calls `manager.activate_file(file)` which triggers `active_file_changed` signal
- Approvals widget listens to `active_file_changed` internally and updates selection (but blocks handler, so no loop)
- **Circular loop prevention**: When `active_file_changed` fires and calls `select_file()`, the handler is blocked, so `file_selected` signal is NOT emitted again

#### 3. ReviewFiles Changes (ReviewFiles → Approvals Bar)

**Purpose**: Update approvals bar visibility and selection when ReviewFiles list changes.

**Signal**: `ReviewFiles.items_changed(uint position, uint removed, uint added)`

**Handler in Approvals Bar**:
- Already implemented in Approvals widget (3.8.3)
- Updates button visibility based on ReviewFiles count
- May need to clear selection if selected file is removed from ReviewFiles

**Implementation** (completed in `liboccoder/Approvals.vala`):
```235:248:liboccoder/Approvals.vala
// Connect to review_files.items_changed signal
this.review_files_handler_id = 
        project.project_files.review_files.items_changed.connect(() => {
    this.update_button_visibility();
    
    // Check if selected file still needs approval
    if (this.selected_file == null) {
        return;
    }
    if (!this.selected_file.is_need_approval) {
        // Selected file no longer needs approval: clear selection internally
        this.clear_selection();
    }
});
```

**Notes**:
- This is fully implemented in Approvals widget
- Selection clearing logic is in place when file is removed from ReviewFiles

### Integration Points

#### 1. SourceView Integration (Implemented)

**Add Approvals Bar to UI**:
- Added approvals bar to header bar (after save button)
- Created Approvals widget with ProjectManager (widget handles its own signal connections internally)
- Connected only the `file_selected` signal to open files

**Implementation** (in `liboccoder/SourceView.vala`):
```142:151:liboccoder/SourceView.vala
// Create Approvals widget with ProjectManager
this.approvals = new Approvals(this.manager);

// Add approvals bar to header bar (after save button)
header_bar.append(this.approvals);

// Connect file_selected signal to open files
this.approvals.file_selected.connect((file) => {
    this.open_file.begin(file, null);
});
```

**Notes**:
- SourceView does NOT need to connect to `active_file_changed` signal
- Approvals widget handles all internal selection updates itself
- SourceView only needs to handle `file_selected` signal to open files

#### 2. SourceView Integration

**Current State**:
- `SourceView.open_file()` already calls `manager.activate_file(file)`
- This triggers `ProjectManager.active_file_changed` signal
- Approvals widget listens to this signal internally and updates selection
- No additional changes needed in SourceView

#### 3. Approvals Widget Updates (Implemented)

**Connect to ProjectManager.active_file_changed Internally**:
- Approvals widget connects to `project_manager.active_file_changed` in constructor
- Handles selection updates internally when active file changes
- `clear_selection()` is private (internal use only)

**Implementation** (in `liboccoder/Approvals.vala`):
```126:208:liboccoder/Approvals.vala
// Connect to active_file_changed signal (internal handling)
this.project_manager.active_file_changed.connect(this.on_active_file_changed);

// ... later in the file ...

/**
 * Handle active file change (internal).
 * 
 * Updates selection when active file changes:
 * - If file is in ReviewFiles, select it (blocks handler, no signal emitted)
 * - If file is not in ReviewFiles, clear selection internally
 */
private void on_active_file_changed(OLLMfiles.File? file)
{
    if (file == null || this.project_manager.active_project == null) {
        // No file active or no project: clear selection internally
        this.clear_selection();
        return;
    }
    
    // Check if file is in ReviewFiles
    if (this.project_manager.active_project.project_files.review_files.file_map.has_key(file.path)) {
        // File is in ReviewFiles: select it (blocks handler, no signal emitted)
        this.select_file(file);
        return;
    } 
    // File is not in ReviewFiles: clear selection internally
    this.clear_selection();
}
```

**Update Selection on ReviewFiles Changes**:
- When ReviewFiles items change, checks if selected file is still in list
- Clears selection if file was removed

**Implementation** (in `liboccoder/Approvals.vala`):
```235:248:liboccoder/Approvals.vala
// Connect to review_files.items_changed signal
this.review_files_handler_id = 
        project.project_files.review_files.items_changed.connect(() => {
    this.update_button_visibility();
    
    // Check if selected file still needs approval
    if (this.selected_file == null) {
        return;
    }
    if (!this.selected_file.is_need_approval) {
        // Selected file no longer needs approval: clear selection internally
        this.clear_selection();
    }
});
```

**Notes**:
- `clear_selection()` remains private (internal use only)
- All selection management is handled internally by Approvals widget
- No public API needed for selection management from SourceView

### Signal Flow Diagram

```
┌─────────────────┐
│ ProjectManager  │
│                 │
│ active_file_    │──┐
│ changed()       │  │
└─────────────────┘  │
                     │
                     ▼
              ┌──────────────┐
              │ Approvals    │
              │ (internal)   │
              │              │
              │ on_active_   │
              │ file_changed │
              │              │
              │ select_file()│ (blocks handler)
              │ or           │
              │ clear_       │ (internal)
              │ selection()  │
              └──────────────┘

┌─────────────────┐
│ User clicks     │
│ file in popover │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Approvals       │
│                 │
│ file_selected() │──┐ (user action, not blocked)
│                 │  │
└─────────────────┘  │
                     │
                     ▼
              ┌──────────────┐
              │ Window.vala  │
              │              │
              │ file_selected│
              │ handler      │
              └──────┬───────┘
                     │
                     ▼
              ┌──────────────┐
              │ SourceView   │
              │              │
              │ open_file()  │
              └──────┬───────┘
                     │
                     ▼
              ┌──────────────┐
              │ ProjectManager│
              │              │
              │ activate_    │
              │ file()       │
              └──────┬───────┘
                     │
                     ▼
              ┌──────────────┐
              │ ProjectManager│
              │              │
              │ active_file_ │
              │ changed()    │──┐ (back to Approvals, but blocked)
              └──────────────┘  │
```

**Key Points**:
- Approvals widget listens to `active_file_changed` internally
- When `select_file()` is called programmatically, handler is blocked (no `file_selected` signal)
- When user clicks file, `file_selected` signal is emitted (not blocked)
- This prevents circular loops while maintaining bidirectional communication

## Implementation Tasks

### Approvals Widget Updates
- [x] Connect to `ProjectManager.active_file_changed` signal in constructor
- [x] Implement `on_active_file_changed()` private method:
  - Check if file is in ReviewFiles
  - Call `select_file(file)` if in ReviewFiles (blocks handler, no signal)
  - Call `clear_selection()` if not in ReviewFiles (internal)
- [x] Keep `clear_selection()` private (internal use only)
- [x] Update `items_changed` handler to clear selection when selected file is removed from ReviewFiles
- [x] Test selection clearing when file is removed from ReviewFiles
- [x] Test selection updates when active file changes (internal handling)

### SourceView Integration (replaces Window.vala)
- [x] Create Approvals widget instance with ProjectManager
- [x] Add approvals bar to header bar (after save button)
- [x] Connect `Approvals.file_selected` signal to handler
- [x] Implement handler to call `source_view.open_file.begin(file, null)`
- [x] Test file opening when file is selected in approvals bar
- [x] Verify SourceView does NOT need to connect to `active_file_changed` (handled internally)

### Signal Flow Testing
- [x] Test: Open file in code editor → approvals bar selection updates
- [x] Test: Select file in approvals bar → file opens in code editor
- [x] Test: Open file not in ReviewFiles → approvals bar selection clears
- [x] Test: Remove file from ReviewFiles → approvals bar selection clears
- [x] Test: Approve file → file removed from ReviewFiles → approvals bar updates
- [x] Test: Revert file → file may be updated in ReviewFiles → approvals bar updates

### Edge Cases
- [x] Test: No active project → approvals bar handles null gracefully
- [x] Test: No active file → approvals bar selection clears
- [x] Test: File deleted while selected → approvals bar handles gracefully
- [x] Test: Project changes → approvals bar updates correctly
- [x] Test: Multiple rapid file changes → approvals bar updates correctly

## Testing

### Signal Integration
- Test approvals bar appears in UI when ReviewFiles has items
- Test approvals bar hides when ReviewFiles is empty
- Test active file change updates approvals bar selection
- Test file selection in approvals bar opens file in code editor
- Test opening file not in ReviewFiles clears approvals bar selection
- Test removing file from ReviewFiles clears approvals bar selection

### Bidirectional Communication
- Test: Code editor file change → approvals bar updates
- Test: Approvals bar file selection → code editor opens file
- Test: Circular updates don't cause infinite loops
- Test: Selection blocking works correctly during programmatic updates

### ReviewFiles Integration
- Test: Approve file → removed from ReviewFiles → approvals bar updates
- Test: Revert file → file updated in ReviewFiles → approvals bar updates
- Test: File added to ReviewFiles → approvals bar shows it
- Test: File removed from ReviewFiles → approvals bar hides it

### Error Handling
- Test: File doesn't exist when opening → error handled gracefully
- Test: File not in ReviewFiles when selecting → handled gracefully
- Test: Null file handling → no crashes
- Test: Project changes during operation → handled gracefully

## Implementation Notes

### Signal Handler Blocking

The Approvals widget uses `blocking_selection_handler` to prevent infinite loops when programmatically updating selection. This is important when:
- `select_file()` is called from `active_file_changed` handler
- `clear_selection()` is called from `active_file_changed` handler

The selection handler checks this flag and returns early if blocked, preventing the `file_selected` signal from being emitted during programmatic updates.

### Circular Signal Prevention

To prevent circular updates:
1. **User clicks file in approvals popover** → `file_selected` signal emitted (not blocked) → Window.vala opens file → `activate_file()` → `active_file_changed` fires
2. **Approvals widget receives `active_file_changed`** → calls `select_file()` internally → handler is blocked → `file_selected` signal is NOT emitted again
3. **Result**: No circular loop - selection updates internally without emitting signals

The `blocking_selection_handler` flag in Approvals widget prevents infinite loops:
- When `select_file()` is called programmatically (from `active_file_changed`), handler is blocked
- When user clicks file in popover, handler is NOT blocked, so `file_selected` signal is emitted
- This maintains bidirectional communication without loops

### Selection State Management

The approvals bar maintains its own `selected_file` property, which may differ from the active file in ProjectManager:
- Active file: The file currently open in the code editor
- Selected file: The file selected in the approvals bar popover

These should be kept in sync:
- When active file changes → update selected file (if in ReviewFiles)
- When selected file changes → open file in code editor → update active file

### Visibility Management

The approvals bar visibility is managed by the Approvals widget itself:
- Shows when `review_files.get_n_items() > 0`
- Hides when `review_files.get_n_items() == 0`
- Updates automatically when ReviewFiles changes

No additional visibility management needed in Window.vala.

## Related Plans

- **3.8.3**: Approvals Widget (completed) - Basic widget with popover
- **3.8.5**: Approvals Widget Integration (completed) - Convert to box with buttons
- **3.8.6**: UI Integration with Approvals Bar (this plan, completed) - Signal integration and file opening

## Implementation Summary

All planned functionality has been implemented:

1. ✅ Approvals widget is integrated into SourceView header bar
2. ✅ `active_file_changed` signal is connected internally in Approvals widget
3. ✅ `file_selected` signal is connected in SourceView to open files
4. ✅ Selection updates automatically when active file changes
5. ✅ Selection clears when file is removed from ReviewFiles
6. ✅ Bidirectional communication works without circular loops
7. ✅ Widget visibility updates based on ReviewFiles count

The implementation follows the planned architecture with proper signal blocking to prevent infinite loops.
