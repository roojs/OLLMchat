# 2.6.1.7. Network Access Support

## Overview

Add network access support with permission system integration. Network access is blocked by default, but can be enabled if the LLM requests it and the user grants permission.

## Background: RunCommand Tool

The RunCommand tool (`liboctools/RunCommand/`) allows the LLM to execute terminal commands in the project root directory. It provides a secure execution environment using `bwrap` (bubblewrap) to sandbox commands, preventing access to the filesystem outside the project directory and blocking network access by default via the `--unshare-net` flag.

The tool includes a permission system that:
- Caches permissions for simple commands based on the resolved executable path
- Always requires approval for complex commands (those with bash operators like `&&`, `|`, `||`, etc.)
- Executes commands in a sandboxed environment for security

Currently, all commands executed through RunCommand have network access blocked. This plan adds the ability to optionally allow network access when explicitly requested by the LLM and approved by the user.

## Status

✅ **DONE** - Implementation finished.

## Prerequisites

- Phase 1 (2.6.1.1) must be completed (network blocking already implemented)
- See main plan: `2.6.1-code-exec-improvements.md` for network access details

## Goals

1. Add `network` parameter to RunCommand tool (default: false) ✅
2. Integrate network access with permission system ✅
3. Allow network access only when permission is granted ✅

## Implementation Details

### Files to Modify

- `liboctools/RunCommand/Tool.vala` - Add `network` parameter to tool definition ✅
- `liboctools/RunCommand/Request.vala` - Add permission handling for network access ✅
- `liboctools/RunCommand/Bubble.vala` - Conditionally omit `--unshare-net` flag ✅

### Network Access Parameter

- Add `network` boolean parameter to RunCommand tool (implemented as `network` instead of `allow_network`)
- Default: `false` (network blocked by default)
- When `true`: Request permission from user before allowing network access

### Permission Integration

- Build permission question for network access when `network` is true
- Request permission via `agent.get_permission_provider().request()`
- Only omit `--unshare-net` flag if permission is granted
- If permission denied, execute command with network blocked (return error in output)

### Bwrap Configuration

- Default: Include `--unshare-net` flag to block network access
- If network access requested and permission granted: Omit `--unshare-net` flag
- Check permission before building bwrap command

## Implementation Tasks

- [x] Add `network` parameter to RunCommand tool (default: false) ✅
- [x] Integrate network access with permission system:
  - [x] Build permission question for network access when `network` is true ✅
  - [x] Request permission via `agent.get_permission_provider().request()` ✅
  - [x] Only omit `--unshare-net` flag if permission is granted ✅
- [ ] Test network blocking (verify commands cannot access network by default)
- [ ] Test network access with permission (commands can access network when permission granted)
- [ ] Test permission denial (commands should still execute but with network blocked)

## Testing

- Test network blocking (commands cannot access network by default)
- Test network access with permission (commands can access network when permission granted)
- Test permission denial (commands execute with network blocked)
- Test with various network-dependent commands (curl, wget, git fetch, etc.)

## Notes

- Network access is blocked by default for security
- Permission system ensures user control over network access
- LLM can request network access via `network` parameter
- User must grant permission for network access to be enabled

