# 1.3.2. Configuration Interface

## Overview

The user permission dialog provides a unified interface for managing connections, models, tools, and agents. This dialog will be implemented in the `ollmchat` application directory under `Settings/` subfolder using libadw (Adwaita) for GTK4 UI components.

## Status

✅ **DONE** - SettingsDialog, ConnectionsPage, and ConnectionAdd implemented. ModelsPage and ToolsPage moved to separate plans (1.3.6 and 1.3.5).

## Related Plans

- **1.3** - Configuration Overview
- **1.3.1** - Configuration Classes
- **1.3.5** - Tools Page and Tool Configuration
- **1.3.6** - Models Page and Model Usage Configuration
- **1.3.9** - Agent Configuration (Agents tab)
- **1.4** - Client Configuration Setup
- **1.5** - Model List Management
- **1.3.5** - Tools Page and Management

## Dialog Tree Structure

```
SettingsDialog (Main Window)
│
├── Tab: Connections
│   ├── Horizontal Box (Action Bar)
│   │   └── [Add Connection] Button
│   │
│   ├── Adw.PreferencesGroup (in Adw.BoxedList)
│   │   └── Connection List (Adw.BoxedList)
│   │       ├── [Connection 1] (Adw.ExpanderRow) [Edit] [Remove]
│   │       ├── [Connection 2] (Adw.ExpanderRow) [Edit] [Remove]
│   │       └── [Connection N] (Adw.ExpanderRow) [Edit] [Remove]
│   │       └── (When only one connection: [Edit] only - Remove button disabled/hidden)
│   │
│   └── Connection Details Panel (Adw.ExpanderRow - when expanded)
│       ├── Name: [text entry]
│       ├── URL: [text entry]
│       ├── API Key: [text entry (password)]
│       ├── Default: [checkbox]
│       └── Action Buttons (at bottom, last row)
│           ├── [Remove] Button (red, left) - Only shown if more than one connection exists
│           └── [Verify] Button (green/blue, right) - Tests connection and saves to config
│
├── Tab: Models
│   ├── Horizontal Box (Action Bar)
│   │   ├── Adw.SearchBar
│   │   │   └── [Search Models] - Filter models by name
│   │   ├── [Add Model] Button (placeholder - not implemented)
│   │   └── [Refresh] Button - Refresh model list from all connections
│   │
│   ├── Adw.PreferencesGroup (in Adw.BoxedList)
│   │   └── Model List (Adw.BoxedList, grouped by connection)
│   │       ├── Connection 1: "Local Ollama" (Section Header)
│   │       │   ├── [Model 1] [Settings ▼] (Adw.ExpanderRow)
│   │       │   ├── [Model 2] [Settings ▼] (Adw.ExpanderRow)
│   │       │   └── [Model N] [Settings ▼] (Adw.ExpanderRow)
│   │       ├── Connection 2: "Remote Server" (Section Header)
│   │       │   ├── [Model 1] [Settings ▼] (Adw.ExpanderRow)
│   │       │   └── [Model 2] [Settings ▼] (Adw.ExpanderRow)
│   │       └── Connection N: "OpenAI" (Section Header)
│   │           └── [Model 1] [Settings ▼] (Adw.ExpanderRow)
│   │
│   └── Model Settings Panel (Adw.ExpanderRow - when expanded)
│       ├── Connection: [read-only label] (models are fixed to their provider)
│       ├── Model Name: [read-only label]
│       ├── [Separator]
│       ├── Temperature: [spin button]
│       ├── Top P: [spin button]
│       ├── Top K: [spin button]
│       ├── Num Ctx: [spin button]
│       └── ... (other Call.Options fields listed directly)
│
└── Tab: Tools
    ├── Horizontal Box (Action Bar)
    │   └── Adw.SearchBar
    │       └── [Search Tools] - Filter tools by name
    │
    ├── Adw.PreferencesGroup (in Adw.BoxedList)
    │   └── Tool List (Adw.BoxedList)
    │       ├── [Tool 1] (Adw.ExpanderRow) [Configure ▼]
    │       │   ├── [Config 1: Embedding Settings] [Edit]
    │       │   ├── [Config 2: Analysis Settings] [Edit]
    │       │   └── [Add Config] Button
    │       ├── [Tool 2] (Adw.ExpanderRow) [Configure ▼]
    │       └── [Tool N] (Adw.ExpanderRow) [Configure ▼]
    │
    └── Tool Configuration Panel (Adw.ExpanderRow - when expanded)
        ├── Config Name: [text entry] (e.g., "embed", "analysis")
        ├── Config Display Name: [text entry] (e.g., "Embedding Settings", "Analysis Settings")
        ├── Enabled: [checkbox]
        ├── Model Configuration: [ModelUsage editor]
        │   ├── Connection: [dropdown]
        │   ├── Model: [dropdown]
        │   ├── [Separator]
        │   ├── Temperature: [spin button]
        │   ├── Top P: [spin button]
        │   └── ... (other Call.Options fields listed directly)
        └── Tool-Specific Settings: [dynamic based on tool type]
            └── (varies by tool - e.g., vector.embed has vector_db_path, etc.)
```

## Detailed Component Descriptions

### Connections Tab

**Purpose**: Manage server connections (add, remove, edit connection details).

**Components**:
- **Horizontal Box (Action Bar)**: Top horizontal container with action buttons
  - **Add Connection Button**: Opens ConnectionAdd dialog for adding new connection
- **Adw.PreferencesGroup**: Contains the connection list
  - Wraps `Gtk.ListBox` for connection list
- **Connection List**: Uses `Gtk.ListBox` to display all connections from `Config2.connections` map
  - Each connection uses `Adw.ExpanderRow` to show/edit connection details inline
  - Each connection shows: name, URL, default indicator (when collapsed)
  - When expanded: Shows editable form fields with Remove and Verify buttons at bottom
  - Editing is inline - no separate edit mode needed
- **Connection Details Panel**: Uses `Adw.ExpanderRow` - inline editable form for connection properties
  - Settings widgets are added as children to the `Adw.ExpanderRow` using `add_row()`
  - Uses `Adw.ActionRow` with suffix widgets for form fields
  - Name: Connection alias/name (Gtk.Entry as suffix)
  - URL: Server URL (e.g., `http://127.0.0.1:11434/api`) (Gtk.Entry as suffix)
  - API Key: Optional API key (Gtk.PasswordEntry as suffix)
  - Default: Switch to mark as default connection (Gtk.Switch as suffix)
  - **Unverified State**: When connection details are edited, add CSS class `oc-settings-unverified` to change background color
  - **Action Buttons** (shown at bottom, in Gtk.Box):
    - **Remove Button** (red, left side): Only shown when expanded and if more than one connection exists
      - Removes connection from `config.connections` map
      - Validation: Cannot remove if it's the last connection
    - **Verify Button** (green/blue, right side): Tests connection using same code as ConnectionAdd dialog
      - Creates temporary Client and calls `version()` endpoint to test
      - On success: Saves connection to `config` immediately (calls `config.save()`)
      - On failure: Shows error message
      - After verification: Removes `oc-settings-unverified` class

**Validation**:
- Cannot remove all connections (at least one must exist) - Remove button only shown when more than one connection exists
- URL must be valid format (validated when Verify button is clicked)
- Name must be unique (or use URL as key)
- Connection is saved to config immediately after successful verification (no separate save step needed)

**Data Source**: `Config2.connections` (Gee.Map<string, Settings.Connection>)

**Note**: Agents tab has been moved to separate plan 1.3.9.

---

## Implementation Considerations

### UI Files Needed (using libadw)

**Note**: These are UI files (not configuration classes) that use libadw (Adwaita) for GTK4 UI components.

**Layout Components**:
- **Adw.PreferencesDialog**: Main dialog window uses `Adw.PreferencesDialog` (not `Adw.Dialog` or `Adw.Window`)
- **Adw.BoxedList**: All lists (connections, models, tools) use `Adw.BoxedList` for consistent styling and layout
- **Adw.PreferencesGroup**: Wraps `Adw.BoxedList` to provide group headers and consistent spacing
- **Adw.ExpanderRow**: All expandable panels (connection details, model settings, tool configurations) use [`Adw.ExpanderRow`](https://valadoc.org/libadwaita-1/Adw.ExpanderRow.html). Settings widgets are added as children using the `add_row()` method. Provides built-in expand/collapse functionality with a visual indicator (▼ arrow)
- **Adw.SearchBar**: Used for search functionality in Models and Tools tabs
- **Horizontal Box (Action Bar)**: Top horizontal container in each tab containing search bar and action buttons (Add, Refresh, etc.)
  - Uses `Gtk.Box` with horizontal orientation
  - Contains both the search bar and action buttons in one container
- **ConnectionAdd**: Dialog for adding new connections (reusable dialog similar to initial bootstrap)

**Model Management**:
- **ModelManager** (potential new class in `libollmchat/`): Similar to liststore wrappers, can contain extra model information
  - May be needed to manage model list with additional metadata (notes, tokens/second, etc.)
  - If created, SettingsDialog would use ModelManager instead of simple `Gee.List<ModelInfo>`
  - Otherwise, SettingsDialog maintains `models_list` property directly

**1. SettingsDialog (Main Dialog Window)**
- **Location**: `ollmchat/Settings/SettingsDialog.vala`
- **UI Framework**: Uses `Adw.PreferencesDialog` with `Adw.ViewStack` for tabs
- **Purpose**: Main dialog window with tabbed interface for displaying and changing configuration
- **Properties**:
  - `config` (Settings.Config2) - Reference to configuration object (contains `connections` map)
  - // `models_list` (Gee.List<ModelInfo>?) - List of available models from all connections (commented out until model tab is added)
  - // `model_manager` (ModelManager?) - Optional ModelManager for managing model list (if created) (commented out until model tab is added)
- **Signals**:
  - // `refresh_models()` - Emitted when models need to be refreshed (main window can connect to this) (commented out until model tab is added)
- **Methods**:
  - `on_close()` - Called when dialog closes, calls `config.save()` to persist changes
  - Note: This class is only responsible for displaying and changing configuration, not loading/saving
  - Loading is done by the caller before creating the dialog
  - Saving is done automatically on close
  - Note: Client instances are not created by this class - that's the responsibility of the caller/main window

**2. ConnectionsPage**
- **Location**: `ollmchat/Settings/ConnectionsPage.vala`
- **Status**: ✅ **IMPLEMENTED** - Connections tab working with add/edit/remove functionality. Uses ConnectionAdd dialog for adding connections.
- **UI Framework**: Uses `Adw.PreferencesPage` with:
  - Horizontal box at top (Add Connection button)
  - `Adw.PreferencesGroup` wrapping `Gtk.ListBox` for connection list
  - `Adw.ExpanderRow` for each connection (expandable connection details panels)
  - Settings widgets added to `Adw.ExpanderRow` via `add_row()` method (Adw.ActionRow with suffix widgets)
  - Remove and Verify buttons shown at bottom of expanded connection details
  - Uses `oc-settings-unverified` CSS class to mark unverified connections
  - See [Adw.ExpanderRow documentation](https://valadoc.org/libadwaita-1/Adw.ExpanderRow.html)
- **Purpose**: Connections tab content
- **Properties**:
  - `settings_dialog` (SettingsDialog) - Reference to parent SettingsDialog (which has the config object)
- **Methods**:
  - `add_connection()` - Opens ConnectionAdd dialog for adding new connection
  - `on_add_closed()` - Called when ConnectionAdd dialog closes, adds verified connection to config
  - `verify_connection(string url)` - Tests connection (same code as ConnectionAdd dialog) and saves to config on success
  - `remove_connection(string url)` - Removes connection from `config.connections` map and updates visibility of Remove buttons (hides if only one connection left)
  - `render_connections()` - Creates UI entries from `config.connections` map
    - Does initial render when page is created
    - Can be called after connections are added/removed to update the UI
    - Updates Remove button visibility based on number of connections
    - Uses `add_connection_row()` to create each connection's expandable row
  - `add_connection_row(string url, Connection connection, bool can_remove)` - Creates expandable row for a connection with form fields
  - Note: Editing is inline - no separate edit/update methods needed. Fields automatically add `oc-settings-unverified` CSS class when changed.

**3. ConnectionAdd**
- **Location**: `ollmchat/Settings/ConnectionAdd.vala`
- **Status**: ✅ **IMPLEMENTED** - Dialog for adding new connections, can be used for both initial bootstrap setup and adding new connections.
- **UI Framework**: Uses `Adw.PreferencesDialog` with:
  - Single `Adw.PreferencesPage` with form fields
  - `Adw.ActionRow` widgets for Host and API Key fields
  - Add Connection button with spinner for loading state
  - See [Adw.PreferencesDialog documentation](https://valadoc.org/libadwaita-1/Adw.PreferencesDialog.html)
- **Purpose**: Dialog for adding/verifying new connections
- **Properties**:
  - `verified_connection` (Connection?) - The verified connection object (set after successful verification), null if verification failed or dialog was cancelled
- **Signals**:
  - `error_occurred(string error_message)` - Emitted when an error occurs during connection test
  - `dialog_closed()` - Emitted when the dialog is closed
- **Methods**:
  - `show_add()` - Shows dialog in "add" mode (clears previous state)
  - `test_and_save()` - Tests connection by creating temporary Client and calling `version()` endpoint, creates Connection object on success
  - `update_button_state()` - Updates button enabled state based on host entry content
  - Note: Uses `closed` signal and `force_close()` method (not `close_request`)


**Note**: ModelsPage, ToolsPage, and AgentsPage have been moved to separate plans:
- **ModelsPage**: See [1.3.6 - Models Page and Model Usage Configuration](1.3.6-DONE-models-page.md)
- **ToolsPage**: See [1.3.5 - Tools Page and Tool Configuration](1.3.5-tools-page.md)
- **AgentsPage**: See [1.3.9 - Agent Configuration](1.3.9-agent-configuration.md)

