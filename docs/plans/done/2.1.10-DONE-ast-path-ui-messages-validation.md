# 2.1.10. AST Path UI Messages and Validation

## Overview

Improve EditMode UI feedback and validation for AST-path edits. This plan focuses on:
- clear UI messages that show AST path and resolved line ranges
- consistent error handling when AST paths fail to resolve
- validation for resolved ranges and comment-aware suffixes

## Status

✅ **DONE** - Error reporting flows through `FileChange` results; UI streaming messages were dropped to avoid interleaving with streamed code.

## Related Plans

- **2.1.4** - AST Path Support for EditFile Integration
- **2.1.5** - AST Path Comment Support
- **2.1.6** - Stream Class Refactoring for EditMode
- **2.1.8** - AST Path Mode (Incremental Application)

## Goals

- [x] Provide actionable error messages for AST path failures (via `FileChange.result`)
- [ ] (Removed) Validate resolved ranges before applying changes (tree-sitter ranges are authoritative)
- [x] Respect comment-aware suffixes (`:with-comment`, `:before-comment`, `:remove`)

## Non-Goals

- Changing AST path parsing behavior
- Adding new edit modes
- Replacing existing permission logic

## Implementation Details

### 1. UI Message Enhancements
- Note: UI streaming messages were removed to avoid interleaving with streamed code blocks.

### 2. AST Path Validation
- [x] Validate AST path exists before applying FileChange
- [x] If AST path not found:
  - Show error message and skip the code block
  - Include the original AST path in the error
// NOTE: Resolved line range validation is not required; tree-sitter provides authoritative ranges.

### 3. Comment-Aware Suffix Handling
- [x] `:with-comment` should use comment start for replace/delete
- [x] `:before-comment` should insert before the comment block
- [x] `:remove` should delete target + comment block
- [ ] UI should reflect which range was applied when comments are included

### 4. Error Handling and Reporting
- [x] Inline error message when parsing a code block fails (stored on `FileChange.result`)

## Files to Update

### EditMode Stream/UI
- `liboctools/EditMode/Stream.vala`
  - [ ] Centralize validation errors for AST resolution and line range
- `liboctools/EditMode/Request.vala`
  - [x] Update instructions/examples as needed

### FileChange
- `libocfiles/FileChange.vala`
  - [ ] Validate resolved line range before applying changes
  - [x] Ensure error messages include AST path and operation type

## Example UI Messages

- "Edit: ast-path: OLLMchat-Client-chat:with-comment"
- "Resolved: OLLMchat-Client-chat (lines 40-67)"
- "Error: AST path not found: OLLMchat-Client-chat"
- "Error: Invalid range for ast-path: OLLMchat-Client-chat (start=0, end=12)"

## Code Example (Proposed)

### Stream: AST block open + resolve
```vala
// In FileChange: human-readable label for UI
public string get_ui_label()
{
	var label = this.ast_path;
	if (this.include_comments) {
		label += " (with comments)";
	}
	switch (this.operation_type) {
		case OperationType.BEFORE:
			label += " (insert before comment)";
			break;
		case OperationType.AFTER:
			label += " (insert after)";
			break;
		case OperationType.DELETE:
			label += " (remove)";
			break;
		default:
			break;
	}
	return label;
}

// In Stream.try_parse_code_block_opener() after AST path parsing
this.current_change = new OLLMfiles.FileChange(this.file) {
	operation_type = operation_type,
	ast_path = ast_path,
	include_comments = include_comments
};

this.request.send_ui("txt", "Edit block", "Edit: " + this.current_change.get_ui_label());
```

```vala
// In Stream.process_next_change() after resolve_ast_path()
if (change.has_error) {
	this.request.send_ui("txt", "Edit error", change.result);
	this.skipped_changes.add(change.get_description() + " - " + change.result);
	return;
}

var resolved_message = "Resolved: " + change.display_ast_path +
	" (lines " + change.start.to_string() + "-" + change.end.to_string() + ")";
if (change.include_comments) {
	resolved_message = "Resolved with comments: " + change.display_ast_path +
		" (lines " + change.start.to_string() + "-" + change.end.to_string() + ")";
}
this.request.send_ui("txt", "Edit resolved", resolved_message);
```

### Stream: end-of-session summary of skipped changes
```vala
// In Stream.send_response()
if (this.skipped_changes.size > 0) {
	reply += "\n\n" + this.skipped_changes.size.to_string() + " code block(s) were skipped:\n";
	foreach (var skipped in this.skipped_changes) {
		reply += "  • " + skipped + "\n";
	}
}
```

## Testing

- AST path resolve success: ensure UI shows path + lines
- AST path resolve failure: ensure error shown and change skipped
- Comment-aware suffixes: ensure ranges include comment block
- Line range validation: invalid ranges should be rejected
