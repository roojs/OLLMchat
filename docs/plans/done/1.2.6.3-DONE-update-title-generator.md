# 1.2.6.3. Update TitleGenerator

## Overview

Update TitleGenerator to take Manager reference instead of `Client` to access config.

**Parent Plan**: [1.2.6. Update Legacy Methods](./1.2.6-DONE-update-legacy-methods.md)

**Prerequisite**: [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) must be complete

## Status

✅ **DONE** - TitleGenerator updated to use Manager reference and `title_model` usage entry.

## Goal

TitleGenerator should not depend on `Client` with config. According to plan 1.2, Manager owns the config, not Client.

## Current Implementation

**File**: `libollmchat/History/TitleGenerator.vala` (line 44-52)

```vala
public TitleGenerator(OLLMchat.Client client)
{
    this.client = client;
}
// ...
public async string to_title(SessionBase session)
{
    // If model is empty, return default title
    // Phase 3: Client no longer has model property
    // TitleGenerator should use Config2.create_chat() or get model from config
    var model = "";
    if (this.client.config != null) {
        model = this.client.config.get_default_model();  // ❌ WRONG: Should use "title_model" usage entry
    }
    // ...
    var response = yield this.client.generate(model, prompt);
}
```

**File**: `libollmchat/History/Manager.vala` (line 156)

```vala
// Set up title generator with a client configured for title generation
var title_client = this.config.create_client("title_model");  // ✅ Correctly uses "title_model"
if (title_client == null) {
    // Fallback: use base_client's connection
    // ❌ This fallback should be removed - TitleGenerator should handle missing config
    title_client = new OLLMchat.Client(this.base_client.connection) {
        config = this.config
    };
}
this.title_generator = new TitleGenerator(title_client);
```

**Note**: The Manager fallback should also be removed. If `title_model` is not configured, TitleGenerator should still be created but will return default titles when `to_title()` is called.

**Issue**: Manager correctly creates a client using `config.create_client("title_model")`, but TitleGenerator then incorrectly uses `get_default_model()` instead of getting the model from the `title_model` usage entry.

**Problem**: TitleGenerator takes `Client` but should take Manager reference to get model from config. Currently it incorrectly uses `get_default_model()` instead of getting the model from the `title_model` usage entry.

**Note**: Config2 has a `title_model` usage entry in the `usage` map (as a `ModelUsage` object) that contains the connection and model for title generation. This should be used instead of `default_model`.

## Proposed Fix

```vala
private History.Manager manager;

public TitleGenerator(History.Manager manager)
{
    this.manager = manager;
}

public async string to_title(SessionBase session)
{
    // Return early if title_model is not configured or invalid
    if (!this.manager.config.usage.has_key("title_model")) {
        return this.get_default_title(session);
    }
    
    var title_model_usage = this.manager.config.usage.get("title_model") as Settings.ModelUsage;
    var model = title_model_usage.model;
    
    if (model == "" || title_model_usage.connection == "" || !this.manager.config.connections.has_key(title_model_usage.connection)) {
        return this.get_default_title(session);
    }
    
    var connection = this.manager.config.connections.get(title_model_usage.connection);
    
    // Find first user-sent message
    string first_message = "";
    foreach (var msg in session.messages) {
        if (msg.role != "user-sent") {
            continue;
        }
        first_message = msg.content;
        break;
    }
    
    // Return early if no user-sent message found
    if (first_message == "") {
        return this.get_default_title(session);
    }
    
    // Generate title
    try {
        var prompt = "Generate a concise title (maximum 8 words) for this chat conversation based on the first user message:\n\n" +
            "\"" + first_message + "\"\n\n" +
            "Respond with ONLY the title, no explanation or quotes.";
        
        var client = new Client(connection);
        var response = yield client.generate(model, prompt);
        
        // Extract title (prompt explicitly says "no explanation or quotes")
        return response.response.strip();
    } catch (Error e) {
        GLib.warning("Title generation failed: %s", e.message);
        return this.get_default_title(session);
    }
}
```

## Implementation Steps

1. Update `TitleGenerator` constructor
2. Update `to_title()` method to create Client from Connection and get model from `title_model` usage entry
3. Remove fallback logic - if `title_model` is not configured, return default title immediately
4. Update Manager constructor where TitleGenerator is created (line ~156) - remove fallback to base_client
5. Test that title generation works when `title_model` is configured
6. Test that default titles are returned when `title_model` is not configured (no fallback)

## Test

1. Verify title generation works when `title_model` is configured in Config2
2. Verify default titles are returned (no LLM call) when `title_model` is not configured
3. Verify no fallback to `default_model` occurs when `title_model` is missing

## Result

TitleGenerator uses model parameter explicitly from the `title_model` usage entry and no longer depends on Client with config. If `title_model` is not configured, TitleGenerator returns default titles without attempting LLM generation (no fallback to `default_model`).

## Files to Modify

- `libollmchat/History/TitleGenerator.vala` - Update constructor and `to_title()` method
- `libollmchat/History/Manager.vala` - Update TitleGenerator creation (line ~161)

## Related Plans

- [1.2.6.1. Update Client Method Signatures](./1.2.6.1-update-client-method-signatures.md) - Prerequisite

