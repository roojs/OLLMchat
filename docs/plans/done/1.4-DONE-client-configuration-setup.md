# 1.4. Client Configuration Setup

## Overview

Client configuration system for setting up and managing server connections, API keys, and basic client settings. Includes bootstrap dialog for initial setup, configuration persistence, and version management. Focuses on the connection layer between the application and LLM servers.

## Status

✅ **DONE** - Bootstrap dialog, basic config persistence, and single client support implemented. Configuration version management and advanced features moved to related plans (1.3.1, 1.3.2, 1.3.7).

## Related Plans

- **1.3** - Multiple Client Configuration
- **1.5** - Model List Management
- **1.3.5** - Tools Page and Management

## Implementation Details

### Phase 1: Bootstrap Dialog ✅ DONE

#### Bootstrap Dialog UI ✅
- **Framework**: Uses libadw (Adwaita) preferences dialog ✅
- **Structure**: Single header/preferences page ✅
- **Header Title**: "Set up initial connect" ✅
- **Description**: 
  > First step is to connect to a ollama or openai server (this is really designed for locally hosted LLMs, however you should be able to use online LLMs if you have an account) ✅

#### Dialog Fields ✅
1. **Host Field** ✅
   - Label: "Host"
   - Placeholder: `http://127.0.0.1:11434/api`
   - Input type: Text entry
   - Required: Yes

2. **API Key Field** ✅
   - Label: "API Key"
   - Description: "(optional) only need for online services or if you serve via nginx proxy"
   - Input type: Text entry
   - Required: No

3. **Next Button** ✅
   - Action: Validate and test connection
   - Behavior:
     - Button locks (disabled) when clicked ✅
     - Shows Adwaita spinner while checking server ✅
     - Calls version endpoint to verify connection ✅
     - On success: Save config and proceed ✅
     - On failure: Show error, unlock button ✅

#### Connection Testing ✅
- **Method**: Uses GET `/api/version` endpoint ✅
- **Purpose**: Verify server is reachable and responding ✅
- **Reference**: https://docs.ollama.com/api-reference/get-version
- **Response**: Expects `{ "version": "x.x.x" }` format ✅
- **Error Handling**: 
  - Network errors (connection refused, timeout) ✅
  - Invalid response format ✅
  - Authentication errors (if API key required) ✅

#### Client API Support ✅
- **Method**: `version()` method added to `Client` class ✅
- **Implementation**: 
  - `Call.Version` class created ✅
  - Returns version string from server ✅
  - Handles errors appropriately ✅
- **Usage**: Called during bootstrap to verify connection ✅

#### Bootstrap Flow ✅
1. First run: Show bootstrap dialog (libadw preferences dialog) ✅
2. User enters host (with default placeholder) ✅
3. User optionally enters API key ✅
4. User clicks "Next" button ✅
5. Button locks, spinner shows ✅
6. System calls `GET /api/version` to test connection ✅
7. On success: Save config as first default client, close dialog ✅
8. On failure: Show error message, unlock button for retry ✅
- **Scope**: Bootstrap handles initial client setup ✅

#### Files Implemented ✅
- `ollmchat/BootstrapDialog.vala` - Bootstrap dialog implementation ✅
- `libollmchat/Call/Version.vala` - Version API call ✅
- `libollmchat/Client.vala` - `version()` method ✅

### Phase 2: Basic Configuration Persistence ✅ DONE

#### Config Class ✅
- **File**: `libollmchat/Config.vala` ✅
- **Properties**:
  - `url` - Server URL ✅
  - `api_key` - Optional API key ✅
  - `model` - Model name ✅
  - `title_model` - Title generation model ✅
  - `think` - Whether to return thinking output ✅
- **Serialization**: JSON serializable ✅
- **Methods**:
  - `from_file()` - Load config from file ✅
  - `save()` - Save config to file ✅
  - `clone()` - Clone config object ✅

#### Configuration Storage ✅
- **Location**: `~/.config/ollmchat/config.json` ✅
- **Format**: JSON ✅
- **Auto-save**: Saves on bootstrap completion ✅

#### Files Implemented ✅
- `libollmchat/Config.vala` - Configuration management ✅

### Phase 3: Configuration Version Management ⏳ TODO

#### Versioned Configuration Files
- **Location**: `~/.config/ollmchat/config.1.json`, `config.2.json`, etc. (versioned config files)
- **Format**: JSON with structured sections
- **Version Management**: Use `Config1.vala`, `Config2.vala`, etc. to read old versions
- **Migration**: Support config migration from existing `config.json` to new versions

#### Configuration Storage Structure
- **Version 1**: Current simple format (single client, basic properties)
- **Version 2+**: Extended format as features are added (multiple clients, etc.)
- **Backward Compatibility**: Old config readers can load previous versions

#### Files to Create
- `libollmchat/Config1.vala` - Config reader for version 1 format (for migration)
- `libollmchat/Config2.vala` - Config reader for version 2 format (future)

#### Files to Modify
- `libollmchat/Config.vala` - Add version detection and migration support

### Phase 4: Configuration Integration ⏳ TODO

#### Configuration Loading
- **Startup**: Load configuration on application start
- **Client Initialization**: Apply connection settings to clients
- **Version Detection**: Detect config version and use appropriate reader

#### Configuration Persistence
- **Auto-save**: Save changes automatically
- **Manual Save**: Save button for explicit saves
- **Validation**: Validate configuration before saving
- **Backup**: Create backup before major changes

#### Configuration Migration
- **From Config.json**: Migrate existing `config.json` to versioned format
- **Version Management**: Handle configuration format versioning using `Config1.vala`, `Config2.vala`, etc. to read old versions
- **Versioned Files**: Use `config.1.json`, `config.2.json`, etc. as format evolves

#### Files to Modify
- `ollmchat/Window.vala` - Load configuration on startup
- `libollmchat/Client.vala` - Initialize from configuration

### Phase 5: Single Client Support (Current) ✅ DONE

#### Single Client Implementation ✅
- Support for single client ✅
- Client configuration stored as default/single client ✅
- Simple config structure for single client ✅

#### Client Management ✅
- Single Client instance managed by application ✅
- Client initialized from config on startup ✅
- Changes to Client properties saved to config ✅

### Phase 6: Chat Defaults (Low Priority) ⏳ TODO

#### ChatDefaults Class
- **Purpose**: Separate chat-specific settings from Client class (not to be confused with Options class)
- **Initialization**: Initialize with standard/default settings
- **Properties to Extract**:
  - `model` - Model name to use
  - `stream` - Whether to stream responses
  - `format` - Response format (json, schema, etc.)
  - `think` - Whether to return thinking output
  - `keep_alive` - Model keep-alive duration
- **Note**: Runtime options (seed, temperature, top_p, etc.) remain in `Call.Options` class - do not overlap

#### Standard Defaults
- Default values should match current Client defaults
- Settings should be easily serializable for config storage
- Settings should support per-model overrides (future)

#### Integration with Client
- Client class should use ChatDefaults object
- Chat methods should accept ChatDefaults (with defaults from Client)
- Allow overriding settings per-chat call

#### Files to Create
- `libollmchat/ChatDefaults.vala` - Chat defaults/settings class

#### Files to Modify
- `libollmchat/Client.vala` - Refactor to use ChatDefaults
- `libollmchat/Call/Chat.vala` - Update to use ChatDefaults

### Phase 7: Possible Enhancements (Low Priority) ⏳ TODO

#### UI Enhancements
- **Font Settings**: Custom font selection for chat interface
- **Window Persistence**: Remember window size and position

#### Files to Create
- `ollmchat/Settings/ApplicationPage.vala` - Application settings page (if needed)

### Files Summary

#### Files Created ✅
- `ollmchat/BootstrapDialog.vala` - Bootstrap dialog ✅
- `libollmchat/Call/Version.vala` - Version API call ✅
- `libollmchat/Config.vala` - Configuration management ✅

#### Files to Create ⏳
- `libollmchat/ChatDefaults.vala` - Chat defaults/settings class (low priority)
- `libollmchat/Config1.vala` - Config reader for version 1 format (for migration)
- `libollmchat/Config2.vala` - Config reader for version 2 format (future)

#### Files to Modify ⏳
- `libollmchat/Client.vala` - Load configuration, optionally refactor to use ChatDefaults (low priority)
- `libollmchat/Call/Chat.vala` - Optionally update to use ChatDefaults (low priority)
- `libollmchat/Config.vala` - Add version detection and migration support
- `ollmchat/Window.vala` - Load configuration on startup

### Implementation Notes

#### Security
- **API Key Storage**: Store as plain text (keep it simple, data is not sensitive)

#### Configuration Versioning
- **Version Detection**: Detect config file version on load
- **Migration Path**: Support migrating from older versions to newer ones
- **Backward Compatibility**: Old config readers can load previous versions

### Integration Points

#### With Related Plans
- **1.3 Multiple Client Configuration**: Extends this plan with multiple connection support
- **1.5 Model List Management**: Uses client configuration for model discovery
- **1.3.5 Tools Page and Management**: Uses client configuration for tool setup
