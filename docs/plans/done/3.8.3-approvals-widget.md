# 3.8.3. Approvals Widget

## Overview

Create Approvals widget (Gtk.Button that extends button functionality) with an internal popover containing Gtk.ListView that displays files needing approval. The button shows task-due icon and the popover appears on mouseover. Allows selecting files and opening them in codeview.

## Status

✅ **COMPLETED** - Implementation complete.

## Prerequisites

- Phase 3.8.2 must be completed (ReviewFiles class)

## Goals

1. Create Approvals button (extends Gtk.Button)
2. Implement internal popover with Gtk.ListView
3. Display list of files needing approval in popover
4. Show file basename with visual indicators (+, strikethrough)
5. Show tooltips with full path and change type
6. Allow clicking files to open in codeview
7. Support programmatic selection with blocked handler
8. Popover height based on list size
9. Button shows task-due icon
10. Popover appears on mouseover of button

## Implementation Details

### File to Create

- `liboccoder/Approvals.vala`

### Class Structure

```vala
namespace OLLMcoder
{
    /**
     * Button widget for displaying and managing files that need approval.
     * 
     * Extends Gtk.Button and contains an internal popover with a list of files that need approval,
     * ordered by last_modified (most recent first). The button shows a task-due icon and the popover
     * appears on mouseover. Allows selecting files to open in codeview. Supports visual indicators
     * for new/deleted files. Tied to ProjectManager and monitors active_project for changes.
     */
    public class Approvals : Gtk.Button
    {
        private OLLMfiles.ProjectManager project_manager;
        private Gtk.Popover popover;
        private Gtk.ListView list_view;
        private Gtk.SingleSelection selection;
        private List.SortedList<OLLMfiles.File> sorted_model;
        private Gtk.EventControllerMotion button_motion;
        private Gtk.EventControllerMotion popover_motion;
        private bool blocking_selection_handler = false;
        private uint hide_timeout_id = 0;
        private uint cooldown_timeout_id = 0;
        private bool in_cooldown = false;
        private ulong? review_files_handler_id = null;
        
        /**
         * Currently selected file (or null).
         */
        private OLLMfiles.File? selected_file { get; set; default = null; }
        
        /**
         * Emitted when a file is selected/clicked.
         */
        public signal void file_selected(OLLMfiles.File file);
        
        /**
         * Constructor.
         * 
         * @param project_manager The ProjectManager instance (required)
         */
        public Approvals(OLLMfiles.ProjectManager project_manager)
        {
            this.project_manager = project_manager;
            this.icon_name = "task-due";
            // ... initialization ...
        }
        
        // ... methods ...
    }
}
```

### Methods

1. **Setup**:
   - Constructor takes `ProjectManager` as parameter
   - Extend Gtk.Button, set icon to "task-due"
   - Create internal Gtk.Popover and set parent to `this` (the button) using `set_parent()`
   - Create Gtk.ListView inside popover
   - Monitor `project_manager.active_project_changed` signal to update backing store
   - When active_project changes: update ReviewFiles backing store from `active_project.review_files`
   - Connect to `review_files.items_changed` signal to update button visibility
   - Connect mouseover events to `this` (the button) to show popover
   - Update selected row when popover is shown
   - Update button visibility based on whether there are files needing approval

2. **Selection**:
   - `select_file(File file)` - Programmatically select a file (blocks handler, public)
   - `select_next()` - Select next file in list (private, blocks handler via selection change)
   - `selected_file` - Private property for currently selected file (or null)
   - `clear_selection()` - Clear selection (private, blocks handler)
   - `update_selected_file()` - Update selected_file from current selection (private)

3. **Internal**:
   - `update_selected_file()` - Handle selection changes (only when not blocked, emits file_selected signal)
   - `create_factory()` - Create factory for list items (binds to display_approval_text and display_approval_tooltip)
   - `create_sorted_model()` - Create sorted model with sorter for last_modified (descending)
   - `activate_project()` - Handle active project change (updates model, connects signals)
   - `update_popover_size()` - Adjust popover height based on list size (called when popover shown)
   - `cancel_hide_timeout()` - Cancel pending hide timeout
   - `schedule_hide()` - Schedule popover to hide in 3 seconds
   - `start_cooldown()` - Start 3 second cooldown after button click
   - `update_button_visibility()` - Update button visibility based on review_files count
   - Signal handlers use lambdas (button_motion.enter/leave, popover_motion.enter/leave, clicked, closed, selection_changed, items_changed)

### FileBase Properties

**File**: `libocfiles/FileBase.vala`

Add two new properties for approval display:

1. **`display_approval_text`** (string property):
   - Returns formatted text for display in approvals list
   - Format: "+ filename" for new files, `<s>filename</s>` for deleted files, "filename" for modified files
   - Uses Pango markup for strikethrough on deleted files
   - Determines file state from FileHistory records (check for "added", "deleted", "modified" change_type)

2. **`display_approval_tooltip`** (string property):
   - Returns tooltip text with full path and change type
   - Format: "Added /path/to/file" or "Modified /path/to/file" or "Deleted /path/to/file"
   - Determines file state from FileHistory records

**Implementation Notes**:
- Uses `last_change_type` property from FileBase (which queries FileHistory internally)
- For new files: `last_change_type == "added"`
- For deleted files: `last_change_type == "deleted"`
- For modified files: `last_change_type == "modified"` or default case

### Factory Implementation

Create factory that binds to File properties:
- Uses `Gtk.SignalListItemFactory` with setup and bind callbacks
- Creates Gtk.Label with `use_markup = true` for Pango markup support
- Binds label text to `file.display_approval_text` using `bind_property()`
- Binds tooltip to `file.display_approval_tooltip` using `bind_property()`
- Uses `GLib.BindingFlags.SYNC_CREATE` for automatic updates when properties change

### Visual Indicators

- **New files**: Show "+ filename" (from `display_approval_text` property)
- **Deleted files**: Show strikethrough using Pango markup: `<s>filename</s>` (from `display_approval_text` property)
- **Modified files**: Show normal filename (from `display_approval_text` property)
- **Tooltip**: From `display_approval_tooltip` property ("Added /path/to/file" or "Modified /path/to/file" or "Deleted /path/to/file")

### Selection Management

- Block selection change handler when programmatically changing selection:
  ```vala
  public void select_file(File file) {
      this.blocking_selection_handler = true;
      // Get file from review_files.file_map (verifies it exists)
      // Find position in sorted model using find_position()
      // Set selection and selected_file
      this.blocking_selection_handler = false;
  }
  ```

- Only process selection changes when not blocked:
  ```vala
  private void update_selected_file() {
      if (this.selection.selected == Gtk.INVALID_LIST_POSITION) {
          this.selected_file = null;
          return;
      }
      var file = this.sorted_model.get_item_typed(this.selection.selected);
      this.selected_file = file;
      this.file_selected(file);  // Emit signal
  }
  ```

- Selection changed signal handler checks blocking flag:
  ```vala
  this.selection.selection_changed.connect(() => {
      if (this.blocking_selection_handler) {
          return;
      }
      this.update_selected_file();
  });
  ```

### Active Project Monitoring

- Connect to `project_manager.active_project_changed` signal → calls `activate_project()`
- `activate_project()` method handles project changes:
  - Clears previous `review_files_handler_id` (if any)
  - Creates new sorted model with `active_project.review_files` (or empty store if null)
  - Updates selection model to use new sorted model
  - Hides button initially
  - If project is null, returns early
  - Connects to new project's `review_files.items_changed` signal (stores handler ID)
  - Updates button visibility
- Initializes with current active_project in constructor

### Button Visibility

- Monitor `review_files.items_changed` signal to update button visibility:
  - When items are added/removed: Check if `review_files.get_n_items() > 0`
  - Show button (`this.visible = true`) if there are files needing approval
  - Hide button (`this.visible = false`) if there are no files needing approval
- No need to monitor for popover resizing - size is calculated when popover is shown

### Popover Display

- Use `Gtk.EventControllerMotion` for mouse tracking:
  - Add motion controller to button (`this`) → `button_motion`
  - Add motion controller to popover → `popover_motion`
  - Set popover parent to `this` using `popover.set_parent(this)`
  - Popover has `autohide = false` to prevent automatic hiding

- Show/hide behavior with delayed hiding:
  - **Mouse enters button**: Show popover immediately (if not in cooldown), cancel hide timeout, update size
  - **Mouse leaves button**: Start 3 second timer to hide popover (if not in cooldown)
  - **Mouse enters popover**: Cancel hide timeout, keep popover visible
  - **Mouse leaves popover**: Start 3 second timer to hide popover
  - **Button clicked**: Hide popover immediately, start 3 second cooldown (ignore mouseover during cooldown)
  - **Click outside button/popover**: Popover's `closed` signal fires, cancel hide timeout

- Implementation details:
  - Uses `GLib.Timeout.add_seconds(3, ...)` for 3 second delays
  - Stores timeout ID in `hide_timeout_id` to cancel when needed
  - Tracks cooldown state (`in_cooldown` boolean flag + `cooldown_timeout_id`) for button click behavior
  - Connects to button's `clicked` signal with lambda (calls `popdown()` and `start_cooldown()`)
  - Detects clicks outside via popover's `closed` signal (fires when clicking outside)
  - Popover size is updated when shown (in button_motion.enter handler)
  - ListView is wrapped in Gtk.ScrolledWindow inside popover

### Popover Sizing

- Popover height based on list size:
  - `update_popover_size()` - Calculate height based on number of items
  - Formula: `n_items * 30px`, clamped between 100px (min) and 400px (max)
  - Uses `set_size_request(-1, calculated_height)` on popover's child (ScrolledWindow)
  - Size is calculated when popover is shown (in button_motion.enter handler)
  - No need to monitor changes for resizing

### Button Configuration

- The Approvals button (extends Gtk.Button):
  - Shows task-due icon (set `icon_name = "task-due"` in constructor)
  - Is the container element for the popover (popover parent is `this`)
  - Uses `Gtk.EventControllerMotion` for mouse tracking
  - Shows popover on mouseover with delayed hide behavior (see Popover Display section)
  - Initially hidden (`visible = false`), shown when `review_files.get_n_items() > 0`

## Implementation Tasks

### FileBase Properties
- [x] Add `display_approval_text` property to FileBase class
- [x] Add `display_approval_tooltip` property to FileBase class
- [x] Implement logic to determine file state from `last_change_type` property
- [x] Format text with "+" prefix for new files (when `last_change_type == "added"`)
- [x] Format text with strikethrough for deleted files (when `last_change_type == "deleted"`)
- [x] Format tooltip with change type and full path

### Approvals Widget
- [x] Create `liboccoder/Approvals.vala` class
- [x] Extend Gtk.Button
- [x] Constructor takes `ProjectManager` parameter
- [x] Set button icon_name to "task-due" in constructor
- [x] Store `project_manager` as private field
- [x] Create internal Gtk.Popover (with autohide = false)
- [x] Set popover parent to `this` (the button) using `popover.set_parent(this)`
- [x] Create Gtk.ListView inside popover with Gtk.SingleSelection
- [x] Create `List.SortedList` to sort by last_modified (descending) using `create_sorted_model()`
- [x] Wrap ListView in Gtk.ScrolledWindow inside popover
- [x] Create factory for list items (bind to `display_approval_text` and `display_approval_tooltip`)
- [x] Add `selected_file` property (private)
- [x] Implement selection management with blocking (`blocking_selection_handler`)
- [x] Implement `select_file()` method (public, blocks handler)
- [x] Implement `select_next()` method (private, blocks handler via selection change)
- [x] Implement `clear_selection()` method (private, blocks handler)
- [x] Implement `update_selected_file()` method (private, emits file_selected signal)
- [x] Connect to `project_manager.active_project_changed` signal → `activate_project()`
- [x] Update backing store when active_project changes (in `activate_project()`)
- [x] Connect to `active_project.review_files.items_changed` signal (stores handler ID)
- [x] Implement `update_button_visibility()` method (show/hide button based on count)
- [x] Implement `activate_project()` method (handles project changes, connects signals)
- [x] Implement `create_sorted_model()` method (creates sorted list with custom sorter)
- [x] Implement `update_popover_size()` method (adjust height based on list size, called when popover shown)
- [x] Add `Gtk.EventControllerMotion` to button (`this`) → `button_motion`
- [x] Add `Gtk.EventControllerMotion` to popover → `popover_motion`
- [x] Implement button_motion.enter handler (show popover, cancel hide timeout, update size, check cooldown)
- [x] Implement button_motion.leave handler (schedule hide in 3 seconds, check cooldown)
- [x] Implement popover_motion.enter handler (cancel hide timeout)
- [x] Implement popover_motion.leave handler (schedule hide in 3 seconds)
- [x] Implement `cancel_hide_timeout()` method
- [x] Implement `schedule_hide()` method (3 second delay using Timeout.add_seconds)
- [x] Connect button's `clicked` signal (lambda: popdown, start_cooldown)
- [x] Implement `start_cooldown()` method (3 second cooldown, ignore mouseover)
- [x] Connect popover's `closed` signal (cancel hide timeout)
- [x] Connect selection's `selection_changed` signal (calls update_selected_file if not blocked)
- [x] Emit file_selected signal when file selected (in update_selected_file)
- [x] Initialize with current active_project
- [x] Initially hide button

## Testing

### FileBase Properties
- Test `display_approval_text` returns "+ filename" for new files
- Test `display_approval_text` returns strikethrough for deleted files
- Test `display_approval_text` returns normal filename for modified files
- Test `display_approval_tooltip` returns "Added /path/to/file" for new files
- Test `display_approval_tooltip` returns "Modified /path/to/file" for modified files
- Test `display_approval_tooltip` returns "Deleted /path/to/file" for deleted files
- Test properties update when FileHistory records change

### Approvals Widget
- Test Approvals button displays correctly
- Test Approvals button shows task-due icon
- Test Approvals popover displays files correctly
- Test Approvals popover shows "+" prefix for new files (from property)
- Test Approvals popover shows strikethrough for deleted files (from property)
- Test Approvals popover tooltips show correct state (from property)
- Test clicking file in Approvals opens it in codeview
- Test select_file() blocks selection handler
- Test select_next() blocks selection handler
- Test clear_selection() blocks selection handler
- Test selection handler processes user clicks correctly
- Test popover updates when ReviewFiles changes
- Test popover handles empty ReviewFiles
- Test button monitors active_project_changed signal
- Test button updates backing store when active_project changes
- Test button disconnects from previous project's signals
- Test button connects to new project's review_files signals
- Test button visibility updates when ReviewFiles.items_changed signal is emitted
- Test button is visible when review_files.get_n_items() > 0
- Test button is hidden when review_files.get_n_items() == 0
- Test button visibility updates when files are added to ReviewFiles
- Test button visibility updates when files are removed from ReviewFiles
- Test popover appears immediately when mouse enters button
- Test popover hides 3 seconds after mouse leaves button (if not entering popover)
- Test popover stays visible when mouse enters popover from button
- Test popover hides 3 seconds after mouse leaves popover (if not entering button)
- Test popover stays visible when mouse enters button from popover
- Test popover hides immediately when button is clicked
- Test popover ignores mouseover for 3 seconds after button click
- Test popover appears again after cooldown period ends
- Test popover hides immediately when clicking outside button/popover (within 3 seconds of leaving)
- Test hide timeout is cancelled when mouse enters popover
- Test hide timeout is cancelled when mouse enters button
- Test popover height adjusts based on list size when shown (no monitoring needed)
- Test popover updates selected row when shown

## Implementation Notes & Differences

### Differences from Original Plan

1. **Signals**: The `approve_requested` and `next_requested` signals were not implemented. Only `file_selected` signal exists. This may be intentional if approval workflow is handled elsewhere (e.g., in UI integration phase 3.8.4).

2. **Method Visibility**:
   - `selected_file` property is **private** (not public) - external code cannot access it directly
   - `select_next()` is **private** (not public) - external code cannot call it directly
   - `clear_selection()` is **private** (not public) - external code cannot call it directly
   - **Note**: If phase 3.8.4 (UI Integration) needs these, they may need to be made public or getter methods added

3. **Model Type**: Uses `List.SortedList<File>` instead of `Gtk.SortListModel`. This is a custom class that provides sorting functionality.

4. **Signal Handlers**: Most signal handlers use lambdas instead of named methods (e.g., `button_motion.enter.connect(() => {...})` instead of `on_button_motion_enter()`). This is a valid implementation approach.

5. **Selection Handling**: Selection changes are handled via `selection_changed` signal rather than `item_activated`. This means clicking an item changes selection and triggers `file_selected` signal.

6. **Popover Shown Handler**: No `on_popover_shown()` method exists. Popover size is updated in the button_motion.enter handler when popover is shown.

7. **File Lookup**: Uses `review_files.file_map.get(file.path)` to verify file exists in ReviewFiles before selecting it.

8. **Handler Tracking**: Uses `ulong? review_files_handler_id` to track and disconnect from previous project's signals.

9. **ScrolledWindow**: ListView is wrapped in Gtk.ScrolledWindow inside the popover to enable scrolling when list is long.

10. **SortedList Methods**: Uses custom `List.SortedList` class with `find_position()` and `get_item_typed()` methods for finding and retrieving items.

### Potential Gaps

1. **Public API for Selection**: If external code (e.g., UI integration) needs to:
   - Get currently selected file → may need public getter or `selected_file` property made public
   - Select next file → may need `select_next()` made public
   - Clear selection → may need `clear_selection()` made public

2. **Approval Signals**: If approval workflow needs `approve_requested` or `next_requested` signals, they would need to be added.

3. **Popover Selection Update**: The plan mentioned updating selected row when popover is shown, but this wasn't implemented. If needed, it could be added to the button_motion.enter handler.

### Implementation Quality

- ✅ All core functionality implemented
- ✅ Proper signal handling and cleanup
- ✅ Selection blocking works correctly
- ✅ Mouse tracking and popover behavior implemented
- ✅ Button visibility management works
- ✅ Active project monitoring works
- ✅ FileBase properties implemented correctly
