# 1.2.9 Refactor Serialization Issues

## Classes Implementing Json.Serializable

All classes in the codebase that implement `Json.Serializable`:

**Response Classes:**
- `Response.Base` (abstract base)
- `Response.Model` (extends Response.Base)
- `Response.Chat` (extends Response.Base)
- `Response.Generate` (extends Response.Base)
- `Response.Embed` (extends Response.Base)
- `Response.Pull` (extends Response.Base)
- `Response.ToolCall`
- `Response.CallFunction`

**Call Classes:**
- `Call.Base` (abstract base)
- `Call.Chat` (extends Call.Base)
- `Call.Options`

**Message Classes:**
- `Message`

**Settings Classes:**
- `Settings.Config2`
- `Settings.Config1`
- `Settings.Connection`
- `Settings.ModelUsage`
- `Settings.BaseToolConfig`
- `Settings.ModelTag`
- `Settings.AvailableModel`

**History Classes:**
- `History.SessionBase` (abstract base)
- `History.Session` (extends SessionBase)
- `History.EmptySession` (extends SessionBase)
- `History.SessionPlaceholder` (extends SessionBase)
- `History.SessionJson` (extends SessionBase)

**Tool Classes:**
- `Tool.BaseTool` (abstract base)
- `Tool.Function`
- `Tool.RequestBase` (abstract base)
- `Tool.Param` (abstract base)
- `Tool.ParamSimple` (extends Param)
- `Tool.ParamArray` (extends Param)
- `Tool.ParamObject` (extends Param)

## Overview

Fix JSON serialization warnings by identifying and blacklisting internal GObject properties that cannot be serialized, while keeping the default serialize behavior for all valid properties.

## Problem Summary

**Root Cause**: When `serialize_property` or `deserialize_property` methods call default handlers in their default cases, JSON-GLib attempts to serialize/deserialize ALL properties of the object, including internal GObject properties with unsupported types:
- `GeeBidirList` - Internal Gee collection type
- `GType` - GLib type system type  
- `gpointer` - Generic pointer type (appears twice in warnings)

**Warning Messages**:
```
(ollmchat:26804): Json-WARNING **: 10:24:36.485: Unsupported type `GeeBidirList'
(ollmchat:26804): Json-WARNING **: 10:24:36.485: Unsupported type `GType'
(ollmchat:26804): Json-WARNING **: 10:24:36.485: Unsupported type `gpointer'
(ollmchat:26804): Json-WARNING **: 10:24:36.485: Unsupported type `gpointer'
```

**Impact**: 
- Warnings clutter console output
- Potential performance impact from attempting to serialize unsupported types
- May mask other serialization issues

**Solution**: Identify the specific property names that correspond to these unsupported types and add them to the blacklist (return `null`/`false` for them), while keeping `default_serialize_property`/`default_deserialize_property` in the default case for all other properties.

## Properties to Blacklist

**Status**: Property names need to be identified. The warnings indicate 4 properties with unsupported types, but the actual property names are unknown and need to be determined.

**Required investigation**: 
- Identify which property names have type `GeeBidirList` (1 property)
- Identify which property names have type `GType` (1 property)
- Identify which property names have type `gpointer` (2 properties)
- Determine which class(es) each property belongs to (Message, ToolCall, CallFunction, Model)

**Note**: These are properties we have added to our classes but forgot to blacklist. They need to be identified by checking which properties have these unsupported types during serialization.

### Step 2: Add Blacklist Cases

Once property names are identified, add them to the blacklist in each affected class's `serialize_property`/`deserialize_property` methods.

## Implementation Steps

### Step 1: Fix Message.serialize_property

**File**: [`libollmchat/Message.vala`](libollmchat/Message.vala)

**Current State**: Line 307 calls `default_serialize_property` in default case, which is correct. We need to add blacklist cases for internal properties.

**Fix**: Add blacklist cases before the default case for properties with unsupported types. Property names to be determined:

```vala
case "PROPERTY_NAME_1":  // GeeBidirList property
case "PROPERTY_NAME_2":  // GType property
case "PROPERTY_NAME_3":  // gpointer property
case "PROPERTY_NAME_4":  // gpointer property
    return null;

default:
    return default_serialize_property(property_name, value, pspec);
```

**Location**: Add before line 306 (before default case)

**TODO**: Identify actual property names causing warnings

### Step 2: Fix Response.ToolCall.deserialize_property

**File**: [`libollmchat/Response/ToolCall.vala`](libollmchat/Response/ToolCall.vala)

**Current State**: Line 84 calls `default_deserialize_property` in default case, which is correct.

**Fix**: Add blacklist cases before the default case. Property names to be determined:

```vala
case "PROPERTY_NAME_1":  // Property with unsupported type
case "PROPERTY_NAME_2":  // Property with unsupported type
    return false;

default:
    return default_deserialize_property(property_name, out value, pspec, property_node);
```

**Location**: Add before line 83 (before default case)

**TODO**: Identify actual property names causing warnings

### Step 3: Fix Response.CallFunction.deserialize_property

**File**: [`libollmchat/Response/CallFunction.vala`](libollmchat/Response/CallFunction.vala)

**Current State**: Line 89 calls `default_deserialize_property` in default case, which is correct.

**Fix**: Add blacklist cases before the default case. Property names to be determined:

```vala
case "PROPERTY_NAME_1":  // Property with unsupported type
case "PROPERTY_NAME_2":  // Property with unsupported type
    return false;

default:
    return default_deserialize_property(property_name, out value, pspec, property_node);
```

**Location**: Add before line 88 (before default case)

**TODO**: Identify actual property names causing warnings

### Step 4: Fix Response.Model.serialize_property

**File**: [`libollmchat/Response/Model.vala`](libollmchat/Response/Model.vala)

**Current State**: Line 263 calls `base.serialize_property` in default case, which is correct.

**Fix**: Add blacklist cases before the default case. Property names to be determined:

```vala
case "PROPERTY_NAME_1":  // Property with unsupported type
case "PROPERTY_NAME_2":  // Property with unsupported type
    return null;

default:
    return base.serialize_property(property_name, value, pspec);
```

**Location**: Add before line 261 (before default case)

**TODO**: Identify actual property names causing warnings

### Step 5: Fix Response.Model.deserialize_property

**File**: [`libollmchat/Response/Model.vala`](libollmchat/Response/Model.vala)

**Current State**: Line 291 calls `default_deserialize_property` in default case, which is correct.

**Fix**: Add blacklist cases before the default case. Property names to be determined:

```vala
case "PROPERTY_NAME_1":  // Property with unsupported type
case "PROPERTY_NAME_2":  // Property with unsupported type
    return false;

default:
    return default_deserialize_property(property_name, out value, pspec, property_node);
```

**Location**: Add before line 289 (before default case)

**TODO**: Identify actual property names causing warnings

## Summary - Properties to Blacklist

**Status**: Property names need to be identified through investigation.

**Required**: Find the actual property names that have these types:
- 1 property with type `GeeBidirList`
- 1 property with type `GType`
- 2 properties with type `gpointer`

**Investigation needed**: 
- Check which properties are being accessed during serialization when warnings occur
- Inspect ParamSpec objects to identify property names with unsupported types
- Determine which class(es) each property belongs to (Message, ToolCall, CallFunction, Model)

## Rationale

The existing approach (blacklist + default serialize) is correct and works in most cases. The issue is that we're missing some internal GObject properties from the blacklist. By identifying and explicitly blacklisting these properties, we:

1. Keep the default serialize behavior for all valid properties
2. Only skip the problematic internal properties
3. Maintain the existing pattern used throughout the codebase

This approach is consistent with other classes in the codebase (e.g., `Settings.Connection.serialize_property` at line 180-186, `Response.Model.serialize_property` at line 241-247).

## Testing

1. **Run the application** and verify warnings no longer appear in console output
2. **Test message serialization**: Create messages with various properties (role, content, tool_calls, thinking, etc.) and verify they serialize correctly
3. **Test message deserialization**: Load saved sessions and verify messages deserialize correctly
4. **Test tool call serialization**: Create messages with tool_calls and verify they serialize/deserialize correctly
5. **Test model serialization**: Verify model objects serialize/deserialize correctly in config files
6. **Verify no regressions**: Ensure all previously serialized properties still serialize correctly

## Files Modified

- [`libollmchat/Message.vala`](libollmchat/Message.vala) - Add blacklist cases for internal GObject properties in serialize_property
- [`libollmchat/Response/ToolCall.vala`](libollmchat/Response/ToolCall.vala) - Add blacklist cases for internal GObject properties in deserialize_property
- [`libollmchat/Response/CallFunction.vala`](libollmchat/Response/CallFunction.vala) - Add blacklist cases for internal GObject properties in deserialize_property
- [`libollmchat/Response/Model.vala`](libollmchat/Response/Model.vala) - Add blacklist cases for internal GObject properties in serialize_property and deserialize_property

## Notes

- Property names in the examples above are placeholders - actual property names need to be identified through investigation
- The warnings indicate 4 properties total: 1 GeeBidirList, 1 GType, and 2 gpointer properties
- These properties are likely from GObject base class or Gee collection internals
- Once identified, the blacklist approach will prevent warnings while maintaining full serialization of valid properties
