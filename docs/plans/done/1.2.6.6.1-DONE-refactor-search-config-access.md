# 1.2.6.6.1. Refactor Search, Indexer, and Analysis Config Access

## Overview

Refactor Search, Indexer, and Analysis to use instance methods instead of static calls for accessing and validating tool config. All three classes should use `this.config` to fetch, validate, and access model configurations. Remove the static `CodebaseSearchToolConfig.tool_config()` method completely.

**Parent Plan**: [1.2.6.6. Update Search](./1.2.6.6-DONE-update-search.md)

## Status

âœ… **DONE** - Search, Indexer, and Analysis all extend VectorBase and use instance methods for config access.

## Goal

Search, Indexer, and Analysis should use instance methods to:
1. Get the tool config from `this.config`
2. Validate it
3. Get the connection for embedding/analysis models

This removes the dependency on static method calls and Client objects with config, making the code more object-oriented. The static `CodebaseSearchToolConfig.tool_config()` method will be **completely removed** after all users are refactored.

## Current Implementation

### Search

**File**: `libocvector/Search/Search.vala` (lines 196-209)

```vala
// Static call to get tool config
var tool_config = yield OLLMvector.Tool.CodebaseSearchToolConfig.tool_config(this.config);
if (!tool_config.enabled || !tool_config.embed.is_valid) {
    throw new GLib.IOError.FAILED("Codebase search tool not properly configured");
}

var connection = this.config.connections.get(tool_config.embed.connection);
if (connection == null) {
    throw new GLib.IOError.FAILED("Embedding connection not found in config");
}
```

**Problem**: Uses static method call instead of instance method. Validation and connection retrieval should be encapsulated in Search class.

### Indexer

**File**: `libocvector/Indexing/Indexer.vala` (lines 81-93, 143-148, 258-259)

```vala
// Takes clients with config (old pattern)
public Indexer(
    OLLMchat.Client analysis_client,
    OLLMchat.Client embed_client,
    OLLMvector.Database vector_db,
    SQ.Database sql_db,
    OLLMfiles.ProjectManager manager)

// Uses embed_client.config
var vector_builder = new VectorBuilder(
    this.embed_client.config, this.vector_db, this.sql_db);

// Uses embed_client for dimension
var dimension = yield OLLMvector.Database.get_embedding_dimension(this.embed_client);
this.vector_db = new OLLMvector.Database(this.embed_client, this.vector_db_path, dimension);
```

**Problem**: Takes Client objects with config instead of Config2. Should use instance methods to get connections from config.

### Analysis

**File**: `libocvector/Indexing/Analysis.vala` (lines 45-50, 308-314)

```vala
// Takes client with config (old pattern)
public Analysis(OLLMchat.Client client, SQ.Database sql_db)

// Uses static call to get tool config
var tool_config = yield OLLMvector.Tool.CodebaseSearchToolConfig.tool_config(this.client.config);
if (!tool_config.enabled || !tool_config.analysis.is_valid) {
    throw new GLib.IOError.FAILED("Codebase analysis tool is not configured or enabled correctly.");
}

var analysis_usage = tool_config.analysis;
var analysis_connection = this.client.config.connections.get(analysis_usage.connection);
```

**Problem**: Takes Client with config and uses static method call. Should take Config2 and use instance method to get analysis connection.

## Class Structure

All three classes:
- **Search**: `OLLMvector.Search` namespace, extends `Object`
- **Indexer**: `OLLMvector.Indexing` namespace, extends `Object`
- **Analysis**: `OLLMvector.Indexing` namespace, extends `Object`

They are in different namespaces (Search vs Indexing), but all extend `Object`. They share the same pattern of needing to get and validate tool config from `this.config`.

**Solution**: Create a base class `VectorBase` in the `OLLMvector` namespace that all three classes can extend. This base class will provide a shared `connection(string usage_type)` method that handles both "embed" and "analysis" usage types.

## Proposed Fix

### Create VectorBase Base Class

Create a base class in `OLLMvector` namespace that provides shared connection logic:

```vala
namespace OLLMvector
{
    /**
     * Base class for vector operations that need tool config access.
     * 
     * Provides shared functionality for getting and validating connections
     * from codebase search tool configuration.
     */
    public abstract class VectorBase : Object
    {
        protected OLLMchat.Settings.Config2 config;
        
        protected VectorBase(OLLMchat.Settings.Config2 config)
        {
            this.config = config;
        }
        
        /**
         * Gets a connection from validated tool config.
         * 
         * Gets tool config from this.config, validates the specified ModelUsage,
         * and returns the connection.
         * 
         * @param usage_type The usage type: "embed" or "analysis"
         * @return The Connection for the specified usage type
         * @throws GLib.Error if tool config is not properly configured
         */
        protected async Settings.Connection connection(string usage_type) throws GLib.Error
        {
            // Get tool config from this.config
            if (!this.config.tools.has_key("codebase_search")) {
                throw new GLib.IOError.FAILED("Codebase search tool config not found");
            }
            
            var tool_config = this.config.tools.get("codebase_search") as OLLMvector.Tool.CodebaseSearchToolConfig;
            if (!tool_config.enabled) {
                throw new GLib.IOError.FAILED("Codebase search tool is disabled");
            }
            
            // Get the appropriate ModelUsage
            OLLMchat.Settings.ModelUsage usage;
            switch (usage_type) {
                case "embed":
                    usage = tool_config.embed;
                    break;
                case "analysis":
                    usage = tool_config.analysis;
                    break;
                default:
                    throw new GLib.IOError.INVALID_ARGUMENT("Invalid usage_type: %s (must be 'embed' or 'analysis')".printf(usage_type));
            }
            
            // Validate ModelUsage
            if (!(yield usage.verify_model(this.config))) {
                throw new GLib.IOError.FAILED("Codebase search tool %s model verification failed".printf(usage_type));
            }
            
            // Get connection
            var connection = this.config.connections.get(usage.connection);
            if (connection == null) {
                throw new GLib.IOError.FAILED("%s connection not found in config".printf(usage_type));
            }
            
            return connection;
        }
    }
}
```

### Search

Update Search to extend VectorBase and use the shared connection method:

```vala
namespace OLLMvector.Search
{
    public class Search : VectorBase
    {
        // ... other fields ...
        
        public Search(
            OLLMvector.Database vector_db,
            SQ.Database sql_db,
            OLLMchat.Settings.Config2 config,
            OLLMfiles.Folder folder,
            string query,
            uint64 max_results = 10,
            Gee.ArrayList<int> filtered_vector_ids,
            string? element_type_filter = null
        )
        {
            base(config);
            // ... initialize other fields ...
        }
        
        public async Gee.ArrayList<SearchResult> execute() throws GLib.Error
        {
            // ... normalize query ...
            
            // Get embedding connection using base class method
            var connection = yield this.connection("embed");
            
            // Get model from tool config (already validated above)
            var tool_config = this.config.tools.get("codebase_search") as OLLMvector.Tool.CodebaseSearchToolConfig;
            var model = tool_config.embed.model;
            
            var client = new OLLMchat.Client(connection) {
                config = this.config
            };
            var embed_response = yield client.embed(model, normalized_query);
            // ... rest of implementation ...
        }
    }
}
```

### Indexer

Update Indexer to extend VectorBase and use the shared connection method:

```vala
namespace OLLMvector.Indexing
{
    public class Indexer : VectorBase
    {
        private OLLMvector.Database vector_db;
        private SQ.Database sql_db;
        private OLLMfiles.ProjectManager manager;
        
        public Indexer(
            OLLMchat.Settings.Config2 config,
            OLLMvector.Database vector_db,
            SQ.Database sql_db,
            OLLMfiles.ProjectManager manager)
        {
            base(config);
            this.vector_db = vector_db;
            this.sql_db = sql_db;
            this.manager = manager;
        }
        
        public async bool index_file(OLLMfiles.File file, bool force = false) throws GLib.Error
        {
            // ... tree parsing ...
            
            // Get analysis connection using base class method
            var analysis_conn = yield this.connection("analysis");
            var tool_config = this.config.tools.get("codebase_search") as OLLMvector.Tool.CodebaseSearchToolConfig;
            var analysis_client = new OLLMchat.Client(analysis_conn) {
                config = this.config
            };
            
            var analysis = new Analysis(this.config, this.sql_db);
            tree = yield analysis.analyze_tree(tree);
            
            // VectorBuilder already takes config
            var vector_builder = new VectorBuilder(
                this.config, this.vector_db, this.sql_db);
            yield vector_builder.process_file(tree);
            // ...
        }
        
        public async void reset_database(string vector_db_path) throws GLib.Error
        {
            // Get embed connection using base class method
            var embed_conn = yield this.connection("embed");
            var tool_config = this.config.tools.get("codebase_search") as OLLMvector.Tool.CodebaseSearchToolConfig;
            var embed_client = new OLLMchat.Client(embed_conn) {
                config = this.config
            };
            
            var dimension = yield OLLMvector.Database.get_embedding_dimension(embed_client);
            this.vector_db = new OLLMvector.Database(embed_client, vector_db_path, dimension);
            // ...
        }
    }
}
```

### Analysis

Update Analysis to extend VectorBase and use the shared connection method:

```vala
namespace OLLMvector.Indexing
{
    public class Analysis : VectorBase
    {
        private SQ.Database sql_db;
        private PromptTemplate? cached_template = null;
        
        public Analysis(OLLMchat.Settings.Config2 config, SQ.Database sql_db)
        {
            base(config);
            this.sql_db = sql_db;
        }
        
        public async Tree analyze_tree(Tree tree) throws GLib.Error
        {
            // ... prepare analysis ...
            
            // Get analysis connection using base class method
            var analysis_conn = yield this.connection("analysis");
            var tool_config = this.config.tools.get("codebase_search") as OLLMvector.Tool.CodebaseSearchToolConfig;
            var analysis_client = new OLLMchat.Client(analysis_conn) {
                config = this.config
            };
            
            var chat = new OLLMchat.Call.Chat(analysis_client.connection, tool_config.analysis.model, tool_config.analysis.options) {
                stream = true
            };
            // ... rest of implementation ...
        }
    }
}
```

## Implementation Steps

### Create VectorBase

1. Create `libocvector/VectorBase.vala` in `OLLMvector` namespace
   - Abstract base class extending `Object`
   - Protected `config` field
   - Protected constructor taking `Config2`
   - Protected `connection(string usage_type)` method
     - Gets tool config from `this.config.tools["codebase_search"]`
     - Validates the specified ModelUsage ("embed" or "analysis")
     - Gets connection from `this.config.connections`
     - Throws error if any step fails

### Search

2. Update Search to extend `VectorBase`
   - Change `extends Object` to `extends VectorBase`
   - Update constructor to call `base(config)`
   - Remove `private config` field (inherited from VectorBase)
   - Update `execute()` to use `yield this.connection("embed")`

### Indexer

3. Update Indexer to extend `VectorBase`
   - Change `extends Object` to `extends VectorBase`
   - Update constructor to take `Config2` instead of clients
   - Call `base(config)` in constructor
   - Remove client fields
   - Update `index_file()` to use `yield this.connection("analysis")`
   - Update `reset_database()` to use `yield this.connection("embed")`
   - Update Analysis constructor call to pass `this.config` instead of client

4. Find all Indexer constructor call sites and update them to pass `config` instead of clients

### Analysis

5. Update Analysis to extend `VectorBase`
   - Change `extends Object` to `extends VectorBase`
   - Update constructor to take `Config2` instead of `Client`
   - Call `base(config)` in constructor
   - Remove `private client` field
   - Update `analyze_tree()` to use `yield this.connection("analysis")`

6. Find all Analysis constructor call sites and update them to pass `config` instead of client

### Remove Static Method

5. Refactor remaining users of static `tool_config()` method:

   **Database.check_required_models_available()** (line 66):
   ```vala
   // Inline validation logic
   if (!config.tools.has_key("codebase_search")) {
       return false;
   }
   var tool_config = config.tools.get("codebase_search") as CodebaseSearchToolConfig;
   if (!tool_config.enabled) {
       return false;
   }
   // Validate both embed and analysis
   if (!(yield tool_config.embed.verify_model(config))) {
       return false;
   }
   if (!(yield tool_config.analysis.verify_model(config))) {
       return false;
   }
   return true;
   ```

   **Window.vala** (line 484):
   ```vala
   // Inline enabled check
   if (!config.tools.has_key("codebase_search")) {
       // tool disabled
       return;
   }
   var tool_config = config.tools.get("codebase_search") as CodebaseSearchToolConfig;
   if (!tool_config.enabled) {
       // tool disabled
       return;
   }
   ```

   **VectorAppBase.vala** (line 99):
   - Already has access to `this.config`
   - Can inline the tool config access and validation
   - Or create instance methods similar to Search/Indexer/Analysis

   **oc-vector-index.vala** (line 182):
   - Already creates clients via `tool_config_client()`
   - Can inline the tool config access

6. Remove static `CodebaseSearchToolConfig.tool_config()` method from `CodebaseSearchToolConfig.vala`

## Benefits

1. **Encapsulation**: Config access and validation is encapsulated in Search class
2. **No static dependencies**: Search doesn't depend on static methods
3. **Reusability**: Methods can be reused if needed elsewhere in Search class
4. **Testability**: Instance methods are easier to test and mock
5. **Consistency**: Follows object-oriented principles

## Files to Modify

- `libocvector/VectorBase.vala` - **NEW FILE** - Create base class with `connection(string usage_type)` method
- `libocvector/Search/Search.vala` - Extend VectorBase, update execute() to use `connection("embed")`
- `libocvector/Indexing/Indexer.vala` - Extend VectorBase, update constructor to take Config2, update methods to use `connection()`
- `libocvector/Indexing/Analysis.vala` - Extend VectorBase, update constructor to take Config2, update analyze_tree() to use `connection("analysis")`
- `libocvector/Tool/CodebaseSearchToolConfig.vala` - Remove static `tool_config()` method
- `libocvector/Database.vala` - Inline validation logic in `check_required_models_available()`
- `ollmapp/Window.vala` - Inline enabled check
- `examples/VectorAppBase.vala` - Refactor to use instance methods or inline
- `examples/oc-vector-index.vala` - Inline validation or refactor
- Find and update all Indexer and Analysis constructor call sites

## Related Plans

- [1.2.6.6. Update Search](./1.2.6.6-DONE-update-search.md) - Parent plan

