# 3.3. Chat History System

## Overview

Comprehensive chat history system for OLLMchat, including persistent storage, browsing, restoration, and support for multiple concurrent chat sessions.

## Status

✅ **DONE** - Core functionality fully implemented. Remaining work split into separate plans.

### Completed Features ✅

1. **Core History System**
   - ✅ History Manager (`OLLMchat.History.Manager`) - Fully implemented
   - ✅ Session classes (`Session`, `SessionBase`, `SessionPlaceholder`, `EmptySession`) - Fully implemented
   - ✅ SQLite database for session metadata - Implemented
   - ✅ JSON file storage for complete session data - Implemented
   - ✅ Directory structure (`~/.local/share/ollmchat/history/YYYY/MM/DD/`) - Implemented

2. **UI Components**
   - ✅ HistoryBrowser widget (`OLLMchatGtk.HistoryBrowser`) - Fully implemented with sorting, selection, and deletion
   - ✅ Session loading and switching - Implemented
   - ✅ Message persistence with special roles (user-sent, think-stream, content-stream, ui, end-stream) - Implemented

3. **Title Generation**
   - ✅ TitleGenerator class - Fully implemented
   - ✅ LLM-generated titles using `title_model` from config - Implemented
   - ✅ Fallback to default titles (first user message or "Untitled Chat") - Implemented

4. **Session Management**
   - ✅ Multiple concurrent chat sessions - Supported
   - ✅ Session activation/deactivation - Implemented
   - ✅ Unread message tracking - Implemented

5. **Application Structure**
   - ✅ Proper window structure with settings dialogs
   - ✅ UI components and layout implemented

## Implementation Details

### Features
- Save all chat conversations to disk in a structured format
- Provide a summary index for quick browsing
- Use LLM to generate meaningful titles for conversations
- Enable browsing and restoring old conversations
- Support multiple concurrent chat sessions

### Directory Structure

```
~/.local/share/ollmchat/
└── history/
    ├── 2025/
    │   └── 01/
    │       └── 15/
    │           ├── 14-30-45.json    # Individual chat session files
    │           └── 15-22-10.json
    └── ...
```

**Note**: Summary index is stored in SQLite database using `SQ/Database.vala` instead of `history.json`.

### File Format

Each chat session is saved as a JSON file with:
- `id` - Session identifier
- `updated_at` - Last update timestamp
- `title` - LLM-generated title
- `model` - Model used
- `child_chats` - Array of child chat IDs
- `messages` - Array of message objects

### Implemented Components
- ✅ History Manager (`OLLMchat.History.Manager`) - Manages sessions and SQLite database
- ✅ Session classes (`Session`, `SessionBase`, `SessionPlaceholder`, `EmptySession`) - Session persistence
- ✅ HistoryBrowser widget (`OLLMchatGtk.HistoryBrowser`) - UI for browsing sessions
- ✅ SQLite database for session metadata
- ✅ JSON file storage for complete session data
- ✅ Session loading and switching
- ✅ Message persistence with special roles (user-sent, think-stream, content-stream, ui, end-stream)

## Related Plans

- [3.3.1. Handle Invalid and Deleted Connections](./3.3.1-handle-invalid-deleted-connections.md) - Handle cases where sessions reference deleted connections
- [1.20. URGENT - About Dialog](./1.20-URGENT-about-dialog.md) - Add about dialog to application
