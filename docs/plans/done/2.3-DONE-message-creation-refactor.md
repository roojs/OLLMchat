# 2.3. DONE. Message Creation Refactor

## Overview

Refactor the client-side message handling to use a unified `message_created(Message m)` signal as the primary driver for both persistence (Manager) and UI display. This replaces the previous `on_chat_send` and `tool_message` handlers, creating dummy messages before prompt engine modification and ensuring the UI only has one entry per message (excluding chunks).

## Status

✅ **DONE** - Fully implemented.

## Implementation Details

### Key Changes
1. **Added `message_created` signal to Client** - Primary driver for message creation events
2. **Refactored Client.chat()** - Creates user-sent messages before prompt engine modification
3. **Refactored Call.Chat.exec_chat() and reply()** - Messages created via signal before API calls
4. **Replaced tool_message with message_created** - Tool status messages now use Message objects with "ui" role
5. **Updated SessionBase** - Handles `message_created` signal instead of `on_chat_send` and `tool_message`
6. **Updated Session** - Uses `on_message_created()` instead of `on_chat_send()`
7. **Updated Manager** - Has `message_created` signal that relays to UI
8. **Updated ChatWidget** - Connects to `manager.message_created` signal and displays messages based on `is_ui_visible` property

### Message Flow
1. User sends message → `ChatWidget.on_send_clicked()`
2. `Client.chat()` called
3. **Before** `prompt_assistant.fill()`: Create dummy user-sent Message → emit `message_created`
4. `prompt_assistant.fill()` modifies `chat_content`
5. If `system_content` set: Create system Message → emit `message_created`
6. `Call.Chat.exec_chat()` builds API request with modified content
7. Response received → create assistant Message → emit `message_created`
8. `message_created` → Manager → Session (save to log) + UI (display)

### Files Modified
- `src/OLLMchat/Client.vala` - Added `message_created` signal, refactored `chat()` method
- `src/OLLMchat/Call/Chat.vala` - Refactored `exec_chat()` and `reply()`, replaced `tool_message` calls
- `src/OLLMchat/History/SessionBase.vala` - Updated to handle `message_created` signal
- `src/OLLMchat/History/Session.vala` - Replaced `on_chat_send()` with `on_message_created()`
- `src/OLLMchat/History/Manager.vala` - Added `message_created` signal
- `src/OLLMchatGtk/ChatWidget.vala` - Updated to use `message_created` signal

### Benefits
- Single source of truth for message creation (`message_created` signal)
- Cleaner separation: messages created before prompt engine modification
- UI only displays messages once (via signal, not duplicate creation)
- Simplified persistence logic (just add message to list when signal received)
- Consistent message handling across all scenarios
