# 3.8.4. UI Integration

## Overview

Integrate Approvals widget into main UI with approve button and next button. The Approvals widget is already a button with popover (from 3.8.3), so we need to add the approve and next buttons near it and implement the approval workflow.

## Status

‚ùå **SUPERSEDED** - This plan has been superseded by plan 3.8.6 (UI Integration with Approvals Bar).

## Prerequisites

- Phase 3.8.3 must be completed (Approvals widget)

## Goals

1. Add Approvals button to main UI toolbar/header (serves as next button)
2. Add approve button near Approvals button (don't replace save button)
3. Add revert button near Approvals button
4. Implement approval workflow
5. Implement FileHistory approval
6. Implement FileHistory revert functionality
7. Connect buttons to Approvals widget signals

## Implementation Details

### Files to Modify

- `ollmapp/Window.vala` - Main UI integration
- `libocfiles/FileHistory.vala` - Add revert method
- `resources/style.css` - Add CSS classes for approve and reject buttons

### UI Layout

1. **Button Placement**:
   - Approvals button (already implemented in 3.8.3) - shows task-due icon, has popover on mouseover, serves as next button
   - Approve button - placed near Approvals button (e.g., in same toolbar/header area)
   - Revert button - placed near Approvals button
   - All buttons in toolbar/header area (not in split pane)

2. **Approvals Widget**:
   - Already implemented as `OLLMcoder.Approvals` (extends Gtk.Button)
   - Contains internal popover with file list
   - Handles its own visibility (shows/hides based on `review_files.get_n_items()`)
   - Emits `file_selected` signal when file is clicked
   - Has `select_file()`, `select_next()`, `get_selected_file()` methods

### Buttons

1. **Approve Button**:
   - Location: Near Approvals button (in toolbar/header area, don't replace save button)
   - Visibility: Only visible when a file in ReviewFiles is selected
   - CSS Classes: `oc-approve` and `suggested-action` (standard GTK4 primary button styling - green/blue background)
   - Track selected file: Store current file from `file_selected` signal (or add `get_selected_file()` method to Approvals widget)
   - Action: Approve selected file and all FileHistory items
   - Behavior: Disappears when file is approved or no file selected
   - Connects to Approvals widget's `file_selected` signal to update visibility

2. **Approvals Button** (serves as next button):
   - Already implemented in 3.8.3
   - Shows task-due icon, has popover on mouseover
   - Visibility: Handled by Approvals widget (shows/hides based on `review_files.get_n_items()`)
   - Tooltip: Can be updated to show "X more files to approve" (shows remaining count)
   - Action: Clicking files in popover selects them and opens in codeview
   - Note: The Approvals button itself serves as the "next" button - users can click files in the popover to navigate

3. **Revert Button**:
   - Location: Near Approvals button (in toolbar/header area)
   - Visibility: Only visible when a file in ReviewFiles is selected AND has FileHistory records with backup_path
   - CSS Class: `oc-reject` (no other styling)
   - Icon: "edit-undo" or similar revert icon
   - Tooltip: "Revert file to previous version"
   - Action: Restore file from FileHistory backup and update database
   - Behavior: Disappears when no file selected or file has no backup to restore from

### Approval Workflow

1. **Approve Button Clicked**:
   ```vala
   void on_approve_clicked() {
       // Get currently selected file (tracked from file_selected signal)
       var file = this.current_selected_file;
       if (file == null) {
           return;
       }
       
       // Approve file
       file.is_need_approval = false;
       file.saveToDB(this.project_manager.db, null, false);
       
       // Approve all FileHistory items for this file
       this.approve_file_history(file);
       
       // Update ReviewFiles (file will be removed)
       this.active_project.review_files.update_from(this.active_project.project_files);
       
       // Note: After update_from, the file will be removed from list
       // User can click next file in Approvals popover to continue
       
       // Update approve button visibility
       this.update_approve_button_visibility();
   }
   ```

2. **File Selected Signal Handler**:
   ```vala
   private OLLMfiles.File? current_selected_file = null;
   
   void on_file_selected(OLLMfiles.File file) {
       // Store currently selected file
       this.current_selected_file = file;
       
       // Update approve button visibility
       this.update_approve_button_visibility();
       
       // Update revert button visibility (async - called without await, will update when ready)
       this.update_revert_button_visibility.begin();
       
       // Optionally open file in codeview (if desired)
       // this.open_file_in_codeview(file);
   }
   ```

4. **Revert Button Clicked**:
   ```vala
   void on_revert_clicked() {
       // Get currently selected file
       var file = this.current_selected_file;
       if (file == null) {
           return;
       }
       
       // Get FileHistory records for this file
       var db = this.project_manager.db;
       var history_records = new Gee.ArrayList<OLLMfiles.FileHistory>();
       try {
           // Query for most recent FileHistory record with backup for this file
           yield OLLMfiles.FileHistory.query(db).select_async(
               "WHERE filebase_id = %lld AND backup_path != '' ORDER BY timestamp DESC LIMIT 1".printf(file.id),
               history_records
           );
       } catch (GLib.Error e) {
           GLib.warning("Failed to query FileHistory for revert: %s", e.message);
           return;
       }
       
       if (history_records.size == 0) {
           // No backup to restore from
           return;
       }
       
       // Get the most recent FileHistory record with backup
       var history = history_records[0];
       
       // Revert the file using FileHistory.revert() method
       try {
           yield history.revert(file);
           
           // Update ReviewFiles (file may be removed or updated)
           this.active_project.review_files.update_from(this.active_project.project_files);
           
           // Update button visibility
           this.update_revert_button_visibility();
           this.update_approve_button_visibility();
       } catch (GLib.Error e) {
           GLib.warning("Failed to revert file: %s", e.message);
       }
   }
   ```

### Button Visibility Management

1. **Approve Button Visibility**:
   ```vala
   void update_approve_button_visibility() {
       // Use tracked selected file from file_selected signal
       this.approve_button.visible = (this.current_selected_file != null);
   }
   ```

2. **Approvals Button Tooltip** (optional):
   ```vala
   void update_approvals_button_tooltip() {
       var count = this.active_project.review_files.get_n_items();
       this.approvals.tooltip_text = "%u more files to approve".printf(count);
   }
   ```

3. **Revert Button Visibility**:
   ```vala
   async void update_revert_button_visibility() {
       var file = this.current_selected_file;
       if (file == null) {
           this.revert_button.visible = false;
           return;
       }
       
       // Check if file has FileHistory records with backup_path
       // Query for FileHistory records with backup_path for this file
       var db = this.project_manager.db;
       var history_records = new Gee.ArrayList<OLLMfiles.FileHistory>();
       try {
           yield OLLMfiles.FileHistory.query(db).select_async(
               "WHERE filebase_id = %lld AND backup_path != '' LIMIT 1".printf(file.id),
               history_records
           );
       } catch (GLib.Error e) {
           GLib.warning("Failed to check FileHistory for revert button: %s", e.message);
           this.revert_button.visible = false;
           return;
       }
       
       this.revert_button.visible = (history_records.size > 0);
   }
   ```

4. **Connect to ReviewFiles Changes**:
   - Connect to `active_project.review_files.items_changed` signal
   - Update Approvals button tooltip when items change (optional)
   - Approve button visibility is handled by `file_selected` signal from Approvals widget
   - Revert button visibility is handled by `file_selected` signal from Approvals widget

### CSS Styling

Add CSS classes to buttons using `add_css_class()` method:

1. **Approve Button**:
   ```vala
   this.approve_button.add_css_class("oc-approve");
   this.approve_button.add_css_class("suggested-action");
   ```
   - Uses both `oc-approve` and `suggested-action` classes
   - `suggested-action` provides standard GTK4 primary button styling (green/blue background)
   - `oc-approve` class exists for potential future custom styling

2. **Revert Button**:
   ```vala
   this.revert_button.add_css_class("oc-reject");
   ```
   - Uses `oc-reject` class (no styling currently, class exists for potential future use)

### FileHistory Approval

When approving a file, also approve all FileHistory items:

```vala
void approve_file_history(File file) {
    // Query FileHistory table for this file_id
    var db = this.project_manager.db;
    var stmt = db.prepare("""
        UPDATE file_history 
        SET status = 1 
        WHERE filebase_id = ?
    """);
    stmt.bind_int64(1, file.id);
    stmt.step();
    stmt.reset();
}
```

### FileHistory Revert

Add revert method to FileHistory class to restore file from backup:

**File**: `libocfiles/FileHistory.vala`

```vala
/**
 * Revert file to previous version from backup.
 * 
 * This method restores the file from backup_path to the original path
 * and updates the File object in the database. The File object has a
 * reference to ProjectManager which provides access to the database.
 * 
 * Handles different change types:
 * - "modified": Restore file from backup_path to path
 * - "deleted": Restore file from backup_path to path (file was deleted, restore it)
 * - "added": Cannot revert (file didn't exist before, no backup)
 * 
 * @param file The File object to revert (has manager reference for database access)
 * @throws Error if backup file doesn't exist or restore fails
 */
public async void revert(OLLMfiles.File file) throws Error
{
    // Check if backup exists
    if (this.backup_path == "" || !GLib.FileUtils.test(this.backup_path, GLib.FileTest.EXISTS)) {
        throw new Error.FILE_NOT_FOUND("Backup file does not exist: %s".printf(this.backup_path));
    }
    
    // Check change type - cannot revert "added" files (no backup)
    if (this.change_type == "added") {
        throw new Error.INVALID_ARGUMENT("Cannot revert added files (no backup exists)");
    }
    
    // Get database from file's manager
    var db = file.manager.db;
    
    // Copy backup file back to original path
    var backup_file = GLib.File.new_for_path(this.backup_path);
    var target_file = GLib.File.new_for_path(this.path);
    
    // Create parent directory if it doesn't exist (for deleted files)
    var parent_dir = target_file.get_parent();
    if (parent_dir != null && !parent_dir.query_exists()) {
        parent_dir.make_directory_with_parents(null);
    }
    
    // Copy backup to original location (overwrites existing file)
    backup_file.copy(
        target_file,
        GLib.FileCopyFlags.OVERWRITE,
        null,
        null
    );
    
    // Update File object metadata
    // For deleted files: clear is_deleted flag (if it exists)
    // Update last_modified timestamp
    file.last_modified = new GLib.DateTime.now_local().to_unix();
    
    // Save File object to database
    file.saveToDB(db, null, false);
    
    // Update FileHistory status to rejected (-1)
    this.status = -1;
    yield this.save_to_db();
    
    // Update file's is_need_approval flag (file may need re-approval after revert)
    file.is_need_approval = true;
    file.saveToDB(db, null, false);
}
```

**Implementation Notes**:
- File object has `manager` property (ProjectManager) which has `db` property
- Method is async to handle file I/O operations
- Handles "modified" and "deleted" change types (restores from backup)
- Cannot revert "added" files (no backup exists)
- Updates FileHistory status to -1 (rejected) after revert
- Sets file.is_need_approval = true after revert (may need re-approval)
- Creates parent directory if needed (for deleted files being restored)

### Selection Management

1. **User Opens File Not in ReviewFiles**:
   ```vala
   void on_file_opened_in_codeview(File file) {
       // Check if file is in ReviewFiles
       if (this.active_project.review_files.file_map.has_key(file.path)) {
           // File is in ReviewFiles: select it
           this.approvals.select_file(file);
       } else {
           // File is not in ReviewFiles: clear selection
           // Note: Approvals widget may not have clear_selection() method
           // If not, selection will be cleared when file is removed from ReviewFiles
       }
       
       // Update approve button visibility
       this.update_approve_button_visibility();
   }
   ```

2. **User Clicks File in Approvals Popover**:
   - Handled by Approvals widget (emits `file_selected` signal)
   - Connect to `approvals.file_selected` signal to update approve button visibility
   - Optionally open file in codeview (if desired)

## Implementation Tasks

### Approvals Widget API Updates (if needed)
- [ ] Optionally add `get_selected_file()` method to Approvals widget (or track via signal)
- [ ] Optionally update Approvals button tooltip to show remaining count

### FileHistory Revert Method
- [ ] Add `revert(File file)` async method to FileHistory class
- [ ] Implement backup file restoration logic
- [ ] Handle "modified" change type (restore from backup)
- [ ] Handle "deleted" change type (restore from backup, create parent dir if needed)
- [ ] Handle "added" change type (throw error, cannot revert)
- [ ] Update File object metadata after restore
- [ ] Update FileHistory status to -1 (rejected) after revert
- [ ] Set file.is_need_approval = true after revert
- [ ] Add error handling for missing backup files

### CSS Styling
- [ ] Add `.oc-approve` CSS class to `resources/style.css` (no styling currently, class exists for potential future use)
- [ ] Add `.oc-reject` CSS class to `resources/style.css` (no styling currently, class exists for potential future use)
- [ ] Note: `suggested-action` is a standard GTK4 class, no custom CSS needed

### UI Integration
- [ ] Add Approvals button to main UI (toolbar/header area) - already implemented, just needs integration
- [ ] Add approve button near Approvals button (don't replace save button)
- [ ] Add CSS class `oc-approve` to approve button using `add_css_class()`
- [ ] Add CSS class `suggested-action` to approve button using `add_css_class()`
- [ ] Add revert button near Approvals button
- [ ] Add CSS class `oc-reject` to revert button using `add_css_class()`
- [ ] Add `current_selected_file` property to track selected file
- [ ] Connect to Approvals widget's `file_selected` signal (store selected file)
- [ ] Connect approve button click handler
- [ ] Connect revert button click handler
- [ ] Implement `update_approve_button_visibility()` method
- [ ] Implement `update_revert_button_visibility()` method
- [ ] Optionally implement `update_approvals_button_tooltip()` method
- [ ] Connect to `review_files.items_changed` signal to update Approvals button tooltip (optional)
- [ ] Implement `approve_file_history()` method
- [ ] Implement selection management when opening files in codeview
- [ ] Clear `current_selected_file` when selection is cleared
- [ ] Test all workflows

## Testing

- Test Approvals button appears in toolbar/header area
- Test Approvals button shows/hides based on review_files count (handled by widget)
- Test Approvals popover appears on mouseover (handled by widget)
- Test approve button only visible when file selected in Approvals
- Test approve button disappears when file approved
- Test approve button disappears when no file selected
- Test Approvals button visibility (handled by widget itself)
- Test Approvals button tooltip shows correct count (if implemented)
- Test Approvals button tooltip updates when items change (if implemented)
- Test approve button approves file and FileHistory
- Test clicking files in Approvals popover selects them and opens in codeview
- Test file_selected signal updates approve button visibility
- Test selection when opening file in ReviewFiles (selects in Approvals)
- Test selection clearing when opening file not in ReviewFiles
- Test ReviewFiles.items_changed signal updates next button visibility and tooltip
- Test revert button only visible when file selected and has FileHistory backup
- Test revert button hidden when file has no backup
- Test revert button restores file from backup for modified files
- Test revert button restores file from backup for deleted files
- Test revert button throws error for added files (no backup)
- Test revert updates FileHistory status to rejected
- Test revert sets file.is_need_approval = true
- Test revert updates ReviewFiles after restore
- Test revert creates parent directory if needed (for deleted files)
