# 1.2.7.22. Investigate Removing message_interface from Message

## Overview

After Step 1 of plan 1.2.7.18, `ChatView.append_complete_assistant_message()` no longer needs `message_interface` to render messages from history. This plan investigates whether `message_interface` can be completely removed from the `Message` class, and whether the `content_interface` parameter can be removed from `on_message_created()` method signature. The goal is to simplify the architecture by removing both unnecessary parameters and using `agent.chat()` as the authoritative source for chat information.

**Parent Plan**: [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md)

## Status

✅ **DONE** - Implementation complete. Both `message_interface` and `content_interface` have been successfully removed from the codebase.

## Implementation Steps

### Phase 1: Make message_interface Optional
- [x] Make `message_interface` optional in all Message constructors (5 constructors in `libollmchat/Message.vala`)
- [x] Test that existing code still works with optional parameter

### Phase 2: Remove content_interface Parameter
- [x] Update `SessionBase.on_message_created()` abstract method signature to remove `content_interface` parameter
- [x] Update `Session.on_message_created()` implementation signature
- [x] Update `EmptySession.on_message_created()` implementation signature
- [x] Update `SessionPlaceholder.on_message_created()` implementation signature
- [x] Find all call sites of `on_message_created()` and update them to remove `content_interface` argument

### Phase 3: Update Session.on_message_created()
- [x] Remove chat property update logic that uses `m.message_interface`
- [x] Remove chat property update logic that uses `content_interface`
- [x] Update to use `this.agent.chat()` directly if needed (or remove if redundant)
- [x] Remove line 228 in `Session.finalize_streaming()` that sets `message_interface`

### Phase 4: Update Tools
- [x] Update `libollmchat/Tools/RequestEditMode.on_message_created()` to remove `content_interface` parameter
- [x] Update `liboctools/RequestEditMode.on_message_created()` to remove `content_interface` parameter
- [x] Replace `content_interface` usage with `this.agent.chat().streaming_response` where needed
- [x] Replace `content_interface` usage with `this.agent.chat().stream` for streaming state checks
- [ ] Test tool execution still works correctly

### Phase 5: Update ChatWidget
- [x] Update `ChatWidget.load_messages()` to remove `message_interface` parameter from Message constructors (lines 274, 280)
- [x] Update `ChatWidget.on_message_created()` to remove `message_interface` parameter from Message constructors (lines 329, 334, 340)
- [x] Consider using existing Message objects directly instead of creating new ones
- [ ] Test history loading still works correctly

### Phase 6: Remove message_interface Assignments
- [x] Remove line 133 in `Response.Chat.deserialize_property()` that sets `message_interface`
- [x] Remove line 212 in `Response.Chat.add_message_chunk()` that sets `message_interface`
- [x] Remove line 314 in `Call.Chat.deserialize_property()` that sets `message_interface`
- [x] Remove line 553 in `Call.Chat.execute_non_streaming()` that sets `message_interface`

### Phase 7: Remove message_interface Property
- [x] Remove `message_interface` property from Message class definition
- [x] Remove `message_interface` parameter from all Message constructors (5 constructors)
- [x] Update all remaining Message constructor calls throughout codebase
- [x] Verify no remaining references to `message_interface`

### Testing
- [ ] Test Message constructors with removed `message_interface` parameter
- [ ] Test Session.on_message_created() without `content_interface` parameter
- [ ] Test tools (RequestEditMode) using `agent.chat().streaming_response`
- [ ] Test ChatWidget message loading
- [ ] Test loading sessions from history
- [ ] Test streaming responses
- [ ] Test non-streaming responses
- [ ] Test tool execution
- [ ] Verify chat property updates still work in Session
- [ ] Verify message rendering still works in ChatView
- [ ] Verify history loading still works correctly

## Analysis Results

### Summary

After thorough investigation, **removing both `message_interface` and the `content_interface` parameter from `on_message_created()` is feasible** with moderate refactoring. The primary remaining use case is in `Session.on_message_created()` for updating chat properties, which can be replaced by using `this.agent.chat()` directly, since chat properties are already set when the chat is created.

### Detailed Findings

#### 1. Session.on_message_created() - Chat Property Updates ✅ REPLACEABLE

**Current Usage**: Lines 103-115 in `libollmchat/History/Session.vala`

**Analysis**:
- The method signature is `on_message_created(Message m, ChatContentInterface? content_interface)`
- The `content_interface` parameter is already available and contains the same information
- When `m.message_interface is Call.Chat`, the `content_interface` parameter will also be `Call.Chat` (or `Response.Chat` which has a `call` property)
- The chat properties being updated (model, stream, format, etc.) are available from:
  - `content_interface` if it's a `Call.Chat`
  - `(content_interface as Response.Chat).call` if it's a `Response.Chat`
  - `this.agent.chat()` directly (which is the authoritative source)

**Recommendation**: Remove the `content_interface` parameter entirely. Use `this.agent.chat()` directly to get chat properties. The chat properties should already be set on `agent.chat()` when the request is made, so this update may be redundant or can be done at the point where the chat is created/configured.

**Code Change**:
```vala
// Current signature:
protected override void on_message_created(Message m, ChatContentInterface? content_interface)

// New signature:
protected override void on_message_created(Message m)

// Replace chat property update logic:
// Remove the content_interface check entirely, or use:
if (this.agent != null && this.agent.chat() != null) {
    var current_chat = this.agent.chat();
    // Chat properties are already set when chat is created
    // No need to update from message_interface or content_interface
}
```

#### 2. ChatWidget.load_messages() - Creating New Message Objects ✅ CAN ELIMINATE OR UPDATE

**Current Usage**: Lines 274, 280 in `libollmchatgtk/ChatWidget.vala`

**Analysis**:
- After plan 1.2.7.18, `append_complete_assistant_message()` no longer uses `message_interface`
- The method signature is `append_complete_assistant_message(Message message, SessionBase session)`
- The method works directly with `message.content` and `message.thinking`
- Messages loaded from history already have their content stored in the Message object
- Currently creates new Message objects with role "assistant" from messages with roles like "think-stream" or "content-stream"
- Once `message_interface` is removed from constructors, these calls will need to be updated

**Recommendation**: After removing `message_interface` from Message constructors, update these calls to not pass the parameter. Alternatively, consider using the existing Message objects directly if `append_complete_assistant_message()` can handle different roles.

**Code Change**:
```vala
// Current (with message_interface):
var stream_msg = new OLLMchat.Message(msg.message_interface, "assistant", msg.content, msg.thinking);

// After removing message_interface from constructor:
var stream_msg = new OLLMchat.Message("assistant", msg.content, msg.thinking);

// Or better: use msg directly if append_complete_assistant_message() can handle "think-stream"/"content-stream" roles:
this.chat_view.append_complete_assistant_message(msg, session);
```

#### 3. ChatWidget.on_message_created() - Creating New Message Objects ✅ CAN ELIMINATE OR UPDATE

**Current Usage**: Lines 329, 334, 340 in `libollmchatgtk/ChatWidget.vala`

**Analysis**:
- Same situation as #2 - `append_complete_assistant_message()` doesn't need `message_interface`
- The incoming `Message m` already has all the content needed
- Currently creates new Message objects with role "assistant" from messages with roles like "ui", "think-stream", "content-stream"
- Once `message_interface` is removed from constructors, these calls will need to be updated

**Recommendation**: After removing `message_interface` from Message constructors, update these calls to not pass the parameter. Alternatively, consider using the incoming Message object directly if `append_complete_assistant_message()` can handle different roles.

**Code Change**:
```vala
// Current (with message_interface):
var ui_msg = new OLLMchat.Message(m.message_interface, "assistant", m.content, m.thinking);

// After removing message_interface from constructor:
var ui_msg = new OLLMchat.Message("assistant", m.content, m.thinking);

// Or better: use m directly if append_complete_assistant_message() can handle "ui"/"think-stream"/"content-stream" roles:
this.chat_view.append_complete_assistant_message(m, session);
```

#### 4. Response.Chat.deserialize_property() - Setting message_interface ✅ REMOVABLE

**Current Usage**: Line 133 in `libollmchat/Response/Chat.vala`

**Analysis**:
- This sets `message_interface` when deserializing from JSON
- However, `message_interface` is not serialized (it's a runtime reference)
- Messages loaded from history won't have `message_interface` set anyway
- This is only needed if `message_interface` is still used elsewhere

**Recommendation**: Remove this line if `message_interface` is removed or made optional.

#### 5. Response.Chat.add_message_chunk() - Setting message_interface ✅ REMOVABLE

**Current Usage**: Line 212 in `libollmchat/Response/Chat.vala`

**Analysis**:
- Sets `message_interface` when processing streaming chunks
- This is only needed for Session.on_message_created() chat property updates
- Can be replaced by using `content_interface` parameter in signals

**Recommendation**: Remove this line if `message_interface` is removed.

#### 6. Call.Chat.deserialize_property() - Setting message_interface ✅ REMOVABLE

**Current Usage**: Line 314 in `libollmchat/Call/Chat.vala`

**Analysis**:
- Sets `message_interface` when deserializing Chat messages from JSON
- Similar to #4 - only needed if `message_interface` is still used

**Recommendation**: Remove this line if `message_interface` is removed.

#### 7. Call.Chat.execute_non_streaming() - Setting message_interface ✅ REPLACEABLE

**Current Usage**: Line 553 in `libollmchat/Call/Chat.vala`

**Analysis**:
- Sets `message_interface` on response message for non-streaming responses
- This is used by Session.on_message_created() to update chat properties
- Can be replaced by using `content_interface` parameter (which will be `Response.Chat`)

**Recommendation**: Remove this line. Session.on_message_created() should use `content_interface` instead.

#### 8. Session.finalize_streaming() - Setting message_interface ✅ REPLACEABLE

**Current Usage**: Line 228 in `libollmchat/History/Session.vala`

**Analysis**:
- Sets `message_interface` on response message before persisting
- Used by Session.on_message_created() to update chat properties
- Can be replaced by using `content_interface` parameter

**Recommendation**: Remove this line. Session.on_message_created() should use `content_interface` instead.

#### 9. Message Constructors - Required Parameter ✅ CAN MAKE OPTIONAL

**Current Usage**: Lines 146, 163, 181, 198, 217 in `libollmchat/Message.vala`

**Analysis**:
- All constructors require `message_interface` as first parameter
- Making it optional (`ChatContentInterface? message_interface = null`) would allow gradual migration
- History messages can have `null` message_interface
- New messages can still pass it if needed during transition

**Recommendation**: Make `message_interface` optional in all constructors, then gradually remove usage.

**Code Change**:
```vala
// Replace:
public Message(ChatContentInterface message_interface, string role, string content, string thinking = "")

// With:
public Message(ChatContentInterface? message_interface, string role, string content, string thinking = "")
```

#### 10. Tools Usage - RequestEditMode ⚠️ NEEDS UPDATE

**Current Usage**: `liboctools/RequestEditMode.vala` and `libollmchat/Tools/RequestEditMode.vala`

**Analysis**:
- RequestEditMode has commented-out code that used `message.message_interface`
- Current implementation uses `content_interface` parameter (line 306-326 in libollmchat/Tools/RequestEditMode.vala)
- Tools access `Response.Chat` via `content_interface` to check streaming state and access response properties
- Tools can get `Response.Chat` from `agent.chat().streaming_response` instead

**Recommendation**: Update tools to remove `content_interface` parameter. Use `this.agent.chat().streaming_response` to get `Response.Chat` when needed, or access chat properties directly from `agent.chat()`.

### Serialization Analysis

**Finding**: `message_interface` is **NOT serialized** to JSON. The `serialize_property()` method in `Message.vala` doesn't handle it, so it's excluded from JSON output. This is correct behavior since it's a runtime reference.

**Implication**: Messages loaded from history won't have `message_interface` set, which is fine since it's not needed for rendering (per plan 1.2.7.18).

### Circular Reference Analysis

**Finding**: `message_interface` creates a circular reference:
- `Message` → `message_interface` (Chat) → `messages[]` → `Message`

**Implication**: This can cause memory leaks if not handled carefully. Removing `message_interface` eliminates this concern.

### Recommended Approach

**Option 3 (Modified)**: Replace with `content_interface` parameter in signals

**Implementation Strategy**:
1. **Phase 1**: Make `message_interface` optional in all Message constructors
2. **Phase 2**: Remove `content_interface` parameter from `on_message_created()` signature
3. **Phase 3**: Update `Session.on_message_created()` to use `this.agent.chat()` instead of `content_interface` or `m.message_interface`
4. **Phase 4**: Update tools (RequestEditMode) to use `agent.chat().streaming_response` instead of `content_interface`
5. **Phase 5**: Update `ChatWidget` to remove `message_interface` parameter from Message constructors when creating display messages
6. **Phase 6**: Remove all assignments to `message.message_interface` in Response.Chat and Call.Chat
7. **Phase 7**: Remove `message_interface` property from Message class entirely

**Benefits**:
- Eliminates circular reference
- Simplifies method signature (removes unnecessary parameter)
- Cleaner architecture - chat properties accessed directly from authoritative source (`agent.chat()`)
- Backward compatible during migration (optional parameter for message_interface)

**Risks**:
- Need to verify all code paths that might access `message_interface` or `content_interface`
- Tools need to be updated to use `agent.chat().streaming_response` instead
- Need to find all call sites of `on_message_created()` and update them
- ChatWidget changes are straightforward

## Implementation Plan

### Files to Modify

1. **libollmchat/Message.vala**
   - Make `message_interface` optional in all constructors (5 constructors)
   - Eventually remove the property entirely

2. **libollmchat/History/SessionBase.vala**
   - Update abstract method signature: `on_message_created(Message m)` (remove `content_interface` parameter)

3. **libollmchat/History/Session.vala**
   - Update `on_message_created()` signature to remove `content_interface` parameter
   - Update chat property update logic to use `this.agent.chat()` instead
   - Remove line 228 that sets `message_interface` in `finalize_streaming()`
   - Find all call sites of `on_message_created()` and update them

4. **libollmchat/History/EmptySession.vala**
   - Update `on_message_created()` signature to remove `content_interface` parameter

5. **libollmchat/History/SessionPlaceholder.vala**
   - Update `on_message_created()` signature to remove `content_interface` parameter

6. **libollmchat/Tools/RequestEditMode.vala**
   - Update `on_message_created()` signature to remove `content_interface` parameter
   - Use `this.agent.chat().streaming_response` to get `Response.Chat` when needed
   - Use `this.agent.chat().stream` to check streaming state

7. **liboctools/RequestEditMode.vala**
   - Update `on_message_created()` signature to remove `content_interface` parameter
   - Use `this.agent.chat().streaming_response` to get `Response.Chat` when needed
   - Use `this.agent.chat().stream` to check streaming state

8. **libollmchatgtk/ChatWidget.vala**
   - Update `load_messages()` to remove `message_interface` parameter from Message constructors (lines 274, 280)
   - Update `on_message_created()` to remove `message_interface` parameter from Message constructors (lines 329, 334, 340)
   - Consider using existing Message objects directly instead of creating new ones

9. **libollmchat/Response/Chat.vala**
   - Remove line 133 in `deserialize_property()` that sets `message_interface`
   - Remove line 212 in `add_message_chunk()` that sets `message_interface`

10. **libollmchat/Call/Chat.vala**
   - Remove line 314 in `deserialize_property()` that sets `message_interface`
   - Remove line 553 in `execute_non_streaming()` that sets `message_interface`

### Testing Strategy

1. **Unit Tests**:
   - Test Message constructors with `null` message_interface
   - Test Session.on_message_created() without content_interface parameter
   - Test tools (RequestEditMode) using agent.chat().streaming_response
   - Test ChatWidget message loading with null message_interface

2. **Integration Tests**:
   - Test loading sessions from history (messages won't have message_interface)
   - Test streaming responses (tools should use agent.chat().streaming_response)
   - Test non-streaming responses (tools should use agent.chat() directly)
   - Test tool execution (RequestEditMode should work without content_interface)

3. **Regression Tests**:
   - Verify chat property updates still work in Session
   - Verify message rendering still works in ChatView
   - Verify history loading still works correctly

### Migration Path

**Phase 1: Make Optional (Backward Compatible)**
- Make `message_interface` optional in Message constructors
- All existing code continues to work
- New code can pass `null`

**Phase 2: Remove content_interface Parameter**
- Update SessionBase abstract method signature
- Update all implementations (Session, EmptySession, SessionPlaceholder)
- Find all call sites and update them

**Phase 3: Update Usage**
- Update Session.on_message_created() to use agent.chat() instead
- Update tools to use agent.chat().streaming_response
- Update ChatWidget to remove message_interface parameter from Message constructors
- Remove assignments in Response.Chat and Call.Chat

**Phase 3: Remove Property**
- Remove `message_interface` property from Message class
- Update all constructors to remove the parameter
- Clean up any remaining references

### Breaking Changes

**Breaking Changes**:
- Phase 2 changes method signature (breaking for subclasses)
- All implementations of `on_message_created()` must be updated
- All call sites of `on_message_created()` must be updated
- Tools that use `content_interface` must be updated

**Mitigation**:
- Phase 1 is backward compatible (optional parameter for message_interface)
- Update all implementations and call sites in same commit
- Tools can use `agent.chat().streaming_response` as replacement

**External API Impact**: None - `message_interface` is not part of the public API for external users.

## Conclusion

**Removal of `message_interface` is recommended and feasible.**

The investigation shows that:
1. ✅ The primary use case (Session chat property updates) can use `agent.chat()` directly instead of `content_interface`
2. ✅ UI rendering no longer needs `message_interface` (plan 1.2.7.18)
3. ✅ Tools can use `agent.chat().streaming_response` instead of `content_interface`
4. ✅ `message_interface` is not serialized, so history loading doesn't need it
5. ✅ Both `message_interface` and `content_interface` create unnecessary complexity
6. ✅ Removing `content_interface` parameter simplifies the method signature

The recommended approach is a phased migration:
1. Make `message_interface` optional (backward compatible)
2. Remove `content_interface` parameter from `on_message_created()` signature
3. Update all implementations and call sites
4. Update tools to use `agent.chat().streaming_response`
5. Remove `message_interface` property entirely

This will result in a cleaner architecture without circular references and with simpler method signatures, while maintaining all functionality.

## Current Usage of message_interface

### 1. Session.on_message_created() - Chat Property Updates
**Location**: `libollmchat/History/Session.vala` lines 103-115

**Usage**: Updates chat properties (model, stream, format, etc.) from the message's `message_interface` when it's a `Call.Chat`.

```vala
if (m.message_interface is Call.Chat) {
    var new_chat = (Call.Chat) m.message_interface;
    // Update properties on agent's chat if available
    if (this.agent != null && this.agent.chat != null) {
        var current_chat = this.agent.chat;
        current_chat.model = new_chat.model;
        current_chat.stream = new_chat.stream;
        // ... etc
    }
}
```

**Question**: Can this be replaced? The chat properties could come from:
- The response object directly (Response.Chat has these properties)
- Session already has access to `agent.chat` which could be updated directly
- The `content_interface` parameter already provides this information

### 2. ChatWidget.load_messages() - Creating New Message Objects
**Location**: `libollmchatgtk/ChatWidget.vala` lines 274, 280, 329, 334, 340

**Usage**: Creates new Message objects from stored messages when loading history, passing `msg.message_interface` to the constructor.

```vala
var stream_msg = new OLLMchat.Message(msg.message_interface, "assistant", msg.content, msg.thinking);
this.chat_view.append_complete_assistant_message(stream_msg, session);
```

**Question**: After Step 1 of 1.2.7.18, `append_complete_assistant_message()` no longer needs `message_interface`. Can we pass `null` here? Or can we eliminate the need to create new Message objects entirely?

### 3. ChatWidget.on_message_created() - Creating New Message Objects
**Location**: `libollmchatgtk/ChatWidget.vala` lines 329, 334, 340

**Usage**: Same as above - creates new Message objects for display.

**Question**: Same as #2 - can we pass `null` or eliminate the need?

### 4. Response.Chat.deserialize_property() - Setting message_interface
**Location**: `libollmchat/Response/Chat.vala` line 133

**Usage**: Sets `message_interface` when deserializing messages from JSON.

```vala
this.message.message_interface = this;
```

**Question**: Is this needed? If we remove `message_interface`, this would be removed.

### 5. Response.Chat.add_message_chunk() - Setting message_interface
**Location**: `libollmchat/Response/Chat.vala` line 212

**Usage**: Sets `message_interface` when processing streaming chunks.

```vala
msg.message_interface = this;
```

**Question**: Same as #4 - needed only if `message_interface` is kept.

### 6. Call.Chat.deserialize_property() - Setting message_interface
**Location**: `libollmchat/Call/Chat.vala` line 314

**Usage**: Sets `message_interface` when deserializing Chat messages from JSON.

```vala
msg_obj.message_interface = this;
```

**Question**: Same as #4 - needed only if `message_interface` is kept.

### 7. Call.Chat.execute_non_streaming() - Setting message_interface
**Location**: `libollmchat/Call/Chat.vala` line 553

**Usage**: Sets `message_interface` on response message for non-streaming responses.

```vala
response_obj.message.message_interface = this;
```

**Question**: This is used by Session.on_message_created() to update chat properties. Can we replace this with a different mechanism?

### 8. Session.finalize_streaming() - Setting message_interface
**Location**: `libollmchat/History/Session.vala` line 220

**Usage**: Sets `message_interface` on response message before persisting.

```vala
response.message.message_interface = this.agent.chat;
```

**Question**: Same as #7 - needed for Session.on_message_created() chat property updates.

### 9. Message Constructors - Required Parameter
**Location**: `libollmchat/Message.vala` lines 146, 163, 181, 198, 217

**Usage**: All Message constructors require `message_interface` as the first parameter.

**Question**: If we remove `message_interface`, all constructors would need to be updated. Can we make it optional or remove it entirely?

## Investigation Steps

### Step 1: Analyze Session.on_message_created() Chat Property Updates ✅ COMPLETE
- [x] Review why chat properties need to be updated from messages
- [x] Determine if `content_interface` parameter provides the same information
- [x] Check if Session can access chat properties directly from `agent.chat`
- [x] Evaluate if chat properties should be updated at a different point in the flow
- [x] Document findings: Can `message_interface` be replaced here?

**Finding**: Yes, `message_interface` can be replaced. The `content_interface` parameter provides the same information, and `agent.chat()` is the authoritative source.

### Step 2: Analyze ChatWidget Message Object Creation ✅ COMPLETE
- [x] Review why new Message objects are created in `load_messages()` and `on_message_created()`
- [x] Determine if we can pass `null` for `message_interface` after Step 1 of 1.2.7.18
- [x] Check if we can eliminate the need to create new Message objects entirely
- [x] Test if `append_complete_assistant_message()` works with `null` message_interface
- [x] Document findings: Can we pass `null` or eliminate Message creation?

**Finding**: Yes, can pass `null`. `append_complete_assistant_message()` no longer needs `message_interface` after plan 1.2.7.18.

### Step 3: Analyze Tools Usage ✅ COMPLETE
- [x] Check if tools like `RequestEditMode` need `message_interface`
- [x] Review how tools access Response.Chat from messages
- [x] Determine if tools can get Response.Chat from the `content_interface` parameter instead
- [x] Document findings: Do tools need `message_interface`?

**Finding**: Tools no longer use `message_interface`. They use `content_interface` parameter from signals.

### Step 4: Analyze Serialization/Deserialization ✅ COMPLETE
- [x] Review if `message_interface` is serialized to JSON (should not be)
- [x] Check if deserialization code that sets `message_interface` is necessary
- [x] Determine if messages loaded from history need `message_interface` set
- [x] Document findings: Is serialization code needed?

**Finding**: `message_interface` is NOT serialized (correct). Deserialization code that sets it can be removed.

### Step 5: Create Removal Plan (if feasible) ✅ COMPLETE
- [x] If removal is feasible, create detailed implementation plan
- [x] List all files that need to be modified
- [x] Identify breaking changes and migration path
- [x] Plan testing strategy

**Finding**: Removal is feasible. See "Recommended Approach" section below.

## Potential Solutions

### Option 1: Remove message_interface Entirely
**Pros**:
- Simplifies Message class
- Removes circular reference concerns
- Cleaner architecture

**Cons**:
- May break tools that need Chat access
- May break Session chat property updates
- Requires refactoring all Message constructors

### Option 2: Make message_interface Optional
**Pros**:
- Backward compatible
- Allows gradual migration
- History messages can have null message_interface

**Cons**:
- Still maintains the property (just nullable)
- Doesn't fully solve the architectural issue

### Option 3: Replace with Different Mechanism
**Pros**:
- Keeps functionality while removing property
- Could use `content_interface` parameter in signals
- Could use Session/Agent references instead

**Cons**:
- More complex refactoring
- May require signal signature changes

## Files to Investigate

1. `libollmchat/Message.vala` - Message class definition
2. `libollmchat/History/Session.vala` - Session.on_message_created() usage
3. `libollmchat/Call/Chat.vala` - Chat deserialization and message creation
4. `libollmchat/Response/Chat.vala` - Response deserialization
5. `libollmchatgtk/ChatWidget.vala` - Message object creation for display
6. `libollmchat/Tools/RequestEditMode.vala` - Tool usage of message_interface
7. `liboctools/RequestEditMode.vala` - Tool usage of message_interface

## Related Plans

- [1.2.7.18. ChatView.append_complete_assistant_message()](./1.2.7.18-chatview-append-complete-assistant-message.md) - Already removed dependency in Step 1
- [1.2.7. Move Remaining Signals from Client to Chat](./1.2.7-DONE-move-signals-to-chat.md) - Parent plan
- [1.10. Refactor Agents Interface](./1.10-refactor-agents-interface.md) - Mentions avoiding message_interface usage

## Notes

- After Step 1 of 1.2.7.18, `append_complete_assistant_message()` no longer needs `message_interface`
- The FIXME comment in ChatView mentioned wanting to "get rid of this message_interface klduget"
- Plan 1.10 mentions avoiding `message.message_interface` usage in favor of Session-based access
- `message_interface` creates a circular reference: Message → Chat → messages[] → Message

