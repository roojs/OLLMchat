# Generate Valadoc documentation (single unified documentation)
# valadoc is required - meson will fail during configuration if it's not found
valadoc = find_program('valadoc', required: true)

# Combined documentation for both base and UI libraries
valadoc_dir = meson.current_source_dir() / 'ollmchat'
valadoc_clean = custom_target('valadoc-clean',
  output: 'valadoc-clean',
  command: [find_program('rm'), '-rf', valadoc_dir],
  build_by_default: false
)

valadoc_docs = custom_target('valadoc',
  input: files(
    # libollmchat sources
    '../libollmchat/Client.vala',
    '../libollmchat/Call/Base.vala',
    '../libollmchat/Call/Chat.vala',
    '../libollmchat/Call/Embed.vala',
    '../libollmchat/Call/Models.vala',
    '../libollmchat/Call/Options.vala',
    '../libollmchat/Call/Ps.vala',
    '../libollmchat/Call/ShowModel.vala',
    '../libollmchat/Message.vala',
    '../libollmchat/ChatContentInterface.vala',
    '../libollmchat/OllamaBase.vala',
    '../libollmchat/Response/Base.vala',
    '../libollmchat/Response/CallFunction.vala',
    '../libollmchat/Response/Chat.vala',
    '../libollmchat/Response/Embed.vala',
    '../libollmchat/Response/Model.vala',
    '../libollmchat/Response/ToolCall.vala',
    '../libollmchat/Tool/RequestBase.vala',
    '../libollmchat/Tool/Tool.vala',
    '../libollmchat/Tool/Param.vala',
    '../libollmchat/Tool/ParamSimple.vala',
    '../libollmchat/Tool/ParamObject.vala',
    '../libollmchat/Tool/ParamArray.vala',
    '../libollmchat/Tool/Function.vala',
    '../libollmchat/ChatPermission/Provider.vala',
    '../libollmchat/ChatPermission/Dummy.vala',
    '../libollmchat/History/Manager.vala',
    '../libollmchat/History/SessionBase.vala',
    '../libollmchat/History/Session.vala',
    '../libollmchat/History/EmptySession.vala',
    '../libollmchat/History/SessionJson.vala',
    '../libollmchat/History/SessionPlaceholder.vala',
    '../libollmchat/History/TitleGenerator.vala',
    '../libollmchat/Call/Generate.vala',
    '../libollmchat/Response/Generate.vala',
    '../libollmchat/Prompt/BaseAgent.vala',
    '../libollmchat/Prompt/AgentInterface.vala',
    '../libollmchat/Prompt/CodeAssistantDummy.vala',
    '../libollmchat/Prompt/CodeAssistant.vala',
    '../libollmchat/Tools/ReadFile.vala',
    '../libollmchat/Tools/RequestReadFile.vala',
    '../libollmchat/Tools/EditMode.vala',
    '../libollmchat/Tools/RequestEditMode.vala',
    '../libollmchat/Tools/EditModeChange.vala',
    '../libollmchat/Tools/RunCommand.vala',
    '../libollmchat/Tools/RequestRunCommand.vala',
    # libollmchatgtk sources
    '../libollmchatgtk/ChatWidget.vala',
    '../libollmchatgtk/ChatView.vala',
    '../libollmchatgtk/ChatInput.vala',
    '../libollmchatgtk/ChatPermission.vala',
    '../libollmchatgtk/HistoryBrowser.vala',
    '../libollmchatgtk/Message.vala',
    '../libollmchatgtk/Tools/RunCommand.vala',
    '../libollmchatgtk/Tools/RequestRunCommand.vala',
    '../libollmchatgtk/Tools/Permission.vala',
    # libocmarkdown sources
    '../libocmarkdown/Parser.vala',
    '../libocmarkdown/RenderBase.vala',
    '../libocmarkdown/PangoRender.vala',
    '../libocmarkdown/DummyRenderer.vala',
    '../libocmarkdown/HtmlParser.vala',
    '../libocmarkdown/HtmlRender.vala',
    '../libocmarkdown/Tags.vala',
    '../libocmarkdown/TagsTable.vala',
    '../libocmarkdown/Writer.vala',
    # libocmarkdowngtk sources
    '../libocmarkdowngtk/Render.vala',
    '../libocmarkdowngtk/RenderSourceView.vala',
    '../libocmarkdowngtk/State.vala',
    '../libocmarkdowngtk/TopState.vala',
    '../libocmarkdowngtk/Table.vala',
    '../libocmarkdowngtk/TableCell.vala',
    # libocsqlite sources
    '../libocsqlite/Database.vala',
    '../libocsqlite/Query.vala',
    '../libocsqlite/Schema.vala',
  ),
  output: ['valadoc'],
  depends: [valadoc_clean],
  command: [
    valadoc,
    '--package-name=ollmchat',
    '--package-version=@0@'.format(meson.project_version()),
    '--vapidir', meson.current_source_dir() / '../vapi',
    '--vapidir', meson.current_source_dir() / '../../vapi',
    '--pkg=gee-0.8',
    '--pkg=gio-2.0',
    '--pkg=glib-2.0',
    '--pkg=gobject-2.0',
    '--pkg=json-glib-1.0',
    '--pkg=libsoup-3.0',
    '--pkg=libxml-2.0',
    '--pkg=sqlite3',
    '--pkg=gtk4',
    '--pkg=gtksourceview-5',
    '--pkg=posix',
    # Don't use --pkg=ocmarkdown or --pkg=ocmarkdowngtk here - valadoc processes source files directly,
    # so it doesn't need VAPI files. Using --pkg would cause duplicate definition errors.
    '--doclet=html',
    '--directory=' + valadoc_dir,
    '@INPUT@'
  ],
  build_by_default: true,
  install: false
)
