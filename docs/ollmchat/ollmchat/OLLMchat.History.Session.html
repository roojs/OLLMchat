<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>
    <title>OLLMchat.History.Session &ndash; ollmchat &ndash; Vala Binding Reference</title>
    <link href="../style.css" rel="stylesheet" type="text/css"/><script src="../scripts.js" type="text/javascript">
    </script>
  </head>
  <body>
    <div class="site_header">OLLMchat.History.Session &ndash; ollmchat Reference Manual</div>
    <div class="site_body">
      <div class="site_navigation">
        <ul class="navi_main">
          <li class="package_index"><a href="../index.html">Packages</a></li>
        </ul>
        <hr class="navi_hr"/>
        <ul class="navi_main">
          <li class="package"><a href="index.htm">ollmchat</a></li>
        </ul>
        <hr class="navi_hr"/>
        <ul class="navi_main">
          <li class="namespace"><a href="OLLMchat.html">OLLMchat</a></li>
        </ul>
        <hr class="navi_hr"/>
        <ul class="navi_main">
          <li class="namespace"><a href="OLLMchat.History.html">History</a></li>
        </ul>
        <hr class="navi_hr"/>
        <ul class="navi_main">
          <li class="class">Session</li>
        </ul>
        <hr class="navi_hr"/>
        <ul class="navi_main">
          <li class="virtual_property"><a href="OLLMchat.History.Session.display_info.html">display_info</a></li>
          <li class="static_method"><a href="OLLMchat.History.Session.initDB.html">initDB</a></li>
          <li class="creation_method"><a href="OLLMchat.History.Session.Session.html">Session</a></li>
          <li class="virtual_method"><a href="OLLMchat.History.Session.activate_agent.html">activate_agent</a></li>
          <li class="virtual_method"><a href="OLLMchat.History.Session.cancel_current_request.html">cancel_current_request</a></li>
          <li class="virtual_method"><a href="OLLMchat.History.Session.deserialize_property.html">deserialize_property</a></li>
          <li class="virtual_method"><a href="OLLMchat.History.Session.handle_stream_chunk.html">handle_stream_chunk</a></li>
          <li class="virtual_method"><a href="OLLMchat.History.Session.load.html">load</a></li>
          <li class="virtual_method"><a href="OLLMchat.History.Session.on_message_created.html">on_message_created</a></li>
          <li class="virtual_method"><a href="OLLMchat.History.Session.read.html">read</a></li>
          <li class="virtual_method"><a href="OLLMchat.History.Session.saveToDB.html">saveToDB</a></li>
          <li class="virtual_method"><a href="OLLMchat.History.Session.save_async.html">save_async</a></li>
          <li class="virtual_method"><a href="OLLMchat.History.Session.send.html">send</a></li>
          <li class="virtual_method"><a href="OLLMchat.History.Session.serialize_property.html">serialize_property</a></li>
          <li class="virtual_method"><a href="OLLMchat.History.Session.write.html">write</a></li>
        </ul>
      </div>
      <div class="site_content">
        <h1 class="main_title">Session</h1>
        <hr class="main_hr"/>
        <h2 class="main_title">Object Hierarchy:</h2>
        <img class="main_diagram" usemap="#OLLMchat.History.Session" alt="Object hierarchy for Session" src="img/OLLMchat.History.Session.png"/>

      <map id="OLLMchat.History.Session" name="OLLMchat.History.Session">
<area shape="rect" id="node1" href="OLLMchat.History.Session.html" title="OLLMchat.History.Session" alt="" coords="27,197,249,245"/>
<area shape="rect" id="node2" href="OLLMchat.History.SessionBase.html" title="OLLMchat.History.SessionBase" alt="" coords="9,101,267,149"/>
</map>

        <h2 class="main_title">Description:</h2>
        <div class="main_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">class</span> <b><span class="class">Session</span></b> : <span class="main_type"><a href="OLLMchat.History.SessionBase.html" class="abstract_class">SessionBase</a></span>
        </div>
        <div class="description">
          <p>Session is a wrapper around Call.Chat that provides history persistence.</p>
          <p>It uses SQ (SQLite) for database storage of metadata, and JSON files for complete session data including all messages. Properties are 
            wrappers Messages come from session.messages. Model and other properties are on Session (Chat is created per request by AgentHandler) with
            a flag to include extra info during JSON encoding.</p>
          <h2>Example </h2>
          <p><pre class="main_source"><code><span class="main_comment">// Create session from chat call</span><br/><span class="main_keyword">var</span> call = <span class="main_keyword">new</span> Call.Chat(client, <span class="main_literal">"llama3.2"</span>);<br/><span class="main_keyword">var</span> session = <span class="main_keyword">new</span> History.Session(call, db);<br/><br/><span class="main_comment">// Save session to disk and database</span><br/><span class="main_keyword">yield</span> session.save();<br/><br/><span class="main_comment">// Load session later</span><br/><span class="main_keyword">var</span> loaded = History.Session.load(id, db, client, config);</code></pre>
          </p>
          <p>Session requires a Call.Chat object in its constructor.</p>
        </div><br/>
        <div class="namespace_note"><b>Namespace:</b> <a href="OLLMchat.History.html">OLLMchat.History</a>
        </div>
        <div class="package_note"><b>Package:</b> <a href="index.htm">ollmchat</a>
        </div>
        <h2 class="main_title">Content:</h2>
        <h3 class="main_title">Properties:</h3>
        <ul class="navi_inline">
          <li class="virtual_property"><span class="leaf_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">override</span> <span class="main_basic_type"><span class="class">string</span></span> <b><a href="OLLMchat.History.Session.display_info.html" class="virtual_property">display_info</a></b> { <span class="main_keyword">owned</span> <span class="main_keyword">get</span>; }
            </span>
            <div class="leaf_brief_description">
            </div></li>
        </ul>
        <h3 class="main_title">Static methods:</h3>
        <ul class="navi_inline">
          <li class="static_method"><span class="leaf_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">static</span> <span class="main_keyword">void</span> <b><a href="OLLMchat.History.Session.initDB.html" class="static_method">initDB</a></b> (<span class="main_type"><a href="SQ.Database.html" class="class">Database</a></span> db)
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Initialize database table for sessions.</span>
            </div></li>
        </ul>
        <h3 class="main_title">Creation methods:</h3>
        <ul class="navi_inline">
          <li class="creation_method"><span class="leaf_code_definition"><span class="main_keyword">public</span> <b><a href="OLLMchat.History.Session.Session.html" class="creation_method">Session</a></b> (<span class="main_type"><a href="OLLMchat.History.Manager.html" class="class">Manager</a></span> manager)
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Constructor for Session.</span>
            </div></li>
        </ul>
        <h3 class="main_title">Methods:</h3>
        <ul class="navi_inline">
          <li class="virtual_method"><span class="leaf_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">override</span> <span class="main_keyword">void</span> <b><a href="OLLMchat.History.Session.activate_agent.html" class="virtual_method">activate_agent</a></b> (<span class="main_basic_type"><span class="class">string</span></span> agent_name) <span class="main_keyword">throws</span> <span class="main_type"><span class="class">Error</span></span>
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Activates an agent for this session.</span>
            </div></li>
          <li class="virtual_method"><span class="leaf_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">override</span> <span class="main_keyword">void</span> <b><a href="OLLMchat.History.Session.cancel_current_request.html" class="virtual_method">cancel_current_request</a></b> ()
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Cancels the current request if one is active.</span>
            </div></li>
          <li class="virtual_method"><span class="leaf_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">override</span> <span class="main_basic_type"><span class="struct">bool</span></span> <b><a href="OLLMchat.History.Session.deserialize_property.html" class="virtual_method">deserialize_property</a></b> (<span class="main_basic_type"><span class="class">string</span></span> property_name, <span class="main_keyword">out</span> <span class="main_type"><span class="struct">Value</span></span> value, <span class="main_type"><span class="class">ParamSpec</span></span> pspec, <span class="main_type"><span class="class">Node</span></span> property_node)
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Handle JSON property mapping and custom deserialization. No-op for 
                Session - sessions are never deserialized (only SessionJson is used).</span>
            </div></li>
          <li class="virtual_method"><span class="leaf_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">override</span> <span class="main_keyword">void</span> <b><a href="OLLMchat.History.Session.handle_stream_chunk.html" class="virtual_method">handle_stream_chunk</a></b> (<span class="main_basic_type"><span class="class">string</span></span> new_text, <span class="main_basic_type"><span class="struct">bool</span></span> is_thinking, <span class="main_type"><a href="OLLMchat.Response.Chat.html" class="class">Chat</a></span> response)
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Called by AgentHandler when a streaming chunk is received. Handles 
                persistence and relays to Manager signals.</span>
            </div></li>
          <li class="virtual_method"><span class="leaf_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">override</span> <span class="main_keyword">async</span> <span class="main_type"><a href="OLLMchat.History.SessionBase.html" class="abstract_class">SessionBase</a></span>? <b><a href="OLLMchat.History.Session.load.html" class="virtual_method">load</a></b> () <span class="main_keyword">throws</span> <span class="main_type"><span class="class">Error</span></span>
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Loads the session data if needed. No-op for Session (already loaded).
              </span>
            </div></li>
          <li class="virtual_method"><span class="leaf_code_definition"><span class="main_keyword">protected</span> <span class="main_keyword">override</span> <span class="main_keyword">void</span> <b><a href="OLLMchat.History.Session.on_message_created.html" class="virtual_method">on_message_created</a></b> (<span class="main_type"><a href="OLLMchat.Message.html" class="class">Message</a></span> m)
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Handler for message_created signal from this session's client. Handles
                message persistence when a message is created. FIXME = needs making logical after we remove get_chat FIXME = on message created should
                not be getting a chat? - need to work out why that would happen</span>
            </div></li>
          <li class="virtual_method"><span class="leaf_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">override</span> <span class="main_keyword">async</span> <span class="main_keyword">void</span> <b><a href="OLLMchat.History.Session.read.html" class="virtual_method">read</a></b> () <span class="main_keyword">throws</span> <span class="main_type"><span class="class">Error</span></span>
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Read session from JSON file. No-op for Session - sessions are loaded 
                once via SessionPlaceholder.load() and never again.</span>
            </div></li>
          <li class="virtual_method"><span class="leaf_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">override</span> <span class="main_keyword">void</span> <b><a href="OLLMchat.History.Session.saveToDB.html" class="virtual_method">saveToDB</a></b> ()
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Save session to SQLite database.</span>
            </div></li>
          <li class="virtual_method"><span class="leaf_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">override</span> <span class="main_keyword">async</span> <span class="main_keyword">void</span> <b><a href="OLLMchat.History.Session.save_async.html" class="virtual_method">save_async</a></b> (<span class="main_basic_type"><span class="struct">bool</span></span> update_timestamp = <span class="main_literal">true</span>)
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Save session to both DB and file asynchronously. Updates metadata and 
                saves to both database and JSON file.</span>
            </div></li>
          <li class="virtual_method"><span class="leaf_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">override</span> <span class="main_keyword">async</span> <span class="main_keyword">void</span> <b><a href="OLLMchat.History.Session.send.html" class="virtual_method">send</a></b> (<span class="main_type"><a href="OLLMchat.Message.html" class="class">Message</a></span> message, <span class="main_type"><span class="class">Cancellable</span></span>? cancellable = <span class="main_literal">null</span>) <span class="main_keyword">throws</span> <span class="main_type"><span class="class">Error</span></span>
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Sends a Message object to this session.</span>
            </div></li>
          <li class="virtual_method"><span class="leaf_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">override</span> <span class="main_type"><span class="class">Node</span></span> <b><a href="OLLMchat.History.Session.serialize_property.html" class="virtual_method">serialize_property</a></b> (<span class="main_basic_type"><span class="class">string</span></span> property_name, <span class="main_type"><span class="struct">Value</span></span> value, <span class="main_type"><span class="class">ParamSpec</span></span> pspec)
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Handle JSON property mapping for serialization.</span>
            </div></li>
          <li class="virtual_method"><span class="leaf_code_definition"><span class="main_keyword">public</span> <span class="main_keyword">override</span> <span class="main_keyword">async</span> <span class="main_keyword">void</span> <b><a href="OLLMchat.History.Session.write.html" class="virtual_method">write</a></b> () <span class="main_keyword">throws</span> <span class="main_type"><span class="class">Error</span></span>
            </span>
            <div class="leaf_brief_description"><span class="brief_description">Write session to JSON file. Uses this.fid and to_path() to determine 
                where to write. Serializes the session including messages with history info (timestamp, hidden).</span>
            </div></li>
        </ul>
        <h3 class="main_title">Inherited Members:</h3>
        <div class="box">
          <div class="headline" onclick="toggle_box (this, 'box-content-182')">All known members inherited from class OLLMchat.History.SessionBase
          </div>
          <div class="content" id="box-content-182">
            <div class="column">
              <ul class="navi_inline">
                <li class="method"><a href="OLLMchat.History.SessionBase.activate.html">activate</a></li>
                <li class="abstract_method"><a href="OLLMchat.History.SessionBase.activate_agent.html">activate_agent</a></li>
                <li class="method"><a href="OLLMchat.History.SessionBase.activate_model.html">activate_model</a></li>
                <li class="method"><a href="OLLMchat.History.SessionBase.add_message.html">add_message</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.agent.html">agent</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.agent_name.html">agent_name</a></li>
                <li class="abstract_method"><a href="OLLMchat.History.SessionBase.cancel_current_request.html">cancel_current_request</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.child_chats.html">child_chats</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.css_classes.html">css_classes</a></li>
                <li class="method"><a href="OLLMchat.History.SessionBase.deactivate.html">deactivate</a></li>
                <li class="abstract_method"><a href="OLLMchat.History.SessionBase.deserialize_property.html">deserialize_property</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.display_date.html">display_date</a></li>
                <li class="abstract_property"><a href="OLLMchat.History.SessionBase.display_info.html">display_info</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.display_title.html">display_title</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.duration_seconds.html">duration_seconds</a></li>
              </ul>
            </div>
            <div class="column">
              <ul class="navi_inline">
                <li class="property"><a href="OLLMchat.History.SessionBase.fid.html">fid</a></li>
                <li class="virtual_method"><a href="OLLMchat.History.SessionBase.handle_stream_chunk.html">handle_stream_chunk</a></li>
                <li class="method"><a href="OLLMchat.History.SessionBase.handle_stream_started.html">handle_stream_started</a></li>
                <li class="method"><a href="OLLMchat.History.SessionBase.handle_tool_message.html">handle_tool_message</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.has_unread.html">has_unread</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.id.html">id</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.is_active.html">is_active</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.is_running.html">is_running</a></li>
                <li class="abstract_method"><a href="OLLMchat.History.SessionBase.load.html">load</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.manager.html">manager</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.messages.html">messages</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.model.html">model</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.model_usage.html">model_usage</a></li>
                <li class="abstract_method"><a href="OLLMchat.History.SessionBase.on_message_created.html">on_message_created</a></li>
              </ul>
            </div>
            <div class="column">
              <ul class="navi_inline">
                <li class="abstract_method"><a href="OLLMchat.History.SessionBase.read.html">read</a></li>
                <li class="method"><a href="OLLMchat.History.SessionBase.reconstruct_model_usage_from_model.html">reconstruct_model_usage_from_model
                  </a></li>
                <li class="abstract_method"><a href="OLLMchat.History.SessionBase.saveToDB.html">saveToDB</a></li>
                <li class="abstract_method"><a href="OLLMchat.History.SessionBase.save_async.html">save_async</a></li>
                <li class="abstract_method"><a href="OLLMchat.History.SessionBase.send.html">send</a></li>
                <li class="abstract_method"><a href="OLLMchat.History.SessionBase.serialize_property.html">serialize_property</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.title.html">title</a></li>
                <li class="method"><a href="OLLMchat.History.SessionBase.to_path.html">to_path</a></li>
                <li class="method"><a href="OLLMchat.History.SessionBase.to_string.html">to_string</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.total_messages.html">total_messages</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.total_tokens.html">total_tokens</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.unread_count.html">unread_count</a></li>
                <li class="property"><a href="OLLMchat.History.SessionBase.updated_at_timestamp.html">updated_at_timestamp</a></li>
                <li class="abstract_method"><a href="OLLMchat.History.SessionBase.write.html">write</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="box">
          <div class="headline" onclick="toggle_box (this, 'box-content-183')">All known members inherited from class GLib.Object</div>
          <div class="content" id="box-content-183">
            <div class="column">
              <ul class="navi_inline">
                <li class="method">@get</li>
                <li class="static_method">@new</li>
                <li class="method">@ref</li>
                <li class="method">@set</li>
                <li class="method">add_toggle_ref</li>
                <li class="method">add_weak_pointer</li>
                <li class="method">bind_property</li>
                <li class="method">connect</li>
                <li class="virtual_method">constructed</li>
                <li class="method">disconnect</li>
                <li class="virtual_method">dispose</li>
                <li class="method">dup_data</li>
                <li class="method">dup_qdata</li>
                <li class="method">force_floating</li>
                <li class="method">freeze_notify</li>
                <li class="method">get_class</li>
                <li class="method">get_data</li>
              </ul>
            </div>
            <div class="column">
              <ul class="navi_inline">
                <li class="method">get_property</li>
                <li class="method">get_qdata</li>
                <li class="method">get_type</li>
                <li class="method">getv</li>
                <li class="static_method">interface_find_property</li>
                <li class="static_method">interface_install_property</li>
                <li class="static_method">interface_list_properties</li>
                <li class="method">is_floating</li>
                <li class="static_method">new_valist</li>
                <li class="static_method">new_with_properties</li>
                <li class="static_method">newv</li>
                <li class="signal">notify</li>
                <li class="method">notify_property</li>
                <li class="field">ref_count</li>
                <li class="method">ref_sink</li>
                <li class="method">remove_toggle_ref</li>
                <li class="method">remove_weak_pointer</li>
              </ul>
            </div>
            <div class="column">
              <ul class="navi_inline">
                <li class="method">replace_data</li>
                <li class="method">replace_qdata</li>
                <li class="method">set_data</li>
                <li class="method">set_data_full</li>
                <li class="method">set_property</li>
                <li class="method">set_qdata</li>
                <li class="method">set_qdata_full</li>
                <li class="method">set_valist</li>
                <li class="method">setv</li>
                <li class="method">steal_data</li>
                <li class="method">steal_qdata</li>
                <li class="method">thaw_notify</li>
                <li class="method">unref</li>
                <li class="method">watch_closure</li>
                <li class="method">weak_ref</li>
                <li class="method">weak_unref</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="box">
          <div class="headline" onclick="toggle_box (this, 'box-content-184')">All known members inherited from interface Json.Serializable</div>
          <div class="content" id="box-content-184">
            <div class="column">
              <ul class="navi_inline">
                <li class="method">default_deserialize_property</li>
                <li class="method">default_serialize_property</li>
                <li class="virtual_method">deserialize_property</li>
              </ul>
            </div>
            <div class="column">
              <ul class="navi_inline">
                <li class="virtual_method">find_property</li>
                <li class="virtual_method">get_property</li>
                <li class="virtual_method">list_properties</li>
              </ul>
            </div>
            <div class="column">
              <ul class="navi_inline">
                <li class="virtual_method">serialize_property</li>
                <li class="virtual_method">set_property</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div><br/>
    <div class="site_footer">Generated by <a href="https://docs.vala.dev"><kbd>valadoc</kbd></a>
    </div>
  </body>
</html>